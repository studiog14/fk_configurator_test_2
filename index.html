<!DOCTYPE html>
<!-- PATCH: Mobile UI fix enabled (2025-09-14) -->
<html lang="pl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="format-detection" content="telephone=no" />
  <title>Konfigurator krzeseÅ‚ - Fajne KrzesÅ‚a</title>
  <link rel="icon" href="icons/favicon.png" type="image/jpeg" />
  <link rel="manifest" href="manifest.json" />
  
  <!-- iOS PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="FK KrzesÅ‚a" />
  <link rel="apple-touch-icon" href="icons/favicon.png" />
  
  <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="pragma" content="no-cache" />
  <meta http-equiv="expires" content="0" />
  
  <!-- Cache buster for welcome screen fix -->
  <meta name="timestamp" content="2025-08-09-12:00" />
  
  <!-- Note: Using native import maps for modern browsers; mobile fallbacks handled in ios-fallback.js -->

  <script src="ios-fallback.js?v=2025080912"></script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script type="importmap">
{
  "imports": {
    "threepipe": "https://unpkg.com/threepipe@0.0.50/dist/index.mjs",
    "@threepipe/webgi-plugins": "https://unpkg.com/@threepipe/webgi-plugins@0.5.0/dist/index.mjs",
    "three": "https://unpkg.com/three@0.157.0/build/three.module.js"
  }
}
</script>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: 'Poppins', sans-serif;
    }

    #app {
      display: flex;
      height: 100vh;
      width: 100vw;
      position: relative;
      visibility: hidden;
    }

    #app.visible {
  visibility: visible;
  opacity: 1;
}

    #canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    body {
      background: #ededed80;
      /* przezroczyste tÅ‚o, lepszy blur */
    }

    /* Panele UI: identyczna przezroczystoÅ›Ä‡ i blur obu paneli */
    #sidebar,
    #config-overview {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 32px rgba(0, 0, 0, 0.10);
      border: 1px solid rgba(0, 0, 0, 0.08);
    }

    #sidebar {
      flex: 0 0 460px;
      min-width: 460px;
      max-width: 540px;
      padding: 32px 24px 24px 24px;
      z-index: 1200;
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
      overflow: hidden;
      position: relative;
      /* NIE dodawaj background! */
      padding-bottom: 80px; /* Add space for bottom elements */
    }
    
    /* Kontener z przewijaniem tylko dla czÄ™Å›ci z materiaÅ‚ami */
    #sidebar #config-section {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding-bottom: 20px; /* Mniejszy odstÄ™p na dole dla lepszego scrollowania */
      max-height: calc(100vh - 200px); /* Zapewnij odpowiedniÄ… maksymalnÄ… wysokoÅ›Ä‡ */
    }

    /* ðŸ“± Mobile: chairs section to bottom with small spacing */
    @media (max-width: 820px) {
      #sidebar #config-section {
        padding-bottom: 250px;
        max-height: calc(100vh - 40px);
      }

      /* Ensure model section goes to bottom */
      #model-section {
        margin-top: auto;
        padding-bottom: 250px;
      }

      /* Mobile sidebar improvements */
      #sidebar {
        padding: 20px 16px 250px 16px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        height: 100vh;
        padding-bottom: 450px; /* Extra space for bottom elements */
      }

      /* Category buttons section */
      #category-buttons {
        flex-shrink: 0;
        margin-bottom: 40px;
      }

      /* Model section takes remaining space and scrolls */
      #model-section {
        flex: 1;
        overflow-y: auto;
        min-height: 450px;
        margin-bottom: 40px;
        padding-bottom: 80px;
      }

      /* Config section hidden by default */
      #config-section {
        flex: 1;
        overflow-y: auto;
        min-height: 450px;
        padding-bottom: 80px;
      }

      /* Ensure thumbnails are properly sized and not cut off */
      .thumbnail-wrapper {
        margin-bottom: 35px;
      }

      .thumbnail {
        width: 130px !important;
        height: 130px !important;
        min-height: 130px !important;
      }

      .thumbnail img {
        max-width: 100%;
        max-height: 100%;
        object-fit: contain;
      }

      /* Fix options grid spacing */
      .options-grid {
        gap: 35px;
        padding-bottom: 60px;
      }

      /* Ensure category buttons are visible */
      #category-buttons {
        display: block !important;
        visibility: visible !important;
        opacity: 1 !important;
      }

      /* Special categories container */
      #special-categories-container {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        flex-wrap: wrap;
        gap: 20px;
        margin-bottom: 30px;
      }

      /* Category buttons container */
      #category-buttons-container {
        display: flex !important;
        visibility: visible !important;
        opacity: 1 !important;
        flex-wrap: wrap;
        gap: 20px;
      }

      /* Force mobile categories to show */
      .category-button.special-category {
        display: inline-flex !important;
        visibility: visible !important;
        opacity: 1 !important;
      }

      .category-button.promotion {
        display: inline-flex !important;
        visibility: visible !important;
        opacity: 1 !important;
      }

      .category-button.bestseller {
        display: inline-flex !important;
        visibility: visible !important;
        opacity: 1 !important;
      }
    }
    /* SEARCH FUNCTIONALITY COMPLETELY REMOVED */
    #search-toggle,
    #search-panel,
    #search-input,
    #search-results,
    #search-container,
    #search-filter-indicator {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }

  /* Akordeony kolekcji (Obicie / StelaÅ¼) - NOWY STYL: zawsze otwarte + przewijanie */
  .collection-accordion-group {
    max-height: 400px;
    overflow-y: auto;
    border: 1px solid #e3e3e3;
    border-radius: 12px;
    background: #fff;
    padding: 8px;
  }
  
  .collection-accordion-group .collection-section {
    margin-bottom: 15px;
  }
  
  .collection-accordion-group .collection-section:last-child {
    margin-bottom: 0;
  }
  
  .collection-accordion-group .collection-header {
    padding: 4px 12px;
    font-weight: 600;
    font-size: 13px;
    background: linear-gradient(135deg,#F5C842,#E5B432);
    color: #222;
    border-radius: 6px;
    margin-bottom: 8px;
  }
  
  .collection-materials-row {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(75px, 1fr));
    gap: 10px;
    padding: 0;
  }
  
  .collection-materials-row .thumbnail {
    width: 75px;
    height: 75px;
    display: flex;
    align-items: center;
    justify-content: center;
    border: 2px solid #eee;
    border-radius: 8px;
    overflow: hidden;
    background: #fafafa;
    cursor: pointer;
    transition: .25s;
  }
  
  .collection-materials-row .thumbnail:hover {
    border-color: #F5C842;
  }
  
  .collection-materials-row .thumbnail.selected {
    border-color: #F5C842;
    box-shadow: 0 0 0 2px rgba(245,200,66,.4);
    background: #fffbe6;
  }
  
  .collection-materials-row .thumbnail img {width:100%;height:100%;object-fit:cover;}
  .thumbnail-caption {font-size:11px;font-weight:500;text-align:center;margin-top:4px;line-height:1.2;max-width:79px;}

    #search-results {
      margin-top: 8px;
      max-height: 300px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
    }

    .search-result-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
      background: rgba(255, 255, 255, 0.9);
      text-align: center;
    }

    .search-result-item:hover {
      background: rgba(245, 200, 66, 0.15);
      border-color: #F5C842;
      transform: translateY(-2px);
    }

    .search-result-item img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 4px;
    }

    .search-result-item .result-name {
      font-size: 11px;
      font-weight: 600;
      color: #333;
      margin-bottom: 2px;
      line-height: 1.2;
    }

    .search-result-item .result-category {
      font-size: 12px;
      color: #f1c40f;
      font-weight: 600;
      line-height: 1.1;
      text-transform: uppercase;
    }

    /* Fallback dla wynikÃ³w bez obrazkÃ³w */
    .search-result-item.text-only {
      grid-column: 1 / -1;
      flex-direction: row;
      justify-content: flex-start;
      text-align: left;
      padding: 8px 12px;
    }

    .search-result-item.text-only .result-name {
      font-size: 14px;
      margin-bottom: 0;
      margin-right: 8px;
    }

    .search-result-item.text-only .result-category {
      font-size: 14px;
      color: #f1c40f;
      font-weight: 600;
      text-transform: uppercase;
    }

    .search-result-item .result-type {
      font-size: 10px;
      color: #F5C842;
      font-weight: 600;
      margin-top: 2px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Przyciski kategorii */
    .category-button {
      padding: 8px 16px;
      border: 2px solid #F5C842;
      background: white;
      color: #333;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: capitalize;
    }

    .category-button:hover {
      background: #F5C842;
      color: white;
      transform: translateY(-1px);
    }

    .category-button.active {
      background: #F5C842;
      color: white;
    }

    .category-button.promotion {
      border-color: #FF6B6B;
      color: #FF6B6B;
    }

    .category-button.promotion:hover,
    .category-button.promotion.active {
      background: #FF6B6B;
      color: white;
    }

    /* Specjalne kategorie */
    .special-category:hover {
      transform: translateY(-2px) scale(1.02);
      filter: brightness(1.1);
    }

    .special-category:active {
      transform: translateY(0) scale(0.98);
    }

    /* Modal wyboru akcji po wyszukiwaniu */
    #search-choice-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      backdrop-filter: blur(5px);
    }

    #search-choice-modal.active {
      display: flex;
    }

    .search-choice-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .search-choice-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #333;
    }

    .search-choice-item {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
      padding: 12px;
      border-radius: 8px;
      background: #f8f9fa;
      border: 2px solid transparent;
    }

    .search-choice-item img {
      width: 40px;
      height: 40px;
      object-fit: contain;
      margin-right: 12px;
      border-radius: 4px;
    }

    .search-choice-item-info {
      flex: 1;
      text-align: left;
    }

    .search-choice-item-name {
      font-weight: 600;
      font-size: 14px;
      color: #333;
      margin-bottom: 2px;
    }

    .search-choice-item-category {
      font-size: 12px;
      color: #f1c40f;
      font-weight: 600;
      text-transform: uppercase;
    }

    .search-choice-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .search-choice-btn {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .search-choice-btn.primary {
      background: #F5C842;
      color: #333;
    }

    .search-choice-btn.primary:hover {
      background: #E5B432;
      transform: translateY(-1px);
    }

    .search-choice-btn.secondary {
      background: #f8f9fa;
      color: #666;
      border: 2px solid #e9ecef;
    }

    .search-choice-btn.secondary:hover {
      background: #e9ecef;
      color: #333;
    }



    /* USUNIÄ˜TY STARY CONFIG-OVERVIEW - teraz uÅ¼ywamy przycisku + popup */

    /* USUNIÄ˜TY STARY CONFIG-OVERVIEW HOVER I CONTENT - teraz uÅ¼ywamy popup */





    hr {
      border: none;
      border-top: 1px solid #eee;
      margin: 16px 0 12px;
    }

    .selection-section h3 {
      font-size: 16px;
      margin-bottom: 10px;
      color: #555;
    }

    .options-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    /* âœ… TYLKO DLA GÅÃ“WNEJ LISTY KRZESEÅ - suwak i wiÄ™ksza wysokoÅ›Ä‡ */
    #model-section .options-grid {
      max-height: calc(100vh - 350px); /* âœ… WiÄ™cej miejsca na UI (byÅ‚o 200px) */
      overflow-y: auto; /* âœ… Suwak tylko tutaj */
      padding-right: 5px; /* âœ… Miejsce na suwak */
    }

    /* âœ… MOBILE: Tylko gÅ‚Ã³wna lista krzeseÅ‚ */
    @media (max-width: 768px) {
      #model-section .options-grid {
        max-height: calc(100vh - 400px); /* âœ… WiÄ™cej miejsca na mobile UI (byÅ‚o 250px) */
      }
    }

    .thumbnail-wrapper {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .thumbnail {
      width: 110px;
      height: 110px;
      object-fit: contain;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 8px;
      transition: all 0.2s;
      background-color: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4px;
      box-sizing: border-box;
      opacity: 1;
      /* Ikonki w peÅ‚ni widoczne */
    }

    .thumbnail:hover {
      transform: scale(1.05);
      border-color: #444;
    }

    .thumbnail.selected {
      outline: 2px solid #050505;
      border: 2px solid transparent;
      outline-offset: -2px;
      box-shadow: 0 0 8px rgba(49, 49, 49, 0.5);
    }

    .thumbnail.promotion {
      border: 2px solid #FF6B6B;
      position: relative;
    }

    .thumbnail.promotion::after {
      content: '';
      position: absolute;
      top: -2px;
      right: -2px;
      width: 12px;
      height: 12px;
      background: #FF6B6B;
      border-radius: 50%;
      z-index: 10;
      display: none; /* Ukryj kropkÄ™, uÅ¼yjemy prostokÄ…ta */
    }

    .thumbnail.promotion::before {
      content: attr(data-discount);
      position: absolute;
      bottom: 4px;
      left: 4px;
      background: #FF6B6B;
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 4px;
      border-radius: 3px;
      z-index: 10;
      line-height: 1;
      white-space: nowrap;
      display: inline-block;
      width: auto;
    }

    .thumbnail.promotion:hover {
      border-color: #FF5252;
    }

    .thumbnail.promotion.selected {
      border: 2px solid #FF6B6B;
      outline: 2px solid #FF5252;
    }

    /* Styl dla bestsellerÃ³w - zÅ‚ota ramka z gwiazdkÄ… */
    .thumbnail.bestseller {
      border: 2px solid #f5c842;
      position: relative;
    }

    .thumbnail.bestseller::after {
      content: '';
      position: absolute;
      top: -2px;
      right: -2px;
      width: 12px;
      height: 12px;
      background: #f5c842;
      border-radius: 50%;
      z-index: 10;
      display: none; /* Ukryj kropkÄ™, uÅ¼yjemy prostokÄ…ta */
    }

    .thumbnail.bestseller::after {
      content: 'â­';
      position: absolute;
      top: 4px;
      right: 4px;
      background: #f5c842;
      color: #333;
      font-size: 12px;
      font-weight: 700;
      padding: 2px 4px;
      border-radius: 3px;
      z-index: 10;
      line-height: 1;
      white-space: nowrap;
      display: inline-block;
      width: auto;
    }

    .thumbnail.bestseller:hover {
      border-color: #e5b432;
    }

    .thumbnail.bestseller.selected {
      border: 2px solid #f5c842;
      outline: 2px solid #e5b432;
    }

    /* Specjalny styl dla krzeseÅ‚ ktÃ³re sÄ… jednoczeÅ›nie promocjÄ… i bestsellerem */
    .thumbnail.promotion.bestseller {
      border: 3px solid;
      border-image: linear-gradient(45deg, #FF6B6B 0%, #FF6B6B 50%, #f5c842 50%, #f5c842 100%);
      border-image-slice: 1;
      position: relative;
    }

    .thumbnail.promotion.bestseller::after {
      content: 'â­';
      position: absolute;
      top: 4px;
      right: 4px;
      background: #f5c842;
      color: #333;
      font-size: 12px;
      font-weight: 700;
      padding: 2px 4px;
      border-radius: 3px;
      z-index: 11;
      line-height: 1;
      white-space: nowrap;
      display: inline-block;
      width: auto;
    }

    .thumbnail.promotion.bestseller:hover {
      border-image: linear-gradient(45deg, #FF5252 0%, #FF5252 50%, #e5b432 50%, #e5b432 100%);
      border-image-slice: 1;
    }

    .thumbnail.promotion.bestseller.selected {
      border: 3px solid;
      border-image: linear-gradient(45deg, #FF6B6B 0%, #FF6B6B 50%, #f5c842 50%, #f5c842 100%);
      border-image-slice: 1;
      outline: 2px solid rgba(255, 107, 107, 0.5);
    }

    .thumbnail img {
      max-width: 100%;
      max-height: 100%;
      opacity: 1;
    }

    .thumbnail-caption {
      font-size: 15px;
      color: #555;
      margin-top: 6px;
      font-weight: 500;
      opacity: 1;
    }

    .thumbnail-price {
      font-size: 13px;
      color: #333;
      margin-top: 4px;
      font-weight: 600;
      text-align: center;
    }

    .thumbnail-price.promotion {
      display: flex;
      flex-direction: column;
      gap: 1px;
      align-items: center;
    }

    .thumbnail-price.bestseller {
      display: flex;
      flex-direction: column;
      gap: 1px;
      align-items: center;
    }

    .thumbnail-price .original-price {
      color: #FF6B6B;
      text-decoration: line-through;
      font-size: 12px;
      font-weight: 600;
    }

    .thumbnail-price .discounted-price {
      color: #333;
      font-weight: 700;
      font-size: 14px;
    }

    .thumbnail-price .discount-badge {
      background: #FF6B6B;
      color: white;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 3px;
      margin-top: 2px;
    }

    .thumbnail-price .bestseller-badge {
      background: #f5c842;
      color: #333;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 3px;
      margin-top: 2px;
    }

    .thumbnail-price .bestseller-price {
      color: #333;
      font-weight: 700;
      font-size: 14px;
    }

    #overview-icons img {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      border: 1px solid #ddd;
      object-fit: contain;
      opacity: 1;
    }

    /* USUNIÄ˜TE STARE STYLE CONFIG-OVERVIEW */

    #back-to-models-container {
      display: flex;
      align-items: center;
      margin-bottom: 18px;
      justify-content: flex-start;
    }

    .back-to-model-btn {
      position: relative;
      width: 110px;
      height: 110px;
      border: 1.5px solid #bbb;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-right: 10px;
      transition: box-shadow 0.2s;
    }

    .back-to-model-btn:hover {
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
    }

    .back-to-model-btn img {
      width: 90px;
      height: 90px;
      object-fit: contain;
      display: block;
    }

    .back-to-model-btn .close-x {
      position: absolute;
      top: 4px;
      right: 6px;
      background: #fff;
      border: none;
      font-size: 20px;
      color: #333;
      cursor: pointer;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      line-height: 20px;
      padding: 0;
      box-shadow: 0 1px 4px #0001;
      transition: background 0.2s;
    }

    .back-to-model-btn .close-x:hover {
      background: #eee;
    }

    /* NakÅ‚adki promocji/bestseller dla przycisku powrotu */
    .back-to-model-btn.promotion::before {
      content: attr(data-discount);
      position: absolute;
      bottom: 4px;
      left: 4px;
      background: #FF6B6B;
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 4px;
      border-radius: 3px;
      z-index: 10;
      line-height: 1;
      white-space: nowrap;
      display: inline-block;
      width: auto;
    }

    .back-to-model-btn.bestseller::after {
      content: 'â­';
      position: absolute;
      top: 4px;
      right: 4px;
      background: #f5c842;
      color: #333;
      font-size: 12px;
      font-weight: 700;
      padding: 2px 4px;
      border-radius: 3px;
      z-index: 10;
      line-height: 1;
      white-space: nowrap;
      display: inline-block;
      width: auto;
    }

    .back-to-model-btn.promotion {
      border-color: #FF6B6B;
    }

    .back-to-model-btn.bestseller {
      border-color: #f5c842;
    }

    .back-to-model-btn.promotion.bestseller {
      border: 3px solid;
      border-image: linear-gradient(45deg, #FF6B6B 0%, #FF6B6B 50%, #f5c842 50%, #f5c842 100%);
      border-image-slice: 1;
    }

    #camera-debug-panel {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: #fff;
      border: 1px solid #ccc;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 8px #0002;
    }

    #camera-debug-panel label {
      display: block;
      margin: 8px 0 4px;
      font-size: 14px;
    }

    #camera-debug-panel input {
      width: 100%;
      margin-bottom: 8px;
    }

    #camera-debug-panel button {
      width: 100%;
      padding: 8px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #camera-debug-panel button:hover {
      background: #0056b3;
    }

    body {
      background: #ededed;
      /* lub TwÃ³j kolor tÅ‚a */
    }

    #buy-button {
      width: 100%;
      padding: 14px 0;
      background: white;
      color: #333;
      border: 2px solid #F5C842;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      margin-top: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    #buy-button:hover {
      background: #F5C842;
      color: #333;
    }

    #buy-button .cart-icon {
      width: 22px;
      height: 22px;
      display: inline-block;
    }

    #sidebar .model-image {
      width: 100%;
      max-width: 100%;
      height: 110px;
      object-fit: contain;
      display: block;
      margin: 0 auto 10px auto;
      background: #fff;
      border-radius: 10px;
      border: 1px solid #eee;
    }



    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.hidden {
      display: none;
    }

    .modal-content {
      position: fixed;
      top: 50%;
      left: 50%;
  transform: translate(-110%, -50%);
      width: 320px;
      background: #fff;
      padding: 24px 28px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      font-family: "Poppins", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      color: #222;
    }


    .close-button {
      position: absolute;
      top: 12px;
      right: 16px;
      cursor: pointer;
      font-size: 26px;
      font-weight: 700;
      color: #888;
      transition: color 0.2s ease;
    }

    .close-button:hover {
      color: #444;
    }

    .modal-content h2 {
      margin-top: 0;
      margin-bottom: 16px;
      font-weight: 700;
      font-size: 20px;
      text-align: center;
    }

    .modal-content label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 14px;
    }

    .modal-content input {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 18px;
      border: 1.5px solid #ddd;
      border-radius: 12px;
      font-size: 15px;
      box-sizing: border-box;
      transition: border-color 0.2s ease;
    }

    .modal-content input:focus {
      border-color: #888;
      outline: none;
    }

    .modal-content button[type="submit"] {
      width: 100%;
      background: white;
      color: #333;
      font-weight: 700;
      font-size: 16px;
      padding: 12px 0;
      border: 2px solid #F5C842;
      border-radius: 16px;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .modal-content button[type="submit"]:hover {
      background: #F5C842;
      color: #333;
    }

    /* Style dla nowego formularza zamÃ³wienia */
    #emailForm input:focus,
    #emailForm textarea:focus {
      outline: none;
      border-color: #F5C842 !important;
      box-shadow: 0 0 0 3px rgba(245, 200, 66, 0.2);
    }

    /* Komunikat sukcesu */
    #success-message {
      position: fixed;
      top: 50%;
      left: 50%;
  transform: translate(-100%, -50%) translateX(-80px);

      background: #ffffff;
      /* biaÅ‚e tÅ‚o */
      border: 1.5px solid #1f1f1f;
      /* czarna ramka */
      color: #1f1f1f;
      /* ciemnozielony tekst */

      font-weight: 700;
      font-family: "Poppins", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;

      padding: 20px 28px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(3, 3, 3, 0.15);

      max-width: 320px;
      width: 90%;
      text-align: center;
      z-index: 9999;
    }


    /* Ukrywanie i pokazywanie */
    .hidden {
      display: none;
    }

    .visible {
      display: block;
    }


    #bottom-toolbar {
      position: fixed;
      left: 20px;
      top: 50%;
      transform: translateY(-50%);
      background: #fff;
      border: 1.5px solid #ccc;
      border-radius: 12px;
      padding: 12px 8px;
      display: flex;
      flex-direction: column;
      gap: 16px;
      z-index: 2000;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      opacity: 0;
      transition: opacity 0.4s ease;
      justify-content: center;
      align-items: center;
    }


    #bottom-toolbar button {
      background: #f0f0f0;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    #bottom-toolbar.visible {
      opacity: 1;
    }

    #bottom-toolbar button:hover {
      background: #e0e0e0;
    }

  body.awaiting-selection #bottom-toolbar { display: none !important; }

    #dimension-overlay {
      position: fixed;
      top: 50%;
      left: 120px; /* TuÅ¼ obok bottom-toolbar */
      transform: translateY(-50%);
      width: 220px; /* Zmniejszone z 300px */
      max-height: 300px;
      background: #fff;
      border: 1.5px solid #ccc;
      border-radius: 12px;
      padding: 14px; /* Zmniejszone z 16px */
      pointer-events: auto;
      z-index: 2100;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
      overflow-y: auto;
      font-family: 'Poppins', sans-serif;
    }

    /* NagÅ‚Ã³wek panelu wymiarÃ³w */
    .dimension-panel-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
      padding-bottom: 8px;
      border-bottom: 1px solid #eee;
    }

    .dimension-panel-title {
      font-size: 16px;
      font-weight: 600;
      color: #333;
    }

    .dimension-close-btn {
      background: #f0f0f0;
      border: none;
      border-radius: 6px;
      width: 24px;
      height: 24px;
      cursor: pointer;
      font-size: 16px;
      color: #666;
      transition: background 0.2s ease;
    }

    .dimension-close-btn:hover {
      background: #e0e0e0;
    }

    /* Kontener dla wymiarÃ³w */
    .dimensions-container {
      display: flex;
      flex-direction: column;
      gap: 8px; /* Zmniejszone z 12px */
    }

    .dimension-item {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px; /* Zmniejszone z 10px 16px */
      background: #f9f9f9;
      border-radius: 8px;
      font-size: 14px;
      min-height: 18px; /* Zmniejszone z 20px */
      gap: 12px; /* Zmniejszone z 20px */
    }

    .dimension-label {
      color: #666;
      font-weight: 500;
      flex: 0 0 auto; /* Nie rozciÄ…gaj etykiety */
      text-align: left;
      min-width: 70px; /* Zmniejszone z 80px */
    }

    .dimension-value {
      color: #333;
      font-weight: 600;
      flex: 1; /* WartoÅ›Ä‡ zajmuje resztÄ™ miejsca */
      text-align: right;
      white-space: nowrap;
    }

    .dimension-line {
      position: absolute;
      background-color: #000;
      height: 2px;
    }

    .axis-line {
      position: absolute;
      height: 2px;
      background-color: #222;
      opacity: 0.6;
    }

    .axis-line.x {
      top: 50%;
      left: 0;
      width: 100%;
      transform: translateY(-50%);
    }

    .axis-line.y {
      left: 50%;
      top: 0;
      width: 2px;
      height: 100%;
      transform: translateX(-50%);
    }

    .axis-line.z {
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 2px dashed #888;
      box-sizing: border-box;
      border-radius: 10px;
    }

    .dimension-label {
      position: absolute;
      background-color: rgba(255, 255, 255, 0.7);
      padding: 5px;
      border-radius: 3px;
      font-size: 14px;
      font-weight: bold;
    }

    .dimension-label:nth-child(4) {
      top: 20px;
    }

    .dimension-label:nth-child(5) {
      top: 50%;
      transform: translate(-50%, -50%);
    }

    .dimension-label:nth-child(6) {
      bottom: 20px;
    }


    #qr-close-btn {
      background-color: #000;
      color: #fff;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s ease;
    }

    #qr-close-btn:hover {
      background-color: #333;
    }

    #qr-popup {
      position: fixed;
      top: 50%;
      left: 75%;
      transform: translate(-150%, -50%);
      background: white;
      padding: 20px 30px;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.2);
      display: block;
      z-index: 9999;
      text-align: center;
      max-width: 300px;
      border: 2px solid rgb(0, 0, 0);
      box-sizing: border-box;
    }

    #qr-popup p {
      font-size: 16px;
      margin-bottom: 12px;
      color: #000;
    }

    #qrcode {
      margin: 0 auto 16px auto;
      display: flex;
      justify-content: center;
    }

    .overview-header {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
    }

    /* USUNIÄ˜TE STARE STYLE CONFIG-OVERVIEW */

    /* ðŸ“± MOBILE RESPONSIVE ADAPTATIONS - Improved mobile fixes */
@media (max-width: 820px) {
  /* Mobile sidebar - responsive sizing based on screen size */
  #sidebar {
    width: 300px !important;
    max-width: 300px !important;
    min-width: 260px !important;
    padding: 16px 12px 80px 12px !important;
    height: 100vh !important;
    overflow-y: auto !important;
    scroll-padding-bottom: 80px !important;
    padding-bottom: calc(80px + env(safe-area-inset-bottom, 0px)) !important;
  }

  /* Mobile canvas - adjust for sidebar */
  #canvas-container {
    width: calc(100% - 300px) !important;
    height: 100vh !important;
    left: 300px !important;
  }

  #canvas {
    width: 100% !important;
    height: 100% !important;
    display: block !important;
  }

  /* Mobile category sections - responsive layout */
  #category-buttons {
    margin-bottom: 20px !important;
  }

  #special-categories-container {
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 8px !important;
    margin-bottom: 12px !important;
    justify-content: center !important;
  }

  #category-buttons-container {
    display: flex !important;
    flex-wrap: wrap !important;
    gap: 8px !important;
    justify-content: center !important;
  }

  /* Mobile category buttons - responsive sizing */
  .category-button {
    padding: 10px 16px !important;
    font-size: 14px !important;
    border-radius: 20px !important;
    min-width: 100px !important;
    text-align: center !important;
    min-height: 44px !important;
    display: flex !important;
    align-items: center !important;
    justify-content: center !important;
  }

  /* Mobile model section - responsive scrolling */
  #model-section {
    margin-bottom: 20px !important;
  }

  #model-section .options-grid {
    max-height: calc(100vh - 400px) !important;
    overflow-y: auto !important;
    padding-right: 5px !important;
    gap: 12px !important;
  }

  /* Mobile thumbnails - responsive sizing */
  .thumbnail-wrapper {
    margin-bottom: 15px !important;
  }

  .thumbnail {
    width: 110px !important;
    height: 110px !important;
    min-height: 110px !important;
  }

  .thumbnail img {
    max-width: 100% !important;
    max-height: 100% !important;
    object-fit: contain !important;
  }

  /* Mobile config section - responsive layout */
  #config-section {
    padding-bottom: 80px !important;
    max-height: calc(100vh - 200px) !important;
  }

  /* Mobile options grid - responsive layout */
  .options-grid {
    gap: 12px !important;
    padding-bottom: 40px !important;
  }

  /* Mobile part tabs - responsive layout */
  #part-tabs {
    display: flex !important;
    overflow-x: auto !important;
    flex-wrap: nowrap !important;
    gap: 8px !important;
    padding: 12px !important;
    justify-content: flex-start !important;
  }

  #part-tabs button,
  #part-tabs .part-btn {
    width: 52px !important;
    height: 52px !important;
    font-size: 11px !important;
    padding: 6px !important;
    flex: 0 0 auto !important;
  }

  /* Mobile material sections - responsive visibility */
  #materials-section {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    height: auto !important;
    overflow: visible !important;
  }

  /* Mobile collection groups - responsive scrolling */
  .collection-accordion-group {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
    max-height: 320px !important;
    overflow-y: auto !important;
    margin-bottom: 16px !important;
  }

  /* Mobile collection materials - responsive grid */
  .collection-materials-row {
    display: grid !important;
    grid-template-columns: repeat(auto-fill, minmax(75px, 1fr)) !important;
    gap: 10px !important;
    padding: 10px !important;
  }

  /* Mobile thumbnails - responsive functionality */
  .thumbnail {
    pointer-events: auto !important;
    cursor: pointer !important;
    display: flex !important;
    visibility: visible !important;
    opacity: 1 !important;
    width: 75px !important;
    height: 75px !important;
    min-width: 75px !important;
    min-height: 75px !important;
  }

  /* Mobile bottom toolbar - responsive positioning */
  #bottom-toolbar {
    left: 15px !important;
    padding: 10px 8px !important;
    gap: 12px !important;
  }

  #bottom-toolbar button {
    width: 36px !important;
    height: 36px !important;
    padding: 8px !important;
  }

  #bottom-toolbar img {
    width: 18px !important;
    height: 18px !important;
  }

  /* Mobile config overview button - responsive positioning */
  #config-overview-button {
    bottom: 20px !important;
    left: 20px !important;
    padding: 10px 16px !important;
    font-size: 13px !important;
    min-height: 44px !important;
  }

  /* Hide rotation message on mobile */
  #rotation-message {
    display: none !important;
  }

  /* Hide export panel on mobile */
  #export-panel {
    display: none !important;
  }

  /* Hide mobile-specific panels */
  #mobile-right-panel {
    display: none !important;
  }
}

/* ðŸ¤– Tryb POZIOMY â€” pokazujemy UI */
@media (max-width: 820px) and (orientation: landscape) {
  #rotation-message {
    display: none !important;
  }

  canvas {
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
  width: 100%;
  height: 100vh;
  display: block;
}

 #sidebar {
  width: 280px; /* staÅ‚a szerokoÅ›Ä‡ panelu UI */
  max-width: 280px;
  min-width: 280px;
  box-sizing: border-box;
  overflow-y: auto;
  padding: 8px;
}

  /* Responsywne style dla wyszukiwania na mobile */
  #search-toggle {
    width: 38px;
    height: 38px;
  }

  #search-toggle svg {
    width: 18px;
    height: 18px;
  }

  #search-panel {
    width: 240px;
  }

  #search-input {
    padding: 10px 12px;
    font-size: 14px;
  }

  #search-results {
    max-height: 150px;
  }

  .search-result-item {
    padding: 6px 10px;
    font-size: 14px;
  }

#part-tabs {
  display: flex;
  flex-wrap: nowrap; /* ðŸ”’ nie zawijaj w nowe linie */
  overflow-x: auto;  /* ðŸ”„ pozwÃ³l na przesuwanie */
  gap: 8px;
  padding: 8px;
  justify-content: flex-start;
}

/* Styl dla pojedynczej ikonki */
#part-tabs button,
#part-tabs .part-btn {
  width: 56px;
  height: 56px;
  font-size: 11px;
  padding: 6px;
  flex: 0 0 auto; /* ðŸ” staÅ‚a szerokoÅ›Ä‡ */
  border-radius: 6px;
  box-sizing: border-box;
}

/* JeÅ›li ikonka ma obrazek */
#part-tabs img {
  width: 32px;
  height: 32px;
}


#bottom-toolbar {
  left: 20px;
  top: 50%;
  transform: translateY(-50%);
  padding: 12px 8px;
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  gap: 12px;
}

/* Responsive style dla dimension-overlay na mobile */
#dimension-overlay {
  left: 320px !important; /* UmieÅ›Ä‡ za sidebarem (280px + 40px margin) */
  width: 250px !important;
  max-height: 300px !important;
  font-size: 12px !important;
}

.dimension-panel-title {
  font-size: 14px !important;
}

.dimension-item {
  padding: 8px 12px !important;
  font-size: 12px !important;
}

.dimension-label {
  margin-right: 15px !important;
}

.dimension-value {
  font-size: 12px !important;
}

#export-panel {
    display: none !important;
    visibility: hidden;
    pointer-events: none;
  }

   #export-config,
  .export-trigger,
  .toolbar-btn[data-action="export"] {
    display: none !important;
  }



  .thumbnail,
  #overview-icons img,
  .back-to-model-btn {
    width: 70px;
    height: 70px;
  }

  .thumbnail-caption {
    font-size: 12px;
    margin-top: 6px;
    text-align: center;
    max-width: 75px;
    line-height: 1.2;
  }

  /* Fix cut icons - ensure proper sizing and spacing */
  .thumbnail img {
    max-width: 100%;
    max-height: 100%;
    object-fit: contain;
  }

  /* Mobile model section improvements */
  #model-section {
    padding-bottom: 20px;
  }

  #model-section .options-grid {
    max-height: calc(100vh - 300px);
    overflow-y: auto;
    padding-right: 8px;
    margin-bottom: 20px;
  }

  #buy-button {
    font-size: 14px;
    padding: 10px;
    width: 100%;
    margin-top: 12px;
  }

  /* USUNIÄ˜TE STARE MOBILE STYLE CONFIG-OVERVIEW */
}



    .dimension-panel {
      background-color: white;
      border: 1px solid #ccc;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      z-index: 1001;
    }

    #hdr-toggle {
      position: relative;
    }

    /* Panel jasnoÅ›ci - wycentrowany wzglÄ™dem przycisku Å¼arÃ³wki */
    #brightness-panel {
      position: absolute;
      top: 50%;
      left: 100%;
      transform: translate(15px, -50%);
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 10px 0;
      width: 50px;
      height: 150px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1005;
    }

    #brightness-panel.hidden {
      display: none;
    }

    /* Pionowy suwak jasnoÅ›ci - idealnie wycentrowany */
    #brightness-panel #brightness-slider {
      writing-mode: bt-lr !important; /* IE */
      -webkit-appearance: slider-vertical !important; /* WebKit */
      appearance: slider-vertical !important;
      width: 8px !important;
      height: 130px !important; /* 150px panel - 20px padding = 130px */
      background-color: #333 !important; /* Czarny pasek suwaka */
      background: #333 !important;
      outline: none !important;
      border-radius: 4px !important;
      cursor: pointer !important;
      border: none !important;
      margin: 0 !important;
      display: block !important;
      /* Dodatkowe resetowanie dla thumb */
      accent-color: #F5C842 !important;
      color-scheme: none !important;
      /* Reset user agent styles */
      padding: 0 !important;
      border-width: 0 !important;
      border-style: none !important;
      background-color: #333 !important;
    }

    /* Alternatywny selektor dla thumb */
    #brightness-panel input[type="range"]::-webkit-slider-thumb {
      -webkit-appearance: none !important;
      width: 18px !important;
      height: 18px !important;
      border-radius: 50% !important;
      background: #F5C842 !important;
      border: 2px solid #fff !important;
      cursor: pointer !important;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3) !important;
      position: relative !important;
      left: 4px !important; /* ZwiÄ™kszone przesuniÄ™cie w prawo */
    }

    /* Kompletnie nowe style dla thumb - delikatne przesuniÄ™cie w prawo */
    #brightness-panel #brightness-slider::-webkit-slider-thumb {
      -webkit-appearance: none !important;
      width: 18px !important;
      height: 18px !important;
      border-radius: 50% !important;
      background: #F5C842 !important;
      border: 2px solid #fff !important;
      cursor: pointer !important;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3) !important;
      margin: 0 !important;
      position: relative !important;
  left: 4px !important; /* ZwiÄ™kszone przesuniÄ™cie w prawo (desktop) */
    }

    #brightness-panel #brightness-slider::-moz-range-thumb {
      -moz-appearance: none !important;
      width: 18px !important;
      height: 18px !important;
      border-radius: 50% !important;
      background: #F5C842 !important;
      border: 2px solid #fff !important;
      cursor: pointer !important;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3) !important;
      margin: 0 !important;
    }

    /* Dodatkowe resetowanie dla MS Edge */
    #brightness-panel #brightness-slider::-ms-thumb {
      appearance: none !important;
      width: 24px !important;
      height: 24px !important;
      border-radius: 50% !important;
      background: #F5C842 !important;
      background-color: #F5C842 !important;
      border: 3px solid #fff !important;
      box-shadow: 0 2px 8px rgba(0,0,0,0.4) !important;
    }

    /* ðŸ“± Mobile-only fix: center yellow thumb on the black track */
    @media (max-width: 820px) {
      /* iOS Safari vertical slider: center 18px thumb over 8px track => (18-8)/2 â‰ˆ 5px */
      #brightness-panel input[type="range"]::-webkit-slider-thumb,
      #brightness-panel #brightness-slider::-webkit-slider-thumb {
        left: 5px !important; /* mobile offset for perfect centering */
      }
      /* Ensure track and thumb visually align on narrow mobile UI */
      #brightness-panel #brightness-slider {
        width: 8px !important;   /* keep narrow track */
      }
      #brightness-panel #brightness-slider::-webkit-slider-runnable-track,
      #brightness-panel #brightness-slider::-moz-range-track {
        width: 8px !important;
      }
    }

    /* Mozilla specific track styling */
    #brightness-panel #brightness-slider::-moz-range-track {
      background-color: #333 !important;
      background: #333 !important;
      width: 8px !important;
      height: 8px !important;
      border-radius: 4px !important;
      border: none !important;
    }

    /* WebKit track styling */
    #brightness-panel #brightness-slider::-webkit-slider-runnable-track {
      background-color: #333 !important;
      background: #333 !important;
      width: 8px !important;
      height: 8px !important;
      border-radius: 4px !important;
      border: none !important;
    }

    /* ===== Custom mobile slider (perfectly centered thumb) ===== */
    /* Hidden by default (desktop uses native input range) */
    #brightness-slider-mobile { display: none; }
    #brightness-slider-mobile { position: relative; width: 30px; height: 130px; user-select: none; -webkit-user-select: none; touch-action: none; }
    #brightness-slider-mobile .track { position: absolute; left: 50%; top: 0; width: 8px; height: 100%; transform: translateX(-50%); background: #333; border-radius: 4px; }
    #brightness-slider-mobile .thumb { position: absolute; left: 50%; width: 18px; height: 18px; transform: translate(-50%, -50%); border-radius: 50%; background: #F5C842; border: 2px solid #fff; box-shadow: 0 2px 6px rgba(0,0,0,0.3); touch-action: none; cursor: pointer; }

    /* Show custom slider only on mobile, hide native input there */
    @media (max-width: 820px) {
      #brightness-panel #brightness-slider { display: none !important; }
      #brightness-slider-mobile { display: block; }
    }

  /* Overlay to capture first outside tap on mobile and close only the brightness slider */
  #brightness-dismiss-layer { position: fixed; inset: 0; background: transparent; z-index: 1004; display: none; pointer-events: auto; }
    @media (max-width: 820px) {
      #brightness-dismiss-layer.mobile-active { display: block; }
    }

    /* ðŸ“± Center popups on mobile only */
    @media (max-width: 820px) {
      #dimension-overlay {
        left: 50% !important;
        top: 50% !important;
        transform: translate(-50%, -50%) !important;
        width: 90vw !important;
        max-width: 360px !important;
        z-index: 2100 !important;
      }

      #ar-popup {
        top: 50% !important;
        left: 50% !important;
        transform: translate(-50%, -50%) !important;
        width: 90vw !important;
        max-width: 360px !important;
      }
    }

    /* === In-page WebXR AR overlay (minimal styles) === */
    #xr-exit-btn {
      position: fixed; bottom: 20px; right: 20px; z-index: 3000;
      background: rgba(0,0,0,0.65); color: #fff; border: 0; border-radius: 8px;
      padding: 10px 14px; font-size: 14px; display: none;
    }
    #xr-reticle { position: fixed; left: 50%; top: 50%; width: 40px; height: 40px; margin: -20px 0 0 -20px; z-index: 2999; display: none; pointer-events: none; }
    #xr-reticle::before {
      content: ""; position: absolute; inset: 0; border-radius: 50%;
      border: 2px solid rgba(255, 215, 0, 0.9); box-shadow: 0 0 8px rgba(255,215,0,0.6);
    }

    #hdr-panel {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      background: #fff;
      border-radius: 12px;
      padding: 12px 16px;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
      z-index: 9999;
      min-width: 240px;
      display: none;
      padding-top: 30px;
    }

    #hdr-panel.hidden {
      display: none;
    }

    #hdr-close {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #111111;
      z-index: 1000;
    }

    #hdr-options {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      padding-top: 10px;
    }

    #hdr-options .thumbnail {
      width: 72px;
      height: 72px;
    }

    #hdr-options .thumbnail img {
      max-width: 100%;
      max-height: 100%;
    }

    .hdr-close-btn {
      position: absolute;
      top: 8px;
      right: 10px;
      background: none;
      border: none;
      font-size: 22px;
      font-weight: bold;
      cursor: pointer;
      color: #555;
      z-index: 10000;
    }

    .hdr-close-btn:hover {
      color: #000;
    }

    #export-panel {
      position: absolute;
      bottom: 60px;
      /* nad przyciskiem */
      right: 62px;
      /* <- tu zwiÄ™ksz wartoÅ›Ä‡, Å¼eby przesunÄ…Ä‡ panel bardziej w lewo */
      background: #ffffff;
      border: 1px solid #eeeeee;
      border-radius: 8px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    #export-panel.hidden {
      display: none;
    }

    .export-btn {
      background-color: #444;
      color: #222222;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
      white-space: nowrap;
    }

    .export-btn:hover {
      background-color: #555;
    }
/*Ukrycie przyciku exportu*/
#export-config {
  display: none;
}

#export-panel {
  display: none;
}

   .collection-icon {
  width: 64px;
  height: 64px;
  object-fit: contain;
  cursor: pointer;
  border: 1px solid #ccc;
  border-radius: 8px;
  transition: transform 0.2s, border-color 0.2s;
}

.collection-icon:hover {
  transform: scale(1.05);
  border-color: #444;
}

.collection-icon.selected {
  outline: 2px solid #000;
  box-shadow: 0 0 8px rgba(0,0,0,0.2);
}




    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #material-options details summary {
      cursor: pointer;
      font-weight: bold;
      background: #f7f7f7;
      border-radius: 8px;
      padding: 6px 10px;
      margin-bottom: 6px;
    }

    .collection-icon {
  width: 64px;
  height: 64px;
  object-fit: contain;
  cursor: pointer;
  border: 1px solid #ccc;
  border-radius: 8px;
  transition: transform 0.2s, border-color 0.2s;
}

.collection-icon:hover {
  transform: scale(1.05);
  border-color: #444;
}

.collection-icon.selected {
  outline: 2px solid #000;
  box-shadow: 0 0 8px rgba(0,0,0,0.2);
}

.collection-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
  width: 88px;
  align-items: center;
}

#custom-loader {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  font-family: 'Poppins', Arial, sans-serif;
}

#custom-loader.fade-out {
  opacity: 0;
  transition: opacity 0.5s ease;
  pointer-events: none;
}

#model-loader {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255, 255, 255, 0.97);
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  font-family: 'Poppins', Arial, sans-serif;
  transition: opacity 0.5s ease-in-out;
}

#model-loader p {
  font-size: 18px;
  color: #333;
  text-align: center;
  margin: 10px 0 0 0;
  font-weight: 500;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

/* Model loader animations */
@keyframes logoPulse {
  0%, 100% { opacity: 0.9; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.05); }
}

@keyframes progressSlide {
  0% { transform: translateX(-100%); }
  50% { transform: translateX(0%); }
  100% { transform: translateX(100%); }
}

/* ðŸŽ¯ WELCOME SCREEN */
#welcome-screen {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  background: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 100;
  font-family: 'Poppins', Arial, sans-serif;
  text-align: center;
  padding: 20px;
  /* Ukrywa tylko canvas, nie UI */
  overflow-y: auto; /* UmoÅ¼liwia przewijanie */
  box-sizing: border-box;
}

/* ðŸ“± Mobilne kontenery PWA - zawsze widoczne */
#mobile-category-buttons-container,
#mobile-model-thumbnails {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

/* ðŸ“± Mobilne UI - osobne komponenty */
#mobile-ui-container {
  display: none !important; /* Ukryj domyÅ›lnie na desktop */
}

@media (max-width: 820px) {
  /* Mobile right panel - HIDDEN on mobile to force desktop UI */
  #mobile-right-panel {
    display: none !important;
    visibility: hidden !important;
    opacity: 0 !important;
  }
  /* Welcome overlay i canvas zajmujÄ… pozostaÅ‚Ä… przestrzeÅ„ */
  #welcome-screen {
    width: calc(100% - 460px) !important;
    right: auto;
    left: 0;
  }
  #canvas-container {
    width: calc(100% - 460px) !important;
  }
  /* Do not use the old mobile container inside welcome */
  #welcome-screen #mobile-ui-container {
    display: none !important;
  }
  /* FORCE desktop sidebar to be visible on mobile */
  #sidebar {
    display: block !important;
    visibility: visible !important;
    opacity: 1 !important;
  }
}

/* Extra small phones (320px-480px) - Improved responsive design */
@media (max-width: 480px) {
  /* Mobile sidebar - even smaller for very small screens */
  #sidebar {
    width: 280px !important;
    max-width: 280px !important;
    min-width: 260px !important;
    padding: 12px 8px 60px 8px !important;
    height: 100vh !important;
    overflow-y: auto !important;
    scroll-padding-bottom: 60px !important;
    padding-bottom: calc(60px + env(safe-area-inset-bottom, 0px)) !important;
  }

  /* Mobile canvas - adjust for smaller sidebar */
  #canvas-container {
    width: calc(100% - 280px) !important;
    height: 100vh !important;
  }

  /* Smaller UI elements for very small screens */
  .thumbnail {
    width: 85px !important;
    height: 85px !important;
    min-height: 85px !important;
  }

  .thumbnail img {
    max-width: 85px !important;
    max-height: 85px !important;
  }

  .category-button {
    padding: 6px 12px !important;
    font-size: 12px !important;
    min-width: 80px !important;
  }

  /* Smaller bottom toolbar */
  #bottom-toolbar {
    left: 10px !important;
    padding: 6px 4px !important;
    gap: 8px !important;
  }

  #bottom-toolbar button {
    width: 28px !important;
    height: 28px !important;
    padding: 4px !important;
  }

  #bottom-toolbar img {
    width: 14px !important;
    height: 14px !important;
  }

  /* Config overview button positioning */
  #config-overview-button {
    bottom: 10px !important;
    left: 10px !important;
    padding: 6px 12px !important;
    font-size: 11px !important;
  }
}

/* Very small phones (under 380px) - Ultra compact design */
@media (max-width: 380px) {
  /* Mobile sidebar - minimal width for very small screens */
  #sidebar {
    width: 260px !important;
    max-width: 260px !important;
    min-width: 240px !important;
    padding: 10px 6px 50px 6px !important;
    height: 100vh !important;
    overflow-y: auto !important;
    scroll-padding-bottom: 50px !important;
    padding-bottom: calc(50px + env(safe-area-inset-bottom, 0px)) !important;
  }

  /* Mobile canvas - adjust for minimal sidebar */
  #canvas-container {
    width: calc(100% - 260px) !important;
    height: 100vh !important;
  }

  /* Ultra compact UI elements */
  .thumbnail {
    width: 75px !important;
    height: 75px !important;
    min-height: 75px !important;
  }

  .thumbnail img {
    max-width: 75px !important;
    max-height: 75px !important;
  }

  .category-button {
    padding: 5px 10px !important;
    font-size: 11px !important;
    min-width: 70px !important;
  }

  /* Minimal bottom toolbar */
  #bottom-toolbar {
    left: 8px !important;
    padding: 4px 3px !important;
    gap: 6px !important;
  }

  #bottom-toolbar button {
    width: 24px !important;
    height: 24px !important;
    padding: 3px !important;
  }

  #bottom-toolbar img {
    width: 12px !important;
    height: 12px !important;
  }

  /* Config overview button minimal positioning */
  #config-overview-button {
    bottom: 8px !important;
    left: 8px !important;
    padding: 5px 10px !important;
    font-size: 10px !important;
  }

  /* Smaller text elements */
  .thumbnail-caption {
    font-size: 10px !important;
    margin-top: 4px !important;
  }

  /* Compact model section */
  #model-section {
    margin-bottom: 15px !important;
  }

  #model-section .options-grid {
    max-height: calc(100vh - 350px) !important;
    gap: 6px !important;
  }
}

/* ðŸ“± Force-mobile rules via body.mobile-mode (UA-based) */
body.mobile-mode #mobile-right-panel {
  position: absolute;
  top: 0;
  right: 0;
  width: 140px;
  height: 100vh;
  background: #fff;
  border-left: 1px solid rgba(0,0,0,0.08);
  box-shadow: -6px 0 24px rgba(0,0,0,0.06);
  z-index: 150;
  overflow-y: auto;
  padding: 12px;
  display: block !important; /* Override inline display:none set in markup on mobile */
}
body.mobile-mode #welcome-screen {
  width: calc(100% - 280px);
  right: auto;
  left: 0;
  display: none !important; /* ðŸš« Never show welcome overlay in mobile-mode */
}
body.mobile-mode #welcome-screen #mobile-ui-container { display: none !important; }
body.mobile-mode #sidebar { 
  position: absolute !important;
  visibility: hidden !important;
  pointer-events: none !important;
  width: 0 !important;
  height: 0 !important;
  overflow: hidden !important;
  opacity: 0 !important;
}
body.mobile-mode #mobile-right-panel .thumbnail { 
  display:flex; 
  flex-direction:column; 
  align-items:center; 
  justify-content:center; 
  padding:4px; 
  background:#fff; 
  border:1px solid #e5e5e5; 
  border-radius:8px; 
  width: 80px; /* SzerokoÅ›Ä‡ dla 3 ikon w rzÄ™dzie w panelu 280px */
  margin: 2px;
}
body.mobile-mode #mobile-right-panel .thumbnail img { 
  width:60px; 
  height:60px; 
  object-fit:contain; 
}
body.mobile-mode #mobile-right-panel .thumbnail div { 
  font-size:11px; 
  margin-top:4px; 
  text-align:center; 
  line-height:1.2;
}
body.mobile-mode #canvas-container {
  width: calc(100% - 140px) !important;
  margin-left: 0 !important;
  margin-right: 0 !important;
  position: relative !important;
  left: 0 !important;
  right: auto !important;
}
body.mobile-mode #standalone-mobile-ui {
  display: none !important;
}

/* ðŸ“± FALLBACK dla bardzo maÅ‚ych ekranÃ³w - force mobile UI */
@media (max-width: 500px) {
  #mobile-right-panel {
    display: block !important;
    position: fixed !important;
    top: 0 !important;
    right: 0 !important;
    width: 33vw !important;
    height: 100vh !important;
    background: #fff !important;
    border-left: 1px solid rgba(0,0,0,0.08) !important;
    box-shadow: -6px 0 24px rgba(0,0,0,0.06) !important;
    z-index: 150 !important;
    overflow-y: auto !important;
    padding: 12px !important;
  }
  #welcome-screen {
    width: 67vw !important;
  }
  #canvas-container {
    width: 67vw !important;
  }
  #sidebar {
    display: none !important;
  }
}

/* ðŸ“± Style dla mobilnych przyciskÃ³w kategori PWA */
#mobile-category-buttons-container .category-button {
  transition: all 0.2s ease;
}

#mobile-category-buttons-container .category-button:hover {
  transform: scale(1.05);
  box-shadow: 0 2px 8px rgba(245, 200, 66, 0.3);
}

/* Mobile responsive dla welcome screen */
@media (max-width: 820px) {
  #welcome-screen {
    justify-content: flex-start;
    padding: 20px 15px;
  }
  
  #welcome-screen h1 {
    font-size: 1.6em; /* Zmniejszone z 2em */
  }
  
  #welcome-logo {
    max-width: 100px; /* Zmniejszone z 150px */
    margin-bottom: 15px; /* Zmniejszone z 20px */
  }
  
  /* Przyciski kategorii na mobile */
  .category-button {
    font-size: 12px;
    padding: 6px 12px;
    margin: 2px;
  }
  
  #category-buttons-container {
    gap: 6px !important;
  }
}

#welcome-logo {
  max-width: 200px;
  height: auto;
  margin-bottom: 30px;
  animation: logoPulse 3s ease-in-out infinite;
}

#welcome-screen h1 {
  font-size: 2.5em;
  font-weight: 600;
  color: #333;
  margin: 0 0 20px 0;
}

#welcome-screen p {
  font-size: 1.1em;
  color: #666;
  max-width: 500px;
  line-height: 1.5;
  margin: 0;
}

/* Welcome screen yellow accents */
.title-with-accent {
  position: relative;
  margin-bottom: 25px;
}

.title-with-accent h1 {
  margin-bottom: 15px !important;
}

.yellow-accent-line {
  width: 120px;
  height: 4px;
  background: linear-gradient(90deg, #FFD700, #FFA500);
  margin: 0 auto;
  border-radius: 2px;
  animation: accentGlow 2s ease-in-out infinite;
}

.promo-text {
  font-size: 1em !important;
  color: #555 !important;
  font-style: normal;
  margin-top: 20px !important;
  opacity: 0.9;
  animation: fadeInUp 1s ease-out 0.5s both;
}

@keyframes accentGlow {
  0%, 100% { 
    transform: scaleX(1);
    box-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
  }
  50% { 
    transform: scaleX(1.1);
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
  }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 0.9;
    transform: translateY(0);
  }
}

/* ï¿½ PWA SUCCESS SCREEN */
#pwa-success-screen {
  position: fixed;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  background: #fff;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 2147483648;
  font-family: 'Poppins', Arial, sans-serif;
  text-align: center;
  padding: 20px;
  overflow-y: auto;
  box-sizing: border-box;
}

#pwa-success-screen.show {
  display: flex;
}

#pwa-success-screen .success-icon {
  font-size: 80px;
  color: #4CAF50;
  margin-bottom: 20px;
  animation: successPulse 2s ease-in-out infinite;
}

#pwa-success-screen h1 {
  font-size: 2.2em;
  font-weight: 600;
  color: #333;
  margin: 0 0 15px 0;
}

#pwa-success-screen p {
  font-size: 1.1em;
  color: #666;
  max-width: 450px;
  line-height: 1.5;
  margin: 0 0 30px 0;
}

.pwa-continue-btn {
  background: linear-gradient(135deg, #4CAF50, #45a049);
  color: white;
  border: none;
  padding: 15px 30px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 30px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
}

.pwa-continue-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
}

/* ðŸŽ¯ PWA SPECIFIC STYLES FOR CHAIR THUMBNAILS */
#pwa-success-screen .options-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  justify-content: center;
  max-width: 600px;
  margin: 0 auto;
}

#pwa-success-screen .thumbnail-wrapper {
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
}

#pwa-success-screen .thumbnail {
  width: 80px;
  height: 80px;
  object-fit: contain;
  cursor: pointer;
  border: 1px solid #ccc;
  border-radius: 8px;
  transition: all 0.2s;
  background-color: transparent;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 4px;
  box-sizing: border-box;
  opacity: 1;
}

#pwa-success-screen .thumbnail:hover {
  transform: scale(1.05);
  border-color: #444;
}

#pwa-success-screen .thumbnail img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  border-radius: 8px;
}

#pwa-success-screen .thumbnail-caption {
  font-size: 15px;
  color: #555;
  margin-top: 6px;
  font-weight: 500;
  opacity: 1;
  max-width: 80px;
  line-height: 1.2;
}

/* Przyciski kategorii w PWA - IDENTYCZNE jak desktop */
#pwa-success-screen .category-button {
  padding: 8px 16px;
  border: 2px solid #F5C842;
  background: white;
  color: #333;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  text-transform: capitalize;
  margin: 4px;
}

#pwa-success-screen .category-button:hover {
  background: #F5C842;
  color: white;
  transform: translateY(-1px);
}

#pwa-success-screen .category-button.active {
  background: #F5C842;
  color: white;
}

#pwa-success-screen .category-button.promotion {
  border-color: #FF6B6B;
  color: #FF6B6B;
}

#pwa-success-screen .category-button.promotion:hover,
#pwa-success-screen .category-button.promotion.active {
  background: #FF6B6B;
  color: white;
}

@keyframes successPulse {
  0%, 100% { 
    transform: scale(1);
    opacity: 1;
  }
  50% { 
    transform: scale(1.1);
    opacity: 0.8;
  }
}

/* ï¿½ðŸŽ¬ ANIMATIONS */
@keyframes logoPulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.05); opacity: 0.8; }
  100% { transform: scale(1); opacity: 1; }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes pulse {
  0% { 
    transform: scale(1);
    box-shadow: 0 4px 15px rgba(245, 200, 66, 0.4);
  }
  50% { 
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(245, 200, 66, 0.6);
  }
  100% { 
    transform: scale(1);
    box-shadow: 0 4px 15px rgba(245, 200, 66, 0.4);
  }
}

@keyframes progressSlide {
  0% { transform: translateX(-100%); }
  50% { transform: translateX(0%); }
  100% { transform: translateX(100%); }
}

.loader {
  border: 8px solid #f3f3f3;
  border-top: 8px solid #555;
  
  border-radius: 50%;
  width: 48px;
  height: 48px;
  animation: spin 1s linear infinite;
  display: inline-block;
  margin-bottom: 12px;
}
@keyframes spin {
  0% { transform: rotate(0deg);}
  100% { transform: rotate(360deg);}
}

@keyframes rotatePhone {
  0% { transform: rotate(0deg); }
  25% { transform: rotate(-15deg); }
  75% { transform: rotate(15deg); }
  100% { transform: rotate(0deg); }
}


  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <script>
      console.log('ðŸ“± SCRIPT START: Mobile bootstrap starting...');
      
      // ðŸš€ EARLY MOBILE-ONLY BOOTSTRAP (runs before main init)
      (function(){
        console.log('ðŸ“± BOOTSTRAP FUNCTION: Starting mobile check');
        
        try {
          const urlFlag = /[?#&]mobile=1\b/.test(location.search + location.hash);
          const uaMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                           (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
          const coarse = (window.matchMedia && matchMedia('(pointer: coarse)').matches) || navigator.maxTouchPoints > 0;
          const narrow = window.innerWidth <= 820;
          
          console.log('ðŸ“± CHECKS:', { urlFlag, uaMobile, coarse, narrow });
          
          const isMobileEarly = urlFlag || uaMobile || coarse || narrow;
          
          // Global mobile check function
          window.isMobileNow = function() {
            return urlFlag || uaMobile || coarse || narrow || document.body.classList.contains('mobile-mode');
          };
          
          // ENABLED: Mobile panel creation for physical devices
          window.forceMobilePanel = function() {
            console.log('ðŸ“± Creating mobile panel...');
            const panel = document.createElement('aside');
            panel.id = 'mobile-right-panel';
            panel.style.cssText = 'position: fixed; top: 0; right: 0; width: 33vw; height: 100vh; background: #fff; border-left: 1px solid rgba(0,0,0,0.08); box-shadow: -6px 0 24px rgba(0,0,0,0.06); z-index: 150; overflow-y: auto; padding: 12px; display: block;';
            panel.innerHTML = `
              <div style="padding:15px;background:white;height:100vh;overflow-y:auto;">
                <div id="category-buttons" style="margin-bottom: 20px;">
                  <h3 style="margin-bottom: 10px; font-size: 16px; color: #555;">Kategorie:</h3>
                  <div id="special-categories-container" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;"></div>
                  <div id="category-buttons-container" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                </div>

                <div id="model-section" style="display: block;">
                  <div class="selection-section">
                    <h3>Wybierz model:</h3>
                    <div id="model-thumbnails" class="options-grid"></div>
                  </div>
                </div>

                <div id="config-section" style="display:none;">
                  <div id="back-to-models-container" style="margin-bottom: 15px;"></div>
                  <div id="legs-section" class="selection-section">
                    <h3>Nogi:</h3>
                    <div id="legs-thumbnails" class="options-grid"></div>
                  </div>
                  <div id="parts-section" class="selection-section">
                    <div id="part-tabs" class="options-grid"></div>
                  </div>
                  <div id="materials-section" class="selection-section">
                    <h3>Wybierz materiaÅ‚:</h3>
                    <div id="material-options" style="display:none;"></div>
                  </div>
                  <div id="summary"></div>
                </div>
              </div>
            `;
            (document.getElementById('app') || document.body).appendChild(panel);
            console.log('âœ… Mobile panel created successfully');
            return panel;
          };
          
          if (!isMobileEarly) {
            console.log('ðŸ“± NOT MOBILE: Exiting bootstrap');
            return;
          }
          
          console.log('ðŸ“± IS MOBILE: Continuing bootstrap');

          // Force mobile-mode class ASAP so CSS applies before other scripts run
          try { document.body.classList.add('mobile-mode'); } catch(_) {}
          try { window.mobileWelcomeDismissed = true; } catch(_) {}
          console.log('ðŸ“± EARLY: Mobile mode forced, welcome dismissed');

          // Create/ensure the right mobile panel exists and is visible
          (function ensureEarlyMobilePanel(){
            const panel = window.forceMobilePanel();
            
            // Add proper sidebar structure like desktop
            panel.innerHTML = `
              <div style="padding:15px;background:white;height:100vh;overflow-y:auto;">
                <div id="category-buttons" style="margin-bottom: 20px;">
                  <h3 style="margin-bottom: 10px; font-size: 16px; color: #555;">Kategorie:</h3>
                  <div id="special-categories-container" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;"></div>
                  <div id="category-buttons-container" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                </div>
                
                <div id="model-section" style="display: block;">
                  <div class="selection-section">
                    <h3>Wybierz model:</h3>
                    <div id="model-thumbnails" class="options-grid"></div>
                  </div>
                </div>
                
                <div id="config-section" style="display:none;">
                  <div id="back-to-models-container" style="margin-bottom: 15px;"></div>
                  <div id="legs-section" class="selection-section">
                    <h3>Nogi:</h3>
                    <div id="legs-thumbnails" class="options-grid"></div>
                  </div>
                  <div id="parts-section" class="selection-section">
                    <div id="part-tabs" class="options-grid"></div>
                  </div>
                  <div id="materials-section" class="selection-section">
                    <h3>Wybierz materiaÅ‚:</h3>
                    <div id="material-options" style="display:none;"></div>
                  </div>
                  <div id="summary"></div>
                </div>
              </div>
            `;
            
            console.log('ðŸ“± EARLY: Mobile panel created with proper structure');
              
              // PozwÃ³l normalnej sekwencji Å‚adowania danych i renderowania
              console.log('ðŸ“± EARLY: Bootstrap complete, waiting for normal data loading...');
              if (window.allData && window.allData.length > 0) {
                console.log('ðŸ“± EARLY: Data available, forcing category render');
                
                // Clear placeholder and render real categories
                const categorySection = document.createElement('div');
                categorySection.id = 'category-buttons';
                categorySection.innerHTML = `
                  <h3 style="margin:0 0 10px 0;font-size:16px;color:#555;">Kategorie:</h3>
                  <div id="special-categories-container" style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:12px;"></div>
                  <div id="category-buttons-container" style="display:flex;flex-wrap:wrap;gap:8px;"></div>
                `;
                
                panel.innerHTML = '';
                panel.appendChild(categorySection);
                
                if (typeof renderCategoryButtons === 'function') {
                  console.log('ðŸ“± EARLY: Calling renderCategoryButtons');
                  renderCategoryButtons();
                } else {
                  console.log('ðŸ“± EARLY: renderCategoryButtons not available yet');
                }
              } else {
                console.log('ðŸ“± EARLY: No data available yet - KEEPING TEST CONTENT (not creating emergency categories)');
                // Skip emergency categories - test content is better
              }
            }, 5000); // Wait longer for data
            
            // Check if data loads later and re-render mobile categories
            const checkDataInterval = setInterval(() => {
              console.log('ðŸ“± RETRY: Checking data...', {
                isMobile: isMobileMode(),
                allDataExists: typeof allData !== 'undefined',
                allDataLength: allData ? allData.length : 0,
                allDataSample: allData ? allData.slice(0, 2) : 'no data'
              });
              
              if (isMobileMode() && typeof allData !== 'undefined' && allData && allData.length > 0) {
                console.log('ðŸ“± RETRY: Data available now, re-rendering mobile categories');
                clearInterval(checkDataInterval);
                
                const mobilePanel = document.getElementById('mobile-right-panel');
                if (mobilePanel && (!mobilePanel.querySelector('.model-thumbnail') || mobilePanel.textContent.includes('Åadowanie modeli'))) {
                  console.log('ðŸ“± RETRY: Attempting to re-render categories with loaded data');
                  try {
                    renderMobileCategoriesOnly(); // Call mobile-only function
                  } catch (e) {
                    console.error('ðŸ“± RETRY: Error re-rendering:', e);
                  }
                }
              }
            }, 1000);
            
            // Stop checking after 30 seconds
            setTimeout(() => clearInterval(checkDataInterval), 30000);
            
            // Also try to call renderMobileCategoriesOnly immediately if data is already available
            setTimeout(() => {
              if (isMobileMode() && typeof allData !== 'undefined' && allData && allData.length > 0) {
                console.log('ðŸ“± IMMEDIATE: Data already available, rendering mobile categories');
                try {
                  renderMobileCategoriesOnly();
                } catch (e) {
                  console.error('ðŸ“± IMMEDIATE: Error rendering:', e);
                }
              } else {
                console.log('ðŸ“± IMMEDIATE: Data not ready yet, allData:', typeof allData, allData ? allData.length : 'undefined');
              }
            }, 2000);
            
            // Hook into data loading completion
            const originalLoadDataFromSheet = window.loadDataFromSheet;
            if (originalLoadDataFromSheet) {
              window.loadDataFromSheet = async function() {
                console.log('ðŸ“± HOOK: loadDataFromSheet called');
                const result = await originalLoadDataFromSheet.apply(this, arguments);
                console.log('ðŸ“± HOOK: loadDataFromSheet completed, allData length:', allData ? allData.length : 'undefined');
                
                // Immediately try to render mobile categories if on mobile
                if (isMobileMode() && allData && allData.length > 0) {
                  console.log('ðŸ“± HOOK: Triggering mobile categories render');
                  setTimeout(() => {
                    try {
                      renderMobileCategoriesOnly();
                    } catch (e) {
                      console.error('ðŸ“± HOOK: Error rendering:', e);
                    }
                  }, 500);
                }
                
                return result;
              };
            }
            
            // Try to load a default model immediately for mobile
            setTimeout(() => {
              if (isMobileMode()) {
                console.log('ðŸ“± QUICK: Attempting immediate mobile model load');
                console.log('ðŸ“± QUICK: loadModel available?', typeof window.loadModel);
                console.log('ðŸ“± QUICK: viewer available?', typeof window.viewer);
                
                try {
                  // Check if viewer is ready
                  if (window.viewer && window.loadModel) {
                    const defaultModels = ['chairs/Tulla.glb', 'chairs/Default.glb', 'chairs/Fargo.glb'];
                    const modelToLoad = defaultModels[0];
                    console.log('ðŸ“± QUICK: Loading model:', modelToLoad);
                    loadModel(modelToLoad);
                    
                    // Also try to set a default env
                    if (window.changeEnvironment) {
                      console.log('ðŸ“± QUICK: Setting default environment');
                      changeEnvironment('hdr/studio_small_09_1k.hdr');
                    }
                  } else {
                    console.log('ðŸ“± QUICK: Viewer not ready yet, will retry...');
                    // Retry when viewer is ready
                    const checkViewer = setInterval(() => {
                      if (window.viewer && window.loadModel) {
                        console.log('ðŸ“± RETRY: Viewer ready, loading model');
                        clearInterval(checkViewer);
                        loadModel('chairs/Tulla.glb');
                        if (window.changeEnvironment) {
                          changeEnvironment('hdr/studio_small_09_1k.hdr');
                        }
                      }
                    }, 500);
                    setTimeout(() => clearInterval(checkViewer), 15000);
                  }
                } catch (e) {
                  console.error('ðŸ“± QUICK: Error loading default model:', e);
                }
              }
            }, 3000);
            
            // Dedykowana funkcja renderowania tylko dla mobile
            window.renderMobileCategoriesOnly = function() {
              const mobilePanel = document.getElementById('mobile-right-panel');
              if (!mobilePanel || !isMobileMode()) return;
              
              console.log('ðŸ“± MOBILE-ONLY: Rendering categories, data available:', !!allData && allData.length > 0);
              
              if (!allData || allData.length === 0) {
                mobilePanel.innerHTML = `
                  <div style="padding:20px;text-align:center;color:#666;">
                    <div style="font-size:18px;margin-bottom:10px;">â³</div>
                    Åadowanie modeli z Google Sheets...
                  </div>
                `;
                return;
              }
              
              // Get all models with categories
              const modelsWithCategories = allData.filter(item => 
                item.Kategoria && 
                item.Kategoria.trim() !== '' && 
                (item.Typ === 'model' || item.Grupa === 'krzesÅ‚o' || item.Grupa === 'kubeÅ‚ek' || item.Model)
              );
              
              console.log('ðŸ“± MOBILE-ONLY: Found models:', modelsWithCategories.length);
              
              if (modelsWithCategories.length === 0) {
                mobilePanel.innerHTML = `
                  <div style="padding:20px;text-align:center;color:#666;">
                    <div style="font-size:18px;margin-bottom:10px;">âŒ</div>
                    Brak modeli w arkuszu Google<br>
                    <small>SprawdÅº strukturÄ™ danych</small>
                  </div>
                `;
                return;
              }
              
              // Get unique categories
              const categories = [...new Set(modelsWithCategories.map(item => item.Kategoria))];
              console.log('ðŸ“± MOBILE-ONLY: Categories:', categories);
              
              // Create category buttons and models grid
              const categoryHTML = `
                <h3 style="margin:0 0 15px 0;font-size:16px;color:#333;">Kategorie:</h3>
                <div style="display:flex;flex-wrap:wrap;gap:8px;margin-bottom:20px;">
                  <button onclick="showMobileCategory('wszystkie')" style="padding:8px 16px;background:#F5C842;border:none;border-radius:20px;font-size:14px;cursor:pointer;">Wszystkie</button>
                  ${categories.map(cat => `
                    <button onclick="showMobileCategory('${cat}')" style="padding:8px 16px;background:white;border:2px solid #ddd;border-radius:20px;font-size:14px;cursor:pointer;">${cat}</button>
                  `).join('')}
                </div>
                <div id="mobile-models-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(120px,1fr));gap:15px;"></div>
              `;
              
              mobilePanel.innerHTML = categoryHTML;
              
              // Add mobile category function to window
              window.showMobileCategory = function(category) {
                console.log('ðŸ“± MOBILE-ONLY: Showing category:', category);
                const modelsGrid = document.getElementById('mobile-models-grid');
                if (!modelsGrid) return;
                
                const modelsToShow = category === 'wszystkie' ? 
                  modelsWithCategories : 
                  modelsWithCategories.filter(item => item.Kategoria === category);
                
                console.log('ðŸ“± MOBILE-ONLY: Models to show:', modelsToShow.length);
                
                const modelsHTML = modelsToShow.map(item => {
                  const modelPath = item.Model || `chairs/${item.Nazwa || 'Default'}.glb`;
                  const iconPath = item.Ikona || `icons/${item.Nazwa || 'chair'}_icon.png`;
                  
                  return `
                    <div onclick="loadMobileModel('${modelPath}')" style="
                      background:white;
                      border-radius:8px;
                      padding:10px;
                      text-align:center;
                      cursor:pointer;
                      box-shadow:0 2px 8px rgba(0,0,0,0.1);
                      transition:transform 0.2s;
                    " onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
                      <img src="${iconPath}" alt="${item.Nazwa}" style="width:60px;height:60px;object-fit:cover;border-radius:4px;" onerror="this.src='icons/chair_icon.png'">
                      <div style="font-size:12px;margin-top:8px;color:#555;">${item.Nazwa || 'Model'}</div>
                    </div>
                  `;
                }).join('');
                
                modelsGrid.innerHTML = modelsHTML;
              };
              
              // Add mobile model loading function
              window.loadMobileModel = function(modelPath) {
                console.log('ðŸ“± MOBILE-ONLY: Loading model:', modelPath);
                if (window.loadModel) {
                  loadModel(modelPath);
                } else {
                  console.error('ðŸ“± MOBILE-ONLY: loadModel function not available');
                }
              };
              
              // Show all models by default
              setTimeout(() => window.showMobileCategory('wszystkie'), 100);
            };

          // Hide welcome overlay immediately if present; if added later, hide via observer
          (function hideWelcomeEarly(){
            const hide = (el) => { try { el.style.display = 'none'; el.style.visibility = 'hidden'; } catch(_) {} };
            const w = document.getElementById('welcome-screen');
            if (w) { hide(w); console.log('ðŸ“± EARLY: Welcome screen hidden'); }
            const mo = new MutationObserver(() => {
              const ws = document.getElementById('welcome-screen');
              if (ws && window.isMobileNow && window.isMobileNow()) { hide(ws); console.log('ðŸ“± EARLY: Welcome re-hidden by observer'); }
            });
            try { mo.observe(document.body, { childList:true, subtree:true }); } catch(_) {}
          })();

          // Override any attempts to show welcome on mobile
          (function() {
          try {
          const originalSetProperty = CSSStyleDeclaration.prototype.setProperty;
          CSSStyleDeclaration.prototype.setProperty = function(property, value) {
            if (property === 'display' && value === 'flex' && this.ownerElement && this.ownerElement.id === 'welcome-screen' && window.isMobileNow && window.isMobileNow()) {
              console.log('ðŸ“± EARLY: Blocked welcome display:flex on mobile');
              return originalSetProperty.call(this, property, 'none');
            }
            return originalSetProperty.call(this, property, value);
          };

          // Override direct style.display assignments
          const originalDisplaySetter = Object.getOwnPropertyDescriptor(CSSStyleDeclaration.prototype, 'display').set;
          Object.defineProperty(CSSStyleDeclaration.prototype, 'display', {
            set: function(value) {
              if (value === 'flex' && this.ownerElement && this.ownerElement.id === 'welcome-screen' && window.isMobileNow && window.isMobileNow()) {
                console.log('ðŸ“± EARLY: Blocked welcome display=flex on mobile');
                return originalDisplaySetter.call(this, 'none');
              }
              return originalDisplaySetter.call(this, value);
            },
            get: Object.getOwnPropertyDescriptor(CSSStyleDeclaration.prototype, 'display').get
          });
        } catch(_) {}
      })();

      // Mobile-only fix: remove stray inline debug text like "// Auto-AR functionality and gesture controls added"
      (function () {
        const isMobile = () => window.innerWidth <= 820 || /Android|iPhone|iPad|iPod|Mobile|Windows Phone/i.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        if (!isMobile()) return;

        function looksLikeDebugComment(text) {
          if (!text) return false;
          const t = text.trim();
          if (!t) return false;
          // Typical JS single-line comment dumped into DOM
          if (t.startsWith('//')) return true;
          // Specific known phrases reported on mobile
          const lower = t.toLowerCase();
          return lower.includes('auto-ar') || lower.includes('gesture controls');
        }

        function cleanNode(node) {
          try {
            if (!node) return;
            // Skip script/style content entirely
            const parent = node.parentNode;
            if (!parent || parent.nodeType !== 1) return;
            const tag = parent.tagName;
            if (tag === 'SCRIPT' || tag === 'STYLE') return;
            if (node.nodeType === Node.TEXT_NODE && looksLikeDebugComment(node.nodeValue)) {
              parent.removeChild(node);
              return;
            }
            if (node.nodeType === Node.ELEMENT_NODE && node.childNodes && node.childNodes.length === 1) {
              const only = node.childNodes[0];
              if (only.nodeType === Node.TEXT_NODE && looksLikeDebugComment(only.nodeValue)) {
                node.remove();
              }
            }
          } catch (_) { /* noop */ }
        }

        function sweep(root) {
          try {
            const walker = document.createTreeWalker(root || document.body, NodeFilter.SHOW_TEXT, null);
            const toRemove = [];
            let n;
            while ((n = walker.nextNode())) {
              const parent = n.parentNode;
              if (!parent) continue;
              const tag = parent.tagName;
              if (tag === 'SCRIPT' || tag === 'STYLE') continue;
              if (looksLikeDebugComment(n.nodeValue)) toRemove.push(n);
            }
            toRemove.forEach((tn) => tn.parentNode && tn.parentNode.removeChild(tn));
          } catch (_) { /* noop */ }
        }

        // Initial sweep and observer for future insertions
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', () => sweep(document.body));
        } else {
          sweep(document.body);
        }
        try {
          const mo = new MutationObserver((mutations) => {
            for (const m of mutations) {
              m.addedNodes && m.addedNodes.forEach((node) => {
                if (node.nodeType === Node.TEXT_NODE) cleanNode(node);
                else if (node.nodeType === Node.ELEMENT_NODE) {
                  // Check element itself, then its text children
                  cleanNode(node);
                  node.childNodes && node.childNodes.forEach((ch) => cleanNode(ch));
                }
              });
            }
          });
          mo.observe(document.body, { childList: true, subtree: true });
        } catch (_) { /* noop */ }
      })();
    </script>
    <!-- ðŸ”„ NOWY KOMUNIKAT OBROTU EKRANU -->
    <div id="rotation-overlay" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100vw;
        height: 100vh;
        background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 99999;
        font-family: 'Poppins', Arial, sans-serif;
        text-align: center;
        padding: 20px;
        box-sizing: border-box;
    ">
        <div style="
            font-size: 80px;
            margin-bottom: 30px;
            animation: phoneRotate 2s ease-in-out infinite;
            filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
        ">ðŸ“±</div>
        
        <h2 style="
            color: #333;
            font-size: 28px;
            font-weight: 700;
            margin: 0 0 15px 0;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        ">ObrÃ³Ä‡ telefon</h2>
        
        <p style="
            color: #555;
            font-size: 18px;
            line-height: 1.4;
            max-width: 350px;
            margin: 0;
            opacity: 0.9;
        ">Dla najlepszego doÅ›wiadczenia uÅ¼yj orientacji poziomej</p>
    </div>

    <!-- CSS dla animacji obrotu telefonu -->
    <style>
    @keyframes phoneRotate {
        0% { transform: rotate(0deg) scale(1); }
        25% { transform: rotate(-10deg) scale(1.1); }
        50% { transform: rotate(0deg) scale(1); }
        75% { transform: rotate(10deg) scale(1.1); }
        100% { transform: rotate(0deg) scale(1); }
    }
    
    /* ðŸ”„ DOMYÅšLNIE ukryj rotation-overlay na desktopie */
    #rotation-overlay {
        display: none !important;
    }
    
    /* ðŸ”„ PokaÅ¼ rotation-overlay tylko na mobile w portrait */
    @media (max-width: 1024px) and (orientation: portrait) {
        #rotation-overlay {
            display: flex !important;
        }
    }
    </style>

    <!-- ðŸ”„ ANIMATED LOADER z Å¼Ã³Å‚tym paskiem -->
    <div id="custom-loader">
        <div class="logo-container" style="
            position: relative;
            margin-bottom: 40px;
            animation: logoPulse 3s ease-in-out infinite;
        ">
            <img src="icons/FK_logo.png" alt="Fajne KrzesÅ‚a" style="
                max-width: 200px; 
                height: auto;
                border-radius: 10px;
                opacity: 0.9;
            " />
        </div>
        
        <div class="spinner" style="
            width: 40px;
            height: 40px;
            border: 3px solid #f0f0f0;
            border-top: 3px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 30px;
        "></div>
        
        <div class="progress-container" style="
            width: 280px;
            height: 3px;
            background: #f0f0f0;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 25px;
        ">
            <div class="progress-bar" style="
                width: 100%;
                height: 100%;
                background: #FFD700;
                animation: progressSlide 2s ease-in-out infinite;
            "></div>
        </div>
        
        <div class="loading-text" style="
            font-size: 16px; 
            color: #333;
            font-weight: 500;
            text-align: center;
            letter-spacing: 0.5px;
        ">Inicjalizacja konfiguratora...</div>
    </div>

    <!-- ðŸ”„ SPINNER podczas zmiany modelu -->
    <div id="model-loader">
        <div class="logo-container" style="
            position: relative;
            margin-bottom: 30px;
            animation: logoPulse 3s ease-in-out infinite;
        ">
            <img src="icons/FK_logo.png" alt="Fajne KrzesÅ‚a" style="
                max-width: 150px; 
                height: auto;
                border-radius: 10px;
                opacity: 0.9;
            " />
        </div>
        
        <div class="spinner" style="
            width: 35px;
            height: 35px;
            border: 3px solid #f0f0f0;
            border-top: 3px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        "></div>
        
        <p>Åadowanie modelu...</p>
        
        <div class="progress-container" style="
            width: 220px;
            height: 3px;
            background: #f0f0f0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 15px;
        ">
            <div class="progress-bar" style="
                width: 100%;
                height: 100%;
                background: #FFD700;
                animation: progressSlide 2s ease-in-out infinite;
            "></div>
        </div>
    </div>

    <!-- Ultra-early loader failsafe: hide loader even if main module fails or errors -->
    <script>
      (function () {
        var already = false;
        function forceHide(reason) {
          if (already) return; already = true;
          try {
            var loader = document.getElementById('custom-loader');
            var modelLoader = document.getElementById('model-loader');
            var app = document.getElementById('app');
            if (loader) {
              try { loader.classList.add('fade-out'); } catch (_) {}
              setTimeout(function(){ try { loader.style.display = 'none'; } catch (_) {} }, 400);
            }
            if (modelLoader) {
              try { modelLoader.style.display = 'none'; } catch (_) {}
            }
            if (app) {
              try { app.style.visibility = 'visible'; app.classList.add('visible'); } catch (_) {}
            }
          } catch (_) { /* noop */ }
        }
        // Kickers: DOM ready, window load, and a hard timeout backstop
        if (document.readyState === 'loading') {
          document.addEventListener('DOMContentLoaded', function(){ setTimeout(forceHide, 600); }, { once: true });
        } else {
          setTimeout(forceHide, 600);
        }
        window.addEventListener('load', function(){ setTimeout(forceHide, 600); }, { once: true });
        setTimeout(forceHide, 7000);
      })();
    </script>

  <div id="app">

    <!-- CANVAS CONTAINER z WELCOME SCREEN -->
    <div id="canvas-container" style="flex: 1 1 0; position: relative; height: 100%; background: #ededed15;">
      <canvas id="canvas"></canvas>
      
      <!-- ðŸŽ¯ WELCOME SCREEN - tylko nad canvas -->
      <div id="welcome-screen">
          <img id="welcome-logo" src="icons/FK_logo.png" alt="Fajne KrzesÅ‚a">
          <div class="title-with-accent">
              <h1 id="welcome-title">Konfigurator KrzeseÅ‚</h1>
              <div class="yellow-accent-line"></div>
          </div>
          <!-- Desktop content -->
          <div id="welcome-desktop-content">
            <p>Wybierz kategoriÄ™ oraz model krzesÅ‚a z bocznego panelu, aby rozpoczÄ…Ä‡ konfiguracjÄ™ w 3D</p>
            <p class="promo-text">MoÅ¼esz rÃ³wnieÅ¼ zapoznaÄ‡ siÄ™ z naszymi promocjami i bestsellerami - najczÄ™Å›ciej wybieranymi modelami krzeseÅ‚</p>
          </div>
          
          <!-- Mobile content -->
          <div id="welcome-mobile-content" style="display: none;">
            <p style="margin: 15px 0; line-height: 1.5;">Wybierz kategoriÄ™ oraz model krzesÅ‚a z bocznego panelu, aby rozpoczÄ…Ä‡ konfiguracjÄ™ w 3D</p>
            <p style="margin: 15px 0; line-height: 1.5; color: #666;">MoÅ¼esz rÃ³wnieÅ¼ zapoznaÄ‡ siÄ™ z naszymi promocjami i bestsellerami - najczÄ™Å›ciej wybieranymi modelami krzeseÅ‚</p>
            
            <button onclick="showInstallInstructions()" style="
              background: linear-gradient(135deg, #F5C842, #E5B432);
              color: #333;
              border: none;
              padding: 12px 24px;
              border-radius: 25px;
              font-size: 14px;
              font-weight: 600;
              cursor: pointer;
              box-shadow: 0 4px 15px rgba(245, 200, 66, 0.4);
              transition: all 0.3s ease;
              margin: 10px;
            " onmouseover="this.style.transform='scale(1.05)'; this.style.background='linear-gradient(135deg, #E5B432, #D1A029)'" onmouseout="this.style.transform='scale(1)'; this.style.background='linear-gradient(135deg, #F5C842, #E5B432)'">
              ðŸ“± Zainstaluj aplikacjÄ™
            </button>
            
            <button id="welcome-continue-btn" style="
              background: #007AFF;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 25px;
              font-size: 14px;
              font-weight: 600;
              cursor: pointer;
              box-shadow: 0 4px 15px rgba(0, 122, 255, 0.4);
              transition: all 0.3s ease;
              margin: 10px;
            " onmouseover="this.style.transform='scale(1.05)'; this.style.background='#0056D6'" onmouseout="this.style.transform='scale(1)'; this.style.background='#007AFF'">
              Kontynuuj do aplikacji
            </button>
          </div>
          
          <!-- PWA Install Button - UKRYTY -->
          <div id="pwa-install-container" style="margin-top: 30px; display: none !important; visibility: hidden;">
            <button id="welcome-install-btn" style="
              background: linear-gradient(135deg, #F5C842, #E5B432);
              color: #333;
              border: none;
              padding: 12px 24px;
              border-radius: 25px;
              font-size: 14px;
              font-weight: 600;
              cursor: pointer;
              box-shadow: 0 4px 15px rgba(245, 200, 66, 0.4);
              transition: all 0.3s ease;
            " onmouseover="this.style.transform='scale(1.05)'; this.style.background='linear-gradient(135deg, #E5B432, #D1A029)'" onmouseout="this.style.transform='scale(1)'; this.style.background='linear-gradient(135deg, #F5C842, #E5B432)'">
              ðŸ“± Zainstaluj jako aplikacjÄ™
            </button>
          </div>
          
          <!-- ðŸ“± MOBILNA SEKCJA KATEGORII I MODELI - widoczna na mobile -->
          <div id="mobile-ui-container" style="margin-top: 30px; padding: 20px; background: rgba(248, 249, 250, 0.9); border-radius: 15px; backdrop-filter: blur(10px);">
            <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #333; text-align: center;">Wybierz krzesÅ‚o:</h3>
            
            <!-- Mobilne kategorie - staÅ‚e przyciski niezaleÅ¼ne od arkusza -->
            <div id="mobile-categories-container" style="margin: 10px 0; text-align: center; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
              <!-- Kategorie bÄ™dÄ… tutaj stworzone przez JavaScript -->
            </div>
            
            <!-- Mobilne modele -->
            <div id="mobile-models-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 20px;">
              <!-- Modele bÄ™dÄ… tutaj renderowane -->
            </div>
            
            <p id="mobile-loading-text" style="text-align: center; color: #666; font-style: italic; margin: 20px 0;">
              Åadowanie kategorii i modeli...
            </p>
          </div>
      </div>
  <!-- ðŸ“± MOBILE RIGHT PANEL (categories + models) -->
  <aside id="mobile-right-panel" style="display:block;visibility:visible;opacity:1;"></aside>
  
  <!-- MOBILE WELCOME POPUP -->
  <div id="mobile-welcome-popup" style="
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: white;
    border-radius: 15px;
    padding: 20px;
    box-shadow: 0 4px 15px rgba(0,0,0,0.3);
    z-index: 2000;
    display: none;
    text-align: center;
    max-width: 280px;
    width: 90%;
  ">
    <img src="icons/FK_logo.png" alt="FK Logo" style="
      width: 80px;
      height: 80px;
      margin-bottom: 15px;
      object-fit: contain;
    ">
    <h3 style="
      margin: 0 0 10px 0;
      font-size: 16px;
      color: #333;
      font-weight: 600;
    ">Konfigurator KrzeseÅ‚</h3>
    <p style="
      margin: 0 0 15px 0;
      font-size: 14px;
      color: #666;
      line-height: 1.4;
    ">Wybierz kategoriÄ™ oraz model krzesÅ‚a z bocznego panelu, aby rozpoczÄ…Ä‡ konfiguracjÄ™ w 3D</p>
    
    <!-- Przycisk instalacji aplikacji (PWA) -->
    <button id="install-app-btn" onclick="installApp()" style="
      background: #4CAF50;
      border: none;
      padding: 8px 16px;
      border-radius: 8px;
      color: white;
      font-weight: 600;
      cursor: pointer;
      font-size: 12px;
      margin-bottom: 10px;
      display: none;
    ">ðŸ“± Zainstaluj aplikacjÄ™</button>
    
    <button onclick="document.getElementById('mobile-welcome-popup').style.display='none'" style="
      background: #F5C842;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      color: #333;
      font-weight: 600;
      cursor: pointer;
      font-size: 14px;
    ">Rozumiem</button>
  </div>
    </div>
    
    <!-- ðŸŽ¯ PWA SUCCESS SCREEN - pokazywany dopiero po instalacji aplikacji -->
    <div id="pwa-success-screen" style="display: none;">
      <img id="success-logo" src="icons/FK_logo.png" alt="Fajne KrzesÅ‚a" style="max-width: 150px; height: auto; margin-bottom: 20px;">
      
      <div style="margin: 20px 0; padding: 20px; background: rgba(40, 167, 69, 0.1); border-radius: 15px; border-left: 4px solid #28a745;">
        <h2 style="color: #28a745; margin: 0 0 10px 0; font-size: 22px;">âœ… Aplikacja zainstalowana pomyÅ›lnie!</h2>
        <p style="margin: 0; color: #333; font-size: 16px;">DziÄ™kujemy za instalacjÄ™ aplikacji Konfigurator KrzeseÅ‚</p>
      </div>
      
      <p style="margin: 20px 0; line-height: 1.6; font-size: 16px; color: #555;">
        Aplikacja zostaÅ‚a dodana do ekranu gÅ‚Ã³wnego. Teraz moÅ¼esz korzystaÄ‡ z peÅ‚nej funkcjonalnoÅ›ci konfiguratora krzeseÅ‚ w trybie offline.
      </p>
      
      <div style="margin: 25px 0; padding: 18px; background: rgba(245, 200, 66, 0.1); border-radius: 12px;">
        <p style="margin: 0; font-weight: 600; color: #333; font-size: 16px;">ðŸš€ Gotowe do rozpoczÄ™cia konfiguracji!</p>
        <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">Skonfiguruj swoje wymarzone krzesÅ‚o w technologii 3D</p>
      </div>
      
      <!-- ðŸŽ¯ KATEGORIE I KRZESÅA W PWA SUCCESS SCREEN - MOBILNA SEKCJA -->
      <div id="pwa-category-section" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 12px;">
        <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #333; text-align: center;">Wybierz krzesÅ‚o:</h3>
        <!-- Uwaga: usuniÄ™to duplikat #mobile-ui-container (istnieje juÅ¼ we welcome-screen) -->
      </div>
      
      <!-- ðŸŽ¯ PRZYCISK KONTYNUUJ -->
      <button id="pwa-success-continue-btn" class="pwa-continue-btn" style="margin-top: 20px;">
        PrzejdÅº do konfiguratora
      </button>
    </div>
    
    <!-- ðŸŽ¯ NOWY CONFIG OVERVIEW BUTTON + POPUP -->
    <div id="config-overview-button" style="
      position: fixed;
      bottom: 20px;
      left: 20px;
      background: linear-gradient(135deg, #F5C842, #E5B432);
      color: #333;
      border: none;
      border-radius: 25px;
      padding: 12px 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(245, 200, 66, 0.4);
      transition: all 0.3s ease;
      z-index: 2000;
      display: none;
      align-items: center;
      gap: 8px;
    " onmouseover="this.style.transform='scale(1.05)'; this.style.background='linear-gradient(135deg, #E5B432, #D1A029)'" onmouseout="this.style.transform='scale(1)'; this.style.background='linear-gradient(135deg, #F5C842, #E5B432)'">
      <span>ðŸ›’</span>
      <span>Twoja konfiguracja</span>
    </div>
    
    <!-- POPUP Z KONFIGURACJÄ„ -->
    <div id="config-overview-popup" style="
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
    ">
      <div style="
        background: #fff;
        border-radius: 16px;
        padding: 24px;
        max-width: 400px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      ">
        <!-- PRZYCISK ZAMKNIJ -->
        <button id="config-popup-close" style="
          position: absolute;
          top: 12px;
          right: 16px;
          background: none;
          border: none;
          font-size: 24px;
          color: #666;
          cursor: pointer;
          width: 30px;
          height: 30px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
          transition: background 0.2s ease;
        " onmouseover="this.style.background='#f0f0f0'" onmouseout="this.style.background='none'">Ã—</button>
        
        <!-- NAGÅÃ“WEK -->
        <h3 style="margin: 0 0 20px 0; font-size: 20px; font-weight: 600; color: #333; text-align: center;">
          Twoja konfiguracja
        </h3>
        
        <!-- IKONKI PRODUKTÃ“W -->
        <div id="popup-overview-icons" style="
          display: flex;
          flex-wrap: wrap;
          gap: 12px;
          margin-bottom: 20px;
          justify-content: center;
        "></div>
        
        <!-- SZCZEGÃ“ÅY I CENY -->
        <div id="popup-overview-details" style="
          border-top: 1px solid #eee;
          padding-top: 16px;
          margin-bottom: 16px;
        "></div>
        
        <!-- SUMA Z PROMOCJÄ„ -->
        <div style="
          background: rgba(245, 200, 66, 0.1);
          border: 1px solid #F5C842;
          border-radius: 12px;
          padding: 16px;
          text-align: center;
          margin-bottom: 20px;
        ">
          <div id="popup-total-original" style="display: none; color: #666; text-decoration: line-through; font-size: 14px; margin-bottom: 4px;"></div>
          <div style="font-size: 18px; font-weight: 700; color: #333;">
            Suma: <span id="popup-overview-total-price">0.00 PLN</span>
          </div>
          <div id="popup-discount-info" style="display: none; color: #FF6B6B; font-size: 12px; font-weight: 600; margin-top: 4px;"></div>
        </div>
        
        <!-- PRZYCISK KUPUJÄ˜ -->
        <button id="popup-buy-button" style="
          width: 100%;
          padding: 14px 0;
          background: white;
          color: #333;
          border: 2px solid #F5C842;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
          cursor: pointer;
          transition: all 0.2s ease;
        " onmouseover="this.style.background='#F5C842'; this.style.color='#333';" onmouseout="this.style.background='white'; this.style.color='#333';">
          <span>ðŸ›’</span>ZamÃ³w
        </button>
      </div>
    </div>

    <div id="sidebar">
      
      <!-- Przyciski kategorii z specjalnymi kategoriami -->
      <div id="category-buttons" style="margin-bottom: 20px;">
        <!-- Specjalne kategorie w jednej linii -->
        <div id="special-categories-container" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;"></div>
        <!-- GÅ‚Ã³wne kategorie -->
        <div id="category-buttons-container" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
      </div>
      
      <div id="model-section">
        <div class="selection-section">
          <h3>Wybierz model:</h3>
          <div id="model-thumbnails" class="options-grid"></div>
        </div>
      </div>
      <div id="config-section" style="display:none;">
        <div id="back-to-models-container" style="margin-bottom: 15px;"></div>
        <div id="legs-section" class="selection-section">
          <h3>Nogi:</h3>
          <div id="legs-thumbnails" class="options-grid"></div>
        </div>
        <div id="parts-section" class="selection-section">
          <div id="part-tabs" class="options-grid"></div>
        </div>
        <div id="materials-section" class="selection-section">
          <h3>Wybierz materiaÅ‚:</h3>
          <div id="material-options" style="display:none;"></div>
          <!-- Panele materiaÅ‚Ã³w sÄ… tworzone dynamicznie przez JavaScript -->
        </div>
      <div id="summary"></div>
      
      <!-- Link do panelu admina (tylko przy kluczu Admin w URL) -->
      <div id="admin-link" style="margin-top: 20px; text-align: center; display: none;">
        <hr style="margin: 16px 0; border: none; border-top: 1px solid #e0e0e0; opacity: 0.3;" />
        <a href="admin.html" style="color: #666; font-size: 12px; text-decoration: none; display: inline-flex; align-items: center; gap: 6px;">
          âš™ï¸ Panel Administracyjny
        </a>
      </div>
    </div>
  </div>
  <!-- FORMULARZ ZAMÃ“WIENIA - POPUP W STYLU PANELU PODSUMOWANIA -->
  <div id="emailModal" class="modal hidden">
    <div style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    ">
      <div style="
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        max-width: 500px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
      ">
        <!-- Przycisk zamknij -->
        <button class="close-button" style="
          position: absolute;
          top: 16px;
          right: 16px;
          background: none;
          border: none;
          font-size: 24px;
          cursor: pointer;
          color: #666;
          z-index: 1;
        ">&times;</button>

        <!-- NagÅ‚Ã³wek -->
        <div style="
          padding: 24px 24px 0 24px;
          text-align: center;
        ">
          <h2 style="
            margin: 0 0 8px 0;
            font-size: 24px;
            font-weight: 700;
            color: #333;
          ">ZÅ‚Ã³Å¼ zamÃ³wienie</h2>
          <p style="
            margin: 0 0 20px 0;
            color: #666;
            font-size: 14px;
          ">WypeÅ‚nij formularz, a skontaktujemy siÄ™ z TobÄ…</p>
        </div>

        <!-- Podsumowanie konfiguracji (ikony) -->
        <div id="order-summary-icons" style="
          padding: 0 24px 16px 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          flex-wrap: wrap;
        "></div>

        <!-- Formularz -->
        <form id="emailForm" style="padding: 0 24px 24px 24px;">
          <div style="margin-bottom: 16px;">
            <label for="name" style="
              display: block;
              margin-bottom: 6px;
              font-weight: 600;
              color: #333;
              font-size: 14px;
            ">ImiÄ™ i nazwisko:</label>
            <input type="text" id="name" name="name" required style="
              width: 100%;
              padding: 12px;
              border: 2px solid #e0e0e0;
              border-radius: 8px;
              font-size: 16px;
              transition: border-color 0.2s;
              box-sizing: border-box;
            ">
          </div>

          <div style="margin-bottom: 16px;">
            <label for="email" style="
              display: block;
              margin-bottom: 6px;
              font-weight: 600;
              color: #333;
              font-size: 14px;
            ">Adres e-mail:</label>
            <input type="email" id="email" name="email" required style="
              width: 100%;
              padding: 12px;
              border: 2px solid #e0e0e0;
              border-radius: 8px;
              font-size: 16px;
              transition: border-color 0.2s;
              box-sizing: border-box;
            ">
            <!-- Ukryte pole to_email dla template klienta -->
            <input type="hidden" id="to_email" name="to_email">
          </div>

          <div style="margin-bottom: 16px;">
            <label for="phone" style="
              display: block;
              margin-bottom: 6px;
              font-weight: 600;
              color: #333;
              font-size: 14px;
            ">Numer telefonu:</label>
            <input type="tel" id="phone" name="phone" style="
              width: 100%;
              padding: 12px;
              border: 2px solid #e0e0e0;
              border-radius: 8px;
              font-size: 16px;
              transition: border-color 0.2s;
              box-sizing: border-box;
            ">
          </div>

          <div style="margin-bottom: 16px;">
            <label for="address" style="
              display: block;
              margin-bottom: 6px;
              font-weight: 600;
              color: #333;
              font-size: 14px;
            ">Adres:</label>
            <input type="text" id="address" name="address" style="
              width: 100%;
              padding: 12px;
              border: 2px solid #e0e0e0;
              border-radius: 8px;
              font-size: 16px;
              transition: border-color 0.2s;
              box-sizing: border-box;
            " placeholder="Ulica, numer domu, kod pocztowy, miasto">
          </div>

          <div style="margin-bottom: 20px;">
            <label for="message" style="
              display: block;
              margin-bottom: 6px;
              font-weight: 600;
              color: #333;
              font-size: 14px;
            ">WiadomoÅ›Ä‡ (opcjonalnie):</label>
            <textarea id="message" name="message" rows="3" style="
              width: 100%;
              padding: 12px;
              border: 2px solid #e0e0e0;
              border-radius: 8px;
              font-size: 16px;
              transition: border-color 0.2s;
              resize: vertical;
              font-family: inherit;
              box-sizing: border-box;
            " placeholder="Dodatkowe uwagi do zamÃ³wienia..."></textarea>
          </div>

          <!-- Ukryte pola na dane konfiguracji -->
          <input type="hidden" id="model" name="model">
          <input type="hidden" id="price" name="price">
          <input type="hidden" id="total" name="total">

          <button type="submit" style="
            width: 100%;
            padding: 16px;
            background: white;
            color: #333;
            border: 2px solid #F5C842;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
          " onmouseover="this.style.background='#F5C842'; this.style.color='#333';" onmouseout="this.style.background='white'; this.style.color='#333';">
            WyÅ›lij zamÃ³wienie
          </button>
        </form>
      </div>
    </div>
  </div>

  



  <!-- KOMUNIKAT SUKCESU -->
  <div id="success-message" class="hidden">ðŸŸ¡ DziÄ™kujemy za zÅ‚oÅ¼enie zamÃ³wienia! Kopia wiadomoÅ›ci zostaÅ‚a wysÅ‚ana na TwÃ³j email.</div>



  <!-- Dolny panel UI -->
  <div id="bottom-toolbar" style="display: none;">

    <!-- Przycisk HDR -->
    <button id="hdr-toggle" title="ZmieÅ„ HDR">
      <img src="icons/bulb_icon.png" alt="HDR" style="width: 20px; height: 20px;">
    </button>

    <div id="hdr-panel" class="hidden">
      <button id="hdr-close" class="hdr-close-btn">Ã—</button>
      <div id="hdr-options" class="options-grid"></div>
    </div>

    <!-- Panel jasnoÅ›ci - obok ikony Å¼arÃ³wki -->
    <div id="brightness-panel" class="hidden">
      <div style="display: flex; flex-direction: column; align-items: center; gap: 8px;">
        <input type="range" id="brightness-slider" min="0.2" max="2.0" step="0.1" value="1.0" orient="vertical">
        <!-- Custom mobile slider (visible only on mobile) -->
        <div id="brightness-slider-mobile" aria-label="Brightness slider mobile" role="slider" aria-valuemin="0.2" aria-valuemax="2.0" aria-valuenow="1.0">
          <div class="track"></div>
          <div class="thumb" style="top: 50%;"></div>
        </div>
        <!-- Ikona sÅ‚oÅ„ca pod sliderem -->
        <div style="width: 20px; height: 20px; display: flex; align-items: center; justify-content: center;">
          <svg width="16" height="16" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="4" stroke="#666" stroke-width="1.5" fill="none"/>
            <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 6.34L4.93 4.93M19.07 19.07l-1.41-1.41" stroke="#666" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </div>
      </div>
    </div>









    <button id="ar-button" title="AR">
      <img src="icons/AR_icon.png" alt="AR" style="width: 30px; height: 30px;">
    </button>

    <button id="dimensions-show" title="Wymiary modelu">
      <img src="icons/dimmension_icon.png" alt="Wymiary" style="width: 20px; height: 20px;">
    </button>


    <button id="export-config" title="Pobierz konfiguracjÄ™">
      <img src="icons/export_icon.png" alt="Eksport" style="width: 20px; height: 20px;">
    </button>

      <div id="export-panel" class="hidden">
      <button class="export-btn" data-format="fbx">FBX</button>
      <button class="export-btn" data-format="dae">DAE</button>
      <button class="export-btn" data-format="obj">OBJ</button>
    </div>

  <button id="qr-button" title="Zobacz na telefonie" style="display:none;">
      <img src="icons/qr_icon.png" alt="QR" style="width: 20px; height: 20px;">
    </button>
  </div>


  <div id="dimension-overlay" style="display: none;">
    <div class="dimension-panel-header">
      <div class="dimension-panel-title">Wymiary modelu</div>
      <button class="dimension-close-btn" onclick="document.getElementById('dimension-overlay').style.display='none'">Ã—</button>
    </div>
    <div class="dimensions-container">
      <!-- Wymiary bÄ™dÄ… dodawane dynamicznie przez JavaScript -->
    </div>
  </div>

  <link rel="manifest" href="manifest.json?v=2025080418&fix=welcome" />
  <link rel="apple-touch-icon" href="icons/favicon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"">
  
  <!-- In-page WebXR AR controls -->
  <div id="xr-reticle"></div>
  <button id="xr-exit-btn">ZakoÅ„cz AR</button>


  <div id="ar-popup" style="
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-108%, -50%);
  background: white;
  padding: 20px 30px;
  border-radius: 12px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.2);
  display: none;
  z-index: 9999;
  text-align: center;
  max-width: 300px;
">
    <img src="icons/AR_icon.png" alt="AR Ikona" style="width: 60px; margin-bottom: 10px;" />
  <div style="font-size: 18px; font-weight: bold;">Tryb AR dostÄ™pny wkrÃ³tce</div>
  <div style="margin-top: 6px; font-size: 14px;">Funkcja zostanie uruchomiona niebawem.</div>
  <button onclick="closeArPopup()" style="
    margin-top: 12px;
    background: #141414;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
  ">Zamknij</button>
  </div>






  <div id="qr-popup" style="
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-108%, -50%);
  background: white;
  padding: 20px 30px;
  border-radius: 12px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.2);
  display: none;
  z-index: 9999;
  text-align: center;
  max-width: 300px;
">
    <p style="margin-bottom:10px;">Zeskanuj kod QR telefonem:</p>
    <div id="qrcode" style="width: 120px; height: 120px; margin: 0 auto 10px auto;"></div>
    <button id="qr-close-btn" style="
      margin-top: 12px;
      background: #141414;
      color: white;
      border: none;
      padding: 6px 12px;
      border-radius: 6px;
      cursor: pointer;
    ">Zamknij</button>

  </div>


  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>


  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <script>
    emailjs.init('y6_uovUeRS8M7gZ1H');

    function generateSummaryText() {
      let text = "";
      let totalPrice = 0;
      let originalTotalPrice = 0;

      if (window.selectedChair) {
        const price = parseFloat(window.selectedChair.Cena) || 0;
        const chairId = window.selectedChair.ID || 'Brak ID';
        const hasPromotion = window.selectedChair.Promocja === 'TRUE' || window.selectedChair.Promocja === 'true' || 
                             window.selectedChair.Promocja === 'tak' || window.selectedChair.Promocja === 'âœ”';
        const procent = hasPromotion ? parseFloat(window.selectedChair.Procent) || 0 : 0;
        
        originalTotalPrice += price;
        
        if (hasPromotion && procent > 0) {
          const discountedPrice = price * (1 - procent / 100);
          totalPrice += discountedPrice;
          text += `Model: ${window.selectedChair.Nazwa} (ID: ${chairId})\n`;
          text += `  Cena regularna: ${price.toFixed(2)} PLN\n`;
          text += `  Promocja -${procent}%: ${discountedPrice.toFixed(2)} PLN\n`;
        } else {
          totalPrice += price;
          text += `Model: ${window.selectedChair.Nazwa} (ID: ${chairId}) (${price.toFixed(2)} PLN)\n`;
        }
      }

      if (window.selectedLeg) {
        const price = parseFloat(window.selectedLeg.Cena) || 0;
        const legId = window.selectedLeg.ID || 'Brak ID';
        totalPrice += price;
        originalTotalPrice += price;
        text += `Wariant stelaÅ¼a: ${window.selectedLeg.Nazwa} (ID: ${legId}) (${price.toFixed(2)} PLN)\n`;
      }

      const partOrder = ['seat', 'backseat_inside', 'backseat_outside', 'legs_material', 'backseat'];
      const partLabels = ['Obicie', 'Oparcie wew.', 'Oparcie zew.', 'StelaÅ¼', 'Siedzisko/Oparcie'];
      partOrder.forEach((part, idx) => {
        var mats = window.selectedMaterials || null;
        var mat = mats ? mats[part] : null;
        if (mat) {
          var price = parseFloat(mat.Cena) || 0;
          var matId = mat.ID || 'Brak ID';
          totalPrice += price;
          originalTotalPrice += price;
          text += `${partLabels[idx]}: ${mat.Nazwa} (ID: ${matId}) (${price.toFixed(2)} PLN)\n`;
        }
      });

      // Dodaj informacjÄ™ o oszczÄ™dnoÅ›ciach
      if (originalTotalPrice > totalPrice) {
        const savings = originalTotalPrice - totalPrice;
        text += `\nOszczÄ™dnoÅ›ci: ${savings.toFixed(2)} PLN`;
        text += `\nCena przed promocjÄ…: ${originalTotalPrice.toFixed(2)} PLN`;
      }

      text += `\nSuma konfiguracji: ${totalPrice.toFixed(2)} PLN`;
      return { text, totalPrice, originalTotalPrice };
    }



    emailForm.addEventListener('submit', (e) => {
      e.preventDefault();

      const summary = generateSummaryText();

  document.getElementById('model').value = (window.selectedChair && window.selectedChair.Nazwa) || 'Brak modelu';
  document.getElementById('price').value = parseFloat((window.selectedChair && window.selectedChair.Cena) || 0).toFixed(2);
      document.getElementById('total').value = summary.totalPrice.toFixed(2);

      let configTextInput = document.getElementById('configText');
      if (!configTextInput) {
        configTextInput = document.createElement('textarea');
        configTextInput.name = 'configText';
        configTextInput.id = 'configText';
        configTextInput.hidden = true;
        emailForm.appendChild(configTextInput);
      }
      configTextInput.value = summary.text;

      // Skopiuj email do ukrytego pola to_email
      const emailInput = document.getElementById('email');
      const toEmailInput = document.getElementById('to_email');
      if (emailInput && toEmailInput) {
        toEmailInput.value = emailInput.value;
      }

      // WyÅ›lij pierwsze zamÃ³wienie do sklepu
      emailjs.sendForm('service_h3otax9', 'template_aykvcls', emailForm)
        .then(() => {
          console.log('âœ… Email do sklepu wysÅ‚any pomyÅ›lnie');
          
          // Teraz wyÅ›lij kopiÄ™ do klienta
          return emailjs.sendForm('service_h3otax9', 'template_vfeld4k', emailForm);
        })
        .then(() => {
          console.log('âœ… Kopia do klienta wysÅ‚ana pomyÅ›lnie');
          
          var emailModalEl = document.getElementById('emailModal');
          if (emailModalEl) emailModalEl.classList.add('hidden');

          const successMessage = document.getElementById('success-message');
          successMessage.classList.remove('hidden');
          successMessage.classList.add('visible');

          setTimeout(() => {
            successMessage.classList.remove('visible');
            successMessage.classList.add('hidden');
          }, 3500);

          emailForm.reset();
        })
        .catch((error) => {
          alert('âŒ CoÅ› poszÅ‚o nie tak podczas wysyÅ‚ania emaila. SprÃ³buj ponownie.');
          console.error('EmailJS error:', error);
        });
    });
  </script>

  <!-- Mobile-only: hide AR button and style/position config + view-in-room buttons -->
  <style>
    /* ðŸ“± Hide AR button on mobile */
    body.mobile-mode #bottom-toolbar #ar-button { display: none !important; }
    @media (max-width: 820px) {
      #bottom-toolbar #ar-button { display: none !important; }
    }
    
    /* ðŸ“± Hide QR button on mobile */
    body.mobile-mode #qr-button { display: none !important; }
    @media (max-width: 820px) {
      #qr-button { display: none !important; }
    }
    
    /* ðŸ“± Hide "Zobacz w pomieszczeniu" button on mobile */
    body.mobile-mode #view-in-room-button { display: none !important; }
    @media (max-width: 820px) {
      #view-in-room-button { display: none !important; }
    }
    
    /* ðŸ“± Hide config overview button (golden "Twoja konfiguracja") on mobile */
    body.mobile-mode #config-overview-button { display: none !important; }
    @media (max-width: 820px) {
      #config-overview-button { display: none !important; }
    }
    
    /* ðŸ“± Smaller HDR/brightness controls on mobile */
    body.mobile-mode #hdr-toggle {
      width: 30px !important;
      height: 30px !important;
      padding: 4px !important;
    }
    body.mobile-mode #hdr-toggle img {
      width: 14px !important;
      height: 14px !important;
    }
    body.mobile-mode #brightness-panel {
      transform: scale(0.7) !important;
    }
    /* ðŸ“± Smaller dimension/config UI elements */
    body.mobile-mode #config-overview-button {
      font-size: 12px !important;
      padding: 6px 10px !important;
    }
    body.mobile-mode #dimensions-show {
      width: 30px !important;
      height: 30px !important;
      padding: 4px !important;
    }
    body.mobile-mode #dimensions-show img {
      width: 14px !important;
      height: 14px !important;
    }
    body.mobile-mode #dimensions-panel {
      transform: scale(0.85) !important;
      transform-origin: top right !important;
    }
    /* ðŸ“± General smaller bottom toolbar buttons */
    body.mobile-mode #bottom-toolbar button {
      width: 30px !important;
      height: 30px !important;
      padding: 4px !important;
    }
    body.mobile-mode #bottom-toolbar button img {
      width: 14px !important;
      height: 14px !important;
    }
    @media (max-width: 820px) {
      #hdr-toggle {
        width: 30px !important;
        height: 30px !important;
        padding: 4px !important;
      }
      #hdr-toggle img {
        width: 14px !important;
        height: 14px !important;
      }
      #brightness-panel {
        transform: scale(0.7) !important;
      }
      #config-overview-button {
        font-size: 12px !important;
        padding: 6px 10px !important;
      }
      #dimensions-show {
        width: 30px !important;
        height: 30px !important;
        padding: 4px !important;
      }
      #dimensions-show img {
        width: 14px !important;
        height: 14px !important;
      }
      #dimensions-panel {
        transform: scale(0.85) !important;
        transform-origin: top right !important;
      }
      /* General smaller bottom toolbar buttons */
      #bottom-toolbar button {
        width: 30px !important;
        height: 30px !important;
        padding: 4px !important;
      }
      #bottom-toolbar button img {
        width: 14px !important;
        height: 14px !important;
      }
    }

    /* On mobile, hide both buttons until a chair is selected */
    body.mobile-mode:not(.has-chair) #config-overview-button,
    body.mobile-mode:not(.has-chair) #view-in-room-button { display: none !important; }
    @media (max-width: 820px) {
      body:not(.has-chair) #config-overview-button,
      body:not(.has-chair) #view-in-room-button { display: none !important; }
    }

    /* Make both buttons smaller and consistent on mobile */
    body.mobile-mode #config-overview-button,
    body.mobile-mode #view-in-room-button {
      padding: 4px 8px !important;
      font-size: 10px !important;
      border-radius: 14px !important;
      box-shadow: 0 2px 8px rgba(245, 200, 66, 0.3) !important;
      display: inline-flex !important;
      align-items: center !important;
      gap: 4px !important;
      line-height: 1 !important;
      height: 26px !important;
    }
    @media (max-width: 820px) {
      #config-overview-button,
      #view-in-room-button {
        padding: 4px 8px !important;
        font-size: 10px !important;
        border-radius: 14px !important;
        box-shadow: 0 2px 8px rgba(245, 200, 66, 0.3) !important;
        display: inline-flex !important;
        align-items: center !important;
        gap: 4px !important;
        line-height: 1 !important;
        height: 26px !important;
      }
    }
  </style>

  <script>
    (function(){
  function isMobileMode(){
        return document.body.classList.contains('mobile-mode') || window.innerWidth <= 820;
      }

      function ensureViewInRoomButton(){
        console.log('ðŸ”§ ensureViewInRoomButton called');
        const configBtn = document.getElementById('config-overview-button');
        if (!configBtn) {
          console.log('âŒ No config button found');
          return null;
        }

        let viewBtn = document.getElementById('view-in-room-button');
        if (!viewBtn) {
          console.log('âœ¨ Creating new view button');
          viewBtn = document.createElement('div');
          viewBtn.id = 'view-in-room-button';
          // Prefer SVG, fallback to PNG to keep transparency
          viewBtn.innerHTML = '<img alt="AR" style="width:14px;height:14px;object-fit:contain;filter:none;" src="icons/AR_icon.svg" onerror="this.onerror=null;this.src=\'icons/AR_icon.png\';" /> <span>Zobacz w pomieszczeniu</span>';
          // Copy base style from config button (looks identical)
          try { viewBtn.style.cssText = configBtn.getAttribute('style') || ''; } catch(_) {}
          // Keep same z-index, padding, colors; position will be computed
          viewBtn.style.position = 'fixed';
          viewBtn.style.bottom = (configBtn.style.bottom || '20px');
          viewBtn.style.display = 'none'; // will be toggled dynamically
          viewBtn.style.whiteSpace = 'nowrap';
          viewBtn.style.userSelect = 'none';

          // Hover effects similar to config button
          viewBtn.addEventListener('mouseover', () => {
            viewBtn.style.transform = 'scale(1.05)';
            viewBtn.style.background = 'linear-gradient(135deg, #E5B432, #D1A029)';
          });
          viewBtn.addEventListener('mouseout', () => {
            viewBtn.style.transform = 'scale(1)';
            viewBtn.style.background = 'linear-gradient(135deg, #F5C842, #E5B432)';
          });

  // Click -> Mobile: open ar.html with current GLB; Desktop: show QR to AR landing
          viewBtn.addEventListener('click', (e) => {
            console.log('ðŸ”¥ AR button clicked! (disabled, showing popup)');
            e.stopPropagation();
            if (typeof openArPopup === 'function') openArPopup();
          });

          document.body.appendChild(viewBtn);
          console.log('âœ… View button created and added to DOM');
        }
        console.log('ðŸ” View button exists:', !!viewBtn);
        return viewBtn;
      }

      function updateViewButtonLayout(){
        const configBtn = document.getElementById('config-overview-button');
        const viewBtn = document.getElementById('view-in-room-button');
        if (!configBtn || !viewBtn) return;

  const isMobile = isMobileMode();
  // Prefer live variable selectedChair; fallback to window.selectedChair
  const curChair = (typeof selectedChair !== 'undefined' && selectedChair && selectedChair.Nazwa) ? selectedChair : window.selectedChair;
  const hasChair = !!(curChair && curChair.Nazwa);
  // Toggle a body flag so CSS can instantly hide/show on mobile
  if (hasChair) document.body.classList.add('has-chair');
  else document.body.classList.remove('has-chair');
        const configVisible = window.getComputedStyle(configBtn).display !== 'none';
        // On mobile: show both only after a chair is selected
        if (isMobile) {
          configBtn.style.display = hasChair ? (configVisible ? window.getComputedStyle(configBtn).display : 'inline-flex') : 'none';
          viewBtn.style.display = hasChair && (window.getComputedStyle(configBtn).display !== 'none') ? 'inline-flex' : 'none';
        } else {
          // On desktop donâ€™t interfere with config button visibility; hide our mobile-only view button
          viewBtn.style.display = 'none';
        }

        // Position to the right side of the config button with 8px gap
        const rect = configBtn.getBoundingClientRect();
        // If config button is positioned fixed at bottom/left, compute left in px
        const leftPx = Math.max(0, rect.left + rect.width + 8);
        viewBtn.style.left = leftPx + 'px';
        // Keep perfect vertical alignment by matching computed bottom in pixels
        const bottomPx = Math.max(0, Math.round(window.innerHeight - rect.bottom));
        viewBtn.style.top = 'auto';
        viewBtn.style.bottom = bottomPx + 'px';
      }

      function initViewButtonEnhancement(){
        const btn = ensureViewInRoomButton();
        if (!btn) return;
        updateViewButtonLayout();

            // Extra safety: intercept clicks early (capture) to always route to AR on mobile
            // This prevents any later-bound handlers from overriding our behavior.
            try {
              const captureHandler = async (e) => {
                // Normalize to an Element (Text nodes don't have closest)
                const baseEl = (e.target && e.target.nodeType === 1) ? e.target : (e.target && e.target.parentElement);
                const target = baseEl && baseEl.closest ? baseEl.closest('#view-in-room-button') : null;
                if (!target) return;
                // Donâ€™t interfere on desktop
                const ua = navigator.userAgent || '';
                const isTouchMac = navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1;
                const isUADevice = /Android|iPhone|iPad|iPod|Mobile|Windows Phone/i.test(ua);
                const isMobileWidth = window.innerWidth <= 1024;
                const isMobileMode = document.body.classList.contains('mobile-mode');
                const isMobileDevice = isUADevice || isTouchMac || isMobileWidth || isMobileMode;
                if (!isMobileDevice) return;
                // Stop other listeners and show AR-coming-soon popup instead of navigating
                e.preventDefault();
                e.stopPropagation();
                e.stopImmediatePropagation?.();
                try { if (typeof openArPopup === 'function') openArPopup(); } catch(_) {}
              };
              // Attach once; capture phase to run before bubbling listeners
              if (!window.__viewInRoomCaptureBound) {
                document.addEventListener('click', captureHandler, true);
                window.__viewInRoomCaptureBound = true;
              }
            } catch(_) {}
      }

      // Initialize after load to ensure base scripts/styles ran
  window.addEventListener('load', () => {
        initViewButtonEnhancement();
        // Recompute on resize/orientation
        window.addEventListener('resize', updateViewButtonLayout);
        window.addEventListener('orientationchange', updateViewButtonLayout);

        // Observe visibility/style changes on the config button
        const cfg = document.getElementById('config-overview-button');
        if (cfg && window.MutationObserver) {
          const mo = new MutationObserver(() => updateViewButtonLayout());
          mo.observe(cfg, { attributes: true, attributeFilter: ['style', 'class'] });
        }

        // Periodic safety check (DOM manipulations elsewhere)
  setInterval(updateViewButtonLayout, 800);
      });
    })();
  </script>
  
  <!-- ðŸš€ OSOBNY MOBILNY KONTENER - globalny, niezaleÅ¼ny od welcome-screen -->
  <div id="standalone-mobile-ui" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%);
    z-index: 10000;
    display: none;
    overflow-y: auto;
    padding: 20px;
    box-sizing: border-box;
  ">
    <div style="max-width: 500px; margin: 0 auto; padding-top: 60px;">
      <div style="text-align: center; margin-bottom: 30px;">
        <img src="icons/FK_logo.png" alt="Fajne KrzesÅ‚a" style="max-width: 120px; height: auto; border-radius: 10px;">
        <h1 style="margin: 15px 0 5px 0; color: #333; font-size: 24px;">Konfigurator krzeseÅ‚</h1>
        <p style="color: #666; margin: 0; font-size: 14px;">Wybierz swoje idealne krzesÅ‚o</p>
      </div>
      
      <!-- Mobilne kategorie -->
      <div style="margin-bottom: 20px;">
        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333; text-align: center;">Kategorie:</h3>
        <div id="standalone-mobile-categories" style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
          <!-- Kategorie tutaj -->
        </div>
      </div>
      
      <!-- Mobilne modele -->
      <div style="margin-bottom: 20px;">
        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333; text-align: center;">KrzesÅ‚a:</h3>
        <div id="standalone-mobile-models" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px;">
          <!-- Modele tutaj -->
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 30px;">
        <button id="close-mobile-ui" style="
          background: #dc3545;
          color: white;
          border: none;
          border-radius: 8px;
          padding: 12px 24px;
          font-size: 14px;
          cursor: pointer;
          transition: all 0.3s ease;
        ">Zamknij mobilny widok</button>
      </div>
    </div>
  </div>

  <script type="module">
    // GÅ‚Ã³wna biblioteka Three.js (z importmap) - jak w poprzedniej wersji
    import * as THREE from 'three';

    // Konkretnie z Three.js (potrzebne do wymiarÃ³w i geometrii)
    import {
      Group,
      Box3,
      Vector3,
      ArrowHelper,
      Sprite,
      SpriteMaterial,
      CanvasTexture,
      Color,
      TextureLoader,
      MeshStandardMaterial,
      LinearFilter,
      LinearMipMapLinearFilter,
      RepeatWrapping,
      sRGBEncoding,
      LinearEncoding
    } from 'three';

    // ThreePipe core â€“ viewer i pluginy
    import {
      ThreeViewer,
      LoadingScreenPlugin,
      GBufferPlugin,
      SSAAPlugin,
    } from 'threepipe';

    // Pluginy z WebGI (ThreePipe)
    import {
      SSReflectionPlugin,
      BloomPlugin
    } from '@threepipe/webgi-plugins';








    const CAMERA_FOV = 12;
    const CAMERA_NEAR = 0.1;
    const CAMERA_FAR = 100;
    const CAMERA_POSITION = { x: -4.5, y: 0.76, z: 3.9 };
    const CAMERA_TARGET = { x: 0.79, y: -1.09, z: -0.22 };

    // Specjalne pozycje kamery dla hookerÃ³w (bardziej oddalone)
    const CAMERA_POSITION_HOOKER = { x: -6.5, y: 1.2, z: 5.5 };
    const CAMERA_TARGET_HOOKER = { x: 0.79, y: -1.09, z: -0.22 };

    const MIN_ZOOM_DISTANCE = 1; // minimalna odlegÅ‚oÅ›Ä‡ kamery od modelu (przybliÅ¼enie)
    const MAX_ZOOM_DISTANCE = 8; // maksymalna odlegÅ‚oÅ›Ä‡ kamery od modelu (oddalenie)

    // Specjalne limity zoomu dla hookerÃ³w (pozwalajÄ… bardziej siÄ™ oddaliÄ‡)
    const MIN_ZOOM_DISTANCE_HOOKER = 2; 
    const MAX_ZOOM_DISTANCE_HOOKER = 12;
  const VERTICAL_OFFSET = 0;
  // Minimal positive correction to ensure legs visually touch the bucket seat across models
  const SEAT_CONTACT_CORRECTION = 0.005;

    let viewer, currentModelContainer, currentLegModel;
    let allData = [];
    let selectedChair, selectedLeg, selectedMaterials = {};
    let globalCameraTargetPosition;
    let userInteracted = false;
    let dimensionHelpers = [];
    let currentModel = null;
    let selectedLegVariant = null;
    let lastOpenedCollection = null;
    let currentSearchFilter = '';
    let activeCollectionsByMesh = {};
    let materialsByMeshAndCollection = {};
    let previousCategory = 'Wszystkie'; // ZapamiÄ™taj poprzedniÄ… kategoriÄ™ przed wyszukiwaniem

    // Funkcja do zapamiÄ™tania aktualnie wybranej kategorii
    function saveCurrentCategory() {
      const activeButton = document.querySelector('.category-button.active');
      if (activeButton) {
        previousCategory = activeButton.textContent.trim();
        console.log('ðŸ’¾ Zapisano aktualnÄ… kategoriÄ™:', previousCategory);
      }
    }

    // Funkcja do przywrÃ³cenia poprzedniej kategorii
    function restorePreviousCategory() {
      console.log('â†©ï¸ Przywracam poprzedniÄ… kategoriÄ™:', previousCategory);
      
      // ZnajdÅº przycisk z poprzedniÄ… kategoriÄ…
      const allButtons = document.querySelectorAll('.category-button');
      const targetButton = Array.from(allButtons).find(btn => 
        btn.textContent.trim() === previousCategory
      );
      
      if (targetButton && targetButton.onclick) {
        // Kliknij przycisk Å¼eby przywrÃ³ciÄ‡ kategoriÄ™
        targetButton.click();
        console.log('âœ… PrzywrÃ³cono kategoriÄ™:', previousCategory);
      } else {
        // JeÅ›li nie znaleziono, wrÃ³Ä‡ do "Wszystkie"
        const allButton = Array.from(allButtons).find(btn => 
          btn.textContent.trim() === 'Wszystkie'
        );
        if (allButton && allButton.onclick) {
          allButton.click();
          console.log('âœ… PrzywrÃ³cono domyÅ›lnÄ… kategoriÄ™: Wszystkie');
        }
      }
    }

    // Helper function to remove text in parentheses (like "(hooker)") from names
    function stripBrackets(name) {
      if (!name) return name;
      return name.replace(/\s*\([^)]*\)\s*/g, '').trim();
    }

    // Helper function to select appropriate default leg for chair category
    function selectDefaultLeg(availableLegs, chairKategoria) {
      if (!availableLegs || availableLegs.length === 0) return null;
      
      console.log('ðŸ¦µ selectDefaultLeg called with:', { 
        chairKategoria, 
        availableLegsCount: availableLegs.length,
        legNames: availableLegs.map(l => l.Nazwa),
        legCategories: availableLegs.map(l => ({ name: l.Nazwa, kategoria: l.Kategoria, typ: l.Typ, grupa: l.Grupa }))
      });
      
      let defaultLeg = null;
      const kategoria = (chairKategoria || '').toLowerCase();
      
      if (kategoria.includes('hooker')) {
        // Dla hookerÃ³w: szukaj nogi z kategorii hooker
        defaultLeg = availableLegs.find(l => {
          const nogaKategoria = (l.Kategoria || l.Typ || l.Grupa || '').toLowerCase();
          return nogaKategoria.includes('hooker');
        });
  console.log('ðŸ¦µ For hooker chair, found leg:', (defaultLeg && defaultLeg.Nazwa));
      } else if (kategoria.includes('krzes')) {
        // Dla krzeseÅ‚: najpierw szukaj "regularne", potem inne krzesÅ‚a
        defaultLeg = availableLegs.find(l => l.Nazwa && l.Nazwa.toLowerCase().includes('regularne'));
        if (!defaultLeg) {
          defaultLeg = availableLegs.find(l => {
            const nogaKategoria = (l.Kategoria || l.Typ || l.Grupa || '').toLowerCase();
            return nogaKategoria.includes('krzes') || nogaKategoria === '' || nogaKategoria === 'nogi';
          });
        }
  console.log('ðŸ¦µ For krzesÅ‚a chair, found leg:', (defaultLeg && defaultLeg.Nazwa));
      }
      
      // JeÅ›li nie znaleziono odpowiedniej nogi, weÅº pierwszÄ… dostÄ™pnÄ…
      const result = defaultLeg || availableLegs[0];
  console.log('ðŸ¦µ Final selected leg:', (result && result.Nazwa));
      return result;
    }

    const ELEMENT_ICONS = {
      seat: 'icons/m_seat_icon.png',
      backseat_inside: 'icons/m_backseat_in_icon.png',
      backseat_outside: 'icons/m_backseat_out_icon.png',
      backseat: 'icons/m_backseat_icon.png',
      legs: 'icons/m_legs_icon.png'
    };

    function showScreen(screenName) {
      console.log("Showing screen:", screenName);
      
      const welcomeScreen = document.getElementById('welcome-screen');
      
      // Ukryj welcome screen przy przejÅ›ciu do ekranÃ³w innych niÅ¼ wyszukiwarka.
      // Na mobile pokaÅ¼ tylko jeÅ›li nie zostaÅ‚ Å›wiadomie zamkniÄ™ty (welcomeDismissed).
      if (welcomeScreen && screenName !== 'search-results') {
        const uaMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        const pointerCoarse = (window.matchMedia && matchMedia('(pointer: coarse)').matches) || navigator.maxTouchPoints > 0;
        const forceMobileFlag = /[?#&]mobile=1\b/.test(location.search + location.hash);
        const isMobile = document.body.classList.contains('mobile-mode') || uaMobile || pointerCoarse || forceMobileFlag || (window.innerWidth <= 820);
        
        // Na mobile NIGDY nie pokazuj welcome; na desktop ZAWSZE ukryj po przejÅ›ciu do innych ekranÃ³w.
        if (isMobile) {
          welcomeScreen.style.display = 'none';
        } else {
          // Na desktop - ukryj welcome screen gdy przechodzimy do modeli lub konfiguracji
          welcomeScreen.style.display = 'none';
        }
      }
      
      // Bezpieczne sprawdzenie elementÃ³w przed manipulacjÄ…
      const modelSection = document.getElementById('model-section');
      const configSection = document.getElementById('config-section');
      
      if (modelSection) {
        modelSection.style.display = (screenName === 'models' || screenName === 'search-results') ? 'block' : 'none';
      } else {
        console.warn('âš ï¸ model-section element not found - trying to create it');
        // SprÃ³buj stworzyÄ‡ brakujÄ…cy element
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
          const newModelSection = document.createElement('div');
          newModelSection.id = 'model-section';
          newModelSection.innerHTML = `
            <div class="selection-section">
              <h3>Wybierz model:</h3>
              <div id="model-thumbnails" class="options-grid"></div>
            </div>
          `;
          
          // Dodaj po sekcji kategorii
          const categorySection = sidebar.querySelector('#category-buttons');
          if (categorySection) {
            categorySection.after(newModelSection);
          } else {
            sidebar.appendChild(newModelSection);
          }
          
          console.log('âœ… Created missing model-section');
          newModelSection.style.display = (screenName === 'models' || screenName === 'search-results') ? 'block' : 'none';
        }
      }
      
      if (configSection) {
        configSection.style.display = screenName === 'config' ? 'block' : 'none';
      } else {
        console.warn('âš ï¸ config-section element not found - trying to create it');
        // SprÃ³buj stworzyÄ‡ brakujÄ…cy element
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
          const newConfigSection = document.createElement('div');
          newConfigSection.id = 'config-section';
          newConfigSection.style.display = 'none';
          newConfigSection.innerHTML = `
            <div id="back-to-models-container" style="margin-bottom: 15px;"></div>
            <div id="legs-section" class="selection-section">
              <h3>Nogi:</h3>
              <div id="legs-thumbnails" class="options-grid"></div>
            </div>
            <div id="parts-section" class="selection-section">
              <div id="part-tabs" class="options-grid"></div>
            </div>
            <div id="materials-section" class="selection-section">
              <h3>Wybierz materiaÅ‚:</h3>
              <div id="material-options" style="display: none;"></div>
              <div id="collection-container" style="display: flex; gap: 24px; margin-top: 20px;">
                <div id="collection-icons" style="display: flex; flex-direction: column; gap: 14px; width: 88px;"></div>
                <div id="material-panel-viewer" class="options-grid" style="flex-grow: 1;"></div>
              </div>
            </div>
            <div id="summary"></div>
          `;
          
          sidebar.appendChild(newConfigSection);
          console.log('âœ… Created missing config-section');
          newConfigSection.style.display = screenName === 'config' ? 'block' : 'none';
        }
      }
      
      // Upewnij siÄ™ Å¼e loader jest ukryty gdy pokazujemy gÅ‚Ã³wny ekran
      if (screenName === 'models') {
        const loader = document.getElementById('custom-loader');
        if (loader && loader.style.display !== 'none') {
          console.log("Ukrywam loader po przejÅ›ciu na ekran models");
          loader.classList.add('fade-out');
          setTimeout(() => {
            loader.style.display = 'none';
            const appElement = document.getElementById('app');
            if (appElement) {
              appElement.style.visibility = 'visible';
            }
          }, 500);
        }
      }
    }

    // USUNIÄ˜TO loadCameraTarget - niepotrzebny plik camera_target.glb

    // ðŸ§° Lekki baner debug â€” pokazuje m.in. ktÃ³ry plik nÃ³g zostaÅ‚ wybrany
    function installDebugBanner() {
      if (window.__showDebugBanner) return;
      const persistent = new URL(window.location.href).searchParams.get('debug') === '1';
      window.__showDebugBanner = (text) => {
        let el = document.getElementById('debug-banner');
        if (!el) {
          el = document.createElement('div');
          el.id = 'debug-banner';
          el.style.cssText = 'position:fixed;bottom:8px;left:8px;z-index:99999;background:rgba(0,0,0,0.76);color:#fff;padding:6px 10px;border-radius:6px;font:12px/1.25 monospace;pointer-events:none;box-shadow:0 2px 8px rgba(0,0,0,0.3)';
          document.body.appendChild(el);
        }
        el.textContent = String(text || '');
        if (!persistent) {
          try { clearTimeout(el.__hideTimer); } catch(_) {}
          el.__hideTimer = setTimeout(() => {
            if (el && el.parentNode) el.parentNode.removeChild(el);
          }, 4000);
        }
      };
    }
    document.addEventListener('DOMContentLoaded', installDebugBanner);

    // ðŸ”„ SYSTEM WERSJONOWANIA â€” dziaÅ‚a takÅ¼e na Live Server (ograniczony do folderu legs/)
    // Bezpieczne kodowanie Å›cieÅ¼ki: koduje kaÅ¼dy segment osobno (spacja, +, diakrytyki itd.)
    function encodePathSegments(p) {
      if (!p) return p;
      // Zachowaj separatory '/', zakoduj kaÅ¼dy segment oddzielnie
      return p.split('/').map(seg => encodeURIComponent(seg)).join('/');
    }

    async function findLatestVersion(basePath) {
      const urlObj = new URL(window.location.href);
      const isDev = urlObj.searchParams.get('dev') === '1';
      const deepScan = urlObj.searchParams.get('scanV') === '1';
      const pathParts = basePath.split('.');
      const extension = pathParts.pop(); // np. glb
      const baseWithoutExt = pathParts.join('.');

      // Wersjonowanie dotyczy tylko nÃ³g (legs/). Dla pozostaÅ‚ych Å›cieÅ¼ek zwrÃ³Ä‡ oryginaÅ‚.
      if (!/^legs\//i.test(basePath)) {
        return basePath;
      }

      // ðŸ”¥ SPECIAL DEBUG: sprawdÅº czy to "z obrotem"
      if (basePath.includes('z obrotem')) {
        console.log(`ðŸ”¥ðŸ”¥ðŸ”¥ VERSIONING Z OBROTEM: ${basePath}`);
        console.log(`ðŸ”¥ baseWithoutExt: ${baseWithoutExt}`);
        console.log(`ðŸ”¥ extension: ${extension}`);
      }

      // Helper: sprawdÅº istnienie pliku. Najpierw HEAD, a w trybie dev fallback do lekkiego GET.
      async function exists(tryPath) {
        const encoded = encodePathSegments(tryPath);
        // 1) SprÃ³buj HEAD
        try {
          const head = await fetch(encoded, { method: 'HEAD', cache: 'no-store' });
          if (head && head.ok) return true;
        } catch (_) { /* noop */ }
        // 2) Fallback w DEV: Å¼ywe serwery czÄ™sto nie wspierajÄ… HEAD â€” sprÃ³buj GET z no-store
        if (isDev) {
          try {
            const getResp = await fetch(encoded, { method: 'GET', cache: 'no-store' });
            return !!(getResp && getResp.ok);
          } catch (_) { /* noop */ }
        }
        return false;
      }

      // Najpierw szybkie sprawdzenie typowych wersji: v4..v1
      for (let v of [4,3,2,1]) {
        const versionedPath = `${baseWithoutExt}_v${v}.${extension}`;
        if (basePath.includes('z obrotem')) {
          console.log(`ðŸ”¥ Checking z obrotem version: ${versionedPath}`);
        }
        if (await exists(versionedPath)) {
          console.log(`ðŸ“¦ Wersjonowanie: uÅ¼ywam ${versionedPath}`);
          return versionedPath;
        }
      }
      // JeÅ›li nie znaleziono Å¼adnej z v4..v1, sprawdÅº czy istnieje plik bazowy i od razu go zwrÃ³Ä‡,
      // aby uniknÄ…Ä‡ kaskady 404.
      if (await exists(basePath)) {
        console.log(`ðŸ“¦ Wersjonowanie: brak v4..v1, uÅ¼ywam bazowego ${basePath}`);
        return basePath;
      }

      // Opcjonalnie: gÅ‚Ä™bszy skan v10..v4 tylko poza DEV lub gdy jawnie wÅ‚Ä…czony parametrem ?scanV=1
      if (!isDev || deepScan) {
        for (let v = 10; v >= 4; v--) {
          const versionedPath = `${baseWithoutExt}_v${v}.${extension}`;
          if (await exists(versionedPath)) {
            console.log(`ðŸ“¦ Wersjonowanie: uÅ¼ywam ${versionedPath}`);
            return versionedPath;
          }
        }
      }
      // Ostateczny fallback: zwrÃ³Ä‡ bazowÄ… Å›cieÅ¼kÄ™
      console.log(`ðŸ“¦ Wersjonowanie: brak wersji, uÅ¼ywam ${basePath}`);
      return basePath;
    }

    async function loadModelWithFreshness(path, viewer, options = {}) {
      // Opcjonalny parametr testowy: ?forceV=3 wymusi _v3.glb TYLKO dla nÃ³g
      const urlObj = new URL(window.location.href);
      const forceV = parseInt(urlObj.searchParams.get('forceV') || '');
      let latestPath;
      if (!isNaN(forceV) && forceV > 0 && /^legs\//i.test(path)) {
        const pathParts = path.split('.');
        const ext = pathParts.pop();
        const base = pathParts.join('.');
        latestPath = `${base}_v${forceV}.${ext}`;
        console.log(`ðŸ§ª forceV aktywny dla nÃ³g: ${path} -> ${latestPath}`);
      } else {
        // Najpierw znajdÅº najwyÅ¼szÄ… dostÄ™pnÄ… wersjÄ™
        latestPath = await findLatestVersion(path);
      }
  const encodedPath = encodePathSegments(latestPath);
      console.log(`ðŸ”„ Loading model: ${path} -> ${latestPath} -> ${encodedPath}`);
      let version = Date.now();
      try {
        // SprÃ³buj pobraÄ‡ Last-Modified (niektÃ³re serwery/iOS mogÄ… blokowaÄ‡ HEAD)
        const res = await fetch(encodedPath, { method: 'HEAD' });
        if (res.ok) {
          const lastModified = res.headers.get('Last-Modified');
          if (lastModified) version = new Date(lastModified).getTime();
        }
      } catch (e) {
        console.warn('HEAD failed for', encodedPath, 'â€” using Date.now() as cache buster');
      }
      const pathWithVersion = `${encodedPath}?v=${version}`;
      // ZapamiÄ™taj ostatnio Å‚adowanÄ… Å›cieÅ¼kÄ™ â€” pomocne do debugowania
      try {
        window.__lastLoadPath = latestPath;
        window.__lastLoadUrl = pathWithVersion;
        if (/\/legs\//i.test(latestPath)) {
          // Banner wyÅ‚Ä…czony na Å¼yczenie - tylko console log
          console.log('[DEBUG-BANNER]', `LEGS: ${latestPath}`);
        }
      } catch(_) {}
      console.log(`ðŸ”„ Loading with cache buster: ${pathWithVersion}`);
      // ZaÅ‚aduj model z cache-busterem (nawet jeÅ›li HEAD siÄ™ nie powiÃ³dÅ‚)
      const loadedModel = await viewer.load(pathWithVersion, options);
      
      // ðŸ”¥ DEBUG: Sprawdzamy zawartoÅ›Ä‡ zaÅ‚adowanego modelu nÃ³g z obrotem
      if (/\/legs\/.*z obrotem.*\.glb/i.test(pathWithVersion)) {
        console.log(`ðŸ”¥ðŸ”¥ðŸ”¥ Z OBROTEM MODEL LOADED - szczegÃ³Å‚y:`, {
          originalPath: path,
          finalLoadedPath: pathWithVersion,
          hasScene: !!loadedModel?.scene,
          sceneChildren: loadedModel?.scene?.children?.length || 0,
          firstChildName: loadedModel?.scene?.children?.[0]?.name || 'brak'
        });
        
        // Sprawdzamy geometriÄ™ pierwszego mesh-a
        const firstMesh = loadedModel?.scene?.children?.find(c => c.type === 'Mesh' || c.isMesh);
        if (firstMesh && firstMesh.geometry) {
          const vertCount = firstMesh.geometry.attributes.position?.count;
          console.log(`ðŸ”¥ Z OBROTEM GEOMETRY:`, {
            meshName: firstMesh.name,
            vertexCount: vertCount,
            hasGeometry: !!firstMesh.geometry,
            geometryType: firstMesh.geometry.constructor?.name
          });
        }
      }
      
      return loadedModel;
    }

    // ï¿½ FUNKCJA DYNAMICZNEGO DOSTOSOWYWANIA PROPORCJI MOBILNYCH
    function adjustMobileProportions() {
      console.log('ðŸ“± adjustMobileProportions called, mobile-mode:', document.body.classList.contains('mobile-mode'));
      
      // SprawdÅº czy rzeczywiÅ›cie jesteÅ›my w mobile mode
      if (!document.body.classList.contains('mobile-mode')) {
        console.log('ðŸ“± Not in mobile mode, skipping adjustments');
        return;
      }
      
      // SprawdÅº czy to nie desktop z wÄ…skim oknem - uÅ¼yj tej samej logiki co computeMobileMode
      const uaMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || (navigator.platform==='MacIntel' && navigator.maxTouchPoints>1);
      const isNarrowScreen = window.innerWidth <= 820;
      const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      const isDevToolsEmulator = isNarrowScreen && (hasTouch || window.orientation !== undefined || /Mobi/i.test(navigator.userAgent));
      const isTinyScreen = window.innerWidth <= 500;
      
      if (!uaMobile && !isDevToolsEmulator && !isTinyScreen) {
        console.log('ðŸ“± Desktop browser detected, skipping mobile proportions');
        return;
      }
      
      const screenWidth = window.screen.width;
      const viewportWidth = window.innerWidth;
      const effectiveWidth = Math.max(screenWidth, viewportWidth);
      const userAgent = navigator.userAgent;
      
      // Wykryj konkretne modele telefonÃ³w
      let deviceInfo = 'Unknown';
      if (userAgent.includes('iPhone')) {
        if (effectiveWidth <= 375) deviceInfo = 'iPhone SE/6/7/8';
        else if (effectiveWidth <= 414) deviceInfo = 'iPhone Plus/XR/11';
        else deviceInfo = 'iPhone Pro/Max';
      } else if (userAgent.includes('Samsung')) {
        if (effectiveWidth <= 360) deviceInfo = 'Samsung Standard';
        else if (effectiveWidth <= 412) deviceInfo = 'Samsung Galaxy S20/S21';
        else deviceInfo = 'Samsung Galaxy Large';
      } else if (userAgent.includes('Android')) {
        if (effectiveWidth <= 360) deviceInfo = 'Android Standard';
        else if (effectiveWidth <= 412) deviceInfo = 'Android Large';
        else deviceInfo = 'Android Tablet';
      }
      
      console.log('ðŸ“± Adjusting mobile proportions:', { 
        device: deviceInfo, 
        screenWidth, 
        viewportWidth, 
        effectiveWidth 
      });
      
      // Proporcje dynamiczne zaleÅ¼ne od rozmiaru ekranu - TERAZ 50-50 dla wszystkich
      let panelWidth, welcomeWidth;
      
      console.log('ðŸ“± Using 50-50 proportions for all screen sizes');
      // Wszystkie ekrany: panel 50%
      panelWidth = Math.round(effectiveWidth * 0.5);
      welcomeWidth = effectiveWidth - panelWidth;
      
      // Minimalne rozmiary tylko dla bardzo maÅ‚ych ekranÃ³w
      if (effectiveWidth <= 320) {
        panelWidth = Math.max(160, panelWidth);
        welcomeWidth = effectiveWidth - panelWidth;
      }
      
      // Maksymalne rozmiary dla bardzo duÅ¼ych ekranÃ³w
      if (effectiveWidth > 800) {
        panelWidth = Math.min(400, panelWidth);
        welcomeWidth = effectiveWidth - panelWidth;
      }
      
      // Dostosuj rozmiar thumbnail do szerokoÅ›ci panelu (3 w rzÄ™dzie)
      const thumbnailWidth = Math.floor((panelWidth - 30) / 3) - 4; // 30px padding + margines
      
      console.log('ðŸ“± Final dimensions:', { panelWidth, welcomeWidth, thumbnailWidth });
      
      // StwÃ³rz style CSS
      const style = document.createElement('style');
      style.id = 'dynamic-mobile-proportions';
      style.textContent = `
        body.mobile-mode #mobile-right-panel {
          width: ${panelWidth}px !important;
        }
        body.mobile-mode #app {
          width: 100vw !important;
          height: 100vh !important;
        }
        body.mobile-mode #welcome-screen {
          width: ${welcomeWidth}px !important;
        }
        body.mobile-mode #canvas-container {
          width: ${welcomeWidth}px !important;
        }
        body.mobile-mode #mobile-right-panel .thumbnail {
          width: ${thumbnailWidth}px !important;
        }
        body.mobile-mode #mobile-right-panel .thumbnail img {
          width: ${Math.min(thumbnailWidth - 8, 60)}px !important;
          height: ${Math.min(thumbnailWidth - 8, 60)}px !important;
        }
      `;
      
      // UsuÅ„ poprzednie dynamiczne style jeÅ›li istniejÄ…
      const existingStyle = document.getElementById('dynamic-mobile-proportions');
      if (existingStyle) existingStyle.remove();
      
      // Dodaj nowe style
      document.head.appendChild(style);
      
      // Aktualizuj dynamicznie tworzony panel
      const dynamicPanel = document.querySelector('#mobile-right-panel[style*="position: fixed"]');
      if (dynamicPanel) {
        dynamicPanel.style.width = panelWidth + 'px';
      }
    }

    // ï¿½ðŸš€ PROSTA INICJALIZACJA (jak w poprzedniej rozmowie)
    document.addEventListener('DOMContentLoaded', () => {
      console.log('ï¿½ DEBUG: DOMContentLoaded fired');
      console.log('ï¿½ðŸš€ DOM loaded, starting app...');
      console.log('ðŸ§© Build stamp:', { ts: new Date().toISOString(), file: 'index.html' });
      try { document.body.classList.add('awaiting-selection'); } catch(_) {}

      // Early mobile mode & ensure panel exists
      try {
        if (typeof applyMobileMode === 'function') {
          applyMobileMode();
        }
        
        // Dostosuj proporcje mobilne AFTER applyMobileMode
        setTimeout(adjustMobileProportions, 50);
        

      } catch(e) { console.warn('Early mobile init failed:', e); }
      
      // NasÅ‚uchuj zmiany orientacji/rozmiaru
      window.addEventListener('resize', () => {
        if (typeof applyMobileMode === 'function') applyMobileMode();
        adjustMobileProportions();
      });
      window.addEventListener('orientationchange', () => {
        setTimeout(() => {
          if (typeof applyMobileMode === 'function') applyMobileMode();
          adjustMobileProportions();
        }, 100);
      });
      
      // SprawdÅº czy pokazaÄ‡ link do panelu admina
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('admin') === 'true' || window.location.hash.includes('admin')) {
        const adminLink = document.getElementById('admin-link');
        if (adminLink) {
          adminLink.style.display = 'block';
        }
      }
      
      init();
    });

    // ðŸ›¡ï¸ Safety: ensure the initial loader is hidden on all devices (esp. mobile)
    (function ensureLoaderHidesSafely(){
      function forceHideInitialLoader(reason){
        try {
          const loader = document.getElementById('custom-loader');
          const app = document.getElementById('app');
          if (loader && loader.style.display !== 'none') {
            console.log('ðŸ›¡ï¸ Force-hiding loader (' + (reason||'safety') + ')');
            loader.classList.add('fade-out');
            setTimeout(() => { try { loader.style.display = 'none'; } catch(_) {} }, 150);
          }
          if (app) app.style.visibility = 'visible';
          // NIE pokazuj dolnego toolbara dopÃ³ki nie wybierzemy krzesÅ‚a
          // (wczeÅ›niej byÅ‚ tutaj kod pokazujÄ…cy toolbar z gÃ³ry)
        } catch(_) {}
      }
      // Hide after window load as a backstop
      window.addEventListener('load', () => setTimeout(() => forceHideInitialLoader('window-load'), 800), { once: true });
      // Hide when tab becomes visible (iOS/Safari quirks)
      document.addEventListener('visibilitychange', () => { if (!document.hidden) setTimeout(() => forceHideInitialLoader('visibilitychange'), 100); });
      // Absolute timeout backstop
      setTimeout(() => forceHideInitialLoader('timeout-5s'), 5000);
      // Expose helper for manual use
      window.forceHideInitialLoader = forceHideInitialLoader;
    })();

    // ðŸ“± NOWY SYSTEM ORIENTACJI - prosty i niezawodny
    // ðŸ”„ FLAGA ZAPOBIEGAJÄ„CA WIELOKROTNEJ INICJALIZACJI
    let isAppInitialized = false;

    async function init() {
      console.log('ðŸ”¥ DEBUG: init() function called');
      if (isAppInitialized) {
        console.log('ðŸš« App already initialized, skipping...');
        return;
      }
      
      console.log('ðŸš€ Starting app initialization...');
      isAppInitialized = true;
      
      // TYMCZASOWO WYÅÄ„CZONE: NasÅ‚uchiwanie zmian w localStorage (synchronizacja z panelem admina)
      // window.addEventListener('storage', function(e) {
      //   if (e.key === 'chairsData' || e.key === 'materialsData') {
      //     console.log('ðŸ”„ Detected data change from admin panel, reloading...');
      //     setTimeout(() => {
      //       loadDataFromSheet(); // PrzeÅ‚aduj dane
      //     }, 1000);
      //   }
      // });
      
      console.log('ðŸ”¥ DEBUG: About to call initApp()');
      initApp(); // Uruchom wÅ‚aÅ›ciwÄ… inicjalizacjÄ™
    }
    
    async function initApp() {
      console.log('ðŸš€ initApp() started');
      
      console.log('ðŸ”¥ DEBUG: About to ensure canvas exists');
      // Ensure the canvas element exists. Some environments or build steps
      // may accidentally remove it; create a fallback canvas so initialization
      // continues and resizeCanvas has something to work with.
      let canvas = document.getElementById("canvas");
      if (!canvas) {
        console.warn('âš ï¸ Canvas element not found in DOM - creating fallback <canvas id="canvas">');
        const container = document.getElementById('canvas-container') || document.getElementById('app') || document.body;
        canvas = document.createElement('canvas');
        canvas.id = 'canvas';
        canvas.style.width = '100%';
        canvas.style.height = '100%';
        // Insert at top of container so welcome-screen overlays remain above
        if (container.firstChild) container.insertBefore(canvas, container.firstChild); else container.appendChild(canvas);
      }

      viewer = new ThreeViewer({
        canvas: canvas,
        plugins: [ GBufferPlugin, SSAAPlugin, SSReflectionPlugin, BloomPlugin],
        rendererSettings: { 
          antialias: true,
          // ðŸ“± Mobile-specific renderer settings for better material compatibility
          preserveDrawingBuffer: document.body.classList.contains('mobile-mode') || window.innerWidth <= 820,
          powerPreference: (document.body.classList.contains('mobile-mode') || window.innerWidth <= 820) ? "default" : "high-performance"
        }
      });
      
      // Eksport viewer dla PWA
      window.viewer = viewer;
      console.log('ðŸŽ¯ Viewer initialized and exported to window');
      
      // Mobile debug: check canvas size and visibility
      if (document.body.classList.contains('mobile-mode') || window.innerWidth <= 820) {
        console.log('ðŸ“± MOBILE DEBUG: Canvas info:', {
          id: canvas.id,
          width: canvas.width,
          height: canvas.height,
          styleWidth: canvas.style.width,
          styleHeight: canvas.style.height,
          offsetWidth: canvas.offsetWidth,
          offsetHeight: canvas.offsetHeight,
          display: getComputedStyle(canvas).display,
          visibility: getComputedStyle(canvas).visibility,
          zIndex: getComputedStyle(canvas).zIndex
        });
        
        // Force canvas to be visible and properly sized
        canvas.style.display = 'block';
        canvas.style.visibility = 'visible';
        canvas.style.position = 'relative';
        canvas.style.zIndex = '1';
        
        // Ensure canvas container is properly sized
        const canvasContainer = document.getElementById('canvas-container');
        if (canvasContainer) {
          canvasContainer.style.width = 'calc(100% - 280px)';
          canvasContainer.style.height = '100vh';
          canvasContainer.style.display = 'block';
          canvasContainer.style.visibility = 'visible';
          console.log('ðŸ“± MOBILE DEBUG: Canvas container sized for mobile');
        }
      }

      // Backwards-compat shim: older code accesses `viewer.renderer` but
      // newer ThreeViewer exposes a `renderManager`. If renderManager exists,
      // proxy `viewer.renderer` to the underlying renderer to avoid runtime
      // errors and ease migration. This keeps logs quiet while we update uses.
      try {
        if (!viewer.renderer && viewer.renderManager && viewer.renderManager.renderer) {
          Object.defineProperty(viewer, 'renderer', {
            configurable: true,
            enumerable: true,
            get() { return viewer.renderManager.renderer; }
          });
          console.log('ðŸ” Compatibility shim: viewer.renderer proxied to renderManager.renderer');
        }
      } catch (e) {
        console.warn('âš ï¸ Could not install viewer.renderer shim:', e);
      }
      
      if (viewer.controls) {
        viewer.controls.minDistance = MIN_ZOOM_DISTANCE;
        viewer.controls.maxDistance = MAX_ZOOM_DISTANCE;
        viewer.controls.dampingFactor = 0.1;
        viewer.controls.enableDamping = true;
        viewer.controls.addEventListener('change', clampCameraDistance);
      }

      // ObsÅ‚uga nowego config overview popup
      const configButton = document.getElementById('config-overview-button');
      const configPopup = document.getElementById('config-overview-popup');
      const configPopupClose = document.getElementById('config-popup-close');
      const popupBuyButton = document.getElementById('popup-buy-button');

      // PokaÅ¼ popup po klikniÄ™ciu w przycisk
      if (configButton) {
        configButton.onclick = () => {
          configPopup.style.display = 'flex';
        };
      }

      // Zamknij popup
      if (configPopupClose) {
        configPopupClose.onclick = () => {
          configPopup.style.display = 'none';
        };
      }

      // Zamknij popup po klikniÄ™ciu w tÅ‚o
      if (configPopup) {
        configPopup.onclick = (e) => {
          if (e.target === configPopup) {
            configPopup.style.display = 'none';
          }
        };
      }

      // ObsÅ‚uga przycisku "ZamÃ³w" w popup
      if (popupBuyButton) {
        popupBuyButton.onclick = () => {
          // WypeÅ‚nij ikony podsumowania
          fillOrderSummaryIcons();
          
          // OtwÃ³rz modal zamÃ³wienia
          const emailModal = document.getElementById('emailModal');
          const successMessage = document.getElementById('success-message');
          if (emailModal) {
            emailModal.classList.remove('hidden');
            emailModal.classList.add('visible');
            if (successMessage) {
              successMessage.classList.remove('visible');
              successMessage.classList.add('hidden');
            }
          }
          
          // Zamknij popup podsumowania
          if (configPopup) {
            configPopup.style.display = 'none';
          }
        };
      }

      // ObsÅ‚uga przycisku "Kontynuuj do aplikacji" na welcome screen
      const welcomeContinueBtn = document.getElementById('welcome-continue-btn');
      if (welcomeContinueBtn) {
        console.log('ðŸŽ¯ Welcome continue button found and adding listener');
        welcomeContinueBtn.onclick = () => {
          console.log('ðŸŽ¯ Welcome continue button clicked');
          const welcomeScreen = document.getElementById('welcome-screen');
          if (welcomeScreen) {
            console.log('ðŸŽ¯ Hiding welcome screen');
            welcomeScreen.style.display = 'none';
          } else {
            console.log('âŒ Welcome screen not found');
          }
        };
      } else {
        console.log('âŒ Welcome continue button not found');
      }

      try {
        console.log('ðŸ“± Loading HDR environment map...');
        await viewer.setEnvironmentMap("hdr/hamburg_hbf_1k.hdr", { isHDR: true });
        console.log('ðŸ“± HDR environment map loaded successfully');
        
        // Zapisz oryginalnÄ… intensywnoÅ›Ä‡ HDR dla pÃ³Åºniejszej kontroli jasnoÅ›ci
        if (viewer.scene && viewer.scene.environment) {
          if (!window.originalHDRIntensity) {
            window.originalHDRIntensity = viewer.scene.environment.intensity || 1;
          }
          console.log('ðŸ’¡ HDR loaded, original intensity:', window.originalHDRIntensity);
          
          // ðŸ“± Mobile: Force higher HDR intensity for better material visibility
          if (document.body.classList.contains('mobile-mode') || window.innerWidth <= 820) {
            viewer.scene.environment.intensity = window.originalHDRIntensity * 1.5;
            console.log('ðŸ“± MOBILE: Increased HDR intensity for better material visibility:', viewer.scene.environment.intensity);
          }
        }
        
        // Ustaw domyÅ›lnÄ… intensywnoÅ›Ä‡ tone mapping
        function getEffectiveRenderer() {
          if (viewer.renderManager && viewer.renderManager.renderer) return viewer.renderManager.renderer;
          if (viewer.renderer) return viewer.renderer;
          return null;
        }
        const effectiveRenderer = getEffectiveRenderer();
        if (effectiveRenderer) {
          effectiveRenderer.toneMappingExposure = 1.0;
          console.log('ðŸ’¡ Tone mapping exposure set to default:', effectiveRenderer.toneMappingExposure);
        }
        
      } catch (e) { 
        console.error("BÅ‚Ä…d Å‚adowania HDR:", e); 
      }

      console.log("Åadowanie celÃ³w kamery...");
      // USUNIÄ˜TO loadCameraTarget - niepotrzebny plik camera_target.glb
      
      // PRZYWRÃ“CONE globalCameraTargetPosition 
      globalCameraTargetPosition = new Vector3(CAMERA_TARGET.x, CAMERA_TARGET.y, CAMERA_TARGET.z); // UÅ¼ywamy zdefiniowanego targetu
      
  window.addEventListener("resize", resizeCanvas);
      resizeCanvas();
      
      // Mark body as mobile-mode when on phone/tablet (UA/touch), so CSS applies even if width wider (Safari UI)
      function computeMobileMode(){
        // ENABLED: Mobile mode detection - proper mobile detection
        const forceMobileFlag = /[?#&]mobile=1\b/.test(location.search + location.hash);
        const forceDesktopFlag = /[?#&]desktop=1\b/.test(location.search + location.hash);

        // More accurate mobile detection
        const uaMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
        const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
        const isAndroid = /Android/.test(navigator.userAgent);
        const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
        const isNarrowScreen = window.innerWidth <= 820;
        const isVeryNarrowScreen = window.innerWidth <= 500;

        // Desktop override - if explicitly requested, always use desktop mode
        if (forceDesktopFlag) {
          console.log('ðŸ–¥ï¸ Desktop mode forced by URL parameter');
          return false;
        }

        // Force mobile mode if explicitly requested
        if (forceMobileFlag) {
          console.log('ðŸ“± Mobile mode forced by URL parameter');
          return true;
        }

        // STRICTER mobile detection - only actual mobile devices with small screens
        const isStandalonePWA = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone === true);
        const isMobileViewport = window.innerWidth <= 820 && window.innerHeight <= 1024;
        const isDesktopBrowser = !isStandalonePWA && window.innerWidth > 1024;

        // Desktop override: if screen is wide enough, force desktop mode
        if (isDesktopBrowser) {
          console.log('ðŸ–¥ï¸ Desktop browser detected (wide screen), forcing desktop mode');
          return false;
        }

        // Stricter mobile detection - only actual mobile devices with small screens
        const isMobile = (uaMobile || hasTouch) &&
                        isNarrowScreen &&
                        (isIOS || isAndroid || isVeryNarrowScreen) &&
                        isMobileViewport;

        console.log('ðŸ“± Mobile detection:', {
          forceMobileFlag,
          forceDesktopFlag,
          uaMobile,
          isIOS,
          isAndroid,
          hasTouch,
          isNarrowScreen,
          isVeryNarrowScreen,
          isStandalonePWA,
          isMobileViewport,
          isDesktopBrowser,
          final: isMobile,
          width: window.innerWidth,
          height: window.innerHeight,
          userAgent: navigator.userAgent.substring(0, 50)
        });

        return isMobile;
      }
      function applyMobileMode(){ 
        const wasMobile = document.body.classList.contains('mobile-mode');
        const shouldBeMobile = computeMobileMode();
        document.body.classList.toggle('mobile-mode', shouldBeMobile);
        const isMobileNow = document.body.classList.contains('mobile-mode');
        
        console.log('ðŸ“± applyMobileMode:', { wasMobile, shouldBeMobile, isMobileNow });
        
        // JeÅ›li przeÅ‚Ä…czono na mobile, upewnij siÄ™ Å¼e panel istnieje
        if (!wasMobile && isMobileNow) {
          console.log('ðŸ“± Switched to mobile mode - ensuring panel exists...');
          setTimeout(() => {
            if (typeof ensureMobilePanel === 'function') {
              const ctx = ensureMobilePanel();
              console.log('ðŸ“± Mobile panel ensured after mode switch:', !!ctx);
            }
            // Wymusz ponowne renderowanie kategorii
            if (typeof renderCategoryButtons === 'function') {
              console.log('ðŸ“± Re-rendering categories after mobile switch...');
              renderCategoryButtons();
            }
          }, 100);
        }
      }
      // DISABLED: Move elements to mobile panel - prevent mobile UI interference
      function moveElementsToMobilePanel(){
        console.log('moveElementsToMobilePanel called but DISABLED - keeping elements in desktop sidebar');
        return;
      }
      // ENABLED: Mobile panel creation for physical devices
      function ensureMobilePanel(){
        try {
          if (!document.body.classList.contains('mobile-mode')) return null;
          const panel = document.getElementById('mobile-right-panel');
          if (!panel) return null;
          try { panel.style.display = 'block'; } catch(_) {}
          // Ensure category section exists inside the panel
          let catSection = panel.querySelector('#category-buttons');
          if (!catSection) {
            catSection = document.createElement('div');
            catSection.id = 'category-buttons';
            catSection.style.marginBottom = '20px';
            const title = document.createElement('h3');
            title.style.cssText = 'margin-bottom: 10px; font-size: 16px; color: #555;';
            title.textContent = 'Kategorie:';
            const special = document.createElement('div');
            special.id = 'special-categories-container';
            special.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;';
            const buttons = document.createElement('div');
            buttons.id = 'category-buttons-container';
            buttons.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px;';
            catSection.appendChild(title);
            catSection.appendChild(special);
            catSection.appendChild(buttons);
            // Insert right after search container if present, otherwise at panel start
            const search = panel.querySelector('#search-container');
            if (search && search.nextSibling) panel.insertBefore(catSection, search.nextSibling);
            else panel.insertBefore(catSection, panel.firstChild);
          }
          // Ensure a dedicated list area exists (to avoid clearing the whole panel)
          let listArea = panel.querySelector('#mobile-list-area');
          if (!listArea) {
            listArea = document.createElement('div');
            listArea.id = 'mobile-list-area';
            listArea.style.marginTop = '8px';
            panel.appendChild(listArea);
          }
          // Make sure elements are moved into the panel
          try { window.moveElementsToMobilePanel(); } catch(_) {}
          return { panel, listArea };
        } catch(_) { return null; }
      }
  applyMobileMode(); 
  window.addEventListener('resize', () => {
    console.log('ðŸ“± RESIZE EVENT:', window.innerWidth + 'x' + window.innerHeight);
    applyMobileMode();
    // Po przeÅ‚Ä…czeniu na mobile w DevTools, upewnij siÄ™ Å¼e panel istnieje
    setTimeout(() => {
      const isMobileNow = document.body.classList.contains('mobile-mode');
      console.log('ðŸ“± RESIZE: After applyMobileMode, mobile-mode:', isMobileNow);
      
      if (isMobileNow) {
        console.log('ðŸ“± RESIZE: Mobile mode detected, ensuring panel exists');
        const ctx = ensureMobilePanel();
        if (ctx && ctx.panel) {
          ctx.panel.style.display = 'block';
          ctx.panel.style.visibility = 'visible';
          ctx.panel.style.opacity = '1';
          console.log('ðŸ“± RESIZE: Mobile panel created/shown');
          
          // Dostosuj proporcje mobilne
          if (typeof adjustMobileProportions === 'function') {
            adjustMobileProportions();
          }
          
          // Wymusz renderowanie kategorii jeÅ›li data juÅ¼ jest zaÅ‚adowana
          if (window.allData && window.allData.length > 0) {
            console.log('ðŸ“± RESIZE: Re-rendering categories for mobile');
            setTimeout(() => renderCategoryButtons(), 100);
          }
        } else {
          console.error('ðŸ“± RESIZE: Failed to create mobile panel!');
        }
      } else {
        console.log('ðŸ“± RESIZE: Not mobile mode, width:', window.innerWidth);
      }
    }, 50);
  });
  
  // FORCE mobile panel dla maÅ‚ych ekranÃ³w w DevTools
  setTimeout(() => {
    if (window.innerWidth <= 768) {
      console.log('ðŸ“± FORCE: Small screen detected, forcing mobile mode');
      document.body.classList.add('mobile-mode');
      const forceCtx = ensureMobilePanel();
      if (forceCtx && forceCtx.panel) {
        console.log('ðŸ“± FORCE: Mobile panel created for small screen');
      }
    }
  }, 100);
  // Ensure the mobile panel is visible and prepared as early as possible on real mobile
  try { 
    if (document.body.classList.contains('mobile-mode')) { 
      const ctxEarly = ensureMobilePanel(); 
      if (ctxEarly && ctxEarly.panel) {
        ctxEarly.panel.style.display = 'block';
        ctxEarly.panel.style.visibility = 'visible';
        ctxEarly.panel.style.opacity = '1';
        console.log('ðŸ“± EARLY: Mobile panel created and made visible');
      }
      
      // PokaÅ¼ mobile welcome popup po krÃ³tkim delay
      setTimeout(() => {
        const popup = document.getElementById('mobile-welcome-popup');
        if (popup) {
          popup.style.display = 'block';
          console.log('ðŸ“± Mobile welcome popup shown');
          
          // SprawdÅº czy aplikacja moÅ¼e byÄ‡ zainstalowana (PWA)
          if (window.deferredPrompt) {
            document.getElementById('install-app-btn').style.display = 'inline-block';
          }
        }
      }, 1000);
    } 
  } catch(_) {}
  
  // PWA Installation function
  let deferredPrompt;
  window.addEventListener('beforeinstallprompt', (e) => {
    e.preventDefault();
    deferredPrompt = e;
    window.deferredPrompt = e;
    // PokaÅ¼ przycisk instalacji w popup jeÅ›li jest otwarty
    const installBtn = document.getElementById('install-app-btn');
    if (installBtn) installBtn.style.display = 'inline-block';
  });
  
  window.installApp = function() {
    if (deferredPrompt) {
      deferredPrompt.prompt();
      deferredPrompt.userChoice.then((choiceResult) => {
        if (choiceResult.outcome === 'accepted') {
          console.log('ðŸ“± User accepted PWA installation');
        }
        deferredPrompt = null;
        window.deferredPrompt = null;
        document.getElementById('install-app-btn').style.display = 'none';
      });
    }
  };
  
  moveElementsToMobilePanel();

      console.log('ðŸ“¡ Loading data from sheets...');
      await loadDataFromSheet();
  console.log('âœ… Data loaded successfully, items:', (allData ? allData.length : 0));
  console.log('ðŸ” Sample data:', (allData ? allData.slice(0, 3) : []));
      
      // ðŸ”§ FALLBACK: JeÅ›li brak danych, stwÃ³rz podstawowe
      if (!allData || allData.length === 0) {
        console.warn('âš ï¸ No data loaded, creating fallback data...');
        allData = [
          { Nazwa: 'KrzesÅ‚o Podstawowe', Kategoria: 'KrzesÅ‚a', Typ: 'model', Promocja: 'FALSE', Bestseller: 'FALSE' },
          { Nazwa: 'Fotel Komfortowy', Kategoria: 'Fotele', Typ: 'model', Promocja: 'TRUE', Procent: '15', Bestseller: 'FALSE' },
          { Nazwa: 'Hoker Barowy', Kategoria: 'Hokery', Typ: 'model', Promocja: 'FALSE', Bestseller: 'TRUE' }
        ];
        console.log('ðŸ”§ Created fallback data:', allData);
      }
      
      // WywoÅ‚aj renderowanie przyciskÃ³w - z dodatkowym opÃ³Åºnieniem dla pewnoÅ›ci
      console.log('ðŸŽ¯ Calling renderCategoryButtons...');
      renderCategoryButtons();
      
      // ðŸ”§ MOBILE: Proper mobile UI setup
      if (document.body.classList.contains('mobile-mode') || window.innerWidth <= 820) {
        console.log('ðŸ“± Mobile mode detected - setting up proper mobile UI');
        const welcomeScreen = document.getElementById('welcome-screen');
        if (welcomeScreen) {
          welcomeScreen.style.display = 'none';
          console.log('ðŸ“± Welcome screen hidden');
        }
        // ZapamiÄ™taj, Å¼e welcome zostaÅ‚ ukryty na mobile, aby inne Å›cieÅ¼ki go nie przywracaÅ‚y
        try { window.mobileWelcomeDismissed = true; } catch(_) {}

        // PokaÅ¼ app
        const appElement = document.getElementById('app');
        if (appElement) {
          appElement.style.visibility = 'visible';
          console.log('ðŸ“± App made visible');
        }

        // ðŸ”§ MOBILE UI: Hide desktop sidebar and show mobile panel
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
          sidebar.style.display = 'none !important';
          sidebar.style.visibility = 'hidden !important';
          sidebar.style.opacity = '0 !important';
          console.log('ðŸ“± Desktop sidebar hidden on mobile');
        }

        // Show mobile panel
        const mobilePanel = document.getElementById('mobile-right-panel');
        if (mobilePanel) {
          mobilePanel.style.display = 'block !important';
          mobilePanel.style.visibility = 'visible !important';
          mobilePanel.style.opacity = '1 !important';
          mobilePanel.style.position = 'fixed !important';
          mobilePanel.style.top = '0 !important';
          mobilePanel.style.right = '0 !important';
          mobilePanel.style.width = '280px !important';
          mobilePanel.style.height = '100vh !important';
          mobilePanel.style.zIndex = '150 !important';
          mobilePanel.style.overflowY = 'auto !important';
          mobilePanel.style.padding = '12px !important';
          mobilePanel.style.background = '#fff !important';
          mobilePanel.style.borderLeft = '1px solid rgba(0,0,0,0.08) !important';
          mobilePanel.style.boxShadow = '-6px 0 24px rgba(0,0,0,0.06) !important';
          console.log('ðŸ“± Mobile panel shown on mobile');
        }

        // Adjust canvas for mobile with mobile panel
        const canvasContainer = document.getElementById('canvas-container');
        if (canvasContainer) {
          canvasContainer.style.width = 'calc(100% - 280px) !important';
          canvasContainer.style.height = '100vh !important';
          canvasContainer.style.display = 'block !important';
          canvasContainer.style.position = 'relative !important';
          canvasContainer.style.left = '0 !important';
          canvasContainer.style.right = '280px !important';
          console.log('ðŸ“± Canvas container adjusted for mobile');
        }

        // Ensure canvas is properly sized
        const canvas = document.getElementById('canvas');
        if (canvas) {
          canvas.style.width = '100% !important';
          canvas.style.height = '100% !important';
          canvas.style.display = 'block !important';
          console.log('ðŸ“± Canvas sized for mobile');
        }
      }
      
      // ðŸ”§ FALLBACK: JeÅ›li przyciski siÄ™ nie pojawiÅ‚y, sprÃ³buj ponownie
      setTimeout(() => {
        const specialContainer = document.getElementById('special-categories-container');
        const categoryContainer = document.getElementById('category-buttons-container');
        console.log('ðŸ” Button check:', {
          specialExists: !!specialContainer,
          categoryExists: !!categoryContainer,
          specialHasButtons: specialContainer ? specialContainer.children.length : 0,
          categoryHasButtons: categoryContainer ? categoryContainer.children.length : 0
        });
        
        if ((!specialContainer || specialContainer.children.length === 0) && 
            (!categoryContainer || categoryContainer.children.length === 0)) {
          console.warn('âš ï¸ No category buttons found, forcing recreation...');
          renderCategoryButtons();
        }
      }, 1000);
      
      // Ustaw domyÅ›lnie kategoriÄ™ "Promocje" (jak w wersji working_promocja) - z wiÄ™kszym opÃ³Åºnieniem
      setTimeout(() => {
        renderPromotions();
      }, 1500);
      
      // GATE: mark that user picked a category on any category-button click to avoid auto-overrides
      try {
        document.addEventListener('click', (ev) => {
          const btn = ev.target && ev.target.closest && ev.target.closest('.category-button');
          if (!btn) return;
          try { window.__userCategoryPicked = true; } catch(_){}
          // Global: enforce active highlighting immediately on any category-button click
          try {
            document.querySelectorAll('.category-button').forEach(b => {
              b.classList.remove('active');
              b.style.background = 'white';
              b.style.color = b.classList.contains('promotion') ? '#FF6B6B' : '#333';
            });
            btn.classList.add('active');
            if (btn.classList.contains('promotion')) {
              btn.style.background = '#FF6B6B';
              btn.style.color = 'white';
            } else {
              btn.style.background = '#F5C842';
              btn.style.color = '#333';
            }
          } catch(_){ }
        }, { passive: true });
      } catch(_){}
      
      // PokaÅ¼ welcome screen tylko na desktopie â€“ na mobile jest ukryty i pomijany
      const welcomeScreen = document.getElementById('welcome-screen');
      if (welcomeScreen) {
        const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                           (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        const desktopContent = document.getElementById('welcome-desktop-content');
        const mobileContent = document.getElementById('welcome-mobile-content');
        // DomyÅ›lnie ukryj na mobile
        if (isMobileUA || document.body.classList.contains('mobile-mode') || window.innerWidth <= 820 || window.mobileWelcomeDismissed) {
          if (desktopContent) desktopContent.style.display = 'none';
          if (mobileContent) mobileContent.style.display = 'none';
          welcomeScreen.style.display = 'none';
        } else {
          if (desktopContent) desktopContent.style.display = 'block';
          if (mobileContent) mobileContent.style.display = 'none';
          // Don't show welcome on mobile even if conditions suggest it
          if (window.isMobileNow && window.isMobileNow()) {
            welcomeScreen.style.display = 'none';
          } else {
            welcomeScreen.style.display = 'flex';
          }
        }
      }
      
      // Ukryj toolbar i przycisk konfiguracji na starcie
      const toolbar = document.getElementById('bottom-toolbar');
      if (toolbar) {
        toolbar.style.display = 'none';
      }
      
      const configOverviewButton = document.getElementById('config-overview-button');
      if (configOverviewButton) {
        configOverviewButton.style.display = 'none';
      }
    }

    function setCameraView(targetPosition) {
      const camera = viewer.scene.mainCamera;
      camera.fov = CAMERA_FOV;
      camera.near = CAMERA_NEAR;
      camera.far = CAMERA_FAR;
      
      // SprawdÅº czy krzesÅ‚o jest z kategorii hooker i uÅ¼yj odpowiedniej pozycji kamery
      const isHookerChair = selectedChair && selectedChair.Kategoria && 
                            selectedChair.Kategoria.toLowerCase().includes('hooker');
      
      if (isHookerChair) {
        // Dla hookerÃ³w: bardziej oddalone ujÄ™cie
        camera.position.set(CAMERA_POSITION_HOOKER.x, CAMERA_POSITION_HOOKER.y, CAMERA_POSITION_HOOKER.z);
        console.log('ðŸŽ¥ Ustawiam kamerÄ™ dla hookera - oddalone ujÄ™cie');
      } else {
        // Dla normalnych krzeseÅ‚: standardowe ujÄ™cie
        camera.position.set(CAMERA_POSITION.x, CAMERA_POSITION.y, CAMERA_POSITION.z);
        console.log('ðŸŽ¥ Ustawiam kamerÄ™ dla krzesÅ‚a - standardowe ujÄ™cie');
      }

      // Ustaw target na wybranÄ… pozycjÄ™ (np. globalCameraTargetPosition)
      let center = globalCameraTargetPosition || new Vector3(CAMERA_TARGET.x, CAMERA_TARGET.y, CAMERA_TARGET.z);
      camera.lookAt(center);
      camera.updateProjectionMatrix();

      // PrawidÅ‚owe ustawienie kontrolek
      if (viewer.controls) {
        viewer.controls.target.copy(center);
        viewer.controls.enableRotate = true;
        viewer.controls.enablePan = false;
        viewer.controls.screenSpacePanning = false;
        viewer.controls.enableZoom = true;  // POPRAWKA: zoom powinien byÄ‡ wÅ‚Ä…czony
        viewer.controls.enabled = true;
        
        // Ustaw limity zoomu odpowiednie dla typu krzesÅ‚a
        if (isHookerChair) {
          viewer.controls.minDistance = MIN_ZOOM_DISTANCE_HOOKER;
          viewer.controls.maxDistance = MAX_ZOOM_DISTANCE_HOOKER;
          console.log('ðŸ” Ustawiam limity zoomu dla hookera:', MIN_ZOOM_DISTANCE_HOOKER, '-', MAX_ZOOM_DISTANCE_HOOKER);
        } else {
          viewer.controls.minDistance = MIN_ZOOM_DISTANCE;
          viewer.controls.maxDistance = MAX_ZOOM_DISTANCE;
          console.log('ðŸ” Ustawiam standardowe limity zoomu:', MIN_ZOOM_DISTANCE, '-', MAX_ZOOM_DISTANCE);
        }
        
        viewer.controls.update();
        
        console.log('ðŸŽ¯ Camera configured and target position updated:', center);
      }
    }

    function resizeCanvas() {
      const sidebar = document.getElementById("sidebar");
      const sidebarWidth = sidebar ? sidebar.offsetWidth : 0;
      const canvas = document.getElementById("canvas");
      
      // SprawdÅº czy canvas istnieje
      if (!canvas) {
        console.warn('resizeCanvas: Canvas element not found');
        return;
      }
      
      const width = window.innerWidth - sidebarWidth;
      const height = window.innerHeight;
      // Ustaw rozmiar CSS
      canvas.style.width = width + "px";
      canvas.style.height = height + "px";
      // Ustaw rozmiar atrybutÃ³w (dla WebGL)
      canvas.width = width;
      canvas.height = height;
      if (viewer && viewer.renderManager && viewer.scene && viewer.scene.mainCamera) {
        viewer.renderManager.setSize(width, height, false);
        viewer.scene.mainCamera.aspect = width / height;
        viewer.scene.mainCamera.updateProjectionMatrix();
      }
    }

    // ===== ðŸ“± MOBILE HELPERS: move config UI and render list =====
    // Global mobile panel helpers (available outside initApp scope)
    // These shims mirror the versions declared inside initApp, so functions
    // defined at top-level (renderMobileRightPanelList, initializeSearch, etc.)
    // can safely call them on mobile without touching desktop flows.
    (function ensureGlobalMobileHelpers(){
      // moveElementsToMobilePanel: move search and category UI into right mobile panel
      if (typeof window.moveElementsToMobilePanel !== 'function') {
        window.moveElementsToMobilePanel = function moveElementsToMobilePanel(){
          try {
            if (!document.body.classList.contains('mobile-mode')) return;
            const panel = document.getElementById('mobile-right-panel');
            if (!panel) return;
            // Move search-container (and its indicator) to the top of the panel
            const search = document.getElementById('search-container');
            if (search && search.parentElement !== panel) {
              panel.insertAdjacentElement('afterbegin', search);
              const indicator = document.getElementById('search-filter-indicator');
              if (indicator && indicator.parentElement !== panel) {
                panel.insertAdjacentElement('afterbegin', indicator);
              }
            }
            // Move category-buttons block if it exists elsewhere
            const categoryButtons = document.getElementById('category-buttons');
            if (categoryButtons && categoryButtons.parentElement !== panel) {
              panel.insertBefore(categoryButtons, panel.firstChild ? panel.firstChild.nextSibling : null);
            }
          } catch(_) {}
        };
      }

      // ensureMobilePanel: prepare the right panel structure and a dedicated list area
      if (typeof window.ensureMobilePanel !== 'function') {
        window.ensureMobilePanel = function ensureMobilePanel(){
          try {
            if (!document.body.classList.contains('mobile-mode')) return null;
            const panel = document.getElementById('mobile-right-panel');
            if (!panel) return null;
            try { panel.style.display = 'block'; } catch(_) {}
            // Ensure category section exists inside the panel
            let catSection = panel.querySelector('#category-buttons');
            if (!catSection) {
              catSection = document.createElement('div');
              catSection.id = 'category-buttons';
              catSection.style.marginBottom = '20px';
              const title = document.createElement('h3');
              title.style.cssText = 'margin-bottom: 10px; font-size: 16px; color: #555;';
              title.textContent = 'Kategorie:';
              const special = document.createElement('div');
              special.id = 'special-categories-container';
              special.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;';
              const buttons = document.createElement('div');
              buttons.id = 'category-buttons-container';
              buttons.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px;';
              catSection.appendChild(title);
              catSection.appendChild(special);
              catSection.appendChild(buttons);
              // Insert right after search container if present, otherwise at panel start
              const search = panel.querySelector('#search-container');
              if (search && search.nextSibling) panel.insertBefore(catSection, search.nextSibling);
              else panel.insertBefore(catSection, panel.firstChild);
            }
            // Ensure a dedicated list area exists (to avoid clearing the whole panel)
            let listArea = panel.querySelector('#mobile-list-area');
            if (!listArea) {
              listArea = document.createElement('div');
              listArea.id = 'mobile-list-area';
              listArea.style.marginTop = '8px';
              panel.appendChild(listArea);
            }
            // Make sure elements are moved into the panel
            try { window.moveElementsToMobilePanel(); } catch(_) {}
            return { panel, listArea };
          } catch(_) { return null; }
        };
      }
    })();

  function isMobileMode() { return document.body.classList.contains('mobile-mode'); }

    // Early mobile panel bootstrap: make the right panel visible on mobile UA
    // and show a lightweight placeholder while data loads.
    (function earlyMobilePanelBootstrap(){
      try {
        const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
                           (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        if (!isMobileUA) return;
        document.addEventListener('DOMContentLoaded', () => {
          try { document.body.classList.add('mobile-mode'); } catch(_) {}
          try {
            const ctx = (typeof window.ensureMobilePanel === 'function') ? window.ensureMobilePanel() : null;
            const panel = ctx ? ctx.panel : document.getElementById('mobile-right-panel');
            if (panel) panel.style.display = 'block';
            if (ctx && ctx.listArea && !ctx.listArea.childElementCount) {
              const ph = document.createElement('div');
              ph.textContent = 'Åadowanieâ€¦';
              ph.style.cssText = 'padding: 12px; color: #777;';
              ctx.listArea.appendChild(ph);
            }
          } catch(_) {}
        }, { once: true });
      } catch(_) {}
    })();

    // DISABLED: Config in mobile panel - prevent mobile UI interference
    function ensureConfigInMobilePanel() {
      console.log('ðŸ“± ensureConfigInMobilePanel called but DISABLED - using desktop config');
      return;
    }

    function moveConfigToSidebar() {
      const cs = document.getElementById('config-section');
      const sidebar = document.getElementById('sidebar');
      if (cs && sidebar && cs.parentElement !== sidebar) {
        sidebar.appendChild(cs);
        cs.style.display = 'none';
      }
    }

  // DISABLED: Mobile right panel list rendering - prevent mobile UI interference
  function renderMobileRightPanelList(selectedCategory = 'Wszystkie') {
    console.log('ðŸ“± renderMobileRightPanelList called but DISABLED - using desktop UI instead');
    return;
  }

    async function silentLoadModel(variant) {
      if (currentModelContainer) viewer.scene.remove(currentModelContainer);
      
      // âœ… OBSÅUGA WARIANTÃ“W W NAZWIE PLIKU - uÅ¼ywaj spacjami jak w nazwach plikÃ³w  
      let modelBaseName = variant.Nazwa;
      if (variant.Wariant && variant.Wariant.trim() !== '') {
        modelBaseName = `${variant.Nazwa} ${variant.Wariant.toLowerCase()}`;
        console.log(`ðŸ“‚ Silent load z wariantem: ${modelBaseName}`);
      }
      // ðŸ”’ Opcja A: dla kubeÅ‚ek NIE centrowaÄ‡ automatycznie (zachowaj eksportowane pozycje/originy)
      const _grupaSilent = (variant && variant.Grupa ? String(variant.Grupa).trim().toLowerCase() : '');
      const _isBucketSilent = _grupaSilent === 'kubeÅ‚ek' || _grupaSilent === 'kubelek';

      currentModelContainer = await loadModelWithFreshness(`chairs/${modelBaseName}.glb`, viewer, { autoCenter: !_isBucketSilent });

      console.log("Meshe w modelu:", currentModelContainer.children.map(obj => obj.name)); // <-- DODAJ TO TUTAJ
  // Keep selection in sync for AR helpers
  selectedChair = variant;
  try { window.selectedChair = variant; } catch(_) {}

    // ðŸŽ¯ Automatycznie ustaw domyÅ›lny materiaÅ‚ nÃ³g w selectedMaterials
    if (selectedChair && selectedChair.DefaultLegMaterial && allData) {
      const defaultLegMaterial = selectedChair.DefaultLegMaterial;
      console.log(`ðŸŽ¯ Looking for default leg material: "${defaultLegMaterial}" for chair: ${selectedChair.Nazwa}`);
      console.log(`ðŸŽ¯ All available groups:`, [...new Set(allData.map(d => d.Grupa))]);
      console.log(`ðŸŽ¯ Items with 'nogi' in group:`, allData.filter(d => d.Grupa && d.Grupa.toLowerCase().includes('nogi')));
      console.log(`ðŸŽ¯ Items with 'stelaÅ¼' in group:`, allData.filter(d => d.Grupa && d.Grupa.toLowerCase().includes('stelaÅ¼')));
      console.log(`ðŸŽ¯ Items with 'metal' in group:`, allData.filter(d => d.Grupa && d.Grupa.toLowerCase().includes('metal')));
      console.log(`ðŸŽ¯ Items with 'materiaÅ‚y_nÃ³g' in group:`, allData.filter(d => d.Grupa && d.Grupa.toLowerCase() === 'materiaÅ‚y_nÃ³g'));
      
      // SprawdÅº rÃ³Å¼ne moÅ¼liwe grupy
      const legMaterial = allData.find(mat => 
        mat.Grupa && (
          mat.Grupa.toLowerCase() === 'stelaÅ¼' ||
          mat.Grupa.toLowerCase() === 'nogi' ||
          mat.Grupa.toLowerCase() === 'metal' ||
          mat.Grupa.toLowerCase() === 'materiaÅ‚y_nÃ³g'
        ) && 
        mat.Nazwa === defaultLegMaterial
      );
      
      if (legMaterial) {
        selectedMaterials['legs_material'] = legMaterial;
        console.log(`ðŸŽ¯ âœ… Automatically set default leg material: ${legMaterial.Nazwa} for chair: ${selectedChair.Nazwa}`);
        console.log(`ðŸŽ¯ selectedMaterials now contains:`, Object.keys(selectedMaterials));
        updateSummary(); // OdÅ›wieÅ¼ podsumowanie od razu po ustawieniu materiaÅ‚u
      } else {
        console.log(`ðŸŽ¯ âŒ Default leg material "${defaultLegMaterial}" not found for chair: ${selectedChair.Nazwa}`);
        console.log(`ðŸŽ¯ Available stelaÅ¼ materials:`, allData.filter(d => d.Grupa && d.Grupa.toLowerCase() === 'stelaÅ¼').map(m => m.Nazwa));
        console.log(`ðŸŽ¯ Available nogi materials:`, allData.filter(d => d.Grupa && d.Grupa.toLowerCase() === 'nogi').map(m => m.Nazwa));
        console.log(`ðŸŽ¯ Available metal materials:`, allData.filter(d => d.Grupa && d.Grupa.toLowerCase() === 'metal').map(m => m.Nazwa));
        console.log(`ðŸŽ¯ Available materiaÅ‚y_nÃ³g materials:`, allData.filter(d => d.Grupa && d.Grupa.toLowerCase() === 'materiaÅ‚y_nÃ³g').map(m => m.Nazwa));
      }
    } else {
      console.log(`ðŸŽ¯ Cannot set default leg material - missing data:`, {
        hasChair: !!selectedChair,
        hasDefaultLegMaterial: !!(selectedChair && selectedChair.DefaultLegMaterial),
        hasAllData: !!allData
      });
    }      
      // WyÅ›rodkuj kamerÄ™ na modelu
      const box = new Box3().setFromObject(currentModelContainer);
      const center = box.getCenter(new Vector3());
      
      // Dla kubeÅ‚kÃ³w nie ustawiaj kamery jeszcze - zrobimy to po zaÅ‚adowaniu nÃ³g
      const _isKubelek = selectedChair && selectedChair.Grupa && selectedChair.Grupa.toLowerCase() === 'kubeÅ‚ek';
      if (!_isKubelek) {
        setCameraView(center);
      }
      
      // ðŸ”’ Nie przesuwaj kubeÅ‚ka do Å›rodka sceny â€“ zachowaj pozycje X/Z z eksportu
      if (!_isBucketSilent) {
        currentModelContainer.position.sub(center);
      }
      userInteracted = true;
      updateSummary();
      renderPartButtons();
    }

  // ðŸ§¹ Funkcja do czyszczenia nazw mesh z numerkÃ³w Blendera (.001, .006 itd.)
  function cleanMeshName(name) {
    if (!name || typeof name !== 'string') return name;
    return name.replace(/\.\d+$/, ''); // usuwa .001, .006, .123 itd. z koÅ„ca nazwy
  }

  // ðŸ§¹ Funkcja do normalizacji nazw mesh/obiektÃ³w w caÅ‚ym modelu
  function normalizeMeshNames(model, logPrefix = 'ðŸ§¹') {
    if (!model || !model.traverse) return;
    
    const renames = [];
    model.traverse(child => {
      if (child && typeof child.name === 'string' && child.name) {
        const originalName = child.name;
        const cleanedName = cleanMeshName(originalName);
        if (originalName !== cleanedName) {
          child.name = cleanedName;
          renames.push(`${originalName} â†’ ${cleanedName}`);
        }
      }
    });
    
    if (renames.length > 0) {
      console.log(`${logPrefix} MESH_CLEANUP: ${renames.join(', ')}`);
    } else {
      console.log(`${logPrefix} MESH_CLEANUP: brak zmian nazw mesh`);
    }
  }

  async function loadModel(variant) {
  console.log('ðŸ“± loadModel called with variant:', variant);
  
  // ðŸ”¥ MEGA DEBUG NA POCZÄ„TKU: sprawdÅº krzesÅ‚o
  console.log('ðŸ”¥ðŸ”¥ðŸ”¥ LOADMODEL START - CHAIR DEBUG:', {
    nazwa: variant?.Nazwa,
    grupa: variant?.Grupa,
    kategoria: variant?.Kategoria,
    wariant: variant?.Wariant,
    isKubelek: variant?.Grupa && variant.Grupa.toLowerCase() === 'kubeÅ‚ek'
  });
  
  // Ukryj welcome screen przy wyborze krzesÅ‚a
  const welcomeScreen = document.getElementById('welcome-screen');
  if (welcomeScreen) {
    console.log('ðŸ“± Hiding welcome screen');
    welcomeScreen.style.display = 'none';
  }
  
  if (currentModelContainer) {
    viewer.scene.remove(currentModelContainer);
    if (typeof currentModelContainer.dispose === 'function') currentModelContainer.dispose();
  }
  if (currentLegModel) {
    viewer.scene.remove(currentLegModel);
    if (typeof currentLegModel.dispose === 'function') currentLegModel.dispose();
  }
  currentModelContainer = null;
  currentLegModel = null;
  selectedLeg = null;
  selectedMaterials = {};

  document.getElementById('model-loader').style.display = 'flex';

  try {
    // Update both local and global references so other modules (AR helpers) see the latest chair
    selectedChair = variant;
    try { window.selectedChair = variant; } catch(_) {}
    
    // ðŸ” DEBUG: SprawdÅº czy wariant jest prawidÅ‚owo ustawiony
    console.log(`ðŸ” CHAIR_LOAD: selectedChair.Nazwa='${selectedChair?.Nazwa}' selectedChair.Wariant='${selectedChair?.Wariant}'`);

    // ðŸŽ¯ Automatycznie ustaw domyÅ›lny materiaÅ‚ nÃ³g w selectedMaterials
    if (selectedChair && selectedChair.DefaultLegMaterial && allData) {
      const defaultLegMaterial = selectedChair.DefaultLegMaterial;
      console.log(`ðŸŽ¯ Looking for default leg material: "${defaultLegMaterial}" for chair: ${selectedChair.Nazwa}`);
      console.log(`ðŸŽ¯ All available groups:`, [...new Set(allData.map(d => d.Grupa))]);
      console.log(`ðŸŽ¯ Items with 'nogi' in group:`, allData.filter(d => d.Grupa && d.Grupa.toLowerCase().includes('nogi')));
      console.log(`ðŸŽ¯ Items with 'stelaÅ¼' in group:`, allData.filter(d => d.Grupa && d.Grupa.toLowerCase().includes('stelaÅ¼')));
      console.log(`ðŸŽ¯ Items with 'metal' in group:`, allData.filter(d => d.Grupa && d.Grupa.toLowerCase().includes('metal')));
      console.log(`ðŸŽ¯ Items with 'materiaÅ‚y_nÃ³g' in group:`, allData.filter(d => d.Grupa && d.Grupa.toLowerCase() === 'materiaÅ‚y_nÃ³g'));
      
      // SprawdÅº rÃ³Å¼ne moÅ¼liwe grupy
      const legMaterial = allData.find(mat => 
        mat.Grupa && (
          mat.Grupa.toLowerCase() === 'stelaÅ¼' ||
          mat.Grupa.toLowerCase() === 'nogi' ||
          mat.Grupa.toLowerCase() === 'metal' ||
          mat.Grupa.toLowerCase() === 'materiaÅ‚y_nÃ³g'
        ) && 
        mat.Nazwa === defaultLegMaterial
      );
      
      if (legMaterial) {
        selectedMaterials['legs_material'] = legMaterial;
        console.log(`ðŸŽ¯ âœ… Automatically set default leg material: ${legMaterial.Nazwa} for chair: ${selectedChair.Nazwa}`);
        console.log(`ðŸŽ¯ selectedMaterials now contains:`, Object.keys(selectedMaterials));
        updateSummary(); // OdÅ›wieÅ¼ podsumowanie od razu po ustawieniu materiaÅ‚u
      } else {
        console.log(`ðŸŽ¯ âŒ Default leg material "${defaultLegMaterial}" not found for chair: ${selectedChair.Nazwa}`);
        console.log(`ðŸŽ¯ Available stelaÅ¼ materials:`, allData.filter(d => d.Grupa && d.Grupa.toLowerCase() === 'stelaÅ¼').map(m => m.Nazwa));
        console.log(`ðŸŽ¯ Available nogi materials:`, allData.filter(d => d.Grupa && d.Grupa.toLowerCase() === 'nogi').map(m => m.Nazwa));
        console.log(`ðŸŽ¯ Available metal materials:`, allData.filter(d => d.Grupa && d.Grupa.toLowerCase() === 'metal').map(m => m.Nazwa));
        console.log(`ðŸŽ¯ Available materiaÅ‚y_nÃ³g materials:`, allData.filter(d => d.Grupa && d.Grupa.toLowerCase() === 'materiaÅ‚y_nÃ³g').map(m => m.Nazwa));
      }
    } else {
      console.log(`ðŸŽ¯ Cannot set default leg material - missing data:`, {
        hasChair: !!selectedChair,
        hasDefaultLegMaterial: !!(selectedChair && selectedChair.DefaultLegMaterial),
        hasAllData: !!allData
      });
    }

    // Przygotuj listÄ™ moÅ¼liwych Å›cieÅ¼ek do modelu (mobilne i desktop)
    function candidateModelPaths(name) {
      const base = stripBrackets(name || '').trim();
      const variants = Array.from(new Set([
        base,
        base.replace(/\s+/g, ''),
        base.replace(/\s+/g, '-'),
        base.replace(/\s+/g, '_')
      ].filter(Boolean)));
      const dirs = ['chairs', 'models'];
      const paths = [];
      dirs.forEach(dir => variants.forEach(v => paths.push(`${dir}/${v}.glb`)));
      return paths;
    }

    // ðŸ”’ Opcja A: flaguj kubeÅ‚ek aby pominÄ…Ä‡ auto-centrowanie i pÃ³Åºniejsze przesuwanie do Å›rodka
    const __grupa = (selectedChair && selectedChair.Grupa ? selectedChair.Grupa.toLowerCase() : '');
    const __isBucket = __grupa === 'kubeÅ‚ek' || __grupa === 'kubelek';

    async function tryLoadAny(paths) {
      let lastError = null;
      for (const p of paths) {
        try {
          return await loadModelWithFreshness(p, viewer, { autoCenter: !__isBucket });
        } catch (e) {
          console.warn(`Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ modelu z: ${p}`, e);
          lastError = e;
        }
      }
      if (lastError) throw lastError;
      throw new Error('Brak dostÄ™pnych Å›cieÅ¼ek do modelu');
    }

    // âœ… OBSÅUGA WARIANTÃ“W W NAZWIE PLIKU - uÅ¼ywaj spacjami jak w nazwach plikÃ³w
    let modelBaseName = variant.Nazwa;
    if (variant.Wariant && variant.Wariant.trim() !== '') {
      modelBaseName = `${variant.Nazwa} ${variant.Wariant.toLowerCase()}`;
      console.log(`ðŸ“‚ Model z wariantem: ${modelBaseName} (original: ${variant.Nazwa}, variant: ${variant.Wariant})`);
    }
    
    // ZaÅ‚aduj kubeÅ‚ek z pierwszej dostÄ™pnej Å›cieÅ¼ki (chairs/ lub models/)
    const paths = candidateModelPaths(modelBaseName);
    currentModelContainer = await tryLoadAny(paths);

    // ðŸ§¹ Normalizuj nazwy mesh (usuÅ„ .001, .006 itd.)
    normalizeMeshNames(currentModelContainer, 'ðŸ§¹ CHAIR');

    // ðŸ” DEBUGOWANIE - pokaÅ¼ wszystkie meshe w zaÅ‚adowanym modelu
    console.log("ðŸ” Meshe w zaÅ‚adowanym modelu:", currentModelContainer.children.map(obj => obj.name));
    console.log("ðŸ” Wszystkie obiekty w modelu:");
    currentModelContainer.traverse(obj => {
      if (obj.isMesh && obj.name) {
        console.log(`  - Mesh: "${obj.name}" (type: ${obj.type})`);
      }
    });

    // Po zaÅ‚adowaniu ustaw kamerÄ™ na Å›rodek modelu, aby byÅ‚ widoczny
    try {
      const box = new Box3().setFromObject(currentModelContainer);
      const center = box.getCenter(new Vector3());
      setCameraView(center);
      // ðŸ”’ Nie przesuwaj kubeÅ‚ka do Å›rodka sceny â€“ zachowaj pozycje X/Z z eksportu
      if (!__isBucket) {
        currentModelContainer.position.sub(center);
      }
      if (viewer && viewer.render) viewer.render();
    } catch(e) { console.warn('Nie udaÅ‚o siÄ™ ustawiÄ‡ kamery po zaÅ‚adowaniu modelu', e); }

    // ðŸ”¥ MEGA DEBUG: sprawdÅº krzesÅ‚o Amy-2
    console.log('ðŸ”¥ðŸ”¥ðŸ”¥ SELECTED CHAIR DEBUG:', {
      nazwa: selectedChair.Nazwa,
      grupa: selectedChair.Grupa,
      kategoria: selectedChair.Kategoria,
      wariant: selectedChair.Wariant,
      isKubelek: selectedChair.Grupa && selectedChair.Grupa.toLowerCase() === 'kubeÅ‚ek'
    });

    // JeÅ›li kubeÅ‚ek, to ewentualnie zaÅ‚aduj domyÅ›lne nogi (bez wyrÃ³wnywania Y kubeÅ‚ka do podÅ‚oÅ¼a)
    if (selectedChair.Grupa && selectedChair.Grupa.toLowerCase() === 'kubeÅ‚ek') {
      // Filtrowanie nÃ³g po kategorii juÅ¼ na starcie
      const chairKategoria = (selectedChair.Kategoria || '').toLowerCase();
      let legsVariants = allData.filter(d => d.Grupa && d.Grupa.toLowerCase() === 'nogi');
      console.log('ðŸ§¾ RAW NOGI (przed kategoriÄ…):', legsVariants.map(l=>`${l.Nazwa}|W=${l.Wariant||'-'}|DlaKubeÅ‚ka=${l.DlaKubeÅ‚ka||l.DlaKubelka||'-'}`));
      
      // ðŸ”¥ MEGA DEBUG: sprawdÅº czy sÄ… nogi "z obrotem" w raw data
      const zObrotemLegs = legsVariants.filter(leg => leg.Nazwa && leg.Nazwa.includes('z obrotem'));
      console.log('ðŸ”¥ðŸ”¥ðŸ”¥ Z OBROTEM W RAW DATA:', zObrotemLegs.length, zObrotemLegs.map(l => `${l.Nazwa}|W=${l.Wariant||'-'}|DlaKubeÅ‚ka=${l.DlaKubeÅ‚ka||l.DlaKubelka||'-'}`));
      
      if (chairKategoria.includes('hooker')) {
        // Dla kubeÅ‚kÃ³w hooker pokazuj TYLKO nogi hooker
        legsVariants = legsVariants.filter(noga => {
          const nogaKategoria = (noga.Kategoria || noga.Typ || noga.Grupa || '').toLowerCase();
          return nogaKategoria.includes('hooker');
        });
      } else if (chairKategoria.includes('krzes')) {
        // Dla kubeÅ‚kÃ³w krzesÅ‚a pokazuj nogi krzesÅ‚a (ale nie hooker)
        legsVariants = legsVariants.filter(noga => {
          const nogaKategoria = (noga.Kategoria || noga.Typ || noga.Grupa || '').toLowerCase();
          if (nogaKategoria.includes('hooker')) return false;
          return nogaKategoria.includes('krzes') || nogaKategoria === '' || nogaKategoria === 'nogi';
        });
      }

      console.log(`ðŸ”¥ PRZED FILTROWANIEM: chair="${selectedChair.Nazwa}" variant="${selectedChair.Wariant}" availableLegs=${legsVariants.length}`);
      // ðŸ”¥ DEBUG: pokaÅ¼ wszystkie dostÄ™pne nogi przed filtrowaniem
      legsVariants.forEach((leg, i) => {
        if (leg.Nazwa && leg.Nazwa.includes('z obrotem')) {
          console.log(`ðŸ”¥ FOUND Z OBROTEM BEFORE FILTER [${i}]: "${leg.Nazwa}" variant="${leg.Wariant}" DlaKubelka="${leg.DlaKubeÅ‚ka || leg.DlaKubelka}"`);
        }
      });
      
      let legsResult = getFilteredLegsForChair(selectedChair, legsVariants);
      console.log(`ðŸ§® LEGS DEBUG (STRICT) -> start=${legsResult.debug.start} kubeÅ‚ekOK=${legsResult.debug.kubelek} variantOK=${legsResult.debug.variant} krzesÅ‚oOK=${legsResult.debug.krzeslo} final=${legsResult.list.length}`);
      if (!legsResult.list.length) {
        console.warn(`âš ï¸ Brak nÃ³g (STRICT) dla kubeÅ‚ka "${selectedChair.Nazwa}" (wariant: ${selectedChair.Wariant||'-'}). PrÃ³ba fallback bez wariantu.`);
        // Fallback 1: ignoruj wariant (szukaj samych dopasowaÅ„ kubeÅ‚ka)
        const chairCopy = { ...selectedChair, Wariant: '' };
        const fbNoVariant = getFilteredLegsForChair(chairCopy, legsVariants);
        console.log(`ðŸ§ª Fallback1 (no variant) final=${fbNoVariant.list.length}`);
        if (fbNoVariant.list.length) {
          legsResult = fbNoVariant;
        } else {
          // Fallback 2: pokaÅ¼ wszystkie nogi typu 'nogi' (ostatnia deska ratunku do debug)
          console.warn('ðŸ†˜ Fallback2: pokazujÄ™ wszystkie nogi (tylko do debug)');
          legsResult = { list: legsVariants.slice(0,5), debug: { note:'fallback2' } }; // max 5 Å¼eby nie Å‚adowaÄ‡ wszystkiego
        }
      }
      
      // ðŸ”¥ DEBUG: pokaÅ¼ co zostaÅ‚o po filtracji
      console.log(`ðŸ”¥ PO FILTRACJI: ${legsResult.list.length} nÃ³g pozostaÅ‚o`);
      legsResult.list.forEach((leg, i) => {
        console.log(`ðŸ”¥ POZOSTAÅA NÃ“G [${i}]: "${leg.Nazwa}" variant="${leg.Wariant}"`);
      });

      if (legsResult.list.length) {
        const firstLeg = legsResult.list[0];
        console.log(`ðŸ¦µ AUTO WYBÃ“R NÃ“G (FINAL): ${firstLeg.Nazwa} [${firstLeg.Wariant||'-'}]`);
        await setLegModel(firstLeg);
      } else {
        console.error('âŒ TOTAL FAILURE: brak nÃ³g po wszystkich fallbackach');
        try {
          let dbg=document.getElementById('legs-debug-overlay');
          if(!dbg){dbg=document.createElement('div');dbg.id='legs-debug-overlay';dbg.style.cssText='position:fixed;bottom:0;left:0;max-width:420px;max-height:40vh;overflow:auto;font:12px monospace;background:#000c;color:#fff;padding:8px;z-index:99999;border:1px solid #f00;';document.body.appendChild(dbg);} 
          dbg.innerText = 'Brak nÃ³g dla '+selectedChair.Nazwa+'\nWariant: '+(selectedChair.Wariant||'-')+'\nÅ¹rÃ³dÅ‚o kandydatÃ³w: '+legsVariants.length;
        }catch(e){console.warn('Overlay fail',e)}
      }
    } else {
      document.getElementById('legs-section').style.display = 'none';
      if (currentLegModel) {
        viewer.scene.remove(currentLegModel);
        currentLegModel = null;
        selectedLeg = null;
      }
    }

    // ðŸŽ¥ Dla kubeÅ‚kÃ³w: ustaw kamerÄ™ na kubeÅ‚ek (nie na caÅ‚y zestaw) po zaÅ‚adowaniu wszystkiego
    if (selectedChair && selectedChair.Grupa && selectedChair.Grupa.toLowerCase() === 'kubeÅ‚ek') {
      try {
        // UÅ¼yj centrum kubeÅ‚ka jako punktu odniesienia (nie caÅ‚ego zestawu)
        const bucketBounds = new Box3();
        if (currentModelContainer) bucketBounds.setFromObject(currentModelContainer);
        
        const bucketCenter = bucketBounds.getCenter(new Vector3());
        console.log(`ðŸŽ¥ silentLoadModel: Ustawiam kamerÄ™ na kubeÅ‚ek (origin), center:`, bucketCenter.toArray());
        setCameraView(bucketCenter);
        // Uruchom delikatny idle sway na domyÅ›lnej kamerze, bez zmiany widoku
        setTimeout(() => { try { startIdleSway(); } catch(_) {} }, 50);
        // Safety: jeÅ›li watchdog nie istnieje (np. lokalnie), nie przerywaj wykonywania
        if (typeof window.scheduleIdleSwayWatchdog !== 'function') {
          window.scheduleIdleSwayWatchdog = function(){ /* noop */ };
        }
        scheduleIdleSwayWatchdog('silentLoadModel+camera');
      } catch(e) {
        console.warn('Nie udaÅ‚o siÄ™ ustawiÄ‡ kamery po zaÅ‚adowaniu kubeÅ‚ka+nÃ³g', e);
      }
    }

    // âœ… Dopiero teraz chowamy loader - po zaÅ‚adowaniu nÃ³g
    // âœ… Eleganckie ukrycie z fade-out
    document.getElementById('model-loader').classList.add('fade-out');
    setTimeout(() => {
      document.getElementById('model-loader').style.display = 'none';
      document.getElementById('model-loader').classList.remove('fade-out');
    }, 500);


    // PokaÅ¼ dolny pasek narzÄ™dzi
    const toolbar = document.getElementById('bottom-toolbar');
    toolbar.classList.add('visible');
    toolbar.style.display = 'flex';
  // PokaÅ¼ przycisk QR (panel dopiero teraz jest widoczny)
  const qrBtnAfterLoad = document.getElementById('qr-button');
  if (qrBtnAfterLoad) qrBtnAfterLoad.style.display = 'flex';
  // UsuÅ„ klasÄ™ blokujÄ…cÄ… miganie toolbara
  try { document.body.classList.remove('awaiting-selection'); } catch(_) {}

    // PokaÅ¼ przycisk konfiguracji (nowy system)
    const configButton = document.getElementById('config-overview-button');
    if (configButton) {
      configButton.style.display = 'flex';
    }

    userInteracted = true;
    renderPartButtons();
    updateSummary();
    hideDimensions();

    // PokaÅ¼ sekcjÄ™ materiaÅ‚Ã³w nÃ³g
    document.getElementById('materials-section').style.display = 'block';

    // Wyrenderuj kafelki materiaÅ‚Ã³w nÃ³g
    const legsMaterials = allData.filter(d => d.Grupa && d.Grupa.toLowerCase() === 'nogi');
    renderOptions('materials-thumbnails', legsMaterials, (item) => {
      setLegMaterial(item);
    });

    setCameraView(globalCameraTargetPosition);
    enforceZoomLimits();
    updateUI();
    // Always show config screen after loading model
    console.log('ðŸ“± MOBILE: Showing config screen after model load');
    showScreen('config');

    // Ensure proper mobile layout
    const isMobileWidth = window.innerWidth <= 820;
    if (isMobileWidth) {
      console.log('ðŸ“± MOBILE: Adjusting layout for mobile');

      // Hide desktop sidebar completely on mobile
      const sidebar = document.getElementById('sidebar');
      if (sidebar) {
        sidebar.style.display = 'none !important';
        sidebar.style.visibility = 'hidden !important';
        sidebar.style.opacity = '0 !important';
        console.log('ðŸ“± MOBILE: Desktop sidebar hidden on mobile');
      }

      // Show mobile panel properly
      const mobilePanel = document.getElementById('mobile-right-panel');
      if (mobilePanel) {
        mobilePanel.style.display = 'block !important';
        mobilePanel.style.visibility = 'visible !important';
        mobilePanel.style.opacity = '1 !important';
        mobilePanel.style.position = 'fixed !important';
        mobilePanel.style.top = '0 !important';
        mobilePanel.style.right = '0 !important';
        mobilePanel.style.width = '280px !important';
        mobilePanel.style.height = '100vh !important';
        mobilePanel.style.zIndex = '150 !important';
        mobilePanel.style.overflowY = 'auto !important';
        mobilePanel.style.padding = '12px !important';
        mobilePanel.style.background = '#fff !important';
        mobilePanel.style.borderLeft = '1px solid rgba(0,0,0,0.08) !important';
        mobilePanel.style.boxShadow = '-6px 0 24px rgba(0,0,0,0.06) !important';
        console.log('ðŸ“± MOBILE: Mobile panel shown on mobile');
      }

      // Adjust canvas for mobile with mobile panel
      const canvasContainer = document.getElementById('canvas-container');
      if (canvasContainer) {
        canvasContainer.style.width = 'calc(100% - 280px) !important';
        canvasContainer.style.height = '100vh !important';
        canvasContainer.style.display = 'block !important';
        canvasContainer.style.position = 'relative !important';
        canvasContainer.style.left = '0 !important';
        canvasContainer.style.right = '280px !important';
        console.log('ðŸ“± MOBILE: Canvas container adjusted for mobile');
      }

      // Ensure canvas is properly sized
      const canvas = document.getElementById('canvas');
      if (canvas) {
        canvas.style.width = '100% !important';
        canvas.style.height = '100% !important';
        canvas.style.display = 'block !important';
        console.log('ðŸ“± MOBILE: Canvas sized for mobile');
      }

      // Force show config section immediately after model load
      setTimeout(() => {
        console.log('ðŸ“± MOBILE: Forcing config section visibility');
        const configSection = document.getElementById('config-section');
        if (configSection) {
          configSection.style.display = 'block !important';
          configSection.style.visibility = 'visible !important';
          configSection.style.position = 'relative !important';
          configSection.style.height = 'auto !important';
          configSection.style.overflow = 'visible !important';
          configSection.style.paddingBottom = '100px !important';
          console.log('ðŸ“± MOBILE: Config section forced visible');
        }

        // Force render part buttons
        if (typeof renderPartButtons === 'function') {
          console.log('ðŸ“± MOBILE: Rendering part buttons');
          renderPartButtons();
        }

        // Force show part tabs
        setTimeout(() => {
          const partTabs = document.getElementById('part-tabs');
          if (partTabs) {
            partTabs.style.display = 'flex !important';
            partTabs.style.visibility = 'visible !important';
            partTabs.style.opacity = '1 !important';
            partTabs.style.flexDirection = 'row !important';
            partTabs.style.gap = '12px !important';
            partTabs.style.padding = '16px !important';
            partTabs.style.background = '#fff !important';
            partTabs.style.borderRadius = '12px !important';
            partTabs.style.marginBottom = '20px !important';
            console.log('ðŸ“± MOBILE: Part tabs forced visible and styled');
          }

          // Auto-click first part tab
          const firstTab = document.querySelector('#part-tabs .simple-part-btn');
          if (firstTab) {
            console.log('ðŸ“± MOBILE: Auto-clicking first part tab');
            firstTab.click();
          }
        }, 100);
      }, 50);
    }

  } catch (e) {
    console.error(`BÅÄ„D Å‚adowania modelu: ${e.message}`, e);
    // Ukryj loader nawet przy bÅ‚Ä™dzie
    document.getElementById('model-loader').style.display = 'none';
  }
}









    function createLegMaterial(legData) {
      const metalness = isNaN(parseFloat(legData.metalness)) ? 1 : parseFloat(legData.metalness);
      const roughness = isNaN(parseFloat(legData.roughness)) ? 0.1 : parseFloat(legData.roughness);
      const color = legData.color || '#FFFFFF';

      return new MeshStandardMaterial({
        color: new Color(color),
        metalness: metalness,
        roughness: roughness,
      });
    }
    
    function czyNogaPasujeDoKubeÅ‚ka(nogaVariant, kubelekNazwa) {
  // KROK 1: SprawdÅº tradycyjnÄ… relacjÄ™: noga -> kubeÅ‚ek (pole DlaKubeÅ‚ka w nodze)
  const zgodneKubeÅ‚ki = (nogaVariant.DlaKubeÅ‚ka || nogaVariant.DlaKubelka || '')
    .toLowerCase()
    .split(',')
    .map(k => stripBrackets(k.trim()).toLowerCase());
  
  // âœ… NOWE: SprawdÅº zarÃ³wno peÅ‚nÄ… nazwÄ™ jak i podstawowÄ… (bez wariantu)
  let kubelekNorm = stripBrackets(kubelekNazwa || '').toLowerCase();
  let kubelekBase = kubelekNorm.replace(/\s+(drewno|metal|tkanina|skÃ³ra|eco|leather|buk|dÄ…b)$/, '').trim();
  
  console.log(`ðŸ” czyNogaPasujeDoKubeÅ‚ka("${nogaVariant.Nazwa}", "${kubelekNazwa}"):`, {
    DlaKubeÅ‚ka: nogaVariant.DlaKubeÅ‚ka,
    zgodneKubeÅ‚ki,
    kubelekNorm,
    kubelekBase,
    matchesFull: zgodneKubeÅ‚ki.includes(kubelekNorm),
    matchesBase: zgodneKubeÅ‚ki.includes(kubelekBase)
  });
  
  // SprawdÅº czy pasuje peÅ‚na nazwa lub podstawowa
  if (!zgodneKubeÅ‚ki.includes(kubelekNorm) && !zgodneKubeÅ‚ki.includes(kubelekBase)) {
    return false;
  }
  
  // KROK 2: âœ… NOWY - SprawdÅº odwrotnÄ… relacjÄ™: czy w polu DlaKrzesÅ‚a kubeÅ‚ek jest zaznaczony
  if (nogaVariant.DlaKrzesÅ‚a && nogaVariant.DlaKrzesÅ‚a.trim() !== '') {
    const dozwoloneKrzesÅ‚a = nogaVariant.DlaKrzesÅ‚a
      .toLowerCase()
      .split(',')
      .map(k => stripBrackets(k.trim()).toLowerCase());
    
    console.log(`ðŸª‘ Sprawdzam DlaKrzesÅ‚a dla "${nogaVariant.Nazwa}" <-> "${kubelekNazwa}":`, {
      DlaKrzesÅ‚a: nogaVariant.DlaKrzesÅ‚a,
      dozwoloneKrzesÅ‚a,
      kubelekNorm,
      kubelekBase,
      matchesFull: dozwoloneKrzesÅ‚a.includes(kubelekNorm),
      matchesBase: dozwoloneKrzesÅ‚a.includes(kubelekBase)
    });
    
    return dozwoloneKrzesÅ‚a.includes(kubelekNorm) || dozwoloneKrzesÅ‚a.includes(kubelekBase);
  }
  
  // JeÅ›li brak pola DlaKrzesÅ‚a - uÅ¼yj starÄ… logikÄ™ (domyÅ›lnie pozwÃ³l)
  return true;
}

// âœ… NOWA FUNKCJA: SprawdÅº czy noga pasuje do krzesÅ‚a (pole DlaKubeÅ‚ka w nodze)
function czyNogaPasujeDoKrzesÅ‚a(nogaVariant, krzesÅ‚oNazwa) {
  // JeÅ›li brak pola DlaKubeÅ‚ka - pozwÃ³l (zachowanie domyÅ›lne)
  if (!nogaVariant.DlaKubeÅ‚ka && !nogaVariant.DlaKubelka) {
    return true;
  }
  
  // âœ… NOWE: SprawdÅº zarÃ³wno peÅ‚nÄ… nazwÄ™ jak i podstawowÄ… (bez wariantu)
  let krzesÅ‚oNorm = stripBrackets(krzesÅ‚oNazwa || '').toLowerCase();
  let krzesÅ‚oBase = krzesÅ‚oNorm.replace(/\s+(drewno|metal|tkanina|skÃ³ra|eco|leather|buk|dÄ…b)$/, '').trim();
  
  // SprawdÅº czy krzesÅ‚o jest na liÅ›cie dozwolonych
  const dozwoloneKrzesÅ‚a = (nogaVariant.DlaKubeÅ‚ka || nogaVariant.DlaKubelka || '')
    .toLowerCase()
    .split(',')
    .map(k => stripBrackets(k.trim()).toLowerCase());
  
  console.log(`ðŸ¦µ Sprawdzam noga "${nogaVariant.Nazwa}" dla krzesÅ‚a "${krzesÅ‚oNazwa}":`, {
    DlaKubeÅ‚ka: nogaVariant.DlaKubeÅ‚ka || nogaVariant.DlaKubelka,
    dozwoloneKrzesÅ‚a,
    krzesÅ‚oNorm,
    krzesÅ‚oBase,
    matchesFull: dozwoloneKrzesÅ‚a.includes(krzesÅ‚oNorm),
    matchesBase: dozwoloneKrzesÅ‚a.includes(krzesÅ‚oBase)
  });
  
  return dozwoloneKrzesÅ‚a.includes(krzesÅ‚oNorm) || dozwoloneKrzesÅ‚a.includes(krzesÅ‚oBase);
}

// âœ… NOWA FUNKCJA: SprawdÅº czy wariant nÃ³g pasuje do wariantu kubeÅ‚ka
function czyWariantNogPasujeDoKubeÅ‚ka(nogaVariant, krzesÅ‚o) {
  const kubelekVar = (krzesÅ‚o.Wariant || '').trim();
  const nogaVar = (nogaVariant.Wariant || '').trim();
  // KubeÅ‚ek BEZ wariantu -> akceptuj wszystkie (nie zawÄ™Å¼amy)
  if (!kubelekVar) return true;
  // KubeÅ‚ek MA wariant -> noga musi mieÄ‡ identyczny (case-insensitive)
  if (!nogaVar) return false; // noga bez wariantu odpada kiedy kubeÅ‚ek ma
  return kubelekVar.toLowerCase() === nogaVar.toLowerCase();
}

// ðŸ”§ Kompleksowe filtrowanie nÃ³g (kubeÅ‚ek + wariant + odwrotne powiÄ…zanie) z raportem
function getFilteredLegsForChair(chair, source){
  const debug = { start: source.length, kubelek:0, variant:0, krzeslo:0 };
  const full = (chair.Nazwa||'').toLowerCase();
  const chairVar = (chair.Wariant||'').trim().toLowerCase();
  const base = (chairVar && full.endsWith(' '+chairVar)) ? full.slice(0, full.lastIndexOf(' '+chairVar)) : full;
  const acceptableNames = new Set([full, base]);
  if (chairVar) acceptableNames.add(base + ' ' + chairVar); // peÅ‚na forma z wariantem

  // ðŸ”¥ DEBUG: pokaÅ¼ co siÄ™ dzieje z filtrowanem dla Amy-2
  console.log(`ðŸ”¥ FILTER DEBUG: chair="${chair.Nazwa}" var="${chairVar}" acceptableNames=[${[...acceptableNames].join('|')}]`);

  function toList(v){ return (v||'').toLowerCase().split(',').map(s=>s.trim()).filter(Boolean); }

  const afterBucket = [];
  for(const leg of source){
    const list = toList(leg.DlaKubeÅ‚ka || leg.DlaKubelka);
    const bucketMatch = !list.length || [...acceptableNames].some(n=>list.includes(n));
    
    // ðŸ”¥ DEBUG: szczegÃ³lnie "z obrotem"
    if (leg.Nazwa && leg.Nazwa.includes('z obrotem')) {
      console.log(`ðŸ”¥ Z OBROTEM CHECK: name="${leg.Nazwa}" var="${leg.Wariant}" DlaKubelka="${leg.DlaKubeÅ‚ka || leg.DlaKubelka}" bucketMatch=${bucketMatch}`);
    }
    
    if (bucketMatch){ afterBucket.push(leg); debug.kubelek++; }
    else console.log(`âœ‚ï¸ LEG bucket mismatch: ${leg.Nazwa} needOneOf=[${[...acceptableNames].join('|')}] has=[${list.join('|')}]`);
  }

  const afterVariant = [];
  for(const leg of afterBucket){
    const legVar = (leg.Wariant||'').trim().toLowerCase();
    const varMatch = !chairVar || (legVar && legVar === chairVar);
    
    // ðŸ”¥ DEBUG: szczegÃ³lnie "z obrotem"
    if (leg.Nazwa && leg.Nazwa.includes('z obrotem')) {
      console.log(`ðŸ”¥ Z OBROTEM VARIANT CHECK: legVar="${legVar}" chairVar="${chairVar}" match=${varMatch}`);
    }
    
    if (varMatch) { afterVariant.push(leg); debug.variant++; }
    else console.log(`âœ‚ï¸ LEG variant mismatch: ${leg.Nazwa} legVar='${legVar}' chairVar='${chairVar}'`);
  }

  const final = [];
  for(const leg of afterVariant){
    if (czyNogaPasujeDoKrzesÅ‚a(leg, chair.Nazwa)) { final.push(leg); debug.krzeslo++; }
    else console.log(`âœ‚ï¸ LEG chair backref mismatch: ${leg.Nazwa}`);
  }

  return { list: final, debug };
}

// ðŸ”¦ Diagnoza czarnego modelu â€“ logujemy podstawowe info o scenie po 2s
setTimeout(()=>{
  try{
    if(!viewer||!viewer.scene)return;
    const lights=[];viewer.scene.traverse(o=>{if(/light/i.test(o.type)) lights.push(o.type);});
    console.log('ðŸ’¡ SCENE LIGHTS:', lights);
    console.log('ðŸ§ª ENV MAP:', viewer.scene.environment ? 'YES' : 'NO');
  }catch(e){console.warn('Light debug fail',e)}
},2000);


    async function setLegModel(variant) {
  try {
    userInteracted = true;
    console.log("ðŸ¦µ setLegModel wywoÅ‚ane dla wariantu:", variant);
    console.log("ðŸ”¥ PIERWSZY LOG W setLegModel - funkcja zostaÅ‚a wywoÅ‚ana!", variant?.Nazwa || 'BRAK_NAZWY');

    // âœ… Sprawdzenie zgodnoÅ›ci kubeÅ‚ka z wariantem nÃ³g (uwzglÄ™dnia wariant kubeÅ‚ka i wariant nÃ³g)
    if (selectedChair && selectedChair.Grupa.toLowerCase() === 'kubeÅ‚ek') {
    const nazwaKubeÅ‚ka = (selectedChair.Nazwa || '').toLowerCase();
  const wariantKubeÅ‚ka = (selectedChair.Wariant || '').toLowerCase(); // drewno / metal
  const fullBucket = nazwaKubeÅ‚ka; // NIE doklejamy wariantu do nazwy kubeÅ‚ka

    const rawAllowed = (variant.DlaKubeÅ‚ka || variant.DlaKubelka || '')
      .toLowerCase()
      .split(',')
      .map(k => k.trim())
      .filter(Boolean);
    console.log(`ðŸ¦µ LEG_LOAD DIRECT: '${variant.Nazwa}' W='${variant.Wariant||'-'}' dla kubeÅ‚ka='${fullBucket}' W='${wariantKubeÅ‚ka}' (szczegÃ³Å‚owa kompatybilnoÅ›Ä‡ sprawdzona wczeÅ›niej)`);
  }

  // PokaÅ¼ loader podczas Å‚adowania nÃ³g
  showModelLoader('Åadowanie nÃ³g...');

      console.log("ðŸ¦µ Rozpoczynam Å‚adowanie modelu nÃ³g dla:", variant.Nazwa);
      const oldLegs = currentLegModel;
      try {
        // ðŸ”§ Nazwy plikÃ³w nÃ³g BEZ podkreÅ›lnikÃ³w - wszystkie ze spacjami
        let legFileName = stripBrackets(variant.Nazwa);
        
        // âœ… Dodaj wariant do nazwy pliku ze SPACJÄ„ (nie podkreÅ›lnikiem) 
        if (variant.Wariant && variant.Wariant.trim() !== '') {
          const variantLower = variant.Wariant.toLowerCase();
          legFileName = `${legFileName} ${variantLower}`; // np. "z obrotem drewno", "slim metal"
          console.log(`ðŸ¦µ Model nÃ³g z wariantem: ${legFileName} (base: ${variant.Nazwa}, variant: ${variant.Wariant})`);
        }
        
        const modelPath = `legs/${legFileName}.glb`;
        console.log(`ðŸ¦µ ÅadujÄ™ model nÃ³g z Å›cieÅ¼ki: ${modelPath}`);
        console.log(`ðŸ§ª DEBUG: legFileName='${legFileName}', variant.Nazwa='${variant.Nazwa}', variant.Wariant='${variant.Wariant||'BRAK'}'`);
        
        // ðŸ”¥ SPRAWDZENIE: czy to nogi "z obrotem"?
        if (legFileName.includes('z obrotem')) {
          console.log(`ðŸ”¥ðŸ”¥ðŸ”¥ LOADING Z OBROTEM LEGS: ${modelPath}`);
          console.log(`ðŸ”¥ Variant object:`, variant);
        }
        
        const newLegs = await loadModelWithFreshness(modelPath, viewer, { autoCenter: false });

        // ðŸ§® Oblicz statystyki geometrii (meshe, trÃ³jkÄ…ty, wysokoÅ›Ä‡) i opcjonalnie wÅ‚Ä…cz wireframe
        try {
          let meshCount = 0, triCount = 0;
          newLegs.traverse((child) => {
            if (child.isMesh && child.geometry) {
              meshCount++;
              const geom = child.geometry;
              const pos = geom.attributes && geom.attributes.position;
              if (geom.index) triCount += Math.floor(geom.index.count / 3);
              else if (pos) triCount += Math.floor(pos.count / 3);
            }
          });
          const bb = new Box3().setFromObject(newLegs);
          const size = bb.getSize(new Vector3());
          window.__lastLegStats = { meshCount, triCount, size: { x: size.x, y: size.y, z: size.z } };
          const urlParams = new URL(window.location.href).searchParams;
          // Stats banner wyÅ‚Ä…czony - tylko console
          if (urlParams.get('debug') === '1') {
            console.log(`[LEGS-STATS] meshes=${meshCount} trisâ‰ˆ${triCount} size(y)=${size.y.toFixed(3)}`);
          }
          if (urlParams.get('wire') === '1') {
            newLegs.traverse((child)=>{ if(child.isMesh && child.material){ try { child.material.wireframe = true; } catch(_){} }});
          }
        } catch(_) {}

        // ðŸ§¹ Normalizuj nazwy mesh w nogach (usuÅ„ .001, .006 itd.)
        normalizeMeshNames(newLegs, 'ðŸ§¹ LEGS');

        // âœ… SprawdÅº czy model zostaÅ‚ prawidÅ‚owo zaÅ‚adowany
        if (!newLegs) {
          console.error(`ðŸ¦µ Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ modelu nÃ³g: ${modelPath}`);
          hideModelLoader();
          return;
        }

        const legBounds = new Box3().setFromObject(newLegs);
        const legHeight = legBounds.max.y - legBounds.min.y;

        if (currentModelContainer && selectedChair) {
          if (selectedChair.Grupa.toLowerCase() === 'kubeÅ‚ek') {
            // RESET: Zawsze zacznij od pozycji (0,0,0) dla kubeÅ‚ka
            currentModelContainer.position.set(0, 0, 0);
            
            // Oblicz bounding boxy po resecie pozycji
            const bucketBounds = new Box3().setFromObject(currentModelContainer);
            const bucketCenter = bucketBounds.getCenter(new Vector3());
            // Debug/sterowanie: parametry URL
            const urlCfg = new URL(window.location.href);
            const seatRayParam = urlCfg.searchParams.get('seatRay'); // '0' = uÅ¼yj bbox min.y
            const legYParam = urlCfg.searchParams.get('legY'); // dodatkowy offset Y (liczba)
            const fixLegParam = urlCfg.searchParams.get('fixLeg'); // '1' = wymusza Y=0 dla nÃ³g
            const useRay = seatRayParam !== '0';
            const extraY = isNaN(parseFloat(legYParam)) ? 0 : parseFloat(legYParam);
            
            // ZnajdÅº dÃ³Å‚ siedziska: raycast (domyÅ›lnie) lub prosto min.y z bbox (seatRay=0)
            let realSeatBottom = bucketBounds.min.y;
            if (useRay) {
              const raycaster = new THREE.Raycaster();
              const rayOrigin = new Vector3(bucketCenter.x, bucketBounds.max.y + 1, bucketCenter.z); // Start nad kubeÅ‚kiem
              const rayDirection = new Vector3(0, -1, 0); // Kierunek w dÃ³Å‚
              raycaster.set(rayOrigin, rayDirection);
              const bucketMeshes = [];
              currentModelContainer.traverse((child) => { if (child.isMesh) bucketMeshes.push(child); });
              const intersects = raycaster.intersectObjects(bucketMeshes, true);
              if (intersects.length > 0) {
                // NajniÅ¼szy punkt przeciÄ™cia pod Å›rodkiem kubeÅ‚ka
                let lowestHit = intersects[0].point.y;
                for (const hit of intersects) {
                  if (hit.point.y < lowestHit) lowestHit = hit.point.y;
                }
                realSeatBottom = lowestHit;
              }
            }
            
            // Najpierw ustaw nogi tymczasowo na Y=0 Å¼eby obliczyÄ‡ ich rzeczywiste wymiary
            newLegs.position.y = 0;
            const legBounds = new Box3().setFromObject(newLegs);
            const legTopY = legBounds.max.y;
            
            // Ustaw nogi tak, Å¼eby ich gÃ³ra dotykaÅ‚a rzeczywistego doÅ‚u siedziska
            // Apply a tiny correction so legs make visual contact with the seat across varied geometries
            let finalLegY = realSeatBottom - legTopY + SEAT_CONTACT_CORRECTION + extraY;
            
            // ðŸ”§ SPECIAL FIX: Nogi "z obrotem" potrzebujÄ… dodatkowej korekty -0.005
            if (variant && variant.Nazwa && variant.Nazwa.toLowerCase().includes('z obrotem')) {
              const obrotCorrection = -0.005;
              finalLegY += obrotCorrection;
              console.log(`ðŸ”„ NOGI Z OBROTEM: dodatkowa korekta ${obrotCorrection}, finalY=${finalLegY.toFixed(3)}`);
            }
            
            // ðŸ”§ EMERGENCY FIX: tylko gdy jawnie wymuszone przez fixLeg=1
            if (fixLegParam === '1') {
              console.warn(`ðŸš¨ Nogi fixLeg=1, ustawiam na Y=0`);
              finalLegY = 0;
            } else if (finalLegY < -0.5) {
              // Tylko przy ekstremalnie gÅ‚Ä™bokich pozycjach (< -50cm) zastosuj korektÄ™
              console.warn(`ðŸš¨ Nogi ekstremalnie gÅ‚Ä™boko (${finalLegY.toFixed(3)}), korygujÄ™ do -0.1`);
              finalLegY = -0.1;
            }
            
            newLegs.position.y = finalLegY;
            
            console.log(`ðŸ”§ Auto-pozycjonowanie kubeÅ‚ka: centrum=${bucketCenter.x.toFixed(2)},${bucketCenter.z.toFixed(2)}, seatBottom=${realSeatBottom.toFixed(3)} (ray=${useRay}), legTopY=${legTopY.toFixed(3)}, extraY=${extraY}, korekta=${SEAT_CONTACT_CORRECTION}, finalY=${finalLegY.toFixed(3)}`);
            try {
              window.__lastLegPlacement = { seatBottom: realSeatBottom, legTopY, extraY, correction: SEAT_CONTACT_CORRECTION, finalY: finalLegY };
              // Debug banner wyÅ‚Ä…czony - tylko przez ?showBanner=1
              // Debug banner wyÅ‚Ä…czony na Å¼yczenie
              // if (typeof window.__showDebugBanner === 'function' && new URL(window.location.href).searchParams.get('showBanner') === '1') {
              //   window.__showDebugBanner(`LEG Y=${finalLegY.toFixed(3)} (seat=${realSeatBottom.toFixed(3)} ray=${useRay?'on':'off'} top=${legTopY.toFixed(3)} extra=${extraY} corr=${SEAT_CONTACT_CORRECTION})`);
              // }
            } catch(_) {}
          } else {
            // SprawdÅº czy krzesÅ‚o to hooker - jeÅ›li tak, podnieÅ› wyÅ¼ej
            const isHookerChair = selectedChair && selectedChair.Kategoria && 
                                  selectedChair.Kategoria.toLowerCase().includes('hooker');
            const verticalOffset = isHookerChair ? 3.0 : VERTICAL_OFFSET;
            
            currentModelContainer.position.y = legHeight + verticalOffset;
            newLegs.position.y = 0;
          }
        }

        if (oldLegs) {
          viewer.scene.remove(oldLegs);
          if (typeof oldLegs.dispose === 'function') oldLegs.dispose();
        }
        viewer.scene.add(newLegs);
        currentLegModel = newLegs;
        selectedLeg = variant;
        renderFilteredMaterialOptions('legs'); // â¬…ï¸ to odÅ›wieÅ¼a widok kafelkÃ³w materiaÅ‚Ã³w nÃ³g
        updateMaterialTiles(); // â¬…ï¸ MUSI byÄ‡ tutaj!

        // ðŸ”§ OdÅ›wieÅ¼enie listy nÃ³g po wyborze (zostanie wykonane przez renderPartButtons)
        console.log(`ðŸ¦µ setLegModel completed: selected leg = ${variant.Nazwa} (variant: ${variant.Wariant || 'none'})`);

        updateSummary();

        // Dla kubeÅ‚kÃ³w: po zaÅ‚adowaniu nÃ³g ustaw kamerÄ™ na kubeÅ‚ek (nie na caÅ‚y zestaw)
        if (selectedChair && selectedChair.Grupa.toLowerCase() === 'kubeÅ‚ek') {
          try {
            // UÅ¼yj centrum kubeÅ‚ka jako punktu odniesienia (nie caÅ‚ego zestawu)
            const bucketBounds = new Box3();
            if (currentModelContainer) bucketBounds.setFromObject(currentModelContainer);
            
            const bucketCenter = bucketBounds.getCenter(new Vector3());
            console.log(`ðŸŽ¥ Ustawiam kamerÄ™ na kubeÅ‚ek (origin), center:`, bucketCenter.toArray());
            setCameraView(bucketCenter);
          } catch(e) {
            console.warn('Nie udaÅ‚o siÄ™ ustawiÄ‡ kamery po zaÅ‚adowaniu nÃ³g', e);
          }
        }

        // Wymuszenie odÅ›wieÅ¼enia sceny
        if (viewer.render) viewer.render();
        
        // Ukryj loader po udanym zaÅ‚adowaniu
        hideModelLoader();
      } catch (e) {
        console.error(`BÅÄ„D Å‚adowania nÃ³g: ${e.message}`, e);
        // Ukryj loader rÃ³wnieÅ¼ przy bÅ‚Ä™dzie
        hideModelLoader();
        
        // âŒ JeÅ›li nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ - nie ustawiaj selectedLeg
        console.warn(`ðŸ¦µ Nie udaÅ‚o siÄ™ zaÅ‚adowaÄ‡ nÃ³g dla wariantu: ${variant.Nazwa}`);
        return; // Przerwij wykonanie
      }
    } catch (globalError) {
      console.error("ðŸš¨ KRYTYCZNY BÅÄ„D w setLegModel:", globalError);
      hideModelLoader();
    }
  }



    let forceRenderInterval;

    function triggerSceneRefresh() {
  if (viewer && viewer.scene && viewer.scene.mainCamera) {
        viewer.scene.mainCamera.position.x += 0.00001;
        if (viewer.scene.mainCamera.zoom !== undefined) {
          viewer.scene.mainCamera.zoom += 0.0001; // â¬…ï¸ mikroskopijny zoom
        }
        viewer.scene.mainCamera.updateProjectionMatrix();
      }
  if (viewer && viewer.renderManager && viewer.renderManager.info) {
        viewer.renderManager.info.reset();
      }
  if (viewer && viewer.render) viewer.render();
    }


    function startForceRender(duration = 2000) {
      clearInterval(forceRenderInterval);
      forceRenderInterval = setInterval(() => {
        triggerSceneRefresh();
      }, 100);

      setTimeout(() => {
        clearInterval(forceRenderInterval);
        console.log("ðŸ›‘ ZakoÅ„czono wymuszone odÅ›wieÅ¼anie");
      }, duration);
    }



    const textureLoader = new TextureLoader();

    

    if (
  (selectedChair && selectedChair.Grupa && selectedChair.Grupa.toLowerCase() === 'kubeÅ‚ek') &&
  (variant.TargetMeshOrModel && variant.TargetMeshOrModel.toLowerCase().includes('legs')) &&
      variant.WariantModelu
    ) {
      // ðŸ‘‰ dla kubeÅ‚kÃ³w z podmianÄ… nÃ³g â€” zmieÅ„ model nÃ³g
      setLegModel(variant);
    } else if (
      selectedChair &&
      (selectedChair.Grupa.toLowerCase() !== 'kubeÅ‚ek' || !variant.WariantModelu)
    ) {
      // ðŸ‘‰ dla pozostaÅ‚ych krzeseÅ‚ bez wariantÃ³w nÃ³g â€” wyÅ›wietl materiaÅ‚y nÃ³g do wyboru
      showLegMaterialsForSimpleChairs(selectedChair);
    }

    // Funkcje preloadera â€“ uÅ¼ywamy tego samego model-loader co dla modeli i nÃ³g
function showPreloader() {
  showModelLoader('Åadowanie materiaÅ‚u...');
}
function hidePreloader() {
  hideModelLoader();
}

// Uniwersalne funkcje loadera z zmiennym tekstem
function showModelLoader(text = 'Åadowanie modelu...') {
  const el = document.getElementById('model-loader');
  if (el) {
    const textEl = el.querySelector('p');
    if (textEl) textEl.textContent = text;
    el.style.display = 'flex';
  }
}

function hideModelLoader() {
  const el = document.getElementById('model-loader');
  if (el) {
    el.classList.add('fade-out');
    setTimeout(() => {
      el.style.display = 'none';
      el.classList.remove('fade-out');
      // PrzywrÃ³Ä‡ oryginalny tekst
      const textEl = el.querySelector('p');
      if (textEl) textEl.textContent = 'Åadowanie modelu...';
    }, 500);
  }
}

// Opcjonalna aktualizacja paska postÄ™pu dla model-loader (wykorzystywana teÅ¼ przez AR)
function updateModelLoaderProgress(percent) {
  const el = document.getElementById('model-loader');
  if (!el) return;
  const bar = el.querySelector('.progress-container .progress-bar');
  if (!bar) return;
  // Zatrzymaj animacjÄ™ i ustaw szerokoÅ›Ä‡ wg procentu
  bar.style.animation = 'none';
  const clamped = Math.max(0, Math.min(100, Number(percent) || 0));
  bar.style.width = clamped + '%';
}

// Funkcje loadera materiaÅ‚Ã³w
function showMaterialLoader(text = 'Åadowanie materiaÅ‚u...') {
  const el = document.getElementById('model-loader');
  if (el) {
    const textEl = el.querySelector('p');
    if (textEl) textEl.textContent = text;
    el.style.display = 'flex';
  }
}

function hideMaterialLoader() {
  const el = document.getElementById('model-loader');
  if (el) {
    el.classList.add('fade-out');
    setTimeout(() => {
      el.style.display = 'none';
      el.classList.remove('fade-out');
      // PrzywrÃ³Ä‡ oryginalny tekst
      const textEl = el.querySelector('p');
      if (textEl) textEl.textContent = 'Åadowanie modelu...';
    }, 500);
  }
}

    function applyMaterialToMesh(variant, forcedMeshName) {
      const clone = { ...variant };
      clone.TargetMeshOrModel = forcedMeshName;
      console.log(`ðŸŽ¯ Przypisano '${clone.Nazwa}' tylko do mesh '${forcedMeshName}'`);
      applyMaterial(clone);
    }

    // Funkcja, ktÃ³ra wyÅ›wietla kafelki materiaÅ‚Ã³w nÃ³g dla prostych krzeseÅ‚
    function showLegMaterialsForSimpleChairs(chair) {
      const legsMaterialsContainer = document.getElementById('legs-thumbnails');
      // UsuÅ„ tylko kafelki materiaÅ‚Ã³w (pozostaw warianty nÃ³g)
      legsMaterialsContainer.querySelectorAll('.material-tile').forEach(tile => tile.remove());


      // Pobierz materiaÅ‚y nÃ³g dla danego krzesÅ‚a (przykÅ‚ad, wymaga dostosowania)
      const materials = getMaterialsForLegs(chair.defaultLegsId || 'default');

      materials.forEach(mat => {
        const tile = document.createElement('div');
        tile.className = 'material-tile';
        tile.textContent = mat.Nazwa;
        tile.style.backgroundImage = `url(${mat.Obrazek || 'fallback.png'})`;
        tile.onclick = () => {
          onLegVariantClick(mat.DlaModeliNÃ³g || mat.Nazwa);
          applyLegMaterial(mat);
        };

        legsMaterialsContainer.appendChild(tile);
      });
    }


    



// DOBRE PROGRESYWNE ÅADOWANIE MATERIAÅÃ“W!!!

// ðŸ‘‡ Legacy bridge: some UI still calls setLegMaterial(item)
// Decide whether the clicked item is a legs MODEL (Grupa: 'nogi' or Typ: 'model')
// or a legs MATERIAL (Grupa: 'materiaÅ‚y_nÃ³g'), and route accordingly.
if (typeof window.setLegMaterial !== 'function') {
  window.setLegMaterial = function(item) {
    try {
      const grupa = (item && item.Grupa ? String(item.Grupa).trim().toLowerCase() : '');
      const typ = (item && item.Typ ? String(item.Typ).trim().toLowerCase() : '');
      if (grupa === 'nogi' || typ === 'model') {
        console.log('ðŸ¦µ setLegMaterial â†’ setLegModel', { Nazwa: item && item.Nazwa, Grupa: item && item.Grupa });
        return setLegModel(item);
      }
      // Treat as legs material, ensure proper target if missing
      if (!item.TargetMeshOrModel || String(item.TargetMeshOrModel).trim() === '') {
        item = { ...item, TargetMeshOrModel: 'legs' };
      }
      console.log('ðŸ¦µ setLegMaterial â†’ applyMaterial (legs material)', { Nazwa: item && item.Nazwa, Target: item && item.TargetMeshOrModel });
      return applyMaterial(item);
    } catch (err) {
      console.warn('setLegMaterial fallback error, forwarding to applyMaterial:', err);
      try { return applyMaterial(item); } catch(_) {}
    }
  }
}

// ðŸ”§ ZgodnoÅ›Ä‡: czÄ™Å›Ä‡ UI wywoÅ‚uje applyLegMaterial(mat)
if (typeof window.applyLegMaterial !== 'function') {
  window.applyLegMaterial = function(mat) {
    try {
      // JeÅ›li brak targetu, domyÅ›lnie kieruj na nogi
      if (!mat.TargetMeshOrModel || String(mat.TargetMeshOrModel).trim() === '') {
        mat = { ...mat, TargetMeshOrModel: 'legs' };
      }
    } catch(_) {}
    console.log('â†ªï¸ applyLegMaterial â†’ applyMaterial', { Nazwa: mat && mat.Nazwa, Target: mat && mat.TargetMeshOrModel });
    applyMaterial(mat);
  }
}

async function applyMaterial(variant) {
  showMaterialLoader('Åadowanie materiaÅ‚u...');
  try {
    console.log('ðŸ“¦ variant:', variant);

    if (!currentModelContainer) {
      console.warn('currentModelContainer jest null lub undefined');
      hideMaterialLoader();
      return;
    }

    // Akceptuj aliasy: niektÃ³re arkusze uÅ¼ywajÄ… TargetMesh zamiast TargetMeshOrModel
    const targetField = variant.TargetMeshOrModel || variant.TargetMesh || variant.Target || variant.TargetModel || variant.TargetMeshes;
    if (!targetField) {
      console.warn('Brak TargetMesh/TargetMeshOrModel w wariancie');
      hideMaterialLoader();
      return;
    }
    // UjednoliÄ‡ na TargetMeshOrModel
    if (!variant.TargetMeshOrModel) variant.TargetMeshOrModel = targetField;

  const targetNames = variant.TargetMeshOrModel.split(',').map(name => name.trim());
    console.log(`ðŸŽ¯ TargetMeshOrModel: '${variant.TargetMeshOrModel}' -> targetNames:`, targetNames);
  const isHex = /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(variant.Color || variant.WartoÅ›Ä‡);
    const folderPath = (!isHex && variant.WartoÅ›Ä‡.startsWith('textures/')) ? variant.WartoÅ›Ä‡ : `textures/${variant.WartoÅ›Ä‡}`;

    // Progresywna obsÅ‚uga wielu meshÃ³w - loader znika dopiero po wszystkich meshach
    const meshPromises = targetNames.map(async (targetName) => {
      // WspÃ³lny parser wartoÅ›ci PBR (obsÅ‚uga przecinka, %, oraz skal 0-100)
      function parsePBR(val, fallback) {
        const raw = (val || '')
          .toString()
          .trim()
          .replace(/['"]/g, '')
          .replace(',', '.');
        const hasPercent = raw.includes('%');
        const num = parseFloat(raw.replace('%',''));
        if (isNaN(num)) return fallback;
        let parsed = hasPercent ? num / 100 : num;
        if (parsed > 1 && parsed <= 100) parsed = parsed / 100; // konwersja 0-100 na 0-1
        parsed = Math.max(0, Math.min(1, parsed)); // clamp 0..1
        return parsed;
      }

      // Dynamiczne wykrywanie kluczy PBR niezaleÅ¼nie od nazwy kolumny w arkuszu
      function normalizeKeyName(k){
        return String(k||'')
          .toLowerCase()
          .normalize('NFD')
          .replace(/\p{Diacritic}/gu,'')
          .replace(/[^a-z0-9_]/g,'');
      }
      function detectPBR(variant, defaults={ metal:0, rough:0.814 }){
        let metal = { value: defaults.metal, key: undefined, override: false };
        let rough = { value: defaults.rough, key: undefined, override: false };
        let gloss = { value: undefined, key: undefined, has: false };
        for (const key of Object.keys(variant||{})){
          const norm = normalizeKeyName(key);
          const rawVal = variant[key];
          const present = rawVal != null && String(rawVal).trim() !== '';
          if (!present) continue;
          // metalness hints: metal, metalliczn, metalicznosc
          if (!metal.override && (norm.includes('metal') || norm.includes('metaliczn'))){
            metal = { value: parsePBR(rawVal, defaults.metal), key, override: true };
            continue;
          }
          // roughness hints: rough, chropow, szorstk
          if (!rough.override && (norm.includes('rough') || norm.includes('chropow') || norm.includes('szorstk'))){
            rough = { value: parsePBR(rawVal, defaults.rough), key, override: true };
            continue;
          }
          // glossiness/poÅ‚ysk (inverse of roughness)
          if (!gloss.has && (norm.includes('polysk') || norm.includes('po') && norm.includes('lysk'))){
            gloss = { value: parsePBR(rawVal, 0), key, has: true };
          }
        }
        if (!rough.override && gloss.has){
          // Interpretuj poÅ‚ysk jako 1 - roughness
          rough = { value: Math.max(0, Math.min(1, 1 - gloss.value)), key: gloss.key, override: true };
        }
        return { metal, rough };
      }
      let container;
      if (targetName.toLowerCase() === 'legs') {
  if ((selectedChair && selectedChair.Grupa && selectedChair.Grupa.toLowerCase() === 'krzesÅ‚o') || !currentLegModel) {
          container = currentModelContainer;
        } else {
          container = currentLegModel;
        }
      } else {
        container = currentModelContainer;
      }

      let targetObject = null;
      // Aliasy dla wyszukania mesha nÃ³g (rÃ³Å¼ne nazwy w modelach)
      function getTargetAliases(key){
        const k = (key||'').toLowerCase().trim();
        if (k === 'legs' || k === 'legs_material') {
          return ['legs','legs_material','stelaÅ¼','stelasz','nogi','stelaÅ¼_nÃ³g','stelaÅ¼ nog','stelaÅ¼_nog','noga','leg'];
        }
        return [k];
      }
      const targetAliases = getTargetAliases(targetName);
      const targetClean = cleanMeshName(String(targetName||'').toLowerCase().trim());
      console.log(`ðŸ” Szukam mesh dla targetName: '${targetName}' (clean='${targetClean}') w kontenerze:`, container);
  if (container && container.traverse) container.traverse(obj => {
        if (obj.isMesh && obj.name) {
          console.log(`ðŸ” Sprawdzam mesh: '${obj.name}' vs targetName: '${targetName}'`);
        }
        const objName = cleanMeshName(String(obj.name||'').toLowerCase().trim());
        if (
          obj.isMesh &&
          obj.name &&
          (
           // dokÅ‚adne dopasowanie
           objName === targetClean ||
           // dopasowanie aliasÃ³w dla nÃ³g/stelaÅ¼a
           targetAliases.includes(objName) ||
           // Marco: seat -> backseat mapping
           objName === 'backseat' && targetClean === 'seat' ||
           // seat can also be combined into a single bucket mesh in some models
           objName === 'siedzisko_oparcie' && targetClean === 'seat' ||
           // Backseat aliases
           objName === 'siedzisko_oparcie' && targetClean === 'backseat' ||
           objName === 'bucket_combo' && targetClean === 'backseat' ||
           objName === 'siedzisko' && targetClean === 'seat' ||
           // fallback: jeÅ›li celem sÄ… nogi, sprÃ³buj czÄ™Å›ciowego dopasowania nazwy obiektu
           ((targetClean==='legs' || targetClean==='legs_material') && /(leg|nogi|stela|stelaz)/.test(objName))
          )
        ) {
          console.log(`âœ… ZNALEZIONO dopasowanie: mesh '${obj.name}' dla targetName '${targetName}'`);
          targetObject = obj;
        }
      });

      if (!targetObject) {
        console.warn(`âŒ Mesh '${targetName}' nie znaleziony w modelu`);
        // Debugowanie - pokaÅ¼ wszystkie dostÄ™pne meshe
        const allMeshes = [];
        if (container && container.traverse) {
          container.traverse(obj => {
            if (obj.isMesh && obj.name) {
              allMeshes.push(obj.name);
            }
          });
        }
        console.log(`ðŸ” Wszystkie dostÄ™pne meshe w modelu:`, allMeshes);
        return;
      }

      if (!targetObject.material) {
        console.warn(`âš ï¸ Mesh '${targetName}' nie ma materiaÅ‚u.`);
        return;
      }

      // Funkcja do bezpiecznego Å‚adowania tekstury (zwraca null, jeÅ›li nie uda siÄ™ zaÅ‚adowaÄ‡)
      async function loadTextureSafe(url) {
        try {
          const tex = await textureLoader.loadAsync(url);
          tex.magFilter = LinearFilter;
          tex.minFilter = LinearMipMapLinearFilter;
          tex.anisotropy = (viewer && viewer.renderer && viewer.renderer.capabilities && viewer.renderer.capabilities.getMaxAnisotropy ? viewer.renderer.capabilities.getMaxAnisotropy() : 4);
          tex.wrapS = tex.wrapT = RepeatWrapping;
          tex.encoding = sRGBEncoding;
          tex.offset.set(0, 0);
          tex.repeat.set(1, 1);
          tex.needsUpdate = true;
          return tex;
        } catch {
          return null;
        }
      }

      // Odczytaj PBR (dynamicznie) raz i wykorzystaj w obu gaÅ‚Ä™ziach
      // DomyÅ›lne wartoÅ›ci z kodu dla znanych materiaÅ‚Ã³w, ale nadpisz z arkusza jeÅ›li sÄ…
      let defaults = { metal: 0, rough: 0.814 };
      const nazwa = (variant.Nazwa || '').toLowerCase().trim();
      if (nazwa.includes('zÅ‚oty') || nazwa.includes('gold')) {
        defaults = { metal: 0.9, rough: 0.1 };
      } else if (nazwa.includes('chrom') || nazwa.includes('chrome')) {
        defaults = { metal: 1.0, rough: 0.0 };
      } else if (nazwa.includes('srebrny') || nazwa.includes('silver')) {
        defaults = { metal: 0.8, rough: 0.2 };
      } else if (nazwa.includes('miedÅº') || nazwa.includes('copper') || nazwa.includes('miedz')) {
        defaults = { metal: 0.7, rough: 0.3 };
      }
      const pbr = detectPBR(variant, defaults);
      const hasMetalOverride = !!pbr.metal.override;
      const hasRoughOverride = !!pbr.rough.override;
      if (isHex) {
        // JeÅ›li kolor HEX â€“ podmieÅ„ od razu (nie ma tekstur)
        const material = targetObject.material.clone();
        material.color.set(variant.Color || variant.WartoÅ›Ä‡);
        material.map = null;
        material.normalMap = null;
        material.roughnessMap = null;
        material.metalnessMap = null;
        // Ustaw metalness/roughness z arkusza takÅ¼e dla wariantÃ³w HEX (dynamiczne klucze)
        material.metalness = pbr.metal.value;
        material.roughness = pbr.rough.value;
        // Delikatnie podbij envMapIntensity dla wysokiej metalicznoÅ›ci â€“ lepszy efekt metalu
        if (material.metalness >= 0.8 && material.roughness <= 0.5) {
          material.envMapIntensity = Math.max(1.0, material.envMapIntensity || 1.0);
        }
        console.log(`ðŸ§ª [HEX] Applied PBR: metalness=${material.metalness} (key: ${pbr.metal.key||'auto'}), roughness=${material.roughness} (key: ${pbr.rough.key||'auto'})`, { name: variant.Nazwa, targetName });
        material.needsUpdate = true;
  targetObject.material = material;
  if (viewer && viewer.render) viewer.render();
      } else if (folderPath && !/\.(jpg|jpeg|png|gif)$/i.test(folderPath)) {
        // --- PROGRESYWNE ÅADOWANIE ---

        // 1. Najpierw zaÅ‚aduj basecolor
        let baseColorTex = null;
        try {
          baseColorTex = await loadTextureSafe(`${folderPath}/baseColor.jpg`);
        } catch (err) {
          console.warn("BÅ‚Ä…d Å‚adowania baseColor:", err);
        }

        // 2. Skopiuj materiaÅ‚ i podepnij basecolor (lub null)
        const material = targetObject.material.clone();
        material.map = baseColorTex || null;
        material.color.set(0xffffff);
        material.normalMap = null;
        material.roughnessMap = null;
        material.metalnessMap = null;
        material.needsUpdate = true;

  // 3. Metalness i roughness z wariantu (dynamiczne klucze)
  material.metalness = pbr.metal.value;
  material.roughness = pbr.rough.value;
  if (material.metalness >= 0.8 && material.roughness <= 0.5) {
    material.envMapIntensity = Math.max(1.0, material.envMapIntensity || 1.0);
  }
  console.log(`ðŸ§ª [TEX] Applied PBR: metalness=${material.metalness} (key: ${pbr.metal.key||'auto'}), roughness=${material.roughness} (key: ${pbr.rough.key||'auto'})`, { name: variant.Nazwa, targetName });

        // 4. PodmieÅ„ materiaÅ‚ dopiero teraz (dopiero po basecolor)
        targetObject.material = material;
  if (targetObject.geometry && targetObject.geometry.computeVertexNormals) {
          targetObject.geometry.computeVertexNormals();
        }
  if (viewer && viewer.render) viewer.render();

        // 6. Progresywnie doÅ‚adowuj pozostaÅ‚e mapy i podmieniaj "w locie"
        loadTextureSafe(`${folderPath}/normal.jpg`).then(tex => {
          if (tex) {
            tex.encoding = LinearEncoding;
            tex.wrapS = tex.wrapT = RepeatWrapping;
            tex.offset.set(0, 0);
            tex.repeat.set(1.001, 1.001);
            material.normalMap = tex;
            material.needsUpdate = true;
            targetObject.material = material;
            if (viewer && viewer.render) viewer.render();
          }
        });

        loadTextureSafe(`${folderPath}/roughness.jpg`).then(tex => {
          if (tex) {
            if (hasRoughOverride) return; // nie nadpisuj liczbowej roughness z arkusza
            tex.encoding = LinearEncoding;
            tex.wrapS = tex.wrapT = RepeatWrapping;
            tex.offset.set(0, 0);
            tex.repeat.set(1.001, 1.001);
            material.roughnessMap = tex;
            material.needsUpdate = true;
            targetObject.material = material;
            if (viewer && viewer.render) viewer.render();
          }
        });

        loadTextureSafe(`${folderPath}/metallic.jpg`).then(tex => {
          if (tex) {
            if (hasMetalOverride) return; // nie nadpisuj liczbowej metalness z arkusza
            tex.encoding = LinearEncoding;
            tex.wrapS = tex.wrapT = RepeatWrapping;
            tex.offset.set(0, 0);
            tex.repeat.set(1.001, 1.001);
            material.metalnessMap = tex;
            material.needsUpdate = true;
            targetObject.material = material;
            if (viewer && viewer.render) viewer.render();
          }
        });

        console.log(`âœ… Progresywne Å‚adowanie tekstur na '${targetName}'`);
        console.log(`ðŸ§ª Metalness=${material.metalness}, Roughness=${material.roughness}`);
      }

      // ZapamiÄ™tanie wyboru i odÅ›wieÅ¼enie sceny
      selectedMaterials[targetName] = variant;
      if (targetName === 'legs' || targetName === 'legs_material') {
        selectedMaterials['legs_material'] = variant;
        // OdÅ›wieÅ¼ podsumowanie gdy materiaÅ‚ nÃ³g zostaÅ‚ ustawiony
        setTimeout(() => updateSummary(), 100);
      }
    });

    await Promise.all(meshPromises); // czekaj aÅ¼ wszystkie meshe ogarnÄ… materiaÅ‚
    hideMaterialLoader();
    // ðŸ—‚ï¸ Automatycznie przypisz Folder do eksportu
    Object.entries(selectedMaterials).forEach(([key, mat]) => {
      if (!mat.Folder && typeof mat.WartoÅ›Ä‡ === 'string') {
        const parts = mat.WartoÅ›Ä‡.split('/');
        const last = parts[parts.length - 1];
  if (last && texturesFilesByFolder && texturesFilesByFolder[last]) {
          mat.Folder = last;
          console.log(`ðŸ“ Dodano Folder='${last}' do '${key}'`);
        }
      }
    });

  viewer.scene.traverse(obj => {
      if (obj.isMesh && obj.material) {
        obj.material.needsUpdate = true;
      }
    });

  if (viewer && viewer.scene && viewer.scene.mainCamera) {
      viewer.scene.mainCamera.position.x += 0.00001;
      viewer.scene.mainCamera.updateProjectionMatrix();
    }

  if (viewer && viewer.render) viewer.render();

    updateSummary();
  } catch (e) {
    hideMaterialLoader();
    console.error("BÅ‚Ä…d w applyMaterial:", e);
  }
}

function applyMaterialToSpecificMesh(variant, meshKey) {
  const clone = { ...variant };
  clone.TargetMeshOrModel = meshKey;
  console.log(`ðŸŽ¯ Przypisano '${variant.Nazwa}' tylko do mesh '${meshKey}'`);
  applyMaterial(clone);
}

// DOBRE PROGRESYWNE ÅADOWANIE MATERIAÅÃ“W!!!





      function renderOptions(containerId, items, onSelect, isInteractive = true) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';
        
        // Zastosuj filtr wyszukiwania jeÅ›li jest aktywny
        const filteredItems = currentSearchFilter 
          ? items.filter(matchesSearchFilter)
          : items;
          
        console.log(`ðŸ“¦ Rendering ${filteredItems.length}/${items.length} items in ${containerId}`);
        
        filteredItems.forEach((item, index) => {
          console.log(`ðŸ“· Item ${index}: "${item.Nazwa}", Image URL: "${item.Obrazek}"`);
          if (index === 0) {
            console.log('ðŸ” FIRST ITEM ALL FIELDS:', Object.keys(item));
            console.log('ðŸ” Obrazek field:', item.Obrazek);
            console.log('ðŸ” Mobile field:', item.Mobile);
          }
          
          const wrapper = document.createElement('div');
          wrapper.className = 'thumbnail-wrapper';
          const button = document.createElement('div');
          button.className = 'thumbnail';
          button.title = stripBrackets(item.Nazwa);

          // Dodaj klasÄ™ promocji jeÅ›li przedmiot jest na promocji
          if (item.Promocja && item.Promocja.trim() !== '' && (item.Promocja === 'TRUE' || item.Promocja === 'true' || item.Promocja === 'tak' || item.Promocja === 'âœ”')) {
            button.classList.add('promotion');
            // Dodaj procent zniÅ¼ki jako data-attribute dla CSS
            const procent = parseFloat(item.Procent) || 0;
            console.log(`ðŸŽ¯ PROMOCJA DEBUG - Item: ${item.Nazwa}, Promocja: "${item.Promocja}", Procent raw: "${item.Procent}", Procent parsed: ${procent}`);
            if (procent > 0) {
              button.setAttribute('data-discount', `-${procent}%`);
            }
          }

          // Dodaj klasÄ™ bestseller jeÅ›li przedmiot jest bestsellerem
          if (item.Bestseller && (item.Bestseller === 'TRUE' || item.Bestseller === 'true' || item.Bestseller === 'tak' || item.Bestseller === 'âœ”')) {
            button.classList.add('bestseller');
          }

          // PODÅšWIETLENIE WYBRANEGO
          let isSelected = false;
          if (containerId === 'material-options') {
            if (item.Grupa && item.Grupa.toLowerCase() === 'materiaÅ‚y_nÃ³g') {
              isSelected = selectedMaterials['legs_material'] && selectedMaterials['legs_material'].Nazwa === item.Nazwa;
            } else if (item.TargetMeshOrModel) {
              const targets = item.TargetMeshOrModel.split(',').map(t => t.trim());
              isSelected = targets.some(t => selectedMaterials[t] && selectedMaterials[t].Nazwa === item.Nazwa);
            }
          } else if (containerId === 'legs-thumbnails') {
            isSelected = selectedLeg && selectedLeg.Nazwa === item.Nazwa;
          }
          if (isSelected) button.classList.add('selected');

          if (isInteractive) {
            button.addEventListener('click', () => {
              onSelect(item);
              container.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('selected'));
              button.classList.add('selected');
            });
          }
          const img = document.createElement('img');
          const imageUrl = item.Obrazek && item.Obrazek.length > 4 ? item.Obrazek : 'icons/placeholder.svg';
          img.src = imageUrl;
          img.alt = item.Nazwa;
          
          // Debug obrazka
          img.onerror = () => {
            console.error(`âŒ Failed to load image: ${imageUrl} for item: ${item.Nazwa}`);
            img.src = 'icons/placeholder.svg';
          };
          img.onload = () => {
            console.log(`âœ… Successfully loaded image: ${imageUrl} for item: ${item.Nazwa}`);
          };
          
          button.appendChild(img);
          const caption = document.createElement('div');
          caption.className = 'thumbnail-caption';
          caption.textContent = stripBrackets(item.Nazwa);
          
          // Dodaj cenÄ™ (tylko dla modeli krzeseÅ‚)
          const priceDiv = document.createElement('div');
          if (item.Typ === 'model' && item.Cena) {
            const cena = parseFloat(item.Cena) || 0;
            const promocja = item.Promocja === 'TRUE' || item.Promocja === 'true' || item.Promocja === 'tak' || item.Promocja === 'âœ”';
            const bestseller = item.Bestseller === 'TRUE' || item.Bestseller === 'true' || item.Bestseller === 'tak' || item.Bestseller === 'âœ”';
            const procent = parseFloat(item.Procent) || 0;
            
            console.log(`ðŸ’° CENA DEBUG - Item: ${item.Nazwa}, Cena raw: "${item.Cena}", Cena parsed: ${cena}, Promocja: ${promocja}, Procent: ${procent}`);
            
            if (promocja && procent > 0) {
              // Cena promocyjna - cena przekreÅ›lona i nowa cena (prostokÄ…t z % jest na ikonce)
              const cenaPoPobniÅ¼ce = cena * (1 - procent / 100);
              if (bestseller) {
                // JeÅ›li to teÅ¼ bestseller, dodaj Å‚atkÄ™ bestseller
                priceDiv.className = 'thumbnail-price promotion bestseller';
                priceDiv.innerHTML = `
                  <span class="original-price">${cena.toFixed(0)} zÅ‚</span>
                  <span class="discounted-price">${cenaPoPobniÅ¼ce.toFixed(0)} zÅ‚</span>
                  <span class="bestseller-badge">â­ Bestseller</span>
                `;
              } else {
                priceDiv.className = 'thumbnail-price promotion';
                priceDiv.innerHTML = `
                  <span class="original-price">${cena.toFixed(0)} zÅ‚</span>
                  <span class="discounted-price">${cenaPoPobniÅ¼ce.toFixed(0)} zÅ‚</span>
                `;
              }
              console.log(`ðŸ’° PROMOCJA PRICE - Cena przed: ${cena}, po obniÅ¼ce: ${cenaPoPobniÅ¼ce} (${procent}% zniÅ¼ki)`);
            } else if (bestseller && cena > 0) {
              // Cena bestsellera - normalna cena z oznaczeniem bestseller
              priceDiv.className = 'thumbnail-price bestseller';
              priceDiv.innerHTML = `
                <span class="bestseller-price">${cena.toFixed(0)} zÅ‚</span>
                <span class="bestseller-badge">â­ Bestseller</span>
              `;
            } else if (cena > 0) {
              // Cena normalna
              priceDiv.className = 'thumbnail-price';
              priceDiv.textContent = `${cena.toFixed(0)} zÅ‚`;
            }
          }
          
          wrapper.appendChild(button);
          wrapper.appendChild(caption);
          if (priceDiv.textContent || priceDiv.innerHTML) {
            wrapper.appendChild(priceDiv);
          }
          container.appendChild(wrapper);
        });
      }





      // ðŸŽ¯ Automatyczne zaznaczenie domyÅ›lnych materiaÅ‚Ã³w
      function autoSelectDefaultMaterials(targetMesh, materialOptions) {
        console.log(`ðŸŽ¯ autoSelectDefaultMaterials called for: ${targetMesh}`);
        console.log(`ðŸŽ¯ selectedChair:`, selectedChair);
        console.log(`ðŸŽ¯ selectedChair keys:`, selectedChair ? Object.keys(selectedChair) : 'null');
        
        if (!materialOptions || materialOptions.length === 0) {
          console.log(`ðŸŽ¯ No materials to auto-select for: ${targetMesh}`);
          return;
        }

        let defaultMaterial = null;
        const isLegs = targetMesh === 'legs' || targetMesh === 'legs_material';

        if (isLegs) {
          // KubeÅ‚ki: brak auto-wyboru
          const isKubelek = selectedChair && selectedChair.Grupa === 'kubeÅ‚ek';
          if (isKubelek) {
            console.log(`ðŸŽ¯ KUBEÅEK: Pomijam auto-wybÃ³r materiaÅ‚u nÃ³g dla: ${selectedChair.Nazwa} (grupa: ${selectedChair.Grupa})`);
            return;
          }

          // JeÅ›li wybrana jest noga (selectedLeg), pobierz domyÅ›lny materiaÅ‚ z jej danych
          let defaultLegMaterial = null;
          if (selectedLeg && selectedLeg.DefaultLegMaterial) {
            defaultLegMaterial = selectedLeg.DefaultLegMaterial;
            console.log(`ðŸ¦µ NOGA: Using DefaultLegMaterial from leg sheet: ${defaultLegMaterial} for leg: ${selectedLeg.Nazwa}`);
          } else if (selectedChair && selectedChair.DefaultLegMaterial) {
            defaultLegMaterial = selectedChair.DefaultLegMaterial;
            console.log(`ðŸŽ¯ KRZESÅO: Using DefaultLegMaterial from sheet: ${defaultLegMaterial} for chair: ${selectedChair.Nazwa}${selectedChair.Wariant ? ` (${selectedChair.Wariant})` : ''}`);
          } else {
            defaultLegMaterial = 'Czarny Mat';
            console.log(`ðŸŽ¯ KRZESÅO: No DefaultLegMaterial found for chair or leg, using fallback: ${defaultLegMaterial}`);
          }

          defaultMaterial = materialOptions.find(mat => mat.Nazwa === defaultLegMaterial);
          if (defaultMaterial) {
            console.log(`ðŸŽ¯ Auto-selecting default leg material: ${defaultMaterial.Nazwa}`);
            requestAnimationFrame(() => {
              setTimeout(() => {
                const thumbnails = document.querySelectorAll('#legs-panels .thumbnail');
                console.log(`ðŸŽ¯ Found ${thumbnails.length} leg material thumbnails to check`);
                let found = false;
                thumbnails.forEach(thumb => {
                  if (thumb.title === defaultMaterial.Nazwa) {
                    thumb.classList.add('selected');
                    found = true;
                    console.log(`ðŸŽ¯ âœ… Zaznaczono domyÅ›lny materiaÅ‚ nÃ³g: ${defaultMaterial.Nazwa}`);
                    selectedMaterials[targetMesh] = defaultMaterial;
                    console.log(`ðŸŽ¯ âœ… Automatycznie ustawiono materiaÅ‚ nÃ³g: ${defaultMaterial.Nazwa} w selectedMaterials['${targetMesh}']`);
                    updateSummary();
                  } else {
                    thumb.classList.remove('selected');
                  }
                });
                if (!found) {
                  console.log(`ðŸŽ¯ âŒ Nie znaleziono thumbnail dla materiaÅ‚u nÃ³g: ${defaultMaterial.Nazwa}`);
                  console.log(`ðŸŽ¯ Available materials:`, materialOptions.map(m => m.Nazwa));
                }
              }, 200);
            });
          } else {
            console.log(`ðŸŽ¯ âŒ Nie znaleziono materiaÅ‚u o nazwie: ${defaultLegMaterial}`);
            console.log(`ðŸŽ¯ Available materials:`, materialOptions.map(m => m.Nazwa));
          }
        } else {
          // Dla tkanin - zawsze "Beige"
          defaultMaterial = materialOptions.find(mat => mat.Nazwa === 'Beige');
          if (defaultMaterial) {
            console.log(`ðŸŽ¯ Auto-selecting default fabric: ${defaultMaterial.Nazwa}`);
            // Ustaw materiaÅ‚ bez wywoÅ‚ywania loadera - poczekaj na DOM
            requestAnimationFrame(() => {
              setTimeout(() => {
                const thumbnails = document.querySelectorAll('#fabric-panels .thumbnail');
                console.log(`ðŸŽ¯ Found ${thumbnails.length} fabric thumbnails to check`);
                let found = false;
                thumbnails.forEach(thumb => {
                  if (thumb.title === defaultMaterial.Nazwa) {
                    thumb.classList.add('selected');
                    found = true;
                    console.log(`ðŸŽ¯ âœ… Zaznaczono domyÅ›lny materiaÅ‚: ${defaultMaterial.Nazwa}`);
                    
                    // Zapisz w selectedMaterials i odÅ›wieÅ¼ podsumowanie
                    selectedMaterials[targetMesh] = defaultMaterial;
                    console.log(`ðŸŽ¯ âœ… Automatycznie ustawiono materiaÅ‚: ${defaultMaterial.Nazwa} w selectedMaterials['${targetMesh}']`);
                    
                    updateSummary();
                  } else {
                    thumb.classList.remove('selected');
                  }
                });
                if (!found) {
                  console.log(`ðŸŽ¯ âŒ Nie znaleziono thumbnail dla: ${defaultMaterial.Nazwa}`);
                }
              }, 200);
            });
          }
        }
      }

      function renderFilteredMaterialOptions(targetMesh) {
  console.log(`ðŸŽ¨ renderFilteredMaterialOptions called for: ${targetMesh}`);
  
  if (!selectedChair || !selectedChair.Grupa) {
    console.warn(`ðŸŽ¨ No selectedChair or Grupa. selectedChair:`, selectedChair);
    return;
  }

  const grupa = selectedChair.Grupa.toLowerCase();

  // Alias map for mesh keys used in sheet vs internal keys
  const meshAliases = {
    seat: ['seat','siedzisko','siedzisko_material','siedzisko_mesh'],
    backseat_inside: ['backseat_inside','oparcie wew','oparcie_wew','oparcie_wewn','oparcie_wewnetrzne','oparcie_wewnÄ™trzne'],
    backseat_outside: ['backseat_outside','oparcie zew','oparcie_zew','oparcie_zewn','oparcie_zewnetrzne','oparcie_zewnÄ™trzne'],
    backseat: ['backseat','bucket_combo','siedzisko_oparcie'],
    legs_material: ['legs_material','legs','stelaÅ¼','stelaÅ¼_material','stelaÅ¼_mat','stelasz','nogi','stelaÅ¼_nÃ³g']
  };
  const targetAliasList = (meshAliases[targetMesh] || [targetMesh]).map(a=>a.toLowerCase());

  function isAllowedForGroup(entryGroupDocelowa) {
    if (!entryGroupDocelowa) return true; // brak => traktuj jako wszystkie
    const norm = s => s
      .toLowerCase()
      .normalize('NFD')
      .replace(/\p{Diacritic}/gu,'')
      .trim();
    const chairGroupNorm = norm(grupa);
    const values = entryGroupDocelowa.split(',').map(norm);
    return values.includes('wszystkie') || values.includes(chairGroupNorm);
  }

  let materialOptions = [];

  const isLegs = targetMesh === 'legs' || targetMesh === 'legs_material';

  if (isLegs) {
    materialOptions = allData.filter(d => {
      if ((d.Grupa || '').toLowerCase() !== 'materiaÅ‚y_nÃ³g') return false;
      if (!isAllowedForGroup(d.GrupaDocelowa)) return false;
      if ((d.Visible || '').toLowerCase() === 'false') return false;
      return true;
    });

    if (selectedLeg && selectedLeg.Typ) {
      materialOptions = materialOptions.filter(mat =>
        !mat.Typ || mat.Typ.toLowerCase().trim() === selectedLeg.Typ.toLowerCase().trim()
      );
    }

    if (selectedLeg && selectedLeg.Nazwa) {
      const norm = s => (s || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/\p{Diacritic}/gu,'')
        .replace(/\s+/g,' ')
        .trim();
      const currentLegName = (selectedLeg.Nazwa || '').toLowerCase().trim();
      const curLegNorm = norm(currentLegName);
      materialOptions = materialOptions.filter(mat => {
        const raw = (mat.DlaModeluNÃ³g || mat.DlaModeluNog || mat.DlaModelu) || '';
        const allowedLegs = raw
          ? raw.split(',').map(s => s.trim()).filter(Boolean)
          : [];
        if (allowedLegs.length === 0) return true; // brak ograniczeÅ„
        return allowedLegs.some(v => {
          const vv = norm(v);
          return vv === curLegNorm || vv.startsWith(curLegNorm + ' ');
        });
      });
    }

    if (selectedChair && selectedChair.Nazwa) {
      // ðŸŽ¯ Dla materiaÅ‚Ã³w nÃ³g: preferuj DlaKubeÅ‚ka dla wariantÃ³w, ale jeÅ›li nie pasuje â€” sprawdÅº DlaKrzesÅ‚a. Dla krzeseÅ‚ bez wariantu skup siÄ™ na DlaKrzesÅ‚a.
      const norm = s => (s || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/\p{Diacritic}/gu,'')
        .replace(/\s+/g,' ')
        .trim();
  const baseN = norm(selectedChair.Nazwa);
  const hasVariant = !!(selectedChair.Wariant && String(selectedChair.Wariant).trim());
  const uVarN = hasVariant ? norm(`${selectedChair.Nazwa}_${selectedChair.Wariant}`) : '';
  const sVarN = hasVariant ? norm(`${selectedChair.Nazwa} ${selectedChair.Wariant}`) : '';
      const isChairGroup = (selectedChair.Grupa||'').toLowerCase() === 'krzesÅ‚o' || (selectedChair.Grupa||'').toLowerCase() === 'krzeslo';

      const before = materialOptions.length;
      materialOptions = materialOptions.filter(mat => {
        const rawBucket = String(mat.DlaKubeÅ‚ka || mat.DlaKubelka || '').trim();
        const rawChair  = String(mat.DlaKrzesÅ‚a || mat.DlaKrzesla || '').trim();
        const hasBucket = rawBucket !== '';
        const hasChair  = rawChair !== '';

        if (hasVariant) {
          // KrzesÅ‚a: tryb STRICT â€” wymagaj jawnego przypisania do wariantu (uVar/sVar). JeÅ›li oba pola puste â†’ wyklucz.
          if (isChairGroup) {
            const matchBucket = hasBucket && rawBucket.split(',').map(s=>norm(s)).some(v=> v===uVarN || v===sVarN);
            const matchChair  = hasChair  && rawChair.split(',').map(s=>norm(s)).some(v=> v===uVarN || v===sVarN);
            return matchBucket || matchChair;
          }
          // KubeÅ‚ki lub inne: najpierw kubeÅ‚ek (wariant), potem fallback do krzesÅ‚a (baza)
          if (hasBucket) {
            const allowedB = rawBucket.split(',').map(s=>norm(s)).filter(Boolean);
            if (allowedB.includes(uVarN) || allowedB.includes(sVarN)) return true;
          }
          if (hasChair) {
            const allowedC = rawChair.split(',').map(s=>norm(s));
            if (allowedC.includes(uVarN) || allowedC.includes(sVarN) || allowedC.includes(baseN)) return true;
          }
          return false; // brak dopasowania â€” nie pokazuj
        } else {
          // Bez wariantu
          if (isChairGroup) {
            // STRICT: wymagaj jawnego przypisania do bazy w DlaKrzesÅ‚a; puste pola wyklucz
            if (hasChair) {
              const allowedC = rawChair.split(',').map(s=>norm(s));
              return allowedC.includes(baseN);
            }
            return false;
          } else {
            // Inne grupy: DlaKrzesÅ‚a jeÅ›li jest; DlaKubeÅ‚ka nie obowiÄ…zuje dla krzeseÅ‚
            if (hasChair) {
              const allowedC = rawChair.split(',').map(s=>norm(s));
              return allowedC.includes(baseN);
            }
            if (hasBucket) return false;
            return true;
          }
        }
      });
      console.log(`ðŸ¦µ Filtr nÃ³g (kubeÅ‚ek/krzesÅ‚o, wariant=${hasVariant}): ${before} -> ${materialOptions.length}`);
    }



    const groupedByCollection = {};
    materialOptions.forEach(mat => {
  const key = (mat.Kolekcja ? mat.Kolekcja.trim() : '') || 'Inne';
      if (!groupedByCollection[key]) groupedByCollection[key] = [];
      groupedByCollection[key].push(mat);
    });

  console.log(`ðŸ¦µ Grupowanie materiaÅ‚Ã³w nÃ³g: ${Object.keys(groupedByCollection).length} kolekcji, ${materialOptions.length} pozycji`);
  renderCollectionsAndMaterials(groupedByCollection, 'legs');
  
  // ðŸŽ¯ Automatyczne zaznaczenie domyÅ›lnych materiaÅ‚Ã³w nÃ³g
  autoSelectDefaultMaterials('legs_material', materialOptions);
  return;
  }

  // ðŸ§µ TKANINY (siedzisko, oparcie itd.)
  materialOptions = allData.filter(d => {
    if ((d.Grupa || '').toLowerCase() !== 'tkanina') return false;
    if (!d.TargetMeshOrModel) return false;
    const parts = d.TargetMeshOrModel.split(',').map(t=>t.trim().toLowerCase());
    const matches = parts.some(p=> targetAliasList.includes(p));
    if (!matches) return false;
    if (!isAllowedForGroup(d.GrupaDocelowa)) return false;
    if ((d.Visible || '').toLowerCase() === 'false') return false;
    return true;
  });

  // Zastosuj filtr wyszukiwania do materiaÅ‚Ã³w nÃ³g
  if (currentSearchFilter && isLegs) {
    materialOptions = allData.filter(d =>
      (d.Grupa || '').toLowerCase() === 'materiaÅ‚y_nÃ³g' &&
      isAllowedForGroup(d.GrupaDocelowa) &&
      ((d.Visible || '').toLowerCase() !== 'false')
    ).filter(matchesSearchFilter);
    
    console.log(`ðŸ¦µ Filtered leg materials to ${materialOptions.length} for filter: "${currentSearchFilter}"`);
    
    // Zastosuj pozostaÅ‚e filtry nÃ³g
    if (selectedLeg && selectedLeg.Typ) {
      materialOptions = materialOptions.filter(mat =>
        !mat.Typ || mat.Typ.toLowerCase().trim() === selectedLeg.Typ.toLowerCase().trim()
      );
    }

    if (selectedLeg && selectedLeg.Nazwa) {
      const norm = s => (s || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/\p{Diacritic}/gu,'')
        .replace(/\s+/g,' ')
        .trim();
      const curLegNorm = norm(selectedLeg.Nazwa);
      materialOptions = materialOptions.filter(mat => {
        const raw = (mat.DlaModeluNÃ³g || mat.DlaModeluNog || mat.DlaModelu) || '';
        const allowedLegs = raw ? raw.split(',').map(s=>s.trim()).filter(Boolean) : [];
        if (allowedLegs.length === 0) return true;
        return allowedLegs.some(v => {
          const vv = norm(v);
          return vv === curLegNorm || vv.startsWith(curLegNorm + ' ');
        });
      });
    }

    if (selectedChair && selectedChair.Nazwa) {
      // Wyszukiwanie: ta sama zasada fallbacku kubeÅ‚ek -> krzesÅ‚o
      const norm = s => (s || '')
        .toLowerCase()
        .normalize('NFD')
        .replace(/\p{Diacritic}/gu,'')
        .replace(/\s+/g,' ')
        .trim();
  const baseN = norm(selectedChair.Nazwa);
  const hasVariant = !!(selectedChair.Wariant && String(selectedChair.Wariant).trim());
  const uVarN = hasVariant ? norm(`${selectedChair.Nazwa}_${selectedChair.Wariant}`) : '';
  const sVarN = hasVariant ? norm(`${selectedChair.Nazwa} ${selectedChair.Wariant}`) : '';
      const isChairGroup = (selectedChair.Grupa||'').toLowerCase() === 'krzesÅ‚o' || (selectedChair.Grupa||'').toLowerCase() === 'krzeslo';
      materialOptions = materialOptions.filter(mat => {
        const rawBucket = String(mat.DlaKubeÅ‚ka || mat.DlaKubelka || '').trim();
        const rawChair  = String(mat.DlaKrzesÅ‚a || mat.DlaKrzesla || '').trim();
        const hasBucket = rawBucket !== '';
        const hasChair  = rawChair !== '';
        if (hasVariant) {
          if (isChairGroup) {
            const matchBucket = hasBucket && rawBucket.split(',').map(s=>norm(s)).some(v=> v===uVarN || v===sVarN);
            const matchChair  = hasChair  && rawChair.split(',').map(s=>norm(s)).some(v=> v===uVarN || v===sVarN);
            return matchBucket || matchChair;
          }
          if (hasBucket) {
            const allowedB = rawBucket.split(',').map(s=>norm(s)).filter(Boolean);
            if (allowedB.includes(uVarN) || allowedB.includes(sVarN)) return true;
          }
          if (hasChair) {
            const allowedC = rawChair.split(',').map(s=>norm(s));
            if (allowedC.includes(uVarN) || allowedC.includes(sVarN) || allowedC.includes(baseN)) return true;
          }
          return false;
        } else {
          if (isChairGroup) {
            if (hasChair) {
              const allowedC = rawChair.split(',').map(s=>norm(s));
              return allowedC.includes(baseN);
            }
            return false;
          }
          if (hasChair) {
            const allowedC = rawChair.split(',').map(s=>norm(s));
            return allowedC.includes(baseN);
          }
          if (hasBucket) return false;
          return true;
        }
      });
    }

    const groupedByCollection = {};
    materialOptions.forEach(mat => {
      const key = mat.Kolekcja?.trim() || 'Inne';
      if (!groupedByCollection[key]) groupedByCollection[key] = [];
      groupedByCollection[key].push(mat);
    });

  console.log(`ðŸ¦µ Grupowanie (search) materiaÅ‚Ã³w nÃ³g: ${Object.keys(groupedByCollection).length} kolekcji, ${materialOptions.length} pozycji`);
  renderCollectionsAndMaterials(groupedByCollection, 'legs');
    return;
  }

  // ðŸ§µ TKANINY (siedzisko, oparcie itd.)
  materialOptions = allData.filter(d => {
    if ((d.Grupa || '').toLowerCase() !== 'tkanina') return false;
    if (!d.TargetMeshOrModel) return false;
    const parts = d.TargetMeshOrModel.split(',').map(t=>t.trim().toLowerCase());
    if (!parts.some(p=> targetAliasList.includes(p))) return false;
    if (!isAllowedForGroup(d.GrupaDocelowa)) return false;
    if ((d.Visible || '').toLowerCase() === 'false') return false;
    return true;
  });

  // ðŸŽ¯ Filtruj tkaniny wedÅ‚ug wariantu krzesÅ‚a (z normalizacjÄ… i fallbackiem)
  if (selectedChair && selectedChair.Nazwa) {
    const norm = s => (s||'')
      .toLowerCase()
      .normalize('NFD')
      .replace(/\p{Diacritic}/gu,'')
      .replace(/\s+/g,' ')
      .trim();
    const base = norm(selectedChair.Nazwa);
    const variantRaw = norm(selectedChair.Wariant);
    const hasVariant = !!variantRaw;
    const uVar = hasVariant ? norm(`${selectedChair.Nazwa}_${selectedChair.Wariant}`) : '';
    const sVar = hasVariant ? norm(`${selectedChair.Nazwa} ${selectedChair.Wariant}`) : '';

    const before = materialOptions.length;
    materialOptions = materialOptions.filter(mat => {
      const rawBucket = norm((mat.DlaKubeÅ‚ka || mat.DlaKubelka || ''));
      const rawChair  = norm((mat.DlaKrzesÅ‚a || mat.DlaKrzesla || ''));
      if (hasVariant) {
        // Prefer DlaKubeÅ‚ka if provided; accept underscore or space variant; 
        // DlaKrzesÅ‚a moÅ¼e zawieraÄ‡ bazÄ™ LUB bazÄ™+wariant (space/underscore)
        if (rawBucket) {
          const allowedB = rawBucket.split(',').map(s=>norm(s)).filter(Boolean);
          if (allowedB.includes(uVar) || allowedB.includes(sVar)) return true;
        }
        if (rawChair) {
          const allowedC = rawChair.split(',').map(s=>norm(s));
          if (allowedC.includes(uVar) || allowedC.includes(sVar) || allowedC.includes(base)) return true;
        }
        // JeÅ¼eli ktÃ³ryÅ› z pÃ³l byÅ‚ podany, a nic nie pasowaÅ‚o â€” odrzuÄ‡; gdy oba puste â€” brak ograniczeÅ„
        return !(rawBucket || rawChair);
      } else {
        // No variant -> use DlaKrzesÅ‚a if present; otherwise allow
        if (rawChair) {
          const allowed = rawChair.split(',').map(s=>norm(s));
          return allowed.includes(base);
        }
        return true;
      }
    });
    console.log(`ðŸ§µ Filtr tkanin (base='${base}'${hasVariant?`, variant='${variantRaw}'`:''}): ${before} -> ${materialOptions.length}`);
  }

  // Zastosuj filtr wyszukiwania jeÅ›li jest aktywny
  if (currentSearchFilter) {
    materialOptions = materialOptions.filter(matchesSearchFilter);
    console.log(`ðŸŽ¨ Filtered materials from ${allData.length} to ${materialOptions.length} for filter: "${currentSearchFilter}"`);
  }

  const groupedByCollection = {};
  materialOptions.forEach(mat => {
    const key = (mat.Kolekcja ? mat.Kolekcja.trim() : '') || 'Inne';
    if (!groupedByCollection[key]) groupedByCollection[key] = [];
    groupedByCollection[key].push(mat);
  });

  console.log(`ðŸŽ¨ Grupowanie tkanin '${targetMesh}': ${Object.keys(groupedByCollection).length} kolekcji, ${materialOptions.length} pozycji`);
  console.log(`ðŸŽ¨ About to call renderCollectionsAndMaterials with:`, groupedByCollection);
  renderCollectionsAndMaterials(groupedByCollection, targetMesh);
  console.log(`ðŸŽ¨ renderCollectionsAndMaterials completed for: ${targetMesh}`);
  
  // ðŸŽ¯ Automatyczne zaznaczenie domyÅ›lnych materiaÅ‚Ã³w
  autoSelectDefaultMaterials(targetMesh, materialOptions);
}

     




// âœ… Po wygenerowaniu â€” otwÃ³rz ostatnio klikniÄ™tÄ… kolekcjÄ™
if (lastOpenedCollection) {
  const toOpen = container.querySelector(`details[data-kolekcja="${lastOpenedCollection}"]`);
  if (toOpen) toOpen.open = true;
}












      function activateLegsTabAndShowMaterials() {
        // PodÅ›wietl zakÅ‚adkÄ™ "Nogi" po data-key
        const partTabs = document.querySelectorAll('#part-tabs .thumbnail');
        partTabs.forEach(tab => tab.classList.remove('selected'));
        partTabs.forEach(tab => {
          if (tab.dataset.key === 'legs') {
            tab.classList.add('selected');
          }
        });

        // PokaÅ¼ sekcjÄ™ materiaÅ‚Ã³w i wyÅ›wietl wszystkie materiaÅ‚y nÃ³g
        document.getElementById('materials-section').style.display = 'block';
        renderFilteredMaterialOptions('legs');

      }

      function renderPartTabs() {
        const container = document.getElementById('part-tabs');
        container.innerHTML = '';
        // Pobierz unikalne elementy do wyboru
        const allTargets = allData.filter(d => d.TargetMeshOrModel)
          .flatMap(d => d.TargetMeshOrModel.split(',').map(t => t.trim()));
        const uniqueTargets = [...new Set(allTargets)];
        if (uniqueTargets.length === 0) {
          document.getElementById('parts-section').style.display = 'none';
          return;
        }
        document.getElementById('parts-section').style.display = 'block';

        // Mapowanie nazw technicznych na polskie
        const POLISH_LABELS = {
          seat: 'Siedzisko',
          backseat_inside: 'Oparcie wew.',
          backseat_outside: 'Oparcie zew.',
          backseat: 'Siedzisko/Oparcie',
          legs: 'Nogi'
        };

        renderOptions('part-tabs', uniqueTargets.map(name => {
          const key = name.trim().toLowerCase();
          return {
            Nazwa: POLISH_LABELS[key] || name.trim(),
            Obrazek: ELEMENT_ICONS[key] || 'icons/placeholder.svg',
            _technicalKey: key
          };
        }), (item) => {
          if (item._technicalKey === 'legs') {
            activateLegsTabAndShowMaterials();
          } else {
            // PodÅ›wietl klikniÄ™tÄ… zakÅ‚adkÄ™
            const partTabs = document.querySelectorAll('#part-tabs .thumbnail');
            partTabs.forEach(tab => tab.classList.remove('selected'));
            partTabs.forEach(tab => {
              if (tab.title && tab.title.toLowerCase().includes(item.Nazwa.toLowerCase())) {
                tab.classList.add('selected');
              }
            });
            document.getElementById('materials-section').style.display = 'block';
            renderFilteredMaterialOptions(item._technicalKey);
          }
        });
      }

      function updateUI() {
        const backContainer = document.getElementById('back-to-models-container');
        backContainer.innerHTML = '';
        if (selectedChair && (selectedChair.Obrazek || selectedChair.Image)) {
          // StwÃ³rz ramkÄ™ z ikonkÄ… i X
          const btn = document.createElement('div');
          btn.className = 'back-to-model-btn';
          btn.title = 'WrÃ³Ä‡ do wyboru modelu';
          
          // DODAJ KLASY PROMOCJI/BESTSELLERA do przycisku
          const hasPromotion = selectedChair.Promocja === 'TRUE' || selectedChair.Promocja === 'true' || 
                               selectedChair.Promocja === 'tak' || selectedChair.Promocja === 'âœ”';
          const procent = hasPromotion ? parseFloat(selectedChair.Procent) || 0 : 0;
          const isBestseller = selectedChair.Bestseller === 'TRUE' || selectedChair.Bestseller === 'true' || 
                              selectedChair.Bestseller === 'tak' || selectedChair.Bestseller === 'âœ”';
          
          if (hasPromotion && procent > 0) {
            btn.classList.add('promotion');
            btn.setAttribute('data-discount', `-${procent}%`);
          }
          if (isBestseller) {
            btn.classList.add('bestseller');
          }

          // Ikonka modelu
          const img = document.createElement('img');
          img.src = selectedChair.Obrazek || selectedChair.Image;
          img.alt = selectedChair.Nazwa;
          btn.appendChild(img);

          // Przycisk X w rogu
          const xBtn = document.createElement('button');
          xBtn.className = 'close-x';
          xBtn.innerHTML = '&times;';
          xBtn.title = 'WrÃ³Ä‡ do wyboru modelu';
          xBtn.onclick = (e) => {
            e.stopPropagation();
            if (window.innerWidth <= 820) {
              renderMobileRightPanelList('Wszystkie');
            } else {
              showScreen('models');
            }
          };
          btn.appendChild(xBtn);

          // KlikniÄ™cie w caÅ‚Ä… ramkÄ™ teÅ¼ wraca do wyboru modelu
          btn.onclick = () => {
            if (window.innerWidth <= 820) {
              renderMobileRightPanelList('Wszystkie');
            } else {
              showScreen('models');
            }
          };

          backContainer.appendChild(btn);
          
          // DODAJ INFORMACJE O PROMOCJI/BESTSELLERZE
          const promoInfo = document.createElement('div');
          promoInfo.className = 'chair-promo-info';
          promoInfo.style.cssText = `
            margin-left: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 14px;
          `;
          
          // SprawdÅº promocjÄ™ i bestseller (juÅ¼ zdefiniowane wyÅ¼ej)
          
          if (hasPromotion && procent > 0) {
            const promoDiv = document.createElement('div');
            promoDiv.style.cssText = `
              display: flex;
              align-items: center;
              gap: 8px;
              color: #FF6B6B;
              font-weight: 600;
              margin-bottom: 2px;
            `;
            
            // Ikonka promocji identyczna jak w UI
            const promoIcon = document.createElement('div');
            promoIcon.style.cssText = `
              width: 20px;
              height: 20px;
              background: #FF6B6B;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-size: 14px;
              font-weight: bold;
              flex-shrink: 0;
              position: relative;
            `;
            
            // Dodaj symbol ognia CSS
            const fireSymbol = document.createElement('div');
            fireSymbol.style.cssText = `
              width: 8px;
              height: 12px;
              background: white;
              border-radius: 4px 4px 0 0;
              position: relative;
            `;
            fireSymbol.innerHTML = '';
            
            // Alternatywnie uÅ¼yj prostego symbolu procenta
            promoIcon.innerHTML = '%';
            promoDiv.appendChild(promoIcon);
            
            const promoText = document.createElement('span');
            promoText.innerHTML = `Promocja -${procent}%`;
            promoDiv.appendChild(promoText);
            
            promoInfo.appendChild(promoDiv);
            
            // Dodaj info o wysyÅ‚ce
            const shipInfo = document.createElement('div');
            shipInfo.style.cssText = `
              display: flex;
              align-items: center;
              gap: 8px;
              font-size: 12px;
              color: #28a745;
              font-weight: 500;
              margin-left: 28px;
            `;
            
            // Ikonka paczki
            const shipIcon = document.createElement('div');
            shipIcon.style.cssText = `
              width: 16px;
              height: 16px;
              background: #28a745;
              border-radius: 3px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-size: 10px;
              font-weight: bold;
              flex-shrink: 0;
            `;
            shipIcon.innerHTML = 'â–¡';
            shipInfo.appendChild(shipIcon);
            
            const shipText = document.createElement('span');
            shipText.innerHTML = 'WysyÅ‚ka 24h';
            shipInfo.appendChild(shipText);
            
            promoInfo.appendChild(shipInfo);
          }
          
          if (isBestseller) {
            const bestsellerDiv = document.createElement('div');
            bestsellerDiv.style.cssText = `
              display: flex;
              align-items: flex-start;
              gap: 8px;
              color: #FFD700;
              font-weight: 600;
              margin-top: ${hasPromotion ? '8px' : '0'};
            `;
            
            // Ikonka bestseller identyczna jak w UI (gwiazdka)
            const bestsellerIcon = document.createElement('div');
            bestsellerIcon.style.cssText = `
              width: 20px;
              height: 20px;
              background: #FFD700;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-size: 12px;
              font-weight: bold;
              flex-shrink: 0;
              margin-top: 1px;
            `;
            bestsellerIcon.innerHTML = 'â˜…';
            bestsellerDiv.appendChild(bestsellerIcon);
            
            const bestsellerTextDiv = document.createElement('div');
            bestsellerTextDiv.style.cssText = `
              display: flex;
              flex-direction: column;
              gap: 2px;
            `;
            
            const bestsellerTitle = document.createElement('div');
            bestsellerTitle.style.cssText = `
              font-weight: 600;
              color: #FFD700;
            `;
            bestsellerTitle.innerHTML = 'Bestseller';
            bestsellerTextDiv.appendChild(bestsellerTitle);
            
            const bestsellerDesc = document.createElement('div');
            bestsellerDesc.style.cssText = `
              font-size: 11px;
              color: #666;
              font-weight: 400;
              line-height: 1.3;
            `;
            bestsellerDesc.innerHTML = 'NajczÄ™Å›ciej wybierany model wÅ›rÃ³d klientÃ³w';
            bestsellerTextDiv.appendChild(bestsellerDesc);
            
            bestsellerDiv.appendChild(bestsellerTextDiv);
            promoInfo.appendChild(bestsellerDiv);
          }
          
          // Dodaj kontener z informacjami do back-container
          if (hasPromotion || isBestseller) {
            const wrapperDiv = document.createElement('div');
            wrapperDiv.style.cssText = `
              display: flex;
              align-items: center;
              gap: 12px;
              margin-bottom: 15px;
            `;
            wrapperDiv.appendChild(btn);
            wrapperDiv.appendChild(promoInfo);
            backContainer.appendChild(wrapperDiv);
          } else {
            backContainer.appendChild(btn);
          }
        }

        // UÅ¼yj indeksu zamiast filtrowania caÅ‚ego allData
  const legsIndex = (window.dataIndices && window.dataIndices.nogi) ? window.dataIndices.nogi : allData.filter(d => (d.Grupa || '').toLowerCase() === 'nogi');
  const legs = legsIndex.filter(d => {
  // Filtrowanie kategorii
  const nogaKategoria = (d.Kategoria || d.Typ || d.Grupa || '').toLowerCase();
  const chairKategoria = ((selectedChair && selectedChair.Kategoria) || '').toLowerCase();
  
  // JeÅ›li krzesÅ‚o to 'hookery', pokazuj tylko nogi 'hooker'
  if (chairKategoria.includes('hooker')) {
    if (!nogaKategoria.includes('hooker')) return false;
  }
  // JeÅ›li krzesÅ‚o to 'krzesÅ‚a', pokazuj tylko nogi 'krzesÅ‚a' (i uniwersalne)
  else if (chairKategoria.includes('krzes')) {
    if (nogaKategoria.includes('hooker')) return false;
    if (!(nogaKategoria.includes('krzes') || nogaKategoria === '' || nogaKategoria === 'nogi')) return false;
  }
  
  // Sprawdzenie zgodnoÅ›ci kubeÅ‚ka
  if (!selectedChair || selectedChair.Grupa.toLowerCase() !== 'kubeÅ‚ek') return true;
  return czyNogaPasujeDoKubeÅ‚ka(d, selectedChair.Nazwa);
})
.filter(d => !selectedChair || czyNogaPasujeDoKrzesÅ‚a(d, selectedChair.Nazwa))
.filter(d => !selectedChair || czyWariantNogPasujeDoKubeÅ‚ka(d, selectedChair));

  console.log(`ðŸ¦µ Filtered legs for ${selectedChair ? selectedChair.Nazwa : ''}:`, legs.map(l => l.Nazwa));


        renderOptions('legs-thumbnails', legs, item => {
  setLegModel(item);
});



        // Sekcja nÃ³g i materiaÅ‚y nÃ³g â€“ nogi tylko dla kubeÅ‚kÃ³w, materiaÅ‚y dla kubeÅ‚kÃ³w i krzeseÅ‚
    if (selectedChair && selectedChair.Grupa) {    
          const grupa = selectedChair.Grupa.toLowerCase();

          if (grupa === 'kubeÅ‚ek') {
            console.log("PokazujÄ™ nogi i materiaÅ‚y nÃ³g dla kubeÅ‚ka");
            // SprawdÅº czy jest uÅ¼ywany uproszczony interfejs (czy istniejÄ… przyciski Obicie/StelaÅ¼)
            const simpleButtons = document.querySelector('.simple-part-btn');
            if (!simpleButtons) {
              // PeÅ‚ny interfejs - pokaÅ¼ legs-section
              document.getElementById('legs-section').style.display = 'block';
            } else {
              // Uproszczony interfejs - nie pokazuj legs-section (uÅ¼ywa nowego systemu)
              console.log('ðŸ”§ DEBUG: Uproszczony interfejs - nie pokazujÄ™ legs-section');
              document.getElementById('legs-section').style.display = 'none';
            }
            

            // Ustaw pierwszÄ… nogÄ™ jeÅ›li jeszcze Å¼adna nie zostaÅ‚a wybrana
if (!selectedLeg && legs.length > 0) {
  const defaultLeg = selectDefaultLeg(legs, selectedChair.Kategoria);
  setLegModel(defaultLeg);
}

renderOptions('legs-thumbnails', legs, item => {
              setLegModel(item);
            });

            // Ukryj sekcjÄ™ materiaÅ‚Ã³w, pokaÅ¼e siÄ™ po klikniÄ™ciu w zakÅ‚adkÄ™
            document.getElementById('materials-section').style.display = 'none';
          } else if (grupa === 'krzesÅ‚o') {
            console.log("Ukrywam sekcjÄ™ nÃ³g dla krzesÅ‚a");
            document.getElementById('legs-section').style.display = 'none';

            // Ukryj sekcjÄ™ materiaÅ‚Ã³w, pokaÅ¼e siÄ™ po klikniÄ™ciu w zakÅ‚adkÄ™
            document.getElementById('materials-section').style.display = 'none';
          } else {
            console.log("Ukrywam sekcje nÃ³g i materiaÅ‚Ã³w");
            document.getElementById('legs-section').style.display = 'none';
            document.getElementById('materials-section').style.display = 'none';
          }
        } else {
          console.log("Brak wybranego elementu lub grupy");
          document.getElementById('legs-section').style.display = 'none';
          document.getElementById('materials-section').style.display = 'none';
        }

        updateSummary();
      }

      const visibleData = allData.filter(d => {
        var v = (d.Visible != null ? d.Visible.toString() : '');
        return v.trim().length > 0;
      });

      // Flaga zapobiegajÄ…ca wielokrotnemu renderowaniu kategorii
      let isCategoryButtonsRendered = false;

      // Flaga zapobiegajÄ…ca wielokrotnemu Å‚adowaniu danych
      let isDataLoaded = false;

      async function loadDataFromSheet() {
        if (isDataLoaded) {
          console.log('ï¿½ Data already loaded, skipping...');
          return;
        }
        
        console.log('ï¿½ðŸ“¡ Loading data from Google Sheets...');
        isDataLoaded = true;
        
        // TYMCZASOWO WYÅÄ„CZONE: SprawdÅº najpierw dane lokalne z panelu admina
        // const localChairs = localStorage.getItem('chairsData');
        // const localMaterials = localStorage.getItem('materialsData');
        
        // BEZPOÅšREDNIO ÅADUJ Z ARKUSZA
        console.log('ðŸ”„ Loading directly from Google Sheets...');
        
        // WyczyÅ›Ä‡ localStorage z danych admina (tymczasowo)
        localStorage.removeItem('chairsData');
        localStorage.removeItem('materialsData');
        console.log('ðŸ—‘ï¸ Cleared local admin data');
        
        // Åaduj bezpoÅ›rednio z Google Sheets
        const sheetId = '1ftI8CkA2Itav_h45KOap__JYtup28V1FiBmpP0p_Cjc';
        const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Baza Danych&v=${new Date().getTime()}`;
        
  try {
          const bust1 = sheetURL + (sheetURL.includes('?') ? '&' : '?') + 'nocache=' + Date.now();
          const response = await fetch(bust1, { 
            cache: 'no-store'
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const csvText = await response.text();
          console.log('âœ… CSV data loaded, parsing...');
          
          const rows = csvText.trim().split('\n');
          const headerRow = rows.shift();
          const rawHeaders = headerRow.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
          const cleanHeaders = rawHeaders.map(h => h.trim().replace(/"/g, ''));
          
          // OczyÅ›Ä‡ nagÅ‚Ã³wki - usuÅ„ wartoÅ›ci z nagÅ‚Ã³wkÃ³w (np. "Kategoria krzesÅ‚a" -> "Kategoria")
          const headers = cleanHeaders.map(header => {
            const cleanHeader = header.split(' ')[0]; // WeÅº tylko pierwszÄ… czÄ™Å›Ä‡ przed spacjÄ…
            return cleanHeader;
          });
          
          console.log('ðŸ” RAW HEADERS:', cleanHeaders);
          console.log('ðŸ” CLEAN HEADERS:', headers);
          
          // Parsowanie CSV - TYLKO parsowanie, bez filtrowania
          const rawData = rows.map(row => {
            const values = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
            const obj = {};
            headers.forEach((header, index) => obj[header] = (values[index] ? values[index].trim().replace(/"/g, '') : '') || '');
            return obj;
          });

          // Filtrowanie DOPIERO po peÅ‚nym parsowaniu wszystkich danych
          allData = rawData.filter(item => ((item.Visible || '').toLowerCase() !== 'false'));

          // ðŸ”§ KLUCZOWE DEBUGOWANIE: SprawdÅº faktyczne dane
          console.log('ðŸ” CRITICAL DEBUG - First 5 parsed items:', allData.slice(0, 5));
          console.log('ðŸ” CRITICAL DEBUG - All unique field names:', [...new Set(allData.flatMap(item => Object.keys(item)))]);
          console.log('ðŸ” CRITICAL DEBUG - Sample field values:');
          if (allData.length > 0) {
            const sample = allData[0];
            Object.keys(sample).forEach(key => {
              console.log(`  ${key}: "${sample[key]}" (type: ${typeof sample[key]})`);
            });
          }
          console.log('ðŸ” CRITICAL DEBUG - Kategoria values:', [...new Set(allData.map(item => item.Kategoria).filter(k => k))]);
          console.log('ðŸ” CRITICAL DEBUG - Typ values:', [...new Set(allData.map(item => item.Typ).filter(t => t))]);
          console.log('ðŸ” CRITICAL DEBUG - Grupa values:', [...new Set(allData.map(item => item.Grupa).filter(g => g))]);
          console.log('ðŸ” CRITICAL DEBUG - Promocja values:', [...new Set(allData.map(item => item.Promocja).filter(p => p))]);
          console.log('ðŸ” CRITICAL DEBUG - Bestseller values:', [...new Set(allData.map(item => item.Bestseller).filter(b => b))]);

          // Sortowanie danych - modele pierwszych, potem nogi, potem materiaÅ‚y
          // To zapewnia Å¼e wszystkie potrzebne referencje sÄ… dostÄ™pne
          allData.sort((a, b) => {
            const getGroupPriority = (item) => {
              const grupa = (item.Grupa || '').toLowerCase();
              if (grupa === 'kubeÅ‚ek' || grupa === 'krzesÅ‚o') return 1; // Modele pierwsze
              if (grupa === 'nogi') return 2; // Nogi drugie  
              if (grupa === 'materiaÅ‚y_nÃ³g' || grupa === 'tkanina') return 3; // MateriaÅ‚y trzecie
              return 4; // Reszta ostatnia
            };
            return getGroupPriority(a) - getGroupPriority(b);
          });

          console.log('ðŸŽ¯ Data parsed and sorted successfully, items:', allData.length);
          
          // StwÃ³rz indeksy dla szybszego dostÄ™pu
          window.dataIndices = {
            kubeÅ‚ki: allData.filter(d => (d.Grupa || '').toLowerCase() === 'kubeÅ‚ek'),
            krzesÅ‚a: allData.filter(d => (d.Grupa || '').toLowerCase() === 'krzesÅ‚o'), 
            nogi: allData.filter(d => (d.Grupa || '').toLowerCase() === 'nogi'),
            materiaÅ‚yNÃ³g: allData.filter(d => (d.Grupa || '').toLowerCase() === 'materiaÅ‚y_nÃ³g'),
            tkaniny: allData.filter(d => (d.Grupa || '').toLowerCase() === 'tkanina')
          };
          
          console.log('ðŸ“Š Data indices created:', {
            kubeÅ‚ki: window.dataIndices.kubeÅ‚ki.length,
            krzesÅ‚a: window.dataIndices.krzesÅ‚a.length, 
            nogi: window.dataIndices.nogi.length,
            materiaÅ‚yNÃ³g: window.dataIndices.materiaÅ‚yNÃ³g.length,
            tkaniny: window.dataIndices.tkaniny.length
          });
          
          console.log('ðŸ” CSV HEADERS:', headers);
          console.log('ðŸ” FIRST ITEM FIELDS:', allData[0] ? Object.keys(allData[0]) : 'No items');
          console.log('ðŸ” FIRST ITEM DATA:', allData[0]);

          // Eksportuj dane dla PWA
          window.allData = allData;
          console.log('âœ… allData exported to window for PWA');

          // Renderuj UI
          // ðŸ“± Jedny UI dla desktop i mobile (responsive design)
          console.log('ðŸ” Window width:', window.innerWidth, 'Is mobile:', window.innerWidth <= 820);
          console.log('ðŸ–¥ï¸ðŸ“± Responsive UI initialization');
          
          // ðŸ”§ KLUCZOWE: Zapewnij, Å¼e mobile panel istnieje PRZED renderowaniem kategorii
          if (document.body.classList.contains('mobile-mode') || window.innerWidth <= 820) {
            console.log('ðŸ“± Ensuring mobile panel exists before rendering categories...');
            try {
              if (typeof ensureMobilePanel === 'function') {
                const ctx = ensureMobilePanel();
                console.log('ðŸ“± Mobile panel ensured:', ctx ? 'SUCCESS' : 'FAILED');
              }
            } catch (e) {
              console.error('âŒ Failed to ensure mobile panel:', e);
            }
          }
          
          renderCategoryButtons();
          // Poczekaj chwilÄ™ aÅ¼ przyciski zostanÄ… dodane do DOM-u, a nastÄ™pnie aktywuj Promocje
          setTimeout(() => { renderPromotions(); }, 50);
          showScreen('models');
          // Mobile: NIE nadpisuj dobrych thumbnails!
          // USUNIÄ˜TE: renderMobileRightPanelList('Promocje') - niszczyÅ‚o ikony po zamkniÄ™ciu popup
          const hdrEntries = allData.filter(d => d.HDR && d.HDRIcon);
          renderHDROptions(hdrEntries);

          // --- MOBILE ONLY: use unified right-side list (with Promocje/Bestsellery) ---
          if ((document.body.classList.contains('mobile-mode')) && allData && allData.length > 0) {
            const sidebar = document.getElementById('sidebar'); if (sidebar) sidebar.style.display = 'none';
            const right = document.getElementById('mobile-right-panel'); if (right) right.style.display = 'block';
            // USUNIÄ˜TE: renderMobileRightPanelList('Promocje') - niech renderMobileCategoriesOnly robi robotÄ™!
          }

          // Ukryj loader
          const customLoader = document.getElementById('custom-loader');
          const appElement = document.getElementById('app');
          
          if (customLoader) {
            customLoader.classList.add('fade-out');
            setTimeout(() => {
              customLoader.style.display = 'none';
              if (appElement) {
                appElement.style.visibility = 'visible';
              }
            }, 500);
          }

          // PokaÅ¼ toolbar
          const toolbar = document.getElementById('bottom-toolbar');
          if (toolbar) {
            toolbar.style.display = 'flex';
            toolbar.classList.add('visible');
          }
          
          console.log('ðŸš€ App initialization complete');

        } catch (e) { 
          console.error("âŒ Error loading data:", e);
          
          // Ukryj loader przy bÅ‚Ä™dzie
          const errorLoader = document.getElementById('custom-loader');
          if (errorLoader) {
            errorLoader.style.display = 'none';
            const errorApp = document.getElementById('app');
            if (errorApp) {
              errorApp.style.visibility = 'visible';
            }
          }
          
          // PokaÅ¼ podstawowy komunikat bÅ‚Ä™du
          alert('BÅ‚Ä…d Å‚adowania danych. SprÃ³buj odÅ›wieÅ¼yÄ‡ stronÄ™.');
        }
      }
        
        // If data was already loaded by an earlier path, skip this duplicate loader
        if ((window.allData || []).length) {
          console.log('âš ï¸ Data already present in window.allData; skipping secondary loading block');
        } else try {
          console.log('Loading data from Google Sheets...');
          
          // Definicje brakujÄ…cych zmiennych
          const sheetId = '1ftI8CkA2Itav_h45KOap__JYtup28V1FiBmpP0p_Cjc';
          const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Baza Danych&v=${new Date().getTime()}`;
          
          // Enhanced mobile detection
          const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                           (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1); // iPad detection
          
          // Timeout for mobile devices
          const timeoutDuration = isMobile ? 15000 : 10000;
          const timeoutPromise = new Promise((_, reject) => {
            const loaderTimeout = setTimeout(() => reject(new Error(`Timeout loading data (${timeoutDuration/1000}s)`)), timeoutDuration);
            // Store timeout reference for cleanup
            window.loaderTimeout = loaderTimeout;
          });
          
          console.log('Making fetch request...');
          
          const bust2 = sheetURL + (sheetURL.includes('?') ? '&' : '?') + 'nocache=' + Date.now();
          const fetchPromise = fetch(bust2, { 
            cache: 'no-store',
            headers: {
              'Accept': 'text/plain,text/csv,application/csv'
            }
          });
          
          console.log('Waiting for response...');
          const response = await Promise.race([fetchPromise, timeoutPromise]);
          console.log('Response received, status:', response.status);
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}, statusText: ${response.statusText}`);
          }

          console.log('Reading response text...');
          const csvText = await response.text();
          console.log('CSV data loaded successfully, length:', csvText.length);
          
          const rows = csvText.trim().split('\n');
          console.log('CSV rows found:', rows.length);
          
          if (rows.length === 0) {
            throw new Error('CSV file appears to be empty');
          }
          
          const headers = rows.shift().split(',').map(h => h.trim().replace(/"/g, ''));
          console.log('CSV headers parsed:', headers.length);
          allData = rows.map(row => {
            const values = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
            const obj = {};
            headers.forEach((header, index) => obj[header] = values[index]?.trim().replace(/"/g, '') || '');
            return obj;
          }).filter(item => item.Visible?.toLowerCase() !== 'false');

          console.log('Data parsed successfully, items:', allData.length);
          console.log('Sample data item:', allData[0]);
          
          // Eksportuj dane dla PWA
          window.allData = allData;
          console.log('âœ… allData exported to window for PWA (second loading)');
          
          if (allData.length === 0) {
            throw new Error('No visible items found in data');
          }

          console.log('Data parsed, items:', allData.length);
          
          if (allData.length === 0) {
            console.error('No data loaded - forcing timeout');
            throw new Error('No data available');
          }

          // WyczyÅ›Ä‡ timeout loader jeÅ›li dane siÄ™ zaÅ‚adowaÅ‚y
          if (window.loaderTimeout) {
            clearTimeout(window.loaderTimeout);
            window.loaderTimeout = null;
          }
          console.log('Starting UI initialization...');

          // ðŸ“± Jedny UI dla desktop i mobile (responsive design)
          console.log('ðŸ” Second check - Window width:', window.innerWidth, 'Is mobile:', window.innerWidth <= 820);
          console.log('ðŸ–¥ï¸ðŸ“± Responsive UI second initialization');
          console.log('About to render category buttons...');
          renderCategoryButtons();
          console.log('Category buttons rendered');
          
          // Renderuj promocje na starcie - poczekaj aÅ¼ przyciski zostanÄ… dodane do DOM-u
          console.log('About to render promotions...');
          setTimeout(() => {
            renderPromotions();
            console.log('Promotions rendered');
          }, 50);
          
          console.log('About to show models screen...');
          showScreen('models');
          console.log('Models screen shown');

          const hdrEntries = allData.filter(d => d.HDR && d.HDRIcon);
          renderHDROptions(hdrEntries);
          console.log('HDR options rendered, entries:', hdrEntries.length);

          // --- MOBILE ONLY: ensure right-side list shows even in this load path ---
          try {
            if (document.body.classList.contains('mobile-mode') && allData && allData.length > 0) {
              const sidebar = document.getElementById('sidebar');
              if (sidebar) sidebar.style.display = 'none';
              const right = document.getElementById('mobile-right-panel');
              if (right) right.style.display = 'block';
              try {
                renderMobileRightPanelList('Promocje');
              } catch (e) {
                console.warn('renderMobileRightPanelList (secondary path) failed:', e);
              }
            }
          } catch (_) { /* noop */ }

          // Ukryj loader
          const customLoader = document.getElementById('custom-loader');
          const appElement = document.getElementById('app');
          
          if (customLoader) {
            customLoader.classList.add('fade-out');
            setTimeout(() => {
              customLoader.style.display = 'none';
              console.log('Loader hidden');
              
              if (appElement) {
                appElement.style.visibility = 'visible';
                console.log('App shown');
              }
            }, 500);
          }

          // PokaÅ¼ toolbar
          const toolbar = document.getElementById('bottom-toolbar');
          if (toolbar) {
            toolbar.style.display = 'flex';
            toolbar.classList.add('visible');
            console.log('Toolbar shown');
          }
          
          console.log('App initialization complete');


        } catch (e) { 
          console.error("=== ERROR IN LOAD DATA FROM SHEET ===");
          console.error("Error type:", e.constructor.name);
          console.error("Error message:", e.message);
          console.error("Full error:", e);
          console.error("Stack trace:", e.stack);
          
          // WyczyÅ›Ä‡ timeout loader
          if (window.loaderTimeout) {
            clearTimeout(window.loaderTimeout);
            window.loaderTimeout = null;
          }
          console.log('Timeout cleared after error');

          // ðŸ“ Local CSV fallback (placed next to index.html) â€” mobile only
          let fallbackSucceeded = false;
          const isMobileEnv = document.body.classList.contains('mobile-mode') ||
            /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) ||
            (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
          if (isMobileEnv) {
          try {
            const localUrl = 'Baza Danych - Baza Danych.csv';
            console.log('ðŸ”„ Trying local CSV fallback:', localUrl);
            const lr = await fetch(localUrl + '?t=' + Date.now(), { cache: 'no-store' });
            if (!lr.ok) throw new Error(`Local CSV HTTP ${lr.status}`);
            const csvText = await lr.text();
            console.log('âœ… Local CSV loaded, parsing...');
            const rows = csvText.trim().split('\n');
            const headerRow = rows.shift();
            const rawHeaders = headerRow.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
            const cleanHeaders = rawHeaders.map(h => h.trim().replace(/"/g, ''));
            const headers = cleanHeaders.map(header => header.split(' ')[0]);
            allData = rows.map(row => {
              const values = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
              const obj = {};
              headers.forEach((header, index) => obj[header] = values[index]?.trim().replace(/"/g, '') || '');
              return obj;
            }).filter(item => item.Visible?.toLowerCase() !== 'false');
            window.allData = allData;
            console.log('âœ… Parsed local data, items:', allData.length);

            // Initialize UI as usual
            console.log('ðŸ” Window width:', window.innerWidth, 'Is mobile:', window.innerWidth <= 820);
            console.log('ðŸ–¥ï¸ðŸ“± Responsive UI initialization (local fallback)');
            renderCategoryButtons();
            renderPromotions();
            showScreen('models');
            const hdrEntries = allData.filter(d => d.HDR && d.HDRIcon);
            renderHDROptions(hdrEntries);
            if (document.body.classList.contains('mobile-mode')) {
              const sidebar = document.getElementById('sidebar'); if (sidebar) sidebar.style.display = 'none';
              const right = document.getElementById('mobile-right-panel'); if (right) right.style.display = 'block';
              renderMobileRightPanelList('Wszystkie');
            }

            // Hide loader after local fallback
            const errorLoader = document.getElementById('custom-loader');
            if (errorLoader) {
              errorLoader.classList.add('fade-out');
              setTimeout(() => {
                errorLoader.style.display = 'none';
                const errorApp = document.getElementById('app');
                if (errorApp) { errorApp.style.visibility = 'visible'; }
                console.log('Loader hidden after local fallback');
              }, 500);
            }
            fallbackSucceeded = true; // mark success, skip error UI
          } catch (lf) {
            console.error('âŒ Local CSV fallback failed:', lf);
          }
          } else {
            console.log('ðŸ–¥ï¸ Desktop environment detected â€” skipping local CSV fallback');
          }
          
          if (!fallbackSucceeded) {
            // Ukryj loader nawet przy bÅ‚Ä™dzie
            const errorLoader = document.getElementById('custom-loader');
            if (errorLoader) {
              errorLoader.classList.add('fade-out');
              setTimeout(() => {
                errorLoader.style.display = 'none';
                const errorApp = document.getElementById('app');
                if (errorApp) {
                  errorApp.style.visibility = 'visible';
                }
                console.log('Loader hidden after error');
              }, 500);
            }
            
            // PokaÅ¼ komunikat bÅ‚Ä™du
            document.body.innerHTML = `
              <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
                <h2>Przerwa techniczna</h2>
                <p>Wracamy wkrÃ³tce.</p>
                <button onclick="window.location.reload()" style="padding: 10px 20px; margin-top: 20px;">
                  SprÃ³buj ponownie
                </button>
              </div>
            `;
          }
        }

setDefaultMaterialsFromSheet();
updateSummary();




      // Funkcja wypeÅ‚niania ikon w modal zamÃ³wienia
      function fillOrderSummaryIcons() {
        const orderSummaryIcons = document.getElementById('order-summary-icons');
        if (!orderSummaryIcons) return;
        
        orderSummaryIcons.innerHTML = '';
        
        // KolejnoÅ›Ä‡ elementÃ³w do podsumowania
        const partOrder = ['seat', 'backseat_inside', 'backseat_outside', 'legs_material', 'backseat'];
        
        // Ikonka modelu krzesÅ‚a
        if (selectedChair && (selectedChair.Obrazek || selectedChair.Image)) {
          const icon = document.createElement('img');
          icon.src = selectedChair.Obrazek || selectedChair.Image;
          icon.title = selectedChair.Nazwa;
          icon.style.cssText = `
            width: 60px;
            height: 60px;
            border-radius: 8px;
            border: 2px solid #F5C842;
            object-fit: contain;
            opacity: 1;
          `;
          orderSummaryIcons.appendChild(icon);
        }

        // Ikony wybranych materiaÅ‚Ã³w
        partOrder.forEach((partKey) => {
          const mat = selectedMaterials[partKey];
          if (mat && mat.Obrazek) {
            const icon = document.createElement('img');
            icon.src = mat.Obrazek;
            icon.title = mat.Nazwa;
            icon.style.cssText = `
              width: 45px;
              height: 45px;
              border-radius: 6px;
              border: 1px solid #ddd;
              object-fit: cover;
              margin-left: 4px;
              opacity: 1;
            `;
            orderSummaryIcons.appendChild(icon);
          }
        });

        // Ikona wybranego wariantu nÃ³g
        if (selectedLeg && selectedLeg.Obrazek) {
          const icon = document.createElement('img');
          icon.src = selectedLeg.Obrazek;
          icon.title = `Wariant stelaÅ¼a: ${selectedLeg.Nazwa}`;
          icon.style.cssText = `
            width: 45px;
            height: 45px;
            border-radius: 6px;
            border: 1px solid #ddd;
            object-fit: cover;
            margin-left: 4px;
            opacity: 1;
          `;
          orderSummaryIcons.appendChild(icon);
        }
      }

      function updateSummary() {
        const overviewButton = document.getElementById('config-overview-button');
        const popupIconsDiv = document.getElementById("popup-overview-icons");
        const popupDetailsDiv = document.getElementById("popup-overview-details");
        const popupTotalPriceSpan = document.getElementById("popup-overview-total-price");
        const popupTotalOriginal = document.getElementById("popup-total-original");
        const popupDiscountInfo = document.getElementById("popup-discount-info");
  const qrBtn = document.getElementById('qr-button'); // przycisk QR boczny

        // SprawdÅº czy elementy istniejÄ…
        if (!popupIconsDiv || !popupDetailsDiv || !popupTotalPriceSpan || !overviewButton) {
          console.warn('updateSummary: Required popup elements not found');
          return;
        }

        popupIconsDiv.innerHTML = '';
        popupDetailsDiv.innerHTML = '';
        popupTotalPriceSpan.textContent = `0.00 PLN`;
        popupTotalOriginal.style.display = 'none';
        popupDiscountInfo.style.display = 'none';

        // JeÅ›li nie byÅ‚o interakcji, ukryj przycisk
        if (!userInteracted) {
          overviewButton.style.display = 'none';
          if (qrBtn) qrBtn.style.display = 'none'; // brak interakcji => ukryj QR
          return;
        } else {
          overviewButton.style.display = 'flex';
        }

        // Kontrola widocznoÅ›ci przycisku QR â€“ tylko gdy wybrane krzesÅ‚o
        if (qrBtn) {
          if (selectedChair && selectedChair.Nazwa) {
            qrBtn.style.display = 'flex';
          } else {
            qrBtn.style.display = 'none';
          }
        }

        // KolejnoÅ›Ä‡ elementÃ³w do podsumowania
        const partOrder = ['seat', 'backseat_inside', 'backseat_outside', 'legs_material', 'backseat'];
        // Dla kubeÅ‚kÃ³w zamiast "Siedzisko/Oparcie" pokaÅ¼ "Obicie"
        const isBucketGroup = selectedChair && selectedChair.Grupa && selectedChair.Grupa.toLowerCase().includes('kube');
        const partLabels = ['Obicie', 'Oparcie wew.', 'Oparcie zew.', 'StelaÅ¼', isBucketGroup ? 'Obicie' : 'Siedzisko/Oparcie'];

        // Ikonka modelu
        if (userInteracted && selectedChair && (selectedChair.Obrazek || selectedChair.Image)) {
          const icon = document.createElement('img');
          icon.src = selectedChair.Obrazek || selectedChair.Image;
          icon.title = selectedChair.Nazwa;
          icon.style.cssText = `
            width: 70px;
            height: 70px;
            border-radius: 8px;
            border: 1px solid #ddd;
            object-fit: contain;
            opacity: 1;
          `;
          popupIconsDiv.appendChild(icon);
        }

        // Ikony wybranych materiaÅ‚Ã³w
        partOrder.forEach((partKey, idx) => {
          const mat = selectedMaterials[partKey];
          if (mat && mat.Obrazek) {
            const icon = document.createElement('img');
            icon.src = mat.Obrazek;
            icon.title = `${partLabels[idx]}: ${mat.Nazwa}`;
            icon.style.cssText = `
              width: 50px;
              height: 50px;
              border-radius: 6px;
              border: 1px solid #ddd;
              object-fit: cover;
              margin-left: 5px;
              opacity: 1;
            `;
            popupIconsDiv.appendChild(icon);
          }
        });

        // Ikona wybranego wariantu nÃ³g
        if (selectedLeg && selectedLeg.Obrazek) {
          const icon = document.createElement('img');
          icon.src = selectedLeg.Obrazek;
          icon.title = `Wariant stelaÅ¼a: ${selectedLeg.Nazwa}`;
          icon.style.cssText = `
            width: 50px;
            height: 50px;
            border-radius: 6px;
            border: 1px solid #ddd;
            object-fit: cover;
            margin-left: 5px;
            opacity: 1;
          `;
          popupIconsDiv.appendChild(icon);
        }

  // (UsuniÄ™to bÅ‚Ä™dnie wklejony kod renderowania kolekcji z updateSummary)

        // Oblicz ceny z promocjami
        let totalPrice = 0;
        let originalTotalPrice = 0;
        let hasDiscount = false;
        let discountAmount = 0;

        if (selectedChair && selectedChair.Cena) {
          const price = parseFloat(selectedChair.Cena) || 0;
          const hasPromotion = selectedChair.Promocja === 'TRUE' || selectedChair.Promocja === 'true' || 
                               selectedChair.Promocja === 'tak' || selectedChair.Promocja === 'âœ”';
          const procent = hasPromotion ? parseFloat(selectedChair.Procent) || 0 : 0;
          const isBestseller = selectedChair.Bestseller === 'TRUE' || selectedChair.Bestseller === 'true' || 
                              selectedChair.Bestseller === 'tak' || selectedChair.Bestseller === 'âœ”';
          
          originalTotalPrice += price;
          
          if (hasPromotion && procent > 0) {
            const discountedPrice = price * (1 - procent / 100);
            totalPrice += discountedPrice;
            hasDiscount = true;
            discountAmount = price - discountedPrice;
            
            const detailLine = document.createElement('div');
            detailLine.className = 'detail-item';
            detailLine.style.cssText = `
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin: 8px 0;
              padding: 8px;
              background: rgba(255, 107, 107, 0.05);
              border-radius: 6px;
              border-left: 3px solid #FF6B6B;
            `;
            
            const label = (selectedChair.Grupa && selectedChair.Grupa.toLowerCase() === 'krzesÅ‚o') ? 'KrzesÅ‚o' : 'Model';
            let extraInfo = '';
            if (isBestseller) {
              extraInfo += '<div style="font-size: 11px; color: #FFB800; font-weight: 600;">â­ Bestseller</div>';
            }
            extraInfo += '<div style="font-size: 11px; color: #28A745; font-weight: 600;">ðŸšš WysyÅ‚ka 24h</div>';
            
            detailLine.innerHTML = `
              <div>
                <div><span style="color:#000; font-weight:700;">${label}:</span> <span style="color:#444;">${selectedChair.Nazwa}</span></div>
                <div style="font-size: 12px; color: #FF6B6B; font-weight: 600;">ðŸ”¥ Promocja -${procent}%</div>
                ${extraInfo}
              </div>
              <div style="text-align: right;">
                <div style="color: #666; text-decoration: line-through; font-size: 13px;">${price.toFixed(2)} PLN</div>
                <div style="font-weight: 600; color: #FF6B6B;">${discountedPrice.toFixed(2)} PLN</div>
              </div>
            `;
            popupDetailsDiv.appendChild(detailLine);
          } else {
            totalPrice += price;
            const detailLine = document.createElement('div');
            detailLine.className = 'detail-item';
            detailLine.style.cssText = `
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin: 8px 0;
              padding: 8px;
              background: ${isBestseller ? 'rgba(255, 184, 0, 0.05)' : 'transparent'};
              border-radius: 6px;
              ${isBestseller ? 'border-left: 3px solid #FFB800;' : ''}
            `;
            const label = (selectedChair.Grupa && selectedChair.Grupa.toLowerCase() === 'krzesÅ‚o') ? 'KrzesÅ‚o' : 'Model';
            const bestsellerBadge = isBestseller ? '<div style="font-size: 11px; color: #FFB800; font-weight: 600; margin-top: 3px;">â­ Bestseller</div>' : '';
            
            detailLine.innerHTML = `
              <div>
                <span style="color:#000; font-weight:700;">${label}:</span> <span style="color:#444;">${selectedChair.Nazwa}</span>
                ${bestsellerBadge}
              </div>
              <strong style="font-size: 15px;">${price.toFixed(2)} PLN</strong>
            `;
            popupDetailsDiv.appendChild(detailLine);
          }
        }

        // MateriaÅ‚y i nogi
        partOrder.forEach((partKey, idx) => {
          const mat = selectedMaterials[partKey];
          if (mat) {
            const price = parseFloat(mat.Cena) || 0;
            totalPrice += price;
            originalTotalPrice += price;
            const detailLine = document.createElement('div');
            detailLine.className = 'detail-item';
            
            detailLine.style.cssText = `
              display: flex;
              justify-content: space-between;
              align-items: center;
              margin: 8px 0;
              font-size: 15px;
            `;
            detailLine.innerHTML = `
              <div style="display:flex; gap:6px; align-items:baseline;">
                <span style="color:#000; font-weight:700;">${partLabels[idx]}:</span>
                <span style="color:#444;">${mat.Nazwa}</span>
              </div>
              <strong>${price.toFixed(2)} PLN</strong>
            `;
            popupDetailsDiv.appendChild(detailLine);
          }
        });

        if (selectedLeg) {
          const price = parseFloat(selectedLeg.Cena) || 0;
          totalPrice += price;
          originalTotalPrice += price;
          const detailLine = document.createElement('div');
          detailLine.className = 'detail-item';
          detailLine.style.cssText = `
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 8px 0;
            font-size: 15px;
          `;
          detailLine.innerHTML = `
            <div style="display:flex; gap:6px; align-items:baseline;">
              <span style="color:#000; font-weight:700;">Wariant stelaÅ¼a:</span>
              <span style="color:#444;">${selectedLeg.Nazwa}</span>
            </div>
            <strong>${price.toFixed(2)} PLN</strong>
          `;
          popupDetailsDiv.appendChild(detailLine);
        }

        // PokaÅ¼ cenÄ™ z promocjÄ…
        popupTotalPriceSpan.textContent = `${totalPrice.toFixed(2)} PLN`;
        
        if (hasDiscount) {
          popupTotalOriginal.textContent = `${originalTotalPrice.toFixed(2)} PLN`;
          popupTotalOriginal.style.display = 'block';
          popupDiscountInfo.textContent = `OszczÄ™dzasz: ${discountAmount.toFixed(2)} PLN`;
          popupDiscountInfo.style.display = 'block';
        }

        // Eksportuj dla innych funkcji
        window.selectedChair = selectedChair;
        window.selectedLeg = selectedLeg;
        window.selectedMaterials = selectedMaterials;
      }
     


      function enforceZoomLimits() {
        if (viewer && viewer.controls) {
          viewer.controls.minDistance = MIN_ZOOM_DISTANCE;
          viewer.controls.maxDistance = MAX_ZOOM_DISTANCE;
          viewer.controls.enableDamping = true;
          viewer.controls.dampingFactor = 0.1;
          viewer.controls.update();
        }
      }

      function clampCameraDistance() {
        if (!viewer || !viewer.scene || !viewer.scene.mainCamera || !viewer.controls) return;
        const camera = viewer.scene.mainCamera;
        const target = viewer.controls.target;
        const pos = camera.position;
        const dist = pos.distanceTo(target);

        if (dist < MIN_ZOOM_DISTANCE) {
          // PrzesuÅ„ kamerÄ™ na sferÄ™ o promieniu MIN_ZOOM_DISTANCE od targetu
          const dir = pos.clone().sub(target).normalize();
          camera.position.copy(target.clone().add(dir.multiplyScalar(MIN_ZOOM_DISTANCE)));
          camera.updateProjectionMatrix();
          viewer.controls.update();
        }
        if (dist > MAX_ZOOM_DISTANCE) {
          // PrzesuÅ„ kamerÄ™ na sferÄ™ o promieniu MAX_ZOOM_DISTANCE od targetu
          const dir = pos.clone().sub(target).normalize();
          camera.position.copy(target.clone().add(dir.multiplyScalar(MAX_ZOOM_DISTANCE)));
          camera.updateProjectionMatrix();
          viewer.controls.update();
        }
      }


      // Nowa funkcja do ograniczeÅ„ zoomu w obrÄ™bie baÅ„ki
      function forceBubbleZoomLimitsEachFrame() {
        if (!viewer || !viewer.scene || !viewer.scene.mainCamera) return;
        const camera = viewer.scene.mainCamera;
        // Åšrodek baÅ„ki â€“ moÅ¼esz zmieniÄ‡ na inny punkt jeÅ›li trzeba
        const bubbleCenter = new Vector3(0, 0, 0);
        const pos = camera.position;
        const dist = pos.distanceTo(bubbleCenter);

        if (dist < MIN_ZOOM_DISTANCE) {
          const dir = pos.clone().sub(bubbleCenter).normalize();
          camera.position.copy(bubbleCenter.clone().add(dir.multiplyScalar(MIN_ZOOM_DISTANCE)));
          camera.updateProjectionMatrix();
          if (viewer.controls) viewer.controls.update();
        }
        if (dist > MAX_ZOOM_DISTANCE) {
          const dir = pos.clone().sub(bubbleCenter).normalize();
          camera.position.copy(bubbleCenter.clone().add(dir.multiplyScalar(MAX_ZOOM_DISTANCE)));
          camera.updateProjectionMatrix();
          if (viewer.controls) viewer.controls.update();
        }
      }

      // Uruchom sprawdzanie w kaÅ¼dej klatce
      function animateBubbleZoomLimit() {
        forceBubbleZoomLimitsEachFrame();
        requestAnimationFrame(animateBubbleZoomLimit);
      }
      animateBubbleZoomLimit();









      const exportButton = document.getElementById("export-config");
      const exportPanel = document.getElementById("export-panel");

      if (exportButton && exportPanel) {
        exportButton.addEventListener("click", () => {
          exportPanel.classList.toggle("hidden");
        });

        // Opcjonalnie â€“ ukrywanie po klikniÄ™ciu poza panelem
        document.addEventListener("click", (e) => {
          if (!exportPanel.contains(e.target) && !exportButton.contains(e.target)) {
            exportPanel.classList.add("hidden");
          }
        });

        // ObsÅ‚uga klikniÄ™Ä‡ eksportu (przykÅ‚adowo)
        document.querySelectorAll(".export-btn").forEach(btn => {
          btn.addEventListener("click", () => {
            const format = btn.dataset.format;
            alert(`Eksport jako: ${format.toUpperCase()}`);
            exportPanel.classList.add("hidden");
          });
        });
      }




      // â€” ObsÅ‚uga dolnego paska narzÄ™dziowego HDR

      function renderHDROptions(entries) {
        const container = document.getElementById('hdr-options');
        if (!container) return;
        container.innerHTML = '';

        entries.forEach(entry => {
          const img = document.createElement('img');
          img.src = entry.HDRIcon;
          img.alt = entry.Nazwa || entry.HDR;
          img.onerror = () => {
            img.src = 'icons/placeholder.svg';
          };

          const thumb = document.createElement('div');
          thumb.className = 'thumbnail';


          thumb.title = entry.Nazwa || entry.HDR;
          thumb.appendChild(img);
          thumb.onclick = () => {
            viewer.setEnvironmentMap(entry.HDR, { isHDR: true });
            document.getElementById('hdr-panel')?.classList.add('hidden');
          };

          const caption = document.createElement('div');
          caption.className = 'thumbnail-caption';
          caption.textContent = entry.Nazwa || entry.HDR;

          const wrapper = document.createElement('div');
          wrapper.className = 'thumbnail-wrapper';
          wrapper.appendChild(thumb);
          //wrapper.appendChild(caption);

          container.appendChild(wrapper);
        });
      }



      // Sterowanie widocznoÅ›ciÄ… panelu

      // Sterowanie widocznoÅ›ciÄ… panelu
      window.addEventListener('DOMContentLoaded', () => {
        const hdrToggle = document.getElementById('hdr-toggle');
        const hdrPanel = document.getElementById('hdr-panel');
        const hdrClose = document.getElementById('hdr-close');

        function toggleHDRPanel() {
          hdrPanel.classList.toggle('hidden');
          hdrPanel.style.display = hdrPanel.classList.contains('hidden') ? 'none' : 'block';
        }

        hdrToggle?.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleHDRPanel();
        });

        hdrPanel?.addEventListener('click', (e) => {
          e.stopPropagation();
        });

        document.addEventListener('click', (e) => {
          // If brightness just closed, ignore this global click
          if (window.__justClosedBrightness && Date.now() - window.__justClosedBrightness < 120) return;
          hdrPanel?.classList.add('hidden');
          if (hdrPanel) hdrPanel.style.display = 'none';
        });

        hdrClose?.addEventListener('click', (e) => {
          e.stopPropagation();
          hdrPanel?.classList.add('hidden');
          if (hdrPanel) hdrPanel.style.display = 'none';
        });
      });

      // Ensure one global body-level dismiss layer exists
      function ensureBrightnessDismissLayer() {
        let el = document.getElementById('brightness-dismiss-layer');
        if (!el) {
          el = document.createElement('div');
          el.id = 'brightness-dismiss-layer';
          el.setAttribute('aria-hidden', 'true');
          document.body.appendChild(el);
        } else if (el.parentElement !== document.body) {
          document.body.appendChild(el);
        }
        // Helper: mark that brightness was just closed (used to ignore global click handlers briefly)
        function __setJustClosedBrightness() {
          try { window.__justClosedBrightness = Date.now(); } catch(_) {}
        }
        if (!el._handlerBound) {
          const handler = (evt) => {
            const panel = document.getElementById('brightness-panel');
            if (!panel) return;
            const isVisible = panel.style.display !== 'none' && !panel.classList.contains('hidden');
            if (!isVisible) return;
            panel.classList.add('hidden');
            panel.style.display = 'none';
            el.classList.remove('mobile-active');
            __setJustClosedBrightness();
            evt.stopPropagation();
          };
          el.addEventListener('click', handler);
          el.addEventListener('touchstart', handler, { passive: false });
          el._handlerBound = true;
        }
        return el;
      }

      // Modyfikacja przycisku HDR Å¼eby pokazywaÅ‚ panel jasnoÅ›ci
      document.getElementById('hdr-toggle')?.addEventListener('click', (e) => {
        e.stopPropagation();
        const panel = document.getElementById('brightness-panel');
        const dismiss = ensureBrightnessDismissLayer();
        panel.classList.toggle('hidden');
        panel.style.display = panel.classList.contains('hidden') ? 'none' : 'block';
        
        // Dodaj obsÅ‚ugÄ™ suwaka po pokazaniu panelu
        if (!panel.classList.contains('hidden')) {
          // Enable dismiss layer (mobile only via CSS)
          if (dismiss) dismiss.classList.add('mobile-active');
          const brightnessSlider = document.getElementById('brightness-slider');
          if (brightnessSlider) {
            // UsuÅ„ stary listener jeÅ›li istnieje
            brightnessSlider.removeEventListener('input', handleBrightnessChange);
            // Dodaj nowy listener
            brightnessSlider.addEventListener('input', handleBrightnessChange);
            console.log('âœ… Brightness slider listener added');
          }

          // Initialize custom mobile slider wiring
          setupMobileBrightnessSlider();
        }
        else {
          // Disable dismiss layer when panel closes
          if (dismiss) dismiss.classList.remove('mobile-active');
        }
      });

      // Funkcja obsÅ‚ugi zmiany jasnoÅ›ci
      function handleBrightnessChange(e) {
        const brightnessValue = parseFloat(e.target.value);
        console.log('ðŸŒŸ Changing brightness to:', brightnessValue);
        
        if (viewer) {
          let lightFound = false;
          
          // Method 1: HDR Environment Intensity - najwaÅ¼niejsze dla oÅ›wietlenia HDR
          if (viewer.scene && viewer.scene.environment) {
            // Ustaw intensywnoÅ›Ä‡ mapy Å›rodowiska HDR
            if (viewer.scene.environment.mapping !== undefined) {
              viewer.scene.environmentIntensity = brightnessValue;
              console.log('âœ… Scene environment intensity set to:', brightnessValue);
              lightFound = true;
            }
            
            // Alternatywnie przez renderer
            if (viewer.renderer && viewer.renderer.toneMappingExposure !== undefined) {
              viewer.renderer.toneMappingExposure = brightnessValue;
              console.log('âœ… Tone mapping exposure set to:', brightnessValue);
              lightFound = true;
            }
          }
          
          // Method 2: WebGI/ThreePipe specific HDR intensity
          if (viewer.environment && typeof viewer.environment.setIntensity === 'function') {
            viewer.environment.setIntensity(brightnessValue);
            console.log('âœ… Environment intensity via setIntensity:', brightnessValue);
            lightFound = true;
          }
          
          // Method 3: BezpoÅ›rednia kontrola HDR poprzez environmentMap
          if (viewer.scene && viewer.scene.environment && viewer.scene.environment.intensity !== undefined) {
            viewer.scene.environment.intensity = brightnessValue;
            console.log('âœ… Direct environment map intensity set to:', brightnessValue);
            lightFound = true;
          }
          
          // Method 4: Zmiana intensywnoÅ›ci wszystkich Å›wiateÅ‚ w scenie
          if (viewer.scene) {
            viewer.scene.traverse((child) => {
              if (child.isLight) {
                if (child.userData.originalIntensity === undefined) {
                  child.userData.originalIntensity = child.intensity || 1;
                }
                child.intensity = child.userData.originalIntensity * brightnessValue;
                console.log('âœ… Scene light intensity updated:', child.type, child.intensity);
                lightFound = true;
              }
            });
          }
          
          // Method 5: Renderer tone mapping dla globalnego oÅ›wietlenia
          if (viewer.renderer) {
            viewer.renderer.toneMappingExposure = brightnessValue;
            console.log('âœ… Renderer tone mapping exposure updated:', brightnessValue);
            lightFound = true;
          }
          
          // Method 6: ThreePipe specific environment controls
          if (viewer.renderManager && viewer.renderManager.renderer) {
            viewer.renderManager.renderer.toneMappingExposure = brightnessValue;
            console.log('âœ… RenderManager tone mapping exposure set:', brightnessValue);
            lightFound = true;
          }
          
          // WymuÅ› przerenderowanie sceny
          if (viewer.setDirty && typeof viewer.setDirty === 'function') {
            viewer.setDirty();
          } else if (viewer.needsUpdate !== undefined) {
            viewer.needsUpdate = true;
          }
          
          console.log('ðŸ”„ Brightness change completed. Method found:', lightFound);
        }
      }

      // ===== Mobile custom slider wiring =====
      function setupMobileBrightnessSlider() {
        const container = document.getElementById('brightness-slider-mobile');
        const thumb = container?.querySelector('.thumb');
        const native = document.getElementById('brightness-slider');
        if (!container || !thumb || !native) return;

        const min = parseFloat(native.min) || 0.2;
        const max = parseFloat(native.max) || 2.0;
        const step = parseFloat(native.step) || 0.1;

        const getH = () => container.clientHeight; // 130px by CSS

        function valueToY(val) {
          const t = (val - min) / (max - min);
          const y = (1 - t) * getH();
          return Math.min(Math.max(y, 0), getH());
        }

        function yToValue(y) {
          const clamped = Math.min(Math.max(y, 0), getH());
          const t = 1 - clamped / getH();
          let val = min + t * (max - min);
          const steps = Math.round((val - min) / step);
          val = min + steps * step;
          return Math.min(Math.max(val, min), max);
        }

        function setThumbByValue(val) {
          const y = valueToY(val);
          thumb.style.top = `${y}px`;
          container.setAttribute('aria-valuenow', String(val.toFixed(2)));
        }

        function setValue(val) {
          native.value = String(val);
          const evt = new Event('input', { bubbles: true });
          native.dispatchEvent(evt);
          setThumbByValue(val);
        }

        // Initialize from current value
        setThumbByValue(parseFloat(native.value));

        let dragging = false;

        function onPointerDown(e) {
          dragging = true;
          e.preventDefault();
          handleMove(e);
        }

        function handleMove(e) {
          const rect = container.getBoundingClientRect();
          const clientY = (e.touches ? e.touches[0].clientY : e.clientY);
          const y = clientY - rect.top;
          const val = yToValue(y);
          setValue(val);
        }

        function onPointerMove(e) {
          if (!dragging) return;
          e.preventDefault();
          handleMove(e);
        }

        function onPointerUp(e) {
          if (!dragging) return; // don't block outside taps
          dragging = false;
          e.preventDefault();
        }

        // Remove any previous listeners
        if (container._removeMobileSliderListeners) container._removeMobileSliderListeners();

        container.addEventListener('mousedown', onPointerDown, { passive: false });
        container.addEventListener('touchstart', onPointerDown, { passive: false });
        window.addEventListener('mousemove', onPointerMove, { passive: false });
        window.addEventListener('touchmove', onPointerMove, { passive: false });
        window.addEventListener('mouseup', onPointerUp, { passive: false });
        window.addEventListener('touchend', onPointerUp, { passive: false });

        container._removeMobileSliderListeners = () => {
          container.removeEventListener('mousedown', onPointerDown);
          container.removeEventListener('touchstart', onPointerDown);
          window.removeEventListener('mousemove', onPointerMove);
          window.removeEventListener('touchmove', onPointerMove);
          window.removeEventListener('mouseup', onPointerUp);
          window.removeEventListener('touchend', onPointerUp);
        };

        // Sync thumb if native changes via other paths
        native.addEventListener('input', () => setThumbByValue(parseFloat(native.value)));
      }

      // Zamknij panel jasnoÅ›ci po klikniÄ™ciu poza nim (capture to prevent other closers)
    document.addEventListener('click', (e) => {
        const brightnessPanel = document.getElementById('brightness-panel');
        const hdrToggle = document.getElementById('hdr-toggle');
        const dismiss = document.getElementById('brightness-dismiss-layer');
        if (!brightnessPanel) return;
        const isVisible = brightnessPanel.style.display !== 'none' && !brightnessPanel.classList.contains('hidden');
        if (!isVisible) return; // nie przechwytuj klikÃ³w gdy panel i tak jest ukryty
        
        // If the dismiss layer is clicked, treat as outside tap but do not close the whole UI
        const tappedDismissLayer = dismiss && dismiss.contains(e.target);
        if (tappedDismissLayer || (!brightnessPanel.contains(e.target) && e.target !== hdrToggle && !hdrToggle.contains(e.target))) {
          brightnessPanel.classList.add('hidden');
          brightnessPanel.style.display = 'none';
          // Disable dismiss layer after first outside tap
          if (dismiss) dismiss.classList.remove('mobile-active');
      try { window.__justClosedBrightness = Date.now(); } catch(_) {}
          // Zatrzymaj propagacjÄ™, Å¼eby nie zamykaÄ‡ caÅ‚ego UI tym samym tapniÄ™ciem
          e.stopPropagation();
        }
      }, { capture: true });

      // Mobile: also close on touchstart outside for faster response (capture + non-passive)
    document.addEventListener('touchstart', (e) => {
        const brightnessPanel = document.getElementById('brightness-panel');
        const hdrToggle = document.getElementById('hdr-toggle');
        const dismiss = document.getElementById('brightness-dismiss-layer');
        if (!brightnessPanel) return;
        const isVisible = brightnessPanel.style.display !== 'none' && !brightnessPanel.classList.contains('hidden');
        if (!isVisible) return; // nie przechwytuj tapniÄ™Ä‡ gdy panel jest ukryty
        const tappedDismissLayer = dismiss && dismiss.contains(e.target);
        if (tappedDismissLayer || (!brightnessPanel.contains(e.target) && e.target !== hdrToggle && !hdrToggle.contains(e.target))) {
          brightnessPanel.classList.add('hidden');
          brightnessPanel.style.display = 'none';
          if (dismiss) dismiss.classList.remove('mobile-active');
      try { window.__justClosedBrightness = Date.now(); } catch(_) {}
          // Zatrzymaj propagacjÄ™, Å¼eby nie zamykaÄ‡ caÅ‚ego UI tym samym tapniÄ™ciem
          e.stopPropagation();
          // On mobile, a synthetic click often follows touchstart; block the next capture click if within 200ms
          const blockNextClick = (ce) => {
            if (window.__justClosedBrightness && Date.now() - window.__justClosedBrightness < 200) {
              ce.stopPropagation();
              ce.preventDefault?.();
            }
            document.removeEventListener('click', blockNextClick, true);
          };
          document.addEventListener('click', blockNextClick, true);
        }
      }, { passive: false, capture: true });

      // Panel wymiarÃ³w
      document.getElementById('dimensions-show')?.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log("ðŸ“ KlikniÄ™to przycisk wymiarÃ³w");
        showDimensions();
      });

      // Zamykanie panelu wymiarÃ³w klikniÄ™ciem poza panelem
      document.addEventListener('click', (e) => {
        if (window.__justClosedBrightness && Date.now() - window.__justClosedBrightness < 120) return;
        const dimensionOverlay = document.getElementById('dimension-overlay');
        const dimensionsButton = document.getElementById('dimensions-show');
        
        if (dimensionOverlay && 
            dimensionOverlay.style.display === 'block' && 
            !dimensionOverlay.contains(e.target) && 
            !dimensionsButton.contains(e.target)) {
          dimensionOverlay.style.display = 'none';
        }
      });

      // Zapobieganie zamykaniu przy klikniÄ™ciu wewnÄ…trz panelu
      document.getElementById('dimension-overlay')?.addEventListener('click', (e) => {
        e.stopPropagation();
      });

      // QR Code popup
      document.getElementById('qr-button')?.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log("ðŸ“± KlikniÄ™to przycisk QR");
        
        const qrPopup = document.getElementById('qr-popup');
        const qrContainer = document.getElementById('qrcode');
        if (!qrPopup || !qrContainer) {
          console.error("Nie znaleziono elementÃ³w QR popup");
          return;
        }

        qrPopup.style.display = 'block';
        qrContainer.innerHTML = '';

        new QRCode(qrContainer, {
          text: window.location.href,
          width: 200,
          height: 200,
        });
      });

      // Zamykanie QR popup klikniÄ™ciem na przycisk zamkniÄ™cia
      document.getElementById('qr-close-btn')?.addEventListener('click', () => {
        document.getElementById('qr-popup').style.display = 'none';
      });

      // Zamykanie QR popup klikniÄ™ciem poza panelem
      document.addEventListener('click', (e) => {
        if (window.__justClosedBrightness && Date.now() - window.__justClosedBrightness < 120) return;
        const qrPopup = document.getElementById('qr-popup');
        const qrButton = document.getElementById('qr-button');
        
        if (qrPopup && 
            qrPopup.style.display === 'block' && 
            !qrPopup.contains(e.target) && 
            !qrButton.contains(e.target)) {
          qrPopup.style.display = 'none';
        }
      });

      // Zapobieganie zamykaniu przy klikniÄ™ciu wewnÄ…trz QR popup
      document.getElementById('qr-popup')?.addEventListener('click', (e) => {
        e.stopPropagation();
      });

      // === AR popup helpers and outside-to-dismiss ===
      window.openArPopup = function openArPopup() {
  // Hide QR popup if visible to avoid overlapping popups
  const qr = document.getElementById('qr-popup');
  if (qr) qr.style.display = 'none';
  const popup = document.getElementById('ar-popup');
  if (!popup) return;
        popup.style.display = 'block';
      };

      window.closeArPopup = function closeArPopup() {
        const popup = document.getElementById('ar-popup');
        if (!popup) return;
        popup.style.display = 'none';
      };

      // Close AR popup on outside tap/click (but ignore the synthetic click after brightness close)
      document.addEventListener('click', (e) => {
        if (window.__justClosedBrightness && Date.now() - window.__justClosedBrightness < 120) return;
        const arPopup = document.getElementById('ar-popup');
        const arButtonEl = document.getElementById('ar-button');
        if (!arPopup) return;
        if (arPopup.style.display === 'block' && !arPopup.contains(e.target) && (!arButtonEl || !arButtonEl.contains(e.target))) {
          closeArPopup();
        }
      }, { capture: true });

      // Prevent closing when clicking inside AR popup
      document.getElementById('ar-popup')?.addEventListener('click', (e) => {
        e.stopPropagation();
      });

      // Bind toolbar AR button to show "coming soon" popup (disable AR flow)
      const arToolbarBtn = document.getElementById('ar-button');
      if (arToolbarBtn) {
        arToolbarBtn.addEventListener('click', (e) => {
          e.stopPropagation();
          openArPopup();
        });
      }

      // === AR MVP helpers ===
      function isIOS() {
        return /iPad|iPhone|iPod/.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      }
      function isAndroid() { return /Android/.test(navigator.userAgent); }
      function isDesktop() { return !(isIOS() || isAndroid()); }

      // Return current model assets for AR, with rich candidate lists sorted by best name match
      function getCurrentArAssets() {
        // Prefer live selectedChair var; fallback to window.selectedChair
        const curChair = (typeof selectedChair !== 'undefined' && selectedChair && selectedChair.Nazwa) ? selectedChair : window.selectedChair;
        const raw = (curChair?.Nazwa || '').trim();
        if (!raw) return { glb: null, glbCandidates: [], usdzCandidates: [] };
        const strip = (s)=> (typeof stripBrackets==='function'? stripBrackets(s): s);
        const baseRaw = strip(raw);
        const norm = (s)=> s
          .normalize?.('NFD').replace(/\p{Diacritic}/gu,'')
          .replace(/[^\w\s-]/g,'').trim();
        const baseClean = norm(baseRaw);
        const bases = Array.from(new Set([
          baseClean,
          baseClean.replace(/\s+/g,''),
          baseClean.replace(/\s+/g,'-'),
          baseClean.replace(/\s+/g,'_')
        ].filter(Boolean)));

        // Generate candidate paths preserving order of best match first
        const glbCandidates = [];
        const usdzCandidates = [];
        const dirs = ['chairs','models'];
        for (const dir of dirs) {
          for (const b of bases) {
            glbCandidates.push(`${dir}/${b}.glb`);
            // common duplicate naming like "-2"
            glbCandidates.push(`${dir}/${b}-2.glb`);
            usdzCandidates.push(`${dir}/${b}.usdz`);
            usdzCandidates.push(`${dir}/${b}-2.usdz`);
          }
        }
  // No generic fallback here; we want the chosen chair or a clear error
        return {
          glb: glbCandidates[0] || null,
          glbCandidates,
          usdzCandidates
        };
      }

  // Build an ar.html URL with current model encoded as ?model=
  function buildArHtmlUrl() {
        try {
          const url = new URL('ar.html', window.location.href);
          if (typeof getCurrentArAssets === 'function') {
            const a = getCurrentArAssets();
    let model = (a && (a.glb || a.glbPath || a.gltf || a.usdzPath)) || null;
            if (!model && a && Array.isArray(a.usdzCandidates) && a.usdzCandidates.length) {
              model = a.usdzCandidates[0];
            }
            if (model) url.searchParams.set('model', model);
          }
          return url.toString();
        } catch (e) {
          return 'ar.html';
        }
      }

      // Prefer resolving an actually existing asset (Android: GLB; iOS: USDZ; else GLB->USDZ)
    async function buildArHtmlUrlAsync() {
        try {
      const url = new URL('ar.html', window.location.href);
          const assets = (typeof getCurrentArAssets === 'function') ? getCurrentArAssets() : null;
          const headOk = async (p) => {
            try {
              const abs = new URL(p, window.location.href).toString();
              const r = await fetch(abs, { method: 'HEAD' });
              return r.ok;
            } catch { return false; }
          };
          let chosen = null;

          // Platform-specific model selection for WebXR
          const preferUSDZ = (typeof isIOS === 'function') ? isIOS() : false;
          const preferGLB = (typeof isAndroid === 'function') ? isAndroid() : !preferUSDZ;

          if (preferGLB) {
            // Android: prefer GLB first
            const glbList = Array.isArray(assets?.glbCandidates) ? assets.glbCandidates : (assets?.glb ? [assets.glb] : []);
            for (const g of glbList) { if (await headOk(g)) { chosen = g; break; } }
            if (!chosen && Array.isArray(assets?.usdzCandidates)) {
              for (const u of assets.usdzCandidates) { if (await headOk(u)) { chosen = u; break; } }
            }
          } else if (preferUSDZ) {
            // iOS: prefer USDZ first for Quick Look
            if (Array.isArray(assets?.usdzCandidates)) {
              for (const u of assets.usdzCandidates) { 
                console.log('Checking USDZ candidate:', u);
                if (await headOk(u)) { 
                  chosen = u; 
                  console.log('Selected USDZ for iOS:', u);
                  break; 
                } 
              }
            }
            // Fallback to GLB if no USDZ
            if (!chosen) {
              const glbList = Array.isArray(assets?.glbCandidates) ? assets.glbCandidates : (assets?.glb ? [assets.glb] : []);
              for (const g of glbList) { if (await headOk(g)) { chosen = g; break; } }
            }
          }
          
          if (chosen) {
            url.searchParams.set('model', chosen);
            console.log('Selected model for AR:', chosen);
          } else {
            const curChair = (typeof selectedChair !== 'undefined' && selectedChair && selectedChair.Nazwa) ? selectedChair : window.selectedChair;
            console.warn('No model found for chair:', curChair?.Nazwa);
          }
          return url.toString();
        } catch(e) { 
          console.error('Error building AR URL:', e);
          return 'ar.html'; 
        }
      }

      function buildSceneViewerUrl(glbUrl) {
        const curChair = (typeof selectedChair !== 'undefined' && selectedChair && selectedChair.Nazwa) ? selectedChair : window.selectedChair;
        const title = encodeURIComponent(curChair?.Nazwa || 'Model');
        const file = encodeURIComponent(new URL(glbUrl, window.location.href).toString());
        let backLink = '';
        try {
          const u = new URL(window.location.href);
          u.searchParams.delete('open_ar');
          // Mark return for post-AR overlay
          u.searchParams.set('ar_return', '1');
          backLink = encodeURIComponent(u.toString());
        } catch { backLink = encodeURIComponent(window.location.href); }
        // Add link param so Scene Viewer shows a bottom-left CTA chip to return
        return `https://arvr.google.com/scene-viewer/1.0?file=${file}&mode=ar_only&title=${title}&link=${backLink}`;
      }
      function buildQuickLookUrl(usdzUrl) {
        // Build iOS Quick Look URL with custom CTA back to configurator
        const abs = new URL(usdzUrl, window.location.href);
        // Preserve existing hash params and append/override Quick Look ones
        const hashParams = new URLSearchParams(abs.hash ? abs.hash.slice(1) : '');
        let returnUrl = (() => {
          try {
            const u = new URL(window.location.href);
            u.searchParams.delete('open_ar');
            return u.toString();
          } catch { return window.location.href; }
        })();
        try {
          const u2 = new URL(returnUrl);
          u2.searchParams.set('ar_return', '1');
          returnUrl = u2.toString();
        } catch {}
        hashParams.set('callToAction', 'PowrÃ³t do konfiguratora');
        hashParams.set('link', returnUrl);
        abs.hash = hashParams.toString();
        return abs.toString();
      }
      function buildArLandingUrl() {
        // Desktop QR should point to dedicated ar.html with model param
        return buildArHtmlUrl();
      }
      function showQrWithUrl(url) {
        const qrPopup = document.getElementById('qr-popup');
        const qrContainer = document.getElementById('qrcode');
        if (!qrPopup || !qrContainer) return;
        qrPopup.style.display = 'block';
        qrContainer.innerHTML = '';
        new QRCode(qrContainer, { text: url, width: 200, height: 200 });
      }

      async function openArFlow() {
        try {
          // Ensure a chair is selected
          const curChair = (typeof selectedChair !== 'undefined' && selectedChair && selectedChair.Nazwa) ? selectedChair : window.selectedChair;
          if (!curChair?.Nazwa) {
            alert('Najpierw wybierz krzesÅ‚o z konfiguratora');
            return;
          }

          // Resolve best-available asset for platform without HEAD latency
          const assets = (typeof getCurrentArAssets === 'function') ? getCurrentArAssets() : null;
          const glb = assets?.glb || (Array.isArray(assets?.glbCandidates) ? assets.glbCandidates[0] : null);
          const usdz = Array.isArray(assets?.usdzCandidates) ? assets.usdzCandidates[0] : null;

          if (typeof isAndroid === 'function' && isAndroid()) {
            if (glb) { window.location.href = buildSceneViewerUrl(glb); return; }
          }
          if (typeof isIOS === 'function' && isIOS()) {
            // Use a Quick Look anchor to ensure it executes in the user gesture context
            if (usdz) {
              const link = document.createElement('a');
              link.setAttribute('rel', 'ar');
              link.setAttribute('href', buildQuickLookUrl(usdz));
              document.body.appendChild(link);
              // iOS can sometimes ignore programmatic clicks; add a safety fallback
              let navigated = false;
              const mark = () => { navigated = true; };
              window.addEventListener('pagehide', mark, { once: true });
              document.addEventListener('visibilitychange', () => {
                if (document.visibilityState !== 'visible') navigated = true;
              }, { once: true });
              link.click();
              setTimeout(() => {
                try { link.remove(); } catch(_){ }
                if (!navigated) {
                  const url = (typeof buildArHtmlUrl === 'function') ? buildArHtmlUrl() : 'ar.html';
                  window.location.href = url;
                }
              }, 900);
              return;
            }
          }

          // Fallback: open landing page that routes to native AR
          const url = (typeof buildArHtmlUrl === 'function') ? buildArHtmlUrl() : 'ar_viewer.html';
          window.location.href = url;
        } catch (e) {
          console.warn('openArFlow error:', e);
          try { openArPopup(); } catch {}
        }
      }

  // Inline WebXR removed for reliability. If needed later, we can re-enable it behind a feature flag.

      // Auto-open AR on mobile when landing from desktop QR
      (function handleArLanding() {
        try {
          const url = new URL(window.location.href);
          if (url.searchParams.get('open_ar') === '1' && (isAndroid() || isIOS())) {
            // remove the param to avoid loops on back
            url.searchParams.delete('open_ar');
            window.history.replaceState({}, '', url.toString());
            // AR disabled for now â€” show info popup instead of launching
            if (typeof openArPopup === 'function') openArPopup();
          }
        } catch {}
      })();

      // ===== Mobile AR (WebXR on Android GLB, Quick Look on iOS USDZ) =====
  async function ensureModelViewerScript() {
        try {
          if (window.customElements && window.customElements.get && window.customElements.get('model-viewer')) return;
          if (document.getElementById('__mv_script')) return;
          await new Promise((resolve, reject) => {
            const s = document.createElement('script');
            s.id = '__mv_script';
            s.type = 'module';
            s.src = 'https://cdn.jsdelivr.net/npm/@google/model-viewer@v3.3.0/dist/model-viewer.min.js';
            s.onload = resolve;
            s.onerror = () => reject(new Error('model-viewer failed to load'));
            document.head.appendChild(s);
          });
        } catch (_) {}
      }

      function toAbsUrl(pathOrUrl) {
        try { return new URL(pathOrUrl, window.location.href).toString(); } catch { return pathOrUrl; }
      }

  // (Legacy AR overlays removed; using shared model loader UI.)

      // Ensure a single hidden model-viewer used to launch AR (Android/iOS)
      function ensureUnifiedArModelViewer() {
        let mv = document.getElementById('__mv_ar_unified');
        if (!mv) {
          // Ensure our DOM overlay exists first so we can reference it in xr-session-init
          const overlayRoot = ensureArDomOverlay();
          mv = document.createElement('model-viewer');
          mv.id = '__mv_ar_unified';
          mv.setAttribute('ar', '');
          // Prefer WebXR but keep native fallbacks available (Scene Viewer/Quick Look)
          mv.setAttribute('ar-modes', 'webxr scene-viewer quick-look');
          mv.setAttribute('ar-placement', 'floor');
          // Request DOM overlay and hit-test for WebXR sessions; bind overlay root
          try {
            const xrInit = {
              requiredFeatures: ['hit-test'],
              optionalFeatures: ['dom-overlay','unbounded'],
              domOverlay: { root: '#' + (overlayRoot?.id || '__ar_dom_overlay') }
            };
            mv.setAttribute('xr-session-init', JSON.stringify(xrInit));
          } catch(_) {}
          mv.setAttribute('reveal', 'manual');
          mv.setAttribute('shadow-intensity', '0.8');
          mv.setAttribute('style', 'position:fixed;left:-9999px;top:-9999px;width:1px;height:1px;opacity:0;pointer-events:none;');
          // Loader progress hook
          const onProgress = (ev) => {
            const p = ev?.detail?.totalProgress;
            if (typeof p === 'number' && p >= 0 && p <= 1) {
              try { updateModelLoaderProgress(6 + Math.round(p * 88)); } catch(_) {}
            }
          };
          const onArStatus = (ev) => {
            const s = ev?.detail?.status || '';
            // Keep loader until AR session actually starts or fails.
            // Do NOT hide on 'not-presenting' because on Android it can fire before Scene Viewer opens.
            if (s === 'session-started' || s === 'failed') {
              try { hideModelLoader(); } catch(_) {}
            }
            // Toggle our DOM overlay when using WebXR
            try {
              const overlay = document.getElementById('__ar_dom_overlay') || ensureArDomOverlay();
              if (s === 'session-started') {
                overlay.style.display = 'block';
              }
              if (s === 'not-presenting' || s === 'failed') {
                overlay.style.display = 'none';
              }
            } catch(_) {}
          };
          mv.addEventListener('progress', onProgress);
          mv.addEventListener('ar-status', onArStatus);
          // iOS Quick Look: hide loader when the page is backgrounded
          const onVis = () => { if (document.visibilityState !== 'visible') { try { hideModelLoader(); } catch(_) {} } };
          document.addEventListener('visibilitychange', onVis);
          window.addEventListener('pagehide', () => { try { hideModelLoader(); } catch(_) {} }, { once: true });
          document.body.appendChild(mv);
        }
        return mv;
      }

      // After changing src/ios-src, wait briefly so model-viewer refreshes its AR link (prevents using previous model)
      async function __waitForArAnchorRefresh(mv, { timeoutMs = 900 } = {}) {
        try {
          // Prefer updateComplete when available (Lit)
          const upd = mv?.updateComplete;
          const waitUpdate = (upd && typeof upd.then === 'function')
            ? upd.catch(()=>{})
            : new Promise(res => requestAnimationFrame(() => requestAnimationFrame(res)));
          const waitLoadOrTimeout = new Promise(res => {
            let done = false;
            const to = setTimeout(() => { if (!done) { done = true; res(); } }, timeoutMs);
            const onLoad = () => { if (!done) { done = true; clearTimeout(to); res(); } };
            mv?.addEventListener('load', onLoad, { once: true });
          });
          await Promise.race([waitUpdate, waitLoadOrTimeout]);
        } catch(_) {}
      }

      // Custom AR back button (Android WebXR)
      function ensureArBackButton(){
        let btn = document.getElementById('ar-back-button');
        if (!btn) {
          btn = document.createElement('button');
          btn.id = 'ar-back-button';
          btn.textContent = 'PowrÃ³t do konfiguratora';
          btn.style.cssText = 'position:fixed;top:14px;left:14px;z-index:999999;display:none;background:#F5C842;color:#333;border:none;border-radius:24px;padding:10px 16px;font-weight:600;font-family:Poppins,sans-serif;box-shadow:0 4px 16px rgba(0,0,0,0.2);';
          document.body.appendChild(btn);
        }
        return btn;
      }

      // DOM Overlay for AR (WebXR) â€” custom UI inside AR view (Android only)
      function ensureArDomOverlay(){
        let root = document.getElementById('__ar_dom_overlay');
        if (!root) {
          root = document.createElement('div');
          root.id = '__ar_dom_overlay';
          // Fullscreen overlay; let only our controls accept input
          root.style.cssText = 'position:fixed;inset:0;z-index:2147483647;display:none;pointer-events:none;'
            + 'font-family:Poppins,system-ui,Segoe UI,Roboto,Arial,sans-serif;';
          // Bottom-left UI group
          const bl = document.createElement('div');
          bl.id = '__ar_ui_bottom_left';
          bl.style.cssText = 'position:absolute;left:12px;bottom:12px;display:flex;gap:10px;align-items:center;pointer-events:auto;';
          // Back tile button
          const back = document.createElement('button');
          back.id = '__ar_ui_back';
          back.type = 'button';
          back.textContent = 'PowrÃ³t do konfiguratora';
          back.style.cssText = 'background:#F5C842;color:#333;border:none;border-radius:18px;padding:12px 16px;'
            + 'font-weight:800;box-shadow:0 10px 30px rgba(0,0,0,.35);letter-spacing:.2px;';
          bl.appendChild(back);
          // Optional: placeholder tile (expand later)
          const info = document.createElement('div');
          info.id = '__ar_ui_hint';
          info.textContent = '';
          info.style.cssText = 'color:white;text-shadow:0 1px 2px rgba(0,0,0,.6);font-size:12px;font-weight:600;opacity:.9;';
          // Preview-close (visible only in preview mode)
          const closePrev = document.createElement('button');
          closePrev.id = '__ar_ui_preview_close';
          closePrev.type = 'button';
          closePrev.textContent = 'Zamknij podglÄ…d';
          closePrev.style.cssText = 'position:absolute;top:12px;right:12px;background:#111;color:#fff;opacity:.9;'
            + 'border:none;border-radius:12px;padding:8px 12px;font-weight:700;pointer-events:auto;display:none;';
          closePrev.addEventListener('click', (e)=>{
            e.preventDefault(); e.stopPropagation();
            hideArOverlayPreview();
          });
          // Add groups
          root.appendChild(bl);
          root.appendChild(info);
          root.appendChild(closePrev);
          document.body.appendChild(root);

          // Behavior: back exits WebXR session if active
          back.addEventListener('click', (e) => {
            e.preventDefault(); e.stopPropagation();
            try {
              const mv = document.getElementById('__mv_ar_unified');
              // Try ending XR session when available (non-public, best-effort)
              const anyMv = mv;
              const xrSession = anyMv && (anyMv.xrSession || anyMv[$$?.xrSession]);
              if (xrSession && typeof xrSession.end === 'function') {
                xrSession.end();
              } else {
                // Fallback: hide overlay; system/native UI may provide exit
                root.style.display = 'none';
              }
            } catch(_) {}
          });
        }
        return root;
      }

  // Overlay preview and DOM overlay removed for simplified AR UX

  // Pre-/Post-AR overlays removed per UX requirement

  async function openArWebXRMobile() {
  try {
    showModelLoader('Uruchamianie trybu AR...');
    updateModelLoaderProgress(0);
  } catch(_) {}
        const curChair = (typeof selectedChair !== 'undefined' && selectedChair && selectedChair.Nazwa) ? selectedChair : window.selectedChair;
        if (!curChair || !curChair.Nazwa) { hideModelLoader(); alert('Najpierw wybierz krzesÅ‚o z konfiguratora'); return; }
  // Remember current chair so we can restore it if the browser/page reloads after AR
  try { sessionStorage.setItem('__ar_resume', JSON.stringify({ chairName: curChair.Nazwa, ts: Date.now() })); } catch(_) {}
        const assets = (typeof getCurrentArAssets === 'function') ? getCurrentArAssets() : null;
        const glb = assets?.glb || (Array.isArray(assets?.glbCandidates) ? assets.glbCandidates[0] : null);
  const usdzList = [];
        await ensureModelViewerScript();
        const mv = ensureUnifiedArModelViewer();
        const absGlb = glb ? toAbsUrl(glb) : '';
        if (!absGlb) { hideModelLoader(); alert('Brak pliku GLB dla AR.'); return; }
        const prevSrc = mv.getAttribute('src') || '';
        const srcChanged = prevSrc !== absGlb;
        if (srcChanged) mv.setAttribute('src', absGlb);
  // iOS GLB-only: do not set ios-src to avoid Quick Look path and remove delay
  const prevIos = mv.getAttribute('ios-src') || '';
  const iosChanged = !!prevIos; // ensure no Quick Look source
  if (prevIos) mv.removeAttribute('ios-src');
        // If we changed src or ios-src, wait a moment so AR intent/anchor points to the new model
        if (srcChanged || iosChanged) {
          await __waitForArAnchorRefresh(mv, { timeoutMs: 900 });
        }
        // Activate AR
        if (typeof mv.activateAR === 'function') {
          try {
            await mv.activateAR();
          } catch(_) {
            // If activation fails (e.g., iOS without WebXR), try Quick Look if available
            try {
              if (typeof isIOS === 'function' && isIOS()) {
                const assets2 = (typeof getCurrentArAssets === 'function') ? getCurrentArAssets() : null;
                const usdz2 = Array.isArray(assets2?.usdzCandidates) ? assets2.usdzCandidates[0] : '';
                if (usdz2) {
                  const link = document.createElement('a');
                  link.setAttribute('rel', 'ar');
                  link.setAttribute('href', buildQuickLookUrl(usdz2));
                  document.body.appendChild(link);
                  link.click();
                } else {
                  alert('AR na iOS wymaga Quick Look (USDZ) lub WebXR. Dla tego modelu brak USDZ.');
                }
              }
            } catch(_) {}
            // Hide shortly after to avoid a stuck loader
            setTimeout(() => { try { hideModelLoader(); } catch(_) {} }, 1500);
          } finally {
            // Do NOT hide immediately; wait for page to background or session-started.
            // Add a long safety timeout to ensure we never get stuck.
            setTimeout(() => { try { hideModelLoader(); } catch(_) {} }, 12000);
          }
        } else {
          // Fallback to Scene Viewer
          try { window.location.href = buildSceneViewerUrl(glb); } finally { setTimeout(() => hideModelLoader(), 800); }
        }
      }

  // Wire bottom AR button (always show AR-coming-soon popup)
      (function wireArButtons() {
        const arBtn = document.getElementById('ar-button');
        if (arBtn && !arBtn._arBound) {
          arBtn.addEventListener('click', (e) => {
            e.stopPropagation();
    if (typeof openArPopup === 'function') openArPopup();
          });
          arBtn._arBound = true;
        }
        // Removed duplicate view button handler - handled by ensureViewInRoomButton() above
      })();

      // Enable overlay preview via URL param (?ar_ui_preview=1)
  (function maybeEnableArUiPreview(){
        try {
          const u = new URL(window.location.href);
          // Preview and post-AR overlays disabled
          if (u.searchParams.get('ar_return') === '1') {
            u.searchParams.delete('ar_return');
            try { window.history.replaceState({}, '', u.toString()); } catch {}
          }
        } catch(_) {}
      })();

      // Restore previously selected chair after returning from AR (even if the page reloaded)
  (function restoreChairAfterAr(){
        const tryRestore = () => {
          let payload = null;
          try { payload = JSON.parse(sessionStorage.getItem('__ar_resume') || 'null'); } catch(_) { payload = null; }
          if (!payload || !payload.chairName) return;
          // Use it only once
          try { sessionStorage.removeItem('__ar_resume'); } catch(_) {}
          const name = payload.chairName;
          let attempts = 0;
          const tick = async () => {
            attempts++;
            if (window.viewer && typeof silentLoadModel === 'function') {
              try { await silentLoadModel({ Nazwa: name }); } catch(_) {}
              return; // done, stop retrying
            }
            if (attempts < 40) {
              setTimeout(tick, 250);
            }
          };
          // Defer until viewer is initialized
          setTimeout(tick, 0);
        };
        window.addEventListener('pageshow', () => { tryRestore(); });
        document.addEventListener('DOMContentLoaded', () => { tryRestore(); });
      })();

  // Preload model-viewer script early
  window.addEventListener('DOMContentLoaded', () => { ensureModelViewerScript(); });

      // Przycisk powrotu do kategorii
      document.getElementById('back-to-categories')?.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log("ðŸ”™ KlikniÄ™to przycisk powrotu do kategorii");
        returnToCategories();
      });

      function showConfigOverview() {
        const overviewPanel = document.getElementById('config-overview');
        overviewPanel.classList.remove('hidden');
      }

      // WywoÅ‚aj tÄ™ funkcjÄ™ w odpowiednim momencie, np. po zaÅ‚adowaniu modelu


      document.addEventListener('click', () => {
        if (window.__justClosedBrightness && Date.now() - window.__justClosedBrightness < 120) return;
        const hdrPanel = document.getElementById('hdr-panel');
        if (hdrPanel) {
          hdrPanel.classList.add('hidden');
        }
      });



      function showDimensions() {
        const dimensionOverlay = document.getElementById('dimension-overlay');
        const dimensionsContainer = dimensionOverlay.querySelector('.dimensions-container');
        
        // PokaÅ¼ overlay
        dimensionOverlay.style.display = 'block';
        
        // WyczyÅ›Ä‡ poprzednie wymiary
        dimensionsContainer.innerHTML = '';

        if (!selectedChair) return;

        // Parsowanie wymiarÃ³w z kolumny Wymiary
        const dimensionsString = selectedChair.Wymiary || '';
        const dimensionsParsed = {};
        dimensionsString.split(',').forEach(dim => {
          const [key, value] = dim.split('=').map(s => s.trim());
          if (key && value) {
            dimensionsParsed[key.toLowerCase()] = parseFloat(value);
          }
        });

        const dimensions = [
          { label: 'SzerokoÅ›Ä‡', value: dimensionsParsed.x },
          { label: 'GÅ‚Ä™bokoÅ›Ä‡', value: dimensionsParsed.y },
          { label: 'WysokoÅ›Ä‡', value: dimensionsParsed.z }
        ];

        // Dodaj wymiary do kontenera
        dimensions.forEach(dim => {
          if (dim.value !== undefined) {
            const dimensionItem = document.createElement('div');
            dimensionItem.className = 'dimension-item';

            const label = document.createElement('div');
            label.className = 'dimension-label';
            label.textContent = dim.label;

            const value = document.createElement('div');
            value.className = 'dimension-value';
            value.textContent = `${dim.value} cm`;

            dimensionItem.appendChild(label);
            dimensionItem.appendChild(value);
            dimensionsContainer.appendChild(dimensionItem);
          }
        });
      }

      function hideDimensions() {
        const dimensionOverlay = document.getElementById('dimension-overlay');
        dimensionOverlay.style.display = 'none';
      }

      // Funkcja powrotu do kategorii
      function returnToCategories() {
        console.log("ðŸ”™ Returning to categories...");
        
        // Ukryj bottom toolbar
        const toolbar = document.getElementById('bottom-toolbar');
        toolbar.classList.remove('visible');
        toolbar.style.display = 'none';
        
        // Ukryj panel konfiguracji
        const configOverview = document.getElementById('config-overview');
        if (configOverview) {
          configOverview.style.display = 'none';
          configOverview.classList.add('hidden');
        }
        
        // Ukryj sekcje materiaÅ‚Ã³w i nÃ³g
        document.getElementById('materials-section').style.display = 'none';
        document.getElementById('legs-section').style.display = 'none';
        
        // PokaÅ¼ welcome screen z kategoriami
        const welcomeScreen = document.getElementById('welcome-screen');
        if (welcomeScreen) {
          // Don't show welcome on mobile
          if (window.isMobileNow && window.isMobileNow()) {
            welcomeScreen.style.display = 'none';
            console.log('ðŸ“± Blocked welcome display in returnToCategories on mobile');
          } else {
            welcomeScreen.style.display = 'flex';
          }
        }
        
        // UsuÅ„ aktualny model ze sceny
        if (currentModelContainer) {
          viewer.scene.remove(currentModelContainer);
          if (typeof currentModelContainer.dispose === 'function') currentModelContainer.dispose();
        }
        if (currentLegModel) {
          viewer.scene.remove(currentLegModel);
          if (typeof currentLegModel.dispose === 'function') currentLegModel.dispose();
        }
        
  // Reset zmiennych (keep globals in sync)
  currentModelContainer = null;
  currentLegModel = null;
  selectedLeg = null;
  selectedMaterials = {};
  selectedChair = null;
  try { window.selectedChair = null; } catch(_) {}
  // Ukryj przycisk QR po powrocie (ekran powitalny)
  const __qrBtn = document.getElementById('qr-button');
  if (__qrBtn) __qrBtn.style.display = 'none';
  try { document.body.classList.add('awaiting-selection'); } catch(_) {}
        
        // OdÅ›wieÅ¼ kategorie
        renderCategoryButtons();
      }



      // ðŸ“¦ Åadowanie JSZip
      async function loadJSZip() {
        if (!window.JSZip) {
          await import('https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js');
        }
      }

      // ðŸ“ ZaÅ‚aduj listÄ™ plikÃ³w tekstur z files.json
      let texturesFilesByFolder = {};
      async function loadTexturesFilesList() {
        try {
          const res = await fetch('textures/files.json');
          texturesFilesByFolder = await res.json();
        } catch (e) {
          console.error('BÅ‚Ä…d Å‚adowania files.json:', e);
          texturesFilesByFolder = {};
        }
      }

      // ðŸ“ ObsÅ‚ugiwane formaty eksportu
      const modelFormats = ['fbx', 'obj', 'dae'];

      // ðŸ—œï¸ GÅ‚Ã³wna funkcja eksportu ZIP
      async function handleExport(format) {
        if (!window.JSZip) {
          alert('JSZip niezaÅ‚adowany!');
          return;
        }

        if (!modelFormats.includes(format)) {
          alert(`NieobsÅ‚ugiwany format eksportu: ${format}`);
          return;
        }

        const zip = new JSZip();

        // ðŸª‘ Eksport gÅ‚Ã³wnego modelu krzesÅ‚a
  const chairModel = (window.selectedChair && window.selectedChair.Nazwa) || 'BrakModelu';
        const chairPath = `export/${chairModel}.${format}`;

        try {
          const res = await fetch(chairPath);
          if (!res.ok) throw new Error(`Nie znaleziono modelu krzesÅ‚a: ${chairPath}`);
          const blob = await res.blob();
          zip.file(`${chairModel}.${format}`, blob);
        } catch (e) {
          alert(e.message);
          return;
        }

        // ðŸ¦µ Eksport nÃ³g (jeÅ›li wybrano)
  const legModel = (window.selectedLeg && window.selectedLeg.Nazwa);
        if (legModel) {
          const legPath = `export/${legModel}.${format}`;
          try {
            const res = await fetch(legPath);
            if (res.ok) {
              const blob = await res.blob();
              zip.file(`${legModel}.${format}`, blob);
            } else {
              console.warn(`Nie znaleziono modelu nÃ³g: ${legPath}`);
            }
          } catch (e) {
            console.warn(`BÅ‚Ä…d pobierania nÃ³g: ${e.message}`);
          }
        }

        // ðŸŽ¨ Eksport materiaÅ‚Ã³w / tekstur z kolekcjÄ… i bez
        const textureFolderInZip = zip.folder('textures');
        const materials = Object.values(window.selectedMaterials || {});
  const collection = ((window.selectedChair && window.selectedChair.Kolekcja) ? window.selectedChair.Kolekcja.trim() : '') || '';

        for (const mat of materials) {
          const folder = mat.Folder || mat.WartoÅ›Ä‡;
          const textureFiles = texturesFilesByFolder[folder] || [];

          for (const texFile of textureFiles) {
            const candidatePaths = [
              collection ? `textures/${collection}/${folder}/${texFile}` : null,
              `textures/${folder}/${texFile}`
            ].filter(Boolean);

            let found = false;

            for (const path of candidatePaths) {
              try {
                const res = await fetch(path);
                if (res.ok) {
                  const blob = await res.blob();
                  textureFolderInZip.file(`${folder}/${texFile}`, blob);
                  found = true;
                  break;
                }
              } catch (e) {
                console.warn(`âŒ BÅ‚Ä…d pobierania: ${path}`, e);
              }
            }

            if (!found) {
              console.warn(`âš ï¸ Nie znaleziono tekstury: ${folder}/${texFile}`);
            }
          }
        }

        // ðŸ“¦ Finalny zapis ZIP
        const blob = await zip.generateAsync({ type: 'blob' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `export_${chairModel}_${format}.zip`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(a.href);
      }

      // ðŸš€ Inicjalizacja tekstur na starcie
      await loadTexturesFilesList();

      // ðŸ–±ï¸ ObsÅ‚uga klikniÄ™cia eksportu
      document.querySelectorAll('.export-btn').forEach(button => {
        button.addEventListener('click', async () => {
          await loadJSZip();
          const format = button.getAttribute('data-format');
          await handleExport(format);
        });
      });



      function updateMaterialTiles() {
        const legsMaterialsContainer = document.getElementById('legs-thumbnails');
        if (!legsMaterialsContainer || !selectedChair || !selectedLeg) return;

        // ðŸ§¼ CzyÅ›Ä‡ tylko kafelki materiaÅ‚Ã³w nÃ³g
  if (legsMaterialsContainer.querySelectorAll) legsMaterialsContainer.querySelectorAll('.material-tile').forEach(tile => tile.remove());

        const allEntries = allData;

  const chairType = (selectedChair.Grupa ? selectedChair.Grupa.trim().toLowerCase() : undefined);       // 'krzesÅ‚o' lub 'kubeÅ‚ek'
  const legVariant = (selectedLeg.Nazwa ? selectedLeg.Nazwa.trim().toLowerCase() : undefined);       // np. 'regularne'

        const filteredMaterials = allEntries.filter(mat => {
          // âœ… tylko materiaÅ‚y nÃ³g
          if (((mat.Grupa ? mat.Grupa.trim().toLowerCase() : '')) !== 'materiaÅ‚y_nÃ³g') return false;

          // âœ… czy materiaÅ‚ pasuje do typu krzesÅ‚a (GrupaDocelowa)
          const grupaDocelowa = (mat.GrupaDocelowa ? mat.GrupaDocelowa.toLowerCase() : '') || '';
          const grupy = grupaDocelowa.split(',').map(g => g.trim());
          if (!grupy.includes(chairType)) return false;

          // âœ… jeÅ›li krzesÅ‚o â†’ ignorujemy DlaModeluNÃ³g
          if (chairType === 'krzesÅ‚o') return true;

          // âœ… jeÅ›li kubeÅ‚ek â†’ DlaModeluNÃ³g musi zawieraÄ‡ aktualny wariant nÃ³g
          const dlaModelu = ((mat.DlaModeluNÃ³g || mat.DlaModeluNog || mat.DlaModelu) ? (mat.DlaModeluNÃ³g || mat.DlaModeluNog || mat.DlaModelu).toLowerCase().trim() : undefined);
          if (!dlaModelu || dlaModelu.length === 0) return false;

          const allowedVariants = dlaModelu.split(',').map(v => v.trim());
          return allowedVariants.includes(legVariant);
        });

        filteredMaterials.forEach(mat => {
          const tile = document.createElement('div');
          tile.className = 'material-tile';
          tile.textContent = mat.Nazwa;
          tile.style.backgroundImage = `url(${mat.Obrazek || 'fallback.png'})`;
          tile.onclick = () => applyLegMaterial(mat);
          legsMaterialsContainer.appendChild(tile);
        });

        console.log(`âœ… Pokazano ${filteredMaterials.length} materiaÅ‚Ã³w nÃ³g dla '${chairType}', wariant nÃ³g '${selectedLeg.Nazwa}'`);
      }





  // PROSTA WERSJA: nagÅ‚Ã³wek + dwa przyciski w jednym rzÄ™dzie: Obicie / StelaÅ¼
      function renderPartButtons(){
        console.log(`ðŸ”§ renderPartButtons called, selectedChair:`, selectedChair);
        
        const host = document.getElementById('part-tabs');
        if(!host) return;
        
        // SprawdÅº czy krzesÅ‚o jest zaÅ‚adowane
        if (!selectedChair) {
          console.warn('ðŸ”§ renderPartButtons: brak selectedChair, pomijam renderowanie');
          return;
        }
        
        host.innerHTML='';
        // UsuÅ„ ewentualny pozostawiony panel wariantÃ³w nÃ³g poza sekcjÄ… StelaÅ¼
        document.querySelectorAll('#leg-variants-panel').forEach(el=>{
          if(el.parentElement && el.parentElement.id !== 'legs-panels') {
            el.remove();
          }
        });
      // Ukryj stary duÅ¼y blok wyboru nÃ³g nad przyciskami (legs-section)
      const legacyLegsSection = document.getElementById('legs-section');
      if (legacyLegsSection) {
        legacyLegsSection.style.display='none';
        legacyLegsSection.style.visibility='hidden';
        console.log('ðŸ”§ DEBUG: Ukryto legacy legs-section');
      }
      
        // Przyciski w staÅ‚ej sekcji na gÃ³rze
        const row=document.createElement('div'); row.className='part-btn-row';
        const btnOb=document.createElement('div'); btnOb.className='simple-part-btn'; btnOb.textContent='Obicie';
        const btnSt=document.createElement('div'); btnSt.className='simple-part-btn'; btnSt.textContent='StelaÅ¼';
        row.appendChild(btnOb); row.appendChild(btnSt); 
        host.appendChild(row);
        
        // Panele materiaÅ‚Ã³w bezpoÅ›rednio w host (part-tabs)
        const fabricPanels=document.createElement('div'); 
        fabricPanels.id='fabric-panels'; 
        fabricPanels.className='collection-accordion-group';
        fabricPanels.setAttribute('data-type', 'fabrics');
        host.appendChild(fabricPanels);
        
        const legsPanels=document.createElement('div'); 
        legsPanels.id='legs-panels'; 
        legsPanels.className='collection-accordion-group';
        legsPanels.setAttribute('data-type', 'legs');
        legsPanels.style.display='none'; 
        legsPanels.style.marginTop='28px';
        host.appendChild(legsPanels);

        function activate(which){
          console.log(`ðŸ”§ DEBUG activate() called with: ${which}`);
          btnOb.classList.toggle('selected', which==='fabrics');
          btnSt.classList.toggle('selected', which==='legs');
          
          // ZnajdÅº panele w DOM
          const fabricPanels = document.getElementById('fabric-panels');
          const legsPanels = document.getElementById('legs-panels');
          
          if (!fabricPanels || !legsPanels) {
            console.warn('ðŸ”§ DEBUG: Nie znaleziono paneli materiaÅ‚Ã³w w DOM');
            return;
          }
          
          const grupa=(selectedChair?.Grupa||'').toLowerCase();
          const kategoria=(selectedChair?.Kategoria||'').toLowerCase();
          console.log(`ðŸ” Chair grupa: '${grupa}', kategoria: '${kategoria}'`);
          const isBucket= grupa==='kubeÅ‚ek'||grupa==='kubelek';
          // Warianty nÃ³g tylko dla krzeseÅ‚ z grupy kubeÅ‚ek
          const shouldShowLegsVariants = isBucket;
          console.log(`ðŸ” shouldShowLegsVariants: ${shouldShowLegsVariants}`);
          fabricPanels.style.display= which==='fabrics' ? 'block':'none';
          legsPanels.style.display= (which==='legs')?'block':'none';
          console.log(`ðŸ”§ DEBUG: Set legsPanels.style.display = ${legsPanels.style.display}`);
          console.log(`ðŸ”§ DEBUG: legsPanels element:`, legsPanels);
          console.log(`ðŸ”§ DEBUG: legsPanels parent:`, legsPanels.parentElement);
          console.log(`ðŸ”§ DEBUG: legsPanels computed style:`, window.getComputedStyle(legsPanels).display);
          
          // Clear when switching
          if(which==='legs') {
            console.log('ðŸ”§ DEBUG: Clearing legsPanels, which=legs');
            legsPanels.innerHTML='';
            
            console.log(`ðŸ”§ DEBUG: shouldShowLegsVariants=${shouldShowLegsVariants}, selectedChair=${selectedChair?.Nazwa}`);
            if(shouldShowLegsVariants){
              // Sekcja wariantÃ³w nÃ³g na gÃ³rze panelu
              console.log('ðŸ”§ DEBUG: Creating leg variants section');
              const variantsSection = document.createElement('div');
              variantsSection.className='leg-variants-section';
              
              const heading = document.createElement('div');
              heading.className='leg-variants-heading';
              heading.textContent='Wariant StelaÅ¼a:';
              heading.style.fontSize = '14px';
              heading.style.fontWeight = '600';
              heading.style.marginBottom = '12px';
              heading.style.color = '#333';
              variantsSection.appendChild(heading);
              
              const variants=document.createElement('div');
              variants.id='leg-variants-panel';
              variants.className='leg-variants-grid';
              variants.style.display = 'flex';
              variants.style.flexWrap = 'wrap';
              variants.style.gap = '8px';
              variants.style.marginBottom = '16px';
              variantsSection.appendChild(variants);
              
              const chairIsHooker = (selectedChair?.Kategoria||'').toLowerCase().includes('hooker');
              
              // ðŸ”Ž Filtrowanie nÃ³g: 1) grupa 'nogi' 2) dopasowanie hooker/krzesÅ‚o 3) dopasowanie do kubeÅ‚ka po DlaKubeÅ‚ka
              const bucketVariant = (selectedChair?.Wariant || '').trim();
              const bucketBase = (selectedChair?.Nazwa || '').trim();
              
              // âœ… ObsÅ‚uga obu formatÃ³w: Amy-2_Drewno i Amy-2 Drewno (case-insensitive)
              const fullBucketWithUnderscore = bucketVariant ? `${bucketBase}_${bucketVariant}` : bucketBase;
              const fullBucketWithSpace = bucketVariant ? `${bucketBase} ${bucketVariant}` : bucketBase;
              const normalizedBucketUnderscore = fullBucketWithUnderscore.toLowerCase();
              const normalizedBucketSpace = fullBucketWithSpace.toLowerCase();
              const normalizedBucketBase = bucketBase.toLowerCase();

              console.log(`ðŸ” LEG_FILTER_DEBUG: selectedChair.Nazwa='${selectedChair?.Nazwa}' selectedChair.Wariant='${selectedChair?.Wariant}' formats=['${normalizedBucketUnderscore}', '${normalizedBucketSpace}']`);

              const legs = allData.filter(d => {
                if ((d.Grupa || '').toLowerCase() !== 'nogi') return false;

                // hooker vs normal
                const kat = (d.Kategoria || d.Typ || '').toLowerCase();
                const isHookerLeg = kat.includes('hooker');
                if (chairIsHooker ? !isHookerLeg : isHookerLeg) return false;

                // Lista dozwolonych kubeÅ‚kÃ³w (peÅ‚ne nazwy) w nodze
                const rawAllowed = (d.DlaKubeÅ‚ka || d.DlaKubelka || '').split(',').map(x => x.trim()).filter(Boolean);
                const allowedLower = rawAllowed.map(a => a.toLowerCase());

                // JeÅ›li brak ograniczeÅ„ -> zostaw (ale zaloguj)
                if (allowedLower.length === 0) {
                  console.log(`ðŸ¦µ LEG_FILTER: '${d.Nazwa}' (brak DlaKubeÅ‚ka) -> ACCEPT`);
                  return true;
                }

                // âœ… SprawdÅº czy lista zawiera kubeÅ‚ek w OBUS formatach (z _ lub ze spacjÄ…)
                const match = allowedLower.includes(normalizedBucketUnderscore) || 
                             allowedLower.includes(normalizedBucketSpace) || 
                             allowedLower.includes(normalizedBucketBase);

                // Dopasowanie wariantu nÃ³g - POPRAWNA logika jak w hookerach (case-insensitive):
                // 1. Noga bez wariantu -> pasuje do kubeÅ‚kÃ³w bez wariantu
                // 2. Noga z wariantem -> pasuje do kubeÅ‚kÃ³w z tym samym wariantem
                // 3. KubeÅ‚ek z wariantem -> moÅ¼e uÅ¼ywaÄ‡ nÃ³g z tym wariantem ORAZ nÃ³g bez wariantu
                const legVariant = (d.Wariant || '').toLowerCase().trim();
                const bucketVarLower = bucketVariant.toLowerCase().trim();
                
                let variantMatch = true;
                if (bucketVarLower) {
                  // KubeÅ‚ek ma wariant (np. Amy-2_Drewno)
                  // MoÅ¼e uÅ¼ywaÄ‡: nÃ³g z tym samym wariantem ALBO nÃ³g bez wariantu (uniwersalne)
                  variantMatch = (!legVariant || legVariant === bucketVarLower);
                } else {
                  // KubeÅ‚ek nie ma wariantu
                  // MoÅ¼e uÅ¼ywaÄ‡ tylko nÃ³g bez wariantu (uniwersalne)
                  variantMatch = !legVariant;
                }

                const accept = match && variantMatch;
                console.log(`ðŸ¦µ LEG_FILTER: '${d.Nazwa}' allowed=[${allowedLower.join('|')}] buckets=['${normalizedBucketUnderscore}','${normalizedBucketSpace}'] legVar='${legVariant}' bucketVar='${bucketVarLower}' match=${match} variantMatch=${variantMatch} => ${accept?'ACCEPT':'REJECT'}`);
                return accept;
              });

              console.log(`ðŸ¦µ Found ${legs.length} leg variants (after filter) for chairs ['${normalizedBucketUnderscore}','${normalizedBucketSpace}']`, legs.map(l => `${l.Nazwa}[${l.Wariant||''}]`));
              
              // âœ… AUTOWYBÃ“R nÃ³g - TYLKO gdy krzesÅ‚o jest zaÅ‚adowane I sÄ… pasujÄ…ce nogi
              if (!selectedLeg && legs.length > 0 && selectedChair && selectedChair.Nazwa && 
                  currentModelContainer && currentModelContainer.children.length > 0) {
                console.log(`ðŸ¦µ LEG_AUTOSELECT: Auto-wybÃ³r pierwszej nogi '${legs[0].Nazwa}' dla kubeÅ‚ka '${fullBucketName}'`);
                setTimeout(() => { 
                  try { 
                    setLegModel(legs[0]); 
                  } catch(e){ 
                    console.warn('LEG_AUTOSELECT error', e); 
                  } 
                }, 100);
              } else {
                console.log(`ðŸ¦µ LEG_AUTOSELECT pominiÄ™ty: selectedLeg=${!!selectedLeg}, legs=${legs.length}, hasChair=${!!(selectedChair && selectedChair.Nazwa)}, hasModel=${!!(currentModelContainer && currentModelContainer.children.length > 0)}`);
              }
              
              legs.forEach((leg, index)=>{
                const wrap=document.createElement('div'); 
                wrap.className='thumbnail-wrapper';
                
                const thumb=document.createElement('div'); 
                thumb.className='thumbnail'; 
                thumb.style.width='60px'; 
                thumb.style.height='60px';
                thumb.style.border = '2px solid #e0e0e0';
                thumb.style.borderRadius = '8px';
                thumb.style.cursor = 'pointer';
                thumb.style.transition = 'all 0.3s';
                thumb.style.background = '#fff';
                
                const img=document.createElement('img'); 
                img.src= leg.Obrazek || 'icons/placeholder.svg'; 
                img.alt= leg.Nazwa; 
                img.style.width = '100%';
                img.style.height = '100%';
                img.style.objectFit = 'cover';
                img.style.borderRadius = '6px';
                thumb.appendChild(img);
                
                // Automatycznie zaznacz pierwszy wariant nÃ³g dla kubeÅ‚kÃ³w - BEZ ÅADOWANIA
                const isFirstLeg = index === 0;
                if(selectedLeg && selectedLeg.Nazwa===leg.Nazwa) {
                  thumb.style.borderColor = '#F5C842';
                  thumb.style.boxShadow = '0 0 0 2px rgba(245,200,66,.4)';
                  thumb.style.background = '#fffbe6';
                } else if (isFirstLeg && !selectedLeg && selectedChair && selectedChair.Grupa) {
                  // Zaznacz wizualnie pierwszy wariant ale NIE Å‚aduj automatycznie
                  thumb.style.borderColor = '#F5C842';
                  thumb.style.boxShadow = '0 0 0 2px rgba(245,200,66,.4)';
                  thumb.style.background = '#fffbe6';
                  console.log(`ðŸ¦µ Wizualnie zaznaczono pierwszÄ… nogÄ™: ${leg.Nazwa} (bez autoÅ‚adowania)`);
                  // USUNIÄ˜TE: automatyczne Å‚adowanie setLegModel(leg)
                }
                
                thumb.onclick=()=>{ 
                  // UsuÅ„ wybÃ³r z innych wariantÃ³w
                  variants.querySelectorAll('.thumbnail').forEach(t=>{
                    t.style.borderColor = '#e0e0e0';
                    t.style.boxShadow = 'none';
                    t.style.background = '#fff';
                  }); 
                  
                  // Dodaj wybÃ³r do klikniÄ™tego
                  thumb.style.borderColor = '#F5C842';
                  thumb.style.boxShadow = '0 0 0 2px rgba(245,200,66,.4)';
                  thumb.style.background = '#fffbe6';
                  
                  setLegModel(leg); 
                  
                  // OdÅ›wieÅ¼ materiaÅ‚y nÃ³g
                  try { renderFilteredMaterialOptions('legs_material'); } catch(e){} 
                };
                
                wrap.appendChild(thumb);
                
                const cap=document.createElement('div'); 
                cap.className='thumbnail-caption'; 
                cap.textContent=leg.Nazwa; 
                cap.style.fontSize = '11px';
                cap.style.textAlign = 'center';
                cap.style.marginTop = '4px';
                wrap.appendChild(cap);
                
                variants.appendChild(wrap);
                console.log(`ðŸ”§ DEBUG: Added leg variant: ${leg.Nazwa} ${isFirstLeg ? '(auto-selected)' : ''}`);
              });
              
              legsPanels.appendChild(variantsSection);
              console.log('ðŸ”§ DEBUG: Leg variants section completed');
            } else {
              console.log('ðŸ”§ DEBUG: NOT showing leg variants (shouldShowLegsVariants=false)');
            }
          } else if(which==='fabrics') {
            console.log('ðŸ”§ DEBUG: Clearing fabricPanels, which=fabrics');
            fabricPanels.innerHTML='';
          }
        }

        btnOb.onclick=()=>{
          activate('fabrics');
          console.log('ðŸ”Ž Switched to fabrics tab');
          // ZaÅ‚aduj materiaÅ‚y tkanin dla dostÄ™pnych czÄ™Å›ci krzesÅ‚a
          const fabricContainer = document.getElementById('fabric-panels');
          console.log('ðŸ”Ž Fabric container:', fabricContainer);
          
          if (!fabricContainer || fabricContainer.children.length === 0) {
            console.log('ðŸ”Ž Loading fabric materials for all chair parts...');
            // 1) Odczytaj dostÄ™pne elementy z wiersza krzesÅ‚a (DostepneElementy / DostÄ™pneElementy)
            const getChairAvailableTargets = (chair)=>{
              const aliases = ['DostepneElementy','DostÄ™pneElementy','Dostepne','DostÄ™pne'];
              let raw = '';
              for (const k of aliases){ if (chair && chair[k] && String(chair[k]).trim() !== '') { raw = String(chair[k]); break; } }
              if (!raw) return [];
              // wspieraj format tagÃ³w: "seat, backseat, legs" albo z separatorami spacji
              let parts = raw.includes(',') ? raw.split(',') : raw.split(/\s+/);
              const norm = s => (s||'').toLowerCase().trim();
              const known = new Set(['seat','backseat','backseat_inside','backseat_outside','legs']);
              const out = [];
              parts.forEach(p=>{ const v = norm(p); if (known.has(v) && !out.includes(v)) out.push(v); });
              return out;
            };

            const chairTargetsRaw = getChairAvailableTargets(selectedChair);
            // tkaniny: interesuje nas tylko seat/backseat/backseat_inside/_outside
            const chairFabricTargets = chairTargetsRaw.filter(t=> t !== 'legs');
            console.log('ðŸ”Ž Chair fabric targets from sheet (DostepneElementy):', chairFabricTargets);

            // 2) Dla bezpieczeÅ„stwa: jeÅ›li w arkuszu brak wpisu, uÅ¼yj unii targetÃ³w z arkusza tkanin (stare zachowanie)
            let candidateTargets = chairFabricTargets;
            if (candidateTargets.length === 0) {
              const allTargets = allData.filter(d => 
                (d.Grupa || '').toLowerCase() === 'tkanina' && 
                d.TargetMeshOrModel &&
                (d.Visible || '').toLowerCase() !== 'false'
              ).flatMap(d => d.TargetMeshOrModel.split(',').map(t => t.trim().toLowerCase()));
              candidateTargets = [...new Set(allTargets)].filter(t=> t!=='legs');
              console.log('ðŸ”Ž Fallback fabric targets (from data):', candidateTargets);
            }

            // 3) Wybierz pierwszy target, ktÃ³ry istnieje w modelu
            const modelMeshNames = [];
            if (currentModelContainer && currentModelContainer.traverse) {
              currentModelContainer.traverse(o => { if (o.isMesh && o.name) modelMeshNames.push(o.name.toLowerCase()); });
            }
            const preferOrder = ['seat','backseat','backseat_inside','backseat_outside'];
            const preferredCandidates = preferOrder.filter(p=> candidateTargets.includes(p));
            let primaryTarget = preferredCandidates.find(t => (
              modelMeshNames.includes(t) ||
              (t==='seat' && (modelMeshNames.includes('siedzisko') || modelMeshNames.includes('siedzisko_oparcie'))) ||
              (t==='backseat' && (modelMeshNames.includes('siedzisko_oparcie') || modelMeshNames.includes('bucket_combo')))
            ));
            if (!primaryTarget) primaryTarget = candidateTargets.find(t => modelMeshNames.includes(t)) || preferredCandidates[0] || candidateTargets[0] || 'seat';
            console.log('ðŸ”Ž Chosen primary fabric target:', primaryTarget, '| model meshes:', modelMeshNames);
            
            console.log('ðŸ”Ž Loading materials for primary target:', primaryTarget);
            try { 
              renderFilteredMaterialOptions(primaryTarget); 
            } catch(e){ 
              console.warn('Error loading materials:', e); 
            }
          } else {
            console.log('ðŸ”Ž Materials already loaded, skipping');
          }
        };
        btnSt.onclick=()=>{
          activate('legs');
          console.log('ðŸ”Ž Switched to legs tab');
          // ZaÅ‚aduj materiaÅ‚y nÃ³g
          const legsContainer = document.getElementById('legs-panels');
          console.log('ðŸ”Ž Legs container:', legsContainer);
          console.log('ðŸ”Ž Legs container children:', legsContainer?.children?.length);
          // Zawsze Å‚aduj materiaÅ‚y nÃ³g przy przeÅ‚Ä…czeniu na StelaÅ¼
          console.log('ðŸ”Ž Loading leg materials...');
          try { renderFilteredMaterialOptions('legs_material'); } catch(e){ console.warn('Error loading leg materials:', e); }
        };

        // Dla kubeÅ‚ka domyÅ›lnie pokaÅ¼ zakÅ‚adkÄ™ "StelaÅ¼" z wariantami nÃ³g
        const chairGrupa = (selectedChair?.Grupa || '').toLowerCase();
        if (chairGrupa === 'kubeÅ‚ek') {
          // DomyÅ›lnie pokazuj Obicie, warianty nÃ³g bÄ™dÄ… widoczne po klikniÄ™ciu StelaÅ¼
          setTimeout(() => {
            console.log('ï¿½ DEBUG: Auto-clicking StelaÅ¼ button for kubeÅ‚ek');
            btnOb.click();
          }, 100);
        } else {
          setTimeout(() => btnOb.click(), 0);
        }
      }
      
      // Styl dla przyciskÃ³w w rzÄ™dzie (przywrÃ³cone prostsze fonty)
      (function(){
        let st=document.getElementById('simple-part-style');
  const css=`.part-tabs-heading{font-size:16px;font-weight:600;color:#333;margin:6px 2px 10px 2px;}
        .part-btn-row{display:flex;gap:8px;margin-bottom:4px;}
        .simple-part-btn{flex:1;box-sizing:border-box;display:flex;align-items:center;justify-content:center;text-align:center;border:2px solid #e5e5e5;border-radius:12px;background:#fff;cursor:pointer;transition:.25s;padding:10px 8px;font-weight:600;font-size:13px;user-select:none;}
        .simple-part-btn:hover{border-color:#d4af37;}
  .simple-part-btn.selected{background:#f0f0f0;color:#222;border-color:#bebebe;} 
  /* ðŸ”¶ Å»Ã³Å‚te podÅ›wietlenie wyborÃ³w jak w kategoriach */
  .simple-part-btn.selected{background:#F5C842;color:#fff;border-color:#F5C842;box-shadow:0 2px 4px rgba(0,0,0,.08);} 
  .leg-variants-grid .thumbnail.selected{border-color:#F5C842!important;box-shadow:0 0 0 2px rgba(245,200,66,.4)!important;background:#fffbe6;}
  .collection-materials-row .thumbnail.selected{border-color:#F5C842!important;box-shadow:0 0 0 2px rgba(245,200,66,.35)!important;background:#fffbe6;outline:none;}
  #leg-variants-panel .thumbnail.selected{border-color:#F5C842!important;box-shadow:0 0 0 2px rgba(245,200,66,.35)!important;background:#fffbe6;}
  #part-tabs{display:block;}
  #fabric-panels,#legs-panels{display:none;}
  #leg-variants-panel{display:flex;flex-wrap:wrap;gap:6px;}
  #leg-variants-panel .thumbnail{border:2px solid #e0e0e0;border-radius:10px;width:75px!important;height:75px!important;}
  #leg-variants-panel .thumbnail.selected{border-color:#333;box-shadow:0 0 0 2px #3332;}
  .leg-variants-section{margin:4px 0 10px 0;padding:6px 4px 2px 4px;border:1px solid #ececec;border-radius:12px;background:#fafafa;}
  .leg-variants-heading{font-size:12px;font-weight:600;letter-spacing:.5px;text-transform:uppercase;color:#555;margin:0 0 6px 4px;}
  .leg-variants-grid{display:flex;flex-wrap:wrap;gap:6px;}
  .leg-variants-grid .thumbnail{width:75px!important;height:75px!important;}
  #legs-thumbnails .thumbnail{width:75px!important;height:75px!important;}
  /* #legs-section{display:none !important;} - WYÅÄ„CZONE DLA DEBUGOWANIA */
  .collection-materials-row .thumbnail.selected{outline:2px solid #444;box-shadow:none;}
  details summary{cursor:pointer;}
  `;
        if(!st){ st=document.createElement('style'); st.id='simple-part-style'; document.head.appendChild(st); }
        st.textContent=css;
      })();

      // ðŸŽ¯ Automatyczne Å‚adowanie materiaÅ‚Ã³w nÃ³g po zaÅ‚adowaniu krzesÅ‚a
      setTimeout(() => {
        console.log('ðŸŽ¯ Auto-loading leg materials after chair load');
        try { 
          renderFilteredMaterialOptions('legs_material'); 
        } catch(e) { 
          console.warn('Error auto-loading leg materials:', e); 
        }
      }, 500);




      // PrzykÅ‚adowo: gdy zmieniasz krzesÅ‚o, wywoÅ‚ujesz:
      renderPartButtons();




      const arButton = document.getElementById('ar-button');
      if (arButton && !arButton._arInfoBound) {
        arButton.addEventListener('click', (e) => {
          e.stopPropagation();
          if (typeof openArPopup === 'function') openArPopup();
        });
        arButton._arInfoBound = true;
      }


function renderCollectionsAndMaterials(groupedByCollection, targetMesh) {
  console.log(`ðŸŽ¨ renderCollectionsAndMaterials called for: ${targetMesh}`, groupedByCollection);
  
  materialsByMeshAndCollection[targetMesh] = groupedByCollection;
  const isLegs = (targetMesh === 'legs' || targetMesh === 'legs_material');
  const container = document.getElementById(isLegs ? 'legs-panels' : 'fabric-panels');
  
  console.log(`ðŸŽ¨ Container found: ${container ? 'YES' : 'NO'}, isLegs: ${isLegs}`);
  if (!container) {
    console.error(`ðŸŽ¨ Container not found! Looking for: ${isLegs ? 'legs-panels' : 'fabric-panels'}`);
    return;
  }
  
  // ðŸ”§ PRZED wyczyszczeniem - sprawdÅº czy istniejÄ… warianty nÃ³g i zachowaj je
  const existingVariants = container.querySelector('.leg-variants-section');
  let variantsClone = null;
  if (existingVariants) {
    console.log('ðŸ”§ DEBUG: ZachowujÄ™ istniejÄ…ce warianty nÃ³g');
    variantsClone = existingVariants.cloneNode(true);
  }
  
  container.innerHTML = '';
  
  // ðŸ”§ PO wyczyszczeniu - przywrÃ³Ä‡ warianty nÃ³g jeÅ›li byÅ‚y
  if (variantsClone) {
    console.log('ðŸ”§ DEBUG: Przywracam warianty nÃ³g na poczÄ…tek panelu');
    container.appendChild(variantsClone);
    
    // ðŸ”§ NAPRAW obsÅ‚ugÄ™ klikniÄ™Ä‡ - po sklonowaniu trzeba przypisaÄ‡ onclick ponownie
    const variantThumbnails = variantsClone.querySelectorAll('.thumbnail');
    variantThumbnails.forEach((thumb, index) => {
      const legName = thumb.parentElement.querySelector('.thumbnail-caption').textContent;
      const leg = allData.find(d => d.Nazwa === legName && (d.Grupa||'').toLowerCase() === 'nogi');
      
      if (leg) {
        thumb.onclick = () => {
          console.log(`ðŸ”§ DEBUG: KlikniÄ™to wariant nÃ³g: ${leg.Nazwa}`);
          
          // UsuÅ„ wybÃ³r z innych wariantÃ³w
          variantThumbnails.forEach(t => {
            t.style.borderColor = '#e0e0e0';
            t.style.boxShadow = 'none';
            t.style.background = '#fff';
          });
          
          // Dodaj wybÃ³r do klikniÄ™tego
          thumb.style.borderColor = '#F5C842';
          thumb.style.boxShadow = '0 0 0 2px rgba(245,200,66,.4)';
          thumb.style.background = '#fffbe6';
          
          setLegModel(leg);
          
          // OdÅ›wieÅ¼ materiaÅ‚y nÃ³g
          try { renderFilteredMaterialOptions('legs_material'); } catch(e) { console.error(e); }
        };
      }
    });
  }
  const remembered = activeCollectionsByMesh[targetMesh];

  Object.entries(groupedByCollection)
    .sort((a,b)=> a[0].localeCompare(b[0], 'pl', {numeric:true}))
    .forEach(([kolekcja, materiaÅ‚y], idx) => {
      // Zmiana: uÅ¼ywamy div zamiast details
      const collectionDiv = document.createElement('div');
      collectionDiv.className = 'collection-section';
      collectionDiv.dataset.kolekcja = kolekcja;
      
      // Zmiana: uÅ¼ywamy div zamiast summary  
      const header = document.createElement('div');
      header.className = 'collection-header';
      header.textContent = kolekcja;
      collectionDiv.appendChild(header);
      
      const row = document.createElement('div');
      row.className = 'collection-materials-row';

      materiaÅ‚y.forEach(mat => {
        const wrap = document.createElement('div');
        wrap.className = 'thumbnail-wrapper';
        const btn = document.createElement('div');
        btn.className = 'thumbnail';
        btn.title = mat.Nazwa;
        const img = document.createElement('img');
        if (isLegs) {
          // Leg materials: use provided image or fallback by type/collection
          const lowerTyp = (mat.Typ || '').toLowerCase();
          const lowerKol = (mat.Kolekcja || '').toLowerCase();
          const isWood = lowerTyp.includes('drewno') || lowerKol.includes('drewno') || lowerKol.includes('wood');
          img.src = mat.Obrazek || (isWood ? 'icons/drewno.png' : 'icons/m_legs_icon.png');
        } else {
          img.src = mat.Obrazek || 'icons/placeholder.svg';
        }
        img.alt = mat.Nazwa;
        btn.appendChild(img);
        const cap = document.createElement('div');
        cap.className = 'thumbnail-caption';
        cap.textContent = mat.Nazwa;
        wrap.appendChild(btn);
        wrap.appendChild(cap);
        row.appendChild(wrap);
        btn.onclick = () => {
          applyMaterialToSpecificMesh(mat, targetMesh);
          container.querySelectorAll('.thumbnail').forEach(t=>t.classList.remove('selected'));
          btn.classList.add('selected');
        };
      });

      collectionDiv.appendChild(row);
      container.appendChild(collectionDiv);
    });
}

      function checkRotation() {
        const overlay = document.getElementById('rotation-overlay');
        if (!overlay) {
          console.log('âŒ rotation-overlay element not found');
          return;
        }
        
        const isMobile = window.innerWidth <= 1024;
        const isPortrait = window.innerHeight > window.innerWidth;
        
        console.log('ðŸ”„ checkRotation:', {
          width: window.innerWidth,
          height: window.innerHeight,
          isMobile,
          isPortrait,
          shouldShow: isMobile && isPortrait
        });
        
        // JavaScript tylko dla edge cases - CSS media query robi gÅ‚Ã³wnÄ… robotÄ™
        if (isMobile && isPortrait) {
          overlay.style.display = 'flex';
          console.log('âœ… JS: Showing rotation overlay');
        } else {
          overlay.style.display = 'none';
          console.log('âœ… JS: Hiding rotation overlay');
        }
  }
      
      // ðŸ”„ Event listeners dla dynamicznych zmian orientacji
      window.addEventListener('orientationchange', () => {
        setTimeout(checkRotation, 200); // dÅ‚uÅ¼szy delay dla orientationchange
      });
      window.addEventListener('resize', checkRotation);
      
      // ðŸ”„ SprawdÅº po zaÅ‚adowaniu strony
      window.addEventListener('load', () => {
        setTimeout(checkRotation, 100);
      });

      // ðŸ”„ SprawdÅº po DOMContentLoaded
      window.addEventListener('DOMContentLoaded', () => {
        console.log('ðŸ”„ DOMContentLoaded - checking rotation');
        setTimeout(checkRotation, 50);
      });


function setDefaultMaterialsFromSheet() {
  if (!Array.isArray(allData) || !window.selectedChair || !selectedChair.Nazwa) return;

  const modelName = selectedChair.Nazwa.trim().toLowerCase();
  if (typeof window.selectedMaterials !== 'object') window.selectedMaterials = {};

  allData.forEach(row => {
    const modelMatch = row.Default?.trim().toLowerCase();
    const targetRaw = row.TargetMeshOrObiect?.trim().toLowerCase();
    const name = row.Nazwa?.trim();
    const price = parseFloat(row.Cena) || 0;
    const image = row.Obrazek || row.Image || '';

    if (!modelMatch || modelMatch !== modelName || !name || !targetRaw) return;

    if (!selectedMaterials[targetRaw]) selectedMaterials[targetRaw] = [];

    selectedMaterials[targetRaw].push({
      Nazwa: name,
      Cena: price,
      Obrazek: image
    });
  });
}










      // USUNIÄ˜TE PODWÃ“JNE WYWOÅANIE - init() juÅ¼ wywoÅ‚uje siÄ™ w DOMContentLoaded na gÃ³rze
      // Tylko dla fallback jeÅ›li DOM juÅ¼ zaÅ‚adowany
      if (document.readyState !== 'loading') {
        init().catch(error => {
          console.error('Error in init():', error);
          // Ukryj loader w przypadku bÅ‚Ä™du w init()
          const loaderElement = document.getElementById('custom-loader');
          if (loaderElement) {
            loaderElement.style.display = 'none';
          }
          const appElement = document.getElementById('app');
          if (appElement) {
            appElement.style.visibility = 'visible';
          }
        });
      }

      // Funkcja do ustawiania filtra wyszukiwania
      function setSearchFilter(query) {
        currentSearchFilter = query.toLowerCase().trim();
        console.log('ðŸ” Search filter set to:', currentSearchFilter);
        
        // Aktualizuj wskaÅºnik filtra
        const indicator = document.getElementById('search-filter-indicator');
        const filterText = document.getElementById('search-filter-text');
        const clearButton = document.getElementById('clear-search-filter');
        
        if (currentSearchFilter) {
          filterText.textContent = `"${query}"`;
          indicator.style.display = 'block';
        } else {
          indicator.style.display = 'none';
        }
        
        // ObsÅ‚uga przycisku czyszczenia filtra
        if (clearButton && !clearButton.hasAttribute('data-listener')) {
          clearButton.addEventListener('click', () => {
            setSearchFilter('');
            // WyczyÅ›Ä‡ takÅ¼e pole wyszukiwania jeÅ›li jest otwarte
            const searchInput = document.getElementById('search-input');
            if (searchInput) searchInput.value = '';
            const searchResults = document.getElementById('search-results');
            if (searchResults) searchResults.innerHTML = '';
          });
          clearButton.setAttribute('data-listener', 'true');
        }
        
        // OdÅ›wieÅ¼ wszystkie sekcje kafelkÃ³w
        refreshAllTiles();
      }

      // Funkcja sprawdzajÄ…ca czy element pasuje do filtra
      function matchesSearchFilter(item) {
        if (!currentSearchFilter) return true;
        
        const searchableFields = [
          item.Nazwa,
          item.Grupa,
          item.Kategoria,
          item.Kolekcja,
          item.Typ,
          item.Opis
        ];
        
        // JeÅ›li filtr zawiera spacje, traktuj jako listÄ™ nazw do wyszukania
        if (currentSearchFilter.includes(' ')) {
          const searchTerms = currentSearchFilter.split(' ').filter(term => term.trim().length > 0);
          return searchTerms.some(term => 
            searchableFields.some(field => 
              field && field.toLowerCase().includes(term.toLowerCase())
            )
          );
        } else {
          // Pojedynczy termin wyszukiwania
          return searchableFields.some(field => 
            field && field.toLowerCase().includes(currentSearchFilter)
          );
        }
      }

      // Funkcja liczÄ…ca relevance dla elementu wzglÄ™dem filtra
      function getRelevance(item, filter) {
        if (!filter) return 0;
        let relevance = 0;
        const searchTerm = filter.toLowerCase().trim();
        const searchableFields = [
          { field: item.Nazwa, weight: 10 },
          { field: item.Grupa, weight: 8 },
          { field: item.Kategoria, weight: 8 },
          { field: item.Kolekcja, weight: 6 },
          { field: item.Typ, weight: 4 },
          { field: item.Opis, weight: 2 }
        ];
        searchableFields.forEach(({ field, weight }) => {
          if (field && field.toLowerCase().includes(searchTerm)) {
            relevance += weight;
            if (field.toLowerCase().startsWith(searchTerm)) {
              relevance += weight;
            }
          }
        });
        return relevance;
      }

      // Funkcja renderujÄ…ca przyciski kategorii
      function renderCategoryButtons(retryCount = 0) {
        const maxRetries = 10;
  console.log(`ðŸŽ¯ renderCategoryButtons called (attempt ${retryCount + 1}/${maxRetries}), allData:`, (allData ? allData.length : 0));
  console.log('ðŸŽ¯ Mobile mode active:', document.body.classList.contains('mobile-mode'), 'Screen width:', window.innerWidth);
  
        // ðŸ”§ KLUCZOWE: Zapewnij mobile panel na poczÄ…tku jeÅ›li w trybie mobilnym
        if (document.body.classList.contains('mobile-mode') || window.innerWidth <= 820) {
          console.log('ðŸ“± Mobile mode detected - ensuring mobile panel...');
          let mobilePanel = document.getElementById('mobile-right-panel');
          if (!mobilePanel) {
            console.log('ðŸ“± Creating mobile panel...');
            mobilePanel = document.createElement('aside');
            mobilePanel.id = 'mobile-right-panel';
            mobilePanel.style.cssText = 'position:fixed;top:0;right:0;width:160px;height:100vh;background:#fff;border-left:1px solid rgba(0,0,0,0.08);box-shadow:-6px 0 24px rgba(0,0,0,0.06);z-index:150;overflow-y:auto;padding:6px;display:block;visibility:visible;opacity:1';
            (document.getElementById('app') || document.body).appendChild(mobilePanel);
          } else {
            mobilePanel.style.display = 'block';
            mobilePanel.style.visibility = 'visible';
            mobilePanel.style.opacity = '1';
          }
          
          // Clear any loading placeholder
          mobilePanel.innerHTML = '';
          
          // Ensure category section exists
          let categorySection = mobilePanel.querySelector('#category-buttons');
          if (!categorySection) {
            categorySection = document.createElement('div');
            categorySection.id = 'category-buttons';
            categorySection.style.marginBottom = '20px';
            
            const title = document.createElement('h3');
            title.style.cssText = 'margin-bottom: 10px; font-size: 16px; color: #555;';
            title.textContent = 'Kategorie:';
            
            const specialContainer = document.createElement('div');
            specialContainer.id = 'special-categories-container';
            specialContainer.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;';
            
            const regularContainer = document.createElement('div');
            regularContainer.id = 'category-buttons-container';
            regularContainer.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px;';
            
            categorySection.appendChild(title);
            categorySection.appendChild(specialContainer);
            categorySection.appendChild(regularContainer);
            mobilePanel.appendChild(categorySection);
          }
          console.log('ðŸ“± Mobile panel prepared for categories');
        }
        
        // JeÅ›li przyciski juÅ¼ zostaÅ‚y wyrenderowane, nie rÃ³b tego ponownie
        if (isCategoryButtonsRendered && !document.body.classList.contains('mobile-mode')) {
          console.log('ðŸŽ¯ Category buttons already rendered, skipping...');
          return;
        }
        
        // ðŸ” SprawdÅº czy dane sÄ… faktycznie zaÅ‚adowane i nie puste
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('â³ allData is empty or not ready, waiting...');
          if (retryCount < maxRetries) {
            setTimeout(() => renderCategoryButtons(retryCount + 1), 500);
          } else {
            console.error('âŒ allData still not ready after maximum retries');
          }
          return;
        }
        
        // ðŸ” SprawdÅº czy dane majÄ… poprawnÄ… strukturÄ™
        const firstItem = allData[0];
        if (!firstItem || (!firstItem.Kategoria && !firstItem['Kategoria '])) {
          console.log('â³ Data structure not ready, waiting for proper parsing...');
          if (retryCount < maxRetries) {
            setTimeout(() => renderCategoryButtons(retryCount + 1), 500);
          } else {
            console.error('âŒ Data structure still not ready after maximum retries');
          }
          return;
        }
        
        // ðŸ” DEBUGGING: SprawdÅº przykÅ‚adowe dane krzeseÅ‚
        if (allData && allData.length > 0) {
          console.log('ðŸ” DEBUGGING: Pierwszych 5 krzeseÅ‚:', allData.slice(0, 5).map(item => ({
            nazwa: item.Nazwa,
            typ: item.Typ,
            promocja: item.Promocja,
            promocjaRaw: `"${item.Promocja}"`,
            promocjaType: typeof item.Promocja,
            bestseller: item.Bestseller,
            bestsellerRaw: `"${item.Bestseller}"`,
            bestsellerType: typeof item.Bestseller,
            procent: item.Procent
          })));
        }
        
        // SprawdÅº czy DOM jest gotowy
        if (document.readyState === 'loading') {
          console.log('ðŸŽ¯ DOM not ready yet, waiting...');
          document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => renderCategoryButtons(retryCount), 100);
          });
          return;
        }
        
        if (!allData || !Array.isArray(allData)) {
          console.error('âŒ allData is not available or not an array');
          return;
        }
        
        // Dodatkowy debug
        console.log('ðŸŽ¯ Looking for category-buttons-container...');
        const isMobile = document.body.classList.contains('mobile-mode');
        console.log('ðŸŽ¯ isMobile detection result:', isMobile);
        console.log('ðŸŽ¯ Body classes:', document.body.className);
        let targetPanel = isMobile ? document.getElementById('mobile-right-panel') : document.getElementById('sidebar');
        console.log('ðŸŽ¯ targetPanel (mobile-right-panel or sidebar):', targetPanel ? targetPanel.id : 'NOT FOUND');
        if (targetPanel) {
          console.log('ðŸŽ¯ targetPanel display:', window.getComputedStyle(targetPanel).display);
          console.log('ðŸŽ¯ targetPanel visibility:', window.getComputedStyle(targetPanel).visibility);
        }

        // FORCE mobile panel jeÅ›li ekran jest bardzo maÅ‚y, niezaleÅ¼nie od mobile-mode
        if (!targetPanel && window.innerWidth <= 820) {
          console.warn('âš™ï¸ Small screen detected, forcing mobile panel creation');
          try {
            // Force mobile mode
            document.body.classList.add('mobile-mode');
            
            // PrÃ³buj uÅ¼yÄ‡ ensureMobilePanel jeÅ›li jest dostÄ™pne
            if (typeof ensureMobilePanel === 'function') {
              const ctx = ensureMobilePanel();
              if (ctx && ctx.panel) {
                targetPanel = ctx.panel;
                console.log('ðŸŽ¯ Used ensureMobilePanel for forced panel creation');
              }
            }
            
            // Fallback: rÄ™czne tworzenie panelu
            if (!targetPanel) {
              const parent = document.getElementById('app') || document.body;
              const newPanel = document.createElement('aside');
              newPanel.id = 'mobile-right-panel';
              newPanel.style.cssText = 'position: fixed; top: 0; right: 0; width: 33vw; height: 100vh; background: #fff; border-left: 1px solid rgba(0,0,0,0.08); box-shadow: -6px 0 24px rgba(0,0,0,0.06); z-index: 150; overflow-y: auto; padding: 12px; display: block;';
              parent.appendChild(newPanel);
              targetPanel = newPanel;
              
              console.log('ðŸŽ¯ Forced mobile panel created (fallback method)');
            }
            
            // Dostosuj proporcje mobilne po utworzeniu panelu
            if (typeof adjustMobileProportions === 'function') {
              setTimeout(adjustMobileProportions, 10);
            }
          } catch (e) {
            console.error('âŒ Failed to create forced mobile panel:', e);
          }
        }

        // Ensure mobile panel exists on mobile path
        if (isMobile && !targetPanel) {
          console.warn('âš™ï¸ Creating #mobile-right-panel dynamically (mobile path)');
          try {
            const parent = document.getElementById('app') || document.body;
            const newPanel = document.createElement('aside');
            newPanel.id = 'mobile-right-panel';
            newPanel.style.display = 'block';
            parent.appendChild(newPanel);
            targetPanel = newPanel;
            
            // Dostosuj proporcje mobilne po utworzeniu panelu
            if (typeof adjustMobileProportions === 'function') {
              setTimeout(adjustMobileProportions, 10);
            }
          } catch (e) {
            console.error('âŒ Failed to create mobile panel dynamically (mobile path):', e);
          }
        }

        // Desktop path: prefer sidebar; if missing (e.g., iframe/partial DOM), render directly into mobile panel now
        if (!isMobile) {
          const sidebar = document.getElementById('sidebar');
          if (!sidebar) {
            console.warn('âš ï¸ Desktop: sidebar not found â€” falling back to mobile panel rendering');
            try { document.body.classList.add('mobile-mode'); } catch(_) {}
            // Ensure mobile panel exists
            let ctx = null;
            try { ctx = (typeof window.ensureMobilePanel === 'function') ? window.ensureMobilePanel() : (typeof ensureMobilePanel === 'function' ? ensureMobilePanel() : null); } catch(_) {}
            let panel = (ctx && ctx.panel) ? ctx.panel : document.getElementById('mobile-right-panel');
            if (!panel) {
              console.warn('âš™ï¸ Creating #mobile-right-panel dynamically (desktop fallback)');
              try {
                const parent = document.getElementById('app') || document.body;
                const newPanel = document.createElement('aside');
                newPanel.id = 'mobile-right-panel';
                newPanel.style.cssText = 'position: fixed; top: 0; right: 0; width: 280px; height: 100vh; background: #fff; border-left: 1px solid rgba(0,0,0,0.08); box-shadow: -6px 0 24px rgba(0,0,0,0.06); z-index: 150; overflow-y: auto; padding: 12px; display: block;';
                
                // ðŸ“± MOBILE: Copy full sidebar structure to mobile panel
                console.log('ðŸ“± MOBILE: Adding full sidebar structure to mobile panel');
                newPanel.innerHTML = `

                  
                  <!-- Przyciski kategorii z specjalnymi kategoriami -->
                  <div id="category-buttons" style="margin-bottom: 20px;">
                    <h3 style="margin-bottom: 10px; font-size: 16px; color: #555;">Kategorie:</h3>
                    <!-- Specjalne kategorie w jednej linii -->
                    <div id="special-categories-container" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;"></div>
                    <!-- GÅ‚Ã³wne kategorie -->
                    <div id="category-buttons-container" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
                  </div>
                  
                  <div id="model-section" style="display: block;">
                    <div class="selection-section">
                      <h3>Wybierz model:</h3>
                      <div id="model-thumbnails" class="options-grid"></div>
                    </div>
                  </div>
                  
                  <div id="config-section" style="display:none;">
                    <div id="back-to-models-container" style="margin-bottom: 15px;"></div>
                    <div id="legs-section" class="selection-section">
                      <h3>Nogi:</h3>
                      <div id="legs-thumbnails" class="options-grid"></div>
                    </div>
                    <div id="parts-section" class="selection-section">
                      <div id="part-tabs" class="options-grid"></div>
                    </div>
                    <div id="materials-section" class="selection-section">
                      <h3>Wybierz materiaÅ‚:</h3>
                      <div id="material-options" style="display:none;"></div>
                    </div>
                    <div id="summary"></div>
                  </div>
                `;
                parent.appendChild(newPanel);
                panel = newPanel;
                
                // Dostosuj proporcje mobilne po utworzeniu panelu
                if (typeof adjustMobileProportions === 'function') {
                  setTimeout(adjustMobileProportions, 10);
                }
              } catch (e) {
                console.error('âŒ Failed to create mobile panel dynamically:', e);
                if (retryCount < maxRetries) return setTimeout(() => renderCategoryButtons(retryCount + 1), 500);
                return;
              }
            }
            // Create section if missing
            let section = panel.querySelector('#category-buttons');
            if (!section) {
              section = document.createElement('div');
              section.id = 'category-buttons';
              section.style.marginBottom = '20px';
              const title = document.createElement('h3');
              title.style.cssText = 'margin-bottom: 10px; font-size: 16px; color: #555;';
              title.textContent = 'Kategorie:';
              const special = document.createElement('div');
              special.id = 'special-categories-container';
              special.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;';
              const buttons = document.createElement('div');
              buttons.id = 'category-buttons-container';
              buttons.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px;';
              section.appendChild(title);
              section.appendChild(special);
              section.appendChild(buttons);
              const search = panel.querySelector('#search-container');
              if (search && search.nextSibling) panel.insertBefore(section, search.nextSibling); else panel.insertBefore(section, panel.firstChild);
            }
            let containerNow = section.querySelector('#category-buttons-container');
            if (!containerNow) {
              const buttons = document.createElement('div');
              buttons.id = 'category-buttons-container';
              buttons.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px;';
              section.appendChild(buttons);
              containerNow = buttons;
            }
            if (!containerNow) {
              console.error('âŒ Failed to create mobile category container');
              if (retryCount < maxRetries) return setTimeout(() => renderCategoryButtons(retryCount + 1), 500);
              return;
            }
            console.log('âœ… Rendering categories directly into mobile panel');
            renderCategoriesContent(containerNow);
            return;
          }
          let desktopSection = sidebar.querySelector('#category-buttons');
          if (!desktopSection) {
            // Move back from mobile panel if exists
            const movedSection = document.getElementById('category-buttons');
            if (movedSection && movedSection.parentElement !== sidebar) {
              console.log('â†©ï¸ Desktop: moving #category-buttons back to sidebar');
              sidebar.insertBefore(movedSection, document.getElementById('model-section'));
              desktopSection = movedSection;
            }
          }
          if (!desktopSection) {
            // Create fresh structure in sidebar
            desktopSection = document.createElement('div');
            desktopSection.id = 'category-buttons';
            desktopSection.style.marginBottom = '20px';
            const title = document.createElement('h3');
            title.style.cssText = 'margin-bottom: 10px; font-size: 16px; color: #555;';
            title.textContent = 'Kategorie:';
            const special = document.createElement('div');
            special.id = 'special-categories-container';
            special.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;';
            const buttons = document.createElement('div');
            buttons.id = 'category-buttons-container';
            buttons.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px;';
            desktopSection.appendChild(title);
            desktopSection.appendChild(special);
            desktopSection.appendChild(buttons);
            const searchContainer = sidebar.querySelector('#search-container');
            if (searchContainer) sidebar.insertBefore(desktopSection, searchContainer.nextSibling); else sidebar.insertBefore(desktopSection, sidebar.firstChild);
          }
          let desktopContainer = desktopSection.querySelector('#category-buttons-container');
          if (!desktopContainer) {
            const buttons = document.createElement('div');
            buttons.id = 'category-buttons-container';
            buttons.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px;';
            desktopSection.appendChild(buttons);
            desktopContainer = buttons;
          }
          if (!desktopContainer) { console.error('âŒ Desktop: missing buttons container'); return; }
          console.log('âœ… Desktop: ensured category section in sidebar');
          renderCategoriesContent(desktopContainer);
          return;
        }

        // Mobile path: scope to mobile panel and move existing section if needed
        targetPanel = document.getElementById('mobile-right-panel');
        if (!targetPanel) {
          console.error('âŒ Mobile panel not found');
          return;
        }
        // Najpierw sprÃ³buj znaleÅºÄ‡ kontener w obrÄ™bie wÅ‚aÅ›ciwego panelu
        let container = targetPanel ? targetPanel.querySelector('#category-buttons-container') : null;
        if (!container) {
          // JeÅ¼eli istnieje sekcja w innym miejscu (np. sidebar), przenieÅ› jÄ… zamiast duplikowaÄ‡ ID
          const existingSection = document.getElementById('category-buttons');
          if (existingSection && targetPanel && existingSection.parentElement !== targetPanel) {
            console.log('ðŸšš Moving existing #category-buttons into', targetPanel.id);
            targetPanel.insertBefore(existingSection, targetPanel.firstChild);
            container = existingSection.querySelector('#category-buttons-container') || null;
          }
        }
        // Ostatecznie sprawdÅº globalnie (wsteczna kompatybilnoÅ›Ä‡), ale to moÅ¼e wskazaÄ‡ ukryty sidebar
        if (!container) container = document.getElementById('category-buttons-container');
        console.log('ðŸŽ¯ category-buttons-container:', container ? 'FOUND' : 'NOT FOUND');
        
        if (!container) {
          // SprÃ³buj rÄ™cznie stworzyÄ‡ kontener jeÅ›li nie istnieje
          if (targetPanel) {
            console.log('ðŸŽ¯ Trying to create missing category container...');
            
            // ZnajdÅº lub stwÃ³rz sekcjÄ™ kategorii
            let categorySection = targetPanel.querySelector('#category-buttons');
            if (!categorySection) {
              categorySection = document.createElement('div');
              categorySection.id = 'category-buttons';
              categorySection.style.cssText = 'margin-bottom: 20px;';
              
              const title = document.createElement('h3');
              title.style.cssText = 'margin-bottom: 10px; font-size: 16px; color: #555;';
              title.textContent = 'Kategorie:';
              categorySection.appendChild(title);
              
              const buttonsContainer = document.createElement('div');
              buttonsContainer.id = 'category-buttons-container';
              buttonsContainer.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px;';
              categorySection.appendChild(buttonsContainer);
              
              // Dodaj przed search container lub na poczÄ…tku
              const searchContainer = targetPanel.querySelector('#search-container');
              if (searchContainer) {
                targetPanel.insertBefore(categorySection, searchContainer.nextSibling);
              } else {
                targetPanel.insertBefore(categorySection, targetPanel.firstChild);
              }
              
              console.log('ðŸŽ¯ Created missing category section in', targetPanel.id);
            }
            
            // SprÃ³buj ponownie pobraÄ‡ kontener
            const newContainer = targetPanel.querySelector('#category-buttons-container') || document.getElementById('category-buttons-container');
            if (newContainer) {
              console.log('ðŸŽ¯ Successfully created category-buttons-container in', targetPanel.id);
              // Kontynuuj z renderowaniem
              renderCategoriesContent(newContainer);
              return;
            }
          }
          
          if (retryCount < maxRetries) {
            console.error(`âŒ category-buttons-container not found, retrying in 500ms... (${retryCount + 1}/${maxRetries})`);
            setTimeout(() => renderCategoryButtons(retryCount + 1), 500);
          } else {
            console.error('âŒ category-buttons-container not found after maximum retries, giving up');
          }
          return;
        }
        
        renderCategoriesContent(container);
      }
      
      // Wydzielona funkcja renderowania zawartoÅ›ci kategorii
      function renderCategoriesContent(container) {
        container.innerHTML = '';
        
        // ZnajdÅº kontener na specjalne kategorie
        const specialContainer = document.getElementById('special-categories-container');
        if (specialContainer) {
          specialContainer.innerHTML = '';
        }
        
        // ZnajdÅº wszystkie unikalne kategorie
        console.log('ðŸ” DEBUG - Sample allData items:');
        console.log('First 3 items:', allData.slice(0, 3));
        console.log('All item.Kategoria values:', allData.map(item => item.Kategoria));
        console.log('All item.Typ values:', allData.map(item => item.Typ));
        console.log('All item.Grupa values:', allData.map(item => item.Grupa));
        
        // ðŸ”§ DEBUGOWANIE: SprawdÅº rÃ³Å¼ne kombinacje filtrÃ³w
        const byTyp = allData.filter(item => item.Kategoria && item.Typ === 'model');
        const byGrupa = allData.filter(item => item.Kategoria && (item.Grupa === 'krzesÅ‚o' || item.Grupa === 'kubeÅ‚ek'));
        const anyModel = allData.filter(item => item.Kategoria && (item.Typ || item.Grupa));
        
        console.log('ðŸ” Items by Typ=model:', byTyp.length);
        console.log('ðŸ” Items by Grupa=krzesÅ‚o/kubeÅ‚ek:', byGrupa.length);
        console.log('ðŸ” Items with any Typ or Grupa:', anyModel.length);
        console.log('ðŸ” Total items with Kategoria:', allData.filter(item => item.Kategoria).length);
        
        // Bardziej elastyczna logika dla nowego arkusza - sprawdÅº wszystkie moÅ¼liwe warianty
        let itemsForCategories = allData.filter(item => {
          if (!item.Kategoria) return false;
          
          // SprawdÅº rÃ³Å¼ne moÅ¼liwe wartoÅ›ci
          const isModel = item.Typ === 'model' || 
                         item.Grupa === 'krzesÅ‚o' || 
                         item.Grupa === 'kubeÅ‚ek' ||
                         item.Grupa?.toLowerCase() === 'krzesÅ‚o' ||
                         item.Grupa?.toLowerCase() === 'kubeÅ‚ek' ||
                         item.Typ?.toLowerCase() === 'model';
          
          return isModel;
        });
        
        console.log('ðŸ” Items for categories (flexible):', itemsForCategories.length);
        
        // JeÅ›li nadal brak elementÃ³w, sprÃ³buj jeszcze bardziej elastyczne podejÅ›cie
        if (itemsForCategories.length === 0) {
          console.warn('âš ï¸ No items found with standard filters, trying more flexible approach...');
          itemsForCategories = allData.filter(item => item.Kategoria && item.Kategoria.trim() !== '');
          console.log('ðŸ” Items with any Kategoria:', itemsForCategories.length);
          
          if (itemsForCategories.length > 0) {
            console.log('ðŸ” Sample items with categories:', itemsForCategories.slice(0, 3));
          }
        }
        
        const categories = [...new Set(itemsForCategories
          .map(item => item.Kategoria)
          .flatMap(kategoria => {
            // ObsÅ‚uga kategorii rozdzielonych przecinkami (np. "krzesÅ‚a, hookery")
            return kategoria.split(',').map(k => k.trim());
          })
        )].filter(cat => cat && cat !== ''); // UsuÅ„ puste kategorie
        
        console.log('Found categories:', categories);
        console.log('Filtered items for categories:', itemsForCategories.length);
        
        // ðŸ”§ ZABEZPIECZENIE: JeÅ›li brak kategorii, dodaj podstawowe
        if (categories.length === 0) {
          console.warn('âš ï¸ No categories found, adding default categories');
          // SprÃ³buj znaleÅºÄ‡ jakiekolwiek unikalne wartoÅ›ci Kategoria
          const anyCategories = [...new Set(allData
            .filter(item => item.Kategoria && item.Kategoria.trim() !== '')
            .map(item => item.Kategoria)
            .flatMap(kategoria => kategoria.split(',').map(k => k.trim()))
          )];
          
          if (anyCategories.length > 0) {
            categories.push(...anyCategories);
            console.log('ðŸ”§ Added fallback categories:', anyCategories);
          } else {
            // Ostatnia deska ratunku - dodaj podstawowe kategorie
            categories.push('KrzesÅ‚a', 'Fotele', 'Hokery');
            console.log('ðŸ”§ Added emergency default categories');
          }
        }
        
        // ===== SPECJALNE KATEGORIE W PIERWSZEJ LINII =====
        if (specialContainer) {
          console.log('ðŸŽ¯ Creating special category buttons...');
          
          // Dodaj przycisk "Wszystkie" - ZAWSZE
          const allButton = document.createElement('button');
          allButton.className = 'category-button special-category';  // UsuÅ„ 'active' na starcie
          allButton.textContent = 'Wszystkie';
          allButton.style.cssText = 'padding: 8px 16px; border: 2px solid #F5C842; background: white; color: #333; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; text-transform: capitalize;';
          allButton.onclick = () => {
            try { window.__userCategoryPicked = true; } catch(_){}
            // Reset wyszukiwania przy klikniÄ™ciu w kategoriÄ™
            if (currentSearchFilter) {
              console.log('ðŸ”„ Resetowanie wyszukiwania przy przeÅ‚Ä…czeniu na kategoriÄ™ "Wszystkie"');
              setSearchFilter('');
              const searchInput = document.getElementById('search-input');
              if (searchInput) searchInput.value = '';
            }
            
            document.querySelectorAll('.category-button').forEach(btn => {
              btn.classList.remove('active');
              btn.style.background = 'white';
              btn.style.color = btn.classList.contains('promotion') ? '#FF6B6B' : '#333';
            });
            allButton.classList.add('active');
            allButton.style.background = '#F5C842';
            allButton.style.color = '#333';
            renderAllModels();
          };
          specialContainer.appendChild(allButton);
          console.log('âœ… Added "Wszystkie" button to special container');
          
          // ðŸ” DEBUGGING: SprawdÅº wszystkie krzesÅ‚a z modelami
          const allModels = allData.filter(item => item.Typ === 'model');
          console.log('ðŸ” DEBUGGING: Wszystkie modele krzeseÅ‚:', allModels.length);
          console.log('ðŸ” DEBUGGING: Modele z promocjÄ…/bestsellerem:', allModels.map(item => ({
            nazwa: item.Nazwa,
            promocja: item.Promocja,
            promocjaType: typeof item.Promocja,
            bestseller: item.Bestseller,
            bestsellerType: typeof item.Bestseller,
            procent: item.Procent,
            procentType: typeof item.Procent
          })));
          
          // SprawdÅº czy sÄ… krzesÅ‚a na promocji
          const promotionalModels = allData.filter(item => {
            // Bardziej elastyczna logika dla nowego arkusza
            const isModel = item.Typ === 'model' || 
                           item.Grupa === 'krzesÅ‚o' || 
                           item.Grupa === 'kubeÅ‚ek' ||
                           item.Grupa?.toLowerCase() === 'krzesÅ‚o' ||
                           item.Grupa?.toLowerCase() === 'kubeÅ‚ek' ||
                           item.Typ?.toLowerCase() === 'model';
            
            // SprawdÅº rÃ³Å¼ne moÅ¼liwe wartoÅ›ci promocji
            const hasPromotion = item.Promocja === 'TRUE' || 
                                item.Promocja === 'true' || 
                                item.Promocja === 'tak' || 
                                item.Promocja === 'âœ”' ||
                                item.Promocja?.toLowerCase() === 'true' ||
                                item.Promocja?.toLowerCase() === 'tak' ||
                                (item.Promocja && item.Promocja.toString().trim() !== '' && item.Promocja !== 'FALSE' && item.Promocja !== 'false');
            
            const hasPercent = item.Procent && parseFloat(item.Procent) > 0;
            return isModel && hasPromotion && hasPercent;
          });
          
          console.log('ðŸ”¥ DEBUGGING: Znalezione krzesÅ‚a na promocji:', promotionalModels.length);
          console.log('ðŸ”¥ DEBUGGING: Lista promocji:', promotionalModels.map(item => ({ 
            nazwa: item.Nazwa, 
            promocja: item.Promocja, 
            procent: item.Procent,
            typ: item.Typ,
            grupa: item.Grupa
          })));
          
          // ðŸ”§ DODATKOWE DEBUGOWANIE: SprawdÅº wszystkie elementy z polem Promocja
          const allWithPromotion = allData.filter(item => item.Promocja && item.Promocja.toString().trim() !== '');
          console.log('ðŸ”¥ All items with Promocja field:', allWithPromotion.length);
          console.log('ðŸ”¥ Promocja values:', [...new Set(allData.map(item => item.Promocja).filter(p => p && p.toString().trim() !== ''))]);
          
          // JeÅ›li nie ma promocji, sprÃ³buj bardziej elastyczne podejÅ›cie
          if (promotionalModels.length === 0) {
            console.warn('âš ï¸ No promotional models found with standard logic, trying flexible approach...');
            const flexiblePromo = allData.filter(item => {
              const hasCategory = item.Kategoria && item.Kategoria.trim() !== '';
              const hasPromoField = item.Promocja && item.Promocja.toString().trim() !== '';
              return hasCategory && hasPromoField;
            });
            console.log('ðŸ”¥ Flexible promotion search:', flexiblePromo.length);
            if (flexiblePromo.length > 0) {
              console.log('ðŸ”¥ Sample flexible promo items:', flexiblePromo.slice(0, 3));
            }
          }
          
          // JeÅ›li sÄ… krzesÅ‚a na promocji, dodaj przycisk "Promocje"
          if (promotionalModels.length > 0) {
            const promoButton = document.createElement('button');
            promoButton.className = 'category-button promotion special-category';
            promoButton.textContent = 'ðŸ”¥ Promocje';
            promoButton.style.cssText = 'padding: 8px 16px; border: 2px solid #FF6B6B; background: white; color: #FF6B6B; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; text-transform: capitalize;';
            promoButton.onclick = () => {
              try { window.__userCategoryPicked = true; } catch(_){}
              // Reset wyszukiwania przy klikniÄ™ciu w kategoriÄ™
              if (currentSearchFilter) {
                console.log('ðŸ”„ Resetowanie wyszukiwania przy przeÅ‚Ä…czeniu na kategoriÄ™ "Promocje"');
                setSearchFilter('');
                const searchInput = document.getElementById('search-input');
                if (searchInput) searchInput.value = '';
              }
              
              document.querySelectorAll('.category-button').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'white';
                btn.style.color = btn.classList.contains('promotion') ? '#FF6B6B' : '#333';
              });
              promoButton.classList.add('active');
              promoButton.style.background = '#FF6B6B';
              promoButton.style.color = 'white';
              renderPromotionalModels();
            };
            
            // Hover efekty dla promocji
            promoButton.onmouseenter = () => {
              if (!promoButton.classList.contains('active')) {
                promoButton.style.background = '#FF6B6B';
                promoButton.style.color = 'white';
                promoButton.style.transform = 'translateY(-1px)';
              }
            };
            
            promoButton.onmouseleave = () => {
              if (!promoButton.classList.contains('active')) {
                promoButton.style.background = 'white';
                promoButton.style.color = '#FF6B6B';
                promoButton.style.transform = 'translateY(0)';
              }
            };
            
            specialContainer.appendChild(promoButton);
            console.log('Added "Promocje" button with', promotionalModels.length, 'items');
          }
          
          // SprawdÅº czy sÄ… bestsellery
          const bestsellerModels = allData.filter(item => {
            // Bardziej elastyczna logika dla nowego arkusza
            const isModel = item.Typ === 'model' || 
                           item.Grupa === 'krzesÅ‚o' || 
                           item.Grupa === 'kubeÅ‚ek' ||
                           item.Grupa?.toLowerCase() === 'krzesÅ‚o' ||
                           item.Grupa?.toLowerCase() === 'kubeÅ‚ek' ||
                           item.Typ?.toLowerCase() === 'model';
            
            // SprawdÅº rÃ³Å¼ne moÅ¼liwe wartoÅ›ci bestseller
            const isBestseller = item.Bestseller === 'TRUE' || 
                               item.Bestseller === 'true' || 
                               item.Bestseller === 'tak' || 
                               item.Bestseller === 'âœ”' ||
                               item.Bestseller?.toLowerCase() === 'true' ||
                               item.Bestseller?.toLowerCase() === 'tak' ||
                               (item.Bestseller && item.Bestseller.toString().trim() !== '' && item.Bestseller !== 'FALSE' && item.Bestseller !== 'false');
            
            return isModel && isBestseller;
          });
          
          console.log('â­ DEBUGGING: Znalezione bestsellery:', bestsellerModels.length);
          console.log('â­ DEBUGGING: Lista bestsellerÃ³w:', bestsellerModels.map(item => ({ 
            nazwa: item.Nazwa, 
            bestseller: item.Bestseller,
            typ: item.Typ,
            grupa: item.Grupa
          })));
          
          // ðŸ”§ DODATKOWE DEBUGOWANIE: SprawdÅº wszystkie elementy z polem Bestseller
          const allWithBestseller = allData.filter(item => item.Bestseller && item.Bestseller.toString().trim() !== '');
          console.log('â­ All items with Bestseller field:', allWithBestseller.length);
          console.log('â­ Bestseller values:', [...new Set(allData.map(item => item.Bestseller).filter(b => b && b.toString().trim() !== ''))]);
          
          // JeÅ›li nie ma bestsellerÃ³w, sprÃ³buj bardziej elastyczne podejÅ›cie
          if (bestsellerModels.length === 0) {
            console.warn('âš ï¸ No bestseller models found with standard logic, trying flexible approach...');
            const flexibleBest = allData.filter(item => {
              const hasCategory = item.Kategoria && item.Kategoria.trim() !== '';
              const hasBestField = item.Bestseller && item.Bestseller.toString().trim() !== '';
              return hasCategory && hasBestField;
            });
            console.log('â­ Flexible bestseller search:', flexibleBest.length);
            if (flexibleBest.length > 0) {
              console.log('â­ Sample flexible bestseller items:', flexibleBest.slice(0, 3));
            }
          }
          
          // JeÅ›li sÄ… bestsellery, dodaj przycisk "Bestsellery"
          if (bestsellerModels.length > 0) {
            const bestsellerButton = document.createElement('button');
            bestsellerButton.className = 'category-button bestseller special-category';
            bestsellerButton.textContent = 'â­ Bestsellery';
            bestsellerButton.style.cssText = 'padding: 8px 16px; border: 2px solid #f5c842; background: white; color: #333; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; text-transform: capitalize;';
            bestsellerButton.onclick = () => {
              try { window.__userCategoryPicked = true; } catch(_){}
              // Reset wyszukiwania przy klikniÄ™ciu w kategoriÄ™
              if (currentSearchFilter) {
                console.log('ðŸ”„ Resetowanie wyszukiwania przy przeÅ‚Ä…czeniu na kategoriÄ™ "Bestsellery"');
                setSearchFilter('');
                const searchInput = document.getElementById('search-input');
                if (searchInput) searchInput.value = '';
              }
              
              document.querySelectorAll('.category-button').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'white';
                btn.style.color = btn.classList.contains('promotion') ? '#FF6B6B' : '#333';
              });
              bestsellerButton.classList.add('active');
              bestsellerButton.style.background = '#f5c842';
              bestsellerButton.style.color = '#333';
              renderBestsellerModels();
            };
            
            // Hover efekty dla bestsellerÃ³w
            bestsellerButton.onmouseenter = () => {
              if (!bestsellerButton.classList.contains('active')) {
                bestsellerButton.style.background = '#f5c842';
                bestsellerButton.style.color = '#333';
                bestsellerButton.style.transform = 'translateY(-1px)';
              }
            };
            
            bestsellerButton.onmouseleave = () => {
              if (!bestsellerButton.classList.contains('active')) {
                bestsellerButton.style.background = 'white';
                bestsellerButton.style.color = '#333';
                bestsellerButton.style.transform = 'translateY(0)';
              }
            };
            
            specialContainer.appendChild(bestsellerButton);
            console.log('Added "Bestsellery" button with', bestsellerModels.length, 'items');
          }
        }
        
        // ===== GÅÃ“WNE KATEGORIE W DRUGIEJ LINII =====
        console.log('ðŸŽ¯ Creating main category buttons for', categories.length, 'categories:', categories);
        
        // Dodaj przyciski dla kaÅ¼dej kategorii
        categories.forEach((category, index) => {
          console.log(`ðŸŽ¯ Creating button ${index + 1}/${categories.length} for category:`, category);
          
          const button = document.createElement('button');
          button.className = 'category-button';
          button.textContent = category;
          
          // Ustaw style dla kategorii (zawsze zÅ‚ote, niezaleÅ¼nie od promocji)
          button.style.cssText = 'padding: 8px 16px; border: 2px solid #F5C842; background: white; color: #333; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; text-transform: capitalize;';
          
          // SprawdÅº czy kategoria ma promocje - ale nie zmieniaj stylu przyciskÃ³w kategorii
          const hasPromotion = allData.some(item => {
            // SprawdÅº kategoriÄ™ - obsÅ‚uga kategorii rozdzielonych przecinkami
            let belongsToCategory = false;
            if (item.Kategoria) {
              const itemCategories = item.Kategoria.split(',').map(k => k.trim());
              belongsToCategory = itemCategories.includes(category);
            }
            
            // Poprawiona logika dla nowego arkusza
            const isModel = item.Typ === 'model' || item.Grupa === 'krzesÅ‚o' || item.Grupa === 'kubeÅ‚ek';
            const hasPromo = item.Promocja && item.Promocja.trim() !== '';
            
            return belongsToCategory && isModel && hasPromo;
          });
          
          // USUNIÄ˜TO: kategorie zawsze sÄ… Å¼Ã³Å‚te, niezaleÅ¼nie od promocji
          // if (hasPromotion) {
          //   button.classList.add('promotion');
          //   button.style.borderColor = '#FF6B6B';
          //   button.style.color = '#FF6B6B';
          // }
          
          button.onclick = () => {
            try { window.__userCategoryPicked = true; } catch(_){}
            // Reset filtra wyszukiwania jeÅ›li jest aktywny
            if (currentSearchFilter) {
              setSearchFilter('');
              const searchInput = document.getElementById('search-input');
              if (searchInput) {
                searchInput.value = '';
              }
            }
            
            document.querySelectorAll('.category-button').forEach(btn => {
              btn.classList.remove('active');
              btn.style.background = 'white';
              btn.style.color = btn.classList.contains('promotion') ? '#FF6B6B' : '#333';
            });
            button.classList.add('active');
            // Zawsze Å¼Ã³Å‚te po klikniÄ™ciu (kategorie nie sÄ… czerwone)
            button.style.background = '#F5C842';
            button.style.color = '#333';
            renderModelsByCategory(category);
          };
          
          // Dodaj hover efekty - zawsze Å¼Ã³Å‚te
          button.onmouseenter = () => {
            if (!button.classList.contains('active')) {
              button.style.background = '#F5C842';
              button.style.color = '#333';
              button.style.transform = 'translateY(-1px)';
            }
          };
          
          button.onmouseleave = () => {
            if (!button.classList.contains('active')) {
              button.style.background = 'white';
              button.style.color = '#333';
              button.style.transform = 'translateY(0)';
            }
          };
          
          container.appendChild(button);
          console.log(`âœ… Added category button: "${category}"`);
        });
        
        // Oznacz, Å¼e przyciski kategorii zostaÅ‚y wyrenderowane
        isCategoryButtonsRendered = true;
        console.log('ðŸŽ¯ Category buttons rendering completed, flag set');
        console.log('ðŸŽ¯ Final summary:');
        console.log('  - Special buttons created:', specialContainer ? specialContainer.children.length : 0);
        console.log('  - Category buttons created:', container.children.length);
        console.log('  - Total categories processed:', categories.length);
      }

      // ===== WARIANTY PRODUKTÃ“W =====
      // Grupowanie modeli po Nazwie i obsÅ‚uga popupu z wariantami

      // Zgrupuj modele po polu Nazwa; jeÅ¼eli sÄ… wielokrotne wpisy o tej samej nazwie (rÃ³Å¼ne Wariant), pokaÅ¼ jeden kafelek i popup z wariantami
      function groupVariants(models) {
        if (!Array.isArray(models)) return [];
        const byName = new Map();
        models.forEach(m => {
          const key = (m.Nazwa || '').trim();
          if (!key) return;
          if (!byName.has(key)) byName.set(key, []);
          byName.get(key).push(m);
        });

        const result = [];
        byName.forEach((arr, name) => {
          // Posortuj: preferuj rekord bez Wariant jako bazowy (jeÅ›li jest)
          const sorted = arr.slice().sort((a,b) => {
            const av = (a.Wariant || '').trim(); const bv = (b.Wariant || '').trim();
            if (av && !bv) return 1; // bez wariantu pierwsze
            if (!av && bv) return -1;
            return 0;
          });

          const base = sorted[0];
          const distinctVariants = new Set(sorted.map(x => (x.Wariant || '').trim()).filter(Boolean));
          const hasVariants = sorted.length > 1 || distinctVariants.size > 0;

          const displayItem = { ...base };
          displayItem._hasVariants = !!hasVariants;
          displayItem._allVariants = sorted;
          // Upewnij siÄ™, Å¼e nazwa do wyÅ›wietlenia nie zawiera sufiksu wariantu
          displayItem._displayName = name;
          result.push(displayItem);
        });

        return result;
      }

      // Po klikniÄ™ciu kafelka modelu: jeÅ›li ma warianty, otwÃ³rz popup; inaczej od razu Å‚aduj model
      function handleModelClick(item) {
        if (item && item._hasVariants && Array.isArray(item._allVariants) && item._allVariants.length) {
          showVariantPopup(item._allVariants);
        } else {
          loadModel(item);
        }
      }

      // Popup wyboru wariantu (siatka miniatur + nazwa + cena + Å¼Ã³Å‚ty Anuluj)
      function showVariantPopup(variants) {
        // UsuÅ„ istniejÄ…cy popup jeÅ›li jest
        const old = document.getElementById('variants-modal');
        if (old) old.remove();

        const overlay = document.createElement('div');
        overlay.id = 'variants-modal';
        overlay.style.cssText = `
          position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 9999;
          display: flex; align-items: center; justify-content: center;
        `;

        // Oblicz optymalnÄ… szerokoÅ›Ä‡ na podstawie iloÅ›ci wariantÃ³w
        const variantCount = variants.length;
        const itemWidth = 160; // szerokoÅ›Ä‡ jednego kafelka
        const gap = 20; // odstÄ™p miÄ™dzy kafelkami (zwiÄ™kszony)
        const padding = 60; // padding wewnÄ™trzny (po 30px z kaÅ¼dej strony)
        const maxColumns = Math.min(4, variantCount); // maksymalnie 4 kolumny
        const actualColumns = Math.min(maxColumns, variantCount);
        const calculatedWidth = (actualColumns * itemWidth) + ((actualColumns - 1) * gap) + padding;
        const modalWidth = Math.max(420, calculatedWidth + 20); // dodaj trochÄ™ bufora

        const modal = document.createElement('div');
        modal.style.cssText = `
          background: #fff; border-radius: 12px; width: ${modalWidth}px; max-height: 80vh; overflow: hidden;
          box-shadow: 0 10px 30px rgba(0,0,0,0.3);
          display: flex; flex-direction: column; max-width: 90vw;
        `;

        const header = document.createElement('div');
        header.style.cssText = `padding: 16px 30px; border-bottom: 1px solid #eee; font-weight: 700; font-size: 16px; text-align: center;`;
        header.textContent = 'Wybierz wariant';

        const grid = document.createElement('div');
        grid.style.cssText = `
          padding: 20px 30px; display: grid; gap: ${gap}px;
          grid-template-columns: repeat(${actualColumns}, ${itemWidth}px);
          justify-content: center; align-items: start;
          width: 100%; box-sizing: border-box;
        `;

        variants.forEach(variant => {
          const wrap = document.createElement('div');
          wrap.style.cssText = `
            border: 2px solid #333; border-radius: 8px; padding: 10px; cursor: pointer; background: #fafafa;
            transition: transform 0.15s ease, box-shadow 0.15s ease; width: ${itemWidth}px;
            box-sizing: border-box;
          `;
          wrap.onmouseenter = () => { wrap.style.transform = 'translateY(-2px)'; wrap.style.boxShadow = '0 4px 12px rgba(0,0,0,0.15)'; };
          wrap.onmouseleave = () => { wrap.style.transform = 'none'; wrap.style.boxShadow = 'none'; };
          wrap.onclick = () => { document.body.removeChild(overlay); loadModel(variant); };

          const img = document.createElement('img');
          img.src = variant.Obrazek || variant.Image || 'icons/placeholder.svg';
          img.alt = (variant.Nazwa || '') + (variant.Wariant ? ` ${variant.Wariant}` : '');
          img.style.cssText = 'width: 100%; aspect-ratio: 1/1; object-fit: contain; border-radius: 6px; background:#fff;';

          const title = document.createElement('div');
          title.style.cssText = 'margin-top: 8px; font-weight: 600; font-size: 14px; color: #222; text-align: center; line-height: 1.2;';
          title.textContent = variant.Nazwa || '';

          // Dodaj etykietÄ™ wariantu z odpowiednim opisem
          const variantLabel = document.createElement('div');
          if (variant.Wariant && variant.Wariant.trim() !== '') {
            const grupa = (variant.Grupa || '').toLowerCase();
            let labelText = '';
            
            if (grupa === 'krzesÅ‚o') {
              labelText = `Kolor: ${variant.Wariant}`;
            } else if (grupa === 'kubeÅ‚ek') {
              labelText = `StelaÅ¼: ${variant.Wariant}`;
            } else {
              labelText = variant.Wariant; // fallback
            }
            
            variantLabel.style.cssText = 'margin-top: 4px; font-weight: 600; font-size: 13px; color: #444; text-align: center; line-height: 1.2; background: rgba(245,196,66,0.15); padding: 3px 6px; border-radius: 4px; margin-bottom: 2px;';
            variantLabel.textContent = labelText;
          }

          const price = document.createElement('div');
          price.style.cssText = 'margin-top: 4px; font-weight: 700; color: #333; text-align: center; font-size: 14px;';
          const p = parseFloat(variant.Cena) || 0; price.textContent = `${p.toFixed(2)} PLN`;

          wrap.appendChild(img);
          wrap.appendChild(title);
          if (variant.Wariant && variant.Wariant.trim() !== '') {
            wrap.appendChild(variantLabel);
          }
          wrap.appendChild(price);
          grid.appendChild(wrap);
        });

        const footer = document.createElement('div');
        footer.style.cssText = 'padding: 12px 30px; border-top: 1px solid #eee; display:flex; justify-content:center;';
        const cancel = document.createElement('button');
        cancel.textContent = 'Anuluj';
        cancel.style.cssText = `
          background: #F5C842; color: #111; border: none; border-radius: 6px; padding: 10px 24px; font-weight: 700;
          cursor: pointer; box-shadow: 0 2px 0 rgba(0,0,0,0.15); font-size: 14px;
        `;
        cancel.onclick = () => { document.body.removeChild(overlay); };
        footer.appendChild(cancel);

        modal.appendChild(header);
        modal.appendChild(grid);
        modal.appendChild(footer);
        overlay.appendChild(modal);
        overlay.addEventListener('click', (e) => { if (e.target === overlay) document.body.removeChild(overlay); });
        document.body.appendChild(overlay);
      }

      // Funkcja renderujÄ…ca wszystkie modele
      function renderAllModels() {
        // Poprawiona logika dla nowego arkusza
        const models = allData.filter(item => {
          // SprawdÅº czy to model (Typ=model lub Grupa=krzesÅ‚o/kubeÅ‚ek)
          return item.Typ === 'model' || item.Grupa === 'krzesÅ‚o' || item.Grupa === 'kubeÅ‚ek';
        });
        
        console.log('ðŸ“¦ Rendering all models:', models.length, 'items');
        console.log('ðŸ“¦ All models:', models.map(m => ({ Nazwa: m.Nazwa, Kategoria: m.Kategoria, Grupa: m.Grupa, Typ: m.Typ })));
        
        // PokaÅ¼ sekcjÄ™ modeli
        document.getElementById('model-section').style.display = 'block';
        document.getElementById('config-section').style.display = 'none';
        
        // WyczyÅ›Ä‡ filtr wyszukiwania jeÅ›li jest aktywny
        const searchFilterIndicator = document.getElementById('search-filter-indicator');
        if (searchFilterIndicator) {
          searchFilterIndicator.style.display = 'none';
        }
        
        const grouped = groupVariants(models);
        renderOptions('model-thumbnails', grouped, item => handleModelClick(item));
      }

      // Funkcja renderujÄ…ca modele promocyjne
      function renderPromotionalModels() {
        console.log('ðŸ” Checking promotional models...');
  console.log('AllData length:', (allData ? allData.length : 0));
        
        if (!allData || allData.length === 0) {
          console.error('âŒ No allData available for promotions');
          return;
        }
        
        // PokaÅ¼ sekcjÄ™ modeli
        document.getElementById('model-section').style.display = 'block';
        document.getElementById('config-section').style.display = 'none';
        
        // WyczyÅ›Ä‡ filtr wyszukiwania jeÅ›li jest aktywny
        const searchFilterIndicator = document.getElementById('search-filter-indicator');
        if (searchFilterIndicator) {
          searchFilterIndicator.style.display = 'none';
        }
        
        const promotionalModels = allData.filter(item => {
          // Poprawiona logika dla nowego arkusza
          const isModel = item.Typ === 'model' || item.Grupa === 'krzesÅ‚o' || item.Grupa === 'kubeÅ‚ek';
          // ObsÅ‚uga checkbox z Google Sheets: TRUE, true, tak, âœ”
          const hasPromotion = item.Promocja === 'TRUE' || item.Promocja === 'true' || item.Promocja === 'tak' || item.Promocja === 'âœ”';
          const hasPercent = item.Procent && parseFloat(item.Procent) > 0;
          
          console.log(`Item: ${item.Nazwa}, Typ: ${item.Typ}, Grupa: ${item.Grupa}, Promocja: "${item.Promocja}", Procent: ${item.Procent}, isModel: ${isModel}, hasPromotion: ${hasPromotion}, hasPercent: ${hasPercent}`);
          
          return isModel && hasPromotion && hasPercent;
        });
        
        console.log('ðŸ”¥ Rendering promotional models:', promotionalModels.length, 'items');
        console.log('Promotional models:', promotionalModels);
        
        if (promotionalModels.length === 0) {
          document.getElementById('model-thumbnails').innerHTML = '<div style="text-align: center; padding: 40px; color: #666; font-style: italic;">Brak produktÃ³w na promocji.<br><br>Aby dodaÄ‡ promocjÄ™, przejdÅº do panelu administracyjnego i ustaw "Promocja: tak" oraz procent obniÅ¼ki przy wybranych krzesÅ‚ach.</div>';
        } else {
          const grouped = groupVariants(promotionalModels);
          renderOptions('model-thumbnails', grouped, item => handleModelClick(item));
        }
      }

      // Funkcja renderujÄ…ca modele bestsellery
      function renderBestsellerModels() {
        console.log('ðŸ” Checking bestseller models...');
  console.log('AllData length:', (allData ? allData.length : 0));
        
        if (!allData || allData.length === 0) {
          console.error('âŒ No allData available for bestsellers');
          return;
        }
        
        // PokaÅ¼ sekcjÄ™ modeli
        document.getElementById('model-section').style.display = 'block';
        document.getElementById('config-section').style.display = 'none';
        
        // WyczyÅ›Ä‡ filtr wyszukiwania jeÅ›li jest aktywny
        const searchFilterIndicator = document.getElementById('search-filter-indicator');
        if (searchFilterIndicator) {
          searchFilterIndicator.style.display = 'none';
        }
        
        const bestsellerModels = allData.filter(item => {
          // Poprawiona logika dla nowego arkusza
          const isModel = item.Typ === 'model' || item.Grupa === 'krzesÅ‚o' || item.Grupa === 'kubeÅ‚ek';
          // ObsÅ‚uga checkbox z Google Sheets: TRUE, true, tak, âœ”
          const isBestseller = item.Bestseller === 'TRUE' || item.Bestseller === 'true' || item.Bestseller === 'tak' || item.Bestseller === 'âœ”';
          
          console.log(`Item: ${item.Nazwa}, Typ: ${item.Typ}, Grupa: ${item.Grupa}, Bestseller: "${item.Bestseller}", isModel: ${isModel}, isBestseller: ${isBestseller}`);
          
          return isModel && isBestseller;
        });
        
        console.log('â­ Rendering bestseller models:', bestsellerModels.length, 'items');
        console.log('Bestseller models:', bestsellerModels);
        
        if (bestsellerModels.length === 0) {
          document.getElementById('model-thumbnails').innerHTML = '<div style="text-align: center; padding: 40px; color: #666; font-style: italic;">Brak bestsellerÃ³w w bazie danych.<br><br>Aby dodaÄ‡ bestseller, przejdÅº do panelu administracyjnego i zaznacz checkboxy "Bestseller" przy wybranych krzesÅ‚ach.</div>';
        } else {
          const grouped = groupVariants(bestsellerModels);
          renderOptions('model-thumbnails', grouped, item => handleModelClick(item));
        }
      }

      // Funkcja renderujÄ…ca modele wedÅ‚ug kategorii
      function renderModelsByCategory(category) {
        // Poprawiona logika filtrowania dla nowego arkusza
        const models = allData.filter(item => {
          // SprawdÅº czy to model (Typ=model lub Grupa=krzesÅ‚o/kubeÅ‚ek)
          const isModel = item.Typ === 'model' || item.Grupa === 'krzesÅ‚o' || item.Grupa === 'kubeÅ‚ek';
          
          // SprawdÅº kategoriÄ™ - obsÅ‚uga kategorii rozdzielonych przecinkami
          let belongsToCategory = false;
          if (item.Kategoria) {
            const itemCategories = item.Kategoria.split(',').map(k => k.trim());
            belongsToCategory = itemCategories.includes(category);
          }
          
          return isModel && belongsToCategory;
        });
        
        console.log(`ðŸ“¦ Rendering models for category "${category}":`, models.length, 'items');
        console.log('ðŸ“¦ Filtered models:', models.map(m => ({ Nazwa: m.Nazwa, Kategoria: m.Kategoria, Grupa: m.Grupa, Typ: m.Typ })));
        
        // PokaÅ¼ sekcjÄ™ modeli
        document.getElementById('model-section').style.display = 'block';
        document.getElementById('config-section').style.display = 'none';
        
        // WyczyÅ›Ä‡ filtr wyszukiwania jeÅ›li jest aktywny
        const searchFilterIndicator = document.getElementById('search-filter-indicator');
        if (searchFilterIndicator) {
          searchFilterIndicator.style.display = 'none';
        }
        
        const grouped = groupVariants(models);
        renderOptions('model-thumbnails', grouped, item => handleModelClick(item));
      }

      // Funkcja renderujÄ…ca promocje na starcie
    function renderPromotions() {
  // If user already interacted with categories, don't override their choice
  try { if (window.__userCategoryPicked) { console.log('renderPromotions skipped: user picked a category'); return; } } catch(_){}
  console.log('ðŸŽ‰ renderPromotions called, allData length:', (allData ? allData.length : 0));
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('âŒ No allData available for renderPromotions');
          return;
        }
        
        const promotionalModels = allData.filter(item => 
          item.Typ && item.Typ.toLowerCase() === 'model' &&
          (item.Promocja === 'TRUE' || item.Promocja === 'true' || item.Promocja === 'tak' || item.Promocja === 'âœ”') &&
          item.Procent && parseFloat(item.Procent) > 0
        );
        
        console.log('ðŸŽ‰ Promotional models found:', promotionalModels.length);
        console.log('ðŸŽ‰ Promotional models details:', promotionalModels);
        
        if (promotionalModels.length > 0) {
          console.log('ðŸŽ‰ Found promotional models, rendering them and activating Promocje button');
          // PokaÅ¼ sekcjÄ™ modeli (bezpiecznie, tworzÄ…c brakujÄ…ce elementy)
          (function ensureSections(){
            const sidebar = document.getElementById('sidebar');
            let ms = document.getElementById('model-section');
            if (!ms && sidebar) {
              ms = document.createElement('div');
              ms.id = 'model-section';
              ms.innerHTML = '<div class="selection-section"><h3>Wybierz model:</h3><div id="model-thumbnails" class="options-grid"></div></div>';
              const cat = document.getElementById('category-buttons');
              if (cat) cat.after(ms); else sidebar.appendChild(ms);
              console.log('âœ… Created model-section (promotions)');
            }
            let cs = document.getElementById('config-section');
            if (!cs && sidebar) {
              cs = document.createElement('div');
              cs.id = 'config-section';
              cs.style.display = 'none';
              cs.innerHTML = '<div id="back-to-models-container" style="margin-bottom: 15px;"></div>\
                <!-- Removed legacy legs-section (hidden) -->\
                <div id="parts-section" class="selection-section"><div id="part-tabs" class="options-grid"></div></div>\
                <div id="materials-section" class="selection-section"><h3>Wybierz materiaÅ‚:</h3><div id="material-options" style="display: none;"></div>\
                  <div id="collection-container" style="display: flex; gap: 24px; margin-top: 20px;">\
                    <div id="collection-icons" style="display: flex; flex-direction: column; gap: 14px; width: 88px;"></div>\
                    <div id="material-panel-viewer" class="options-grid" style="flex-grow: 1;"></div>\
                  </div>\
                </div>\
                <div id="summary"></div>';
              sidebar.appendChild(cs);
              console.log('âœ… Created config-section (promotions)');
            }
          })();
          const msEl = document.getElementById('model-section');
          const csEl = document.getElementById('config-section');
          if (msEl) msEl.style.display = 'block';
          if (csEl) csEl.style.display = 'none';
          
          renderOptions('model-thumbnails', promotionalModels, item => loadModel(item));
          
          // Aktywuj przycisk "Promocje" zamiast "Wszystkie" 
          setTimeout(() => {
            if (window.__userCategoryPicked) { return; }
            console.log('ðŸŽ‰ Looking for .category-button.promotion...');
            const promoButton = document.querySelector('.category-button.promotion');
            console.log('ðŸŽ‰ Found promotion button:', promoButton ? 'YES' : 'NO');
            
            if (promoButton) {
              if (window.__userCategoryPicked) { return; }
              console.log('ðŸŽ‰ Activating promotion button');
              document.querySelectorAll('.category-button').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'white';
                btn.style.color = btn.classList.contains('promotion') ? '#FF6B6B' : '#333';
              });
              promoButton.classList.add('active');
              promoButton.style.background = '#FF6B6B';
              promoButton.style.color = 'white';
            } else {
              console.log('âŒ Promotion button not found in DOM');
            }
          }, 100);
  } else {
          console.log('ðŸŽ‰ No promotional models, showing all models instead');
          renderAllModels();
          // Aktywuj przycisk "Wszystkie" jeÅ›li nie ma promocji
          setTimeout(() => {
            if (window.__userCategoryPicked) { return; }
            const allButton = document.querySelector('.category-button.special-category');
            if (allButton) {
              if (window.__userCategoryPicked) { return; }
              document.querySelectorAll('.category-button').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'white';
                btn.style.color = btn.classList.contains('promotion') ? '#FF6B6B' : '#333';
              });
              allButton.classList.add('active');
              allButton.style.background = '#F5C842';
              allButton.style.color = '#333';
            }
          }, 100);
        }
      }

      // Funkcja renderujÄ…ca kategorie i krzesÅ‚a w PWA Success Screen - UÅ»YWA MOBILNYCH FUNKCJI
      function renderPWACategoryButtons() {
  console.log('ðŸ“± renderPWACategoryButtons called - uÅ¼ywa mobilnych funkcji, allData:', (allData ? allData.length : 0));
        
        // Czekaj na zaÅ‚adowanie danych jeÅ›li jeszcze nie sÄ… dostÄ™pne
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('â³ allData not ready yet, waiting...');
          
          // Sprawdzaj co 100ms czy dane sÄ… dostÄ™pne, max 10 sekund
          let attempts = 0;
          const maxAttempts = 100; // 10 sekund
          
          const waitForData = setInterval(() => {
            attempts++;
            console.log(`â³ Waiting for data, attempt ${attempts}/${maxAttempts}`);
            
            if (allData && Array.isArray(allData) && allData.length > 0) {
              console.log('âœ… Data ready, calling renderPWACategoryButtons again');
              clearInterval(waitForData);
              renderPWACategoryButtons();
              return;
            }
            
            if (attempts >= maxAttempts) {
              console.error('âŒ Timeout waiting for allData in PWA');
              clearInterval(waitForData);
              return;
            }
          }, 100);
          
          return;
        }
        
        // WYWOÅAJ MOBILNE FUNKCJE RENDEROWANIA
        console.log('ðŸ“± PWA: Rendering mobile categories and models...');
        renderMobileCategories();
        renderMobileModels(); // PokaÅ¼ wszystkie modele na poczÄ…tku
      }

      // ðŸ“± DEDYKOWANE FUNKCJE MOBILNE DLA PWA SUCCESS SCREEN
      
      // Funkcja renderujÄ…ca kategorie w mobilnej sekcji PWA
      function renderMobileCategories() {
  console.log('ðŸ“± renderMobileCategories called, allData:', (allData ? allData.length : 0));
        
        const container = document.getElementById('mobile-category-buttons-container');
        if (!container) {
          console.error('âŒ mobile-category-buttons-container not found');
          return;
        }
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('â³ allData not ready for mobile categories');
          return;
        }
        
        container.innerHTML = '';
        
        // ZnajdÅº wszystkie unikalne kategorie
        const categories = [...new Set(allData
          .filter(item => item.Kategoria && item.Typ === 'model')
          .map(item => item.Kategoria)
        )];
        
        console.log('ðŸ“± Found mobile categories:', categories);
        
        // ==== SPECJALNE KATEGORIE W PIERWSZEJ LINII (mobile) ====
        // Dodaj przycisk "Wszystkie"
        const allButton = document.createElement('button');
        allButton.className = 'category-button active mobile-special';
        allButton.textContent = 'Wszystkie';
        allButton.style.cssText = 'margin: 5px; padding: 8px 15px; border: 2px solid #F5C842; background: #F5C842; color: #333; border-radius: 8px; font-weight: bold; cursor: pointer;';
        allButton.onclick = () => {
            try { window.__userCategoryPicked = true; } catch(_){}
          document.querySelectorAll('#mobile-category-buttons-container .category-button').forEach(btn => {
            btn.classList.remove('active');
            btn.style.background = '#fff';
            btn.style.color = '#333';
          });
          allButton.classList.add('active');
          allButton.style.background = '#F5C842';
          allButton.style.color = '#333';
          renderMobileModels();
        };
        container.appendChild(allButton);
        
        // SprawdÅº czy sÄ… krzesÅ‚a na promocji
        const promotionalModels = allData.filter(item => 
          item.Typ === 'model' && 
          item.Promocja === 'tak' && 
          item.Procent && 
          parseFloat(item.Procent) > 0
        );
        
        // JeÅ›li sÄ… krzesÅ‚a na promocji, dodaj przycisk "Promocje" 
        if (promotionalModels.length > 0) {
          const promoButton = document.createElement('button');
          promoButton.className = 'category-button mobile-special';
          promoButton.textContent = 'ðŸ”¥ Promocje';
          promoButton.style.cssText = 'margin: 5px; padding: 8px 15px; border: 2px solid #FF6B6B; background: #fff; color: #FF6B6B; border-radius: 8px; font-weight: bold; cursor: pointer;';
          promoButton.onclick = () => {
            try { window.__userCategoryPicked = true; } catch(_){}
            document.querySelectorAll('#mobile-category-buttons-container .category-button').forEach(btn => {
              btn.classList.remove('active');
              btn.style.background = '#fff';
              btn.style.color = btn.textContent.includes('Promocje') ? '#FF6B6B' : btn.textContent.includes('Bestsellery') ? '#f5c842' : '#333';
            });
            promoButton.classList.add('active');
            promoButton.style.background = '#FF6B6B';
            promoButton.style.color = '#fff';
            renderMobilePromotionalModels();
          };
          container.appendChild(promoButton);
          console.log('ðŸ“± Added mobile "Promocje" button with', promotionalModels.length, 'items');
        }
        
        // SprawdÅº czy sÄ… bestsellery
        const bestsellerModels = allData.filter(item => 
          item.Typ === 'model' && 
          (item.Bestseller === 'tak' || item.Bestseller === 'true')
        );
        
        // JeÅ›li sÄ… bestsellery, dodaj przycisk "Bestsellery"
        if (bestsellerModels.length > 0) {
          const bestsellerButton = document.createElement('button');
          bestsellerButton.className = 'category-button mobile-special';
          bestsellerButton.textContent = 'â­ Bestsellery';
          bestsellerButton.style.cssText = 'margin: 5px; padding: 8px 15px; border: 2px solid #f5c842; background: #fff; color: #333; border-radius: 8px; font-weight: bold; cursor: pointer;';
          bestsellerButton.onclick = () => {
            try { window.__userCategoryPicked = true; } catch(_){}
            document.querySelectorAll('#mobile-category-buttons-container .category-button').forEach(btn => {
              btn.classList.remove('active');
              btn.style.background = '#fff';
              btn.style.color = btn.textContent.includes('Promocje') ? '#FF6B6B' : btn.textContent.includes('Bestsellery') ? '#f5c842' : '#333';
            });
            bestsellerButton.classList.add('active');
            bestsellerButton.style.background = '#f5c842';
            bestsellerButton.style.color = '#333';
            renderMobileBestsellerModels();
          };
          container.appendChild(bestsellerButton);
          console.log('ðŸ“± Added mobile "Bestsellery" button with', bestsellerModels.length, 'items');
        }
        
        // Dodaj separator miÄ™dzy specjalnymi a gÅ‚Ã³wnymi kategoriami
        const separator = document.createElement('div');
        separator.style.cssText = 'width: 100%; height: 1px; background: #e0e0e0; margin: 10px 5px; flex-basis: 100%;';
        container.appendChild(separator);
        
        // ==== GÅÃ“WNE KATEGORIE W DRUGIEJ LINII (mobile) ====
        // Dodaj przyciski dla kaÅ¼dej kategorii
        categories.forEach(category => {
          const button = document.createElement('button');
          button.className = 'category-button mobile-main';
          button.textContent = category;
          button.style.cssText = 'margin: 5px; padding: 8px 15px; border: 2px solid #F5C842; background: #fff; color: #333; border-radius: 8px; font-weight: bold; cursor: pointer;';
          
          button.onclick = () => {
            try { window.__userCategoryPicked = true; } catch(_){}
            document.querySelectorAll('#mobile-category-buttons-container .category-button').forEach(btn => {
              btn.classList.remove('active');
              btn.style.background = '#fff';
              btn.style.color = btn.textContent.includes('Promocje') ? '#FF6B6B' : btn.textContent.includes('Bestsellery') ? '#f5c842' : '#333';
            });
            button.classList.add('active');
            button.style.background = '#F5C842';
            button.style.color = '#333';
            renderMobileModels(category);
          };
          
          container.appendChild(button);
        });
        
        console.log('ðŸ“± Added mobile category buttons: 3 special +', categories.length, 'main categories');
      }
      
      // ðŸ“± NOWE FUNKCJE MOBILNE - bazujÄ… na logice desktop
      
      function createMobileCategories() {
        console.log('ðŸ“± createMobileCategories called');
        console.log('ðŸ“± Window width:', window.innerWidth, 'Is mobile:', window.innerWidth <= 820);
        
        // PokaÅ¼ osobny mobilny kontener na mobile
        const standaloneMobileUI = document.getElementById('standalone-mobile-ui');
        if (standaloneMobileUI && window.innerWidth <= 820) {
          standaloneMobileUI.style.display = 'block';
          console.log('ðŸ“± Standalone mobile UI shown');
        }
        
        const container = document.getElementById('standalone-mobile-categories');
        console.log('ðŸ“± standalone-mobile-categories:', container ? 'FOUND' : 'NOT FOUND');
        
        if (!container) {
          console.error('âŒ standalone-mobile-categories not found');
          return;
        }
        
        container.innerHTML = '';
        
        // StaÅ‚e kategorie niezaleÅ¼ne od arkusza (jak na desktop)
        const mobileCategories = ['Wszystkie', 'Welur', 'Eco skÃ³ra', 'Tkanina'];
        
        mobileCategories.forEach((category, index) => {
          const button = document.createElement('button');
          button.className = 'mobile-category-btn';
          button.textContent = category;
          button.style.cssText = `
            background: linear-gradient(135deg, #F5C842, #E5B432);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(245, 200, 66, 0.3);
          `;
          
          // Pierwszy przycisk aktywny
          if (index === 0) {
            button.classList.add('active');
            button.style.background = 'linear-gradient(135deg, #E5B432, #D1A029)';
          }
          
          button.onclick = () => {
            // UsuÅ„ aktywny ze wszystkich
            document.querySelectorAll('.mobile-category-btn').forEach(btn => {
              btn.classList.remove('active');
              btn.style.background = 'linear-gradient(135deg, #F5C842, #E5B432)';
            });
            // Dodaj aktywny do klikniÄ™tego
            button.classList.add('active');
            button.style.background = 'linear-gradient(135deg, #E5B432, #D1A029)';
            
            // Renderuj modele dla kategorii
            if (category === 'Wszystkie') {
              renderStandaloneMobileAllModels();
            } else {
              renderStandaloneMobileModelsByCategory(category);
            }
          };
          
          container.appendChild(button);
        });
        
        console.log('ðŸ“± Mobile categories created:', mobileCategories.length);
        
        // Automatycznie zaÅ‚aduj wszystkie modele
        setTimeout(() => renderStandaloneMobileAllModels(), 100);
      }
      
      function renderStandaloneMobileAllModels() {
        console.log('ðŸ“± renderStandaloneMobileAllModels called');
        
        const container = document.getElementById('standalone-mobile-models');
        if (!container) {
          console.error('âŒ standalone-mobile-models not found');
          return;
        }
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('â³ allData not ready for mobile models');
          return;
        }
        
        container.innerHTML = '';
        
        // Filtruj tylko modele (jak na desktop)
        const models = allData.filter(item => item.Typ === 'model');
        console.log('ðŸ“± Found models for mobile:', models.length);
        
        models.forEach(model => {
          const modelElement = createStandaloneMobileModelElement(model);
          container.appendChild(modelElement);
        });
        
        console.log('ðŸ“± Standalone mobile all models rendered:', models.length);
      }
      
      function renderStandaloneMobileModelsByCategory(category) {
        console.log('ðŸ“± renderStandaloneMobileModelsByCategory called for:', category);
        
        const container = document.getElementById('standalone-mobile-models');
        if (!container) {
          console.error('âŒ standalone-mobile-models not found');
          return;
        }
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('â³ allData not ready for mobile category models');
          return;
        }
        
        container.innerHTML = '';
        
        // Filtruj modele wedÅ‚ug kategorii (jak na desktop)
        const models = allData.filter(item => 
          item.Typ === 'model' && 
          item.Kategoria === category
        );
        
        console.log('ðŸ“± Found models for category', category + ':', models.length);
        
        models.forEach(model => {
          const modelElement = createStandaloneMobileModelElement(model);
          container.appendChild(modelElement);
        });
        
        console.log('ðŸ“± Standalone mobile category models rendered:', models.length);
      }
      
      function createStandaloneMobileModelElement(model) {
        const div = document.createElement('div');
        div.style.cssText = `
          background: white;
          border-radius: 12px;
          padding: 10px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          transition: all 0.3s ease;
          cursor: pointer;
          text-align: center;
        `;
        
        // UÅ¼yj mobile image path - jeÅ›li juÅ¼ zawiera mobile_icons/ to nie dodawaj ponownie
        let imagePath;
        if (model.Mobile && model.Mobile.trim() !== '') {
          // JeÅ›li juÅ¼ zawiera mobile_icons/, uÅ¼yj bezpoÅ›rednio
          if (model.Mobile.includes('mobile_icons/')) {
            imagePath = model.Mobile;
          } else {
            // W przeciwnym razie dodaj folder
            imagePath = `mobile_icons/${model.Mobile}`;
          }
        } else {
          imagePath = model.Image || 'icons/placeholder.svg';
        }
        
        console.log('ðŸ“± Model:', model.Nazwa, 'Mobile path:', model.Mobile, 'Final path:', imagePath);
        
        div.innerHTML = `
          <img src="${imagePath}" alt="${model.Nazwa}" 
               style="width: 100%; height: 100px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;"
               onerror="this.src='icons/placeholder.svg'">
          <div style="font-size: 12px; font-weight: 600; color: #333; margin-bottom: 4px;">
            ${model.Nazwa}
          </div>
          <div style="font-size: 11px; color: #666;">
            ${model.Cena || 'Brak ceny'}
          </div>
        `;
        
        // Hover effect
        div.onmouseenter = () => {
          div.style.transform = 'translateY(-2px)';
          div.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
        };
        div.onmouseleave = () => {
          div.style.transform = 'translateY(0)';
          div.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        };
        
        // KlikniÄ™cie w model
        div.onclick = () => {
          console.log('ðŸ“± Standalone mobile model clicked:', model.Nazwa);
          
          // Ukryj mobilny kontener
          const standaloneMobileUI = document.getElementById('standalone-mobile-ui');
          if (standaloneMobileUI) {
            standaloneMobileUI.style.display = 'none';
          }
          
          // Zamknij welcome screen
          const welcomeScreen = document.getElementById('welcome-screen');
          if (welcomeScreen) {
            welcomeScreen.style.display = 'none';
          }
          
          // ZaÅ‚aduj model (uÅ¼yj istniejÄ…cej funkcji)
          if (typeof loadChairModel === 'function') {
            loadChairModel(model['3D model']);
          }
          
          // Ustaw aktywny model
          window.currentModel = model;
        };
        
        return div;
      }
      
      // Handler dla przycisku zamykania mobilnego UI
      document.addEventListener('DOMContentLoaded', () => {
        const closeMobileUIBtn = document.getElementById('close-mobile-ui');
        if (closeMobileUIBtn) {
          closeMobileUIBtn.onclick = () => {
            const standaloneMobileUI = document.getElementById('standalone-mobile-ui');
            if (standaloneMobileUI) {
              standaloneMobileUI.style.display = 'none';
            }
          };
        }
      });
      
      function renderMobileAllModels() {
        console.log('ðŸ“± renderMobileAllModels called');
        
        const container = document.getElementById('mobile-models-container');
        if (!container) {
          console.error('âŒ mobile-models-container not found');
          return;
        }
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('â³ allData not ready for mobile models');
          return;
        }
        
        container.innerHTML = '';
        
        // Filtruj tylko modele (jak na desktop)
        const models = allData.filter(item => item.Typ === 'model');
        console.log('ðŸ“± Found models for mobile:', models.length);
        
        models.forEach(model => {
          const modelElement = createMobileModelElement(model);
          container.appendChild(modelElement);
        });
        
        // Ukryj loading text
        const loadingText = document.getElementById('mobile-loading-text');
        if (loadingText) loadingText.style.display = 'none';
        
        console.log('ðŸ“± Mobile all models rendered:', models.length);
      }
      
      function renderMobileModelsByCategory(category) {
        console.log('ðŸ“± renderMobileModelsByCategory called for:', category);
        
        const container = document.getElementById('mobile-models-container');
        if (!container) {
          console.error('âŒ mobile-models-container not found');
          return;
        }
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('â³ allData not ready for mobile category models');
          return;
        }
        
        container.innerHTML = '';
        
        // Filtruj modele wedÅ‚ug kategorii (jak na desktop)
        const models = allData.filter(item => 
          item.Typ === 'model' && 
          item.Kategoria === category
        );
        
        console.log('ðŸ“± Found models for category', category + ':', models.length);
        
        models.forEach(model => {
          const modelElement = createMobileModelElement(model);
          container.appendChild(modelElement);
        });
        
        console.log('ðŸ“± Mobile category models rendered:', models.length);
      }
      
      function createMobileModelElement(model) {
        const div = document.createElement('div');
        div.className = 'mobile-model-item';
        
        // UÅ¼yj mobile image path jeÅ›li dostÄ™pny, inaczej fallback
        const imagePath = model.Mobile && model.Mobile.trim() !== '' 
          ? `mobile_icons/${model.Mobile}`
          : (model.Image || 'icons/placeholder.svg');
        
        console.log('ðŸ“± Model:', model.Nazwa, 'Mobile path:', model.Mobile, 'Final path:', imagePath);
        
        // Przygotuj cenÄ™ z uwzglÄ™dnieniem promocji
        let priceHTML = model.Cena || 'Brak ceny';
        if (model.Cena) {
          const cena = parseFloat(model.Cena) || 0;
          const promocja = model.Promocja === 'tak' || model.Promocja === 'true';
          const procent = parseFloat(model.Procent) || 0;
          
          if (promocja && procent > 0) {
            // Cena promocyjna - cena przekreÅ›lona i nowa cena
            const cenaPoPobniÅ¼ce = cena * (1 - procent / 100);
            priceHTML = `
              <div style="font-size: 11px; color: #999; text-decoration: line-through;">${cena.toFixed(0)} zÅ‚</div>
              <div style="font-size: 13px; color: #e74c3c; font-weight: bold;">${cenaPoPobniÅ¼ce.toFixed(0)} zÅ‚</div>
            `;
          } else {
            priceHTML = `${cena.toFixed(0)} zÅ‚`;
          }
        }
        
        div.innerHTML = `
          <img src="${imagePath}" alt="${model.Nazwa}" 
               onerror="this.src='icons/placeholder.svg'">
          <div class="model-name">${model.Nazwa}</div>
          <div class="model-price">${priceHTML}</div>
        `;
        
        // KlikniÄ™cie w model (jak na desktop)
        div.onclick = () => {
          console.log('ðŸ“± Mobile model clicked:', model.Nazwa);
          
          // Zamknij welcome screen
          const welcomeScreen = document.getElementById('welcome-screen');
          if (welcomeScreen) {
            welcomeScreen.style.display = 'none';
          }
          
          // ZaÅ‚aduj model (uÅ¼yj istniejÄ…cej funkcji)
          if (typeof loadChairModel === 'function') {
            loadChairModel(model['3D model']);
          }
          
          // Ustaw aktywny model
          window.currentModel = model;
        };
        
        return div;
      }
      
      // Funkcja renderujÄ…ca kategorie w gÅ‚Ã³wnej mobilnej sekcji (welcome screen)
      function renderMobileMainCategories() {
  console.log('ðŸ“± renderMobileMainCategories called, allData:', (allData ? allData.length : 0));
        
        // Dodatkowe debugowanie ekranu i viewport
        console.log('ðŸ“± Window dimensions:', window.innerWidth + 'x' + window.innerHeight);
        console.log('ðŸ“± Is mobile viewport (width <= 820):', window.innerWidth <= 820);
        console.log('ðŸ“± User Agent:', navigator.userAgent.substring(0, 100));
        
        // Wymusza widocznoÅ›Ä‡ mobilnej sekcji jeÅ›li width <= 820
        const section = document.getElementById('mobile-main-section');
        if (section && window.innerWidth <= 820) {
          console.log('ðŸ“± Forcing mobile section visibility via JavaScript');
          section.style.display = 'block';
          section.style.visibility = 'visible';
          section.style.opacity = '1';
          section.style.backgroundColor = 'lightblue'; // Testowy kolor
          section.style.border = '2px solid orange'; // Testowa ramka
        }
        
        const container = document.getElementById('mobile-main-category-buttons');
        console.log('ðŸ“± mobile-main-category-buttons element:', container ? 'FOUND' : 'NOT FOUND');
        
        if (!container) {
          console.error('âŒ mobile-main-category-buttons not found');
          // SprawdÅº czy mobile-main-section istnieje
          const section = document.getElementById('mobile-main-section');
          console.log('ðŸ“± mobile-main-section element:', section ? 'FOUND' : 'NOT FOUND');
          if (section) {
            const styles = window.getComputedStyle(section);
            console.log('ðŸ“± mobile-main-section display:', styles.display);
            console.log('ðŸ“± mobile-main-section visibility:', styles.visibility);
            console.log('ðŸ“± mobile-main-section opacity:', styles.opacity);
            console.log('ðŸ“± mobile-main-section z-index:', styles.zIndex);
          }
          return;
        }
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('â³ allData not ready for mobile main categories');
          return;
        }
        
        container.innerHTML = '';
        
        // ZnajdÅº wszystkie unikalne kategorie
        const categories = [...new Set(allData
          .filter(item => item.Kategoria && item.Typ === 'model')
          .map(item => item.Kategoria)
        )];
        
        console.log('ðŸ“± Found mobile main categories:', categories);
        
        // Dodaj przycisk "Wszystkie"
        const allButton = document.createElement('button');
        allButton.className = 'category-button active';
        allButton.textContent = 'Wszystkie';
        allButton.style.cssText = 'margin: 5px; padding: 10px 18px; border: 2px solid #F5C842; background: #F5C842; color: #333; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px;';
        allButton.onclick = () => {
          try { window.__userCategoryPicked = true; } catch(_){}
          document.querySelectorAll('#mobile-main-category-buttons .category-button').forEach(btn => {
            btn.classList.remove('active');
            btn.style.background = '#fff';
            btn.style.color = '#333';
          });
          allButton.classList.add('active');
          allButton.style.background = '#F5C842';
          allButton.style.color = '#333';
          renderMobileMainModels();
        };
        container.appendChild(allButton);
        
        // Dodaj przyciski dla kaÅ¼dej kategorii
        categories.forEach(category => {
          const button = document.createElement('button');
          button.className = 'category-button';
          button.textContent = category;
          button.style.cssText = 'margin: 5px; padding: 10px 18px; border: 2px solid #F5C842; background: #fff; color: #333; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px;';
          
          button.onclick = () => {
            try { window.__userCategoryPicked = true; } catch(_){}
            document.querySelectorAll('#mobile-main-category-buttons .category-button').forEach(btn => {
              btn.classList.remove('active');
              btn.style.background = '#fff';
              btn.style.color = '#333';
            });
            button.classList.add('active');
            button.style.background = '#F5C842';
            button.style.color = '#333';
            renderMobileMainModels(category);
          };
          
          container.appendChild(button);
        });
        
        console.log('ðŸ“± Added mobile main category buttons:', categories.length + 1);
      }
      
      // Funkcja renderujÄ…ca modele w gÅ‚Ã³wnej mobilnej sekcji (welcome screen)
      function renderMobileMainModels(selectedCategory = null) {
        console.log('ðŸ“± renderMobileMainModels called, category:', selectedCategory);
        
        const container = document.getElementById('mobile-main-model-thumbnails');
        const loadingText = document.getElementById('mobile-main-loading-text');
        
        console.log('ðŸ“± mobile-main-model-thumbnails element:', container ? 'FOUND' : 'NOT FOUND');
        console.log('ðŸ“± mobile-main-loading-text element:', loadingText ? 'FOUND' : 'NOT FOUND');
        
        if (!container) {
          console.error('âŒ mobile-main-model-thumbnails not found');
          // SprawdÅº czy mobile-main-section istnieje
          const section = document.getElementById('mobile-main-section');
          console.log('ðŸ“± mobile-main-section element:', section ? 'FOUND' : 'NOT FOUND');
          if (section) {
            console.log('ðŸ“± mobile-main-section display:', window.getComputedStyle(section).display);
            console.log('ðŸ“± mobile-main-section innerHTML:', section.innerHTML.substring(0, 200) + '...');
          }
          return;
        }
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('â³ allData not ready for mobile main models');
          return;
        }
        
        // Ukryj tekst Å‚adowania
        if (loadingText) {
          loadingText.style.display = 'none';
        }
        
        container.innerHTML = '';
        
        // Filtruj modele
        let models = allData.filter(item => item.Typ === 'model');
        
        if (selectedCategory) {
          models = models.filter(item => item.Kategoria === selectedCategory);
        }
        
        console.log('ðŸ“± Rendering mobile main models:', models.length);
        
        models.forEach(item => {
          const wrapper = document.createElement('div');
          wrapper.style.cssText = 'text-align: center; cursor: pointer; padding: 10px; background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s ease;';
          
          const img = document.createElement('img');
          img.src = item.Obrazek && item.Obrazek.length > 4 ? item.Obrazek : 'icons/placeholder.svg';
          img.alt = item.Nazwa;
          img.style.cssText = 'width: 100%; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;';
          img.onerror = () => {
            img.src = 'icons/placeholder.svg';
          };
          
          const caption = document.createElement('div');
          caption.textContent = item.Nazwa;
          caption.style.cssText = 'font-size: 12px; font-weight: 600; color: #333; line-height: 1.2;';
          
          const price = document.createElement('div');
          if (item.Cena) {
            const cena = parseFloat(item.Cena) || 0;
            const promocja = item.Promocja === 'tak' || item.Promocja === 'true';
            const procent = parseFloat(item.Procent) || 0;
            
            if (promocja && procent > 0) {
              // Cena promocyjna - cena przekreÅ›lona i nowa cena
              const cenaPoPobniÅ¼ce = cena * (1 - procent / 100);
              price.innerHTML = `
                <div style="font-size: 10px; color: #999; text-decoration: line-through; margin-bottom: 1px;">${cena.toFixed(0)} zÅ‚</div>
                <div style="font-size: 12px; color: #e74c3c; font-weight: bold;">${cenaPoPobniÅ¼ce.toFixed(0)} zÅ‚</div>
              `;
              price.style.cssText = 'margin-top: 4px; text-align: center;';
            } else if (cena > 0) {
              // Cena normalna
              price.textContent = `${cena.toFixed(0)} zÅ‚`;
              price.style.cssText = 'font-size: 11px; color: #F5C842; font-weight: bold; margin-top: 4px;';
            }
          }
          
          wrapper.appendChild(img);
          wrapper.appendChild(caption);
          if (item.Cena) wrapper.appendChild(price);
          
          wrapper.onclick = () => {
            console.log('ðŸ“± Mobile main model clicked:', item.Nazwa);
            // Ukryj welcome screen i przejdÅº do konfiguratora
            const welcomeScreen = document.getElementById('welcome-screen');
            if (welcomeScreen) {
              welcomeScreen.style.display = 'none';
            }
            // PokaÅ¼ aplikacjÄ™
            const app = document.getElementById('app');
            if (app) {
              app.style.display = 'block';
            }
            // ZaÅ‚aduj model
            loadModel(item);
          };
          
          wrapper.onmouseenter = () => {
            wrapper.style.transform = 'scale(1.05)';
          };
          
          wrapper.onmouseleave = () => {
            wrapper.style.transform = 'scale(1)';
          };
          
          container.appendChild(wrapper);
        });
        
        console.log('ðŸ“± Mobile main models rendered successfully');
      }
      
      // Funkcja renderujÄ…ca modele w mobilnej sekcji PWA
      function renderMobileModels(selectedCategory = null) {
        console.log('ðŸ“± renderMobileModels called, category:', selectedCategory);
        
        const container = document.getElementById('mobile-model-thumbnails');
        const loadingText = document.getElementById('mobile-loading-text');
        
        if (!container) {
          console.error('âŒ mobile-model-thumbnails not found');
          return;
        }
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('â³ allData not ready for mobile models');
          return;
        }
        
        // Ukryj tekst Å‚adowania
        if (loadingText) {
          loadingText.style.display = 'none';
        }
        
        container.innerHTML = '';
        
        // Filtruj modele
        let models = allData.filter(item => item.Typ === 'model');
        
        if (selectedCategory) {
          models = models.filter(item => item.Kategoria === selectedCategory);
        }
        
        console.log('ðŸ“± Rendering mobile models:', models.length);
        
        models.forEach(item => {
          const wrapper = document.createElement('div');
          wrapper.className = 'thumbnail-wrapper';
          wrapper.style.cssText = 'text-align: center; cursor: pointer; position: relative;';
          
          const img = document.createElement('img');
          img.src = item.Obrazek && item.Obrazek.length > 4 ? item.Obrazek : 'icons/placeholder.svg';
          img.alt = item.Nazwa;
          
          // SprawdÅº promocjÄ™ i ustaw odpowiedni border
          const promocja = item.Promocja === 'tak' || item.Promocja === 'true';
          const procent = parseFloat(item.Procent) || 0;
          
          if (promocja && procent > 0) {
            img.style.cssText = 'width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #FF6B6B;';
            
            // Dodaj overlay z procentem na mobilnej wersji
            const discountOverlay = document.createElement('div');
            discountOverlay.textContent = `-${procent}%`;
            discountOverlay.style.cssText = `
              position: absolute;
              top: 4px;
              right: 4px;
              background: #FF6B6B;
              color: white;
              font-size: 9px;
              font-weight: 700;
              padding: 2px 3px;
              border-radius: 2px;
              z-index: 10;
              line-height: 1;
            `;
            wrapper.appendChild(discountOverlay);
          } else {
            img.style.cssText = 'width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd;';
          }
          
          img.onerror = () => {
            img.src = 'icons/placeholder.svg';
          };
          
          const caption = document.createElement('div');
          caption.className = 'thumbnail-caption';
          caption.textContent = item.Nazwa;
          caption.style.cssText = 'font-size: 12px; margin-top: 5px; color: #333;';
          
          // Dodaj cenÄ™ (mobilna wersja)
          const priceDiv = document.createElement('div');
          if (item.Cena) {
            const cena = parseFloat(item.Cena) || 0;
            const promocja = item.Promocja === 'tak' || item.Promocja === 'true';
            const procent = parseFloat(item.Procent) || 0;
            
            if (promocja && procent > 0) {
              // Cena promocyjna - mobilna wersja  
              const cenaPoPobniÅ¼ce = cena * (1 - procent / 100);
              priceDiv.className = 'thumbnail-price promotion';
              priceDiv.style.cssText = 'font-size: 11px; margin-top: 3px; text-align: center;';
              priceDiv.innerHTML = `
                <div style="color: #FF6B6B; text-decoration: line-through; font-size: 10px; font-weight: 600;">${cena.toFixed(0)} zÅ‚</div>
                <div style="color: #333; font-weight: 700; font-size: 12px;">${cenaPoPobniÅ¼ce.toFixed(0)} zÅ‚</div>
                <div style="background: #FF6B6B; color: white; font-size: 8px; padding: 1px 4px; border-radius: 2px; margin-top: 2px; font-weight: 600;">-${procent}%</div>
              `;
            } else if (cena > 0) {
              // Cena normalna
              priceDiv.className = 'thumbnail-price';
              priceDiv.style.cssText = 'font-size: 11px; margin-top: 3px; color: #333; font-weight: 600; text-align: center;';
              priceDiv.textContent = `${cena.toFixed(0)} zÅ‚`;
            }
          }
          
          wrapper.appendChild(img);
          wrapper.appendChild(caption);
          if (priceDiv.textContent || priceDiv.innerHTML) {
            wrapper.appendChild(priceDiv);
          }
          
          wrapper.onclick = () => {
            console.log('ðŸ“± Mobile model clicked:', item.Nazwa);
            // Ukryj PWA success screen i przejdÅº do konfiguratora
            const pwaScreen = document.getElementById('pwa-success-screen');
            if (pwaScreen) {
              pwaScreen.style.display = 'none';
            }
            // PokaÅ¼ aplikacjÄ™
            const app = document.getElementById('app');
            if (app) {
              app.style.display = 'block';
            }
            // ZaÅ‚aduj model
            loadModel(item);
          };
          
          container.appendChild(wrapper);
        });
        
        console.log('ðŸ“± Mobile models rendered successfully');
      }

      // Funkcja renderujÄ…ca mobilne modele promocyjne
      function renderMobilePromotionalModels() {
        console.log('ðŸ“± renderMobilePromotionalModels called');
        
        const container = document.getElementById('mobile-model-thumbnails');
        const loadingText = document.getElementById('mobile-loading-text');
        
        if (!container) {
          console.error('âŒ mobile-model-thumbnails not found');
          return;
        }
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('â³ allData not ready for mobile promotional models');
          return;
        }
        
        // Ukryj tekst Å‚adowania
        if (loadingText) {
          loadingText.style.display = 'none';
        }
        
        container.innerHTML = '';
        
        // Filtruj modele promocyjne
        const promotionalModels = allData.filter(item => 
          item.Typ === 'model' && 
          item.Promocja === 'tak' && 
          item.Procent && 
          parseFloat(item.Procent) > 0
        );
        
        console.log('ðŸ“± Rendering mobile promotional models:', promotionalModels.length);
        
        promotionalModels.forEach(item => {
          const wrapper = document.createElement('div');
          wrapper.className = 'thumbnail-wrapper';
          wrapper.style.cssText = 'text-align: center; cursor: pointer;';
          
          const img = document.createElement('img');
          img.src = item.Obrazek && item.Obrazek.length > 4 ? item.Obrazek : 'icons/placeholder.svg';
          img.alt = item.Nazwa;
          img.style.cssText = 'width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #FF6B6B;';
          img.onerror = () => {
            img.src = 'icons/placeholder.svg';
          };
          
          const caption = document.createElement('div');
          caption.className = 'thumbnail-caption';
          caption.textContent = item.Nazwa;
          caption.style.cssText = 'font-size: 12px; margin-top: 5px; color: #333;';
          
          // Dodaj cenÄ™ promocyjnÄ…
          const priceDiv = document.createElement('div');
          if (item.Cena) {
            const cena = parseFloat(item.Cena) || 0;
            const procent = parseFloat(item.Procent) || 0;
            const cenaPoPobniÅ¼ce = cena * (1 - procent / 100);
            priceDiv.className = 'thumbnail-price promotion';
            priceDiv.style.cssText = 'font-size: 11px; margin-top: 3px; text-align: center;';
            priceDiv.innerHTML = `
              <div style="color: #FF6B6B; text-decoration: line-through; font-size: 10px; font-weight: 600;">${cena.toFixed(0)} zÅ‚</div>
              <div style="color: #333; font-weight: 700; font-size: 12px;">${cenaPoPobniÅ¼ce.toFixed(0)} zÅ‚</div>
              <div style="background: #FF6B6B; color: white; font-size: 8px; padding: 1px 4px; border-radius: 2px; margin-top: 2px; font-weight: 600;">-${procent}%</div>
            `;
          }
          
          wrapper.appendChild(img);
          wrapper.appendChild(caption);
          if (priceDiv.innerHTML) {
            wrapper.appendChild(priceDiv);
          }
          
          wrapper.onclick = () => {
            console.log('ðŸ“± Mobile promotional model clicked:', item.Nazwa);
            // Ukryj PWA success screen i przejdÅº do konfiguratora
            const pwaScreen = document.getElementById('pwa-success-screen');
            if (pwaScreen) {
              pwaScreen.style.display = 'none';
            }
            // PokaÅ¼ aplikacjÄ™
            const app = document.getElementById('app');
            if (app) {
              app.style.display = 'block';
            }
            // ZaÅ‚aduj model
            loadModel(item);
          };
          
          container.appendChild(wrapper);
        });
        
        console.log('ðŸ“± Mobile promotional models rendered successfully');
      }

      // Funkcja renderujÄ…ca mobilne modele bestsellery
      function renderMobileBestsellerModels() {
        console.log('ðŸ“± renderMobileBestsellerModels called');
        
        const container = document.getElementById('mobile-model-thumbnails');
        const loadingText = document.getElementById('mobile-loading-text');
        
        if (!container) {
          console.error('âŒ mobile-model-thumbnails not found');
          return;
        }
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('â³ allData not ready for mobile bestseller models');
          return;
        }
        
        // Ukryj tekst Å‚adowania
        if (loadingText) {
          loadingText.style.display = 'none';
        }
        
        container.innerHTML = '';
        
        // Filtruj modele bestsellery
        const bestsellerModels = allData.filter(item => 
          item.Typ === 'model' && 
          (item.Bestseller === 'tak' || item.Bestseller === 'true')
        );
        
        console.log('ðŸ“± Rendering mobile bestseller models:', bestsellerModels.length);
        
        bestsellerModels.forEach(item => {
          const wrapper = document.createElement('div');
          wrapper.className = 'thumbnail-wrapper';
          wrapper.style.cssText = 'text-align: center; cursor: pointer;';
          
          const img = document.createElement('img');
          img.src = item.Obrazek && item.Obrazek.length > 4 ? item.Obrazek : 'icons/placeholder.svg';
          img.alt = item.Nazwa;
          img.style.cssText = 'width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #f5c842;';
          img.onerror = () => {
            img.src = 'icons/placeholder.svg';
          };
          
          const caption = document.createElement('div');
          caption.className = 'thumbnail-caption';
          caption.textContent = item.Nazwa;
          caption.style.cssText = 'font-size: 12px; margin-top: 5px; color: #333;';
          
          // Dodaj cenÄ™ z oznaczeniem bestsellera
          const priceDiv = document.createElement('div');
          if (item.Cena) {
            const cena = parseFloat(item.Cena) || 0;
            priceDiv.className = 'thumbnail-price bestseller';
            priceDiv.style.cssText = 'font-size: 11px; margin-top: 3px; text-align: center;';
            priceDiv.innerHTML = `
              <div style="color: #333; font-weight: 700; font-size: 12px;">${cena.toFixed(0)} zÅ‚</div>
              <div style="background: #f5c842; color: #333; font-size: 8px; padding: 1px 4px; border-radius: 2px; margin-top: 2px; font-weight: 600;">â­ Bestseller</div>
            `;
          }
          
          wrapper.appendChild(img);
          wrapper.appendChild(caption);
          if (priceDiv.innerHTML) {
            wrapper.appendChild(priceDiv);
          }
          
          wrapper.onclick = () => {
            console.log('ðŸ“± Mobile bestseller model clicked:', item.Nazwa);
            // Ukryj PWA success screen i przejdÅº do konfiguratora
            const pwaScreen = document.getElementById('pwa-success-screen');
            if (pwaScreen) {
              pwaScreen.style.display = 'none';
            }
            // PokaÅ¼ aplikacjÄ™
            const app = document.getElementById('app');
            if (app) {
              app.style.display = 'block';
            }
            // ZaÅ‚aduj model
            loadModel(item);
          };
          
          container.appendChild(wrapper);
        });
        
        console.log('ðŸ“± Mobile bestseller models rendered successfully');
      }

      // PWA TERAZ UÅ»YWA PRAWDZIWEGO DESKTOP SIDEBAR - usuniÄ™to renderPWACategoryButtons

      // Funkcja odÅ›wieÅ¼ajÄ…ca wszystkie kafelki z filtrem
      function refreshAllTiles() {
        console.log('ðŸ”„ Refreshing all tiles with filter:', currentSearchFilter);
        
                  // OdÅ›wieÅ¼ modele gÅ‚Ã³wne (krzesÅ‚a/kubeÅ‚ki)
          if (allData && Array.isArray(allData)) {
            console.log('ðŸ” Available groups:', [...new Set(allData.map(d => d.Grupa))]);
            const filteredByGroup = allData.filter(d => 
              d.Kategoria && 
              d.Kategoria.toLowerCase().includes('krzesÅ‚a') && 
              d.Typ && 
              d.Typ.toLowerCase() === 'model'
            );
            console.log('ðŸ” Filtered models before search filter:', filteredByGroup.map(d => ({ Nazwa: d.Nazwa, Grupa: d.Grupa, Kategoria: d.Kategoria, Typ: d.Typ })));
            const mainModels = filteredByGroup.filter(matchesSearchFilter);
            console.log('ðŸ” After search filter:', mainModels.map(d => ({ Nazwa: d.Nazwa, Grupa: d.Grupa })));
          if (currentSearchFilter) {
            mainModels.sort((a, b) => getRelevance(b, currentSearchFilter) - getRelevance(a, currentSearchFilter));
          }
          console.log('ðŸ” Rendering main models:', mainModels.length, 'with filter:', currentSearchFilter);
          renderOptions('model-thumbnails', mainModels, item => loadModel(item));
        }
        
        // OdÅ›wieÅ¼ kafelki nÃ³g jeÅ›li sÄ… widoczne
        const legsSection = document.getElementById('legs-section');
        if (legsSection && legsSection.style.display !== 'none' && selectedChair) {
          const legs = allData
            .filter(d => d.Grupa.toLowerCase() === 'nogi')
            .filter(d => {
              // Filtrowanie kategorii
              const nogaKategoria = (d.Kategoria || d.Typ || d.Grupa || '').toLowerCase();
              const chairKategoria = ((selectedChair && selectedChair.Kategoria) || '').toLowerCase();
              
              // JeÅ›li krzesÅ‚o to 'hookery', pokazuj tylko nogi 'hooker'
              if (chairKategoria.includes('hooker')) {
                if (!nogaKategoria.includes('hooker')) return false;
              }
              // JeÅ›li krzesÅ‚o to 'krzesÅ‚a', pokazuj tylko nogi 'krzesÅ‚a' (i uniwersalne)
              else if (chairKategoria.includes('krzes')) {
                if (nogaKategoria.includes('hooker')) return false;
                if (!(nogaKategoria.includes('krzes') || nogaKategoria === '' || nogaKategoria === 'nogi')) return false;
              }
              
              return true;
            })
            .filter(d => !selectedChair || selectedChair.Grupa.toLowerCase() !== 'kubeÅ‚ek' || czyNogaPasujeDoKubeÅ‚ka(d, selectedChair.Nazwa))
            .filter(d => !selectedChair || czyNogaPasujeDoKrzesÅ‚a(d, selectedChair.Nazwa))
            .filter(d => !selectedChair || czyWariantNogPasujeDoKubeÅ‚ka(d, selectedChair))
            .filter(matchesSearchFilter);
          renderOptions('legs-thumbnails', legs, item => setLegModel(item));
        }
        
        // OdÅ›wieÅ¼ materiaÅ‚y jeÅ›li sÄ… widoczne
        const materialsSection = document.getElementById('materials-section');
        if (materialsSection && materialsSection.style.display !== 'none') {
          // ZnajdÅº aktywnÄ… zakÅ‚adkÄ™ czÄ™Å›ci
          const activeTab = document.querySelector('#part-tabs .thumbnail.selected');
          if (activeTab) {
            const targetMesh = activeTab.dataset.key;
            renderFilteredMaterialOptions(targetMesh);
          }
        }
      }

      // FunkcjonalnoÅ›Ä‡ wyszukiwania
      function initializeSearch() {
        console.log('ðŸ” Initializing search...');
        console.log('DOM ready state:', document.readyState);
        console.log('Available elements in DOM:', {
          searchToggle: document.getElementById('search-toggle'),
          searchPanel: document.getElementById('search-panel'),
          searchInput: document.getElementById('search-input'),
          searchResults: document.getElementById('search-results')
        });
        
        let searchToggle = document.getElementById('search-toggle');
        let searchPanel = document.getElementById('search-panel');
        let searchInput = document.getElementById('search-input');
        let searchResults = document.getElementById('search-results');
        
        console.log('Elements found:', {
          toggle: !!searchToggle,
          panel: !!searchPanel,
          input: !!searchInput,
          results: !!searchResults
        });
        
        let isSearchOpen = false;

        if (!searchToggle || !searchPanel) {
          // SprÃ³buj po krÃ³tkiej chwili â€“ mogÅ‚y zostaÄ‡ przeniesione do panelu mobilnego
          console.warn('âŒ Search elements not found, retrying after moving elements...');
          try {
            // Create minimal search UI if completely missing
            let sc = document.getElementById('search-container');
            if (!sc) {
              sc = document.createElement('div');
              sc.id = 'search-container';
              sc.innerHTML = `
                <button id="search-toggle" type="button" aria-label="Szukaj">
                  <svg viewBox="0 0 24 24">
                    <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
                  </svg>
                </button>
                <div id="search-panel">
                  <input type="text" id="search-input" placeholder="Szukaj modeli, materiaÅ‚Ã³w, kolekcji..." autocomplete="off" />
                  <div id="search-results"></div>
                  <div id="search-extra"></div>
                </div>`;
              // Place in sidebar if present, otherwise try mobile panel
              const sb = document.getElementById('sidebar');
              if (sb) sb.insertBefore(sc, sb.firstChild);
              else {
                const mp = document.getElementById('mobile-right-panel');
                if (mp) mp.insertBefore(sc, mp.firstChild);
              }
            }
            ensureMobilePanel();
            moveElementsToMobilePanel();
          } catch(_) {}
          setTimeout(() => {
            searchToggle = document.getElementById('search-toggle');
            searchPanel = document.getElementById('search-panel');
            searchInput = document.getElementById('search-input');
            searchResults = document.getElementById('search-results');
            if (!searchToggle || !searchPanel) {
              console.error('âŒ Search elements still not found');
              console.log('HTML content around search:', (document.getElementById('search-container') ? document.getElementById('search-container').innerHTML : ''));
              return;
            }
            // Kontynuuj inicjalizacjÄ™ po re-lookup
            setupSearchHandlers();
          }, 150);
          return;
        }

        function setupSearchHandlers(){
          console.log('âœ… Setting up search event listeners');
          console.log('Initial panel styles:', {
            position: window.getComputedStyle(searchPanel).position,
            right: window.getComputedStyle(searchPanel).right,
            opacity: window.getComputedStyle(searchPanel).opacity,
            visibility: window.getComputedStyle(searchPanel).visibility,
            zIndex: window.getComputedStyle(searchPanel).zIndex
          });

          // Toggle panel wyszukiwania
          searchToggle.addEventListener('click', (e) => {
            e.preventDefault();
            e.stopPropagation();
            console.log('ðŸ” Search toggle clicked!', {
              wasOpen: isSearchOpen,
              willBeOpen: !isSearchOpen,
              currentClasses: searchPanel.className
            });
            
            isSearchOpen = !isSearchOpen;
            
            if (isSearchOpen) {
              // ZapamiÄ™taj aktualnÄ… kategoriÄ™ przed otwarciem wyszukiwania
              saveCurrentCategory();
              searchPanel.classList.add('active');
              console.log('ðŸ” Panel opened');
              setTimeout(() => searchInput && searchInput.focus(), 200);
            } else {
              searchPanel.classList.remove('active');
              console.log('ðŸ” Panel closed');
              if (searchInput) searchInput.value = '';
              if (searchResults) searchResults.innerHTML = '';
              // WyczyÅ›Ä‡ filtr kafelkÃ³w
              setSearchFilter('');
              // PrzywrÃ³Ä‡ poprzedniÄ… kategoriÄ™
              restorePreviousCategory();
            }
            
            console.log('Panel state after toggle:', {
              classes: searchPanel.className,
              computedStyles: {
                right: window.getComputedStyle(searchPanel).right,
                opacity: window.getComputedStyle(searchPanel).opacity,
                visibility: window.getComputedStyle(searchPanel).visibility
              }
            });
          });
          
          // Wyszukiwanie w czasie rzeczywistym
          if (searchInput) {
            searchInput.addEventListener('input', (e) => {
              const value = e.target.value.trim();
              setSearchFilter(value);
              if (value.length === 0) {
                searchResults.innerHTML = '';
              }
            });
          }
        }

        setupSearchHandlers();

        console.log('âœ… Setting up search event listeners');
        console.log('Initial panel styles:', {
          position: window.getComputedStyle(searchPanel).position,
          right: window.getComputedStyle(searchPanel).right,
          opacity: window.getComputedStyle(searchPanel).opacity,
          visibility: window.getComputedStyle(searchPanel).visibility,
          zIndex: window.getComputedStyle(searchPanel).zIndex
        });

        // Toggle panel wyszukiwania
        searchToggle.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log('ðŸ” Search toggle clicked!', {
            wasOpen: isSearchOpen,
            willBeOpen: !isSearchOpen,
            currentClasses: searchPanel.className
          });
          
          isSearchOpen = !isSearchOpen;
          
          if (isSearchOpen) {
            // ZapamiÄ™taj aktualnÄ… kategoriÄ™ przed otwarciem wyszukiwania
            saveCurrentCategory();
            searchPanel.classList.add('active');
            console.log('ðŸ” Panel opened');
            setTimeout(() => searchInput && searchInput.focus(), 200);
          } else {
            searchPanel.classList.remove('active');
            console.log('ðŸ” Panel closed');
            if (searchInput) searchInput.value = '';
            if (searchResults) searchResults.innerHTML = '';
            // WyczyÅ›Ä‡ filtr kafelkÃ³w
            setSearchFilter('');
            // PrzywrÃ³Ä‡ poprzedniÄ… kategoriÄ™
            restorePreviousCategory();
          }
          
          console.log('Panel state after toggle:', {
            classes: searchPanel.className,
            computedStyles: {
              right: window.getComputedStyle(searchPanel).right,
              opacity: window.getComputedStyle(searchPanel).opacity,
              visibility: window.getComputedStyle(searchPanel).visibility
            }
          });
        });

        // Zamknij panel przy klikniÄ™ciu poza nim
        document.addEventListener('click', (e) => {
          if (window.__justClosedBrightness && Date.now() - window.__justClosedBrightness < 120) return;
          if (!searchPanel.contains(e.target) && !searchToggle.contains(e.target)) {
            if (isSearchOpen) {
              isSearchOpen = false;
              searchPanel.classList.remove('active');
              if (searchInput) searchInput.value = '';
              if (searchResults) searchResults.innerHTML = '';
              // WyczyÅ›Ä‡ filtr kafelkÃ³w
              setSearchFilter('');
              // PrzywrÃ³Ä‡ poprzedniÄ… kategoriÄ™
              restorePreviousCategory();
            }
          }
        });

        // Funkcja wyszukiwania
        function performSearch(query, limit = 20) {
          if (!query.trim() || !allData) return [];
          
          const searchTerm = query.toLowerCase().trim();
          const results = [];

          console.log('ðŸ” Searching for:', searchTerm, 'in', allData.length, 'items');

          // UPROSZCZONE WYSZUKIWANIE: tylko po nazwie i tylko dla Typ === 'model'
          const modelItems = allData.filter(item => {
            const nazwa = (item.Nazwa || '').toLowerCase();
            const typ = (item.Typ || '').toLowerCase();
            
            return typ === 'model' &&  // tylko modele (krzesÅ‚a/hookery)
                   nazwa.includes(searchTerm) &&  // nazwa zawiera frazÄ™
                   item.Visible !== 'false' &&  // tylko widoczne
                   item.Nazwa && item.Nazwa.trim() !== '';  // tylko z nazwÄ…
          });

          console.log('ðŸ” Found', modelItems.length, 'model items matching name search');

          // Dodaj wszystkie znalezione modele do wynikÃ³w
          modelItems.forEach(item => {
            const nazwa = (item.Nazwa || '').toLowerCase();
            let relevance = 10; // bazowa wartoÅ›Ä‡
            
            // Bonus za dopasowanie od poczÄ…tku nazwy
            if (nazwa.startsWith(searchTerm)) {
              relevance += 10;
            }
            
            console.log('ðŸ” Found match:', item.Nazwa, 'Kategoria:', item.Kategoria);
            item.searchType = 'chair';
            results.push({ item, relevance });
          });

          console.log('ðŸ” Final results:', results.length);
          
          // Sortowanie alfabetyczne po nazwach
          const sortedResults = results
            .sort((a, b) => {
              const nameA = (a.item.Nazwa || '').toLowerCase();
              const nameB = (b.item.Nazwa || '').toLowerCase();
              return nameA.localeCompare(nameB);
            })
            .slice(0, limit);
          
          console.log('ðŸ” Returning', sortedResults.length, 'results after sorting alphabetically');
          return sortedResults.map(r => r.item);
        }

        // Handler wpisywania w pole wyszukiwania
        searchInput.addEventListener('input', (e) => {
          const query = e.target.value;
          searchResults.innerHTML = '';

          // AUTOMATYCZNE PRZEÅÄ„CZENIE NA KATEGORIÄ˜ "WSZYSTKIE" podczas wyszukiwania
          if (query.trim().length > 0) {
            const allButton = document.querySelector('[data-category="Wszystkie"]');
            if (allButton && !allButton.classList.contains('active')) {
              // Dezaktywuj inne kategorie
              document.querySelectorAll('.category-button').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'white';
                btn.style.color = btn.classList.contains('promotion') ? '#FF6B6B' : '#333';
              });
              // Aktywuj kategoriÄ™ "Wszystkie"
              allButton.classList.add('active');
              allButton.style.background = '#F5C842';
              allButton.style.color = '#333';
              console.log('ðŸ”„ Auto-switched to "Wszystkie" category during search');
            }
          }

          // Ustaw filtr dla kafelkÃ³w w sidebarze
          setSearchFilter(query);

          if (query.trim().length < 2) {
            // JeÅ›li zapytanie za krÃ³tkie, wyczyÅ›Ä‡ tylko wyniki popup'a ale zostaw filtr
            return;
          }

          const results = performSearch(query);
          
          if (results.length === 0) {
            const noResultsDiv = document.createElement('div');
            noResultsDiv.className = 'search-result-item text-only';
            noResultsDiv.innerHTML = '<div class="result-name">Brak wynikÃ³w</div>';
            noResultsDiv.style.cursor = 'default';
            noResultsDiv.style.opacity = '0.7';
            searchResults.appendChild(noResultsDiv);
            return;
          }

          results.forEach(item => {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'search-result-item';
            
            const name = item.Nazwa || 'Bez nazwy';
            const category = item.Kategoria || '';
            const image = item.Obrazek || item.Image;
            
            // Dodaj etykietÄ™ typu elementu (tylko dla materiaÅ‚Ã³w i nÃ³g)
            let typeLabel = '';
            if (item.searchType === 'leg-material') {
              typeLabel = 'MateriaÅ‚ nÃ³g';
            } else if (item.searchType === 'leg') {
              typeLabel = 'Nogi';
            }
            // Nie pokazuj typeLabel dla krzeseÅ‚ - zostanie tylko kategoria
            
            if (image) {
              // Kafelek z obrazkiem - tylko kategoria
              resultDiv.innerHTML = `
                <img src="${image}" alt="${name}" onerror="this.style.display='none'">
                <div class="result-category">${category}</div>
                ${typeLabel ? `<div class="result-type">${typeLabel}</div>` : ''}
              `;
            } else {
              // Fallback tekstowy dla elementÃ³w bez obrazkÃ³w - tylko kategoria
              resultDiv.className += ' text-only';
              resultDiv.innerHTML = `
                <div class="result-category">${category}</div>
                ${typeLabel ? `<div class="result-type">${typeLabel}</div>` : ''}
              `;
            }

            resultDiv.addEventListener('click', () => {
              // KlikniÄ™cie w kafelek od razu przenosi do krzesÅ‚a
              if (item.searchType === 'chair') {
                // WYCZYÅšÄ† FILTR WYSZUKIWANIA NAJPIERW!
                setSearchFilter('');
                console.log('ðŸ§¹ Wyczyszczono filtr wyszukiwania przed Å‚adowaniem krzesÅ‚a');
                
                // Zamknij panel wyszukiwania
                isSearchOpen = false;
                searchPanel.classList.remove('active');
                if (searchInput) searchInput.value = '';
                if (searchResults) searchResults.innerHTML = '';
                
                // Aktywuj kategoriÄ™ "Wszystkie"
                const allButtons = document.querySelectorAll('.category-button');
                allButtons.forEach(btn => {
                  btn.classList.remove('active');
                  btn.style.background = 'white';
                  btn.style.color = btn.classList.contains('promotion') ? '#FF6B6B' : '#333';
                });
                
                const allButton = Array.from(allButtons).find(btn => btn.textContent.trim() === 'Wszystkie');
                if (allButton) {
                  allButton.classList.add('active');
                  allButton.style.background = '#F5C842';
                  allButton.style.color = '#333';
                }
                
                // ZaÅ‚aduj model krzesÅ‚a
                loadModel(item).then(() => {
                  console.log('ðŸ”§ Model zaÅ‚adowany z wyszukiwania, aktywujÄ™ pierwszÄ… zakÅ‚adkÄ™ materiaÅ‚Ã³w...');
                  
                  // Po zaÅ‚adowaniu modelu, automatycznie aktywuj pierwszÄ… dostÄ™pnÄ… zakÅ‚adkÄ™ czÄ™Å›ci
                  setTimeout(() => {
                    const firstPartTab = document.querySelector('#part-tabs .thumbnail');
                    if (firstPartTab) {
                      console.log('ðŸŽ¯ AktywujÄ™ pierwszÄ… zakÅ‚adkÄ™ czÄ™Å›ci:', firstPartTab.dataset.key);
                      firstPartTab.click(); // To wywoÅ‚a renderFilteredMaterialOptions
                    }
                  }, 100); // MaÅ‚e opÃ³Åºnienie Å¼eby UI zdÄ…Å¼yÅ‚ siÄ™ wyrenderowaÄ‡
                }).catch(error => {
                  console.error('âŒ BÅ‚Ä…d Å‚adowania modelu z wyszukiwania:', error);
                });
                
                // Ukryj welcome screen
                const welcomeScreen = document.getElementById('welcome-screen');
                if (welcomeScreen) {
                  welcomeScreen.style.display = 'none';
                }
              }
            });

            searchResults.appendChild(resultDiv);
          });
          
          // Dodaj separator i przycisk do osobnego kontenera pod gridem
          const searchExtra = document.getElementById('search-extra');
          searchExtra.innerHTML = '';
          if (results.length > 0) {
            const separator = document.createElement('div');
            separator.className = 'search-separator';
            separator.style.cssText = `
              width: 100%;
              height: 1px;
              background: #ddd;
              margin: 15px 0 10px 0;
            `;
            searchExtra.appendChild(separator);

            const showAllButton = document.createElement('button');
            showAllButton.className = 'search-show-all-btn';
            showAllButton.textContent = 'PokaÅ¼ wszystkie wyniki';
            showAllButton.style.cssText = `
              width: 100%;
              padding: 14px 20px;
              margin: 10px 0 0 0;
              background: #F5C842;
              color: #333;
              border: none;
              border-radius: 8px;
              font-weight: 600;
              font-size: 14px;
              cursor: pointer;
              transition: all 0.2s ease;
              text-align: center;
            `;
            showAllButton.onmouseenter = () => {
              showAllButton.style.background = '#E6B537';
              showAllButton.style.transform = 'translateY(-1px)';
            };
            showAllButton.onmouseleave = () => {
              showAllButton.style.background = '#F5C842';
              showAllButton.style.transform = 'translateY(0)';
            };
            showAllButton.onclick = () => {
              // PrzeÅ‚Ä…cz na kategoriÄ™ "Wszystkie" - ZAWSZE zaktualizuj style
              const allButton = document.querySelector('[data-category="Wszystkie"]');
              if (allButton) {
                // Dezaktywuj inne kategorie
                document.querySelectorAll('.category-button').forEach(btn => {
                  btn.classList.remove('active');
                  btn.style.background = 'white';
                  btn.style.color = btn.classList.contains('promotion') ? '#FF6B6B' : '#333';
                });
                // Aktywuj kategoriÄ™ "Wszystkie"
                allButton.classList.add('active');
                allButton.style.background = '#F5C842';
                allButton.style.color = '#333';
                console.log('ðŸ”„ Activated "Wszystkie" category from "PokaÅ¼ wszystkie wyniki"');
              }
              
              isSearchOpen = false;
              searchPanel.classList.remove('active');
              showScreen('search-results');
              const container = document.getElementById('model-thumbnails');
              if (container) {
                const allSearchResults = performSearch(query, 999);
                console.log('ðŸ” Rendering', allSearchResults.length, 'search results with proper styling');
                
                // UÅ¼yj funkcji renderOptions ktÃ³ra poprawnie obsÅ‚uguje promocje/bestsellery
                renderOptions('model-thumbnails', allSearchResults, (variant) => {
                  // WYCZYÅšÄ† FILTR WYSZUKIWANIA przed Å‚adowaniem krzesÅ‚a z "PokaÅ¼ wszystkie wyniki"
                  setSearchFilter('');
                  console.log('ðŸ§¹ Wyczyszczono filtr przed Å‚adowaniem krzesÅ‚a z "PokaÅ¼ wszystkie wyniki"');
                  loadModel(variant);
                }, true);
              }
              if (searchInput) searchInput.value = '';
              if (searchResults) searchResults.innerHTML = '';
            };
            searchExtra.appendChild(showAllButton);
          }
        });
      }

      // Funkcja wykonujÄ…ca akcjÄ™ po wyborze w modalu
      function executeSearchResultAction(item) {
        // SprawdÅº typ elementu na podstawie searchType
        if (item.searchType === 'chair') {
          // Wybierz model krzesÅ‚a
          loadModel(item);
        } else if (item.searchType === 'leg-material') {
          // JeÅ›li to materiaÅ‚ nÃ³g, pokaÅ¼ krzesÅ‚a ktÃ³re mogÄ… mieÄ‡ ten materiaÅ‚
          showChairsWithMaterial(item);
        } else if (item.searchType === 'leg') {
          // JeÅ›li to nogi, pokaÅ¼ krzesÅ‚a ktÃ³re mogÄ… mieÄ‡ te nogi
          showChairsWithLegs(item);
        } else {
          // Fallback na starÄ… logikÄ™
          const group = (item.Grupa ? item.Grupa.toLowerCase() : undefined);
          
          if (group === 'krzesÅ‚o' || group === 'kubeÅ‚ek') {
            loadModel(item);
          } else if (group === 'tkanina' || group === 'materiaÅ‚y_nÃ³g') {
            if (selectedChair) {
              if (item.TargetMeshOrModel) {
                applyMaterial(item);
              }
              showScreen('config');
            } else {
              alert('Najpierw wybierz model krzesÅ‚a');
            }
          } else if (group === 'nogi') {
            if (selectedChair && selectedChair.Grupa && selectedChair.Grupa.toLowerCase() === 'kubeÅ‚ek') {
              setLegModel(item);
              showScreen('config');
            } else {
              alert('Nogi moÅ¼na wybieraÄ‡ tylko dla kubeÅ‚kÃ³w');
            }
          }
        }
      }

      // Funkcja pokazujÄ…ca krzesÅ‚a z okreÅ›lonym materiaÅ‚em nÃ³g
      function showChairsWithMaterial(material) {
        console.log('ðŸ” Looking for chairs compatible with material:', material.Nazwa);
        console.log('ðŸ” Material data:', material);
        
        // ZnajdÅº krzesÅ‚a ktÃ³re mogÄ… mieÄ‡ ten materiaÅ‚
        const allChairs = allData.filter(item => 
          item.Typ && item.Typ.toLowerCase() === 'model' &&
          item.Kategoria && item.Kategoria.toLowerCase().includes('krzesÅ‚a')
        );
        
        console.log('ðŸ” All chairs found:', allChairs.map(c => ({ Nazwa: c.Nazwa, Grupa: c.Grupa })));
        
        const compatibleChairs = allChairs.filter(chair => {
          // SprawdÅº czy materiaÅ‚ jest kompatybilny z krzesÅ‚em
          if (!material.DlaKrzesÅ‚a) {
            console.log('ðŸ” No DlaKrzesÅ‚a field for material:', material.Nazwa);
            return false;
          }
          
          const materialChairs = material.DlaKrzesÅ‚a.toLowerCase().split(',').map(s => s.trim());
          const chairName = chair.Nazwa.toLowerCase().trim();
          
          console.log('ðŸ” Checking chair:', chairName, 'against material chairs:', materialChairs);
          
          return materialChairs.some(materialChair => 
            materialChair.includes(chairName) || chairName.includes(materialChair)
          );
        });

        console.log('ðŸ” Compatible chairs:', compatibleChairs.map(c => c.Nazwa));

        if (compatibleChairs.length > 0) {
          // PokaÅ¼ welcome screen
          const welcomeScreen = document.getElementById('welcome-screen');
          if (welcomeScreen) {
            welcomeScreen.style.display = 'flex';
          }
          showScreen('search-results');
          
          // BezpoÅ›rednio wyÅ›wietl kompatybilne krzesÅ‚a
          console.log('ðŸ” Directly rendering compatible chairs:', compatibleChairs.map(c => c.Nazwa));
          // WyczyÅ›Ä‡ kontener i wyÅ›wietl kompatybilne krzesÅ‚a
          const container = document.getElementById('model-thumbnails');
          if (container) {
            container.innerHTML = '';
            compatibleChairs.forEach(item => {
              const wrapper = document.createElement('div');
              wrapper.className = 'thumbnail-wrapper';
              const button = document.createElement('div');
              button.className = 'thumbnail';
              button.title = item.Nazwa;
              
              const img = document.createElement('img');
              img.src = item.Obrazek && item.Obrazek.length > 4 ? item.Obrazek : 'icons/placeholder.svg';
              img.alt = item.Nazwa;
              button.appendChild(img);
              
              const caption = document.createElement('div');
              caption.className = 'thumbnail-caption';
              caption.textContent = item.Nazwa;
              
              wrapper.appendChild(button);
              wrapper.appendChild(caption);
              container.appendChild(wrapper);
              
              button.addEventListener('click', () => loadModel(item));
            });
          }
          
          alert(`Znaleziono ${compatibleChairs.length} krzeseÅ‚ kompatybilnych z materiaÅ‚em "${material.Nazwa}": ${compatibleChairs.map(c => c.Nazwa).join(', ')}`);
        } else {
          alert(`Nie znaleziono krzeseÅ‚ kompatybilnych z materiaÅ‚em "${material.Nazwa}"`);
        }
      }

      // Funkcja pokazujÄ…ca krzesÅ‚a z okreÅ›lonymi nogami
      function showChairsWithLegs(legs) {
        console.log('ðŸ” Looking for chairs compatible with legs:', legs.Nazwa);
        console.log('ðŸ” Legs data:', legs);
        
        // ZnajdÅº krzesÅ‚a ktÃ³re mogÄ… mieÄ‡ te nogi
        const allChairs = allData.filter(item => 
          item.Typ && item.Typ.toLowerCase() === 'model' &&
          item.Kategoria && item.Kategoria.toLowerCase().includes('krzesÅ‚a')
        );
        
        console.log('ðŸ” All chairs found:', allChairs.map(c => ({ Nazwa: c.Nazwa, Grupa: c.Grupa })));
        
        const compatibleChairs = allChairs.filter(chair => {
          // SprawdÅº czy nogi sÄ… kompatybilne z krzesÅ‚em
          if (!legs.DlaModeluNÃ³g) {
            console.log('ðŸ” No DlaModeluNÃ³g field for legs:', legs.Nazwa);
            return false;
          }
          
          const legChairs = legs.DlaModeluNÃ³g.toLowerCase().split(',').map(s => s.trim());
          const chairName = chair.Nazwa.toLowerCase().trim();
          
          console.log('ðŸ” Checking chair:', chairName, 'against leg chairs:', legChairs);
          
          return legChairs.some(legChair => 
            legChair.includes(chairName) || chairName.includes(legChair)
          );
        });

        console.log('ðŸ” Compatible chairs:', compatibleChairs.map(c => c.Nazwa));

        if (compatibleChairs.length > 0) {
          // PokaÅ¼ welcome screen
          const welcomeScreen = document.getElementById('welcome-screen');
          if (welcomeScreen) {
            welcomeScreen.style.display = 'flex';
          }
          showScreen('search-results');
          
          // BezpoÅ›rednio wyÅ›wietl kompatybilne krzesÅ‚a
          console.log('ðŸ” Directly rendering compatible chairs:', compatibleChairs.map(c => c.Nazwa));
          // WyczyÅ›Ä‡ kontener i wyÅ›wietl kompatybilne krzesÅ‚a
          const container = document.getElementById('model-thumbnails');
          if (container) {
            container.innerHTML = '';
            compatibleChairs.forEach(item => {
              const wrapper = document.createElement('div');
              wrapper.className = 'thumbnail-wrapper';
              const button = document.createElement('div');
              button.className = 'thumbnail';
              button.title = item.Nazwa;
              
              const img = document.createElement('img');
              img.src = item.Obrazek && item.Obrazek.length > 4 ? item.Obrazek : 'icons/placeholder.svg';
              img.alt = item.Nazwa;
              button.appendChild(img);
              
              const caption = document.createElement('div');
              caption.className = 'thumbnail-caption';
              caption.textContent = item.Nazwa;
              
              wrapper.appendChild(button);
              wrapper.appendChild(caption);
              container.appendChild(wrapper);
              
              button.addEventListener('click', () => loadModel(item));
            });
          }
          
          alert(`Znaleziono ${compatibleChairs.length} krzeseÅ‚ kompatybilnych z nogami "${legs.Nazwa}": ${compatibleChairs.map(c => c.Nazwa).join(', ')}`);
        } else {
          alert(`Nie znaleziono krzeseÅ‚ kompatybilnych z nogami "${legs.Nazwa}"`);
        }
      }

      // Inicjalizuj wyszukiwanie po zaÅ‚adowaniu danych
      window.addEventListener('load', () => {
        setTimeout(initializeSearch, 500);
      });

      // Dodatkowa inicjalizacja po DOM
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initializeSearch, 100);
      });

      // Jeszcze jedna inicjalizacja na wszelki wypadek
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => initializeSearch());
      } else {
        // DOM juÅ¼ zaÅ‚adowany
        setTimeout(initializeSearch, 50);
      }

    

      // Sprawdzenie czy strona zostaÅ‚a zaÅ‚adowana z cache (wyÅ‚Ä…czone na mobile)
      window.addEventListener('load', function() {
        // SprawdÅº czy to mobile device (ÑƒÐ»ÑƒÑ‡ÑˆÐµÐ½Ð° detekcja dla iOS)
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1); // iPad na iOS 13+
        
        if (isMobile) {
          console.log('Mobile device detected (iOS/Android), skipping cache reload logic');
          return;
        }
        
        // SprawdÅº czy to byÅ‚o nawigacja z cache
        const navigationEntries = performance.getEntriesByType('navigation');
        if (navigationEntries.length > 0) {
          const nav = navigationEntries[0];
          // JeÅ›li transferSize jest 0 lub bardzo maÅ‚y, prawdopodobnie z cache
          if (nav.transferSize < 1000 && nav.type === 'reload') {
            console.log('Page loaded from cache, forcing hard reload...');
            // OpÃ³Åºnienie aby nie powodowaÄ‡ pÄ™tli
            setTimeout(() => {
              window.location.reload(true);
            }, 100);
            return;
          }
        }
      });

      // Funkcja czyszczenia cache
      function clearAllCaches() {
        if ('caches' in window) {
          caches.keys().then(cacheNames => {
            cacheNames.forEach(cacheName => {
              caches.delete(cacheName);
              console.log('Cleared cache:', cacheName);
            });
          });
        }
      }

      // Funkcja wymuszenia aktualizacji SW
      function forceSwUpdate() {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.getRegistrations().then(registrations => {
            registrations.forEach(registration => {
              registration.update();
            });
          });
        }
      }

      // Sprawdzenie czy strona byÅ‚a odÅ›wieÅ¼ona normalnie (nie hard refresh) - wyÅ‚Ä…czone na mobile
      const perfEntries = performance.getEntriesByType('navigation');
      if (perfEntries.length > 0) {
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1); // iPad na iOS 13+
        
        if (isMobile) {
          console.log('Mobile device detected (iOS/Android), skipping aggressive cache clearing');
        } else {
          const navType = perfEntries[0].type;
          if (navType === 'reload' || navType === 'navigate') {
            console.log('Clearing caches on normal reload...');
            clearAllCaches();
            forceSwUpdate();
          }
        }
      }

      // Jednorazowy bust SW + cache na mobile/PWA jeÅ›li stare wersje blokujÄ… start
      (function oneTimeMobileSwBust(){
        try {
          const key = 'sw_bust_20250914_v2';
          const isStandalone = (window.matchMedia && window.matchMedia('(display-mode: standalone)').matches) || (window.navigator.standalone === true);
          const isMobileUA = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
          const isDev = new URL(window.location.href).searchParams.get('dev') === '1';
          if (isDev && 'serviceWorker' in navigator) {
            console.warn('DEV mode: unregistering all service workers and skipping registration');
            navigator.serviceWorker.getRegistrations().then(regs => Promise.all((regs||[]).map(r => r.unregister())));
            if ('caches' in window) { caches.keys().then(names => Promise.all((names||[]).map(n => caches.delete(n)))); }
          }
          if (!localStorage.getItem(key) && (isMobileUA || isStandalone)) {
            console.log('One-time SW/cache bust for mobile/PWA...');
            Promise.resolve()
              .then(() => (('serviceWorker' in navigator) ? navigator.serviceWorker.getRegistrations() : Promise.resolve([])))
              .then((regs) => Promise.all((regs||[]).map(r => { try { return r.unregister(); } catch(_) { return Promise.resolve(false); } })))
              .then(() => (('caches' in window) ? caches.keys() : Promise.resolve([])))
              .then((names) => Promise.all((names||[]).map(n => { try { return caches.delete(n); } catch(_) { return Promise.resolve(false); } })))
              .then(() => {
                try { localStorage.setItem(key, '1'); } catch(_) {}
                // Reload with a cache-busting param to guarantee fresh HTML
                const url = new URL(window.location.href);
                url.searchParams.set('v', Date.now().toString());
                window.location.replace(url.toString());
              });
          }
        } catch (_) { /* noop */ }
      })();

      // Rejestracja Service Workera z obsÅ‚ugÄ… aktualizacji (mniej agresywne na mobile)
      const isDev = new URL(window.location.href).searchParams.get('dev') === '1';
      if ('serviceWorker' in navigator && !isDev) {
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1); // iPad na iOS 13+
        
        navigator.serviceWorker.register('service-worker.js')
          .then(registration => {
            console.log('Service Worker registered');
            
            // SprawdÅº aktualizacje (mniej agresywne na mobile)
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  console.log('New SW available');
                  if (!isMobile) {
                    console.log('Reloading for SW update...');
                    window.location.reload();
                  } else {
                    console.log('Mobile detected (iOS/Android), skipping auto-reload for SW update');
                  }
                }
              });
            });
          })
          .catch(err => console.error('SW registration failed:', err));

        // SÅ‚uchaj komunikatÃ³w od SW (mniej agresywne na mobile)
        navigator.serviceWorker.addEventListener('message', event => {
          if (event.data.type === 'CACHE_UPDATED') {
            console.log('Cache updated');
            if (!isMobile) {
              console.log('Reloading for cache update...');
              window.location.reload();
            } else {
              console.log('Mobile detected (iOS/Android), skipping auto-reload for cache update');
            }
          }
        });
      }

      // PokaÅ¼/ukryj popup (bezpiecznie na mobile: elementy mogÄ… nie istnieÄ‡)
      (function initEmailPopup() {
        const emailModal = document.getElementById('emailModal');
        const buyButton = document.getElementById('buy-button');
        const emailForm = document.getElementById('emailForm');
        const successMessage = document.getElementById('success-message');
        const closeBtn = emailModal ? emailModal.querySelector('.close-button') : null;

        // Guard when any required element is missing (e.g., simplified mobile UI)
        if (!emailModal || !successMessage) return;

        if (buyButton) {
          buyButton.addEventListener('click', () => {
            // WypeÅ‚nij ikony podsumowania
            fillOrderSummaryIcons();
            
            emailModal.classList.remove('hidden');
            emailModal.classList.add('visible');
            successMessage.classList.remove('visible');
            successMessage.classList.add('hidden');
          });
        }

        if (closeBtn) {
          closeBtn.addEventListener('click', () => {
            emailModal.classList.remove('visible');
            emailModal.classList.add('hidden');
          });
        }

        emailModal.addEventListener('click', (e) => {
          if (e.target === emailModal) {
            emailModal.classList.remove('visible');
            emailModal.classList.add('hidden');
          }
        });
      })();


      const btn = document.getElementById('dimensions-show');
      if (btn) {
        btn.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log("ðŸ“ KlikniÄ™to przycisk wymiarÃ³w");
          toggleDimensions();
        };
      }


      // Po inicjalizacji (czyli gdy masz juÅ¼ modele i przyciski):
      document.querySelectorAll(".export-btn").forEach(button => {
        button.addEventListener("click", () => {
          const format = button.getAttribute("data-format");
          handleExport(format);
        });
      });

      // Keep AR asset candidates in sync with the currently selected chair
      (function keepArAssetsSynced() {
        const recompute = () => {
          try { window.__arAssets = (typeof getCurrentArAssets === 'function') ? getCurrentArAssets() : null; } catch { window.__arAssets = null; }
        };
        recompute();
        // Hook into loadModel if available
        if (typeof window.loadModel === 'function') {
          const orig = window.loadModel;
          window.loadModel = function(...args) {
            const r = orig.apply(this, args);
            setTimeout(recompute, 0);
            return r;
          };
        }
        // Also observe changes to selected chair name in DOM to be safe
        const mo = new MutationObserver(() => setTimeout(recompute, 0));
        mo.observe(document.body, { childList: true, subtree: true });
        // Recompute on visibility changes
        document.addEventListener('visibilitychange', () => setTimeout(recompute, 0));
      })();

      // Funkcje instalacji PWA
      window.showInstallInstructions = function() {
        console.log('ðŸ“± Showing install instructions...');
        
        // Try to trigger native install prompt first
        if (window.deferredInstallPrompt) {
          window.deferredInstallPrompt.prompt();
          window.deferredInstallPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
              console.log('ðŸ“± User accepted the install prompt');
            } else {
              console.log('ðŸ“± User dismissed the install prompt');
              // Show manual instructions
              showManualInstallInstructions();
            }
            window.deferredInstallPrompt = null;
          });
        } else {
          // Show manual instructions
          showManualInstallInstructions();
        }
      };

      function showManualInstallInstructions() {
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
          backdrop-filter: blur(5px);
        `;
        
        modal.innerHTML = `
          <div style="
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 350px;
            width: 90%;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
          ">
            <h3 style="margin: 0 0 16px 0; color: #333;">ðŸ“± Instalacja aplikacji</h3>
            
            <div style="text-align: left; margin: 16px 0; padding: 16px; background: #f8f9fa; border-radius: 8px;">
              <p style="margin: 8px 0; font-size: 14px;"><strong>1.</strong> OtwÃ³rz w Safari</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>2.</strong> NaciÅ›nij przycisk "UdostÄ™pnij" â¬†ï¸</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>3.</strong> Wybierz "Dodaj do ekranu poczÄ…tkowego"</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>4.</strong> PotwierdÅº instalacjÄ™</p>
            </div>
            
            <button onclick="this.parentElement.parentElement.remove()" style="
              background: #007AFF;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 8px;
              font-size: 14px;
              font-weight: 600;
              cursor: pointer;
              margin: 8px;
            ">
              Rozumiem
            </button>
            
            <button onclick="tryAutoInstall()" style="
              background: #F5C842;
              color: #333;
              border: none;
              padding: 12px 24px;
              border-radius: 8px;
              font-size: 14px;
              font-weight: 600;
              cursor: pointer;
              margin: 8px;
            ">
              SprÃ³buj automatycznie
            </button>
          </div>
        `;
        
        document.body.appendChild(modal);
      }

      // Try auto install
      window.tryAutoInstall = function() {
        console.log('ðŸ“± Attempting auto install...');
        
        // Close modal first
        const modal = document.querySelector('div[style*="position: fixed"]');
        if (modal && modal.style.background.includes('rgba(0, 0, 0, 0.7)')) {
          modal.remove();
        }
        
        // Try various install methods
        if (window.BeforeInstallPromptEvent) {
          console.log('ðŸ“± Triggering BeforeInstallPromptEvent...');
          window.dispatchEvent(new Event('beforeinstallprompt'));
        }
        
        // Fallback: redirect to add to homescreen
        setTimeout(() => {
          alert('Dotknij przycisku UdostÄ™pnij (â¬†ï¸) w dolnej czÄ™Å›ci Safari, a nastÄ™pnie "Dodaj do ekranu poczÄ…tkowego"');
        }, 500);
      };

      // Eksport funkcji dla PWA
      window.loadModel = loadModel;
      window.showScreen = showScreen;
      window.renderMobileCategories = renderMobileCategories;
      window.renderMobileModels = renderMobileModels;
      window.renderMobileMainCategories = renderMobileMainCategories;
      window.renderMobileMainModels = renderMobileMainModels;
      window.renderPWACategoryButtons = renderPWACategoryButtons;
  // Export unified mobile list renderer (right panel)
  try { window.renderMobileRightPanelList = renderMobileRightPanelList; } catch(_) {}
      window.allData = allData; // Eksport danych dla PWA
      window.viewer = null; // BÄ™dzie ustawione w initApp

      // ðŸ”„ NOWY HYBRID SYSTEM (CSS + JS) - rotation-overlay
      console.log('ðŸ”„ NEW HYBRID ROTATION SYSTEM - CSS media queries + JS fallback');
      console.log('ðŸ”„ rotation-overlay exists:', !!document.getElementById('rotation-overlay'));
      console.log('ðŸ”„ Window size:', window.innerWidth, 'x', window.innerHeight);
      console.log('ðŸ”„ CSS should handle portrait display automatically');

      // ðŸ”„ NOWE FUNKCJE TESTOWE - teraz wspÃ³Å‚pracujÄ… z CSS
      window.testRotationOverlay = () => {
        const overlay = document.getElementById('rotation-overlay');
        console.log('ðŸ”„ Testing rotation overlay - element:', !!overlay);
        if (overlay) {
          overlay.style.display = 'flex';
          console.log('âœ… Force showing rotation overlay (overriding CSS)');
          return true;
        }
        console.log('âŒ rotation-overlay not found');
        return false;
      };

      window.hideRotationOverlay = () => {
        const overlay = document.getElementById('rotation-overlay');
        if (overlay) {
          overlay.style.display = 'none';
          console.log('âœ… Force hiding rotation overlay (overriding CSS)');
          return true;
        }
        return false;
      };
      
      window.resetRotationOverlay = () => {
        const overlay = document.getElementById('rotation-overlay');
        if (overlay) {
          overlay.style.display = '';
          console.log('âœ… Reset rotation overlay - let CSS media queries handle it');
          return true;
        }
        return false;
      };

      // ðŸ”„ AUTO TEST po 1 sekundzie
      setTimeout(() => {
        console.log('ðŸ”„ NEW AUTO TEST after 1 second');
        const overlay = document.getElementById('rotation-overlay');
        console.log('ðŸ”„ rotation-overlay exists:', !!overlay);
        console.log('ðŸ”„ Window size:', window.innerWidth, 'x', window.innerHeight);
        console.log('ðŸ”„ Is portrait?', window.innerHeight > window.innerWidth);
        console.log('ðŸ”„ Is mobile?', window.innerWidth <= 1024);
        
        // Auto test - pokaÅ¼ komunikat jeÅ›li portrait i mobile
        if (window.innerHeight > window.innerWidth && window.innerWidth <= 1024) {
          console.log('ðŸ”„ AUTO: Portrait + Mobile detected, showing overlay');
          window.testRotationOverlay();
        }
      }, 1000);

  </script>
</body>
</html>
