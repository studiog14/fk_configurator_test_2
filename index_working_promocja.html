<!DOCTYPE html>
<html lang="pl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="format-detection" content="telephone=no" />
  <title>Konfigurator krzeseł - Fajne Krzesła</title>
  <link rel="icon" href="icons/favicon.png" type="image/jpeg" />
  <link rel="manifest" href="manifest.json" />
  
  <!-- iOS PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="FK Krzesła" />
  <link rel="apple-touch-icon" href="icons/favicon.png" />
  
  <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="pragma" content="no-cache" />
  <meta http-equiv="expires" content="0" />
  
  <!-- Cache buster for welcome screen fix -->
  <meta name="timestamp" content="2025-08-09-12:00" />
  
  <script src="ios-fallback.js?v=2025080912"></script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script type="importmap">
{
  "imports": {
    "threepipe": "https://unpkg.com/threepipe@0.0.50/dist/index.mjs",
    "@threepipe/webgi-plugins": "https://unpkg.com/@threepipe/webgi-plugins@0.5.0/dist/index.mjs",
    "three": "https://unpkg.com/three@0.157.0/build/three.module.js"
  }
}
</script>

  <style>
    html,
    body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: 'Poppins', sans-serif;
    }

    #app {
      display: flex;
      height: 100vh;
      width: 100vw;
      position: relative;
      visibility: hidden;
    }

    #app.visible {
  visibility: visible;
  opacity: 1;
}

    #canvas {
      width: 100%;
      height: 100%;
      display: block;
    }

    body {
      background: #ededed80;
      /* przezroczyste tło, lepszy blur */
    }

    /* Panele UI: identyczna przezroczystość i blur obu paneli */
    #sidebar,
    #config-overview {
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 32px rgba(0, 0, 0, 0.10);
      border: 1px solid rgba(0, 0, 0, 0.08);
    }

    #sidebar {
      flex: 0 0 460px;
      min-width: 460px;
      max-width: 540px;
      padding: 32px 24px 24px 24px;
      z-index: 1200;
      display: flex;
      flex-direction: column;
      height: 100vh;
      box-sizing: border-box;
      overflow-y: auto;
      overflow-x: visible;
      position: relative;
      /* NIE dodawaj background! */
    }

    #sidebar-content {
      flex-grow: 1;
      overflow-y: auto;
    }

    /* Separator między wyszukiwaniem a kategoriami */
    #sidebar hr {
      border: none;
      border-top: 1px solid #e0e0e0;
      margin: 10px 0 16px 0;
      opacity: 0.6;
    }

    /* Pole wyszukiwania w lewym sidebar'ze po prawej stronie */
    #search-container {
      position: relative;
      margin-bottom: 10px;
      margin-top: -10px;
      z-index: 1300;
      display: flex;
      align-items: flex-start;
      justify-content: flex-end;
      gap: 10px;
    }

    #search-toggle {
      background: #F5C842;
      border: none;
      border-radius: 50%;
      width: 44px;
      height: 44px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
      transition: all 0.3s ease;
      transform: translateY(-5px);
    }

    #search-toggle:hover {
      background: #E5B432;
      transform: scale(1.05);
    }

    #search-toggle svg {
      width: 20px;
      height: 20px;
      fill: #333;
    }

    #search-panel {
      position: absolute !important;
      top: 0 !important;
      right: 54px !important;
      width: 0 !important;
      max-width: 0 !important;
      background: rgba(255, 255, 255, 0.98) !important;
      backdrop-filter: blur(15px) !important;
      border-radius: 12px !important;
      padding: 0 !important;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2) !important;
      opacity: 0 !important;
      visibility: hidden !important;
      transition: all 0.4s cubic-bezier(0.25, 0.46, 0.45, 0.94) !important;
      z-index: 1400 !important;
      transform: translateX(0) translateY(-5px) !important;
      overflow: hidden !important;
    }

    #search-panel.active {
      width: 320px !important;
      max-width: 320px !important;
      padding: 16px !important;
      opacity: 1 !important;
      visibility: visible !important;
      transform: translateX(0) translateY(-5px) !important;
    }

    #search-input {
      width: 100%;
      border: 2px solid #F5C842;
      border-radius: 8px;
      padding: 12px 16px;
      font-size: 16px;
      outline: none;
      background: white;
      box-sizing: border-box;
    }

    #search-input::placeholder {
      color: #888;
    }

    #search-input:focus {
      border-color: #E5B432;
      box-shadow: 0 0 0 3px rgba(245, 200, 66, 0.2);
    }

    #search-results {
      margin-top: 8px;
      max-height: 300px;
      overflow-y: auto;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(80px, 1fr));
      gap: 8px;
    }

    .search-result-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 8px;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.2s ease;
      border: 2px solid transparent;
      background: rgba(255, 255, 255, 0.9);
      text-align: center;
    }

    .search-result-item:hover {
      background: rgba(245, 200, 66, 0.15);
      border-color: #F5C842;
      transform: translateY(-2px);
    }

    .search-result-item img {
      width: 50px;
      height: 50px;
      object-fit: cover;
      border-radius: 6px;
      margin-bottom: 4px;
    }

    .search-result-item .result-name {
      font-size: 11px;
      font-weight: 600;
      color: #333;
      margin-bottom: 2px;
      line-height: 1.2;
    }

    .search-result-item .result-category {
      font-size: 12px;
      color: #f1c40f;
      font-weight: 600;
      line-height: 1.1;
      text-transform: uppercase;
    }

    /* Fallback dla wyników bez obrazków */
    .search-result-item.text-only {
      grid-column: 1 / -1;
      flex-direction: row;
      justify-content: flex-start;
      text-align: left;
      padding: 8px 12px;
    }

    .search-result-item.text-only .result-name {
      font-size: 14px;
      margin-bottom: 0;
      margin-right: 8px;
    }

    .search-result-item.text-only .result-category {
      font-size: 14px;
      color: #f1c40f;
      font-weight: 600;
      text-transform: uppercase;
    }

    .search-result-item .result-type {
      font-size: 10px;
      color: #F5C842;
      font-weight: 600;
      margin-top: 2px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* Przyciski kategorii */
    .category-button {
      padding: 8px 16px;
      border: 2px solid #F5C842;
      background: white;
      color: #333;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: capitalize;
    }

    .category-button:hover {
      background: #F5C842;
      color: white;
      transform: translateY(-1px);
    }

    .category-button.active {
      background: #F5C842;
      color: white;
    }

    .category-button.promotion {
      border-color: #FF6B6B;
      color: #FF6B6B;
    }

    .category-button.promotion:hover,
    .category-button.promotion.active {
      background: #FF6B6B;
      color: white;
    }

    /* Specjalne kategorie */
    .special-category:hover {
      transform: translateY(-2px) scale(1.02);
      filter: brightness(1.1);
    }

    .special-category:active {
      transform: translateY(0) scale(0.98);
    }

    /* Modal wyboru akcji po wyszukiwaniu */
    #search-choice-modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      justify-content: center;
      align-items: center;
      z-index: 2000;
      backdrop-filter: blur(5px);
    }

    #search-choice-modal.active {
      display: flex;
    }

    .search-choice-content {
      background: white;
      border-radius: 16px;
      padding: 24px;
      max-width: 400px;
      width: 90%;
      text-align: center;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
      animation: modalSlideIn 0.3s ease;
    }

    @keyframes modalSlideIn {
      from {
        opacity: 0;
        transform: translateY(-20px) scale(0.95);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .search-choice-title {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 16px;
      color: #333;
    }

    .search-choice-item {
      display: flex;
      align-items: center;
      margin-bottom: 16px;
      padding: 12px;
      border-radius: 8px;
      background: #f8f9fa;
      border: 2px solid transparent;
    }

    .search-choice-item img {
      width: 40px;
      height: 40px;
      object-fit: contain;
      margin-right: 12px;
      border-radius: 4px;
    }

    .search-choice-item-info {
      flex: 1;
      text-align: left;
    }

    .search-choice-item-name {
      font-weight: 600;
      font-size: 14px;
      color: #333;
      margin-bottom: 2px;
    }

    .search-choice-item-category {
      font-size: 12px;
      color: #f1c40f;
      font-weight: 600;
      text-transform: uppercase;
    }

    .search-choice-buttons {
      display: flex;
      gap: 12px;
      margin-top: 20px;
    }

    .search-choice-btn {
      flex: 1;
      padding: 12px 16px;
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .search-choice-btn.primary {
      background: #F5C842;
      color: #333;
    }

    .search-choice-btn.primary:hover {
      background: #E5B432;
      transform: translateY(-1px);
    }

    .search-choice-btn.secondary {
      background: #f8f9fa;
      color: #666;
      border: 2px solid #e9ecef;
    }

    .search-choice-btn.secondary:hover {
      background: #e9ecef;
      color: #333;
    }



    #config-overview {
      position: absolute;
      top: 20px;
      left: 20px;
      width: 300px;
      padding: 12px 16px;
      /* Zmniejszone padding */
      z-index: 1300;
      font-size: 15px;
      max-height: 1000px;
      opacity: 1;
      transition: max-height 0.3s ease, opacity 0.3s ease, padding 0.3s ease;
      overflow: hidden;
      box-shadow: 0 4px 32px rgba(0, 0, 0, 0.10);
      border-radius: 16px;
      border: 1px solid rgba(0, 0, 0, 0.08);
      background: #fff;
      box-sizing: border-box;
    }

    #config-overview.collapsed {
      max-height: 40px;
      /* Zmniejszone z 60px */
      opacity: 0.8;
      padding: 8px 16px;
      /* Zmniejszone padding w stanie zwiniętym */
    }



    #config-overview:hover {
      opacity: 1;
    }

    .overview-content {
      max-height: 1000px;
      opacity: 1;
      transition: max-height 0.3s ease, opacity 0.3s ease;
      overflow: hidden;
    }

    #config-overview.collapsed .overview-content {
      max-height: 0;
      opacity: 0;
    }





    hr {
      border: none;
      border-top: 1px solid #eee;
      margin: 16px 0 12px;
    }

    .selection-section h3 {
      font-size: 16px;
      margin-bottom: 10px;
      color: #555;
    }

    .options-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
    }

    .thumbnail-wrapper {
      text-align: center;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .thumbnail {
      width: 80px;
      height: 80px;
      object-fit: contain;
      cursor: pointer;
      border: 1px solid #ccc;
      border-radius: 8px;
      transition: all 0.2s;
      background-color: transparent;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 4px;
      box-sizing: border-box;
      opacity: 1;
      /* Ikonki w pełni widoczne */
    }

    .thumbnail:hover {
      transform: scale(1.05);
      border-color: #444;
    }

    .thumbnail.selected {
      outline: 2px solid #050505;
      border: 2px solid transparent;
      outline-offset: -2px;
      box-shadow: 0 0 8px rgba(49, 49, 49, 0.5);
    }

    .thumbnail.promotion {
      border: 2px solid #FF6B6B;
      position: relative;
    }

    .thumbnail.promotion::after {
      content: '';
      position: absolute;
      top: -2px;
      right: -2px;
      width: 12px;
      height: 12px;
      background: #FF6B6B;
      border-radius: 50%;
      z-index: 10;
      display: none; /* Ukryj kropkę, użyjemy prostokąta */
    }

    .thumbnail.promotion::before {
      content: attr(data-discount);
      position: absolute;
      bottom: 4px;
      left: 4px;
      background: #FF6B6B;
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 4px;
      border-radius: 3px;
      z-index: 10;
      line-height: 1;
      white-space: nowrap;
      display: inline-block;
      width: auto;
    }

    .thumbnail.promotion:hover {
      border-color: #FF5252;
    }

    .thumbnail.promotion.selected {
      border: 2px solid #FF6B6B;
      outline: 2px solid #FF5252;
    }

    /* Styl dla bestsellerów - złota ramka z gwiazdką */
    .thumbnail.bestseller {
      border: 2px solid #f5c842;
      position: relative;
    }

    .thumbnail.bestseller::after {
      content: '';
      position: absolute;
      top: -2px;
      right: -2px;
      width: 12px;
      height: 12px;
      background: #f5c842;
      border-radius: 50%;
      z-index: 10;
      display: none; /* Ukryj kropkę, użyjemy prostokąta */
    }

    .thumbnail.bestseller::after {
      content: '⭐';
      position: absolute;
      top: 4px;
      right: 4px;
      background: #f5c842;
      color: #333;
      font-size: 12px;
      font-weight: 700;
      padding: 2px 4px;
      border-radius: 3px;
      z-index: 10;
      line-height: 1;
      white-space: nowrap;
      display: inline-block;
      width: auto;
    }

    .thumbnail.bestseller:hover {
      border-color: #e5b432;
    }

    .thumbnail.bestseller.selected {
      border: 2px solid #f5c842;
      outline: 2px solid #e5b432;
    }

    /* Specjalny styl dla krzeseł które są jednocześnie promocją i bestsellerem */
    .thumbnail.promotion.bestseller {
      border: 3px solid;
      border-image: linear-gradient(45deg, #FF6B6B 0%, #FF6B6B 50%, #f5c842 50%, #f5c842 100%);
      border-image-slice: 1;
      position: relative;
    }

    .thumbnail.promotion.bestseller::after {
      content: '⭐';
      position: absolute;
      top: 4px;
      right: 4px;
      background: #f5c842;
      color: #333;
      font-size: 12px;
      font-weight: 700;
      padding: 2px 4px;
      border-radius: 3px;
      z-index: 11;
      line-height: 1;
      white-space: nowrap;
      display: inline-block;
      width: auto;
    }

    .thumbnail.promotion.bestseller:hover {
      border-image: linear-gradient(45deg, #FF5252 0%, #FF5252 50%, #e5b432 50%, #e5b432 100%);
      border-image-slice: 1;
    }

    .thumbnail.promotion.bestseller.selected {
      border: 3px solid;
      border-image: linear-gradient(45deg, #FF6B6B 0%, #FF6B6B 50%, #f5c842 50%, #f5c842 100%);
      border-image-slice: 1;
      outline: 2px solid rgba(255, 107, 107, 0.5);
    }

    .thumbnail img {
      max-width: 90%;
      max-height: 90%;
      opacity: 1;
    }

    .thumbnail-caption {
      font-size: 15px;
      color: #555;
      margin-top: 6px;
      font-weight: 500;
      opacity: 1;
    }

    .thumbnail-price {
      font-size: 13px;
      color: #333;
      margin-top: 4px;
      font-weight: 600;
      text-align: center;
    }

    .thumbnail-price.promotion {
      display: flex;
      flex-direction: column;
      gap: 1px;
      align-items: center;
    }

    .thumbnail-price.bestseller {
      display: flex;
      flex-direction: column;
      gap: 1px;
      align-items: center;
    }

    .thumbnail-price .original-price {
      color: #FF6B6B;
      text-decoration: line-through;
      font-size: 12px;
      font-weight: 600;
    }

    .thumbnail-price .discounted-price {
      color: #333;
      font-weight: 700;
      font-size: 14px;
    }

    .thumbnail-price .discount-badge {
      background: #FF6B6B;
      color: white;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 3px;
      margin-top: 2px;
    }

    .thumbnail-price .bestseller-badge {
      background: #f5c842;
      color: #333;
      font-size: 10px;
      font-weight: 600;
      padding: 2px 6px;
      border-radius: 3px;
      margin-top: 2px;
    }

    .thumbnail-price .bestseller-price {
      color: #333;
      font-weight: 700;
      font-size: 14px;
    }

    #overview-icons img {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      border: 1px solid #ddd;
      object-fit: contain;
      opacity: 1;
    }

    #config-overview h4 {
      font-size: 20px;
      font-weight: 600;
      margin-bottom: 18px;
    }

    #overview-details .detail-item {
      font-size: 16px;
      margin: 8px 0;
    }

    #overview-total-price {
      font-size: 22px;
    }

    #overview-icons {
      gap: 16px;
      margin-bottom: 20px;
      padding-bottom: 20px;
    }

    #summary {
      margin-top: auto;
      padding-top: 15px;
      border-top: 1px solid #ffffff;
    }

    #back-to-models-container {
      display: flex;
      align-items: center;
      margin-bottom: 18px;
      justify-content: flex-start;
    }

    .back-to-model-btn {
      position: relative;
      width: 80px;
      height: 80px;
      border: 1.5px solid #bbb;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-right: 10px;
      transition: box-shadow 0.2s;
    }

    .back-to-model-btn:hover {
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
    }

    .back-to-model-btn img {
      width: 60px;
      height: 60px;
      object-fit: contain;
      display: block;
    }

    .back-to-model-btn .close-x {
      position: absolute;
      top: 4px;
      right: 6px;
      background: #fff;
      border: none;
      font-size: 20px;
      color: #333;
      cursor: pointer;
      border-radius: 50%;
      width: 24px;
      height: 24px;
      line-height: 20px;
      padding: 0;
      box-shadow: 0 1px 4px #0001;
      transition: background 0.2s;
    }

    .back-to-model-btn .close-x:hover {
      background: #eee;
    }

    /* Nakładki promocji/bestseller dla przycisku powrotu */
    .back-to-model-btn.promotion::before {
      content: attr(data-discount);
      position: absolute;
      bottom: 4px;
      left: 4px;
      background: #FF6B6B;
      color: white;
      font-size: 10px;
      font-weight: 700;
      padding: 2px 4px;
      border-radius: 3px;
      z-index: 10;
      line-height: 1;
      white-space: nowrap;
      display: inline-block;
      width: auto;
    }

    .back-to-model-btn.bestseller::after {
      content: '⭐';
      position: absolute;
      top: 4px;
      right: 4px;
      background: #f5c842;
      color: #333;
      font-size: 12px;
      font-weight: 700;
      padding: 2px 4px;
      border-radius: 3px;
      z-index: 10;
      line-height: 1;
      white-space: nowrap;
      display: inline-block;
      width: auto;
    }

    .back-to-model-btn.promotion {
      border-color: #FF6B6B;
    }

    .back-to-model-btn.bestseller {
      border-color: #f5c842;
    }

    .back-to-model-btn.promotion.bestseller {
      border: 3px solid;
      border-image: linear-gradient(45deg, #FF6B6B 0%, #FF6B6B 50%, #f5c842 50%, #f5c842 100%);
      border-image-slice: 1;
    }

    #camera-debug-panel {
      position: fixed;
      top: 20px;
      right: 20px;
      z-index: 1000;
      background: #fff;
      border: 1px solid #ccc;
      padding: 16px;
      border-radius: 8px;
      box-shadow: 0 2px 8px #0002;
    }

    #camera-debug-panel label {
      display: block;
      margin: 8px 0 4px;
      font-size: 14px;
    }

    #camera-debug-panel input {
      width: 100%;
      margin-bottom: 8px;
    }

    #camera-debug-panel button {
      width: 100%;
      padding: 8px;
      background: #007bff;
      color: #fff;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #camera-debug-panel button:hover {
      background: #0056b3;
    }

    body {
      background: #ededed;
      /* lub Twój kolor tła */
    }

    #buy-button {
      width: 100%;
      padding: 14px 0;
      background: #111;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 18px;
      font-weight: 600;
      margin-top: 18px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      cursor: pointer;
      transition: background 0.2s;
    }

    #buy-button:hover {
      background: #333;
    }

    #buy-button .cart-icon {
      width: 22px;
      height: 22px;
      display: inline-block;
    }

    #sidebar .model-image {
      width: 100%;
      max-width: 100%;
      height: 110px;
      object-fit: contain;
      display: block;
      margin: 0 auto 10px auto;
      background: #fff;
      border-radius: 10px;
      border: 1px solid #eee;
    }



    .modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
    }

    .modal.hidden {
      display: none;
    }

    .modal-content {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 320px;
      background: #fff;
      padding: 24px 28px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
      font-family: "Poppins", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      color: #222;
    }


    .close-button {
      position: absolute;
      top: 12px;
      right: 16px;
      cursor: pointer;
      font-size: 26px;
      font-weight: 700;
      color: #888;
      transition: color 0.2s ease;
    }

    .close-button:hover {
      color: #444;
    }

    .modal-content h2 {
      margin-top: 0;
      margin-bottom: 16px;
      font-weight: 700;
      font-size: 20px;
      text-align: center;
    }

    .modal-content label {
      display: block;
      margin-bottom: 6px;
      font-weight: 600;
      font-size: 14px;
    }

    .modal-content input {
      width: 100%;
      padding: 10px 12px;
      margin-bottom: 18px;
      border: 1.5px solid #ddd;
      border-radius: 12px;
      font-size: 15px;
      box-sizing: border-box;
      transition: border-color 0.2s ease;
    }

    .modal-content input:focus {
      border-color: #888;
      outline: none;
    }

    .modal-content button[type="submit"] {
      width: 100%;
      background: #000;
      color: #fff;
      font-weight: 700;
      font-size: 16px;
      padding: 12px 0;
      border: none;
      border-radius: 16px;
      cursor: pointer;
      transition: background-color 0.3s ease;
    }

    .modal-content button[type="submit"]:hover {
      background: #333;
    }

    /* Komunikat sukcesu */
    #success-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-100%, -50%);

      background: #ffffff;
      /* jasne zielone tło */
      border: 1.5px solid #1f1f1f;
      /* zielona ramka, spójna z tłem */
      color: #000000;
      /* ciemnozielony tekst */

      font-weight: 700;
      font-family: "Poppins", "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;

      padding: 20px 28px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(3, 3, 3, 0.15);

      max-width: 320px;
      width: 90%;
      text-align: center;
      z-index: 9999;
    }


    /* Ukrywanie i pokazywanie */
    .hidden {
      display: none;
    }

    .visible {
      display: block;
    }


    #bottom-toolbar {
      position: fixed;
      top: 50%;
      left: 20px;
      transform: translateY(-50%);
      background: #fff;
      border: 1.5px solid #ccc;
      border-radius: 12px;
      padding: 14px 8px;
      display: flex;
      flex-direction: column;
      gap: 12px;
      z-index: 2000;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      opacity: 0;
      transition: opacity 0.4s ease;
      justify-content: center;
      align-items: center;
    }


    #bottom-toolbar button {
      background: #f0f0f0;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      font-size: 14px;
      cursor: pointer;
      transition: background 0.2s ease;
    }

    #bottom-toolbar.visible {
      opacity: 1;
    }

    #bottom-toolbar button:hover {
      background: #e0e0e0;
    }

    #dimension-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
      z-index: 1000;
    }

    .dimension-line {
      position: absolute;
      background-color: #000;
      height: 2px;
    }

    .axis-line {
      position: absolute;
      height: 2px;
      background-color: #222;
      opacity: 0.6;
    }

    .axis-line.x {
      top: 50%;
      left: 0;
      width: 100%;
      transform: translateY(-50%);
    }

    .axis-line.y {
      left: 50%;
      top: 0;
      width: 2px;
      height: 100%;
      transform: translateX(-50%);
    }

    .axis-line.z {
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      border: 2px dashed #888;
      box-sizing: border-box;
      border-radius: 10px;
    }

    .dimension-label {
      position: absolute;
      background-color: rgba(255, 255, 255, 0.7);
      padding: 5px;
      border-radius: 3px;
      font-size: 14px;
      font-weight: bold;
    }

    .dimension-label:nth-child(4) {
      top: 20px;
    }

    .dimension-label:nth-child(5) {
      top: 50%;
      transform: translate(-50%, -50%);
    }

    .dimension-label:nth-child(6) {
      bottom: 20px;
    }


    #qr-close-btn {
      background-color: #000;
      color: #fff;
      padding: 10px 16px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
      transition: background 0.2s ease;
    }

    #qr-close-btn:hover {
      background-color: #333;
    }

    #qr-popup {
      right: auto !important;
      left: 20px !important;
      transform: translate(175%, 0%) !important;
      width: 320px;
      background: #fff;
      border: 2px solid rgb(0, 0, 0);
      /* łatwiej zobaczyć granice */
      z-index: 999;
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
      text-align: center;
      box-sizing: border-box;
    }

    #qr-popup p {
      font-size: 16px;
      margin-bottom: 12px;
      color: #000;
    }

    #qrcode {
      margin: 0 auto 16px auto;
      display: flex;
      justify-content: center;
    }

    #collapse-btn {
      font-size: 18px;
      /* Zmniejszona z 22px */
      font-weight: bold;
      background: none;
      border: none;
      cursor: pointer;
      color: #111;
      margin-right: 8px;
      padding: 0;
      width: 24px;
      /* Zmniejszona z 30px */
      height: 24px;
      /* Zmniejszona z 30px */
      display: flex;
      align-items: center;
      justify-content: center;
      line-height: 1;
      /* Dodane dla lepszego wycentrowania */
    }

    .overview-header h6 {
      font-size: 18;
      /* Dodane, aby zmniejszyć rozmiar nagłówka */
      margin: 0;
      /* Usunięcie domyślnych marginesów */
    }

    .overview-header {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
      /* Zmniejszone z 12px */
    }

    #config-overview.hidden {
      display: none;
    }

    .overview-title {
      font-size: 16px;
      /* lub inna preferowana wielkość */
      font-weight: bold;
      margin: 0;
    }

   /* 📱 Tryb PIONOWY — ukryj aplikację, pokaż komunikat i mobilne kategorie */
@media (max-width: 820px) and (orientation: portrait) {
  #app,
  #bottom-toolbar,
  #sidebar,
  .dimension-panel,
  .dimension-label,
  #qr-button {
    display: none !important;
  }

  /* Pokaż welcome screen z mobilną sekcją w orientacji pionowej */
  #welcome-screen {
    display: flex !important;
    position: fixed !important;
    top: 0;
    left: 0;
    right: 0;
    bottom: 0;
    z-index: 2001;
    background: #fff;
    overflow-y: auto;
  }
  
  #rotation-message {
    display: none !important;
  }

   #export-panel {
    display: none !important;
  }

  /* Ukryj wyszukiwanie w trybie portrait */
  #search-container {
    display: none;
  }
}

/* 🤖 Tryb POZIOMY — pokazujemy UI */
@media (max-width: 820px) and (orientation: landscape) {
  #rotation-message {
    display: none !important;
  }

  canvas {
  touch-action: manipulation;
  -webkit-tap-highlight-color: transparent;
  width: 100%;
  height: 100vh;
  display: block;
}

 #sidebar {
  width: 280px; /* stała szerokość panelu UI */
  max-width: 280px;
  min-width: 280px;
  box-sizing: border-box;
  overflow-y: auto;
  padding: 8px;
}

  /* Responsywne style dla wyszukiwania na mobile */
  #search-toggle {
    width: 38px;
    height: 38px;
  }

  #search-toggle svg {
    width: 18px;
    height: 18px;
  }

  #search-panel {
    width: 240px;
  }

  #search-input {
    padding: 10px 12px;
    font-size: 14px;
  }

  #search-results {
    max-height: 150px;
  }

  .search-result-item {
    padding: 6px 10px;
    font-size: 14px;
  }

#bottom-toolbar #qr-button {
  display: none !important;
}

#part-tabs {
  display: flex;
  flex-wrap: nowrap; /* 🔒 nie zawijaj w nowe linie */
  overflow-x: auto;  /* 🔄 pozwól na przesuwanie */
  gap: 8px;
  padding: 8px;
  justify-content: flex-start;
}

/* Styl dla pojedynczej ikonki */
#part-tabs button,
#part-tabs .part-btn {
  width: 56px;
  height: 56px;
  font-size: 11px;
  padding: 6px;
  flex: 0 0 auto; /* 🔐 stała szerokość */
  border-radius: 6px;
  box-sizing: border-box;
}

/* Jeśli ikonka ma obrazek */
#part-tabs img {
  width: 32px;
  height: 32px;
}


#bottom-toolbar {
  left: 50%;
  transform: translateX(-125%);
  bottom: 12px;
  padding: 10px 16px;
  display: flex;
  justify-content: center;
  flex-wrap: wrap;
  gap: 8px; /* opcjonalny odstęp między przyciskami */
}

.dimension-panel {
  position: fixed !important;
  top: auto !important;       /* lub np. top: 80px */
  bottom: 150px !important;   /* odległość od dołu */
  left: 200px !important;      /* odległość od lewej krawędzi */
  right: auto !important;     /* lub np. right: 20px */
  transform: none !important;

  font-size: 12px !important;
  padding: 6px 8px !important;
  width: auto !important;
  max-width: 90% !important;
  z-index: 2147483647 !important;
  background: white !important;
  border: 1px solid #ccc !important;
  box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2) !important;
  border-radius: 6px !important;
}

#export-panel {
    display: none !important;
    visibility: hidden;
    pointer-events: none;
  }

   #export-config,
  .export-trigger,
  .toolbar-btn[data-action="export"] {
    display: none !important;
  }



  .thumbnail,
  #overview-icons img,
  .back-to-model-btn {
    width: 56px;
    height: 56px;
  }

  .thumbnail-caption {
    font-size: 13px;
    margin-top: 4px;
    text-align: center;
  }

  #buy-button {
    font-size: 14px;
    padding: 10px;
    width: 100%;
    margin-top: 12px;
  }

  #config-overview {
  position: fixed;
  top: 0;
  bottom: 0;
  left: 0;
  width: 150px; /* szerokość bocznego panelu */
  height: 100vh; /* pełna wysokość */
  padding: 16px;
  background: rgba(245, 245, 245, 0.95);
  box-shadow: 2px 0 10px rgba(0, 0, 0, 0.1);
  border-radius: 0 8px 8px 0;
  z-index: 999;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
}



  #config-overview h2 {
    font-size: 6px !important;
    line-height: 1 !important;
    margin: 0 !important;
    padding: 0 !important;
  }

  #config-overview h2::after {
    content: "+  Twoja konfiguracja";
    font-size: 14px;
    position: absolute;
    right: 10px;
    top: 50%;
    transform: translateY(-50%);
    color: #000;
  }

  #config-overview .overview-title {
    display: none;
  }
}



    .dimension-panel {
      background-color: white;
      border: 1px solid #ccc;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
      padding: 10px;
      border-radius: 5px;
      font-size: 14px;
      z-index: 1001;
    }

    #hdr-toggle {
      position: relative;
    }

    #hdr-panel {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      background: #fff;
      border-radius: 12px;
      padding: 12px 16px;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
      z-index: 9999;
      min-width: 240px;
      display: none;
      padding-top: 30px;
    }

    #hdr-panel.hidden {
      display: none;
    }

    #hdr-close {
      position: absolute;
      top: 5px;
      right: 5px;
      background: none;
      border: none;
      font-size: 20px;
      cursor: pointer;
      color: #111111;
      z-index: 1000;
    }

    #hdr-options {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      justify-content: center;
      padding-top: 10px;
    }

    #hdr-options .thumbnail {
      width: 72px;
      height: 72px;
    }

    #hdr-options .thumbnail img {
      max-width: 100%;
      max-height: 100%;
    }

    .hdr-close-btn {
      position: absolute;
      top: 8px;
      right: 10px;
      background: none;
      border: none;
      font-size: 22px;
      font-weight: bold;
      cursor: pointer;
      color: #555;
      z-index: 10000;
    }

    .hdr-close-btn:hover {
      color: #000;
    }

    #export-panel {
      position: absolute;
      bottom: 60px;
      /* nad przyciskiem */
      right: 62px;
      /* <- tu zwiększ wartość, żeby przesunąć panel bardziej w lewo */
      background: #ffffff;
      border: 1px solid #eeeeee;
      border-radius: 8px;
      padding: 8px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      z-index: 100;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
    }

    #export-panel.hidden {
      display: none;
    }

    .export-btn {
      background-color: #444;
      color: #222222;
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      text-align: left;
      white-space: nowrap;
    }

    .export-btn:hover {
      background-color: #555;
    }
/*Ukrycie przyciku exportu*/
#export-config {
  display: none;
}

#export-panel {
  display: none;
}

   .collection-icon {
  width: 64px;
  height: 64px;
  object-fit: contain;
  cursor: pointer;
  border: 1px solid #ccc;
  border-radius: 8px;
  transition: transform 0.2s, border-color 0.2s;
}

.collection-icon:hover {
  transform: scale(1.05);
  border-color: #444;
}

.collection-icon.selected {
  outline: 2px solid #000;
  box-shadow: 0 0 8px rgba(0,0,0,0.2);
}




    @keyframes slideDown {
      from {
        opacity: 0;
        transform: translateY(-5px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    #material-options details summary {
      cursor: pointer;
      font-weight: bold;
      background: #f7f7f7;
      border-radius: 8px;
      padding: 6px 10px;
      margin-bottom: 6px;
    }

    .collection-icon {
  width: 64px;
  height: 64px;
  object-fit: contain;
  cursor: pointer;
  border: 1px solid #ccc;
  border-radius: 8px;
  transition: transform 0.2s, border-color 0.2s;
}

.collection-icon:hover {
  transform: scale(1.05);
  border-color: #444;
}

.collection-icon.selected {
  outline: 2px solid #000;
  box-shadow: 0 0 8px rgba(0,0,0,0.2);
}

.collection-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
  width: 88px;
  align-items: center;
}

#custom-loader {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  font-family: 'Poppins', Arial, sans-serif;
}

#custom-loader.fade-out {
  opacity: 0;
  transition: opacity 0.5s ease;
  pointer-events: none;
}

#model-loader {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  background: rgba(255, 255, 255, 0.97);
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 9999;
  font-family: 'Poppins', Arial, sans-serif;
  transition: opacity 0.5s ease-in-out;
}

#model-loader p {
  font-size: 18px;
  color: #333;
  text-align: center;
  margin: 10px 0 0 0;
  font-weight: 500;
  text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
}

/* Model loader animations */
@keyframes logoPulse {
  0%, 100% { opacity: 0.9; transform: scale(1); }
  50% { opacity: 1; transform: scale(1.05); }
}

@keyframes progressSlide {
  0% { transform: translateX(-100%); }
  50% { transform: translateX(0%); }
  100% { transform: translateX(100%); }
}

/* 🎯 WELCOME SCREEN */
#welcome-screen {
  position: absolute;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  background: #fff;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 100;
  font-family: 'Poppins', Arial, sans-serif;
  text-align: center;
  padding: 20px;
  /* Ukrywa tylko canvas, nie UI */
  overflow-y: auto; /* Umożliwia przewijanie */
  box-sizing: border-box;
}

/* 📱 Mobilne kontenery PWA - zawsze widoczne */
#mobile-category-buttons-container,
#mobile-model-thumbnails {
  display: block !important;
  visibility: visible !important;
  opacity: 1 !important;
}

/* 📱 Mobilne UI - osobne komponenty */
#mobile-ui-container {
  display: none !important; /* Ukryj domyślnie na desktop */
}

@media (max-width: 820px) {
  #mobile-ui-container {
    display: block !important; /* Pokaż na mobile */
  }
  
  /* Style dla mobilnych przycisków kategorii */
  #mobile-categories-container .mobile-category-btn {
    background: linear-gradient(135deg, #F5C842, #E5B432);
    color: #fff;
    border: none;
    border-radius: 8px;
    padding: 8px 16px;
    font-size: 14px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 2px 8px rgba(245, 200, 66, 0.3);
  }
  
  #mobile-categories-container .mobile-category-btn:hover,
  #mobile-categories-container .mobile-category-btn.active {
    background: linear-gradient(135deg, #E5B432, #D1A029);
    transform: scale(1.05);
  }
  
  /* Style dla mobilnych modeli */
  #mobile-models-container .mobile-model-item {
    background: white;
    border-radius: 12px;
    padding: 10px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    transition: all 0.3s ease;
    cursor: pointer;
    text-align: center;
  }
  
  #mobile-models-container .mobile-model-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 6px 20px rgba(0,0,0,0.15);
  }
  
  #mobile-models-container .mobile-model-item img {
    width: 100%;
    height: 80px;
    object-fit: cover;
    border-radius: 8px;
    margin-bottom: 8px;
  }
  
  #mobile-models-container .mobile-model-item .model-name {
    font-size: 12px;
    font-weight: 600;
    color: #333;
    margin-bottom: 4px;
  }
  
  #mobile-models-container .mobile-model-item .model-price {
    font-size: 11px;
    color: #666;
  }
}

/* 📱 Style dla mobilnych przycisków kategori PWA */
#mobile-category-buttons-container .category-button {
  transition: all 0.2s ease;
}

#mobile-category-buttons-container .category-button:hover {
  transform: scale(1.05);
  box-shadow: 0 2px 8px rgba(245, 200, 66, 0.3);
}

/* Mobile responsive dla welcome screen */
@media (max-width: 820px) {
  #welcome-screen {
    justify-content: flex-start;
    padding: 20px 15px;
  }
  
  #welcome-screen h1 {
    font-size: 1.6em; /* Zmniejszone z 2em */
  }
  
  #welcome-logo {
    max-width: 100px; /* Zmniejszone z 150px */
    margin-bottom: 15px; /* Zmniejszone z 20px */
  }
  
  /* Przyciski kategorii na mobile */
  .category-button {
    font-size: 12px;
    padding: 6px 12px;
    margin: 2px;
  }
  
  #category-buttons-container {
    gap: 6px !important;
  }
}

#welcome-logo {
  max-width: 200px;
  height: auto;
  margin-bottom: 30px;
  animation: logoPulse 3s ease-in-out infinite;
}

#welcome-screen h1 {
  font-size: 2.5em;
  font-weight: 600;
  color: #333;
  margin: 0 0 20px 0;
}

#welcome-screen p {
  font-size: 1.1em;
  color: #666;
  max-width: 500px;
  line-height: 1.5;
  margin: 0;
}

/* Welcome screen yellow accents */
.title-with-accent {
  position: relative;
  margin-bottom: 25px;
}

.title-with-accent h1 {
  margin-bottom: 15px !important;
}

.yellow-accent-line {
  width: 120px;
  height: 4px;
  background: linear-gradient(90deg, #FFD700, #FFA500);
  margin: 0 auto;
  border-radius: 2px;
  animation: accentGlow 2s ease-in-out infinite;
}

.promo-text {
  font-size: 1em !important;
  color: #555 !important;
  font-style: normal;
  margin-top: 20px !important;
  opacity: 0.9;
  animation: fadeInUp 1s ease-out 0.5s both;
}

@keyframes accentGlow {
  0%, 100% { 
    transform: scaleX(1);
    box-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
  }
  50% { 
    transform: scaleX(1.1);
    box-shadow: 0 0 15px rgba(255, 215, 0, 0.6);
  }
}

@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(10px);
  }
  to {
    opacity: 0.9;
    transform: translateY(0);
  }
}

/* � PWA SUCCESS SCREEN */
#pwa-success-screen {
  position: fixed;
  top: 0; left: 0;
  width: 100%;
  height: 100%;
  background: #fff;
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  z-index: 2147483648;
  font-family: 'Poppins', Arial, sans-serif;
  text-align: center;
  padding: 20px;
  overflow-y: auto;
  box-sizing: border-box;
}

#pwa-success-screen.show {
  display: flex;
}

#pwa-success-screen .success-icon {
  font-size: 80px;
  color: #4CAF50;
  margin-bottom: 20px;
  animation: successPulse 2s ease-in-out infinite;
}

#pwa-success-screen h1 {
  font-size: 2.2em;
  font-weight: 600;
  color: #333;
  margin: 0 0 15px 0;
}

#pwa-success-screen p {
  font-size: 1.1em;
  color: #666;
  max-width: 450px;
  line-height: 1.5;
  margin: 0 0 30px 0;
}

.pwa-continue-btn {
  background: linear-gradient(135deg, #4CAF50, #45a049);
  color: white;
  border: none;
  padding: 15px 30px;
  font-size: 16px;
  font-weight: 600;
  border-radius: 30px;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 15px rgba(76, 175, 80, 0.3);
}

.pwa-continue-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(76, 175, 80, 0.4);
}

/* 🎯 PWA SPECIFIC STYLES FOR CHAIR THUMBNAILS */
#pwa-success-screen .options-grid {
  display: flex;
  flex-wrap: wrap;
  gap: 12px;
  justify-content: center;
  max-width: 600px;
  margin: 0 auto;
}

#pwa-success-screen .thumbnail-wrapper {
  text-align: center;
  display: flex;
  flex-direction: column;
  align-items: center;
}

#pwa-success-screen .thumbnail {
  width: 80px;
  height: 80px;
  object-fit: contain;
  cursor: pointer;
  border: 1px solid #ccc;
  border-radius: 8px;
  transition: all 0.2s;
  background-color: transparent;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 4px;
  box-sizing: border-box;
  opacity: 1;
}

#pwa-success-screen .thumbnail:hover {
  transform: scale(1.05);
  border-color: #444;
}

#pwa-success-screen .thumbnail img {
  width: 100%;
  height: 100%;
  object-fit: contain;
  border-radius: 8px;
}

#pwa-success-screen .thumbnail-caption {
  font-size: 15px;
  color: #555;
  margin-top: 6px;
  font-weight: 500;
  opacity: 1;
  max-width: 80px;
  line-height: 1.2;
}

/* Przyciski kategorii w PWA - IDENTYCZNE jak desktop */
#pwa-success-screen .category-button {
  padding: 8px 16px;
  border: 2px solid #F5C842;
  background: white;
  color: #333;
  border-radius: 20px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  text-transform: capitalize;
  margin: 4px;
}

#pwa-success-screen .category-button:hover {
  background: #F5C842;
  color: white;
  transform: translateY(-1px);
}

#pwa-success-screen .category-button.active {
  background: #F5C842;
  color: white;
}

#pwa-success-screen .category-button.promotion {
  border-color: #FF6B6B;
  color: #FF6B6B;
}

#pwa-success-screen .category-button.promotion:hover,
#pwa-success-screen .category-button.promotion.active {
  background: #FF6B6B;
  color: white;
}

@keyframes successPulse {
  0%, 100% { 
    transform: scale(1);
    opacity: 1;
  }
  50% { 
    transform: scale(1.1);
    opacity: 0.8;
  }
}

/* �🎬 ANIMATIONS */
@keyframes logoPulse {
  0% { transform: scale(1); opacity: 1; }
  50% { transform: scale(1.05); opacity: 0.8; }
  100% { transform: scale(1); opacity: 1; }
}

@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}

@keyframes pulse {
  0% { 
    transform: scale(1);
    box-shadow: 0 4px 15px rgba(245, 200, 66, 0.4);
  }
  50% { 
    transform: scale(1.05);
    box-shadow: 0 6px 20px rgba(245, 200, 66, 0.6);
  }
  100% { 
    transform: scale(1);
    box-shadow: 0 4px 15px rgba(245, 200, 66, 0.4);
  }
}

@keyframes progressSlide {
  0% { transform: translateX(-100%); }
  50% { transform: translateX(0%); }
  100% { transform: translateX(100%); }
}

.loader {
  border: 8px solid #f3f3f3;
  border-top: 8px solid #555;
  
  border-radius: 50%;
  width: 48px;
  height: 48px;
  animation: spin 1s linear infinite;
  display: inline-block;
  margin-bottom: 12px;
}
@keyframes spin {
  0% { transform: rotate(0deg);}
  100% { transform: rotate(360deg);}
}

@keyframes rotatePhone {
  0% { transform: rotate(0deg); }
  25% { transform: rotate(-15deg); }
  75% { transform: rotate(15deg); }
  100% { transform: rotate(0deg); }
}


  </style>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>

<body>
    <!-- Komunikat obrotu telefonu - pierwszy element -->
    <div id="rotation-message" style="
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: #FFD700;
        display: none;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        z-index: 30000;
        text-align: center;
        padding: 40px;
        box-sizing: border-box;
    ">
        <img src="icons/FK_logo.png" alt="Fajne Krzesła" style="
            max-width: 120px;
            height: auto;
            margin-bottom: 30px;
            border-radius: 10px;
        " />
        
        <div style="
            font-size: 60px;
            margin-bottom: 20px;
            animation: rotatePhone 2s ease-in-out infinite;
            line-height: 1;
        ">📱</div>
        
        <h2 style="
            color: #333;
            font-size: 24px;
            margin: 0 0 15px 0;
            font-weight: 600;
            font-family: 'Poppins', sans-serif;
        ">Obróć telefon</h2>
        
        <p style="
            color: #666;
            font-size: 16px;
            line-height: 1.5;
            max-width: 300px;
            margin: 0;
            font-family: 'Poppins', sans-serif;
        ">Dla lepszego doświadczenia użyj orientacji poziomej</p>
    </div>

    <!-- 🔄 ANIMATED LOADER z żółtym paskiem -->
    <div id="custom-loader">
        <div class="logo-container" style="
            position: relative;
            margin-bottom: 40px;
            animation: logoPulse 3s ease-in-out infinite;
        ">
            <img src="icons/FK_logo.png" alt="Fajne Krzesła" style="
                max-width: 200px; 
                height: auto;
                border-radius: 10px;
                opacity: 0.9;
            " />
        </div>
        
        <div class="spinner" style="
            width: 40px;
            height: 40px;
            border: 3px solid #f0f0f0;
            border-top: 3px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 30px;
        "></div>
        
        <div class="progress-container" style="
            width: 280px;
            height: 3px;
            background: #f0f0f0;
            border-radius: 2px;
            overflow: hidden;
            margin-bottom: 25px;
        ">
            <div class="progress-bar" style="
                width: 100%;
                height: 100%;
                background: #FFD700;
                animation: progressSlide 2s ease-in-out infinite;
            "></div>
        </div>
        
        <div class="loading-text" style="
            font-size: 16px; 
            color: #333;
            font-weight: 500;
            text-align: center;
            letter-spacing: 0.5px;
        ">Inicjalizacja konfiguratora...</div>
    </div>

    <!-- 🔄 SPINNER podczas zmiany modelu -->
    <div id="model-loader">
        <div class="logo-container" style="
            position: relative;
            margin-bottom: 30px;
            animation: logoPulse 3s ease-in-out infinite;
        ">
            <img src="icons/FK_logo.png" alt="Fajne Krzesła" style="
                max-width: 150px; 
                height: auto;
                border-radius: 10px;
                opacity: 0.9;
            " />
        </div>
        
        <div class="spinner" style="
            width: 35px;
            height: 35px;
            border: 3px solid #f0f0f0;
            border-top: 3px solid #333;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        "></div>
        
        <p>Ładowanie modelu...</p>
        
        <div class="progress-container" style="
            width: 220px;
            height: 3px;
            background: #f0f0f0;
            border-radius: 2px;
            overflow: hidden;
            margin-top: 15px;
        ">
            <div class="progress-bar" style="
                width: 100%;
                height: 100%;
                background: #FFD700;
                animation: progressSlide 2s ease-in-out infinite;
            "></div>
        </div>
    </div>

  <div id="app">

    <!-- CANVAS CONTAINER z WELCOME SCREEN -->
    <div id="canvas-container" style="flex: 1 1 0; position: relative; height: 100%; background: #ededed15;">
      <canvas id="canvas"></canvas>
      
      <!-- 🎯 WELCOME SCREEN - tylko nad canvas -->
      <div id="welcome-screen">
          <img id="welcome-logo" src="icons/FK_logo.png" alt="Fajne Krzesła">
          <div class="title-with-accent">
              <h1 id="welcome-title">Konfigurator Krzeseł</h1>
              <div class="yellow-accent-line"></div>
          </div>
          <!-- Desktop content -->
          <div id="welcome-desktop-content">
            <p>Wybierz kategorię oraz model krzesła z bocznego panelu, aby rozpocząć konfigurację w 3D</p>
            <p class="promo-text">Możesz również zapoznać się z naszymi promocjami i bestsellerami - najczęściej wybieranymi modelami krzeseł</p>
          </div>
          
          <!-- Mobile content -->
          <div id="welcome-mobile-content" style="display: none;">
            <p style="margin: 15px 0; line-height: 1.5;">Wybierz kategorię oraz model krzesła z bocznego panelu, aby rozpocząć konfigurację w 3D</p>
            <p style="margin: 15px 0; line-height: 1.5; color: #666;">Możesz również zapoznać się z naszymi promocjami i bestsellerami - najczęściej wybieranymi modelami krzeseł</p>
            
            <button onclick="showInstallInstructions()" style="
              background: linear-gradient(135deg, #F5C842, #E5B432);
              color: #333;
              border: none;
              padding: 12px 24px;
              border-radius: 25px;
              font-size: 14px;
              font-weight: 600;
              cursor: pointer;
              box-shadow: 0 4px 15px rgba(245, 200, 66, 0.4);
              transition: all 0.3s ease;
              margin: 10px;
            " onmouseover="this.style.transform='scale(1.05)'; this.style.background='linear-gradient(135deg, #E5B432, #D1A029)'" onmouseout="this.style.transform='scale(1)'; this.style.background='linear-gradient(135deg, #F5C842, #E5B432)'">
              📱 Zainstaluj aplikację
            </button>
            
            <button id="welcome-continue-btn" style="
              background: #007AFF;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 25px;
              font-size: 14px;
              font-weight: 600;
              cursor: pointer;
              box-shadow: 0 4px 15px rgba(0, 122, 255, 0.4);
              transition: all 0.3s ease;
              margin: 10px;
            " onmouseover="this.style.transform='scale(1.05)'; this.style.background='#0056D6'" onmouseout="this.style.transform='scale(1)'; this.style.background='#007AFF'">
              Kontynuuj do aplikacji
            </button>
          </div>
          
          <!-- PWA Install Button - UKRYTY -->
          <div id="pwa-install-container" style="margin-top: 30px; display: none !important; visibility: hidden;">
            <button id="welcome-install-btn" style="
              background: linear-gradient(135deg, #F5C842, #E5B432);
              color: #333;
              border: none;
              padding: 12px 24px;
              border-radius: 25px;
              font-size: 14px;
              font-weight: 600;
              cursor: pointer;
              box-shadow: 0 4px 15px rgba(245, 200, 66, 0.4);
              transition: all 0.3s ease;
            " onmouseover="this.style.transform='scale(1.05)'; this.style.background='linear-gradient(135deg, #E5B432, #D1A029)'" onmouseout="this.style.transform='scale(1)'; this.style.background='linear-gradient(135deg, #F5C842, #E5B432)'">
              📱 Zainstaluj jako aplikację
            </button>
          </div>
          
          <!-- 📱 MOBILNA SEKCJA KATEGORII I MODELI - widoczna na mobile -->
          <div id="mobile-ui-container" style="margin-top: 30px; padding: 20px; background: rgba(248, 249, 250, 0.9); border-radius: 15px; backdrop-filter: blur(10px);">
            <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #333; text-align: center;">Wybierz krzesło:</h3>
            
            <!-- Mobilne kategorie - stałe przyciski niezależne od arkusza -->
            <div id="mobile-categories-container" style="margin: 10px 0; text-align: center; display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
              <!-- Kategorie będą tutaj stworzone przez JavaScript -->
            </div>
            
            <!-- Mobilne modele -->
            <div id="mobile-models-container" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(120px, 1fr)); gap: 15px; margin-top: 20px;">
              <!-- Modele będą tutaj renderowane -->
            </div>
            
            <p id="mobile-loading-text" style="text-align: center; color: #666; font-style: italic; margin: 20px 0;">
              Ładowanie kategorii i modeli...
            </p>
          </div>
      </div>
    </div>
    
    <!-- 🎯 PWA SUCCESS SCREEN - pokazywany dopiero po instalacji aplikacji -->
    <div id="pwa-success-screen" style="display: none;">
      <img id="success-logo" src="icons/FK_logo.png" alt="Fajne Krzesła" style="max-width: 150px; height: auto; margin-bottom: 20px;">
      
      <div style="margin: 20px 0; padding: 20px; background: rgba(40, 167, 69, 0.1); border-radius: 15px; border-left: 4px solid #28a745;">
        <h2 style="color: #28a745; margin: 0 0 10px 0; font-size: 22px;">✅ Aplikacja zainstalowana pomyślnie!</h2>
        <p style="margin: 0; color: #333; font-size: 16px;">Dziękujemy za instalację aplikacji Konfigurator Krzeseł</p>
      </div>
      
      <p style="margin: 20px 0; line-height: 1.6; font-size: 16px; color: #555;">
        Aplikacja została dodana do ekranu głównego. Teraz możesz korzystać z pełnej funkcjonalności konfiguratora krzeseł w trybie offline.
      </p>
      
      <div style="margin: 25px 0; padding: 18px; background: rgba(245, 200, 66, 0.1); border-radius: 12px;">
        <p style="margin: 0; font-weight: 600; color: #333; font-size: 16px;">🚀 Gotowe do rozpoczęcia konfiguracji!</p>
        <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">Skonfiguruj swoje wymarzone krzesło w technologii 3D</p>
      </div>
      
      <!-- 🎯 KATEGORIE I KRZESŁA W PWA SUCCESS SCREEN - MOBILNA SEKCJA -->
      <div id="pwa-category-section" style="margin: 20px 0; padding: 20px; background: #f8f9fa; border-radius: 12px;">
        <h3 style="margin: 0 0 15px 0; font-size: 18px; color: #333; text-align: center;">Wybierz krzesło:</h3>
        
        <!-- 🎯 MOBILNE KONTENERY KATEGORII - niezależne od sidebar -->
        <div id="mobile-category-buttons-container" style="margin: 10px 0;">
          <!-- Kategorie będą tutaj renderowane przez renderMobileCategories() -->
        </div>
        
        <div id="mobile-model-thumbnails" class="options-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(80px, 1fr)); gap: 10px; margin-top: 15px;">
          <!-- Modele będą tutaj renderowane przez renderMobileModels() -->
        </div>
        
        <p id="mobile-loading-text" style="text-align: center; color: #666; font-style: italic;">
          Ładowanie kategorii i modeli...
        </p>
      </div>
      
      <!-- 🎯 PRZYCISK KONTYNUUJ -->
      <button id="pwa-success-continue-btn" class="pwa-continue-btn" style="margin-top: 20px;">
        Przejdź do konfiguratora
      </button>
    </div>
    
    <div id="config-overview" class="collapsed hidden">
      <div class="overview-header">
        <button id="collapse-btn">+</button>
        <span class="overview-title">Twoja Konfiguracja</span>
      </div>
      <div class="overview-content">
        <!-- tu cała zawartość, która ma się zwijać -->
        <div id="overview-icons"></div>
        <div id="overview-details"></div>
        <div id="overview-total">
          <p>Suma: <strong id="overview-total-price">0.00 PLN</strong></p>
          <button id="buy-button">Kupuję</button>
        </div>
      </div>
    </div>

    <div id="sidebar">
      <!-- Pole wyszukiwania w prawym górnym rogu sidebar'a -->
      <div id="search-container">
        <button id="search-toggle" type="button" aria-label="Szukaj">
          <svg viewBox="0 0 24 24">
            <path d="M15.5 14h-.79l-.28-.27C15.41 12.59 16 11.11 16 9.5 16 5.91 13.09 3 9.5 3S3 5.91 3 9.5 5.91 16 9.5 16c1.61 0 3.09-.59 4.23-1.57l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/>
          </svg>
        </button>
        
        <div id="search-panel">
          <input 
            type="text" 
            id="search-input" 
            placeholder="Szukaj modeli, materiałów, kolekcji..."
            autocomplete="off"
          />
          <div id="search-results"></div>
          <div id="search-extra"></div>
        </div>
      </div>

      <!-- Modal wyboru akcji po wyszukiwaniu -->
      <div id="search-choice-modal">
        <div class="search-choice-content">
          <div class="search-choice-title">Co chcesz zrobić?</div>
          <div class="search-choice-item">
            <img id="search-choice-item-img" src="" alt="" onerror="this.style.display='none'">
            <div class="search-choice-item-info">
              <div class="search-choice-item-name" id="search-choice-item-name"></div>
              <div class="search-choice-item-category" id="search-choice-item-category"></div>
            </div>
          </div>
          <div class="search-choice-buttons">
            <button class="search-choice-btn secondary" id="search-choice-view-options">Wyniki wyszukiwania</button>
            <button class="search-choice-btn primary" id="search-choice-go-to-chair">Przejdź do krzesła</button>
          </div>
        </div>
      </div>


      
      <!-- Wskaźnik aktywnego filtra wyszukiwania -->
      <div id="search-filter-indicator" style="display: none; margin-bottom: 15px; padding: 8px 12px; background: rgba(245, 200, 66, 0.1); border: 1px solid #F5C842; border-radius: 8px; font-size: 14px;">
        <span style="font-weight: 600;">🔍 Filtr aktywny:</span> 
        <span id="search-filter-text"></span>
        <button id="clear-search-filter" style="float: right; background: none; border: none; color: #666; cursor: pointer; font-size: 16px; padding: 0;" title="Wyczyść filtr">×</button>
      </div>
      
      <!-- Separator oddzielajacy wyszukiwanie od kategorii -->
      <hr style="margin: 20px 0 16px 0; border: none; border-top: 1px solid #e0e0e0; opacity: 0.6;" />
      
      <!-- Przyciski kategorii z specjalnymi kategoriami -->
      <div id="category-buttons" style="margin-bottom: 20px;">
        <h3 style="margin-bottom: 10px; font-size: 16px; color: #555;">Kategorie:</h3>
        <!-- Specjalne kategorie w jednej linii -->
        <div id="special-categories-container" style="display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 12px;"></div>
        <!-- Główne kategorie -->
        <div id="category-buttons-container" style="display: flex; flex-wrap: wrap; gap: 8px;"></div>
      </div>
      
      <div id="model-section">
        <div class="selection-section">
          <h3>Wybierz model:</h3>
          <div id="model-thumbnails" class="options-grid"></div>
        </div>
      </div>
      <div id="config-section" style="display:none;">
        <div id="back-to-models-container" style="margin-bottom: 15px;"></div>
        <div id="legs-section" class="selection-section">
          <h3>Nogi:</h3>
          <div id="legs-thumbnails" class="options-grid"></div>
        </div>
        <div id="parts-section" class="selection-section">
          <h3>Wybierz element:</h3>
          <div id="part-tabs" class="options-grid"></div>
        </div>
        <div id="materials-section" class="selection-section">
          <h3>Wybierz materiał:</h3>
          <div id="material-options" style="display: none;"></div>

<!-- PANEL KOLEKCJI + MATERIAŁY -->
<div id="collection-container" style="display: flex; gap: 24px; margin-top: 20px;">
  <div id="collection-icons" style="display: flex; flex-direction: column; gap: 14px; width: 88px;"></div>
  <div id="material-panel-viewer" class="options-grid" style="flex-grow: 1;"></div>
</div>




      </div>
      <div id="summary"></div>
      
      <!-- Link do panelu admina (tylko przy kluczu Admin w URL) -->
      <div id="admin-link" style="margin-top: 20px; text-align: center; display: none;">
        <hr style="margin: 16px 0; border: none; border-top: 1px solid #e0e0e0; opacity: 0.3;" />
        <a href="admin.html" style="color: #666; font-size: 12px; text-decoration: none; display: inline-flex; align-items: center; gap: 6px;">
          ⚙️ Panel Administracyjny
        </a>
      </div>
    </div>
  </div>
  <!-- FORMULARZ EMAIL - POPUP -->
  <div id="emailModal" class="modal hidden">
    <div class="modal-content">
      <span class="close-button">&times;</span>
      <h2>Wyślij swoją konfigurację</h2>
      <form id="emailForm">
        <label for="name">Imię i nazwisko:</label>
        <input type="text" id="name" name="name" required>

        <label for="email">Adres e-mail:</label>
        <input type="email" id="email" name="email" required>

        <label for="phone">Numer telefonu:</label>
        <input type="tel" id="phone" name="phone">

        <!-- Ukryte pola na dane konfiguracji -->
        <input type="hidden" id="model" name="model">
        <input type="hidden" id="price" name="price">
        <input type="hidden" id="total" name="total">

        <button type="submit">Wyślij</button>
      </form>
    </div>
  </div>

  



  <!-- KOMUNIKAT obrotu -->
  <div id="rotate-message" style="display: none;">
  🔄 Obróć urządzenie poziomo
</div>



  <!-- KOMUNIKAT SUKCESU -->
  <div id="success-message" class="hidden">✅ Dziękujemy! Formularz został wysłany.</div>



  <!-- Lewy panel UI (były dolny toolbar) -->
  <div id="bottom-toolbar" style="display: none;">

    <!-- Przycisk HDR -->
    <button id="hdr-toggle" title="Zmień HDR">
      <img src="icons/bulb_icon.png" alt="HDR" style="width: 20px; height: 20px;">
    </button>

    <div id="hdr-panel" class="hidden">
      <button id="hdr-close" class="hdr-close-btn">×</button>
      <div id="hdr-options" class="options-grid"></div>
    </div>









    <button id="ar-button" title="AR">
      <img src="icons/AR_icon.png" alt="AR" style="width: 30px; height: 30px;">
    </button>

    <button id="dimensions-show" title="Wymiary modelu">
      <img src="icons/dimmension_icon.png" alt="Wymiary" style="width: 20px; height: 20px;">
    </button>


    <button id="export-config" title="Pobierz konfigurację">
      <img src="icons/export_icon.png" alt="Eksport" style="width: 20px; height: 20px;">
    </button>

      <div id="export-panel" class="hidden">
      <button class="export-btn" data-format="fbx">FBX</button>
      <button class="export-btn" data-format="dae">DAE</button>
      <button class="export-btn" data-format="obj">OBJ</button>
    </div>

    <button id="qr-button" title="Zobacz na telefonie">
      <img src="icons/qr_icon.png" alt="QR" style="width: 20px; height: 20px;">
    </button>
  </div>


  <div id="dimension-overlay" style="display: none;"></div>

  <link rel="manifest" href="manifest.json?v=2025080418&fix=welcome" />
  <link rel="apple-touch-icon" href="icons/favicon.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent"">


  <div id="ar-popup" style="
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-100%, -50%);
  background: white;
  padding: 20px 30px;
  border-radius: 12px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.2);
  display: none;
  z-index: 9999;
  text-align: center;
  max-width: 300px;
">
    <img src="icons/AR_icon.png" alt="AR Ikona" style="width: 60px; margin-bottom: 10px;" />
    <div style="font-size: 18px; font-weight: bold;">Dostępne wkrótce</div>
    <div style="margin-top: 6px; font-size: 14px;">Tryb AR zostanie wkrótce uruchomiony.</div>
    <button onclick="document.getElementById('ar-popup').style.display='none'" style="
    margin-top: 12px;
    background: #141414;
    color: white;
    border: none;
    padding: 6px 12px;
    border-radius: 6px;
    cursor: pointer;
  ">Zamknij</button>
  </div>






  <div id="qr-popup"
    style="display:none; position:fixed; top:20%; left:50%; transform:translateX(-50%); background:white; padding:20px; border-radius:12px; box-shadow:0 0 20px rgba(0,0,0,0.2); z-index:3000;">
    <p style="margin-bottom:10px;">Zeskanuj kod QR telefonem:</p>
    <div id="qrcode"></div>
    <button id="qr-close-btn">Zamknij</button>

  </div>


  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script>
    function showQR() {
      const url = window.location.href;
      document.getElementById('qr-popup').style.display = 'block';
      document.getElementById('qrcode').innerHTML = ''; // czyść stare
      document.getElementById('qr-close-btn').addEventListener('click', () => {
        document.getElementById('qr-popup').style.display = 'none';
      });

      new QRCode(document.getElementById("qrcode"), {
        text: url,
        width: 200,
        height: 200,
      });
    }
  </script>


  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
  <script>
    emailjs.init('tjw0wCwxn3xsnfNV5');

    function generateSummaryText() {
      let text = "";
      let totalPrice = 0;

      if (window.selectedChair) {
        const price = parseFloat(window.selectedChair.Cena) || 0;
        totalPrice += price;
        text += `Model: ${window.selectedChair.Nazwa} (${price.toFixed(2)} PLN)\n`;
      }

      if (window.selectedLeg) {
        const price = parseFloat(window.selectedLeg.Cena) || 0;
        totalPrice += price;
        text += `Wariant nóg: ${window.selectedLeg.Nazwa} (${price.toFixed(2)} PLN)\n`;
      }

      const partOrder = ['seat', 'backseat_inside', 'backseat_outside', 'legs_material', 'backseat'];
      partOrder.forEach(part => {
        const mat = window.selectedMaterials?.[part];
        if (mat) {
          const price = parseFloat(mat.Cena) || 0;
          totalPrice += price;
          text += `${part.replace(/_/g, ' ')}: ${mat.Nazwa} (${price.toFixed(2)} PLN)\n`;
        }
      });

      text += `\nSuma konfiguracji: ${totalPrice.toFixed(2)} PLN`;
      return { text, totalPrice };
    }



    emailForm.addEventListener('submit', (e) => {
      e.preventDefault();

      const summary = generateSummaryText();

      document.getElementById('model').value = window.selectedChair?.Nazwa || 'Brak modelu';
      document.getElementById('price').value = parseFloat(window.selectedChair?.Cena || 0).toFixed(2);
      document.getElementById('total').value = summary.totalPrice.toFixed(2);

      let configTextInput = document.getElementById('configText');
      if (!configTextInput) {
        configTextInput = document.createElement('textarea');
        configTextInput.name = 'configText';
        configTextInput.id = 'configText';
        configTextInput.hidden = true;
        emailForm.appendChild(configTextInput);
      }
      configTextInput.value = summary.text;

      emailjs.sendForm('service_iqzcwli', 'template_qgq7htg', emailForm)
        .then(() => {
          document.getElementById('emailModal')?.classList.add('hidden');

          const successMessage = document.getElementById('success-message');
          successMessage.classList.remove('hidden');
          successMessage.classList.add('visible');

          setTimeout(() => {
            successMessage.classList.remove('visible');
            successMessage.classList.add('hidden');
          }, 3500);

          emailForm.reset();
        })
        .catch((error) => {
          alert('❌ Coś poszło nie tak. Spróbuj ponownie.');
          console.error('EmailJS error:', error);
        });
    });
  </script>
  
  <!-- 🚀 OSOBNY MOBILNY KONTENER - globalny, niezależny od welcome-screen -->
  <div id="standalone-mobile-ui" style="
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #f8f9fa 0%, #e3f2fd 100%);
    z-index: 10000;
    display: none;
    overflow-y: auto;
    padding: 20px;
    box-sizing: border-box;
  ">
    <div style="max-width: 500px; margin: 0 auto; padding-top: 60px;">
      <div style="text-align: center; margin-bottom: 30px;">
        <img src="icons/FK_logo.png" alt="Fajne Krzesła" style="max-width: 120px; height: auto; border-radius: 10px;">
        <h1 style="margin: 15px 0 5px 0; color: #333; font-size: 24px;">Konfigurator krzeseł</h1>
        <p style="color: #666; margin: 0; font-size: 14px;">Wybierz swoje idealne krzesło</p>
      </div>
      
      <!-- Mobilne kategorie -->
      <div style="margin-bottom: 20px;">
        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333; text-align: center;">Kategorie:</h3>
        <div id="standalone-mobile-categories" style="display: flex; flex-wrap: wrap; gap: 8px; justify-content: center;">
          <!-- Kategorie tutaj -->
        </div>
      </div>
      
      <!-- Mobilne modele -->
      <div style="margin-bottom: 20px;">
        <h3 style="margin: 0 0 15px 0; font-size: 16px; color: #333; text-align: center;">Krzesła:</h3>
        <div id="standalone-mobile-models" style="display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px;">
          <!-- Modele tutaj -->
        </div>
      </div>
      
      <div style="text-align: center; margin-top: 30px;">
        <button id="close-mobile-ui" style="
          background: #dc3545;
          color: white;
          border: none;
          border-radius: 8px;
          padding: 12px 24px;
          font-size: 14px;
          cursor: pointer;
          transition: all 0.3s ease;
        ">Zamknij mobilny widok</button>
      </div>
    </div>
  </div>

  <script type="module">
    // Główna biblioteka Three.js (z importmap) - jak w poprzedniej wersji
    import * as THREE from 'three';

    // Konkretnie z Three.js (potrzebne do wymiarów i geometrii)
    import {
      Group,
      Box3,
      Vector3,
      ArrowHelper,
      Sprite,
      SpriteMaterial,
      CanvasTexture,
      Color,
      TextureLoader,
      MeshStandardMaterial,
      LinearFilter,
      LinearMipMapLinearFilter,
      RepeatWrapping,
      sRGBEncoding,
      LinearEncoding
    } from 'three';

    // ThreePipe core – viewer i pluginy
    import {
      ThreeViewer,
      LoadingScreenPlugin,
      GBufferPlugin,
      SSAAPlugin,
    } from 'threepipe';

    // Pluginy z WebGI (ThreePipe)
    import {
      SSReflectionPlugin,
      BloomPlugin
    } from '@threepipe/webgi-plugins';








    const CAMERA_FOV = 12;
    const CAMERA_NEAR = 0.1;
    const CAMERA_FAR = 100;
    const CAMERA_POSITION = { x: -4.5, y: 0.76, z: 3.9 };
    const CAMERA_TARGET = { x: 0.79, y: -1.09, z: -0.22 };

    // Specjalne pozycje kamery dla hookerów (bardziej oddalone)
    const CAMERA_POSITION_HOOKER = { x: -6.5, y: 1.2, z: 5.5 };
    const CAMERA_TARGET_HOOKER = { x: 0.79, y: -1.09, z: -0.22 };

    const MIN_ZOOM_DISTANCE = 1; // minimalna odległość kamery od modelu (przybliżenie)
    const MAX_ZOOM_DISTANCE = 8; // maksymalna odległość kamery od modelu (oddalenie)

    // Specjalne limity zoomu dla hookerów (pozwalają bardziej się oddalić)
    const MIN_ZOOM_DISTANCE_HOOKER = 2; 
    const MAX_ZOOM_DISTANCE_HOOKER = 12;
    const VERTICAL_OFFSET = 0;

    let currentModelContainer, currentLegModel;
    window.viewer = null; // Będzie ustawione w initApp
    window.viewerReady = false; // Flaga gotowości viewer'a
    let allData = [];
    let selectedChair, selectedLeg, selectedMaterials = {};
    let globalCameraTargetPosition;
    let userInteracted = false;
    let dimensionHelpers = [];
    let currentModel = null;
    let selectedLegVariant = null;
    let lastOpenedCollection = null;
    let currentSearchFilter = '';
    let activeCollectionsByMesh = {};
    let materialsByMeshAndCollection = {};
    let previousCategory = 'Wszystkie'; // Zapamiętaj poprzednią kategorię przed wyszukiwaniem

    // Funkcja do zapamiętania aktualnie wybranej kategorii
    function saveCurrentCategory() {
      const activeButton = document.querySelector('.category-button.active');
      if (activeButton) {
        previousCategory = activeButton.textContent.trim();
        console.log('💾 Zapisano aktualną kategorię:', previousCategory);
      }
    }

    // Funkcja do przywrócenia poprzedniej kategorii
    function restorePreviousCategory() {
      console.log('↩️ Przywracam poprzednią kategorię:', previousCategory);
      
      // Znajdź przycisk z poprzednią kategorią
      const allButtons = document.querySelectorAll('.category-button');
      const targetButton = Array.from(allButtons).find(btn => 
        btn.textContent.trim() === previousCategory
      );
      
      if (targetButton && targetButton.onclick) {
        // Kliknij przycisk żeby przywrócić kategorię
        targetButton.click();
        console.log('✅ Przywrócono kategorię:', previousCategory);
      } else {
        // Jeśli nie znaleziono, wróć do "Wszystkie"
        const allButton = Array.from(allButtons).find(btn => 
          btn.textContent.trim() === 'Wszystkie'
        );
        if (allButton && allButton.onclick) {
          allButton.click();
          console.log('✅ Przywrócono domyślną kategorię: Wszystkie');
        }
      }
    }

    // Helper function to remove text in parentheses (like "(hooker)") from names
    function stripBrackets(name) {
      if (!name) return name;
      return name.replace(/\s*\([^)]*\)\s*/g, '').trim();
    }

    // Helper function to select appropriate default leg for chair category
    function selectDefaultLeg(availableLegs, chairKategoria) {
      if (!availableLegs || availableLegs.length === 0) return null;
      
      console.log('🦵 selectDefaultLeg called with:', { 
        chairKategoria, 
        availableLegsCount: availableLegs.length,
        legNames: availableLegs.map(l => l.Nazwa),
        legCategories: availableLegs.map(l => ({ name: l.Nazwa, kategoria: l.Kategoria, typ: l.Typ, grupa: l.Grupa }))
      });
      
      let defaultLeg = null;
      const kategoria = (chairKategoria || '').toLowerCase();
      
      if (kategoria.includes('hooker')) {
        // Dla hookerów: szukaj nogi z kategorii hooker
        defaultLeg = availableLegs.find(l => {
          const nogaKategoria = (l.Kategoria || l.Typ || l.Grupa || '').toLowerCase();
          return nogaKategoria.includes('hooker');
        });
        console.log('🦵 For hooker chair, found leg:', defaultLeg?.Nazwa);
      } else if (kategoria.includes('krzes')) {
        // Dla krzeseł: najpierw szukaj "regularne", potem inne krzesła
        defaultLeg = availableLegs.find(l => l.Nazwa && l.Nazwa.toLowerCase().includes('regularne'));
        if (!defaultLeg) {
          defaultLeg = availableLegs.find(l => {
            const nogaKategoria = (l.Kategoria || l.Typ || l.Grupa || '').toLowerCase();
            return nogaKategoria.includes('krzes') || nogaKategoria === '' || nogaKategoria === 'nogi';
          });
        }
        console.log('🦵 For krzesła chair, found leg:', defaultLeg?.Nazwa);
      }
      
      // Jeśli nie znaleziono odpowiedniej nogi, weź pierwszą dostępną
      const result = defaultLeg || availableLegs[0];
      console.log('🦵 Final selected leg:', result?.Nazwa);
      return result;
    }

    const ELEMENT_ICONS = {
      seat: 'icons/m_seat_icon.png',
      backseat_inside: 'icons/m_backseat_in_icon.png',
      backseat_outside: 'icons/m_backseat_out_icon.png',
      backseat: 'icons/m_backseat_icon.png',
      legs: 'icons/m_legs_icon.png'
    };

    function showScreen(screenName) {
      console.log("Showing screen:", screenName);
      
      const welcomeScreen = document.getElementById('welcome-screen');
      
      // Ukryj welcome screen przy przejściu do jakiegokolwiek ekranu
      if (welcomeScreen && screenName !== 'search-results') {
        welcomeScreen.style.display = 'none';
      }
      
      // Bezpieczne sprawdzenie elementów przed manipulacją
      const modelSection = document.getElementById('model-section');
      const configSection = document.getElementById('config-section');
      
      if (modelSection) {
        modelSection.style.display = (screenName === 'models' || screenName === 'search-results') ? 'block' : 'none';
      } else {
        console.warn('⚠️ model-section element not found - trying to create it');
        // Spróbuj stworzyć brakujący element
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
          const newModelSection = document.createElement('div');
          newModelSection.id = 'model-section';
          newModelSection.innerHTML = `
            <div class="selection-section">
              <h3>Wybierz model:</h3>
              <div id="model-thumbnails" class="options-grid"></div>
            </div>
          `;
          
          // Dodaj po sekcji kategorii
          const categorySection = sidebar.querySelector('#category-buttons');
          if (categorySection) {
            categorySection.after(newModelSection);
          } else {
            sidebar.appendChild(newModelSection);
          }
          
          console.log('✅ Created missing model-section');
          newModelSection.style.display = (screenName === 'models' || screenName === 'search-results') ? 'block' : 'none';
        }
      }
      
      if (configSection) {
        configSection.style.display = screenName === 'config' ? 'block' : 'none';
      } else {
        console.warn('⚠️ config-section element not found - trying to create it');
        // Spróbuj stworzyć brakujący element
        const sidebar = document.getElementById('sidebar');
        if (sidebar) {
          const newConfigSection = document.createElement('div');
          newConfigSection.id = 'config-section';
          newConfigSection.style.display = 'none';
          newConfigSection.innerHTML = `
            <div id="back-to-models-container" style="margin-bottom: 15px;"></div>
            <div id="legs-section" class="selection-section">
              <h3>Nogi:</h3>
              <div id="legs-thumbnails" class="options-grid"></div>
            </div>
            <div id="parts-section" class="selection-section">
              <h3>Wybierz element:</h3>
              <div id="part-tabs" class="options-grid"></div>
            </div>
            <div id="materials-section" class="selection-section">
              <h3>Wybierz materiał:</h3>
              <div id="material-options" style="display: none;"></div>
              <div id="collection-container" style="display: flex; gap: 24px; margin-top: 20px;">
                <div id="collection-icons" style="display: flex; flex-direction: column; gap: 14px; width: 88px;"></div>
                <div id="material-panel-viewer" class="options-grid" style="flex-grow: 1;"></div>
              </div>
            </div>
            <div id="summary"></div>
          `;
          
          sidebar.appendChild(newConfigSection);
          console.log('✅ Created missing config-section');
          newConfigSection.style.display = screenName === 'config' ? 'block' : 'none';
        }
      }
      
      // Upewnij się że loader jest ukryty gdy pokazujemy główny ekran
      if (screenName === 'models') {
        const loader = document.getElementById('custom-loader');
        if (loader && loader.style.display !== 'none') {
          console.log("Ukrywam loader po przejściu na ekran models");
          loader.classList.add('fade-out');
          setTimeout(() => {
            loader.style.display = 'none';
            const appElement = document.getElementById('app');
            if (appElement) {
              appElement.style.visibility = 'visible';
            }
          }, 500);
        }
      }
    }

    // USUNIĘTO loadCameraTarget - niepotrzebny plik camera_target.glb

    async function loadModelWithFreshness(path, viewer, options = {}) {
      try {
        // Zakoduj URL żeby obsłużyć spacje w nazwach plików
        const encodedPath = encodeURI(path);
        console.log(`🔄 Loading model: ${path} -> ${encodedPath}`);
        
        // Wykonaj zapytanie HEAD, aby pobrać Last-Modified z serwera
        const res = await fetch(encodedPath, { method: 'HEAD' });
        const lastModified = res.headers.get('Last-Modified');

        // Jeśli data jest dostępna, użyj jej jako wersji cache-bustera
        const version = lastModified ? new Date(lastModified).getTime() : Date.now();
        const pathWithVersion = `${encodedPath}?v=${version}`;

        console.log(`🔄 Loading with cache buster: ${pathWithVersion}`);
        
        // Sprawdź czy viewer jest dostępny
        if (!viewer) {
          throw new Error('Viewer not initialized');
        }
        
        // Załaduj model z cache-busterem
        const modelContainer = await viewer.load(pathWithVersion, options);
        return modelContainer;
      } catch (e) {
        console.error(`Nie udało się załadować modelu: ${path}`, e);
        throw e;
      }
    }

    // 🚀 PROSTA INICJALIZACJA (jak w poprzedniej rozmowie)
    document.addEventListener('DOMContentLoaded', () => {
      console.log('🚀 DOM loaded, starting app...');
      
      // Sprawdź czy pokazać link do panelu admina
      const urlParams = new URLSearchParams(window.location.search);
      if (urlParams.get('admin') === 'true' || window.location.hash.includes('admin')) {
        const adminLink = document.getElementById('admin-link');
        if (adminLink) {
          adminLink.style.display = 'block';
        }
      }
      
      init();
    });

    // 📱 ORIENTACJA (oddzielnie, nie blokuje aplikacji)
    window.addEventListener('load', () => {
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
      
      if (isMobile) {
        function checkOrientation() {
          const rotationMessage = document.getElementById('rotation-message');
          
          if (window.innerHeight > window.innerWidth) {
            if (rotationMessage) rotationMessage.style.display = 'flex';
          } else {
            if (rotationMessage) rotationMessage.style.display = 'none';
          }
        }
        
        checkOrientation();
        window.addEventListener('orientationchange', () => setTimeout(checkOrientation, 100));
        window.addEventListener('resize', checkOrientation);
      }
    });

    // Flaga zapobiegająca wielokrotnej inicjalizacji
    let isAppInitialized = false;

    async function init() {
      if (isAppInitialized) {
        console.log('🚫 App already initialized, skipping...');
        return;
      }
      
      console.log('🚀 Starting app initialization...');
      isAppInitialized = true;
      
      // TYMCZASOWO WYŁĄCZONE: Nasłuchiwanie zmian w localStorage (synchronizacja z panelem admina)
      // window.addEventListener('storage', function(e) {
      //   if (e.key === 'chairsData' || e.key === 'materialsData') {
      //     console.log('🔄 Detected data change from admin panel, reloading...');
      //     setTimeout(() => {
      //       loadDataFromSheet(); // Przeładuj dane
      //     }, 1000);
      //   }
      // });
      
      await initApp(); // Uruchom właściwą inicjalizację
    }
    
    async function initApp() {
      console.log('🚀 initApp() started');
      
      const canvas = document.getElementById("canvas");
      const viewer = new ThreeViewer({
        canvas: canvas,
        plugins: [ GBufferPlugin, SSAAPlugin, SSReflectionPlugin, BloomPlugin],
        rendererSettings: { antialias: true }
      });
      
      // Eksport viewer dla PWA
      window.viewer = viewer;
      console.log('🎯 Viewer initialized and exported to window');
      
      if (window.viewer.controls) {
        window.viewer.controls.minDistance = MIN_ZOOM_DISTANCE;
        window.viewer.controls.maxDistance = MAX_ZOOM_DISTANCE;
        window.viewer.controls.dampingFactor = 0.1;
        window.viewer.controls.enableDamping = true;
        window.viewer.controls.addEventListener('change', clampCameraDistance);
      }

      const collapseBtn = document.getElementById('collapse-btn');
      const overviewPanel = document.getElementById('config-overview');
      collapseBtn.onclick = () => {
        overviewPanel.classList.toggle('collapsed');
        collapseBtn.textContent = overviewPanel.classList.contains('collapsed') ? '+' : '−';
      };

      document.getElementById('buy-button').innerHTML = '<span class="cart-icon">🛒</span>Zapytaj o produkt';

      document.getElementById('buy-button').onclick = () => {
        const summary = generateSummaryText();
        const emailAddress = 'mrpeter@o2.pl';
        const subject = `Zapytanie o wycenę: ${selectedChair ? selectedChair.Nazwa : 'Konfiguracja'}`;
        const body = `Dzień dobry,\n\nProszę o wycenę poniższej konfiguracji:\n\n${summary.text}\n-------------------\nSuma: ${summary.totalPrice.toFixed(2)} PLN\n\nPozdrawiam`;
        
        window.location.href = `mailto:${emailAddress}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}`;
      };

      // Obsługa przycisku "Kontynuuj do aplikacji" na welcome screen
      const welcomeContinueBtn = document.getElementById('welcome-continue-btn');
      if (welcomeContinueBtn) {
        console.log('🎯 Welcome continue button found and adding listener');
        welcomeContinueBtn.onclick = () => {
          console.log('🎯 Welcome continue button clicked');
          const welcomeScreen = document.getElementById('welcome-screen');
          if (welcomeScreen) {
            console.log('🎯 Hiding welcome screen');
            welcomeScreen.style.display = 'none';
          } else {
            console.log('❌ Welcome screen not found');
          }
        };
      } else {
        console.log('❌ Welcome continue button not found');
      }

      try {
        await window.viewer.setEnvironmentMap("hdr/hamburg_hbf_1k.hdr", { isHDR: true });
      } catch (e) { 
        console.error("Błąd ładowania HDR:", e); 
      }

      console.log("Ładowanie celów kamery...");
      // USUNIĘTO loadCameraTarget - niepotrzebny plik camera_target.glb
      
      // PRZYWRÓCONE globalCameraTargetPosition 
      globalCameraTargetPosition = new Vector3(CAMERA_TARGET.x, CAMERA_TARGET.y, CAMERA_TARGET.z); // Używamy zdefiniowanego targetu
      
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();
      
      console.log('📡 Loading data from sheets...');
      await loadDataFromSheet();
      console.log('✅ Data loaded successfully, items:', allData?.length);
      console.log('🔍 Sample data:', allData?.slice(0, 3));
      
      // Wywołaj renderowanie przycisków
      renderCategoryButtons();
      
      // Pokaż welcome screen z odpowiednią zawartością
      const welcomeScreen = document.getElementById('welcome-screen');
      if (welcomeScreen) {
        // Wykryj urządzenie mobilne PRZED pokazaniem ekranu
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
        
        const desktopContent = document.getElementById('welcome-desktop-content');
        const mobileContent = document.getElementById('welcome-mobile-content');
        
        // Ustaw zawartość PRZED pokazaniem welcome screen
        if (isMobile) {
          if (desktopContent) desktopContent.style.display = 'none';
          if (mobileContent) mobileContent.style.display = 'block';
        } else {
          if (desktopContent) desktopContent.style.display = 'block';
          if (mobileContent) mobileContent.style.display = 'none';
        }
        
        // Teraz pokaż welcome screen z prawidłową zawartością
        welcomeScreen.style.display = 'flex';
      }
      
      // Ukryj toolbar i panel na starcie
      const toolbar = document.getElementById('bottom-toolbar');
      if (toolbar) {
        toolbar.style.display = 'none';
      }
      
      const configOverview = document.getElementById('config-overview');
      if (configOverview) {
        configOverview.style.display = 'none';
      }
      
      // Ustaw flagę gotowości viewer'a
      window.viewerReady = true;
      console.log('🎯 Viewer is ready for model loading');
      console.log('🔍 Final check: window.viewer =', window.viewer);
      console.log('🔍 Final check: window.viewerReady =', window.viewerReady);
    }

    function setCameraView(targetPosition) {
      const camera = window.viewer.scene.mainCamera;
      camera.fov = CAMERA_FOV;
      camera.near = CAMERA_NEAR;
      camera.far = CAMERA_FAR;
      
      // Sprawdź czy krzesło jest z kategorii hooker i użyj odpowiedniej pozycji kamery
      const isHookerChair = selectedChair && selectedChair.Kategoria && 
                            selectedChair.Kategoria.toLowerCase().includes('hooker');
      
      if (isHookerChair) {
        // Dla hookerów: bardziej oddalone ujęcie
        camera.position.set(CAMERA_POSITION_HOOKER.x, CAMERA_POSITION_HOOKER.y, CAMERA_POSITION_HOOKER.z);
        console.log('🎥 Ustawiam kamerę dla hookera - oddalone ujęcie');
      } else {
        // Dla normalnych krzeseł: standardowe ujęcie
        camera.position.set(CAMERA_POSITION.x, CAMERA_POSITION.y, CAMERA_POSITION.z);
        console.log('🎥 Ustawiam kamerę dla krzesła - standardowe ujęcie');
      }

      // Ustaw target na wybraną pozycję (np. globalCameraTargetPosition)
      let center = globalCameraTargetPosition || new Vector3(CAMERA_TARGET.x, CAMERA_TARGET.y, CAMERA_TARGET.z);
      camera.lookAt(center);
      camera.updateProjectionMatrix();

      // Prawidłowe ustawienie kontrolek
      if (window.viewer.controls) {
        window.viewer.controls.target.copy(center);
        window.viewer.controls.enableRotate = true;
        window.viewer.controls.enablePan = false;
        window.viewer.controls.screenSpacePanning = false;
        window.viewer.controls.enableZoom = true;  // POPRAWKA: zoom powinien być włączony
        window.viewer.controls.enabled = true;
        
        // Ustaw limity zoomu odpowiednie dla typu krzesła
        if (isHookerChair) {
          window.viewer.controls.minDistance = MIN_ZOOM_DISTANCE_HOOKER;
          window.viewer.controls.maxDistance = MAX_ZOOM_DISTANCE_HOOKER;
          console.log('🔍 Ustawiam limity zoomu dla hookera:', MIN_ZOOM_DISTANCE_HOOKER, '-', MAX_ZOOM_DISTANCE_HOOKER);
        } else {
          window.viewer.controls.minDistance = MIN_ZOOM_DISTANCE;
          window.viewer.controls.maxDistance = MAX_ZOOM_DISTANCE;
          console.log('🔍 Ustawiam standardowe limity zoomu:', MIN_ZOOM_DISTANCE, '-', MAX_ZOOM_DISTANCE);
        }
        
        window.viewer.controls.update();
        
        console.log('🎯 Camera configured and target position updated:', center);
      }
    }

    function resizeCanvas() {
      const sidebar = document.getElementById("sidebar");
      const sidebarWidth = sidebar ? sidebar.offsetWidth : 0;
      const canvas = document.getElementById("canvas");
      
      // Sprawdź czy canvas istnieje
      if (!canvas) {
        console.warn('resizeCanvas: Canvas element not found');
        return;
      }
      
      const width = window.innerWidth - sidebarWidth;
      const height = window.innerHeight;
      // Ustaw rozmiar CSS
      canvas.style.width = width + "px";
      canvas.style.height = height + "px";
      // Ustaw rozmiar atrybutów (dla WebGL)
      canvas.width = width;
      canvas.height = height;
      if (window.viewer && window.viewer.renderManager && window.viewer.scene && window.viewer.scene.mainCamera) {
        window.viewer.renderManager.setSize(width, height, false);
        window.viewer.scene.mainCamera.aspect = width / height;
        window.viewer.scene.mainCamera.updateProjectionMatrix();
      }
    }

    async function silentLoadModel(variant) {
      if (currentModelContainer) window.viewer.scene.remove(currentModelContainer);
      currentModelContainer = await loadModelWithFreshness(`chairs/${variant.Nazwa}.glb`, window.viewer, { autoCenter: true });

      console.log("Meshe w modelu:", currentModelContainer.children.map(obj => obj.name)); // <-- DODAJ TO TUTAJ
      //selectedChair = variant; // <-- DODAJ TO!

      
      // Wyśrodkuj kamerę na modelu
      const box = new Box3().setFromObject(currentModelContainer);
      const center = box.getCenter(new Vector3());
      setCameraView(center);
      currentModelContainer.position.sub(center);
      updateSummary();
      renderPartButtons();
    }

    async function loadModel(variant) {
  // Ukryj welcome screen przy wyborze krzesła
  const welcomeScreen = document.getElementById('welcome-screen');
  if (welcomeScreen) {
    welcomeScreen.style.display = 'none';
  }
  
  if (currentModelContainer) {
    if (window.viewer && window.viewer.scene) {
      window.viewer.scene.remove(currentModelContainer);
    }
    if (typeof currentModelContainer.dispose === 'function') currentModelContainer.dispose();
  }
  if (currentLegModel) {
    if (window.viewer && window.viewer.scene) {
      window.viewer.scene.remove(currentLegModel);
    }
    if (typeof currentLegModel.dispose === 'function') currentLegModel.dispose();
  }
  currentModelContainer = null;
  currentLegModel = null;
  selectedLeg = null;
  selectedMaterials = {};

  document.getElementById('model-loader').style.display = 'flex';

  try {
    // Sprawdź czy viewer jest gotowy
    console.log('🔍 loadModel check: window.viewer =', window.viewer);
    console.log('🔍 loadModel check: window.viewerReady =', window.viewerReady);
    console.log('🔍 loadModel check: viewer.load =', window.viewer?.load);
    if (!window.viewer || !window.viewer.load) {
      throw new Error('Viewer nie jest jeszcze zainicjalizowany. Poczekaj chwilę i spróbuj ponownie.');
    }
    
    const modelPath = `chairs/${stripBrackets(variant.Nazwa)}.glb`;
    selectedChair = variant;

    // Załaduj kubełek
    currentModelContainer = await loadModelWithFreshness(modelPath, window.viewer, { autoCenter: true });

    // Jeśli kubełek, to ewentualnie załaduj domyślne nogi
    if (selectedChair.Grupa && selectedChair.Grupa.toLowerCase() === 'kubełek') {
      const chairBounds = new Box3().setFromObject(currentModelContainer);
      currentModelContainer.position.y -= chairBounds.min.y;

      // Filtrowanie nóg po kategorii już na starcie
      const chairKategoria = (selectedChair.Kategoria || '').toLowerCase();
      let legsVariants = allData.filter(d => d.Grupa && d.Grupa.toLowerCase() === 'nogi');
      if (chairKategoria.includes('hooker')) {
        legsVariants = legsVariants.filter(noga => ((noga.Kategoria || noga.Typ || noga.Grupa || '').toLowerCase().includes('hooker')));
      } else if (chairKategoria.includes('krzes')) {
        legsVariants = legsVariants.filter(noga => {
          const nogaKategoria = (noga.Kategoria || noga.Typ || noga.Grupa || '').toLowerCase();
          // Wyklucz nogi hookerów
          if (nogaKategoria.includes('hooker')) return false;
          return nogaKategoria.includes('krzes') || nogaKategoria === '' || nogaKategoria === 'nogi';
        });
      }

      // Domyślna noga: wybieraj odpowiednią dla kategorii krzesła
      const defaultLeg = selectDefaultLeg(legsVariants, selectedChair.Kategoria);

      if (defaultLeg) {
        await setLegModel(defaultLeg);
      }

      document.getElementById('legs-section').style.display = 'block';
      activateLegsTabAndShowMaterials();
    } else {
      document.getElementById('legs-section').style.display = 'none';
      if (currentLegModel) {
        window.viewer.scene.remove(currentLegModel);
        currentLegModel = null;
        selectedLeg = null;
      }
    }

    // ✅ Dopiero teraz chowamy loader
    // ✅ Eleganckie ukrycie z fade-out
document.getElementById('model-loader').classList.add('fade-out');
setTimeout(() => {
  document.getElementById('model-loader').style.display = 'none';
  document.getElementById('model-loader').classList.remove('fade-out');
}, 500);


    // Pokaż dolny pasek narzędzi
    const toolbar = document.getElementById('bottom-toolbar');
    toolbar.classList.add('visible');
    toolbar.style.display = 'flex';

    // Pokaż panel konfiguracji
    const configOverview = document.getElementById('config-overview');
    if (configOverview) {
      configOverview.style.display = 'block';
      configOverview.classList.remove('hidden');
    }

    renderPartButtons();
    userInteracted = true;
    hideDimensions();

    // Pokaż sekcję materiałów nóg
    document.getElementById('materials-section').style.display = 'block';

    // Wyrenderuj kafelki materiałów nóg
    const legsMaterials = allData.filter(d => d.Grupa && d.Grupa.toLowerCase() === 'nogi');
    renderOptions('materials-thumbnails', legsMaterials, (item) => {
      setLegMaterial(item);
    });

    setCameraView(globalCameraTargetPosition);
    enforceZoomLimits();
    updateUI();
    showScreen('config');

  } catch (e) {
    console.error(`BŁĄD ładowania modelu: ${e.message}`, e);
    // Ukryj loader nawet przy błędzie
    document.getElementById('model-loader').style.display = 'none';
    
    // Jeśli błąd związany z brakiem inicjalizacji, pokaż komunikat
    if (e.message.includes('nie jest jeszcze zainicjalizowany')) {
      // Pokazuj komunikat przez 3 sekundy
      const errorDiv = document.createElement('div');
      errorDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(255, 0, 0, 0.9);
        color: white;
        padding: 15px 20px;
        border-radius: 8px;
        font-size: 16px;
        z-index: 10000;
      `;
      errorDiv.textContent = 'Aplikacja się jeszcze ładuje. Poczekaj chwilę i spróbuj ponownie.';
      document.body.appendChild(errorDiv);
      
      setTimeout(() => {
        document.body.removeChild(errorDiv);
      }, 3000);
    }
  }
}









    function createLegMaterial(legData) {
      const metalness = isNaN(parseFloat(legData.metalness)) ? 1 : parseFloat(legData.metalness);
      const roughness = isNaN(parseFloat(legData.roughness)) ? 0.1 : parseFloat(legData.roughness);
      const color = legData.color || '#FFFFFF';

      return new MeshStandardMaterial({
        color: new Color(color),
        metalness: metalness,
        roughness: roughness,
      });
    }
    
    function czyNogaPasujeDoKubełka(nogaVariant, kubelekNazwa) {
  // Sprawdź tradycyjną relację: noga -> kubełek (pole DlaKubełka w nodze)
  const zgodneKubełki = (nogaVariant.DlaKubełka || '')
    .toLowerCase()
    .split(',')
    .map(k => stripBrackets(k.trim()).toLowerCase());
  const kubelekNorm = stripBrackets(kubelekNazwa || '').toLowerCase();
  if (zgodneKubełki.includes(kubelekNorm)) {
    return true;
  }
  
  // Sprawdź nową relację: kubełek -> nogi (pole DostępneNogi w kubełku)
  if (selectedChair && selectedChair.DostępneNogi) {
    const dostępneNogi = selectedChair.DostępneNogi
      .toLowerCase()
      .split(',')
      .map(n => stripBrackets(n.trim()).toLowerCase());
    return dostępneNogi.includes(stripBrackets(nogaVariant.Nazwa || '').toLowerCase());
  }
  
  return false;
}


    async function setLegModel(variant) {
  userInteracted = true;
  console.log("Wywołanie setLegModel dla wariantu:", variant);

  // Sprawdź czy viewer jest gotowy
  if (!window.viewer || !window.viewerReady) {
    console.warn('Viewer nie jest jeszcze gotowy do ładowania nóg');
    return;
  }

  // ✅ Sprawdzenie zgodności kubełka z wariantem nóg
  if (selectedChair && selectedChair.Grupa.toLowerCase() === 'kubełek') {
    const nazwaKubełka = selectedChair.Nazwa?.toLowerCase();
    
    // Sprawdź tradycyjną relację: noga -> kubełek (pole DlaKubełka w nodze)
    const zgodneKubełki = (variant.DlaKubełka || '').toLowerCase().split(',').map(k => k.trim());
    let isCompatible = zgodneKubełki.includes(nazwaKubełka);
    
    // Jeśli tradycyjna relacja nie pasuje, sprawdź nową relację: kubełek -> nogi
    if (!isCompatible && selectedChair.DostępneNogi) {
      const dostępneNogi = selectedChair.DostępneNogi.toLowerCase().split(',').map(n => n.trim());
      isCompatible = dostępneNogi.includes(variant.Nazwa.toLowerCase());
    }
    
    if (!isCompatible) {
      console.warn(`❌ Wariant nóg "${variant.Nazwa}" nie pasuje do kubełka "${selectedChair.Nazwa}"`);
      return;
    }
  }

  // Pokaż loader podczas ładowania nóg
  showModelLoader('Ładowanie nóg...');

      console.log("Wywołanie setLegModel dla wariantu:", variant);
      const oldLegs = currentLegModel;
      try {
        const modelPath = `legs/${stripBrackets(variant.Nazwa)}.glb`;
        console.log("Ładuję model nóg z ścieżki:", modelPath);
        const newLegs = await loadModelWithFreshness(modelPath, window.viewer, { autoCenter: false });


        const legBounds = new Box3().setFromObject(newLegs);
        const legHeight = legBounds.max.y - legBounds.min.y;

        if (currentModelContainer && selectedChair) {
          if (selectedChair.Grupa.toLowerCase() === 'kubełek') {
            let height = parseFloat(variant.height) || legHeight;
            newLegs.position.y = -height;
            currentModelContainer.position.y = 0;
          } else {
            // Sprawdź czy krzesło to hooker - jeśli tak, podnieś wyżej
            const isHookerChair = selectedChair && selectedChair.Kategoria && 
                                  selectedChair.Kategoria.toLowerCase().includes('hooker');
            const verticalOffset = isHookerChair ? 3.0 : VERTICAL_OFFSET;
            
            currentModelContainer.position.y = legHeight + verticalOffset;
            newLegs.position.y = 0;
          }
        }

        if (oldLegs) {
          window.viewer.scene.remove(oldLegs);
          if (typeof oldLegs.dispose === 'function') oldLegs.dispose();
        }
        window.viewer.scene.add(newLegs);
        currentLegModel = newLegs;
        selectedLeg = variant;
        renderFilteredMaterialOptions('legs'); // ⬅️ to odświeża widok kafelków materiałów nóg
        updateMaterialTiles(); // ⬅️ MUSI być tutaj!


        // Odśwież listę nóg, żeby podświetlić wybrany wariant
        const legs = allData
  .filter(d => d.Grupa && d.Grupa.toLowerCase() === 'nogi')
  .filter(noga => {
    const nogaKategoria = (noga.Kategoria || noga.Typ || noga.Grupa || '').toLowerCase();
    const chairKategoria = (selectedChair?.Kategoria || '').toLowerCase();
    // Jeśli wybrano kategorię 'hookery', pokazuj tylko nogi z tej kategorii
    if (chairKategoria.includes('hooker')) {
      return nogaKategoria.includes('hooker');
    }
    // Jeśli wybrano kategorię 'krzesła', pokazuj tylko nogi z tej kategorii (lub uniwersalne)
    if (chairKategoria.includes('krzes')) {
      return nogaKategoria.includes('krzes') || nogaKategoria === '' || nogaKategoria === 'nogi';
    }
    // Domyślnie: oryginalne filtrowanie kubełka
    if (selectedChair && selectedChair.Grupa.toLowerCase() === 'kubełek') {
      if (!czyNogaPasujeDoKubełka(noga, selectedChair.Nazwa)) return false;
    }
    return true;
  });



// Ustaw pierwszą nogę jeśli jeszcze żadna nie została wybrana
if (!selectedLeg && legs.length > 0) {
  const defaultLeg = selectDefaultLeg(legs, selectedChair?.Kategoria);
  setLegModel(defaultLeg);
}
    renderOptions('legs-thumbnails', legs, item => {
  setLegModel(item);
});    



        updateSummary();

        // Wymuszenie odświeżenia sceny
        if (window.viewer.render) window.viewer.render();
        
        // Ukryj loader po udanym załadowaniu
        hideModelLoader();
      } catch (e) {
        console.error(`BŁĄD ładowania nóg: ${e.message}`, e);
        // Ukryj loader również przy błędzie
        hideModelLoader();
      }
    }



    let forceRenderInterval;

    function triggerSceneRefresh() {
      if (window.viewer?.scene?.mainCamera) {
        window.viewer.scene.mainCamera.position.x += 0.00001;
        if (window.viewer.scene.mainCamera.zoom !== undefined) {
          window.viewer.scene.mainCamera.zoom += 0.0001; // ⬅️ mikroskopijny zoom
        }
        window.viewer.scene.mainCamera.updateProjectionMatrix();
      }
      if (window.viewer?.renderManager?.info) {
        window.viewer.renderManager.info.reset();
      }
      if (window.viewer?.render) window.viewer.render();
    }


    function startForceRender(duration = 2000) {
      clearInterval(forceRenderInterval);
      forceRenderInterval = setInterval(() => {
        triggerSceneRefresh();
      }, 100);

      setTimeout(() => {
        clearInterval(forceRenderInterval);
        console.log("🛑 Zakończono wymuszone odświeżanie");
      }, duration);
    }



    const textureLoader = new TextureLoader();

    

    if (
      selectedChair?.Grupa?.toLowerCase() === 'kubełek' &&
      variant.TargetMeshOrModel?.toLowerCase().includes('legs') &&
      variant.WariantModelu
    ) {
      // 👉 dla kubełków z podmianą nóg — zmień model nóg
      setLegModel(variant);
    } else if (
      selectedChair &&
      (selectedChair.Grupa.toLowerCase() !== 'kubełek' || !variant.WariantModelu)
    ) {
      // 👉 dla pozostałych krzeseł bez wariantów nóg — wyświetl materiały nóg do wyboru
      showLegMaterialsForSimpleChairs(selectedChair);
    }

    // Funkcje preloadera – używamy tego samego model-loader co dla modeli i nóg
function showPreloader() {
  showModelLoader('Ładowanie materiału...');
}
function hidePreloader() {
  hideModelLoader();
}

// Uniwersalne funkcje loadera z zmiennym tekstem
function showModelLoader(text = 'Ładowanie modelu...') {
  const el = document.getElementById('model-loader');
  if (el) {
    const textEl = el.querySelector('p');
    if (textEl) textEl.textContent = text;
    el.style.display = 'flex';
  }
}

function hideModelLoader() {
  const el = document.getElementById('model-loader');
  if (el) {
    el.classList.add('fade-out');
    setTimeout(() => {
      el.style.display = 'none';
      el.classList.remove('fade-out');
      // Przywróć oryginalny tekst
      const textEl = el.querySelector('p');
      if (textEl) textEl.textContent = 'Ładowanie modelu...';
    }, 500);
  }
}

// Funkcje loadera materiałów
function showMaterialLoader(text = 'Ładowanie materiału...') {
  const el = document.getElementById('model-loader');
  if (el) {
    const textEl = el.querySelector('p');
    if (textEl) textEl.textContent = text;
    el.style.display = 'flex';
  }
}

function hideMaterialLoader() {
  const el = document.getElementById('model-loader');
  if (el) {
    el.classList.add('fade-out');
    setTimeout(() => {
      el.style.display = 'none';
      el.classList.remove('fade-out');
      // Przywróć oryginalny tekst
      const textEl = el.querySelector('p');
      if (textEl) textEl.textContent = 'Ładowanie modelu...';
    }, 500);
  }
}

    function applyMaterialToMesh(variant, forcedMeshName) {
      const clone = { ...variant };
      clone.TargetMeshOrModel = forcedMeshName;
      console.log(`🎯 Przypisano '${clone.Nazwa}' tylko do mesh '${forcedMeshName}'`);
      applyMaterial(clone);
    }

    // Funkcja, która wyświetla kafelki materiałów nóg dla prostych krzeseł
    function showLegMaterialsForSimpleChairs(chair) {
      const legsMaterialsContainer = document.getElementById('legs-thumbnails');
      // Usuń tylko kafelki materiałów (pozostaw warianty nóg)
      legsMaterialsContainer.querySelectorAll('.material-tile').forEach(tile => tile.remove());


      // Pobierz materiały nóg dla danego krzesła (przykład, wymaga dostosowania)
      const materials = getMaterialsForLegs(chair.defaultLegsId || 'default');

      materials.forEach(mat => {
        const tile = document.createElement('div');
        tile.className = 'material-tile';
        tile.textContent = mat.Nazwa;
        tile.style.backgroundImage = `url(${mat.Obrazek || 'fallback.png'})`;
        tile.onclick = () => {
          onLegVariantClick(mat.DlaModeliNóg || mat.Nazwa);
          applyLegMaterial(mat);
        };

        legsMaterialsContainer.appendChild(tile);
      });
    }


    



// DOBRE PROGRESYWNE ŁADOWANIE MATERIAŁÓW!!!

async function applyMaterial(variant) {
  showMaterialLoader('Ładowanie materiału...');
  try {
    console.log('📦 variant:', variant);

    if (!currentModelContainer) {
      console.warn('currentModelContainer jest null lub undefined');
      hideMaterialLoader();
      return;
    }

    if (!variant.TargetMeshOrModel) {
      console.warn('Brak TargetMeshOrModel w wariancie');
      hideMaterialLoader();
      return;
    }

    const targetNames = variant.TargetMeshOrModel.split(',').map(name => name.trim());
    const isHex = /^#([0-9a-f]{3}|[0-9a-f]{6})$/i.test(variant.Color || variant.Wartość);
    const folderPath = (!isHex && variant.Wartość.startsWith('textures/')) ? variant.Wartość : `textures/${variant.Wartość}`;

    // Progresywna obsługa wielu meshów - loader znika dopiero po wszystkich meshach
    const meshPromises = targetNames.map(async (targetName) => {
      let container;
      if (targetName.toLowerCase() === 'legs') {
        if (selectedChair?.Grupa?.toLowerCase() === 'krzesło' || !currentLegModel) {
          container = currentModelContainer;
        } else {
          container = currentLegModel;
        }
      } else {
        container = currentModelContainer;
      }

      let targetObject = null;
      container?.traverse(obj => {
        if (
          obj.isMesh &&
          obj.name &&
          obj.name.toLowerCase().trim() === targetName.toLowerCase().trim()
        ) {
          targetObject = obj;
        }
      });

      if (!targetObject) {
        console.warn(`❌ Mesh '${targetName}' nie znaleziony w modelu`);
        return;
      }

      if (!targetObject.material) {
        console.warn(`⚠️ Mesh '${targetName}' nie ma materiału.`);
        return;
      }

      // Funkcja do bezpiecznego ładowania tekstury (zwraca null, jeśli nie uda się załadować)
      async function loadTextureSafe(url) {
        try {
          const tex = await textureLoader.loadAsync(url);
          tex.magFilter = LinearFilter;
          tex.minFilter = LinearMipMapLinearFilter;
          tex.anisotropy = viewer?.renderer?.capabilities?.getMaxAnisotropy?.() || 4;
          tex.wrapS = tex.wrapT = RepeatWrapping;
          tex.encoding = sRGBEncoding;
          tex.offset.set(0, 0);
          tex.repeat.set(1, 1);
          tex.needsUpdate = true;
          return tex;
        } catch {
          return null;
        }
      }

      if (isHex) {
        // Jeśli kolor HEX – podmień od razu (nie ma tekstur)
        const material = targetObject.material.clone();
        material.color.set(variant.Color || variant.Wartość);
        material.map = null;
        material.normalMap = null;
        material.roughnessMap = null;
        material.metalnessMap = null;
        material.needsUpdate = true;
        targetObject.material = material;
        window.viewer.render?.();
      } else if (folderPath && !/\.(jpg|jpeg|png|gif)$/i.test(folderPath)) {
        // --- PROGRESYWNE ŁADOWANIE ---

        // 1. Najpierw załaduj basecolor
        let baseColorTex = null;
        try {
          baseColorTex = await loadTextureSafe(`${folderPath}/baseColor.jpg`);
        } catch (err) {
          console.warn("Błąd ładowania baseColor:", err);
        }

        // 2. Skopiuj materiał i podepnij basecolor (lub null)
        const material = targetObject.material.clone();
        material.map = baseColorTex || null;
        material.color.set(0xffffff);
        material.normalMap = null;
        material.roughnessMap = null;
        material.metalnessMap = null;
        material.needsUpdate = true;

        // 3. Metalness i roughness z wariantu
        function parseValue(val, fallback) {
          const raw = (val || '')
            .toString()
            .trim()
            .replace(/['"]/g, '')
            .replace(',', '.');
          const parsed = parseFloat(raw);
          return !isNaN(parsed) ? parsed : fallback;
        }
        material.metalness = parseValue(variant.Metalness, 0);
        material.roughness = parseValue(variant.Roughness, 0.814);

        // 4. Podmień materiał dopiero teraz (dopiero po basecolor)
        targetObject.material = material;
        if (targetObject.geometry?.computeVertexNormals) {
          targetObject.geometry.computeVertexNormals();
        }
        window.viewer.render?.();

        // 6. Progresywnie doładowuj pozostałe mapy i podmieniaj "w locie"
        loadTextureSafe(`${folderPath}/normal.jpg`).then(tex => {
          if (tex) {
            tex.encoding = LinearEncoding;
            tex.wrapS = tex.wrapT = RepeatWrapping;
            tex.offset.set(0, 0);
            tex.repeat.set(1.001, 1.001);
            material.normalMap = tex;
            material.needsUpdate = true;
            targetObject.material = material;
            window.viewer.render?.();
          }
        });

        loadTextureSafe(`${folderPath}/roughness.jpg`).then(tex => {
          if (tex) {
            tex.encoding = LinearEncoding;
            tex.wrapS = tex.wrapT = RepeatWrapping;
            tex.offset.set(0, 0);
            tex.repeat.set(1.001, 1.001);
            material.roughnessMap = tex;
            material.needsUpdate = true;
            targetObject.material = material;
            window.viewer.render?.();
          }
        });

        loadTextureSafe(`${folderPath}/metallic.jpg`).then(tex => {
          if (tex) {
            tex.encoding = LinearEncoding;
            tex.wrapS = tex.wrapT = RepeatWrapping;
            tex.offset.set(0, 0);
            tex.repeat.set(1.001, 1.001);
            material.metalnessMap = tex;
            material.needsUpdate = true;
            targetObject.material = material;
            window.viewer.render?.();
          }
        });

        console.log(`✅ Progresywne ładowanie tekstur na '${targetName}'`);
        console.log(`🧪 Metalness=${material.metalness}, Roughness=${material.roughness}`);
      }

      // Zapamiętanie wyboru i odświeżenie sceny
      selectedMaterials[targetName] = variant;
      if (targetName === 'legs' || targetName === 'legs_material') {
        selectedMaterials['legs_material'] = variant;
      }
    });

    await Promise.all(meshPromises); // czekaj aż wszystkie meshe ogarną materiał
    hideMaterialLoader();
    // 🗂️ Automatycznie przypisz Folder do eksportu
    Object.entries(selectedMaterials).forEach(([key, mat]) => {
      if (!mat.Folder && typeof mat.Wartość === 'string') {
        const parts = mat.Wartość.split('/');
        const last = parts[parts.length - 1];
        if (last && texturesFilesByFolder?.[last]) {
          mat.Folder = last;
          console.log(`📁 Dodano Folder='${last}' do '${key}'`);
        }
      }
    });

    window.viewer.scene.traverse(obj => {
      if (obj.isMesh && obj.material) {
        obj.material.needsUpdate = true;
      }
    });

    if (window.viewer?.scene?.mainCamera) {
      window.viewer.scene.mainCamera.position.x += 0.00001;
      window.viewer.scene.mainCamera.updateProjectionMatrix();
    }

    if (window.viewer?.render) window.viewer.render();

    updateSummary();
  } catch (e) {
    hideMaterialLoader();
    console.error("Błąd w applyMaterial:", e);
  }
}

function applyMaterialToSpecificMesh(variant, meshKey) {
  const clone = { ...variant };
  clone.TargetMeshOrModel = meshKey;
  console.log(`🎯 Przypisano '${variant.Nazwa}' tylko do mesh '${meshKey}'`);
  applyMaterial(clone);
}

// DOBRE PROGRESYWNE ŁADOWANIE MATERIAŁÓW!!!





      function renderOptions(containerId, items, onSelect, isInteractive = true) {
        const container = document.getElementById(containerId);
        if (!container) return;
        container.innerHTML = '';
        
        // Zastosuj filtr wyszukiwania jeśli jest aktywny
        const filteredItems = currentSearchFilter 
          ? items.filter(matchesSearchFilter)
          : items;
          
        console.log(`📦 Rendering ${filteredItems.length}/${items.length} items in ${containerId}`);
        
        filteredItems.forEach((item, index) => {
          console.log(`📷 Item ${index}: "${item.Nazwa}", Image URL: "${item.Obrazek}"`);
          if (index === 0) {
            console.log('🔍 FIRST ITEM ALL FIELDS:', Object.keys(item));
            console.log('🔍 Obrazek field:', item.Obrazek);
            console.log('🔍 Mobile field:', item.Mobile);
          }
          
          const wrapper = document.createElement('div');
          wrapper.className = 'thumbnail-wrapper';
          const button = document.createElement('div');
          button.className = 'thumbnail';
          button.title = stripBrackets(item.Nazwa);

          // Dodaj klasę promocji jeśli przedmiot jest na promocji
          if (item.Promocja && item.Promocja.trim() !== '' && (item.Promocja === 'TRUE' || item.Promocja === 'true' || item.Promocja === 'tak' || item.Promocja === '✔')) {
            button.classList.add('promotion');
            // Dodaj procent zniżki jako data-attribute dla CSS
            const procent = parseFloat(item.Procent) || 0;
            console.log(`🎯 PROMOCJA DEBUG - Item: ${item.Nazwa}, Promocja: "${item.Promocja}", Procent raw: "${item.Procent}", Procent parsed: ${procent}`);
            if (procent > 0) {
              button.setAttribute('data-discount', `-${procent}%`);
            }
          }

          // Dodaj klasę bestseller jeśli przedmiot jest bestsellerem
          if (item.Bestseller && (item.Bestseller === 'TRUE' || item.Bestseller === 'true' || item.Bestseller === 'tak' || item.Bestseller === '✔')) {
            button.classList.add('bestseller');
          }

          // PODŚWIETLENIE WYBRANEGO
          let isSelected = false;
          if (containerId === 'material-options') {
            if (item.Grupa && item.Grupa.toLowerCase() === 'materiały_nóg') {
              isSelected = selectedMaterials['legs_material'] && selectedMaterials['legs_material'].Nazwa === item.Nazwa;
            } else if (item.TargetMeshOrModel) {
              const targets = item.TargetMeshOrModel.split(',').map(t => t.trim());
              isSelected = targets.some(t => selectedMaterials[t] && selectedMaterials[t].Nazwa === item.Nazwa);
            }
          } else if (containerId === 'legs-thumbnails') {
            isSelected = selectedLeg && selectedLeg.Nazwa === item.Nazwa;
          }
          if (isSelected) button.classList.add('selected');

          if (isInteractive) {
            button.addEventListener('click', () => {
              onSelect(item);
              container.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('selected'));
              button.classList.add('selected');
            });
          }
          const img = document.createElement('img');
          const imageUrl = item.Obrazek && item.Obrazek.length > 4 ? item.Obrazek : 'icons/placeholder.svg';
          img.src = imageUrl;
          img.alt = item.Nazwa;
          
          // Debug obrazka
          img.onerror = () => {
            console.error(`❌ Failed to load image: ${imageUrl} for item: ${item.Nazwa}`);
            img.src = 'icons/placeholder.svg';
          };
          img.onload = () => {
            console.log(`✅ Successfully loaded image: ${imageUrl} for item: ${item.Nazwa}`);
          };
          
          button.appendChild(img);
          const caption = document.createElement('div');
          caption.className = 'thumbnail-caption';
          caption.textContent = stripBrackets(item.Nazwa);
          
          // Dodaj cenę (tylko dla modeli krzeseł)
          const priceDiv = document.createElement('div');
          if (item.Typ === 'model' && item.Cena) {
            const cena = parseFloat(item.Cena) || 0;
            const promocja = item.Promocja === 'TRUE' || item.Promocja === 'true' || item.Promocja === 'tak' || item.Promocja === '✔';
            const bestseller = item.Bestseller === 'TRUE' || item.Bestseller === 'true' || item.Bestseller === 'tak' || item.Bestseller === '✔';
            const procent = parseFloat(item.Procent) || 0;
            
            console.log(`💰 CENA DEBUG - Item: ${item.Nazwa}, Cena raw: "${item.Cena}", Cena parsed: ${cena}, Promocja: ${promocja}, Procent: ${procent}`);
            
            if (promocja && procent > 0) {
              // Cena promocyjna - cena przekreślona i nowa cena (prostokąt z % jest na ikonce)
              const cenaPoPobniżce = cena * (1 - procent / 100);
              if (bestseller) {
                // Jeśli to też bestseller, dodaj łatkę bestseller
                priceDiv.className = 'thumbnail-price promotion bestseller';
                priceDiv.innerHTML = `
                  <span class="original-price">${cena.toFixed(0)} zł</span>
                  <span class="discounted-price">${cenaPoPobniżce.toFixed(0)} zł</span>
                  <span class="bestseller-badge">⭐ Bestseller</span>
                `;
              } else {
                priceDiv.className = 'thumbnail-price promotion';
                priceDiv.innerHTML = `
                  <span class="original-price">${cena.toFixed(0)} zł</span>
                  <span class="discounted-price">${cenaPoPobniżce.toFixed(0)} zł</span>
                `;
              }
              console.log(`💰 PROMOCJA PRICE - Cena przed: ${cena}, po obniżce: ${cenaPoPobniżce} (${procent}% zniżki)`);
            } else if (bestseller && cena > 0) {
              // Cena bestsellera - normalna cena z oznaczeniem bestseller
              priceDiv.className = 'thumbnail-price bestseller';
              priceDiv.innerHTML = `
                <span class="bestseller-price">${cena.toFixed(0)} zł</span>
                <span class="bestseller-badge">⭐ Bestseller</span>
              `;
            } else if (cena > 0) {
              // Cena normalna
              priceDiv.className = 'thumbnail-price';
              priceDiv.textContent = `${cena.toFixed(0)} zł`;
            }
          }
          
          wrapper.appendChild(button);
          wrapper.appendChild(caption);
          if (priceDiv.textContent || priceDiv.innerHTML) {
            wrapper.appendChild(priceDiv);
          }
          container.appendChild(wrapper);
        });
      }





      function renderFilteredMaterialOptions(targetMesh) {
  if (!selectedChair || !selectedChair.Grupa) return;

  const grupa = selectedChair.Grupa.toLowerCase();

  function isAllowedForGroup(entryGroupDocelowa) {
    if (!entryGroupDocelowa) return false;
    const values = entryGroupDocelowa.toLowerCase().split(',').map(s => s.trim());
    return values.includes('wszystkie') || values.includes(grupa) || values.includes('kubełek, krzesło');
  }

  let materialOptions = [];

  const isLegs = targetMesh === 'legs' || targetMesh === 'legs_material';

  if (isLegs) {
    materialOptions = allData.filter(d =>
      d.Grupa?.toLowerCase() === 'materiały_nóg' &&
      isAllowedForGroup(d.GrupaDocelowa) &&
      d.Visible?.toLowerCase() !== 'false'
    );

    if (selectedLeg && selectedLeg.Typ) {
      materialOptions = materialOptions.filter(mat =>
        !mat.Typ || mat.Typ.toLowerCase().trim() === selectedLeg.Typ.toLowerCase().trim()
      );
    }

    if (selectedLeg && selectedLeg.Nazwa) {
      const currentLegName = selectedLeg.Nazwa.toLowerCase().trim();
      materialOptions = materialOptions.filter(mat => {
        const allowedLegs = mat.DlaModeluNóg
          ? mat.DlaModeluNóg.split(',').map(s => s.trim().toLowerCase())
          : [];
        return allowedLegs.length === 0 || allowedLegs.includes(currentLegName);
      });
    }

    if (selectedChair && selectedChair.Nazwa) {
  const currentChairName = selectedChair.Nazwa.toLowerCase().trim();
  materialOptions = materialOptions.filter(mat => {
    // ⛔️ Jeśli pole DlaKrzesła jest puste → odrzucamy
    if (!mat.DlaKrzesła || mat.DlaKrzesła.trim().length === 0) return false;

    const allowedChairs = mat.DlaKrzesła
      .split(',')
      .map(s => s.trim().toLowerCase());

    return allowedChairs.includes(currentChairName);
  });
}



    const groupedByCollection = {};
    materialOptions.forEach(mat => {
      const key = mat.Kolekcja?.trim() || 'Inne';
      if (!groupedByCollection[key]) groupedByCollection[key] = [];
      groupedByCollection[key].push(mat);
    });

    renderCollectionsAndMaterials(groupedByCollection, 'legs');
    return;
  }

  // 🧵 TKANINY (siedzisko, oparcie itd.)
  materialOptions = allData.filter(d =>
    d.Grupa?.toLowerCase() === 'tkanina' &&
    d.TargetMeshOrModel &&
    d.TargetMeshOrModel.split(',').map(t => t.trim()).includes(targetMesh) &&
    isAllowedForGroup(d.GrupaDocelowa) &&
    d.Visible?.toLowerCase() !== 'false'
  );

  // Zastosuj filtr wyszukiwania do materiałów nóg
  if (currentSearchFilter && isLegs) {
    materialOptions = allData.filter(d =>
      d.Grupa?.toLowerCase() === 'materiały_nóg' &&
      isAllowedForGroup(d.GrupaDocelowa) &&
      d.Visible?.toLowerCase() !== 'false'
    ).filter(matchesSearchFilter);
    
    console.log(`🦵 Filtered leg materials to ${materialOptions.length} for filter: "${currentSearchFilter}"`);
    
    // Zastosuj pozostałe filtry nóg
    if (selectedLeg && selectedLeg.Typ) {
      materialOptions = materialOptions.filter(mat =>
        !mat.Typ || mat.Typ.toLowerCase().trim() === selectedLeg.Typ.toLowerCase().trim()
      );
    }

    if (selectedLeg && selectedLeg.Nazwa) {
      const currentLegName = selectedLeg.Nazwa.toLowerCase().trim();
      materialOptions = materialOptions.filter(mat => {
        const allowedLegs = mat.DlaModeluNóg
          ? mat.DlaModeluNóg.split(',').map(s => s.trim().toLowerCase())
          : [];
        return allowedLegs.length === 0 || allowedLegs.includes(currentLegName);
      });
    }

    if (selectedChair && selectedChair.Nazwa) {
      const currentChairName = selectedChair.Nazwa.toLowerCase().trim();
      materialOptions = materialOptions.filter(mat => {
        if (!mat.DlaKrzesła || mat.DlaKrzesła.trim().length === 0) return false;
        const allowedChairs = mat.DlaKrzesła.split(',').map(s => s.trim().toLowerCase());
        return allowedChairs.includes(currentChairName);
      });
    }

    const groupedByCollection = {};
    materialOptions.forEach(mat => {
      const key = mat.Kolekcja?.trim() || 'Inne';
      if (!groupedByCollection[key]) groupedByCollection[key] = [];
      groupedByCollection[key].push(mat);
    });

    renderCollectionsAndMaterials(groupedByCollection, 'legs');
    return;
  }

  // 🧵 TKANINY (siedzisko, oparcie itd.)
  materialOptions = allData.filter(d =>
    d.Grupa?.toLowerCase() === 'tkanina' &&
    d.TargetMeshOrModel &&
    d.TargetMeshOrModel.split(',').map(t => t.trim()).includes(targetMesh) &&
    isAllowedForGroup(d.GrupaDocelowa) &&
    d.Visible?.toLowerCase() !== 'false'
  );

  // Zastosuj filtr wyszukiwania jeśli jest aktywny
  if (currentSearchFilter) {
    materialOptions = materialOptions.filter(matchesSearchFilter);
    console.log(`🎨 Filtered materials from ${allData.length} to ${materialOptions.length} for filter: "${currentSearchFilter}"`);
  }

  const groupedByCollection = {};
  materialOptions.forEach(mat => {
    const key = mat.Kolekcja?.trim() || 'Inne';
    if (!groupedByCollection[key]) groupedByCollection[key] = [];
    groupedByCollection[key].push(mat);
  });

  renderCollectionsAndMaterials(groupedByCollection, targetMesh);
}

     




// ✅ Po wygenerowaniu — otwórz ostatnio klikniętą kolekcję
if (lastOpenedCollection) {
  const toOpen = container.querySelector(`details[data-kolekcja="${lastOpenedCollection}"]`);
  if (toOpen) toOpen.open = true;
}












      function activateLegsTabAndShowMaterials() {
        // Podświetl zakładkę "Nogi" po data-key
        const partTabs = document.querySelectorAll('#part-tabs .thumbnail');
        partTabs.forEach(tab => tab.classList.remove('selected'));
        partTabs.forEach(tab => {
          if (tab.dataset.key === 'legs') {
            tab.classList.add('selected');
          }
        });

        // Pokaż sekcję materiałów i wyświetl wszystkie materiały nóg
        document.getElementById('materials-section').style.display = 'block';
        renderFilteredMaterialOptions('legs');

      }

      function renderPartTabs() {
        const container = document.getElementById('part-tabs');
        container.innerHTML = '';
        // Pobierz unikalne elementy do wyboru
        const allTargets = allData.filter(d => d.TargetMeshOrModel)
          .flatMap(d => d.TargetMeshOrModel.split(',').map(t => t.trim()));
        const uniqueTargets = [...new Set(allTargets)];
        if (uniqueTargets.length === 0) {
          document.getElementById('parts-section').style.display = 'none';
          return;
        }
        document.getElementById('parts-section').style.display = 'block';

        // Mapowanie nazw technicznych na polskie
        const POLISH_LABELS = {
          seat: 'Siedzisko',
          backseat_inside: 'Oparcie wew.',
          backseat_outside: 'Oparcie zew.',
          backseat: 'Siedzisko/Oparcie',
          legs: 'Nogi'
        };

        renderOptions('part-tabs', uniqueTargets.map(name => {
          const key = name.trim().toLowerCase();
          return {
            Nazwa: POLISH_LABELS[key] || name.trim(),
            Obrazek: ELEMENT_ICONS[key] || 'icons/placeholder.svg',
            _technicalKey: key
          };
        }), (item) => {
          if (item._technicalKey === 'legs') {
            activateLegsTabAndShowMaterials();
          } else {
            // Podświetl klikniętą zakładkę
            const partTabs = document.querySelectorAll('#part-tabs .thumbnail');
            partTabs.forEach(tab => tab.classList.remove('selected'));
            partTabs.forEach(tab => {
              if (tab.title && tab.title.toLowerCase().includes(item.Nazwa.toLowerCase())) {
                tab.classList.add('selected');
              }
            });
            document.getElementById('materials-section').style.display = 'block';
            renderFilteredMaterialOptions(item._technicalKey);
          }
        });
      }

      function updateUI() {
        const backContainer = document.getElementById('back-to-models-container');
        backContainer.innerHTML = '';
        if (selectedChair && (selectedChair.Obrazek || selectedChair.Image)) {
          // Stwórz ramkę z ikonką i X
          const btn = document.createElement('div');
          btn.className = 'back-to-model-btn';
          btn.title = 'Wróć do wyboru modelu';
          
          // DODAJ KLASY PROMOCJI/BESTSELLERA do przycisku
          const hasPromotion = selectedChair.Promocja === 'TRUE' || selectedChair.Promocja === 'true' || 
                               selectedChair.Promocja === 'tak' || selectedChair.Promocja === '✔';
          const procent = hasPromotion ? parseFloat(selectedChair.Procent) || 0 : 0;
          const isBestseller = selectedChair.Bestseller === 'TRUE' || selectedChair.Bestseller === 'true' || 
                              selectedChair.Bestseller === 'tak' || selectedChair.Bestseller === '✔';
          
          if (hasPromotion && procent > 0) {
            btn.classList.add('promotion');
            btn.setAttribute('data-discount', `-${procent}%`);
          }
          if (isBestseller) {
            btn.classList.add('bestseller');
          }

          // Ikonka modelu
          const img = document.createElement('img');
          img.src = selectedChair.Obrazek || selectedChair.Image;
          img.alt = selectedChair.Nazwa;
          btn.appendChild(img);

          // Przycisk X w rogu
          const xBtn = document.createElement('button');
          xBtn.className = 'close-x';
          xBtn.innerHTML = '&times;';
          xBtn.title = 'Wróć do wyboru modelu';
          xBtn.onclick = (e) => {
            e.stopPropagation();
            showScreen('models');
          };
          btn.appendChild(xBtn);

          // Kliknięcie w całą ramkę też wraca do wyboru modelu
          btn.onclick = () => showScreen('models');

          backContainer.appendChild(btn);
          
          // DODAJ INFORMACJE O PROMOCJI/BESTSELLERZE
          const promoInfo = document.createElement('div');
          promoInfo.className = 'chair-promo-info';
          promoInfo.style.cssText = `
            margin-left: 12px;
            display: flex;
            flex-direction: column;
            gap: 6px;
            font-size: 14px;
          `;
          
          // Sprawdź promocję i bestseller (już zdefiniowane wyżej)
          
          if (hasPromotion && procent > 0) {
            const promoDiv = document.createElement('div');
            promoDiv.style.cssText = `
              display: flex;
              align-items: center;
              gap: 8px;
              color: #FF6B6B;
              font-weight: 600;
              margin-bottom: 2px;
            `;
            
            // Ikonka promocji identyczna jak w UI
            const promoIcon = document.createElement('div');
            promoIcon.style.cssText = `
              width: 20px;
              height: 20px;
              background: #FF6B6B;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-size: 14px;
              font-weight: bold;
              flex-shrink: 0;
              position: relative;
            `;
            
            // Dodaj symbol ognia CSS
            const fireSymbol = document.createElement('div');
            fireSymbol.style.cssText = `
              width: 8px;
              height: 12px;
              background: white;
              border-radius: 4px 4px 0 0;
              position: relative;
            `;
            fireSymbol.innerHTML = '';
            
            // Alternatywnie użyj prostego symbolu procenta
            promoIcon.innerHTML = '%';
            promoDiv.appendChild(promoIcon);
            
            const promoText = document.createElement('span');
            promoText.innerHTML = `Promocja -${procent}%`;
            promoDiv.appendChild(promoText);
            
            promoInfo.appendChild(promoDiv);
            
            // Dodaj info o wysyłce
            const shipInfo = document.createElement('div');
            shipInfo.style.cssText = `
              display: flex;
              align-items: center;
              gap: 8px;
              font-size: 12px;
              color: #28a745;
              font-weight: 500;
              margin-left: 28px;
            `;
            
            // Ikonka paczki
            const shipIcon = document.createElement('div');
            shipIcon.style.cssText = `
              width: 16px;
              height: 16px;
              background: #28a745;
              border-radius: 3px;
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-size: 10px;
              font-weight: bold;
              flex-shrink: 0;
            `;
            shipIcon.innerHTML = '□';
            shipInfo.appendChild(shipIcon);
            
            const shipText = document.createElement('span');
            shipText.innerHTML = 'Wysyłka 24h';
            shipInfo.appendChild(shipText);
            
            promoInfo.appendChild(shipInfo);
          }
          
          if (isBestseller) {
            const bestsellerDiv = document.createElement('div');
            bestsellerDiv.style.cssText = `
              display: flex;
              align-items: flex-start;
              gap: 8px;
              color: #FFD700;
              font-weight: 600;
              margin-top: ${hasPromotion ? '8px' : '0'};
            `;
            
            // Ikonka bestseller identyczna jak w UI (gwiazdka)
            const bestsellerIcon = document.createElement('div');
            bestsellerIcon.style.cssText = `
              width: 20px;
              height: 20px;
              background: #FFD700;
              border-radius: 50%;
              display: flex;
              align-items: center;
              justify-content: center;
              color: white;
              font-size: 12px;
              font-weight: bold;
              flex-shrink: 0;
              margin-top: 1px;
            `;
            bestsellerIcon.innerHTML = '★';
            bestsellerDiv.appendChild(bestsellerIcon);
            
            const bestsellerTextDiv = document.createElement('div');
            bestsellerTextDiv.style.cssText = `
              display: flex;
              flex-direction: column;
              gap: 2px;
            `;
            
            const bestsellerTitle = document.createElement('div');
            bestsellerTitle.style.cssText = `
              font-weight: 600;
              color: #FFD700;
            `;
            bestsellerTitle.innerHTML = 'Bestseller';
            bestsellerTextDiv.appendChild(bestsellerTitle);
            
            const bestsellerDesc = document.createElement('div');
            bestsellerDesc.style.cssText = `
              font-size: 11px;
              color: #666;
              font-weight: 400;
              line-height: 1.3;
            `;
            bestsellerDesc.innerHTML = 'Najczęściej wybierany model wśród klientów';
            bestsellerTextDiv.appendChild(bestsellerDesc);
            
            bestsellerDiv.appendChild(bestsellerTextDiv);
            promoInfo.appendChild(bestsellerDiv);
          }
          
          // Dodaj kontener z informacjami do back-container
          if (hasPromotion || isBestseller) {
            const wrapperDiv = document.createElement('div');
            wrapperDiv.style.cssText = `
              display: flex;
              align-items: center;
              gap: 12px;
              margin-bottom: 15px;
            `;
            wrapperDiv.appendChild(btn);
            wrapperDiv.appendChild(promoInfo);
            backContainer.appendChild(wrapperDiv);
          } else {
            backContainer.appendChild(btn);
          }
        }

        const legs = allData.filter(d => {
  if (d.Grupa.toLowerCase() !== 'nogi') return false;
  
  // Filtrowanie kategorii
  const nogaKategoria = (d.Kategoria || d.Typ || d.Grupa || '').toLowerCase();
  const chairKategoria = (selectedChair?.Kategoria || '').toLowerCase();
  
  // Jeśli krzesło to 'hookery', pokazuj tylko nogi 'hooker'
  if (chairKategoria.includes('hooker')) {
    if (!nogaKategoria.includes('hooker')) return false;
  }
  // Jeśli krzesło to 'krzesła', pokazuj tylko nogi 'krzesła' (i uniwersalne)
  else if (chairKategoria.includes('krzes')) {
    if (nogaKategoria.includes('hooker')) return false;
    if (!(nogaKategoria.includes('krzes') || nogaKategoria === '' || nogaKategoria === 'nogi')) return false;
  }
  
  // Sprawdzenie zgodności kubełka
  if (!selectedChair || selectedChair.Grupa.toLowerCase() !== 'kubełek') return true;
  return czyNogaPasujeDoKubełka(d, selectedChair.Nazwa);
});


        renderOptions('legs-thumbnails', legs, item => {
  setLegModel(item);
});



        // Sekcja nóg i materiały nóg – nogi tylko dla kubełków, materiały dla kubełków i krzeseł
    if (selectedChair && selectedChair.Grupa) {    
          const grupa = selectedChair.Grupa.toLowerCase();

          if (grupa === 'kubełek') {
            console.log("Pokazuję nogi i materiały nóg dla kubełka");
            document.getElementById('legs-section').style.display = 'block';
            

            // Ustaw pierwszą nogę jeśli jeszcze żadna nie została wybrana
if (!selectedLeg && legs.length > 0) {
  const defaultLeg = selectDefaultLeg(legs, selectedChair.Kategoria);
  setLegModel(defaultLeg);
}

renderOptions('legs-thumbnails', legs, item => {
              setLegModel(item);
            });

            // Ukryj sekcję materiałów, pokaże się po kliknięciu w zakładkę
            document.getElementById('materials-section').style.display = 'none';
          } else if (grupa === 'krzesło') {
            console.log("Ukrywam sekcję nóg dla krzesła");
            document.getElementById('legs-section').style.display = 'none';

            // Ukryj sekcję materiałów, pokaże się po kliknięciu w zakładkę
            document.getElementById('materials-section').style.display = 'none';
          } else {
            console.log("Ukrywam sekcje nóg i materiałów");
            document.getElementById('legs-section').style.display = 'none';
            document.getElementById('materials-section').style.display = 'none';
          }
        } else {
          console.log("Brak wybranego elementu lub grupy");
          document.getElementById('legs-section').style.display = 'none';
          document.getElementById('materials-section').style.display = 'none';
        }

        updateSummary();
      }

      const visibleData = allData.filter(d =>
        d.Visible?.toString().trim().length > 0
      );


      // Flaga zapobiegająca wielokrotnemu ładowaniu danych
      let isDataLoaded = false;

      async function loadDataFromSheet() {
        if (isDataLoaded) {
          console.log('� Data already loaded, skipping...');
          return;
        }
        
        console.log('�📡 Loading data from Google Sheets...');
        isDataLoaded = true;
        
        // TYMCZASOWO WYŁĄCZONE: Sprawdź najpierw dane lokalne z panelu admina
        // const localChairs = localStorage.getItem('chairsData');
        // const localMaterials = localStorage.getItem('materialsData');
        
        // BEZPOŚREDNIO ŁADUJ Z ARKUSZA
        console.log('🔄 Loading directly from Google Sheets...');
        
        // Wyczyść localStorage z danych admina (tymczasowo)
        localStorage.removeItem('chairsData');
        localStorage.removeItem('materialsData');
        console.log('🗑️ Cleared local admin data');
        
        // Ładuj bezpośrednio z Google Sheets
        const sheetId = '1lZMJ-4Qd0nDY-7Hl9iV-pJnZSTVzYiA-A3rDq_bC16U';
        const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Baza Danych&v=${new Date().getTime()}`;
        
        try {
          const response = await fetch(sheetURL + '?nocache=' + Date.now(), { 
            cache: 'no-store'
          });
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const csvText = await response.text();
          console.log('✅ CSV data loaded, parsing...');
          
          const rows = csvText.trim().split('\n');
          const headerRow = rows.shift();
          const rawHeaders = headerRow.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
          const cleanHeaders = rawHeaders.map(h => h.trim().replace(/"/g, ''));
          
          // Oczyść nagłówki - usuń wartości z nagłówków (np. "Kategoria krzesła" -> "Kategoria")
          const headers = cleanHeaders.map(header => {
            const cleanHeader = header.split(' ')[0]; // Weź tylko pierwszą część przed spacją
            return cleanHeader;
          });
          
          console.log('🔍 RAW HEADERS:', cleanHeaders);
          console.log('🔍 CLEAN HEADERS:', headers);
          
          allData = rows.map(row => {
            const values = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
            const obj = {};
            headers.forEach((header, index) => obj[header] = values[index]?.trim().replace(/"/g, '') || '');
            return obj;
          }).filter(item => item.Visible?.toLowerCase() !== 'false');

          console.log('🎯 Data parsed successfully, items:', allData.length);
          console.log('🔍 CSV HEADERS:', headers);
          console.log('🔍 FIRST ITEM FIELDS:', allData[0] ? Object.keys(allData[0]) : 'No items');
          console.log('🔍 FIRST ITEM DATA:', allData[0]);

          // Eksportuj dane dla PWA
          window.allData = allData;
          console.log('✅ allData exported to window for PWA');

          // Renderuj UI
          // 📱 Warunkowo: Desktop LUB Mobile UI (nie oba!)
          console.log('🔍 Window width:', window.innerWidth, 'Is mobile:', window.innerWidth <= 820);
          if (window.innerWidth > 820) {
            // Desktop UI
            console.log('🖥️ Desktop UI initialization');
            renderCategoryButtons();
            renderPromotions();
          } else {
            // Mobile UI
            console.log('📱 Mobile UI initialization');
            createMobileCategories();
          }
          
          showScreen('models');

          const hdrEntries = allData.filter(d => d.HDR && d.HDRIcon);
          renderHDROptions(hdrEntries);

          // Ukryj loader
          const customLoader = document.getElementById('custom-loader');
          const appElement = document.getElementById('app');
          
          if (customLoader) {
            customLoader.classList.add('fade-out');
            setTimeout(() => {
              customLoader.style.display = 'none';
              if (appElement) {
                appElement.style.visibility = 'visible';
              }
            }, 500);
          }

          // Pokaż toolbar
          const toolbar = document.getElementById('bottom-toolbar');
          if (toolbar) {
            toolbar.style.display = 'flex';
            toolbar.classList.add('visible');
          }
          
          console.log('🚀 App initialization complete');

        } catch (e) { 
          console.error("❌ Error loading data:", e);
          
          // Ukryj loader przy błędzie
          const errorLoader = document.getElementById('custom-loader');
          if (errorLoader) {
            errorLoader.style.display = 'none';
            const errorApp = document.getElementById('app');
            if (errorApp) {
              errorApp.style.visibility = 'visible';
            }
          }
          
          // Pokaż podstawowy komunikat błędu
          alert('Błąd ładowania danych. Spróbuj odświeżyć stronę.');
        }
      }
        
        try {
          console.log('Loading data from Google Sheets...');
          
          // Definicje brakujących zmiennych
          const sheetId = '1lZMJ-4Qd0nDY-7Hl9iV-pJnZSTVzYiA-A3rDq_bC16U';
          const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Baza Danych&v=${new Date().getTime()}`;
          
          // Enhanced mobile detection
          const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                           (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1); // iPad detection
          
          // Timeout for mobile devices
          const timeoutDuration = isMobile ? 15000 : 10000;
          const timeoutPromise = new Promise((_, reject) => {
            const loaderTimeout = setTimeout(() => reject(new Error(`Timeout loading data (${timeoutDuration/1000}s)`)), timeoutDuration);
            // Store timeout reference for cleanup
            window.loaderTimeout = loaderTimeout;
          });
          
          console.log('Making fetch request...');
          
          const fetchPromise = fetch(sheetURL + '?nocache=' + Date.now(), { 
            cache: 'no-store',
            headers: {
              'Accept': 'text/plain,text/csv,application/csv',
              'User-Agent': navigator.userAgent
            }
          });
          
          console.log('Waiting for response...');
          const response = await Promise.race([fetchPromise, timeoutPromise]);
          console.log('Response received, status:', response.status);
          
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}, statusText: ${response.statusText}`);
          }

          console.log('Reading response text...');
          const csvText = await response.text();
          console.log('CSV data loaded successfully, length:', csvText.length);
          
          const rows = csvText.trim().split('\n');
          console.log('CSV rows found:', rows.length);
          
          if (rows.length === 0) {
            throw new Error('CSV file appears to be empty');
          }
          
          const headers = rows.shift().split(',').map(h => h.trim().replace(/"/g, ''));
          console.log('CSV headers parsed:', headers.length);
          allData = rows.map(row => {
            const values = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
            const obj = {};
            headers.forEach((header, index) => obj[header] = values[index]?.trim().replace(/"/g, '') || '');
            return obj;
          }).filter(item => item.Visible?.toLowerCase() !== 'false');

          console.log('Data parsed successfully, items:', allData.length);
          console.log('Sample data item:', allData[0]);
          
          // Eksportuj dane dla PWA
          window.allData = allData;
          console.log('✅ allData exported to window for PWA (second loading)');
          
          if (allData.length === 0) {
            throw new Error('No visible items found in data');
          }

          console.log('Data parsed, items:', allData.length);
          
          if (allData.length === 0) {
            console.error('No data loaded - forcing timeout');
            throw new Error('No data available');
          }

          // Wyczyść timeout loader jeśli dane się załadowały
          if (window.loaderTimeout) {
            clearTimeout(window.loaderTimeout);
            window.loaderTimeout = null;
          }
          console.log('Starting UI initialization...');

          // 📱 Warunkowo: Desktop LUB Mobile UI (nie oba!)
          console.log('🔍 Second check - Window width:', window.innerWidth, 'Is mobile:', window.innerWidth <= 820);
          if (window.innerWidth > 820) {
            // Desktop UI
            console.log('🖥️ Desktop UI second initialization');
            console.log('About to render category buttons...');
            renderCategoryButtons();
            console.log('Category buttons rendered');
            
            // Renderuj promocje na starcie
            console.log('About to render promotions...');
            renderPromotions();
            console.log('Promotions rendered');
          } else {
            // Mobile UI
            console.log('📱 Mobile UI second initialization');
            console.log('About to create mobile categories...');
            createMobileCategories();
            console.log('Mobile categories created');
          }
          
          console.log('About to show models screen...');
          showScreen('models');
          console.log('Models screen shown');

          const hdrEntries = allData.filter(d => d.HDR && d.HDRIcon);
          renderHDROptions(hdrEntries);
          console.log('HDR options rendered, entries:', hdrEntries.length);

          // Ukryj loader
          const customLoader = document.getElementById('custom-loader');
          const appElement = document.getElementById('app');
          
          if (customLoader) {
            customLoader.classList.add('fade-out');
            setTimeout(() => {
              customLoader.style.display = 'none';
              console.log('Loader hidden');
              
              if (appElement) {
                appElement.style.visibility = 'visible';
                console.log('App shown');
              }
            }, 500);
          }

          // Pokaż toolbar
          const toolbar = document.getElementById('bottom-toolbar');
          if (toolbar) {
            toolbar.style.display = 'flex';
            toolbar.classList.add('visible');
            console.log('Toolbar shown');
          }
          
          console.log('App initialization complete');


        } catch (e) { 
          console.error("=== ERROR IN LOAD DATA FROM SHEET ===");
          console.error("Error type:", e.constructor.name);
          console.error("Error message:", e.message);
          console.error("Full error:", e);
          console.error("Stack trace:", e.stack);
          
          // Wyczyść timeout loader
          if (window.loaderTimeout) {
            clearTimeout(window.loaderTimeout);
            window.loaderTimeout = null;
          }
          console.log('Timeout cleared after error');
          
          // Ukryj loader nawet przy błędzie
          const errorLoader = document.getElementById('custom-loader');
          if (errorLoader) {
            errorLoader.classList.add('fade-out');
            setTimeout(() => {
              errorLoader.style.display = 'none';
              const errorApp = document.getElementById('app');
              if (errorApp) {
                errorApp.style.visibility = 'visible';
              }
              console.log('Loader hidden after error');
            }, 500);
          }
          
          // Pokaż komunikat błędu
          document.body.innerHTML = `
            <div style="text-align: center; padding: 50px; font-family: Arial, sans-serif;">
              <h2>Przerwa techniczna</h2>
              <p>Wracamy wkrótce.</p>
              <button onclick="window.location.reload()" style="padding: 10px 20px; margin-top: 20px;">
                Spróbuj ponownie
              </button>
            </div>
          `;
        }

setDefaultMaterialsFromSheet();
updateSummary();




      function updateSummary() {
        const overviewPanel = document.getElementById('config-overview');
        const overviewIconsDiv = document.getElementById("overview-icons");
        const overviewDetailsDiv = document.getElementById("overview-details");
        const overviewTotalPriceSpan = document.getElementById("overview-total-price");

        // Sprawdź czy elementy istnieją
        if (!overviewIconsDiv || !overviewDetailsDiv || !overviewTotalPriceSpan) {
          console.warn('updateSummary: Required elements not found');
          return;
        }

        overviewIconsDiv.innerHTML = '';
        overviewDetailsDiv.innerHTML = '';
        overviewTotalPriceSpan.textContent = `0.00 PLN`;

        // Jeśli nie było interakcji, nie pokazuj szczegółów
        if (!userInteracted) {
          overviewPanel.style.display = 'block';
          return;
        }

        // Kolejność elementów do podsumowania
        const partOrder = ['seat', 'backseat_inside', 'backseat_outside', 'legs_material', 'backseat'];
        const partLabels = ['Siedzisko', 'Oparcie wew.', 'Oparcie zew.', 'Nogi', 'Siedzisko/Oparcie'];

        // Ikonka modelu
        if (userInteracted && selectedChair && (selectedChair.Obrazek || selectedChair.Image)) {
          const icon = document.createElement('img');
          icon.src = selectedChair.Obrazek || selectedChair.Image;
          icon.title = selectedChair.Nazwa;
          icon.className = 'model-image'; // <-- dodaj tę klasę!
          overviewIconsDiv.appendChild(icon);
        }
        

        // Ikonki materiałów dla każdego elementu
        partOrder.forEach((partKey, idx) => {
          const mats = selectedMaterials[partKey];
if (Array.isArray(mats)) {
  mats.forEach(mat => {
    if (mat && (mat.Obrazek || mat.Image)) {
      const icon = document.createElement('img');
      icon.src = mat.Obrazek || mat.Image;
      icon.title = mat.Nazwa;
      overviewIconsDiv.appendChild(icon);
    }
  });
} else if (mats && (mats.Obrazek || mats.Image)) {
  // Obsługa starego trybu (pojedynczy materiał)
  const icon = document.createElement('img');
  icon.src = mats.Obrazek || mats.Image;
  icon.title = mats.Nazwa;
  overviewIconsDiv.appendChild(icon);
}

        });

        // Ikonka wybranego wariantu nóg (jeśli jest)
        if (selectedLeg && (selectedLeg.Obrazek || selectedLeg.Image)) {
          const icon = document.createElement('img');
          icon.src = selectedLeg.Obrazek || selectedLeg.Image;
          icon.title = selectedLeg.Nazwa;
          overviewIconsDiv.appendChild(icon);
        }

        // Szczegóły i ceny
        let totalPrice = 0;
        if (selectedChair && selectedChair.Cena) {
          const price = parseFloat(selectedChair.Cena) || 0;
          totalPrice += price;
          const detailLine = document.createElement('div');
          detailLine.className = 'detail-item';
          const label = (selectedChair.Grupa && selectedChair.Grupa.toLowerCase() === 'krzesło') ? 'Krzesło' : 'Model';
          detailLine.innerHTML = `<span>${label}: ${selectedChair.Nazwa}</span><strong>: ${price.toFixed(2)} PLN</strong>`;
          overviewDetailsDiv.appendChild(detailLine);
        }
        partOrder.forEach((partKey, idx) => {
          const mat = selectedMaterials[partKey];
          if (mat) {
            const price = parseFloat(mat.Cena) || 0;
            totalPrice += price;
            const detailLine = document.createElement('div');
            detailLine.className = 'detail-item';
            detailLine.innerHTML = `<span>${partLabels[idx]}: ${mat.Nazwa}</span><strong>: ${price.toFixed(2)} PLN</strong>`;
            overviewDetailsDiv.appendChild(detailLine);
          }
        });
        // Dodano szczegóły wariantu nóg
        if (selectedLeg) {
          const price = parseFloat(selectedLeg.Cena) || 0;
          const detailLine = document.createElement('div');
          detailLine.className = 'detail-item';
          detailLine.innerHTML = `<span>Wariant nóg: ${selectedLeg.Nazwa}</span><strong>: ${price.toFixed(2)} PLN</strong>`;
          overviewDetailsDiv.appendChild(detailLine);
        }
        if (selectedLeg) {
          const price = parseFloat(selectedLeg.Cena) || 0;
          totalPrice += price;
        }

        const hr = document.createElement('hr');
        overviewDetailsDiv.appendChild(hr);

        overviewTotalPriceSpan.textContent = `${totalPrice.toFixed(2)} PLN`;

        window.selectedChair = selectedChair;
        window.selectedLeg = selectedLeg;
        window.selectedMaterials = selectedMaterials;

      }
     


      function enforceZoomLimits() {
        if (window.viewer && window.viewer.controls) {
          window.viewer.controls.minDistance = MIN_ZOOM_DISTANCE;
          window.viewer.controls.maxDistance = MAX_ZOOM_DISTANCE;
          window.viewer.controls.enableDamping = true;
          window.viewer.controls.dampingFactor = 0.1;
          window.viewer.controls.update();
        }
      }

      function clampCameraDistance() {
        if (!window.viewer || !window.viewer.scene || !window.viewer.scene.mainCamera || !window.viewer.controls) return;
        const camera = window.viewer.scene.mainCamera;
        const target = window.viewer.controls.target;
        const pos = camera.position;
        const dist = pos.distanceTo(target);

        if (dist < MIN_ZOOM_DISTANCE) {
          // Przesuń kamerę na sferę o promieniu MIN_ZOOM_DISTANCE od targetu
          const dir = pos.clone().sub(target).normalize();
          camera.position.copy(target.clone().add(dir.multiplyScalar(MIN_ZOOM_DISTANCE)));
          camera.updateProjectionMatrix();
          window.viewer.controls.update();
        }
        if (dist > MAX_ZOOM_DISTANCE) {
          // Przesuń kamerę na sferę o promieniu MAX_ZOOM_DISTANCE od targetu
          const dir = pos.clone().sub(target).normalize();
          camera.position.copy(target.clone().add(dir.multiplyScalar(MAX_ZOOM_DISTANCE)));
          camera.updateProjectionMatrix();
          window.viewer.controls.update();
        }
      }


      // Nowa funkcja do ograniczeń zoomu w obrębie bańki
      function forceBubbleZoomLimitsEachFrame() {
        if (!window.viewer || !window.viewer.scene || !window.viewer.scene.mainCamera) return;
        const camera = window.viewer.scene.mainCamera;
        // Środek bańki – możesz zmienić na inny punkt jeśli trzeba
        const bubbleCenter = new Vector3(0, 0, 0);
        const pos = camera.position;
        const dist = pos.distanceTo(bubbleCenter);

        if (dist < MIN_ZOOM_DISTANCE) {
          const dir = pos.clone().sub(bubbleCenter).normalize();
          camera.position.copy(bubbleCenter.clone().add(dir.multiplyScalar(MIN_ZOOM_DISTANCE)));
          camera.updateProjectionMatrix();
          if (window.viewer.controls) window.viewer.controls.update();
        }
        if (dist > MAX_ZOOM_DISTANCE) {
          const dir = pos.clone().sub(bubbleCenter).normalize();
          camera.position.copy(bubbleCenter.clone().add(dir.multiplyScalar(MAX_ZOOM_DISTANCE)));
          camera.updateProjectionMatrix();
          if (window.viewer.controls) window.viewer.controls.update();
        }
      }

      // Uruchom sprawdzanie w każdej klatce
      function animateBubbleZoomLimit() {
        forceBubbleZoomLimitsEachFrame();
        requestAnimationFrame(animateBubbleZoomLimit);
      }
      animateBubbleZoomLimit();









      const exportButton = document.getElementById("export-config");
      const exportPanel = document.getElementById("export-panel");

      exportButton.addEventListener("click", () => {
        exportPanel.classList.toggle("hidden");
      });

      // Opcjonalnie – ukrywanie po kliknięciu poza panelem
      document.addEventListener("click", (e) => {
        if (!exportPanel.contains(e.target) && !exportButton.contains(e.target)) {
          exportPanel.classList.add("hidden");
        }
      });

      // Obsługa kliknięć eksportu (przykładowo)
      document.querySelectorAll(".export-btn").forEach(btn => {
        btn.addEventListener("click", () => {
          const format = btn.dataset.format;
          alert(`Eksport jako: ${format.toUpperCase()}`);
          exportPanel.classList.add("hidden");
        });
      });




      // — Obsługa dolnego paska narzędziowego HDR

      function renderHDROptions(entries) {
        const container = document.getElementById('hdr-options');
        if (!container) return;
        container.innerHTML = '';

        entries.forEach(entry => {
          const img = document.createElement('img');
          img.src = entry.HDRIcon;
          img.alt = entry.Nazwa || entry.HDR;
          img.onerror = () => {
            img.src = 'icons/placeholder.svg';
          };

          const thumb = document.createElement('div');
          thumb.className = 'thumbnail';


          thumb.title = entry.Nazwa || entry.HDR;
          thumb.appendChild(img);
          thumb.onclick = () => {
            viewer.setEnvironmentMap(entry.HDR, { isHDR: true });
            document.getElementById('hdr-panel')?.classList.add('hidden');
          };

          const caption = document.createElement('div');
          caption.className = 'thumbnail-caption';
          caption.textContent = entry.Nazwa || entry.HDR;

          const wrapper = document.createElement('div');
          wrapper.className = 'thumbnail-wrapper';
          wrapper.appendChild(thumb);
          //wrapper.appendChild(caption);

          container.appendChild(wrapper);
        });
      }



      // Sterowanie widocznością panelu

      // Sterowanie widocznością panelu
      window.addEventListener('DOMContentLoaded', () => {
        const hdrToggle = document.getElementById('hdr-toggle');
        const hdrPanel = document.getElementById('hdr-panel');
        const hdrClose = document.getElementById('hdr-close');

        function toggleHDRPanel() {
          hdrPanel.classList.toggle('hidden');
          hdrPanel.style.display = hdrPanel.classList.contains('hidden') ? 'none' : 'block';
        }

        hdrToggle?.addEventListener('click', (e) => {
          e.stopPropagation();
          toggleHDRPanel();
        });

        hdrPanel?.addEventListener('click', (e) => {
          e.stopPropagation();
        });

        document.addEventListener('click', () => {
          hdrPanel?.classList.add('hidden');
          if (hdrPanel) hdrPanel.style.display = 'none';
        });

        hdrClose?.addEventListener('click', (e) => {
          e.stopPropagation();
          hdrPanel?.classList.add('hidden');
          if (hdrPanel) hdrPanel.style.display = 'none';
        });
      });

      // Modyfikacja istniejącego kodu obsługi przycisku HDR
      document.getElementById('hdr-toggle')?.addEventListener('click', (e) => {
        e.stopPropagation();
        const panel = document.getElementById('hdr-panel');
        panel.classList.toggle('hidden');
        panel.style.display = panel.classList.contains('hidden') ? 'none' : 'block';
      });

















      // Panel wymiarów
      document.getElementById('dimensions-show')?.addEventListener('click', (e) => {
        e.stopPropagation();
        console.log("📐 Kliknięto przycisk wymiarów");
        showDimensions();
      });

      window.addEventListener('load', () => {
        const showQRBtn = document.getElementById('qr-button');

        if (!showQRBtn) return;

        // Pokaż przycisk po załadowaniu strony i UI
        showQRBtn.style.display = 'flex';

        // Podłącz event do wyświetlenia kodu QR
        showQRBtn.addEventListener('click', () => {
          const qrPopup = document.getElementById('qr-popup');
          const qrContainer = document.getElementById('qrcode');
          if (!qrPopup || !qrContainer) return;

          qrPopup.style.display = 'block';
          qrContainer.innerHTML = '';

          new QRCode(qrContainer, {
            text: window.location.href,
            width: 200,
            height: 200,
          });
        });
      });

      function showConfigOverview() {
        const overviewPanel = document.getElementById('config-overview');
        overviewPanel.classList.remove('hidden');
      }

      // Wywołaj tę funkcję w odpowiednim momencie, np. po załadowaniu modelu


      document.addEventListener('click', () => {
        const hdrPanel = document.getElementById('hdr-panel');
        if (hdrPanel) {
          hdrPanel.classList.add('hidden');
        }
      });



      function showDimensions() {
        const dimensionOverlay = document.getElementById('dimension-overlay');
        dimensionOverlay.style.display = 'block';
        dimensionOverlay.innerHTML = ''; // Wyczyść poprzednie wymiary

        if (!selectedChair) return;

        // Parsowanie wymiarów z kolumny Wymiary
        const dimensionsString = selectedChair.Wymiary || '';
        const dimensionsParsed = {};
        dimensionsString.split(',').forEach(dim => {
          const [key, value] = dim.split('=').map(s => s.trim());
          if (key && value) {
            dimensionsParsed[key.toLowerCase()] = parseFloat(value);
          }
        });

        const dimensions = [
          { label: 'Szerokość', value: dimensionsParsed.x },
          { label: 'Głębokość', value: dimensionsParsed.y },
          { label: 'Wysokość', value: dimensionsParsed.z }
        ];

        const panel = document.createElement('div');
        panel.className = 'dimension-panel';
        panel.style.cssText = `
  position: fixed;
  top: 85%;
  transform: translate(-150%, -50%);
  left: 50%;
  background-color: rgba(255, 255, 255, 0.8);
  padding: 10px;
  border-radius: 5px;
  font-size: 14px;
  font-weight: bold;
  z-index: 1001;
`;


        dimensions.forEach(dim => {
          if (dim.value !== undefined) {
            const dimElement = document.createElement('div');
            dimElement.textContent = `${dim.label}: ${dim.value} cm`;
            dimElement.style.marginBottom = '5px';
            panel.appendChild(dimElement);
          }
        });

        dimensionOverlay.appendChild(panel);
      }

      function hideDimensions() {
        const dimensionOverlay = document.getElementById('dimension-overlay');
        dimensionOverlay.style.display = 'none';
      }

      // Funkcja powrotu do kategorii
      function returnToCategories() {
        console.log("🔙 Returning to categories...");
        
        // Ukryj bottom toolbar
        const toolbar = document.getElementById('bottom-toolbar');
        toolbar.classList.remove('visible');
        toolbar.style.display = 'none';
        
        // Ukryj panel konfiguracji
        const configOverview = document.getElementById('config-overview');
        if (configOverview) {
          configOverview.style.display = 'none';
          configOverview.classList.add('hidden');
        }
        
        // Ukryj sekcje materiałów i nóg
        document.getElementById('materials-section').style.display = 'none';
        document.getElementById('legs-section').style.display = 'none';
        
        // Pokaż welcome screen z kategoriami
        const welcomeScreen = document.getElementById('welcome-screen');
        if (welcomeScreen) {
          welcomeScreen.style.display = 'flex';
        }
        
        // Usuń aktualny model ze sceny
        if (currentModelContainer) {
          window.viewer.scene.remove(currentModelContainer);
          if (typeof currentModelContainer.dispose === 'function') currentModelContainer.dispose();
        }
        if (currentLegModel) {
          window.viewer.scene.remove(currentLegModel);
          if (typeof currentLegModel.dispose === 'function') currentLegModel.dispose();
        }
        
        // Reset zmiennych
        currentModelContainer = null;
        currentLegModel = null;
        selectedLeg = null;
        selectedMaterials = {};
        selectedChair = null;
        
        // Odśwież kategorie
        renderCategoryButtons();
      }



      // 📦 Ładowanie JSZip
      async function loadJSZip() {
        if (!window.JSZip) {
          await import('https://cdn.jsdelivr.net/npm/jszip@3.10.0/dist/jszip.min.js');
        }
      }

      // 📁 Załaduj listę plików tekstur z files.json
      let texturesFilesByFolder = {};
      async function loadTexturesFilesList() {
        try {
          const res = await fetch('textures/files.json');
          texturesFilesByFolder = await res.json();
        } catch (e) {
          console.error('Błąd ładowania files.json:', e);
          texturesFilesByFolder = {};
        }
      }

      // 📐 Obsługiwane formaty eksportu
      const modelFormats = ['fbx', 'obj', 'dae'];

      // 🗜️ Główna funkcja eksportu ZIP
      async function handleExport(format) {
        if (!window.JSZip) {
          alert('JSZip niezaładowany!');
          return;
        }

        if (!modelFormats.includes(format)) {
          alert(`Nieobsługiwany format eksportu: ${format}`);
          return;
        }

        const zip = new JSZip();

        // 🪑 Eksport głównego modelu krzesła
        const chairModel = window.selectedChair?.Nazwa || 'BrakModelu';
        const chairPath = `export/${chairModel}.${format}`;

        try {
          const res = await fetch(chairPath);
          if (!res.ok) throw new Error(`Nie znaleziono modelu krzesła: ${chairPath}`);
          const blob = await res.blob();
          zip.file(`${chairModel}.${format}`, blob);
        } catch (e) {
          alert(e.message);
          return;
        }

        // 🦵 Eksport nóg (jeśli wybrano)
        const legModel = window.selectedLeg?.Nazwa;
        if (legModel) {
          const legPath = `export/${legModel}.${format}`;
          try {
            const res = await fetch(legPath);
            if (res.ok) {
              const blob = await res.blob();
              zip.file(`${legModel}.${format}`, blob);
            } else {
              console.warn(`Nie znaleziono modelu nóg: ${legPath}`);
            }
          } catch (e) {
            console.warn(`Błąd pobierania nóg: ${e.message}`);
          }
        }

        // 🎨 Eksport materiałów / tekstur z kolekcją i bez
        const textureFolderInZip = zip.folder('textures');
        const materials = Object.values(window.selectedMaterials || {});
        const collection = window.selectedChair?.Kolekcja?.trim() || '';

        for (const mat of materials) {
          const folder = mat.Folder || mat.Wartość;
          const textureFiles = texturesFilesByFolder[folder] || [];

          for (const texFile of textureFiles) {
            const candidatePaths = [
              collection ? `textures/${collection}/${folder}/${texFile}` : null,
              `textures/${folder}/${texFile}`
            ].filter(Boolean);

            let found = false;

            for (const path of candidatePaths) {
              try {
                const res = await fetch(path);
                if (res.ok) {
                  const blob = await res.blob();
                  textureFolderInZip.file(`${folder}/${texFile}`, blob);
                  found = true;
                  break;
                }
              } catch (e) {
                console.warn(`❌ Błąd pobierania: ${path}`, e);
              }
            }

            if (!found) {
              console.warn(`⚠️ Nie znaleziono tekstury: ${folder}/${texFile}`);
            }
          }
        }

        // 📦 Finalny zapis ZIP
        const blob = await zip.generateAsync({ type: 'blob' });
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = `export_${chairModel}_${format}.zip`;
        document.body.appendChild(a);
        a.click();
        a.remove();
        URL.revokeObjectURL(a.href);
      }

      // 🚀 Inicjalizacja tekstur na starcie
      await loadTexturesFilesList();

      // 🖱️ Obsługa kliknięcia eksportu
      document.querySelectorAll('.export-btn').forEach(button => {
        button.addEventListener('click', async () => {
          await loadJSZip();
          const format = button.getAttribute('data-format');
          await handleExport(format);
        });
      });



      function updateMaterialTiles() {
        const legsMaterialsContainer = document.getElementById('legs-thumbnails');
        if (!legsMaterialsContainer || !selectedChair || !selectedLeg) return;

        // 🧼 Czyść tylko kafelki materiałów nóg
        legsMaterialsContainer.querySelectorAll('.material-tile')?.forEach(tile => tile.remove());

        const allEntries = allData;

        const chairType = selectedChair.Grupa?.trim().toLowerCase();       // 'krzesło' lub 'kubełek'
        const legVariant = selectedLeg.Nazwa?.trim().toLowerCase();       // np. 'regularne'

        const filteredMaterials = allEntries.filter(mat => {
          // ✅ tylko materiały nóg
          if (mat.Grupa?.trim().toLowerCase() !== 'materiały_nóg') return false;

          // ✅ czy materiał pasuje do typu krzesła (GrupaDocelowa)
          const grupaDocelowa = mat.GrupaDocelowa?.toLowerCase() || '';
          const grupy = grupaDocelowa.split(',').map(g => g.trim());
          if (!grupy.includes(chairType)) return false;

          // ✅ jeśli krzesło → ignorujemy DlaModeluNóg
          if (chairType === 'krzesło') return true;

          // ✅ jeśli kubełek → DlaModeluNóg musi zawierać aktualny wariant nóg
          const dlaModelu = mat.DlaModeluNóg?.toLowerCase().trim();
          if (!dlaModelu || dlaModelu.length === 0) return false;

          const allowedVariants = dlaModelu.split(',').map(v => v.trim());
          return allowedVariants.includes(legVariant);
        });

        filteredMaterials.forEach(mat => {
          const tile = document.createElement('div');
          tile.className = 'material-tile';
          tile.textContent = mat.Nazwa;
          tile.style.backgroundImage = `url(${mat.Obrazek || 'fallback.png'})`;
          tile.onclick = () => applyLegMaterial(mat);
          legsMaterialsContainer.appendChild(tile);
        });

        console.log(`✅ Pokazano ${filteredMaterials.length} materiałów nóg dla '${chairType}', wariant nóg '${selectedLeg.Nazwa}'`);
      }





      //UKRYWANIE PRZYCISKÓW ELEMENTÓW KRZESŁA

      // kolejność części i ich powiązane nazwy meshów/obiektów
      const partOrder = ['seat', 'backseat_inside', 'backseat_outside', 'backseat', 'legs_material'];

      // funkcja tworząca i wyświetlająca przyciski części krzesła na podstawie danych wybranego krzesła
      function renderPartButtons() {
        const partTabs = document.getElementById('part-tabs');
        partTabs.innerHTML = ''; // czyścimy zawartość

        if (!selectedChair) {
          console.warn('renderPartButtons: brak wybranego krzesła');
          return;
        }

        const availableElementsRaw = selectedChair['DostępneElementy'] || '';
        if (!availableElementsRaw.trim()) {
          console.log('renderPartButtons: brak dostępnych elementów — nie pokazuję nic.');
          return;
        }

        const availableParts = availableElementsRaw
          .split(',')
          .map(el => el.trim().toLowerCase())
          .filter(Boolean);

        const partNames = {
          seat: 'Siedzisko',
          backseat_inside: 'Oparcie wew.',
          backseat_outside: 'Oparcie zew.',
          backseat: 'Siedzisko/Oparcie',

          legs: 'Nogi'
        };

        Object.keys(ELEMENT_ICONS).forEach(part => {
          if (availableParts.includes(part)) {

            const wrapper = document.createElement('div');
            wrapper.className = 'thumbnail-wrapper';

            const thumb = document.createElement('div');
            thumb.className = 'thumbnail';
            thumb.title = part;
            thumb.dataset.key = part; // ✅ TO jest potrzebne dla dalszego UI

            thumb.onclick = () => {
              document.querySelectorAll('#part-tabs .thumbnail').forEach(tab => tab.classList.remove('selected'));
              thumb.classList.add('selected');
              document.getElementById('materials-section').style.display = 'block';

              // Pokazuje odpowiednie materiały do klikniętej części
              renderFilteredMaterialOptions(part);
            };

            const img = document.createElement('img');
            img.src = ELEMENT_ICONS[part];
            img.alt = part;

            thumb.appendChild(img);
            wrapper.appendChild(thumb);

            const caption = document.createElement('div');
            caption.className = 'thumbnail-caption';
            caption.textContent = partNames[part] || part;
            wrapper.appendChild(caption);

            partTabs.appendChild(wrapper);
          }
        });
      }




      // Przykładowo: gdy zmieniasz krzesło, wywołujesz:
      renderPartButtons();




      const arButton = document.getElementById('ar-button');
      if (arButton) {
        arButton.addEventListener('click', () => {
          const popup = document.getElementById('ar-popup');
          if (popup) popup.style.display = 'block';
        });
      }


function renderCollectionsAndMaterials(groupedByCollection, targetMesh) {
  // ⏱️ Zapisz dane materiałów dla danego elementu
  materialsByMeshAndCollection[targetMesh] = groupedByCollection;

  const iconPanel = document.getElementById('collection-icons');
  const materialPanel = document.getElementById('material-panel-viewer');
  if (!iconPanel || !materialPanel) return;

  iconPanel.innerHTML = '';
  materialPanel.innerHTML = '';

  Object.entries(groupedByCollection).forEach(([kolekcja, materiały]) => {
    const icon = document.createElement('img');

    // 🎯 Ikony specjalne dla 'legs' i 'backseat'
    let iconFileName = kolekcja.trim().toLowerCase().replace(/\s+/g, '_');

const basePath = `icons/${iconFileName}.png`;

fetch(basePath, { method: 'HEAD' })
  .then(res => {
    icon.src = res.ok ? basePath : 'icons/default.png';
  })
  .catch(() => {
    icon.src = 'icons/default.png';
  });




    icon.alt = kolekcja;
    icon.className = 'collection-icon';

    icon.onclick = () => {
      const isActive = activeCollectionsByMesh[targetMesh] === kolekcja;
      iconPanel.querySelectorAll('.collection-icon').forEach(i => i.classList.remove('selected'));

      if (isActive) {
        activeCollectionsByMesh[targetMesh] = null;
        materialPanel.innerHTML = '';
        return;
      }

      activeCollectionsByMesh[targetMesh] = kolekcja;
      icon.classList.add('selected');
      materialPanel.innerHTML = '';
      renderMaterialsInPanel(materiały, targetMesh);
    };

    iconPanel.appendChild(icon);
  });

  // ✅ Automatyczne otwarcie zapamiętanej kolekcji
  const rememberedCollection = activeCollectionsByMesh[targetMesh];
  const rememberedGroup = materialsByMeshAndCollection[targetMesh] || {};
  const rememberedMaterials = rememberedGroup[rememberedCollection];

  if (rememberedCollection && rememberedMaterials?.length) {
    const rememberedIcon = [...iconPanel.querySelectorAll('.collection-icon')].find(
      i => i.alt === rememberedCollection
    );
    if (rememberedIcon) {
      rememberedIcon.classList.add('selected');
      renderMaterialsInPanel(rememberedMaterials, targetMesh);
    }
  }
}









function renderMaterialsInPanel(materiały, targetMesh) {
  const viewer = document.getElementById('material-panel-viewer');
  if (!viewer) return;
  viewer.innerHTML = '';

  materiały.forEach(mat => {
    const wrapper = document.createElement('div');
    wrapper.className = 'thumbnail-wrapper';

    const button = document.createElement('div');
    button.className = 'thumbnail';
    button.title = mat.Nazwa;

    const img = document.createElement('img');
    img.src = mat.Obrazek || 'icons/placeholder.svg';
    img.alt = mat.Nazwa;
    button.appendChild(img);

    const caption = document.createElement('div');
    caption.className = 'thumbnail-caption';
    caption.textContent = mat.Nazwa;

    wrapper.appendChild(button);
    wrapper.appendChild(caption);
    viewer.appendChild(wrapper);

    button.onclick = () => {
      applyMaterialToSpecificMesh(mat, targetMesh);
      viewer.querySelectorAll('.thumbnail').forEach(t => t.classList.remove('selected'));
      button.classList.add('selected');
    };
  });
}



 window.addEventListener('orientationchange', () => {
    const rotateMsg = document.getElementById('rotate-message');
    if (!rotateMsg) return;

    // ✅ Jeśli poziomo — chowaj komunikat
    if (window.innerWidth > window.innerHeight) {
      rotateMsg.style.display = 'none';
    } else {
      rotateMsg.style.display = 'flex';
    }
  });

  // ✅ Dodatkowy test przy starcie — gdy strona ładuje się w pionie
  window.addEventListener('load', () => {
    const rotateMsg = document.getElementById('rotate-message');
    if (!rotateMsg) return;

    if (window.innerWidth > window.innerHeight) {
      rotateMsg.style.display = 'none';
    } else {
      rotateMsg.style.display = 'flex';
    }
  });


function updateRotateMessage() {
  const rotateMsg = document.getElementById('rotate-message');
  if (!rotateMsg) return;

  const isLandscape = window.innerWidth > window.innerHeight;
  rotateMsg.style.display = isLandscape ? 'none' : 'flex';
}

window.addEventListener('orientationchange', updateRotateMessage);
window.addEventListener('resize', updateRotateMessage);
window.addEventListener('load', updateRotateMessage);


window.addEventListener('DOMContentLoaded', () => {
  // przygotowanie canvas i kontenerów
  
});


function setDefaultMaterialsFromSheet() {
  if (!Array.isArray(allData) || !window.selectedChair || !selectedChair.Nazwa) return;

  const modelName = selectedChair.Nazwa.trim().toLowerCase();
  if (typeof window.selectedMaterials !== 'object') window.selectedMaterials = {};

  allData.forEach(row => {
    const modelMatch = row.Default?.trim().toLowerCase();
    const targetRaw = row.TargetMeshOrObiect?.trim().toLowerCase();
    const name = row.Nazwa?.trim();
    const price = parseFloat(row.Cena) || 0;
    const image = row.Obrazek || row.Image || '';

    if (!modelMatch || modelMatch !== modelName || !name || !targetRaw) return;

    if (!selectedMaterials[targetRaw]) selectedMaterials[targetRaw] = [];

    selectedMaterials[targetRaw].push({
      Nazwa: name,
      Cena: price,
      Obrazek: image
    });
  });
}










      // USUNIĘTE PODWÓJNE WYWOŁANIE - init() już wywołuje się w DOMContentLoaded na górze
      // Tylko dla fallback jeśli DOM już załadowany
      if (document.readyState !== 'loading') {
        init().catch(error => {
          console.error('Error in init():', error);
          // Ukryj loader w przypadku błędu w init()
          const loaderElement = document.getElementById('custom-loader');
          if (loaderElement) {
            loaderElement.style.display = 'none';
          }
          const appElement = document.getElementById('app');
          if (appElement) {
            appElement.style.visibility = 'visible';
          }
        });
      }

      // Funkcja do ustawiania filtra wyszukiwania
      function setSearchFilter(query) {
        currentSearchFilter = query.toLowerCase().trim();
        console.log('🔍 Search filter set to:', currentSearchFilter);
        
        // Aktualizuj wskaźnik filtra
        const indicator = document.getElementById('search-filter-indicator');
        const filterText = document.getElementById('search-filter-text');
        const clearButton = document.getElementById('clear-search-filter');
        
        if (currentSearchFilter) {
          filterText.textContent = `"${query}"`;
          indicator.style.display = 'block';
        } else {
          indicator.style.display = 'none';
        }
        
        // Obsługa przycisku czyszczenia filtra
        if (clearButton && !clearButton.hasAttribute('data-listener')) {
          clearButton.addEventListener('click', () => {
            setSearchFilter('');
            // Wyczyść także pole wyszukiwania jeśli jest otwarte
            const searchInput = document.getElementById('search-input');
            if (searchInput) searchInput.value = '';
            const searchResults = document.getElementById('search-results');
            if (searchResults) searchResults.innerHTML = '';
          });
          clearButton.setAttribute('data-listener', 'true');
        }
        
        // Odśwież wszystkie sekcje kafelków
        refreshAllTiles();
      }

      // Funkcja sprawdzająca czy element pasuje do filtra
      function matchesSearchFilter(item) {
        if (!currentSearchFilter) return true;
        
        const searchableFields = [
          item.Nazwa,
          item.Grupa,
          item.Kategoria,
          item.Kolekcja,
          item.Typ,
          item.Opis
        ];
        
        // Jeśli filtr zawiera spacje, traktuj jako listę nazw do wyszukania
        if (currentSearchFilter.includes(' ')) {
          const searchTerms = currentSearchFilter.split(' ').filter(term => term.trim().length > 0);
          return searchTerms.some(term => 
            searchableFields.some(field => 
              field && field.toLowerCase().includes(term.toLowerCase())
            )
          );
        } else {
          // Pojedynczy termin wyszukiwania
          return searchableFields.some(field => 
            field && field.toLowerCase().includes(currentSearchFilter)
          );
        }
      }

      // Funkcja licząca relevance dla elementu względem filtra
      function getRelevance(item, filter) {
        if (!filter) return 0;
        let relevance = 0;
        const searchTerm = filter.toLowerCase().trim();
        const searchableFields = [
          { field: item.Nazwa, weight: 10 },
          { field: item.Grupa, weight: 8 },
          { field: item.Kategoria, weight: 8 },
          { field: item.Kolekcja, weight: 6 },
          { field: item.Typ, weight: 4 },
          { field: item.Opis, weight: 2 }
        ];
        searchableFields.forEach(({ field, weight }) => {
          if (field && field.toLowerCase().includes(searchTerm)) {
            relevance += weight;
            if (field.toLowerCase().startsWith(searchTerm)) {
              relevance += weight;
            }
          }
        });
        return relevance;
      }

      // Funkcja renderująca przyciski kategorii
      function renderCategoryButtons(retryCount = 0) {
        const maxRetries = 10;
        console.log(`🎯 renderCategoryButtons called (attempt ${retryCount + 1}/${maxRetries}), allData:`, allData?.length);
        
        // 🔍 DEBUGGING: Sprawdź przykładowe dane krzeseł
        if (allData && allData.length > 0) {
          console.log('🔍 DEBUGGING: Pierwszych 5 krzeseł:', allData.slice(0, 5).map(item => ({
            nazwa: item.Nazwa,
            typ: item.Typ,
            promocja: item.Promocja,
            promocjaRaw: `"${item.Promocja}"`,
            promocjaType: typeof item.Promocja,
            bestseller: item.Bestseller,
            bestsellerRaw: `"${item.Bestseller}"`,
            bestsellerType: typeof item.Bestseller,
            procent: item.Procent
          })));
        }
        
        // Sprawdź czy DOM jest gotowy
        if (document.readyState === 'loading') {
          console.log('🎯 DOM not ready yet, waiting...');
          document.addEventListener('DOMContentLoaded', () => {
            setTimeout(() => renderCategoryButtons(retryCount), 100);
          });
          return;
        }
        
        if (!allData || !Array.isArray(allData)) {
          console.error('❌ allData is not available or not an array');
          return;
        }
        
        // Dodatkowy debug
        console.log('🎯 Looking for category-buttons-container...');
        const sidebar = document.getElementById('sidebar');
        console.log('🎯 sidebar element:', sidebar ? 'FOUND' : 'NOT FOUND');
        if (sidebar) {
          console.log('🎯 sidebar display:', window.getComputedStyle(sidebar).display);
          console.log('🎯 sidebar visibility:', window.getComputedStyle(sidebar).visibility);
        }
        
        const container = document.getElementById('category-buttons-container');
        console.log('🎯 category-buttons-container:', container ? 'FOUND' : 'NOT FOUND');
        
        if (!container) {
          // Spróbuj ręcznie stworzyć kontener jeśli nie istnieje
          if (sidebar) {
            console.log('🎯 Trying to create missing category container...');
            
            // Znajdź lub stwórz sekcję kategorii
            let categorySection = sidebar.querySelector('#category-buttons');
            if (!categorySection) {
              categorySection = document.createElement('div');
              categorySection.id = 'category-buttons';
              categorySection.style.cssText = 'margin-bottom: 20px;';
              
              const title = document.createElement('h3');
              title.style.cssText = 'margin-bottom: 10px; font-size: 16px; color: #555;';
              title.textContent = 'Kategorie:';
              categorySection.appendChild(title);
              
              const buttonsContainer = document.createElement('div');
              buttonsContainer.id = 'category-buttons-container';
              buttonsContainer.style.cssText = 'display: flex; flex-wrap: wrap; gap: 8px;';
              categorySection.appendChild(buttonsContainer);
              
              // Dodaj przed search container
              const searchContainer = sidebar.querySelector('#search-container');
              if (searchContainer) {
                sidebar.insertBefore(categorySection, searchContainer.nextSibling);
              } else {
                sidebar.appendChild(categorySection);
              }
              
              console.log('🎯 Created missing category section');
            }
            
            // Spróbuj ponownie pobrać kontener
            const newContainer = document.getElementById('category-buttons-container');
            if (newContainer) {
              console.log('🎯 Successfully created category-buttons-container');
              // Kontynuuj z renderowaniem
              renderCategoriesContent(newContainer);
              return;
            }
          }
          
          if (retryCount < maxRetries) {
            console.error(`❌ category-buttons-container not found, retrying in 500ms... (${retryCount + 1}/${maxRetries})`);
            setTimeout(() => renderCategoryButtons(retryCount + 1), 500);
          } else {
            console.error('❌ category-buttons-container not found after maximum retries, giving up');
          }
          return;
        }
        
        renderCategoriesContent(container);
      }
      
      // Wydzielona funkcja renderowania zawartości kategorii
      function renderCategoriesContent(container) {
        container.innerHTML = '';
        
        // Znajdź kontener na specjalne kategorie
        const specialContainer = document.getElementById('special-categories-container');
        if (specialContainer) {
          specialContainer.innerHTML = '';
        }
        
        // Znajdź wszystkie unikalne kategorie
        console.log('🔍 DEBUG - Sample allData items:');
        console.log('First 3 items:', allData.slice(0, 3));
        console.log('All item.Kategoria values:', allData.map(item => item.Kategoria));
        console.log('All item.Typ values:', allData.map(item => item.Typ));
        
        const categories = [...new Set(allData
          .filter(item => item.Kategoria && item.Typ === 'model')
          .map(item => item.Kategoria)
        )];
        
        console.log('Found categories:', categories);
        console.log('Filtered items for categories:', allData.filter(item => item.Kategoria && item.Typ === 'model').length);
        
        // ===== SPECJALNE KATEGORIE W PIERWSZEJ LINII =====
        if (specialContainer) {
          // Dodaj przycisk "Wszystkie"
          const allButton = document.createElement('button');
          allButton.className = 'category-button active special-category';
          allButton.textContent = 'Wszystkie';
          allButton.style.cssText = 'padding: 8px 16px; border: 2px solid #F5C842; background: #F5C842; color: #333; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; text-transform: capitalize;';
          allButton.onclick = () => {
            // Reset wyszukiwania przy kliknięciu w kategorię
            if (currentSearchFilter) {
              console.log('🔄 Resetowanie wyszukiwania przy przełączeniu na kategorię "Wszystkie"');
              setSearchFilter('');
              const searchInput = document.getElementById('search-input');
              if (searchInput) searchInput.value = '';
            }
            
            document.querySelectorAll('.category-button').forEach(btn => {
              btn.classList.remove('active');
              btn.style.background = 'white';
              btn.style.color = btn.classList.contains('promotion') ? '#FF6B6B' : '#333';
            });
            allButton.classList.add('active');
            allButton.style.background = '#F5C842';
            allButton.style.color = '#333';
            renderAllModels();
          };
          specialContainer.appendChild(allButton);
          console.log('Added "Wszystkie" button to special container');
          
          // 🔍 DEBUGGING: Sprawdź wszystkie krzesła z modelami
          const allModels = allData.filter(item => item.Typ === 'model');
          console.log('🔍 DEBUGGING: Wszystkie modele krzeseł:', allModels.length);
          console.log('🔍 DEBUGGING: Modele z promocją/bestsellerem:', allModels.map(item => ({
            nazwa: item.Nazwa,
            promocja: item.Promocja,
            promocjaType: typeof item.Promocja,
            bestseller: item.Bestseller,
            bestsellerType: typeof item.Bestseller,
            procent: item.Procent,
            procentType: typeof item.Procent
          })));
          
          // Sprawdź czy są krzesła na promocji
          const promotionalModels = allData.filter(item => 
            item.Typ === 'model' && 
            (item.Promocja === 'TRUE' || item.Promocja === 'true' || item.Promocja === 'tak' || item.Promocja === '✔') && 
            item.Procent && 
            parseFloat(item.Procent) > 0
          );
          
          console.log('🔥 DEBUGGING: Znalezione krzesła na promocji:', promotionalModels.length);
          console.log('🔥 DEBUGGING: Lista promocji:', promotionalModels.map(item => ({ 
            nazwa: item.Nazwa, 
            promocja: item.Promocja, 
            procent: item.Procent 
          })));
          
          // Jeśli są krzesła na promocji, dodaj przycisk "Promocje"
          if (promotionalModels.length > 0) {
            const promoButton = document.createElement('button');
            promoButton.className = 'category-button promotion special-category';
            promoButton.textContent = '🔥 Promocje';
            promoButton.style.cssText = 'padding: 8px 16px; border: 2px solid #FF6B6B; background: white; color: #FF6B6B; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; text-transform: capitalize;';
            promoButton.onclick = () => {
              // Reset wyszukiwania przy kliknięciu w kategorię
              if (currentSearchFilter) {
                console.log('🔄 Resetowanie wyszukiwania przy przełączeniu na kategorię "Promocje"');
                setSearchFilter('');
                const searchInput = document.getElementById('search-input');
                if (searchInput) searchInput.value = '';
              }
              
              document.querySelectorAll('.category-button').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'white';
                btn.style.color = btn.classList.contains('promotion') ? '#FF6B6B' : '#333';
              });
              promoButton.classList.add('active');
              promoButton.style.background = '#FF6B6B';
              promoButton.style.color = 'white';
              renderPromotionalModels();
            };
            
            // Hover efekty dla promocji
            promoButton.onmouseenter = () => {
              if (!promoButton.classList.contains('active')) {
                promoButton.style.background = '#FF6B6B';
                promoButton.style.color = 'white';
                promoButton.style.transform = 'translateY(-1px)';
              }
            };
            
            promoButton.onmouseleave = () => {
              if (!promoButton.classList.contains('active')) {
                promoButton.style.background = 'white';
                promoButton.style.color = '#FF6B6B';
                promoButton.style.transform = 'translateY(0)';
              }
            };
            
            specialContainer.appendChild(promoButton);
            console.log('Added "Promocje" button with', promotionalModels.length, 'items');
          }
          
          // Sprawdź czy są bestsellery
          const bestsellerModels = allData.filter(item => 
            item.Typ === 'model' && 
            (item.Bestseller === 'TRUE' || item.Bestseller === 'true' || item.Bestseller === 'tak' || item.Bestseller === '✔')
          );
          
          console.log('⭐ DEBUGGING: Znalezione bestsellery:', bestsellerModels.length);
          console.log('⭐ DEBUGGING: Lista bestsellerów:', bestsellerModels.map(item => ({ 
            nazwa: item.Nazwa, 
            bestseller: item.Bestseller 
          })));
          
          // Jeśli są bestsellery, dodaj przycisk "Bestsellery"
          if (bestsellerModels.length > 0) {
            const bestsellerButton = document.createElement('button');
            bestsellerButton.className = 'category-button bestseller special-category';
            bestsellerButton.textContent = '⭐ Bestsellery';
            bestsellerButton.style.cssText = 'padding: 8px 16px; border: 2px solid #f5c842; background: white; color: #333; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; text-transform: capitalize;';
            bestsellerButton.onclick = () => {
              // Reset wyszukiwania przy kliknięciu w kategorię
              if (currentSearchFilter) {
                console.log('🔄 Resetowanie wyszukiwania przy przełączeniu na kategorię "Bestsellery"');
                setSearchFilter('');
                const searchInput = document.getElementById('search-input');
                if (searchInput) searchInput.value = '';
              }
              
              document.querySelectorAll('.category-button').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'white';
                btn.style.color = btn.classList.contains('promotion') ? '#FF6B6B' : '#333';
              });
              bestsellerButton.classList.add('active');
              bestsellerButton.style.background = '#f5c842';
              bestsellerButton.style.color = '#333';
              renderBestsellerModels();
            };
            
            // Hover efekty dla bestsellerów
            bestsellerButton.onmouseenter = () => {
              if (!bestsellerButton.classList.contains('active')) {
                bestsellerButton.style.background = '#f5c842';
                bestsellerButton.style.color = '#333';
                bestsellerButton.style.transform = 'translateY(-1px)';
              }
            };
            
            bestsellerButton.onmouseleave = () => {
              if (!bestsellerButton.classList.contains('active')) {
                bestsellerButton.style.background = 'white';
                bestsellerButton.style.color = '#333';
                bestsellerButton.style.transform = 'translateY(0)';
              }
            };
            
            specialContainer.appendChild(bestsellerButton);
            console.log('Added "Bestsellery" button with', bestsellerModels.length, 'items');
          }
        }
        
        // ===== GŁÓWNE KATEGORIE W DRUGIEJ LINII =====
        // Dodaj przyciski dla każdej kategorii
        categories.forEach(category => {
          const button = document.createElement('button');
          button.className = 'category-button';
          button.textContent = category;
          
          // Ustaw style dla kategorii (zawsze złote, niezależnie od promocji)
          button.style.cssText = 'padding: 8px 16px; border: 2px solid #F5C842; background: white; color: #333; border-radius: 20px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease; text-transform: capitalize;';
          
          // Sprawdź czy kategoria ma promocje - ale nie zmieniaj stylu przycisków kategorii
          const hasPromotion = allData.some(item => 
            item.Kategoria === category && 
            item.Typ === 'model' && 
            item.Promocja && 
            item.Promocja.trim() !== ''
          );
          
          // USUNIĘTO: kategorie zawsze są żółte, niezależnie od promocji
          // if (hasPromotion) {
          //   button.classList.add('promotion');
          //   button.style.borderColor = '#FF6B6B';
          //   button.style.color = '#FF6B6B';
          // }
          
          button.onclick = () => {
            // Reset filtra wyszukiwania jeśli jest aktywny
            if (currentSearchFilter) {
              setSearchFilter('');
              const searchInput = document.getElementById('search-input');
              if (searchInput) {
                searchInput.value = '';
              }
            }
            
            document.querySelectorAll('.category-button').forEach(btn => {
              btn.classList.remove('active');
              btn.style.background = 'white';
              btn.style.color = btn.classList.contains('promotion') ? '#FF6B6B' : '#333';
            });
            button.classList.add('active');
            // Zawsze żółte po kliknięciu (kategorie nie są czerwone)
            button.style.background = '#F5C842';
            button.style.color = '#333';
            renderModelsByCategory(category);
          };
          
          // Dodaj hover efekty - zawsze żółte
          button.onmouseenter = () => {
            if (!button.classList.contains('active')) {
              button.style.background = '#F5C842';
              button.style.color = '#333';
              button.style.transform = 'translateY(-1px)';
            }
          };
          
          button.onmouseleave = () => {
            if (!button.classList.contains('active')) {
              button.style.background = 'white';
              button.style.color = '#333';
              button.style.transform = 'translateY(0)';
            }
          };
          
          container.appendChild(button);
        });
      }

      // Funkcja renderująca wszystkie modele
      function renderAllModels() {
        const models = allData.filter(item => 
          item.Typ && item.Typ.toLowerCase() === 'model'
        );
        console.log('📦 Rendering all models:', models.length, 'items');
        
        // Pokaż sekcję modeli
        document.getElementById('model-section').style.display = 'block';
        document.getElementById('config-section').style.display = 'none';
        
        // Wyczyść filtr wyszukiwania jeśli jest aktywny
        const searchFilterIndicator = document.getElementById('search-filter-indicator');
        if (searchFilterIndicator) {
          searchFilterIndicator.style.display = 'none';
        }
        
        renderOptions('model-thumbnails', models, item => loadModel(item));
      }

      // Funkcja renderująca modele promocyjne
      function renderPromotionalModels() {
        console.log('🔍 Checking promotional models...');
        console.log('AllData length:', allData?.length);
        
        if (!allData || allData.length === 0) {
          console.error('❌ No allData available for promotions');
          return;
        }
        
        // Pokaż sekcję modeli
        document.getElementById('model-section').style.display = 'block';
        document.getElementById('config-section').style.display = 'none';
        
        // Wyczyść filtr wyszukiwania jeśli jest aktywny
        const searchFilterIndicator = document.getElementById('search-filter-indicator');
        if (searchFilterIndicator) {
          searchFilterIndicator.style.display = 'none';
        }
        
        const promotionalModels = allData.filter(item => {
          const isModel = item.Typ === 'model';
          // Obsługa checkbox z Google Sheets: TRUE, true, tak, ✔
          const hasPromotion = item.Promocja === 'TRUE' || item.Promocja === 'true' || item.Promocja === 'tak' || item.Promocja === '✔';
          const hasPercent = item.Procent && parseFloat(item.Procent) > 0;
          
          console.log(`Item: ${item.Nazwa}, Typ: ${item.Typ}, Promocja: "${item.Promocja}", Procent: ${item.Procent}, isModel: ${isModel}, hasPromotion: ${hasPromotion}, hasPercent: ${hasPercent}`);
          
          return isModel && hasPromotion && hasPercent;
        });
        
        console.log('🔥 Rendering promotional models:', promotionalModels.length, 'items');
        console.log('Promotional models:', promotionalModels);
        
        if (promotionalModels.length === 0) {
          document.getElementById('model-thumbnails').innerHTML = '<div style="text-align: center; padding: 40px; color: #666; font-style: italic;">Brak produktów na promocji.<br><br>Aby dodać promocję, przejdź do panelu administracyjnego i ustaw "Promocja: tak" oraz procent obniżki przy wybranych krzesłach.</div>';
        } else {
          renderOptions('model-thumbnails', promotionalModels, item => loadModel(item));
        }
      }

      // Funkcja renderująca modele bestsellery
      function renderBestsellerModels() {
        console.log('🔍 Checking bestseller models...');
        console.log('AllData length:', allData?.length);
        
        if (!allData || allData.length === 0) {
          console.error('❌ No allData available for bestsellers');
          return;
        }
        
        // Pokaż sekcję modeli
        document.getElementById('model-section').style.display = 'block';
        document.getElementById('config-section').style.display = 'none';
        
        // Wyczyść filtr wyszukiwania jeśli jest aktywny
        const searchFilterIndicator = document.getElementById('search-filter-indicator');
        if (searchFilterIndicator) {
          searchFilterIndicator.style.display = 'none';
        }
        
        const bestsellerModels = allData.filter(item => {
          const isModel = item.Typ === 'model';
          // Obsługa checkbox z Google Sheets: TRUE, true, tak, ✔
          const isBestseller = item.Bestseller === 'TRUE' || item.Bestseller === 'true' || item.Bestseller === 'tak' || item.Bestseller === '✔';
          
          console.log(`Item: ${item.Nazwa}, Typ: ${item.Typ}, Bestseller: "${item.Bestseller}", isModel: ${isModel}, isBestseller: ${isBestseller}`);
          
          return isModel && isBestseller;
        });
        
        console.log('⭐ Rendering bestseller models:', bestsellerModels.length, 'items');
        console.log('Bestseller models:', bestsellerModels);
        
        if (bestsellerModels.length === 0) {
          document.getElementById('model-thumbnails').innerHTML = '<div style="text-align: center; padding: 40px; color: #666; font-style: italic;">Brak bestsellerów w bazie danych.<br><br>Aby dodać bestseller, przejdź do panelu administracyjnego i zaznacz checkboxy "Bestseller" przy wybranych krzesłach.</div>';
        } else {
          renderOptions('model-thumbnails', bestsellerModels, item => loadModel(item));
        }
      }

      // Funkcja renderująca modele według kategorii
      function renderModelsByCategory(category) {
        const models = allData.filter(item => 
          item.Typ && item.Typ.toLowerCase() === 'model' &&
          item.Kategoria === category
        );
        console.log(`📦 Rendering models for category "${category}":`, models.length, 'items');
        
        // Pokaż sekcję modeli
        document.getElementById('model-section').style.display = 'block';
        document.getElementById('config-section').style.display = 'none';
        
        // Wyczyść filtr wyszukiwania jeśli jest aktywny
        const searchFilterIndicator = document.getElementById('search-filter-indicator');
        if (searchFilterIndicator) {
          searchFilterIndicator.style.display = 'none';
        }
        
        renderOptions('model-thumbnails', models, item => loadModel(item));
      }

      // Funkcja renderująca promocje na starcie
      function renderPromotions() {
        const promotionalModels = allData.filter(item => 
          item.Typ && item.Typ.toLowerCase() === 'model' &&
          (item.Promocja === 'TRUE' || item.Promocja === 'true' || item.Promocja === 'tak' || item.Promocja === '✔') &&
          item.Procent && parseFloat(item.Procent) > 0
        );
        
        console.log('🎉 Promotional models found:', promotionalModels.length);
        
        if (promotionalModels.length > 0) {
          // Pokaż sekcję modeli
          document.getElementById('model-section').style.display = 'block';
          document.getElementById('config-section').style.display = 'none';
          
          renderOptions('model-thumbnails', promotionalModels, item => loadModel(item));
          
          // Aktywuj przycisk "Promocje" zamiast "Wszystkie" 
          setTimeout(() => {
            const promoButton = document.querySelector('.category-button.promotion');
            if (promoButton) {
              document.querySelectorAll('.category-button').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'white';
                btn.style.color = btn.classList.contains('promotion') ? '#FF6B6B' : '#333';
              });
              promoButton.classList.add('active');
              promoButton.style.background = '#FF6B6B';
              promoButton.style.color = 'white';
            }
          }, 100);
        } else {
          console.log('🎉 No promotional models, showing all models instead');
          renderAllModels();
        }
      }

      // Funkcja renderująca kategorie i krzesła w PWA Success Screen - UŻYWA MOBILNYCH FUNKCJI
      function renderPWACategoryButtons() {
        console.log('📱 renderPWACategoryButtons called - używa mobilnych funkcji, allData:', allData?.length);
        
        // Czekaj na załadowanie danych jeśli jeszcze nie są dostępne
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('⏳ allData not ready yet, waiting...');
          
          // Sprawdzaj co 100ms czy dane są dostępne, max 10 sekund
          let attempts = 0;
          const maxAttempts = 100; // 10 sekund
          
          const waitForData = setInterval(() => {
            attempts++;
            console.log(`⏳ Waiting for data, attempt ${attempts}/${maxAttempts}`);
            
            if (allData && Array.isArray(allData) && allData.length > 0) {
              console.log('✅ Data ready, calling renderPWACategoryButtons again');
              clearInterval(waitForData);
              renderPWACategoryButtons();
              return;
            }
            
            if (attempts >= maxAttempts) {
              console.error('❌ Timeout waiting for allData in PWA');
              clearInterval(waitForData);
              return;
            }
          }, 100);
          
          return;
        }
        
        // WYWOŁAJ MOBILNE FUNKCJE RENDEROWANIA
        console.log('📱 PWA: Rendering mobile categories and models...');
        renderMobileCategories();
        renderMobileModels(); // Pokaż wszystkie modele na początku
      }

      // 📱 DEDYKOWANE FUNKCJE MOBILNE DLA PWA SUCCESS SCREEN
      
      // Funkcja renderująca kategorie w mobilnej sekcji PWA
      function renderMobileCategories() {
        console.log('📱 renderMobileCategories called, allData:', allData?.length);
        
        const container = document.getElementById('mobile-category-buttons-container');
        if (!container) {
          console.error('❌ mobile-category-buttons-container not found');
          return;
        }
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('⏳ allData not ready for mobile categories');
          return;
        }
        
        container.innerHTML = '';
        
        // Znajdź wszystkie unikalne kategorie
        const categories = [...new Set(allData
          .filter(item => item.Kategoria && item.Typ === 'model')
          .map(item => item.Kategoria)
        )];
        
        console.log('📱 Found mobile categories:', categories);
        
        // ==== SPECJALNE KATEGORIE W PIERWSZEJ LINII (mobile) ====
        // Dodaj przycisk "Wszystkie"
        const allButton = document.createElement('button');
        allButton.className = 'category-button active mobile-special';
        allButton.textContent = 'Wszystkie';
        allButton.style.cssText = 'margin: 5px; padding: 8px 15px; border: 2px solid #F5C842; background: #F5C842; color: #333; border-radius: 8px; font-weight: bold; cursor: pointer;';
        allButton.onclick = () => {
          document.querySelectorAll('#mobile-category-buttons-container .category-button').forEach(btn => {
            btn.classList.remove('active');
            btn.style.background = '#fff';
            btn.style.color = '#333';
          });
          allButton.classList.add('active');
          allButton.style.background = '#F5C842';
          allButton.style.color = '#333';
          renderMobileModels();
        };
        container.appendChild(allButton);
        
        // Sprawdź czy są krzesła na promocji
        const promotionalModels = allData.filter(item => 
          item.Typ === 'model' && 
          item.Promocja === 'tak' && 
          item.Procent && 
          parseFloat(item.Procent) > 0
        );
        
        // Jeśli są krzesła na promocji, dodaj przycisk "Promocje" 
        if (promotionalModels.length > 0) {
          const promoButton = document.createElement('button');
          promoButton.className = 'category-button mobile-special';
          promoButton.textContent = '🔥 Promocje';
          promoButton.style.cssText = 'margin: 5px; padding: 8px 15px; border: 2px solid #FF6B6B; background: #fff; color: #FF6B6B; border-radius: 8px; font-weight: bold; cursor: pointer;';
          promoButton.onclick = () => {
            document.querySelectorAll('#mobile-category-buttons-container .category-button').forEach(btn => {
              btn.classList.remove('active');
              btn.style.background = '#fff';
              btn.style.color = btn.textContent.includes('Promocje') ? '#FF6B6B' : btn.textContent.includes('Bestsellery') ? '#f5c842' : '#333';
            });
            promoButton.classList.add('active');
            promoButton.style.background = '#FF6B6B';
            promoButton.style.color = '#fff';
            renderMobilePromotionalModels();
          };
          container.appendChild(promoButton);
          console.log('📱 Added mobile "Promocje" button with', promotionalModels.length, 'items');
        }
        
        // Sprawdź czy są bestsellery
        const bestsellerModels = allData.filter(item => 
          item.Typ === 'model' && 
          (item.Bestseller === 'tak' || item.Bestseller === 'true')
        );
        
        // Jeśli są bestsellery, dodaj przycisk "Bestsellery"
        if (bestsellerModels.length > 0) {
          const bestsellerButton = document.createElement('button');
          bestsellerButton.className = 'category-button mobile-special';
          bestsellerButton.textContent = '⭐ Bestsellery';
          bestsellerButton.style.cssText = 'margin: 5px; padding: 8px 15px; border: 2px solid #f5c842; background: #fff; color: #333; border-radius: 8px; font-weight: bold; cursor: pointer;';
          bestsellerButton.onclick = () => {
            document.querySelectorAll('#mobile-category-buttons-container .category-button').forEach(btn => {
              btn.classList.remove('active');
              btn.style.background = '#fff';
              btn.style.color = btn.textContent.includes('Promocje') ? '#FF6B6B' : btn.textContent.includes('Bestsellery') ? '#f5c842' : '#333';
            });
            bestsellerButton.classList.add('active');
            bestsellerButton.style.background = '#f5c842';
            bestsellerButton.style.color = '#333';
            renderMobileBestsellerModels();
          };
          container.appendChild(bestsellerButton);
          console.log('📱 Added mobile "Bestsellery" button with', bestsellerModels.length, 'items');
        }
        
        // Dodaj separator między specjalnymi a głównymi kategoriami
        const separator = document.createElement('div');
        separator.style.cssText = 'width: 100%; height: 1px; background: #e0e0e0; margin: 10px 5px; flex-basis: 100%;';
        container.appendChild(separator);
        
        // ==== GŁÓWNE KATEGORIE W DRUGIEJ LINII (mobile) ====
        // Dodaj przyciski dla każdej kategorii
        categories.forEach(category => {
          const button = document.createElement('button');
          button.className = 'category-button mobile-main';
          button.textContent = category;
          button.style.cssText = 'margin: 5px; padding: 8px 15px; border: 2px solid #F5C842; background: #fff; color: #333; border-radius: 8px; font-weight: bold; cursor: pointer;';
          
          button.onclick = () => {
            document.querySelectorAll('#mobile-category-buttons-container .category-button').forEach(btn => {
              btn.classList.remove('active');
              btn.style.background = '#fff';
              btn.style.color = btn.textContent.includes('Promocje') ? '#FF6B6B' : btn.textContent.includes('Bestsellery') ? '#f5c842' : '#333';
            });
            button.classList.add('active');
            button.style.background = '#F5C842';
            button.style.color = '#333';
            renderMobileModels(category);
          };
          
          container.appendChild(button);
        });
        
        console.log('📱 Added mobile category buttons: 3 special +', categories.length, 'main categories');
      }
      
      // 📱 NOWE FUNKCJE MOBILNE - bazują na logice desktop
      
      function createMobileCategories() {
        console.log('📱 createMobileCategories called');
        console.log('📱 Window width:', window.innerWidth, 'Is mobile:', window.innerWidth <= 820);
        
        // Pokaż osobny mobilny kontener na mobile
        const standaloneMobileUI = document.getElementById('standalone-mobile-ui');
        if (standaloneMobileUI && window.innerWidth <= 820) {
          standaloneMobileUI.style.display = 'block';
          console.log('📱 Standalone mobile UI shown');
        }
        
        const container = document.getElementById('standalone-mobile-categories');
        console.log('📱 standalone-mobile-categories:', container ? 'FOUND' : 'NOT FOUND');
        
        if (!container) {
          console.error('❌ standalone-mobile-categories not found');
          return;
        }
        
        container.innerHTML = '';
        
        // Stałe kategorie niezależne od arkusza (jak na desktop)
        const mobileCategories = ['Wszystkie', 'Welur', 'Eco skóra', 'Tkanina'];
        
        mobileCategories.forEach((category, index) => {
          const button = document.createElement('button');
          button.className = 'mobile-category-btn';
          button.textContent = category;
          button.style.cssText = `
            background: linear-gradient(135deg, #F5C842, #E5B432);
            color: white;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(245, 200, 66, 0.3);
          `;
          
          // Pierwszy przycisk aktywny
          if (index === 0) {
            button.classList.add('active');
            button.style.background = 'linear-gradient(135deg, #E5B432, #D1A029)';
          }
          
          button.onclick = () => {
            // Usuń aktywny ze wszystkich
            document.querySelectorAll('.mobile-category-btn').forEach(btn => {
              btn.classList.remove('active');
              btn.style.background = 'linear-gradient(135deg, #F5C842, #E5B432)';
            });
            // Dodaj aktywny do klikniętego
            button.classList.add('active');
            button.style.background = 'linear-gradient(135deg, #E5B432, #D1A029)';
            
            // Renderuj modele dla kategorii
            if (category === 'Wszystkie') {
              renderStandaloneMobileAllModels();
            } else {
              renderStandaloneMobileModelsByCategory(category);
            }
          };
          
          container.appendChild(button);
        });
        
        console.log('📱 Mobile categories created:', mobileCategories.length);
        
        // Automatycznie załaduj wszystkie modele
        setTimeout(() => renderStandaloneMobileAllModels(), 100);
      }
      
      function renderStandaloneMobileAllModels() {
        console.log('📱 renderStandaloneMobileAllModels called');
        
        const container = document.getElementById('standalone-mobile-models');
        if (!container) {
          console.error('❌ standalone-mobile-models not found');
          return;
        }
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('⏳ allData not ready for mobile models');
          return;
        }
        
        container.innerHTML = '';
        
        // Filtruj tylko modele (jak na desktop)
        const models = allData.filter(item => item.Typ === 'model');
        console.log('📱 Found models for mobile:', models.length);
        
        models.forEach(model => {
          const modelElement = createStandaloneMobileModelElement(model);
          container.appendChild(modelElement);
        });
        
        console.log('📱 Standalone mobile all models rendered:', models.length);
      }
      
      function renderStandaloneMobileModelsByCategory(category) {
        console.log('📱 renderStandaloneMobileModelsByCategory called for:', category);
        
        const container = document.getElementById('standalone-mobile-models');
        if (!container) {
          console.error('❌ standalone-mobile-models not found');
          return;
        }
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('⏳ allData not ready for mobile category models');
          return;
        }
        
        container.innerHTML = '';
        
        // Filtruj modele według kategorii (jak na desktop)
        const models = allData.filter(item => 
          item.Typ === 'model' && 
          item.Kategoria === category
        );
        
        console.log('📱 Found models for category', category + ':', models.length);
        
        models.forEach(model => {
          const modelElement = createStandaloneMobileModelElement(model);
          container.appendChild(modelElement);
        });
        
        console.log('📱 Standalone mobile category models rendered:', models.length);
      }
      
      function createStandaloneMobileModelElement(model) {
        const div = document.createElement('div');
        div.style.cssText = `
          background: white;
          border-radius: 12px;
          padding: 10px;
          box-shadow: 0 4px 12px rgba(0,0,0,0.1);
          transition: all 0.3s ease;
          cursor: pointer;
          text-align: center;
        `;
        
        // Użyj mobile image path - jeśli już zawiera mobile_icons/ to nie dodawaj ponownie
        let imagePath;
        if (model.Mobile && model.Mobile.trim() !== '') {
          // Jeśli już zawiera mobile_icons/, użyj bezpośrednio
          if (model.Mobile.includes('mobile_icons/')) {
            imagePath = model.Mobile;
          } else {
            // W przeciwnym razie dodaj folder
            imagePath = `mobile_icons/${model.Mobile}`;
          }
        } else {
          imagePath = model.Image || 'icons/placeholder.svg';
        }
        
        console.log('📱 Model:', model.Nazwa, 'Mobile path:', model.Mobile, 'Final path:', imagePath);
        
        div.innerHTML = `
          <img src="${imagePath}" alt="${model.Nazwa}" 
               style="width: 100%; height: 100px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;"
               onerror="this.src='icons/placeholder.svg'">
          <div style="font-size: 12px; font-weight: 600; color: #333; margin-bottom: 4px;">
            ${model.Nazwa}
          </div>
          <div style="font-size: 11px; color: #666;">
            ${model.Cena || 'Brak ceny'}
          </div>
        `;
        
        // Hover effect
        div.onmouseenter = () => {
          div.style.transform = 'translateY(-2px)';
          div.style.boxShadow = '0 6px 20px rgba(0,0,0,0.15)';
        };
        div.onmouseleave = () => {
          div.style.transform = 'translateY(0)';
          div.style.boxShadow = '0 4px 12px rgba(0,0,0,0.1)';
        };
        
        // Kliknięcie w model
        div.onclick = () => {
          console.log('📱 Standalone mobile model clicked:', model.Nazwa);
          
          // Ukryj mobilny kontener
          const standaloneMobileUI = document.getElementById('standalone-mobile-ui');
          if (standaloneMobileUI) {
            standaloneMobileUI.style.display = 'none';
          }
          
          // Zamknij welcome screen
          const welcomeScreen = document.getElementById('welcome-screen');
          if (welcomeScreen) {
            welcomeScreen.style.display = 'none';
          }
          
          // Załaduj model (użyj istniejącej funkcji)
          if (typeof loadChairModel === 'function') {
            loadChairModel(model['3D model']);
          }
          
          // Ustaw aktywny model
          window.currentModel = model;
        };
        
        return div;
      }
      
      // Handler dla przycisku zamykania mobilnego UI
      document.addEventListener('DOMContentLoaded', () => {
        const closeMobileUIBtn = document.getElementById('close-mobile-ui');
        if (closeMobileUIBtn) {
          closeMobileUIBtn.onclick = () => {
            const standaloneMobileUI = document.getElementById('standalone-mobile-ui');
            if (standaloneMobileUI) {
              standaloneMobileUI.style.display = 'none';
            }
          };
        }
      });
      
      function renderMobileAllModels() {
        console.log('📱 renderMobileAllModels called');
        
        const container = document.getElementById('mobile-models-container');
        if (!container) {
          console.error('❌ mobile-models-container not found');
          return;
        }
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('⏳ allData not ready for mobile models');
          return;
        }
        
        container.innerHTML = '';
        
        // Filtruj tylko modele (jak na desktop)
        const models = allData.filter(item => item.Typ === 'model');
        console.log('📱 Found models for mobile:', models.length);
        
        models.forEach(model => {
          const modelElement = createMobileModelElement(model);
          container.appendChild(modelElement);
        });
        
        // Ukryj loading text
        const loadingText = document.getElementById('mobile-loading-text');
        if (loadingText) loadingText.style.display = 'none';
        
        console.log('📱 Mobile all models rendered:', models.length);
      }
      
      function renderMobileModelsByCategory(category) {
        console.log('📱 renderMobileModelsByCategory called for:', category);
        
        const container = document.getElementById('mobile-models-container');
        if (!container) {
          console.error('❌ mobile-models-container not found');
          return;
        }
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('⏳ allData not ready for mobile category models');
          return;
        }
        
        container.innerHTML = '';
        
        // Filtruj modele według kategorii (jak na desktop)
        const models = allData.filter(item => 
          item.Typ === 'model' && 
          item.Kategoria === category
        );
        
        console.log('📱 Found models for category', category + ':', models.length);
        
        models.forEach(model => {
          const modelElement = createMobileModelElement(model);
          container.appendChild(modelElement);
        });
        
        console.log('📱 Mobile category models rendered:', models.length);
      }
      
      function createMobileModelElement(model) {
        const div = document.createElement('div');
        div.className = 'mobile-model-item';
        
        // Użyj mobile image path jeśli dostępny, inaczej fallback
        const imagePath = model.Mobile && model.Mobile.trim() !== '' 
          ? `mobile_icons/${model.Mobile}`
          : (model.Image || 'icons/placeholder.svg');
        
        console.log('📱 Model:', model.Nazwa, 'Mobile path:', model.Mobile, 'Final path:', imagePath);
        
        // Przygotuj cenę z uwzględnieniem promocji
        let priceHTML = model.Cena || 'Brak ceny';
        if (model.Cena) {
          const cena = parseFloat(model.Cena) || 0;
          const promocja = model.Promocja === 'tak' || model.Promocja === 'true';
          const procent = parseFloat(model.Procent) || 0;
          
          if (promocja && procent > 0) {
            // Cena promocyjna - cena przekreślona i nowa cena
            const cenaPoPobniżce = cena * (1 - procent / 100);
            priceHTML = `
              <div style="font-size: 11px; color: #999; text-decoration: line-through;">${cena.toFixed(0)} zł</div>
              <div style="font-size: 13px; color: #e74c3c; font-weight: bold;">${cenaPoPobniżce.toFixed(0)} zł</div>
            `;
          } else {
            priceHTML = `${cena.toFixed(0)} zł`;
          }
        }
        
        div.innerHTML = `
          <img src="${imagePath}" alt="${model.Nazwa}" 
               onerror="this.src='icons/placeholder.svg'">
          <div class="model-name">${model.Nazwa}</div>
          <div class="model-price">${priceHTML}</div>
        `;
        
        // Kliknięcie w model (jak na desktop)
        div.onclick = () => {
          console.log('📱 Mobile model clicked:', model.Nazwa);
          
          // Zamknij welcome screen
          const welcomeScreen = document.getElementById('welcome-screen');
          if (welcomeScreen) {
            welcomeScreen.style.display = 'none';
          }
          
          // Załaduj model (użyj istniejącej funkcji)
          if (typeof loadChairModel === 'function') {
            loadChairModel(model['3D model']);
          }
          
          // Ustaw aktywny model
          window.currentModel = model;
        };
        
        return div;
      }
      
      // Funkcja renderująca kategorie w głównej mobilnej sekcji (welcome screen)
      function renderMobileMainCategories() {
        console.log('📱 renderMobileMainCategories called, allData:', allData?.length);
        
        // Dodatkowe debugowanie ekranu i viewport
        console.log('📱 Window dimensions:', window.innerWidth + 'x' + window.innerHeight);
        console.log('📱 Is mobile viewport (width <= 820):', window.innerWidth <= 820);
        console.log('📱 User Agent:', navigator.userAgent.substring(0, 100));
        
        // Wymusza widoczność mobilnej sekcji jeśli width <= 820
        const section = document.getElementById('mobile-main-section');
        if (section && window.innerWidth <= 820) {
          console.log('📱 Forcing mobile section visibility via JavaScript');
          section.style.display = 'block';
          section.style.visibility = 'visible';
          section.style.opacity = '1';
          section.style.backgroundColor = 'lightblue'; // Testowy kolor
          section.style.border = '2px solid orange'; // Testowa ramka
        }
        
        const container = document.getElementById('mobile-main-category-buttons');
        console.log('📱 mobile-main-category-buttons element:', container ? 'FOUND' : 'NOT FOUND');
        
        if (!container) {
          console.error('❌ mobile-main-category-buttons not found');
          // Sprawdź czy mobile-main-section istnieje
          const section = document.getElementById('mobile-main-section');
          console.log('📱 mobile-main-section element:', section ? 'FOUND' : 'NOT FOUND');
          if (section) {
            const styles = window.getComputedStyle(section);
            console.log('📱 mobile-main-section display:', styles.display);
            console.log('📱 mobile-main-section visibility:', styles.visibility);
            console.log('📱 mobile-main-section opacity:', styles.opacity);
            console.log('📱 mobile-main-section z-index:', styles.zIndex);
          }
          return;
        }
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('⏳ allData not ready for mobile main categories');
          return;
        }
        
        container.innerHTML = '';
        
        // Znajdź wszystkie unikalne kategorie
        const categories = [...new Set(allData
          .filter(item => item.Kategoria && item.Typ === 'model')
          .map(item => item.Kategoria)
        )];
        
        console.log('📱 Found mobile main categories:', categories);
        
        // Dodaj przycisk "Wszystkie"
        const allButton = document.createElement('button');
        allButton.className = 'category-button active';
        allButton.textContent = 'Wszystkie';
        allButton.style.cssText = 'margin: 5px; padding: 10px 18px; border: 2px solid #F5C842; background: #F5C842; color: #333; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px;';
        allButton.onclick = () => {
          document.querySelectorAll('#mobile-main-category-buttons .category-button').forEach(btn => {
            btn.classList.remove('active');
            btn.style.background = '#fff';
            btn.style.color = '#333';
          });
          allButton.classList.add('active');
          allButton.style.background = '#F5C842';
          allButton.style.color = '#333';
          renderMobileMainModels();
        };
        container.appendChild(allButton);
        
        // Dodaj przyciski dla każdej kategorii
        categories.forEach(category => {
          const button = document.createElement('button');
          button.className = 'category-button';
          button.textContent = category;
          button.style.cssText = 'margin: 5px; padding: 10px 18px; border: 2px solid #F5C842; background: #fff; color: #333; border-radius: 8px; font-weight: bold; cursor: pointer; font-size: 14px;';
          
          button.onclick = () => {
            document.querySelectorAll('#mobile-main-category-buttons .category-button').forEach(btn => {
              btn.classList.remove('active');
              btn.style.background = '#fff';
              btn.style.color = '#333';
            });
            button.classList.add('active');
            button.style.background = '#F5C842';
            button.style.color = '#333';
            renderMobileMainModels(category);
          };
          
          container.appendChild(button);
        });
        
        console.log('📱 Added mobile main category buttons:', categories.length + 1);
      }
      
      // Funkcja renderująca modele w głównej mobilnej sekcji (welcome screen)
      function renderMobileMainModels(selectedCategory = null) {
        console.log('📱 renderMobileMainModels called, category:', selectedCategory);
        
        const container = document.getElementById('mobile-main-model-thumbnails');
        const loadingText = document.getElementById('mobile-main-loading-text');
        
        console.log('📱 mobile-main-model-thumbnails element:', container ? 'FOUND' : 'NOT FOUND');
        console.log('📱 mobile-main-loading-text element:', loadingText ? 'FOUND' : 'NOT FOUND');
        
        if (!container) {
          console.error('❌ mobile-main-model-thumbnails not found');
          // Sprawdź czy mobile-main-section istnieje
          const section = document.getElementById('mobile-main-section');
          console.log('📱 mobile-main-section element:', section ? 'FOUND' : 'NOT FOUND');
          if (section) {
            console.log('📱 mobile-main-section display:', window.getComputedStyle(section).display);
            console.log('📱 mobile-main-section innerHTML:', section.innerHTML.substring(0, 200) + '...');
          }
          return;
        }
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('⏳ allData not ready for mobile main models');
          return;
        }
        
        // Ukryj tekst ładowania
        if (loadingText) {
          loadingText.style.display = 'none';
        }
        
        container.innerHTML = '';
        
        // Filtruj modele
        let models = allData.filter(item => item.Typ === 'model');
        
        if (selectedCategory) {
          models = models.filter(item => item.Kategoria === selectedCategory);
        }
        
        console.log('📱 Rendering mobile main models:', models.length);
        
        models.forEach(item => {
          const wrapper = document.createElement('div');
          wrapper.style.cssText = 'text-align: center; cursor: pointer; padding: 10px; background: white; border-radius: 10px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); transition: transform 0.2s ease;';
          
          const img = document.createElement('img');
          img.src = item.Obrazek && item.Obrazek.length > 4 ? item.Obrazek : 'icons/placeholder.svg';
          img.alt = item.Nazwa;
          img.style.cssText = 'width: 100%; height: 80px; object-fit: cover; border-radius: 8px; margin-bottom: 8px;';
          img.onerror = () => {
            img.src = 'icons/placeholder.svg';
          };
          
          const caption = document.createElement('div');
          caption.textContent = item.Nazwa;
          caption.style.cssText = 'font-size: 12px; font-weight: 600; color: #333; line-height: 1.2;';
          
          const price = document.createElement('div');
          if (item.Cena) {
            const cena = parseFloat(item.Cena) || 0;
            const promocja = item.Promocja === 'tak' || item.Promocja === 'true';
            const procent = parseFloat(item.Procent) || 0;
            
            if (promocja && procent > 0) {
              // Cena promocyjna - cena przekreślona i nowa cena
              const cenaPoPobniżce = cena * (1 - procent / 100);
              price.innerHTML = `
                <div style="font-size: 10px; color: #999; text-decoration: line-through; margin-bottom: 1px;">${cena.toFixed(0)} zł</div>
                <div style="font-size: 12px; color: #e74c3c; font-weight: bold;">${cenaPoPobniżce.toFixed(0)} zł</div>
              `;
              price.style.cssText = 'margin-top: 4px; text-align: center;';
            } else if (cena > 0) {
              // Cena normalna
              price.textContent = `${cena.toFixed(0)} zł`;
              price.style.cssText = 'font-size: 11px; color: #F5C842; font-weight: bold; margin-top: 4px;';
            }
          }
          
          wrapper.appendChild(img);
          wrapper.appendChild(caption);
          if (item.Cena) wrapper.appendChild(price);
          
          wrapper.onclick = () => {
            console.log('📱 Mobile main model clicked:', item.Nazwa);
            // Ukryj welcome screen i przejdź do konfiguratora
            const welcomeScreen = document.getElementById('welcome-screen');
            if (welcomeScreen) {
              welcomeScreen.style.display = 'none';
            }
            // Pokaż aplikację
            const app = document.getElementById('app');
            if (app) {
              app.style.display = 'block';
            }
            // Załaduj model
            loadModel(item);
          };
          
          wrapper.onmouseenter = () => {
            wrapper.style.transform = 'scale(1.05)';
          };
          
          wrapper.onmouseleave = () => {
            wrapper.style.transform = 'scale(1)';
          };
          
          container.appendChild(wrapper);
        });
        
        console.log('📱 Mobile main models rendered successfully');
      }
      
      // Funkcja renderująca modele w mobilnej sekcji PWA
      function renderMobileModels(selectedCategory = null) {
        console.log('📱 renderMobileModels called, category:', selectedCategory);
        
        const container = document.getElementById('mobile-model-thumbnails');
        const loadingText = document.getElementById('mobile-loading-text');
        
        if (!container) {
          console.error('❌ mobile-model-thumbnails not found');
          return;
        }
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('⏳ allData not ready for mobile models');
          return;
        }
        
        // Ukryj tekst ładowania
        if (loadingText) {
          loadingText.style.display = 'none';
        }
        
        container.innerHTML = '';
        
        // Filtruj modele
        let models = allData.filter(item => item.Typ === 'model');
        
        if (selectedCategory) {
          models = models.filter(item => item.Kategoria === selectedCategory);
        }
        
        console.log('📱 Rendering mobile models:', models.length);
        
        models.forEach(item => {
          const wrapper = document.createElement('div');
          wrapper.className = 'thumbnail-wrapper';
          wrapper.style.cssText = 'text-align: center; cursor: pointer; position: relative;';
          
          const img = document.createElement('img');
          img.src = item.Obrazek && item.Obrazek.length > 4 ? item.Obrazek : 'icons/placeholder.svg';
          img.alt = item.Nazwa;
          
          // Sprawdź promocję i ustaw odpowiedni border
          const promocja = item.Promocja === 'tak' || item.Promocja === 'true';
          const procent = parseFloat(item.Procent) || 0;
          
          if (promocja && procent > 0) {
            img.style.cssText = 'width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #FF6B6B;';
            
            // Dodaj overlay z procentem na mobilnej wersji
            const discountOverlay = document.createElement('div');
            discountOverlay.textContent = `-${procent}%`;
            discountOverlay.style.cssText = `
              position: absolute;
              top: 4px;
              right: 4px;
              background: #FF6B6B;
              color: white;
              font-size: 9px;
              font-weight: 700;
              padding: 2px 3px;
              border-radius: 2px;
              z-index: 10;
              line-height: 1;
            `;
            wrapper.appendChild(discountOverlay);
          } else {
            img.style.cssText = 'width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #ddd;';
          }
          
          img.onerror = () => {
            img.src = 'icons/placeholder.svg';
          };
          
          const caption = document.createElement('div');
          caption.className = 'thumbnail-caption';
          caption.textContent = item.Nazwa;
          caption.style.cssText = 'font-size: 12px; margin-top: 5px; color: #333;';
          
          // Dodaj cenę (mobilna wersja)
          const priceDiv = document.createElement('div');
          if (item.Cena) {
            const cena = parseFloat(item.Cena) || 0;
            const promocja = item.Promocja === 'tak' || item.Promocja === 'true';
            const procent = parseFloat(item.Procent) || 0;
            
            if (promocja && procent > 0) {
              // Cena promocyjna - mobilna wersja  
              const cenaPoPobniżce = cena * (1 - procent / 100);
              priceDiv.className = 'thumbnail-price promotion';
              priceDiv.style.cssText = 'font-size: 11px; margin-top: 3px; text-align: center;';
              priceDiv.innerHTML = `
                <div style="color: #FF6B6B; text-decoration: line-through; font-size: 10px; font-weight: 600;">${cena.toFixed(0)} zł</div>
                <div style="color: #333; font-weight: 700; font-size: 12px;">${cenaPoPobniżce.toFixed(0)} zł</div>
                <div style="background: #FF6B6B; color: white; font-size: 8px; padding: 1px 4px; border-radius: 2px; margin-top: 2px; font-weight: 600;">-${procent}%</div>
              `;
            } else if (cena > 0) {
              // Cena normalna
              priceDiv.className = 'thumbnail-price';
              priceDiv.style.cssText = 'font-size: 11px; margin-top: 3px; color: #333; font-weight: 600; text-align: center;';
              priceDiv.textContent = `${cena.toFixed(0)} zł`;
            }
          }
          
          wrapper.appendChild(img);
          wrapper.appendChild(caption);
          if (priceDiv.textContent || priceDiv.innerHTML) {
            wrapper.appendChild(priceDiv);
          }
          
          wrapper.onclick = () => {
            console.log('📱 Mobile model clicked:', item.Nazwa);
            // Ukryj PWA success screen i przejdź do konfiguratora
            const pwaScreen = document.getElementById('pwa-success-screen');
            if (pwaScreen) {
              pwaScreen.style.display = 'none';
            }
            // Pokaż aplikację
            const app = document.getElementById('app');
            if (app) {
              app.style.display = 'block';
            }
            // Załaduj model
            loadModel(item);
          };
          
          container.appendChild(wrapper);
        });
        
        console.log('📱 Mobile models rendered successfully');
      }

      // Funkcja renderująca mobilne modele promocyjne
      function renderMobilePromotionalModels() {
        console.log('📱 renderMobilePromotionalModels called');
        
        const container = document.getElementById('mobile-model-thumbnails');
        const loadingText = document.getElementById('mobile-loading-text');
        
        if (!container) {
          console.error('❌ mobile-model-thumbnails not found');
          return;
        }
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('⏳ allData not ready for mobile promotional models');
          return;
        }
        
        // Ukryj tekst ładowania
        if (loadingText) {
          loadingText.style.display = 'none';
        }
        
        container.innerHTML = '';
        
        // Filtruj modele promocyjne
        const promotionalModels = allData.filter(item => 
          item.Typ === 'model' && 
          item.Promocja === 'tak' && 
          item.Procent && 
          parseFloat(item.Procent) > 0
        );
        
        console.log('📱 Rendering mobile promotional models:', promotionalModels.length);
        
        promotionalModels.forEach(item => {
          const wrapper = document.createElement('div');
          wrapper.className = 'thumbnail-wrapper';
          wrapper.style.cssText = 'text-align: center; cursor: pointer;';
          
          const img = document.createElement('img');
          img.src = item.Obrazek && item.Obrazek.length > 4 ? item.Obrazek : 'icons/placeholder.svg';
          img.alt = item.Nazwa;
          img.style.cssText = 'width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #FF6B6B;';
          img.onerror = () => {
            img.src = 'icons/placeholder.svg';
          };
          
          const caption = document.createElement('div');
          caption.className = 'thumbnail-caption';
          caption.textContent = item.Nazwa;
          caption.style.cssText = 'font-size: 12px; margin-top: 5px; color: #333;';
          
          // Dodaj cenę promocyjną
          const priceDiv = document.createElement('div');
          if (item.Cena) {
            const cena = parseFloat(item.Cena) || 0;
            const procent = parseFloat(item.Procent) || 0;
            const cenaPoPobniżce = cena * (1 - procent / 100);
            priceDiv.className = 'thumbnail-price promotion';
            priceDiv.style.cssText = 'font-size: 11px; margin-top: 3px; text-align: center;';
            priceDiv.innerHTML = `
              <div style="color: #FF6B6B; text-decoration: line-through; font-size: 10px; font-weight: 600;">${cena.toFixed(0)} zł</div>
              <div style="color: #333; font-weight: 700; font-size: 12px;">${cenaPoPobniżce.toFixed(0)} zł</div>
              <div style="background: #FF6B6B; color: white; font-size: 8px; padding: 1px 4px; border-radius: 2px; margin-top: 2px; font-weight: 600;">-${procent}%</div>
            `;
          }
          
          wrapper.appendChild(img);
          wrapper.appendChild(caption);
          if (priceDiv.innerHTML) {
            wrapper.appendChild(priceDiv);
          }
          
          wrapper.onclick = () => {
            console.log('📱 Mobile promotional model clicked:', item.Nazwa);
            // Ukryj PWA success screen i przejdź do konfiguratora
            const pwaScreen = document.getElementById('pwa-success-screen');
            if (pwaScreen) {
              pwaScreen.style.display = 'none';
            }
            // Pokaż aplikację
            const app = document.getElementById('app');
            if (app) {
              app.style.display = 'block';
            }
            // Załaduj model
            loadModel(item);
          };
          
          container.appendChild(wrapper);
        });
        
        console.log('📱 Mobile promotional models rendered successfully');
      }

      // Funkcja renderująca mobilne modele bestsellery
      function renderMobileBestsellerModels() {
        console.log('📱 renderMobileBestsellerModels called');
        
        const container = document.getElementById('mobile-model-thumbnails');
        const loadingText = document.getElementById('mobile-loading-text');
        
        if (!container) {
          console.error('❌ mobile-model-thumbnails not found');
          return;
        }
        
        if (!allData || !Array.isArray(allData) || allData.length === 0) {
          console.log('⏳ allData not ready for mobile bestseller models');
          return;
        }
        
        // Ukryj tekst ładowania
        if (loadingText) {
          loadingText.style.display = 'none';
        }
        
        container.innerHTML = '';
        
        // Filtruj modele bestsellery
        const bestsellerModels = allData.filter(item => 
          item.Typ === 'model' && 
          (item.Bestseller === 'tak' || item.Bestseller === 'true')
        );
        
        console.log('📱 Rendering mobile bestseller models:', bestsellerModels.length);
        
        bestsellerModels.forEach(item => {
          const wrapper = document.createElement('div');
          wrapper.className = 'thumbnail-wrapper';
          wrapper.style.cssText = 'text-align: center; cursor: pointer;';
          
          const img = document.createElement('img');
          img.src = item.Obrazek && item.Obrazek.length > 4 ? item.Obrazek : 'icons/placeholder.svg';
          img.alt = item.Nazwa;
          img.style.cssText = 'width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid #f5c842;';
          img.onerror = () => {
            img.src = 'icons/placeholder.svg';
          };
          
          const caption = document.createElement('div');
          caption.className = 'thumbnail-caption';
          caption.textContent = item.Nazwa;
          caption.style.cssText = 'font-size: 12px; margin-top: 5px; color: #333;';
          
          // Dodaj cenę z oznaczeniem bestsellera
          const priceDiv = document.createElement('div');
          if (item.Cena) {
            const cena = parseFloat(item.Cena) || 0;
            priceDiv.className = 'thumbnail-price bestseller';
            priceDiv.style.cssText = 'font-size: 11px; margin-top: 3px; text-align: center;';
            priceDiv.innerHTML = `
              <div style="color: #333; font-weight: 700; font-size: 12px;">${cena.toFixed(0)} zł</div>
              <div style="background: #f5c842; color: #333; font-size: 8px; padding: 1px 4px; border-radius: 2px; margin-top: 2px; font-weight: 600;">⭐ Bestseller</div>
            `;
          }
          
          wrapper.appendChild(img);
          wrapper.appendChild(caption);
          if (priceDiv.innerHTML) {
            wrapper.appendChild(priceDiv);
          }
          
          wrapper.onclick = () => {
            console.log('📱 Mobile bestseller model clicked:', item.Nazwa);
            // Ukryj PWA success screen i przejdź do konfiguratora
            const pwaScreen = document.getElementById('pwa-success-screen');
            if (pwaScreen) {
              pwaScreen.style.display = 'none';
            }
            // Pokaż aplikację
            const app = document.getElementById('app');
            if (app) {
              app.style.display = 'block';
            }
            // Załaduj model
            loadModel(item);
          };
          
          container.appendChild(wrapper);
        });
        
        console.log('📱 Mobile bestseller models rendered successfully');
      }

      // PWA TERAZ UŻYWA PRAWDZIWEGO DESKTOP SIDEBAR - usunięto renderPWACategoryButtons

      // Funkcja odświeżająca wszystkie kafelki z filtrem
      function refreshAllTiles() {
        console.log('🔄 Refreshing all tiles with filter:', currentSearchFilter);
        
                  // Odśwież modele główne (krzesła/kubełki)
          if (allData && Array.isArray(allData)) {
            console.log('🔍 Available groups:', [...new Set(allData.map(d => d.Grupa))]);
            const filteredByGroup = allData.filter(d => 
              d.Kategoria && 
              d.Kategoria.toLowerCase().includes('krzesła') && 
              d.Typ && 
              d.Typ.toLowerCase() === 'model'
            );
            console.log('🔍 Filtered models before search filter:', filteredByGroup.map(d => ({ Nazwa: d.Nazwa, Grupa: d.Grupa, Kategoria: d.Kategoria, Typ: d.Typ })));
            const mainModels = filteredByGroup.filter(matchesSearchFilter);
            console.log('🔍 After search filter:', mainModels.map(d => ({ Nazwa: d.Nazwa, Grupa: d.Grupa })));
          if (currentSearchFilter) {
            mainModels.sort((a, b) => getRelevance(b, currentSearchFilter) - getRelevance(a, currentSearchFilter));
          }
          console.log('🔍 Rendering main models:', mainModels.length, 'with filter:', currentSearchFilter);
          renderOptions('model-thumbnails', mainModels, item => loadModel(item));
        }
        
        // Odśwież kafelki nóg jeśli są widoczne
        const legsSection = document.getElementById('legs-section');
        if (legsSection && legsSection.style.display !== 'none' && selectedChair) {
          const legs = allData
            .filter(d => d.Grupa.toLowerCase() === 'nogi')
            .filter(d => {
              // Filtrowanie kategorii
              const nogaKategoria = (d.Kategoria || d.Typ || d.Grupa || '').toLowerCase();
              const chairKategoria = (selectedChair?.Kategoria || '').toLowerCase();
              
              // Jeśli krzesło to 'hookery', pokazuj tylko nogi 'hooker'
              if (chairKategoria.includes('hooker')) {
                if (!nogaKategoria.includes('hooker')) return false;
              }
              // Jeśli krzesło to 'krzesła', pokazuj tylko nogi 'krzesła' (i uniwersalne)
              else if (chairKategoria.includes('krzes')) {
                if (nogaKategoria.includes('hooker')) return false;
                if (!(nogaKategoria.includes('krzes') || nogaKategoria === '' || nogaKategoria === 'nogi')) return false;
              }
              
              return true;
            })
            .filter(d => !selectedChair || selectedChair.Grupa.toLowerCase() !== 'kubełek' || czyNogaPasujeDoKubełka(d, selectedChair.Nazwa))
            .filter(matchesSearchFilter);
          renderOptions('legs-thumbnails', legs, item => setLegModel(item));
        }
        
        // Odśwież materiały jeśli są widoczne
        const materialsSection = document.getElementById('materials-section');
        if (materialsSection && materialsSection.style.display !== 'none') {
          // Znajdź aktywną zakładkę części
          const activeTab = document.querySelector('#part-tabs .thumbnail.selected');
          if (activeTab) {
            const targetMesh = activeTab.dataset.key;
            renderFilteredMaterialOptions(targetMesh);
          }
        }
      }

      // Funkcjonalność wyszukiwania
      function initializeSearch() {
        console.log('🔍 Initializing search...');
        console.log('DOM ready state:', document.readyState);
        console.log('Available elements in DOM:', {
          searchToggle: document.getElementById('search-toggle'),
          searchPanel: document.getElementById('search-panel'),
          searchInput: document.getElementById('search-input'),
          searchResults: document.getElementById('search-results')
        });
        
        const searchToggle = document.getElementById('search-toggle');
        const searchPanel = document.getElementById('search-panel');
        const searchInput = document.getElementById('search-input');
        const searchResults = document.getElementById('search-results');
        
        console.log('Elements found:', {
          toggle: !!searchToggle,
          panel: !!searchPanel,
          input: !!searchInput,
          results: !!searchResults
        });
        
        let isSearchOpen = false;

        if (!searchToggle || !searchPanel) {
          console.error('❌ Search elements not found');
          console.log('HTML content around search:', document.getElementById('search-container')?.innerHTML);
          return;
        }

        console.log('✅ Setting up search event listeners');
        console.log('Initial panel styles:', {
          position: window.getComputedStyle(searchPanel).position,
          right: window.getComputedStyle(searchPanel).right,
          opacity: window.getComputedStyle(searchPanel).opacity,
          visibility: window.getComputedStyle(searchPanel).visibility,
          zIndex: window.getComputedStyle(searchPanel).zIndex
        });

        // Toggle panel wyszukiwania
        searchToggle.addEventListener('click', (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log('🔍 Search toggle clicked!', {
            wasOpen: isSearchOpen,
            willBeOpen: !isSearchOpen,
            currentClasses: searchPanel.className
          });
          
          isSearchOpen = !isSearchOpen;
          
          if (isSearchOpen) {
            // Zapamiętaj aktualną kategorię przed otwarciem wyszukiwania
            saveCurrentCategory();
            searchPanel.classList.add('active');
            console.log('🔍 Panel opened');
            setTimeout(() => searchInput && searchInput.focus(), 200);
          } else {
            searchPanel.classList.remove('active');
            console.log('🔍 Panel closed');
            if (searchInput) searchInput.value = '';
            if (searchResults) searchResults.innerHTML = '';
            // Wyczyść filtr kafelków
            setSearchFilter('');
            // Przywróć poprzednią kategorię
            restorePreviousCategory();
          }
          
          console.log('Panel state after toggle:', {
            classes: searchPanel.className,
            computedStyles: {
              right: window.getComputedStyle(searchPanel).right,
              opacity: window.getComputedStyle(searchPanel).opacity,
              visibility: window.getComputedStyle(searchPanel).visibility
            }
          });
        });

        // Zamknij panel przy kliknięciu poza nim
        document.addEventListener('click', (e) => {
          if (!searchPanel.contains(e.target) && !searchToggle.contains(e.target)) {
            if (isSearchOpen) {
              isSearchOpen = false;
              searchPanel.classList.remove('active');
              if (searchInput) searchInput.value = '';
              if (searchResults) searchResults.innerHTML = '';
              // Wyczyść filtr kafelków
              setSearchFilter('');
              // Przywróć poprzednią kategorię
              restorePreviousCategory();
            }
          }
        });

        // Funkcja wyszukiwania
        function performSearch(query, limit = 20) {
          if (!query.trim() || !allData) return [];
          
          const searchTerm = query.toLowerCase().trim();
          const results = [];

          console.log('🔍 Searching for:', searchTerm, 'in', allData.length, 'items');

          // UPROSZCZONE WYSZUKIWANIE: tylko po nazwie i tylko dla Typ === 'model'
          const modelItems = allData.filter(item => {
            const nazwa = (item.Nazwa || '').toLowerCase();
            const typ = (item.Typ || '').toLowerCase();
            
            return typ === 'model' &&  // tylko modele (krzesła/hookery)
                   nazwa.includes(searchTerm) &&  // nazwa zawiera frazę
                   item.Visible !== 'false' &&  // tylko widoczne
                   item.Nazwa && item.Nazwa.trim() !== '';  // tylko z nazwą
          });

          console.log('🔍 Found', modelItems.length, 'model items matching name search');

          // Dodaj wszystkie znalezione modele do wyników
          modelItems.forEach(item => {
            const nazwa = (item.Nazwa || '').toLowerCase();
            let relevance = 10; // bazowa wartość
            
            // Bonus za dopasowanie od początku nazwy
            if (nazwa.startsWith(searchTerm)) {
              relevance += 10;
            }
            
            console.log('🔍 Found match:', item.Nazwa, 'Kategoria:', item.Kategoria);
            item.searchType = 'chair';
            results.push({ item, relevance });
          });

          console.log('🔍 Final results:', results.length);
          
          // Sortowanie alfabetyczne po nazwach
          const sortedResults = results
            .sort((a, b) => {
              const nameA = (a.item.Nazwa || '').toLowerCase();
              const nameB = (b.item.Nazwa || '').toLowerCase();
              return nameA.localeCompare(nameB);
            })
            .slice(0, limit);
          
          console.log('🔍 Returning', sortedResults.length, 'results after sorting alphabetically');
          return sortedResults.map(r => r.item);
        }

        // Handler wpisywania w pole wyszukiwania
        searchInput.addEventListener('input', (e) => {
          const query = e.target.value;
          searchResults.innerHTML = '';

          // AUTOMATYCZNE PRZEŁĄCZENIE NA KATEGORIĘ "WSZYSTKIE" podczas wyszukiwania
          if (query.trim().length > 0) {
            const allButton = document.querySelector('[data-category="Wszystkie"]');
            if (allButton && !allButton.classList.contains('active')) {
              // Dezaktywuj inne kategorie
              document.querySelectorAll('.category-button').forEach(btn => {
                btn.classList.remove('active');
                btn.style.background = 'white';
                btn.style.color = btn.classList.contains('promotion') ? '#FF6B6B' : '#333';
              });
              // Aktywuj kategorię "Wszystkie"
              allButton.classList.add('active');
              allButton.style.background = '#F5C842';
              allButton.style.color = '#333';
              console.log('🔄 Auto-switched to "Wszystkie" category during search');
            }
          }

          // Ustaw filtr dla kafelków w sidebarze
          setSearchFilter(query);

          if (query.trim().length < 2) {
            // Jeśli zapytanie za krótkie, wyczyść tylko wyniki popup'a ale zostaw filtr
            return;
          }

          const results = performSearch(query);
          
          if (results.length === 0) {
            const noResultsDiv = document.createElement('div');
            noResultsDiv.className = 'search-result-item text-only';
            noResultsDiv.innerHTML = '<div class="result-name">Brak wyników</div>';
            noResultsDiv.style.cursor = 'default';
            noResultsDiv.style.opacity = '0.7';
            searchResults.appendChild(noResultsDiv);
            return;
          }

          results.forEach(item => {
            const resultDiv = document.createElement('div');
            resultDiv.className = 'search-result-item';
            
            const name = item.Nazwa || 'Bez nazwy';
            const category = item.Kategoria || '';
            const image = item.Obrazek || item.Image;
            
            // Dodaj etykietę typu elementu (tylko dla materiałów i nóg)
            let typeLabel = '';
            if (item.searchType === 'leg-material') {
              typeLabel = 'Materiał nóg';
            } else if (item.searchType === 'leg') {
              typeLabel = 'Nogi';
            }
            // Nie pokazuj typeLabel dla krzeseł - zostanie tylko kategoria
            
            if (image) {
              // Kafelek z obrazkiem - tylko kategoria
              resultDiv.innerHTML = `
                <img src="${image}" alt="${name}" onerror="this.style.display='none'">
                <div class="result-category">${category}</div>
                ${typeLabel ? `<div class="result-type">${typeLabel}</div>` : ''}
              `;
            } else {
              // Fallback tekstowy dla elementów bez obrazków - tylko kategoria
              resultDiv.className += ' text-only';
              resultDiv.innerHTML = `
                <div class="result-category">${category}</div>
                ${typeLabel ? `<div class="result-type">${typeLabel}</div>` : ''}
              `;
            }

            resultDiv.addEventListener('click', () => {
              // Kliknięcie w kafelek od razu przenosi do krzesła
              if (item.searchType === 'chair') {
                // WYCZYŚĆ FILTR WYSZUKIWANIA NAJPIERW!
                setSearchFilter('');
                console.log('🧹 Wyczyszczono filtr wyszukiwania przed ładowaniem krzesła');
                
                // Zamknij panel wyszukiwania
                isSearchOpen = false;
                searchPanel.classList.remove('active');
                if (searchInput) searchInput.value = '';
                if (searchResults) searchResults.innerHTML = '';
                
                // Aktywuj kategorię "Wszystkie"
                const allButtons = document.querySelectorAll('.category-button');
                allButtons.forEach(btn => {
                  btn.classList.remove('active');
                  btn.style.background = 'white';
                  btn.style.color = btn.classList.contains('promotion') ? '#FF6B6B' : '#333';
                });
                
                const allButton = Array.from(allButtons).find(btn => btn.textContent.trim() === 'Wszystkie');
                if (allButton) {
                  allButton.classList.add('active');
                  allButton.style.background = '#F5C842';
                  allButton.style.color = '#333';
                }
                
                // Załaduj model krzesła
                loadModel(item).then(() => {
                  console.log('🔧 Model załadowany z wyszukiwania, aktywuję pierwszą zakładkę materiałów...');
                  
                  // Po załadowaniu modelu, automatycznie aktywuj pierwszą dostępną zakładkę części
                  setTimeout(() => {
                    const firstPartTab = document.querySelector('#part-tabs .thumbnail');
                    if (firstPartTab) {
                      console.log('🎯 Aktywuję pierwszą zakładkę części:', firstPartTab.dataset.key);
                      firstPartTab.click(); // To wywoła renderFilteredMaterialOptions
                    }
                  }, 100); // Małe opóźnienie żeby UI zdążył się wyrenderować
                }).catch(error => {
                  console.error('❌ Błąd ładowania modelu z wyszukiwania:', error);
                });
                
                // Ukryj welcome screen
                const welcomeScreen = document.getElementById('welcome-screen');
                if (welcomeScreen) {
                  welcomeScreen.style.display = 'none';
                }
              }
            });

            searchResults.appendChild(resultDiv);
          });
          
          // Dodaj separator i przycisk do osobnego kontenera pod gridem
          const searchExtra = document.getElementById('search-extra');
          searchExtra.innerHTML = '';
          if (results.length > 0) {
            const separator = document.createElement('div');
            separator.className = 'search-separator';
            separator.style.cssText = `
              width: 100%;
              height: 1px;
              background: #ddd;
              margin: 15px 0 10px 0;
            `;
            searchExtra.appendChild(separator);

            const showAllButton = document.createElement('button');
            showAllButton.className = 'search-show-all-btn';
            showAllButton.textContent = 'Pokaż wszystkie wyniki';
            showAllButton.style.cssText = `
              width: 100%;
              padding: 14px 20px;
              margin: 10px 0 0 0;
              background: #F5C842;
              color: #333;
              border: none;
              border-radius: 8px;
              font-weight: 600;
              font-size: 14px;
              cursor: pointer;
              transition: all 0.2s ease;
              text-align: center;
            `;
            showAllButton.onmouseenter = () => {
              showAllButton.style.background = '#E6B537';
              showAllButton.style.transform = 'translateY(-1px)';
            };
            showAllButton.onmouseleave = () => {
              showAllButton.style.background = '#F5C842';
              showAllButton.style.transform = 'translateY(0)';
            };
            showAllButton.onclick = () => {
              // Przełącz na kategorię "Wszystkie" - ZAWSZE zaktualizuj style
              const allButton = document.querySelector('[data-category="Wszystkie"]');
              if (allButton) {
                // Dezaktywuj inne kategorie
                document.querySelectorAll('.category-button').forEach(btn => {
                  btn.classList.remove('active');
                  btn.style.background = 'white';
                  btn.style.color = btn.classList.contains('promotion') ? '#FF6B6B' : '#333';
                });
                // Aktywuj kategorię "Wszystkie"
                allButton.classList.add('active');
                allButton.style.background = '#F5C842';
                allButton.style.color = '#333';
                console.log('🔄 Activated "Wszystkie" category from "Pokaż wszystkie wyniki"');
              }
              
              isSearchOpen = false;
              searchPanel.classList.remove('active');
              showScreen('search-results');
              const container = document.getElementById('model-thumbnails');
              if (container) {
                const allSearchResults = performSearch(query, 999);
                console.log('🔍 Rendering', allSearchResults.length, 'search results with proper styling');
                
                // Użyj funkcji renderOptions która poprawnie obsługuje promocje/bestsellery
                renderOptions('model-thumbnails', allSearchResults, (variant) => {
                  // WYCZYŚĆ FILTR WYSZUKIWANIA przed ładowaniem krzesła z "Pokaż wszystkie wyniki"
                  setSearchFilter('');
                  console.log('🧹 Wyczyszczono filtr przed ładowaniem krzesła z "Pokaż wszystkie wyniki"');
                  loadModel(variant);
                }, true);
              }
              if (searchInput) searchInput.value = '';
              if (searchResults) searchResults.innerHTML = '';
            };
            searchExtra.appendChild(showAllButton);
          }
        });

        // Obsługa Enter w polu wyszukiwania
        searchInput.addEventListener('keydown', (e) => {
          if (e.key === 'Enter') {
            const showAllButton = document.querySelector('.search-show-all-btn');
            if (showAllButton) showAllButton.click();
          }
        });
      }

      // Funkcja obsługi wybranego wyniku wyszukiwania
      function selectSearchResult(item, query) {
        // Pokaż modal wyboru
        showSearchChoiceModal(item, query);
      }

      // Funkcja pokazywania modala wyboru
      function showSearchChoiceModal(item, query) {
        const modal = document.getElementById('search-choice-modal');
        const itemImg = document.getElementById('search-choice-item-img');
        const itemName = document.getElementById('search-choice-item-name');
        const itemCategory = document.getElementById('search-choice-item-category');
        const viewOptionsBtn = document.getElementById('search-choice-view-options');
        const goToChairBtn = document.getElementById('search-choice-go-to-chair');

        // Ustaw dane elementu
        const name = item.Nazwa || 'Bez nazwy';
        const category = item.Kategoria || '';
        const image = item.Obrazek || item.Image;
        
        // Pokaż tylko kategorię (żółty tekst)
        itemName.textContent = '';
        itemCategory.textContent = category;
        
        if (image) {
          itemImg.src = image;
          itemImg.style.display = 'block';
        } else {
          itemImg.style.display = 'none';
        }

        // Pokaż modal
        modal.classList.add('active');

        // Dostosuj przyciski w zależności od typu elementu
        if (item.searchType === 'chair') {
          goToChairBtn.style.display = 'block';
          goToChairBtn.textContent = 'Przejdź do krzesła';
          viewOptionsBtn.style.flex = '';
        } else if (item.searchType === 'leg-material') {
          goToChairBtn.style.display = 'block';
          goToChairBtn.textContent = 'Pokaż kompatybilne krzesła';
          viewOptionsBtn.style.flex = '';
        } else if (item.searchType === 'leg') {
          goToChairBtn.style.display = 'block';
          goToChairBtn.textContent = 'Pokaż kompatybilne krzesła';
          viewOptionsBtn.style.flex = '';
        } else {
          // Fallback na starą logikę
          const group = item.Grupa?.toLowerCase();
          if (group === 'krzesło' || group === 'kubełek') {
            goToChairBtn.style.display = 'block';
            goToChairBtn.textContent = 'Przejdź do krzesła';
            viewOptionsBtn.style.flex = '';
          } else if (group === 'tkanina' || group === 'materiały_nóg') {
            goToChairBtn.style.display = 'block';
            goToChairBtn.textContent = 'Zastosuj materiał';
            viewOptionsBtn.style.flex = '';
          } else if (group === 'nogi') {
            goToChairBtn.style.display = 'block';
            goToChairBtn.textContent = 'Zastosuj nogi';
            viewOptionsBtn.style.flex = '';
          } else {
            goToChairBtn.style.display = 'none';
            viewOptionsBtn.style.flex = '1';
          }
        }

        // Obsługa przycisku "Wyniki wyszukiwania"
        viewOptionsBtn.onclick = () => {
          modal.classList.remove('active');
          document.removeEventListener('keydown', handleEscape);
          // Pokaż welcome screen
          const welcomeScreen = document.getElementById('welcome-screen');
          if (welcomeScreen) {
            welcomeScreen.style.display = 'flex';
          }
          // Przełącz na ekran modeli, żeby pokazać kafelki
          showScreen('search-results');
          // Ustaw filtr wyszukiwania na query (fraza z inputa)
          setSearchFilter(query);
          // Odśwież wszystkie kafelki z nowym filtrem
          refreshAllTiles();
          // Zamknij panel wyszukiwania
          const searchPanel = document.getElementById('search-panel');
          const searchInput = document.getElementById('search-input');
          if (searchPanel) {
            searchPanel.classList.remove('active');
          }
          if (searchInput) searchInput.value = '';
          // Wyczyść wyniki wyszukiwania w panelu
          const searchResults = document.getElementById('search-results');
          if (searchResults) searchResults.innerHTML = '';
        };

        // Obsługa przycisku "Przejdź do krzesła"
        goToChairBtn.onclick = () => {
          modal.classList.remove('active');
          document.removeEventListener('keydown', handleEscape);
          // Zamknij panel wyszukiwania
          const searchPanel = document.getElementById('search-panel');
          const searchInput = document.getElementById('search-input');
          if (searchPanel) {
            searchPanel.classList.remove('active');
          }
          if (searchInput) searchInput.value = '';
          // Wyczyść filtr wyszukiwania
          setSearchFilter('');
          
          // NOWA LOGIKA: Zawsze aktywuj kategorię "Wszystkie" przed załadowaniem modelu
          const allButtons = document.querySelectorAll('.category-button');
          allButtons.forEach(btn => {
            btn.classList.remove('active');
            btn.style.background = 'white';
            btn.style.color = btn.classList.contains('promotion') ? '#FF6B6B' : '#333';
          });
          
          // Znajdź i aktywuj przycisk "Wszystkie"
          const allButton = Array.from(allButtons).find(btn => btn.textContent.trim() === 'Wszystkie');
          if (allButton) {
            allButton.classList.add('active');
            allButton.style.background = '#F5C842';
            allButton.style.color = '#333';
          }
          
          // Teraz załaduj model
          executeSearchResultAction(item);
          // Odśwież wszystkie kafelki bez filtra
          refreshAllTiles();
          // Ukryj welcome screen
          const welcomeScreen = document.getElementById('welcome-screen');
          if (welcomeScreen) {
            welcomeScreen.style.display = 'none';
          }
        };

        // Zamknij modal przy kliknięciu poza nim
        modal.onclick = (e) => {
          if (e.target === modal) {
            modal.classList.remove('active');
            document.removeEventListener('keydown', handleEscape);
          }
        };

        // Zamknij modal przy naciśnięciu Escape
        const handleEscape = (e) => {
          if (e.key === 'Escape') {
            modal.classList.remove('active');
            document.removeEventListener('keydown', handleEscape);
          }
        };
        document.addEventListener('keydown', handleEscape);
      }

      // Funkcja wykonująca akcję po wyborze w modalu
      function executeSearchResultAction(item) {
        // Sprawdź typ elementu na podstawie searchType
        if (item.searchType === 'chair') {
          // Wybierz model krzesła
          loadModel(item);
        } else if (item.searchType === 'leg-material') {
          // Jeśli to materiał nóg, pokaż krzesła które mogą mieć ten materiał
          showChairsWithMaterial(item);
        } else if (item.searchType === 'leg') {
          // Jeśli to nogi, pokaż krzesła które mogą mieć te nogi
          showChairsWithLegs(item);
        } else {
          // Fallback na starą logikę
          const group = item.Grupa?.toLowerCase();
          
          if (group === 'krzesło' || group === 'kubełek') {
            loadModel(item);
          } else if (group === 'tkanina' || group === 'materiały_nóg') {
            if (selectedChair) {
              if (item.TargetMeshOrModel) {
                applyMaterial(item);
              }
              showScreen('config');
            } else {
              alert('Najpierw wybierz model krzesła');
            }
          } else if (group === 'nogi') {
            if (selectedChair && selectedChair.Grupa?.toLowerCase() === 'kubełek') {
              setLegModel(item);
              showScreen('config');
            } else {
              alert('Nogi można wybierać tylko dla kubełków');
            }
          }
        }
      }

      // Funkcja pokazująca krzesła z określonym materiałem nóg
      function showChairsWithMaterial(material) {
        console.log('🔍 Looking for chairs compatible with material:', material.Nazwa);
        console.log('🔍 Material data:', material);
        
        // Znajdź krzesła które mogą mieć ten materiał
        const allChairs = allData.filter(item => 
          item.Typ && item.Typ.toLowerCase() === 'model' &&
          item.Kategoria && item.Kategoria.toLowerCase().includes('krzesła')
        );
        
        console.log('🔍 All chairs found:', allChairs.map(c => ({ Nazwa: c.Nazwa, Grupa: c.Grupa })));
        
        const compatibleChairs = allChairs.filter(chair => {
          // Sprawdź czy materiał jest kompatybilny z krzesłem
          if (!material.DlaKrzesła) {
            console.log('🔍 No DlaKrzesła field for material:', material.Nazwa);
            return false;
          }
          
          const materialChairs = material.DlaKrzesła.toLowerCase().split(',').map(s => s.trim());
          const chairName = chair.Nazwa.toLowerCase().trim();
          
          console.log('🔍 Checking chair:', chairName, 'against material chairs:', materialChairs);
          
          return materialChairs.some(materialChair => 
            materialChair.includes(chairName) || chairName.includes(materialChair)
          );
        });

        console.log('🔍 Compatible chairs:', compatibleChairs.map(c => c.Nazwa));

        if (compatibleChairs.length > 0) {
          // Pokaż welcome screen
          const welcomeScreen = document.getElementById('welcome-screen');
          if (welcomeScreen) {
            welcomeScreen.style.display = 'flex';
          }
          showScreen('search-results');
          
          // Bezpośrednio wyświetl kompatybilne krzesła
          console.log('🔍 Directly rendering compatible chairs:', compatibleChairs.map(c => c.Nazwa));
          // Wyczyść kontener i wyświetl kompatybilne krzesła
          const container = document.getElementById('model-thumbnails');
          if (container) {
            container.innerHTML = '';
            compatibleChairs.forEach(item => {
              const wrapper = document.createElement('div');
              wrapper.className = 'thumbnail-wrapper';
              const button = document.createElement('div');
              button.className = 'thumbnail';
              button.title = item.Nazwa;
              
              const img = document.createElement('img');
              img.src = item.Obrazek && item.Obrazek.length > 4 ? item.Obrazek : 'icons/placeholder.svg';
              img.alt = item.Nazwa;
              button.appendChild(img);
              
              const caption = document.createElement('div');
              caption.className = 'thumbnail-caption';
              caption.textContent = item.Nazwa;
              
              wrapper.appendChild(button);
              wrapper.appendChild(caption);
              container.appendChild(wrapper);
              
              button.addEventListener('click', () => loadModel(item));
            });
          }
          
          alert(`Znaleziono ${compatibleChairs.length} krzeseł kompatybilnych z materiałem "${material.Nazwa}": ${compatibleChairs.map(c => c.Nazwa).join(', ')}`);
        } else {
          alert(`Nie znaleziono krzeseł kompatybilnych z materiałem "${material.Nazwa}"`);
        }
      }

      // Funkcja pokazująca krzesła z określonymi nogami
      function showChairsWithLegs(legs) {
        console.log('🔍 Looking for chairs compatible with legs:', legs.Nazwa);
        console.log('🔍 Legs data:', legs);
        
        // Znajdź krzesła które mogą mieć te nogi
        const allChairs = allData.filter(item => 
          item.Typ && item.Typ.toLowerCase() === 'model' &&
          item.Kategoria && item.Kategoria.toLowerCase().includes('krzesła')
        );
        
        console.log('🔍 All chairs found:', allChairs.map(c => ({ Nazwa: c.Nazwa, Grupa: c.Grupa })));
        
        const compatibleChairs = allChairs.filter(chair => {
          // Sprawdź czy nogi są kompatybilne z krzesłem
          if (!legs.DlaModeluNóg) {
            console.log('🔍 No DlaModeluNóg field for legs:', legs.Nazwa);
            return false;
          }
          
          const legChairs = legs.DlaModeluNóg.toLowerCase().split(',').map(s => s.trim());
          const chairName = chair.Nazwa.toLowerCase().trim();
          
          console.log('🔍 Checking chair:', chairName, 'against leg chairs:', legChairs);
          
          return legChairs.some(legChair => 
            legChair.includes(chairName) || chairName.includes(legChair)
          );
        });

        console.log('🔍 Compatible chairs:', compatibleChairs.map(c => c.Nazwa));

        if (compatibleChairs.length > 0) {
          // Pokaż welcome screen
          const welcomeScreen = document.getElementById('welcome-screen');
          if (welcomeScreen) {
            welcomeScreen.style.display = 'flex';
          }
          showScreen('search-results');
          
          // Bezpośrednio wyświetl kompatybilne krzesła
          console.log('🔍 Directly rendering compatible chairs:', compatibleChairs.map(c => c.Nazwa));
          // Wyczyść kontener i wyświetl kompatybilne krzesła
          const container = document.getElementById('model-thumbnails');
          if (container) {
            container.innerHTML = '';
            compatibleChairs.forEach(item => {
              const wrapper = document.createElement('div');
              wrapper.className = 'thumbnail-wrapper';
              const button = document.createElement('div');
              button.className = 'thumbnail';
              button.title = item.Nazwa;
              
              const img = document.createElement('img');
              img.src = item.Obrazek && item.Obrazek.length > 4 ? item.Obrazek : 'icons/placeholder.svg';
              img.alt = item.Nazwa;
              button.appendChild(img);
              
              const caption = document.createElement('div');
              caption.className = 'thumbnail-caption';
              caption.textContent = item.Nazwa;
              
              wrapper.appendChild(button);
              wrapper.appendChild(caption);
              container.appendChild(wrapper);
              
              button.addEventListener('click', () => loadModel(item));
            });
          }
          
          alert(`Znaleziono ${compatibleChairs.length} krzeseł kompatybilnych z nogami "${legs.Nazwa}": ${compatibleChairs.map(c => c.Nazwa).join(', ')}`);
        } else {
          alert(`Nie znaleziono krzeseł kompatybilnych z nogami "${legs.Nazwa}"`);
        }
      }

      // Inicjalizuj wyszukiwanie po załadowaniu danych
      window.addEventListener('load', () => {
        setTimeout(initializeSearch, 500);
      });

      // Dodatkowa inicjalizacja po DOM
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initializeSearch, 100);
      });

      // Jeszcze jedna inicjalizacja na wszelki wypadek
      if (document.readyState === 'loading') {
        document.addEventListener('DOMContentLoaded', () => initializeSearch());
      } else {
        // DOM już załadowany
        setTimeout(initializeSearch, 50);
      }

    

      // Sprawdzenie czy strona została załadowana z cache (wyłączone na mobile)
      window.addEventListener('load', function() {
        // Sprawdź czy to mobile device (улучшена detekcja dla iOS)
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1); // iPad na iOS 13+
        
        if (isMobile) {
          console.log('Mobile device detected (iOS/Android), skipping cache reload logic');
          return;
        }
        
        // Sprawdź czy to było nawigacja z cache
        const navigationEntries = performance.getEntriesByType('navigation');
        if (navigationEntries.length > 0) {
          const nav = navigationEntries[0];
          // Jeśli transferSize jest 0 lub bardzo mały, prawdopodobnie z cache
          if (nav.transferSize < 1000 && nav.type === 'reload') {
            console.log('Page loaded from cache, forcing hard reload...');
            // Opóźnienie aby nie powodować pętli
            setTimeout(() => {
              window.location.reload(true);
            }, 100);
            return;
          }
        }
      });

      // Funkcja czyszczenia cache
      function clearAllCaches() {
        if ('caches' in window) {
          caches.keys().then(cacheNames => {
            cacheNames.forEach(cacheName => {
              caches.delete(cacheName);
              console.log('Cleared cache:', cacheName);
            });
          });
        }
      }

      // Funkcja wymuszenia aktualizacji SW
      function forceSwUpdate() {
        if ('serviceWorker' in navigator) {
          navigator.serviceWorker.getRegistrations().then(registrations => {
            registrations.forEach(registration => {
              registration.update();
            });
          });
        }
      }

      // Sprawdzenie czy strona była odświeżona normalnie (nie hard refresh) - wyłączone na mobile
      const perfEntries = performance.getEntriesByType('navigation');
      if (perfEntries.length > 0) {
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1); // iPad na iOS 13+
        
        if (isMobile) {
          console.log('Mobile device detected (iOS/Android), skipping aggressive cache clearing');
        } else {
          const navType = perfEntries[0].type;
          if (navType === 'reload' || navType === 'navigate') {
            console.log('Clearing caches on normal reload...');
            clearAllCaches();
            forceSwUpdate();
          }
        }
      }

      // Rejestracja Service Workera z obsługą aktualizacji (mniej agresywne na mobile)
      if ('serviceWorker' in navigator) {
        const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent) || 
                         (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1); // iPad na iOS 13+
        
        navigator.serviceWorker.register('service-worker.js')
          .then(registration => {
            console.log('Service Worker registered');
            
            // Sprawdź aktualizacje (mniej agresywne na mobile)
            registration.addEventListener('updatefound', () => {
              const newWorker = registration.installing;
              newWorker.addEventListener('statechange', () => {
                if (newWorker.state === 'installed' && navigator.serviceWorker.controller) {
                  console.log('New SW available');
                  if (!isMobile) {
                    console.log('Reloading for SW update...');
                    window.location.reload();
                  } else {
                    console.log('Mobile detected (iOS/Android), skipping auto-reload for SW update');
                  }
                }
              });
            });
          })
          .catch(err => console.error('SW registration failed:', err));

        // Słuchaj komunikatów od SW (mniej agresywne na mobile)
        navigator.serviceWorker.addEventListener('message', event => {
          if (event.data.type === 'CACHE_UPDATED') {
            console.log('Cache updated');
            if (!isMobile) {
              console.log('Reloading for cache update...');
              window.location.reload();
            } else {
              console.log('Mobile detected (iOS/Android), skipping auto-reload for cache update');
            }
          }
        });
      }

      // Pokaż/ukryj popup
      const emailModal = document.getElementById('emailModal');
      const closeBtn = emailModal.querySelector('.close-button');
      const buyButton = document.getElementById('buy-button');
      const emailForm = document.getElementById('emailForm');
      const successMessage = document.getElementById('success-message');

      buyButton.addEventListener('click', () => {
        emailModal.classList.remove('hidden');
        emailModal.classList.add('visible');
        successMessage.classList.remove('visible'); // ukryj komunikat na otwarciu
        successMessage.classList.add('hidden');
      });

      closeBtn.addEventListener('click', () => {
        emailModal.classList.remove('visible');
        emailModal.classList.add('hidden');
      });

      emailModal.addEventListener('click', (e) => {
        if (e.target === emailModal) {
          emailModal.classList.remove('visible');
          emailModal.classList.add('hidden');
        }
      });

      emailForm.addEventListener('submit', (e) => {
        e.preventDefault();

        // Tutaj wysyłka danych formularza (jeśli masz backend)
        // Można dodać fetch lub EmailJS

        // Po wysłaniu:
        emailModal.classList.remove('visible');
        emailModal.classList.add('hidden');

        successMessage.classList.remove('hidden');
        successMessage.classList.add('visible');

        setTimeout(() => {
          successMessage.classList.remove('visible');
          successMessage.classList.add('hidden');
        }, 3000);

        emailForm.reset(); // wyczyść formularz
      });


      const btn = document.getElementById('dimensions-show');
      if (btn) {
        btn.onclick = (e) => {
          e.preventDefault();
          e.stopPropagation();
          console.log("📐 Kliknięto przycisk wymiarów");
          toggleDimensions();
        };
      }


      // Po inicjalizacji (czyli gdy masz już modele i przyciski):
      document.querySelectorAll(".export-btn").forEach(button => {
        button.addEventListener("click", () => {
          const format = button.getAttribute("data-format");
          handleExport(format);
        });
      });

      // Funkcje instalacji PWA
      window.showInstallInstructions = function() {
        console.log('📱 Showing install instructions...');
        
        // Try to trigger native install prompt first
        if (window.deferredInstallPrompt) {
          window.deferredInstallPrompt.prompt();
          window.deferredInstallPrompt.userChoice.then((choiceResult) => {
            if (choiceResult.outcome === 'accepted') {
              console.log('📱 User accepted the install prompt');
            } else {
              console.log('📱 User dismissed the install prompt');
              // Show manual instructions
              showManualInstallInstructions();
            }
            window.deferredInstallPrompt = null;
          });
        } else {
          // Show manual instructions
          showManualInstallInstructions();
        }
      };

      function showManualInstallInstructions() {
        const modal = document.createElement('div');
        modal.style.cssText = `
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          height: 100%;
          background: rgba(0, 0, 0, 0.7);
          display: flex;
          justify-content: center;
          align-items: center;
          z-index: 10000;
          backdrop-filter: blur(5px);
        `;
        
        modal.innerHTML = `
          <div style="
            background: white;
            border-radius: 16px;
            padding: 24px;
            max-width: 350px;
            width: 90%;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
          ">
            <h3 style="margin: 0 0 16px 0; color: #333;">📱 Instalacja aplikacji</h3>
            
            <div style="text-align: left; margin: 16px 0; padding: 16px; background: #f8f9fa; border-radius: 8px;">
              <p style="margin: 8px 0; font-size: 14px;"><strong>1.</strong> Otwórz w Safari</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>2.</strong> Naciśnij przycisk "Udostępnij" ⬆️</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>3.</strong> Wybierz "Dodaj do ekranu początkowego"</p>
              <p style="margin: 8px 0; font-size: 14px;"><strong>4.</strong> Potwierdź instalację</p>
            </div>
            
            <button onclick="this.parentElement.parentElement.remove()" style="
              background: #007AFF;
              color: white;
              border: none;
              padding: 12px 24px;
              border-radius: 8px;
              font-size: 14px;
              font-weight: 600;
              cursor: pointer;
              margin: 8px;
            ">
              Rozumiem
            </button>
            
            <button onclick="tryAutoInstall()" style="
              background: #F5C842;
              color: #333;
              border: none;
              padding: 12px 24px;
              border-radius: 8px;
              font-size: 14px;
              font-weight: 600;
              cursor: pointer;
              margin: 8px;
            ">
              Spróbuj automatycznie
            </button>
          </div>
        `;
        
        document.body.appendChild(modal);
      }

      // Try auto install
      window.tryAutoInstall = function() {
        console.log('📱 Attempting auto install...');
        
        // Close modal first
        const modal = document.querySelector('div[style*="position: fixed"]');
        if (modal && modal.style.background.includes('rgba(0, 0, 0, 0.7)')) {
          modal.remove();
        }
        
        // Try various install methods
        if (window.BeforeInstallPromptEvent) {
          console.log('📱 Triggering BeforeInstallPromptEvent...');
          window.dispatchEvent(new Event('beforeinstallprompt'));
        }
        
        // Fallback: redirect to add to homescreen
        setTimeout(() => {
          alert('Dotknij przycisku Udostępnij (⬆️) w dolnej części Safari, a następnie "Dodaj do ekranu początkowego"');
        }, 500);
      };

      // Eksport funkcji dla PWA
      window.loadModel = loadModel;
      window.showScreen = showScreen;
      window.renderMobileCategories = renderMobileCategories;
      window.renderMobileModels = renderMobileModels;
      window.renderMobileMainCategories = renderMobileMainCategories;
      window.renderMobileMainModels = renderMobileMainModels;
      window.renderPWACategoryButtons = renderPWACategoryButtons;
      window.allData = allData; // Eksport danych dla PWA
      window.viewer = null; // Będzie ustawione w initApp

  </script>
</body>

</html>