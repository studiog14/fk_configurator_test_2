<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>AR Viewer — model-viewer</title>
  <script type="module" src="https://unpkg.com/@google/model-viewer/dist/model-viewer.min.js"></script>
  <style>
    :root {
      --ui-bg: rgba(20, 20, 20, 0.6);
      --ui-fg: #fff;
      --ui-accent: #00b7ff;
      --tile-size: 48px;
      --radius: 12px;
    }
    html, body { height: 100%; margin: 0; font-family: system-ui, -apple-system, Segoe UI, Roboto, sans-serif; background:#111; color:#fff; }
    model-viewer { width: 100%; height: 100%; background: #000; }
    .topbar, .bottombar { position: fixed; left: 0; right: 0; display: flex; align-items: center; gap: 10px; z-index: 10; }
    .topbar { top: 0; padding: 10px; }
    .bottombar { bottom: 0; padding: 10px; justify-content: center; }
    .panel { background: var(--ui-bg); backdrop-filter: blur(6px); border: 1px solid rgba(255,255,255,0.08); border-radius: var(--radius); padding: 8px 10px; display: flex; align-items: center; gap: 10px; }
    .chip { background: var(--ui-bg); border: 1px solid rgba(255,255,255,0.08); border-radius: var(--radius); padding: 8px 12px; font-weight: 600; }
    .tile { width: var(--tile-size); height: var(--tile-size); display: inline-flex; align-items: center; justify-content: center; border-radius: 10px; background: #1e1e1e; border: 1px solid rgba(255,255,255,0.08); cursor: pointer; }
    .tile img { width: 28px; height: 28px; filter: invert(1); opacity: 0.95; }
    .spacer { flex: 1; }
    .hidden { display: none !important; }
    .toast { position: fixed; bottom: 90px; left: 50%; transform: translateX(-50%); background: #222; color:#fff; padding: 10px 14px; border-radius: 999px; border: 1px solid rgba(255,255,255,0.1); z-index: 20; opacity: 0.95; }
    .ar-note { position: fixed; top: 60px; left: 50%; transform: translateX(-50%); background: #312; color: #fff; padding: 10px 14px; border-radius: 10px; border: 1px solid rgba(255,255,255,0.12); z-index: 20; }
    .arButton { background: var(--ui-accent); color: #001018; padding: 10px 14px; border-radius: 10px; border: none; font-weight: 700; cursor: pointer; }
  </style>
</head>
<body>
  <div class="topbar">
    <div class="panel" id="titlePanel">
      <img src="icons/back_arrow.png" alt="Wróć" class="tile" id="backBtn" style="width:40px;height:40px;padding:6px;" />
      <div id="title" class="chip">AR Viewer</div>
    </div>
    <div class="spacer"></div>
    <div class="panel">
      <button id="arEnterBtn" class="arButton">Wejdź do AR</button>
    </div>
  </div>

  <model-viewer id="mv"
    src=""
    alt="Model 3D"
    ar
    ar-modes="scene-viewer webxr quick-look"
    ar-placement="floor"
    ar-scale="fixed"
    shadow-intensity="0.8"
    camera-controls
    exposure="0.9"
    environment-image="hdr/cayley_interior_1k.hdr"
    autoplay
    xr-session-init='{"optionalFeatures":["dom-overlay","unbounded"],"requiredFeatures":["hit-test"],"domOverlay":{"root":"#arDomOverlay"}}'>
    <button slot="ar-button" id="mvArButton" class="arButton">Otwórz w AR</button>
  </model-viewer>

  <div id="arDomOverlay" class="bottombar">
    <div class="panel" style="gap:12px">
      <div class="tile" id="rotateLeft"><img src="icons/legs_obrotowe_icon.jpg" alt="Obróć" /></div>
      <div class="tile" id="rotateRight"><img src="icons/legs_obrotowe_icon.jpg" alt="Obróć" style="transform: scaleX(-1)"/></div>
      <div class="tile" id="scaleMinus"><img src="icons/minus.png" alt="-" /></div>
      <div class="tile" id="scalePlus"><img src="icons/plus.png" alt="+" /></div>
      <div class="tile" id="screenshot" title="Zrzut ekranu"><img src="icons/export_icon.png" alt="Shot" /></div>
    </div>
  </div>

  <div id="toast" class="toast hidden"></div>
  <div id="arNote" class="ar-note hidden"></div>

  <script>
    function qs(name, def = '') {
      const u = new URL(window.location.href);
      return u.searchParams.get(name) ?? def;
    }
    function isIOS() {
      return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
    }
    function showToast(msg, ms = 1800) {
      const t = document.getElementById('toast');
      t.textContent = msg; t.classList.remove('hidden');
      setTimeout(() => t.classList.add('hidden'), ms);
    }

    const mv = document.getElementById('mv');
    const title = document.getElementById('title');
    const backBtn = document.getElementById('backBtn');
    const arEnterBtn = document.getElementById('arEnterBtn');
    const arNote = document.getElementById('arNote');

    const model = qs('model', 'chairs/Tulla-2.glb');
    const usdz = qs('usdz', '');
    const name = qs('name', 'Model 3D');
    const ret = qs('ret', 'index.html');

    title.textContent = name;
    mv.src = model;
    if (usdz) mv.setAttribute('ios-src', usdz);

    backBtn.addEventListener('click', () => {
      if (ret) window.location.href = ret; else history.back();
    });

    arEnterBtn.addEventListener('click', () => {
      // Trigger model-viewer's AR button
      document.getElementById('mvArButton').click();
    });

    // iOS guidance if no USDZ
    function updateIOSNote() {
      if (isIOS() && !usdz) {
        arNote.textContent = 'Na iOS (Quick Look) wymagany jest plik USDZ. Dla tego modelu AR może nie działać.';
        arNote.classList.remove('hidden');
      } else {
        arNote.classList.add('hidden');
      }
    }
    updateIOSNote();

    // Controls
    const ROT_STEP = Math.PI / 16;
    const SCALE_STEP = 0.05;

    document.getElementById('rotateLeft').addEventListener('click', () => {
      mv.rotation = `${mv.rotation.x || 0} ${((mv.rotation?.y)||0) - ROT_STEP} ${mv.rotation.z || 0}`;
    });
    document.getElementById('rotateRight').addEventListener('click', () => {
      mv.rotation = `${mv.rotation.x || 0} ${((mv.rotation?.y)||0) + ROT_STEP} ${mv.rotation.z || 0}`;
    });
    document.getElementById('scalePlus').addEventListener('click', () => {
      const s = mv.scale ?? {x:1,y:1,z:1};
      const nx = Math.min(3, s.x + SCALE_STEP);
      mv.scale = `${nx} ${nx} ${nx}`;
      showToast(`Skala: ${(nx*100)|0}%`);
    });
    document.getElementById('scaleMinus').addEventListener('click', () => {
      const s = mv.scale ?? {x:1,y:1,z:1};
      const nx = Math.max(0.3, s.x - SCALE_STEP);
      mv.scale = `${nx} ${nx} ${nx}`;
      showToast(`Skala: ${(nx*100)|0}%`);
    });

    // Screenshot (2D viewer mode only)
    document.getElementById('screenshot').addEventListener('click', async () => {
      try {
        const blob = await mv.toBlob({idealAspect: true});
        const url = URL.createObjectURL(blob);
        const a = document.createElement('a');
        a.href = url; a.download = `${name.replace(/\s+/g,'_')}.png`;
        document.body.appendChild(a); a.click(); a.remove();
        URL.revokeObjectURL(url);
      } catch (e) {
        showToast('Zrzut niedostępny w tym trybie');
      }
    });

    // Reflect AR support (show/hide AR button)
    function reflectARSupport() {
      const supportsAR = mv.canActivateAR;
      arEnterBtn.classList.toggle('hidden', !supportsAR);
    }
    mv.addEventListener('load', reflectARSupport);
    reflectARSupport();
  </script>
</body>
</html>
