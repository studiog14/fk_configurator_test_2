<!DOCTYPE html>
<!-- Mobile Version - Same functionality as desktop but optimized for mobile devices -->
<html lang="pl">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, shrink-to-fit=no" />
  <meta name="mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
  <meta name="format-detection" content="telephone=no" />
  <title>Konfigurator krzeseł - Fajne Krzesła</title>
  <link rel="icon" href="icons/favicon.png" type="image/jpeg" />
  <link rel="manifest" href="manifest.json" />

  <!-- iOS PWA Meta Tags -->
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="default" />
  <meta name="apple-mobile-web-app-title" content="FK Krzesła" />
  <link rel="apple-touch-icon" href="icons/favicon.png" />

  <meta http-equiv="cache-control" content="no-cache, no-store, must-revalidate" />
  <meta http-equiv="pragma" content="no-cache" />
  <meta http-equiv="expires" content="0" />

  <!-- Cache buster for welcome screen fix -->
  <meta name="timestamp" content="2025-08-09-12:00" />

  <!-- Note: Using native import maps for modern browsers; mobile fallbacks handled in ios-fallback.js -->
  <script src="ios-fallback.js?v=2025080912"></script>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet" />
  <script type="importmap">
{
  "imports": {
    "threepipe": "https://unpkg.com/threepipe@0.0.50/dist/index.mjs",
    "@threepipe/webgi-plugins": "https://unpkg.com/@threepipe/webgi-plugins@0.5.0/dist/index.mjs",
    "three": "https://unpkg.com/three@0.157.0/build/three.module.js"
  }
}
</script>

  <style>
    /* Mobile-first approach - optimized for mobile devices */
    html, body {
      margin: 0;
      padding: 0;
      width: 100%;
      height: 100%;
      overflow: hidden;
      font-family: 'Poppins', sans-serif;
      /* Mobile viewport height fix */
      --vh: 1vh;
    }

    /* Dynamic viewport height for mobile browsers */
    @media (max-width: 1024px) {
      html, body {
        height: calc(var(--vh, 1vh) * 100);
      }
    }

    #app {
      display: flex;
      height: 100vh;
      width: 100vw;
      position: relative;
      visibility: hidden;
      flex-direction: column; /* Mobile: stack vertically */
    }

    #app.visible {
      visibility: visible;
      opacity: 1;
    }

    /* Canvas takes most of the screen on mobile */
    #canvas-container {
      flex: 1;
      position: relative;
      height: calc(100vh - 140px); /* Leave space for bottom UI */
      width: 100%;
      background: #ededed15;
    }

    #canvas {
      width: 100%;
      height: 100%;
      display: block;
      touch-action: manipulation;
    }

    /* Mobile sidebar - positioned at bottom like mobile apps */
    #sidebar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      height: 140px; /* Fixed height for bottom panel */
      background: #fff;
      border-top: 1px solid rgba(0, 0, 0, 0.08);
      box-shadow: 0 -4px 32px rgba(0, 0, 0, 0.10);
      z-index: 1200;
      padding: 12px;
      box-sizing: border-box;
      overflow: hidden;
    }

    /* Mobile category buttons - horizontal scroll */
    #category-buttons {
      margin-bottom: 12px;
      display: flex;
      gap: 8px;
      overflow-x: auto;
      padding: 4px 0;
    }

    #special-categories-container {
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      min-width: max-content;
    }

    #category-buttons-container {
      display: flex;
      flex-wrap: nowrap;
      gap: 8px;
      min-width: max-content;
    }

    /* Mobile category buttons - touch friendly */
    .category-button {
      padding: 10px 16px;
      font-size: 13px;
      border-radius: 20px;
      border: 2px solid #F5C842;
      background: white;
      color: #333;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      text-transform: capitalize;
      white-space: nowrap;
      min-width: auto;
      flex: 0 0 auto;
    }

    .category-button:hover {
      background: #F5C842;
      color: white;
      transform: translateY(-1px);
    }

    .category-button.active {
      background: #F5C842;
      color: white;
    }

    .category-button.promotion {
      border-color: #FF6B6B;
      color: #FF6B6B;
    }

    .category-button.promotion:hover,
    .category-button.promotion.active {
      background: #FF6B6B;
      color: white;
    }

    /* Mobile model section - horizontal scroll with larger thumbnails */
    #model-section {
      display: none; /* Hidden by default, shown when active */
    }

    #model-section.active {
      display: block;
    }

    #model-section .options-grid {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding: 8px 0;
      scroll-snap-type: x mandatory;
    }

    /* Mobile model thumbnails - larger for touch */
    .thumbnail-wrapper {
      flex: 0 0 auto;
      width: 120px;
      text-align: center;
    }

    .thumbnail {
      width: 100px;
      height: 100px;
      border-radius: 12px;
      border: 2px solid #ddd;
      background: #fff;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 0 auto 6px auto;
      scroll-snap-align: center;
    }

    .thumbnail:hover {
      transform: scale(1.05);
      border-color: #F5C842;
      box-shadow: 0 4px 12px rgba(245, 200, 66, 0.3);
    }

    .thumbnail.selected {
      border-color: #F5C842;
      box-shadow: 0 0 0 3px rgba(245, 200, 66, 0.4);
    }

    .thumbnail img {
      max-width: 90%;
      max-height: 90%;
      object-fit: contain;
    }

    .thumbnail-caption {
      font-size: 11px;
      color: #555;
      font-weight: 500;
      line-height: 1.2;
      display: -webkit-box;
      -webkit-line-clamp: 2;
      -webkit-box-orient: vertical;
      overflow: hidden;
    }

    /* Mobile config section - slide up from bottom */
    #config-section {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 140px; /* Leave space for bottom panel */
      background: #fff;
      z-index: 1300;
      overflow-y: auto;
      padding: 16px;
      box-shadow: 0 -4px 32px rgba(0, 0, 0, 0.15);
    }

    #config-section.active {
      display: block;
    }

    /* Mobile part tabs - horizontal scroll */
    #part-tabs {
      display: flex;
      gap: 12px;
      overflow-x: auto;
      padding: 8px 0;
      margin-bottom: 16px;
    }

    #part-tabs .thumbnail {
      width: 70px;
      height: 70px;
      border-radius: 10px;
      font-size: 10px;
      padding: 8px;
    }

    /* Mobile materials section */
    #materials-section {
      display: block;
      visibility: visible;
      opacity: 1;
    }

    .collection-accordion-group {
      margin-bottom: 16px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e3e3e3;
      border-radius: 12px;
      background: #fff;
      padding: 8px;
    }

    .collection-header {
      padding: 8px 12px;
      font-weight: 600;
      font-size: 12px;
      background: linear-gradient(135deg,#F5C842,#E5B432);
      color: #222;
      border-radius: 8px;
      margin-bottom: 8px;
      text-align: center;
    }

    .collection-materials-row {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(60px, 1fr));
      gap: 8px;
      padding: 4px;
    }

    .collection-materials-row .thumbnail {
      width: 60px;
      height: 60px;
      border: 2px solid #eee;
      border-radius: 8px;
      background: #fafafa;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .collection-materials-row .thumbnail:hover {
      border-color: #F5C842;
      transform: scale(1.05);
    }

    .collection-materials-row .thumbnail.selected {
      border-color: #F5C842;
      box-shadow: 0 0 0 2px rgba(245,200,66,.4);
      background: #fffbe6;
    }

    /* Mobile bottom toolbar - floating above content */
    #bottom-toolbar {
      position: fixed;
      bottom: 150px; /* Above the sidebar */
      left: 50%;
      transform: translateX(-50%);
      background: #fff;
      border: 1.5px solid #ccc;
      border-radius: 16px;
      padding: 8px;
      display: flex;
      gap: 12px;
      z-index: 2000;
      box-shadow: 0 4px 20px rgba(0, 0, 0, 0.15);
      opacity: 0;
      transition: opacity 0.4s ease;
    }

    #bottom-toolbar.visible {
      opacity: 1;
    }

    #bottom-toolbar button {
      width: 40px;
      height: 40px;
      border: none;
      border-radius: 8px;
      background: #f0f0f0;
      cursor: pointer;
      transition: background 0.2s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    #bottom-toolbar button:hover {
      background: #e0e0e0;
    }

    #bottom-toolbar img {
      width: 20px;
      height: 20px;
    }

    /* Mobile config overview button */
    #config-overview-button {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: linear-gradient(135deg, #F5C842, #E5B432);
      color: #333;
      border: none;
      border-radius: 25px;
      padding: 12px 24px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 4px 15px rgba(245, 200, 66, 0.4);
      transition: all 0.3s ease;
      z-index: 2000;
      display: none;
    }

    #config-overview-button:hover {
      transform: translateX(-50%) scale(1.05);
      background: linear-gradient(135deg, #E5B432, #D1A029);
    }

    /* Mobile popups - centered and responsive */
    #config-overview-popup {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.5);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 3000;
      padding: 20px;
    }

    #config-overview-popup .popup-content {
      background: #fff;
      border-radius: 16px;
      padding: 20px;
      max-width: 400px;
      width: 90%;
      max-height: 80vh;
      overflow-y: auto;
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
    }

    /* Mobile dimension overlay */
    #dimension-overlay {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 90vw;
      max-width: 320px;
      background: #fff;
      border: 1.5px solid #ccc;
      border-radius: 12px;
      padding: 16px;
      z-index: 2100;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
    }

    /* Mobile AR popup */
    #ar-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.2);
      text-align: center;
      max-width: 300px;
      width: 90%;
      z-index: 9999;
    }

    /* Mobile QR popup */
    #qr-popup {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.2);
      text-align: center;
      max-width: 300px;
      width: 90%;
      z-index: 9999;
    }

    /* Mobile email modal */
    #emailModal .modal-content {
      width: 90%;
      max-width: 400px;
      margin: 0 auto;
      transform: none;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }

    /* Mobile success message */
    #success-message {
      position: fixed;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: #ffffff;
      border: 1.5px solid #1f1f1f;
      color: #1f1f1f;
      font-weight: 700;
      font-family: "Poppins", sans-serif;
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 8px 32px rgba(3, 3, 3, 0.15);
      max-width: 320px;
      width: 90%;
      text-align: center;
      z-index: 9999;
    }

    /* Mobile welcome screen */
    #welcome-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 100;
      font-family: 'Poppins', Arial, sans-serif;
      text-align: center;
      padding: 20px;
      overflow-y: auto;
      box-sizing: border-box;
    }

    #welcome-logo {
      max-width: 150px;
      height: auto;
      margin-bottom: 20px;
    }

    #welcome-screen h1 {
      font-size: 2em;
      font-weight: 600;
      color: #333;
      margin: 0 0 15px 0;
    }

    #welcome-screen p {
      font-size: 1em;
      color: #666;
      max-width: 300px;
      line-height: 1.5;
      margin: 0 0 20px 0;
    }

    /* Mobile loader */
    #custom-loader, #model-loader {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #fff;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      font-family: 'Poppins', Arial, sans-serif;
    }

    /* Mobile rotation overlay */
    #rotation-overlay {
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      font-family: 'Poppins', Arial, sans-serif;
      text-align: center;
      padding: 20px;
    }

    @media (max-width: 1024px) and (orientation: portrait) {
      #rotation-overlay {
        display: flex !important;
      }
    }

    /* Hide desktop-specific elements on mobile */
    #rotation-message,
    #export-panel,
    #mobile-right-panel,
    #mobile-ui-container,
    #standalone-mobile-ui {
      display: none !important;
    }

    /* Mobile-specific enhancements */
    .mobile-only {
      display: block !important;
    }

    /* Touch-friendly interactions */
    @media (hover: none) {
      .thumbnail:hover {
        transform: none;
      }

      .category-button:hover {
        transform: none;
      }
    }

    /* Very small phones */
    @media (max-width: 380px) {
      #sidebar {
        height: 120px;
      }

      #canvas-container {
        height: calc(100vh - 120px);
      }

      #bottom-toolbar {
        bottom: 130px;
      }

      .thumbnail {
        width: 80px;
        height: 80px;
      }

      .category-button {
        padding: 8px 12px;
        font-size: 12px;
      }
    }

    /* Hide search functionality on mobile */
    #search-toggle,
    #search-panel,
    #search-input,
    #search-results,
    #search-container,
    #search-filter-indicator {
      display: none !important;
      visibility: hidden !important;
      opacity: 0 !important;
    }

    /* Mobile PWA success screen */
    #pwa-success-screen {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: #fff;
      display: none;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 2147483648;
      font-family: 'Poppins', Arial, sans-serif;
      text-align: center;
      padding: 20px;
      overflow-y: auto;
    }

    #pwa-success-screen.show {
      display: flex;
    }

    /* Mobile back button */
    #back-to-models-container {
      display: flex;
      align-items: center;
      margin-bottom: 12px;
      justify-content: center;
    }

    .back-to-model-btn {
      width: 80px;
      height: 80px;
      border: 1.5px solid #bbb;
      border-radius: 12px;
      background: #fff;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      transition: box-shadow 0.2s;
    }

    .back-to-model-btn:hover {
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
    }

    .back-to-model-btn img {
      width: 70px;
      height: 70px;
      object-fit: contain;
    }

    /* Mobile brightness panel */
    #brightness-panel {
      position: absolute;
      top: 50%;
      right: 100%;
      transform: translate(-15px, -50%);
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
      padding: 8px 0;
      width: 40px;
      height: 120px;
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1005;
    }

    #brightness-panel.hidden {
      display: none;
    }

    /* Mobile HDR panel */
    #hdr-panel {
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%) translateY(-8px);
      background: #fff;
      border-radius: 12px;
      padding: 12px;
      box-shadow: 0 6px 24px rgba(0, 0, 0, 0.15);
      z-index: 9999;
      min-width: 200px;
      display: none;
    }

    /* Mobile animations */
    @keyframes logoPulse {
      0%, 100% { opacity: 0.9; transform: scale(1); }
      50% { opacity: 1; transform: scale(1.05); }
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @keyframes progressSlide {
      0% { transform: translateX(-100%); }
      50% { transform: translateX(0%); }
      100% { transform: translateX(100%); }
    }

    .loader {
      border: 6px solid #f3f3f3;
      border-top: 6px solid #555;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      display: inline-block;
      margin-bottom: 12px;
    }

    @keyframes rotatePhone {
      0% { transform: rotate(0deg); }
      25% { transform: rotate(-15deg); }
      75% { transform: rotate(15deg); }
      100% { transform: rotate(0deg); }
    }

    /* Mobile-specific utility classes */
    .mobile-hidden { display: none !important; }
    .mobile-visible { display: block !important; }
    .mobile-flex { display: flex !important; }
    .mobile-grid { display: grid !important; }

    /* Safe area insets for iOS devices */
    @supports (padding: max(0px)) {
      #sidebar {
        padding-bottom: calc(12px + env(safe-area-inset-bottom));
      }
      #bottom-toolbar {
        bottom: calc(150px + env(safe-area-inset-bottom));
      }
      #config-overview-button {
        bottom: calc(20px + env(safe-area-inset-bottom));
      }
    }
  </style>
</head>

<body>
  <!-- Mobile device detection script -->
  <script>
    console.log('📱 Mobile version loading...');

    // Mobile detection
    (function() {
      const ua = navigator.userAgent || '';
      const isIOS = /iPad|iPhone|iPod/.test(ua) || (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const isAndroid = /Android/.test(ua);
      const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(ua) ||
                       (navigator.platform === 'MacIntel' && navigator.maxTouchPoints > 1);
      const hasTouch = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
      const isNarrow = window.innerWidth <= 1024;

      window.isMobileDevice = isMobile || hasTouch || isNarrow;
      window.isIOSDevice = isIOS;
      window.isAndroidDevice = isAndroid;

      console.log('📱 Device detection:', {
        isMobile,
        isIOS,
        isAndroid,
        hasTouch,
        isNarrow,
        userAgent: ua.substring(0, 50),
        final: window.isMobileDevice
      });

      // Add mobile class to body for CSS targeting
      if (window.isMobileDevice) {
        document.body.classList.add('mobile-device');
        document.documentElement.classList.add('mobile');
      }

      // Dynamic viewport height fix for mobile browsers
      function setVh() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', vh + 'px');
      }

      setVh();
      window.addEventListener('resize', setVh);
      window.addEventListener('orientationchange', () => {
        setTimeout(setVh, 100);
      });
    })();

    // Mobile rotation handler
    function checkRotation() {
      const overlay = document.getElementById('rotation-overlay');
      if (!overlay) return;

      const isMobile = window.innerWidth <= 1024;
      const isPortrait = window.innerHeight > window.innerWidth;

      if (isMobile && isPortrait) {
        overlay.style.display = 'flex';
      } else {
        overlay.style.display = 'none';
      }
    }

    window.addEventListener('load', () => {
      setTimeout(checkRotation, 100);
    });

    window.addEventListener('resize', checkRotation);
    window.addEventListener('orientationchange', () => {
      setTimeout(checkRotation, 200);
    });
  </script>

  <!-- Mobile rotation prompt -->
  <div id="rotation-overlay" style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100vw;
      height: 100vh;
      background: linear-gradient(135deg, #FFD700 0%, #FFA500 100%);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      z-index: 99999;
      font-family: 'Poppins', Arial, sans-serif;
      text-align: center;
      padding: 20px;
      box-sizing: border-box;
  ">
    <div style="
        font-size: 80px;
        margin-bottom: 30px;
        animation: rotatePhone 2s ease-in-out infinite;
        filter: drop-shadow(0 4px 8px rgba(0,0,0,0.3));
    ">📱</div>

    <h2 style="
        color: #333;
        font-size: 28px;
        font-weight: 700;
        margin: 0 0 15px 0;
        text-shadow: 0 2px 4px rgba(0,0,0,0.1);
    ">Obróć telefon</h2>

    <p style="
        color: #555;
        font-size: 18px;
        line-height: 1.4;
        max-width: 350px;
        margin: 0;
        opacity: 0.9;
    ">Dla najlepszego doświadczenia użyj orientacji poziomej</p>
  </div>

  <!-- Mobile loader -->
  <div id="custom-loader">
    <div style="
        position: relative;
        margin-bottom: 40px;
        animation: logoPulse 3s ease-in-out infinite;
    ">
      <img src="icons/FK_logo.png" alt="Fajne Krzesła" style="
          max-width: 150px;
          height: auto;
          border-radius: 10px;
          opacity: 0.9;
      " />
    </div>

    <div class="loader"></div>

    <div style="
        width: 200px;
        height: 3px;
        background: #f0f0f0;
        border-radius: 2px;
        overflow: hidden;
        margin-bottom: 25px;
    ">
      <div style="
          width: 100%;
          height: 100%;
          background: #FFD700;
          animation: progressSlide 2s ease-in-out infinite;
      "></div>
    </div>

    <div style="
        font-size: 16px;
        color: #333;
        font-weight: 500;
        text-align: center;
        letter-spacing: 0.5px;
    ">Inicjalizacja konfiguratora...</div>
  </div>

  <!-- Model loader -->
  <div id="model-loader" style="display: none;">
    <div style="
        position: relative;
        margin-bottom: 30px;
        animation: logoPulse 3s ease-in-out infinite;
    ">
      <img src="icons/FK_logo.png" alt="Fajne Krzesła" style="
          max-width: 120px;
          height: auto;
          border-radius: 10px;
          opacity: 0.9;
      " />
    </div>

    <div class="loader"></div>

    <p>Ładowanie modelu...</p>
  </div>

  <div id="app">
    <!-- Canvas container -->
    <div id="canvas-container">
      <canvas id="canvas"></canvas>

      <!-- Mobile welcome screen -->
      <div id="welcome-screen">
        <img id="welcome-logo" src="icons/FK_logo.png" alt="Fajne Krzesła">
        <h1>Konfigurator Krzeseł</h1>
        <p>Wybierz kategorię oraz model krzesła z dolnego panelu, aby rozpocząć konfigurację w 3D</p>
        <p style="font-size: 14px; color: #666; margin-top: 10px;">
          Możesz również zapoznać się z naszymi promocjami i bestsellerami
        </p>

        <button onclick="showInstallInstructions()" style="
          background: linear-gradient(135deg, #F5C842, #E5B432);
          color: #333;
          border: none;
          padding: 12px 24px;
          border-radius: 25px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          box-shadow: 0 4px 15px rgba(245, 200, 66, 0.4);
          transition: all 0.3s ease;
          margin: 10px;
        " onmouseover="this.style.transform='scale(1.05)'; this.style.background='linear-gradient(135deg, #E5B432, #D1A029)'" onmouseout="this.style.transform='scale(1)'; this.style.background='linear-gradient(135deg, #F5C842, #E5B432)'">
          📱 Zainstaluj aplikację
        </button>

        <button id="welcome-continue-btn" style="
          background: #007AFF;
          color: white;
          border: none;
          padding: 12px 24px;
          border-radius: 25px;
          font-size: 14px;
          font-weight: 600;
          cursor: pointer;
          box-shadow: 0 4px 15px rgba(0, 122, 255, 0.4);
          transition: all 0.3s ease;
          margin: 10px;
        " onmouseover="this.style.transform='scale(1.05)'; this.style.background='#0056D6'" onmouseout="this.style.transform='scale(1)'; this.style.background='#007AFF'">
          Kontynuuj do aplikacji
        </button>
      </div>
    </div>

    <!-- Mobile bottom sidebar -->
    <div id="sidebar">
      <!-- Category buttons section -->
      <div id="category-buttons" style="margin-bottom: 12px;">
        <div id="special-categories-container" style="display: flex; gap: 8px; margin-bottom: 8px; overflow-x: auto; padding: 2px 0;"></div>
        <div id="category-buttons-container" style="display: flex; gap: 8px; overflow-x: auto; padding: 2px 0;"></div>
      </div>

      <!-- Model selection (shown when category is selected) -->
      <div id="model-section" class="mobile-only">
        <div class="options-grid" style="display: flex; gap: 12px; overflow-x: auto; padding: 4px 0;"></div>
      </div>

      <!-- Config section (shown when model is selected) -->
      <div id="config-section" class="mobile-only">
        <div id="back-to-models-container" style="margin-bottom: 12px;"></div>
        <div id="part-tabs" style="display: flex; gap: 8px; overflow-x: auto; margin-bottom: 12px;"></div>
        <div id="materials-section">
          <div id="material-options"></div>
        </div>
      </div>
    </div>

    <!-- Mobile bottom toolbar -->
    <div id="bottom-toolbar">
      <button id="hdr-toggle" title="Zmień HDR">
        <img src="icons/bulb_icon.png" alt="HDR" style="width: 20px; height: 20px;">
      </button>

      <div id="hdr-panel" class="hidden">
        <button id="hdr-close" class="hdr-close-btn">×</button>
        <div id="hdr-options"></div>
      </div>

      <div id="brightness-panel" class="hidden">
        <input type="range" id="brightness-slider" min="0.2" max="2.0" step="0.1" value="1.0" orient="vertical">
        <div style="width: 16px; height: 16px; margin-top: 8px;">
          <svg width="12" height="12" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="4" stroke="#666" stroke-width="1.5" fill="none"/>
            <path d="M12 2v2M12 20v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2M20 12h2M6.34 6.34L4.93 4.93M19.07 19.07l-1.41-1.41" stroke="#666" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
        </div>
      </div>

      <button id="ar-button" title="AR">
        <img src="icons/AR_icon.png" alt="AR" style="width: 20px; height: 20px;">
      </button>

      <button id="dimensions-show" title="Wymiary modelu">
        <img src="icons/dimmension_icon.png" alt="Wymiary" style="width: 20px; height: 20px;">
      </button>

      <button id="qr-button" title="Zobacz na telefonie">
        <img src="icons/qr_icon.png" alt="QR" style="width: 20px; height: 20px;">
      </button>
    </div>

    <!-- Mobile config overview button -->
    <div id="config-overview-button">
      <span>🛒</span>
      <span>Twoja konfiguracja</span>
    </div>

    <!-- Mobile config overview popup -->
    <div id="config-overview-popup">
      <div class="popup-content">
        <button id="config-popup-close" style="
          position: absolute;
          top: 12px;
          right: 16px;
          background: none;
          border: none;
          font-size: 24px;
          color: #666;
          cursor: pointer;
          width: 30px;
          height: 30px;
          display: flex;
          align-items: center;
          justify-content: center;
          border-radius: 50%;
        ">×</button>

        <h3 style="margin: 0 0 20px 0; font-size: 20px; font-weight: 600; color: #333; text-align: center;">
          Twoja konfiguracja
        </h3>

        <div id="popup-overview-icons" style="
          display: flex;
          flex-wrap: wrap;
          gap: 12px;
          margin-bottom: 20px;
          justify-content: center;
        "></div>

        <div id="popup-overview-details" style="
          border-top: 1px solid #eee;
          padding-top: 16px;
          margin-bottom: 16px;
        "></div>

        <div style="
          background: rgba(245, 200, 66, 0.1);
          border: 1px solid #F5C842;
          border-radius: 12px;
          padding: 16px;
          text-align: center;
          margin-bottom: 20px;
        ">
          <div id="popup-total-original" style="display: none; color: #666; text-decoration: line-through; font-size: 14px; margin-bottom: 4px;"></div>
          <div style="font-size: 18px; font-weight: 700; color: #333;">
            Suma: <span id="popup-overview-total-price">0.00 PLN</span>
          </div>
          <div id="popup-discount-info" style="display: none; color: #FF6B6B; font-size: 12px; font-weight: 600; margin-top: 4px;"></div>
        </div>

        <button id="popup-buy-button" style="
          width: 100%;
          padding: 14px 0;
          background: white;
          color: #333;
          border: 2px solid #F5C842;
          border-radius: 8px;
          font-size: 16px;
          font-weight: 600;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 10px;
          cursor: pointer;
          transition: all 0.2s ease;
        ">
          <span>🛒</span>Zamów
        </button>
      </div>
    </div>

    <!-- Mobile dimension overlay -->
    <div id="dimension-overlay" style="display: none;">
      <div class="dimension-panel-header" style="
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
        padding-bottom: 8px;
        border-bottom: 1px solid #eee;
      ">
        <div style="font-size: 16px; font-weight: 600; color: #333;">Wymiary modelu</div>
        <button class="dimension-close-btn" onclick="document.getElementById('dimension-overlay').style.display='none'" style="
          background: #f0f0f0;
          border: none;
          border-radius: 6px;
          width: 24px;
          height: 24px;
          cursor: pointer;
          font-size: 16px;
          color: #666;
        ">×</button>
      </div>
      <div class="dimensions-container" style="
        display: flex;
        flex-direction: column;
        gap: 8px;
      "></div>
    </div>

    <!-- Mobile AR popup -->
    <div id="ar-popup">
      <img src="icons/AR_icon.png" alt="AR Ikona" style="width: 60px; margin-bottom: 10px;" />
      <div style="font-size: 18px; font-weight: bold;">Tryb AR dostępny wkrótce</div>
      <div style="margin-top: 6px; font-size: 14px;">Funkcja zostanie uruchomiona niebawem.</div>
      <button onclick="closeArPopup()" style="
        margin-top: 12px;
        background: #141414;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
      ">Zamknij</button>
    </div>

    <!-- Mobile QR popup -->
    <div id="qr-popup">
      <p style="margin-bottom:10px;">Zeskanuj kod QR telefonem:</p>
      <div id="qrcode" style="width: 120px; height: 120px; margin: 0 auto 10px auto;"></div>
      <button id="qr-close-btn" style="
        margin-top: 12px;
        background: #141414;
        color: white;
        border: none;
        padding: 6px 12px;
        border-radius: 6px;
        cursor: pointer;
      ">Zamknij</button>
    </div>
  </div>

  <!-- Mobile email modal -->
  <div id="emailModal" class="modal hidden">
    <div style="
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 10000;
    ">
      <div class="modal-content" style="
        background: white;
        border-radius: 16px;
        box-shadow: 0 20px 40px rgba(0,0,0,0.3);
        max-width: 400px;
        width: 90%;
        max-height: 80vh;
        overflow-y: auto;
        position: relative;
        margin: 20px;
      ">
        <button class="close-button" style="
          position: absolute;
          top: 16px;
          right: 16px;
          background: none;
          border: none;
          font-size: 24px;
          cursor: pointer;
          color: #666;
          z-index: 1;
        ">&times;</button>

        <div style="padding: 24px 24px 0 24px; text-align: center;">
          <h2 style="margin: 0 0 8px 0; font-size: 24px; font-weight: 700; color: #333;">Złóż zamówienie</h2>
          <p style="margin: 0 0 20px 0; color: #666; font-size: 14px;">Wypełnij formularz, a skontaktujemy się z Tobą</p>
        </div>

        <div id="order-summary-icons" style="
          padding: 0 24px 16px 24px;
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
          flex-wrap: wrap;
        "></div>

        <form id="emailForm" style="padding: 0 24px 24px 24px;">
          <div style="margin-bottom: 16px;">
            <label for="name" style="display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px;">Imię i nazwisko:</label>
            <input type="text" id="name" name="name" required style="
              width: 100%;
              padding: 12px;
              border: 2px solid #e0e0e0;
              border-radius: 8px;
              font-size: 16px;
              box-sizing: border-box;
            ">
          </div>

          <div style="margin-bottom: 16px;">
            <label for="email" style="display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px;">Adres e-mail:</label>
            <input type="email" id="email" name="email" required style="
              width: 100%;
              padding: 12px;
              border: 2px solid #e0e0e0;
              border-radius: 8px;
              font-size: 16px;
              box-sizing: border-box;
            ">
            <input type="hidden" id="to_email" name="to_email">
          </div>

          <div style="margin-bottom: 16px;">
            <label for="phone" style="display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px;">Numer telefonu:</label>
            <input type="tel" id="phone" name="phone" style="
              width: 100%;
              padding: 12px;
              border: 2px solid #e0e0e0;
              border-radius: 8px;
              font-size: 16px;
              box-sizing: border-box;
            ">
          </div>

          <div style="margin-bottom: 16px;">
            <label for="address" style="display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px;">Adres:</label>
            <input type="text" id="address" name="address" style="
              width: 100%;
              padding: 12px;
              border: 2px solid #e0e0e0;
              border-radius: 8px;
              font-size: 16px;
              box-sizing: border-box;
            " placeholder="Ulica, numer domu, kod pocztowy, miasto">
          </div>

          <div style="margin-bottom: 20px;">
            <label for="message" style="display: block; margin-bottom: 6px; font-weight: 600; color: #333; font-size: 14px;">Wiadomość (opcjonalnie):</label>
            <textarea id="message" name="message" rows="3" style="
              width: 100%;
              padding: 12px;
              border: 2px solid #e0e0e0;
              border-radius: 8px;
              font-size: 16px;
              resize: vertical;
              font-family: inherit;
              box-sizing: border-box;
            " placeholder="Dodatkowe uwagi do zamówienia..."></textarea>
          </div>

          <input type="hidden" id="model" name="model">
          <input type="hidden" id="price" name="price">
          <input type="hidden" id="total" name="total">

          <button type="submit" style="
            width: 100%;
            padding: 16px;
            background: white;
            color: #333;
            border: 2px solid #F5C842;
            border-radius: 12px;
            font-size: 18px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
          ">
            Wyślij zamówienie
          </button>
        </form>
      </div>
    </div>
  </div>

  <!-- Mobile success message -->
  <div id="success-message" class="hidden">
    🟡 Dziękujemy za złożenie zamówienia! Kopia wiadomości została wysłana na Twój email.
  </div>

  <!-- Mobile PWA success screen -->
  <div id="pwa-success-screen">
    <img id="success-logo" src="icons/FK_logo.png" alt="Fajne Krzesła" style="max-width: 150px; height: auto; margin-bottom: 20px;">

    <div style="margin: 20px 0; padding: 20px; background: rgba(40, 167, 69, 0.1); border-radius: 15px; border-left: 4px solid #28a745;">
      <h2 style="color: #28a745; margin: 0 0 10px 0; font-size: 22px;">✅ Aplikacja zainstalowana pomyślnie!</h2>
      <p style="margin: 0; color: #333; font-size: 16px;">Dziękujemy za instalację aplikacji Konfigurator Krzeseł</p>
    </div>

    <p style="margin: 20px 0; line-height: 1.6; font-size: 16px; color: #555;">
      Aplikacja została dodana do ekranu głównego. Teraz możesz korzystać z pełnej funkcjonalności konfiguratora krzeseł w trybie offline.
    </p>

    <div style="margin: 25px 0; padding: 18px; background: rgba(245, 200, 66, 0.1); border-radius: 12px;">
      <p style="margin: 0; font-weight: 600; color: #333; font-size: 16px;">🚀 Gotowe do rozpoczęcia konfiguracji!</p>
      <p style="margin: 8px 0 0 0; font-size: 14px; color: #666;">Skonfiguruj swoje wymarzone krzesło w technologii 3D</p>
    </div>

    <button id="pwa-success-continue-btn" class="pwa-continue-btn" style="margin-top: 20px;">
      Przejdź do konfiguratora
    </button>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/qrcodejs/qrcode.min.js"></script>
  <script src="https://cdn.emailjs.com/dist/email.min.js"></script>

  <script type="module">
    // Import the same modules as desktop version
    import * as THREE from 'three';
    import {
      Group, Box3, Vector3, ArrowHelper, Sprite, SpriteMaterial, CanvasTexture, Color,
      TextureLoader, MeshStandardMaterial, LinearFilter, LinearMipMapLinearFilter,
      RepeatWrapping, sRGBEncoding, LinearEncoding
    } from 'three';
    import { ThreeViewer, LoadingScreenPlugin, GBufferPlugin, SSAAPlugin } from 'threepipe';
    import { SSReflectionPlugin, BloomPlugin } from '@threepipe/webgi-plugins';

    // Same configuration as desktop
    const CAMERA_FOV = 12;
    const CAMERA_NEAR = 0.1;
    const CAMERA_FAR = 100;
    const CAMERA_POSITION = { x: -4.5, y: 0.76, z: 3.9 };
    const CAMERA_TARGET = { x: 0.79, y: -1.09, z: -0.22 };
    const CAMERA_POSITION_HOOKER = { x: -6.5, y: 1.2, z: 5.5 };
    const CAMERA_TARGET_HOOKER = { x: 0.79, y: -1.09, z: -0.22 };
    const MIN_ZOOM_DISTANCE = 1;
    const MAX_ZOOM_DISTANCE = 8;
    const MIN_ZOOM_DISTANCE_HOOKER = 2;
    const MAX_ZOOM_DISTANCE_HOOKER = 12;
    const VERTICAL_OFFSET = 0;
    const SEAT_CONTACT_CORRECTION = 0.005;

    let viewer, currentModelContainer, currentLegModel;
    let allData = [];
    let selectedChair, selectedLeg, selectedMaterials = {};
    let globalCameraTargetPosition;
    let userInteracted = false;
    let dimensionHelpers = [];
    let currentModel = null;
    let selectedLegVariant = null;
    let lastOpenedCollection = null;
    let currentSearchFilter = '';
    let activeCollectionsByMesh = {};
    let materialsByMeshAndCollection = {};
    let previousCategory = 'Wszystkie';

    // Mobile-optimized initialization
    async function initMobile() {
      console.log('📱 Initializing mobile version...');

      // Create canvas if it doesn't exist
      let canvas = document.getElementById("canvas");
      if (!canvas) {
        canvas = document.createElement('canvas');
        canvas.id = 'canvas';
        canvas.style.width = '100%';
        canvas.style.height = '100%';
        document.getElementById('canvas-container').appendChild(canvas);
      }

      // Initialize ThreeViewer with mobile-optimized settings
      viewer = new ThreeViewer({
        canvas: canvas,
        plugins: [GBufferPlugin, SSAAPlugin, SSReflectionPlugin, BloomPlugin],
        rendererSettings: {
          antialias: true,
          preserveDrawingBuffer: true, // Better for mobile
          powerPreference: "default" // Better for mobile
        }
      });

      window.viewer = viewer;

      // Set up mobile-optimized controls
      if (viewer.controls) {
        viewer.controls.minDistance = MIN_ZOOM_DISTANCE;
        viewer.controls.maxDistance = MAX_ZOOM_DISTANCE;
        viewer.controls.dampingFactor = 0.1;
        viewer.controls.enableDamping = true;
        viewer.controls.addEventListener('change', clampCameraDistance);
      }

      // Load HDR environment
      try {
        await viewer.setEnvironmentMap("hdr/hamburg_hbf_1k.hdr", { isHDR: true });
        if (viewer.scene && viewer.scene.environment) {
          window.originalHDRIntensity = viewer.scene.environment.intensity || 1;
          // Increase HDR intensity for mobile for better material visibility
          viewer.scene.environment.intensity = window.originalHDRIntensity * 1.5;
        }
      } catch (e) {
        console.error("Error loading HDR:", e);
      }

      globalCameraTargetPosition = new Vector3(CAMERA_TARGET.x, CAMERA_TARGET.y, CAMERA_TARGET.z);

      // Load data from Google Sheets
      await loadDataFromSheet();

      if (!allData || allData.length === 0) {
        console.warn('No data loaded, using fallback');
        allData = [
          { Nazwa: 'Krzesło Podstawowe', Kategoria: 'Krzesła', Typ: 'model', Promocja: 'FALSE', Bestseller: 'FALSE' },
          { Nazwa: 'Fotel Komfortowy', Kategoria: 'Fotele', Typ: 'model', Promocja: 'TRUE', Procent: '15', Bestseller: 'FALSE' }
        ];
      }

      // Initialize mobile UI
      renderMobileCategoryButtons();
      renderMobileModels();
      setupMobileEventListeners();

      // Hide loader and show app
      const loader = document.getElementById('custom-loader');
      if (loader) {
        loader.style.display = 'none';
      }
      const app = document.getElementById('app');
      if (app) {
        app.classList.add('visible');
      }

      console.log('📱 Mobile initialization complete');
    }

    // Mobile-specific functions
    function renderMobileCategoryButtons() {
      const specialContainer = document.getElementById('special-categories-container');
      const categoryContainer = document.getElementById('category-buttons-container');

      if (!specialContainer || !categoryContainer) return;

      specialContainer.innerHTML = '';
      categoryContainer.innerHTML = '';

      // Add "Wszystkie" button
      const allButton = document.createElement('button');
      allButton.className = 'category-button active';
      allButton.textContent = 'Wszystkie';
      allButton.onclick = () => {
        document.querySelectorAll('.category-button').forEach(btn => {
          btn.classList.remove('active');
        });
        allButton.classList.add('active');
        renderMobileModels();
      };
      specialContainer.appendChild(allButton);

      // Get unique categories
      const categories = [...new Set(allData
        .filter(item => item.Kategoria && (item.Typ === 'model' || item.Grupa === 'krzesło' || item.Grupa === 'kubełek'))
        .map(item => item.Kategoria)
      )];

      // Add category buttons
      categories.forEach(category => {
        const button = document.createElement('button');
        button.className = 'category-button';
        button.textContent = category;
        button.onclick = () => {
          document.querySelectorAll('.category-button').forEach(btn => {
            btn.classList.remove('active');
          });
          button.classList.add('active');
          renderMobileModels(category);
        };
        categoryContainer.appendChild(button);
      });
    }

    function renderMobileModels(selectedCategory = null) {
      const modelSection = document.getElementById('model-section');
      const container = modelSection.querySelector('.options-grid');

      if (!container) return;

      container.innerHTML = '';

      let models = allData.filter(item =>
        item.Typ === 'model' || item.Grupa === 'krzesło' || item.Grupa === 'kubełek'
      );

      if (selectedCategory) {
        models = models.filter(item => item.Kategoria === selectedCategory);
      }

      models.forEach(model => {
        const wrapper = document.createElement('div');
        wrapper.className = 'thumbnail-wrapper';

        const button = document.createElement('div');
        button.className = 'thumbnail';
        button.title = model.Nazwa;

        // Add promotion/bestseller styling
        if (model.Promocja === 'TRUE' || model.Promocja === 'true' || model.Promocja === 'tak') {
          button.classList.add('promotion');
        }
        if (model.Bestseller === 'TRUE' || model.Bestseller === 'true' || model.Bestseller === 'tak') {
          button.classList.add('bestseller');
        }

        const img = document.createElement('img');
        img.src = model.Obrazek && model.Obrazek.length > 4 ? model.Obrazek : 'icons/placeholder.svg';
        img.alt = model.Nazwa;
        button.appendChild(img);

        const caption = document.createElement('div');
        caption.className = 'thumbnail-caption';
        caption.textContent = model.Nazwa;
        wrapper.appendChild(button);
        wrapper.appendChild(caption);

        // Add price if available
        if (model.Cena) {
          const priceDiv = document.createElement('div');
          priceDiv.className = 'thumbnail-price';
          priceDiv.textContent = `${parseFloat(model.Cena).toFixed(0)} zł`;
          wrapper.appendChild(priceDiv);
        }

        button.onclick = () => {
          loadMobileModel(model);
        };

        container.appendChild(wrapper);
      });

      // Show model section
      modelSection.style.display = 'block';
    }

    async function loadMobileModel(model) {
      console.log('📱 Loading mobile model:', model.Nazwa);

      // Hide welcome screen
      const welcomeScreen = document.getElementById('welcome-screen');
      if (welcomeScreen) {
        welcomeScreen.style.display = 'none';
      }

      // Show model loader
      const modelLoader = document.getElementById('model-loader');
      if (modelLoader) {
        modelLoader.style.display = 'flex';
      }

      try {
        // Load the model (reuse desktop logic)
        selectedChair = model;
        window.selectedChair = model;

        // For demo purposes, just show the config section
        setTimeout(() => {
          const modelLoader = document.getElementById('model-loader');
          if (modelLoader) {
            modelLoader.style.display = 'none';
          }

          // Show bottom toolbar
          const toolbar = document.getElementById('bottom-toolbar');
          if (toolbar) {
            toolbar.classList.add('visible');
          }

          // Show config overview button
          const configButton = document.getElementById('config-overview-button');
          if (configButton) {
            configButton.style.display = 'flex';
          }

          // Show config section
          const configSection = document.getElementById('config-section');
          if (configSection) {
            configSection.classList.add('active');
          }

          userInteracted = true;
        }, 1500);

      } catch (e) {
        console.error('Error loading mobile model:', e);
        const modelLoader = document.getElementById('model-loader');
        if (modelLoader) {
          modelLoader.style.display = 'none';
        }
      }
    }

    function setupMobileEventListeners() {
      // Welcome continue button
      const welcomeContinueBtn = document.getElementById('welcome-continue-btn');
      if (welcomeContinueBtn) {
        welcomeContinueBtn.onclick = () => {
          const welcomeScreen = document.getElementById('welcome-screen');
          if (welcomeScreen) {
            welcomeScreen.style.display = 'none';
          }
        };
      }

      // Config overview button
      const configButton = document.getElementById('config-overview-button');
      const configPopup = document.getElementById('config-overview-popup');
      const configPopupClose = document.getElementById('config-popup-close');

      if (configButton) {
        configButton.onclick = () => {
          configPopup.style.display = 'flex';
        };
      }

      if (configPopupClose) {
        configPopupClose.onclick = () => {
          configPopup.style.display = 'none';
        };
      }

      if (configPopup) {
        configPopup.onclick = (e) => {
          if (e.target === configPopup) {
            configPopup.style.display = 'none';
          }
        };
      }

      // EmailJS initialization
      emailjs.init('y6_uovUeRS8M7gZ1H');

      // Setup other mobile event listeners (AR, dimensions, etc.)
      setupMobilePopups();
    }

    function setupMobilePopups() {
      // AR popup
      const arButton = document.getElementById('ar-button');
      if (arButton) {
        arButton.onclick = () => {
          const arPopup = document.getElementById('ar-popup');
          if (arPopup) {
            arPopup.style.display = 'block';
          }
        };
      }

      // QR popup
      const qrButton = document.getElementById('qr-button');
      if (qrButton) {
        qrButton.onclick = () => {
          const qrPopup = document.getElementById('qr-popup');
          const qrContainer = document.getElementById('qrcode');
          if (qrPopup && qrContainer) {
            qrPopup.style.display = 'block';
            qrContainer.innerHTML = '';
            new QRCode(qrContainer, {
              text: window.location.href,
              width: 200,
              height: 200,
            });
          }
        };
      }

      // Close buttons
      document.getElementById('qr-close-btn')?.addEventListener('click', () => {
        document.getElementById('qr-popup').style.display = 'none';
      });

      window.closeArPopup = () => {
        document.getElementById('ar-popup').style.display = 'none';
      };
    }

    // Load data from Google Sheets (same as desktop)
    async function loadDataFromSheet() {
      console.log('📱 Loading data from Google Sheets...');

      const sheetId = '1ftI8CkA2Itav_h45KOap__JYtup28V1FiBmpP0p_Cjc';
      const sheetURL = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?tqx=out:csv&sheet=Baza Danych&v=${new Date().getTime()}`;

      try {
        const response = await fetch(sheetURL, { cache: 'no-store' });
        if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);

        const csvText = await response.text();
        const rows = csvText.trim().split('\n');
        const headerRow = rows.shift();
        const rawHeaders = headerRow.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
        const cleanHeaders = rawHeaders.map(h => h.trim().replace(/"/g, ''));
        const headers = cleanHeaders.map(header => header.split(' ')[0]);

        const rawData = rows.map(row => {
          const values = row.match(/(".*?"|[^",]+)(?=\s*,|\s*$)/g) || [];
          const obj = {};
          headers.forEach((header, index) => obj[header] = values[index]?.trim().replace(/"/g, '') || '');
          return obj;
        });

        allData = rawData.filter(item => (item.Visible || '').toLowerCase() !== 'false');
        window.allData = allData;

        console.log('✅ Mobile data loaded:', allData.length, 'items');
      } catch (e) {
        console.error('❌ Error loading mobile data:', e);
        allData = [];
      }
    }

    // Mobile PWA installation
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
      e.preventDefault();
      deferredPrompt = e;
      window.deferredPrompt = e;
    });

    window.installApp = function() {
      if (deferredPrompt) {
        deferredPrompt.prompt();
        deferredPrompt.userChoice.then((choiceResult) => {
          if (choiceResult.outcome === 'accepted') {
            console.log('📱 User accepted PWA installation');
          }
          deferredPrompt = null;
        });
      }
    };

    window.showInstallInstructions = function() {
      if (window.deferredPrompt) {
        window.deferredPrompt.prompt();
      } else {
        alert('Aby zainstalować aplikację, użyj menu "Udostępnij" w Safari i wybierz "Dodaj do ekranu głównego"');
      }
    };

    // Initialize mobile app
    document.addEventListener('DOMContentLoaded', () => {
      console.log('📱 DOM Content Loaded - initializing mobile app');
      initMobile();
    });

    // Fail-safe for mobile
    window.addEventListener('load', () => {
      if (!window.viewer) {
        console.log('📱 Fail-safe initialization');
        initMobile();
      }
    });
  </script>
</body>
</html>
